# å¥ä¿æ‰‹è¡“ç¢¼èƒå–å™¨ Dev Spec

**ç‰ˆæœ¬**: v1.0
**æ—¥æœŸ**: 2026-01-03
**ä¾†æº**: ChatGPT + Claude Code æ•´åˆ

---

## 1. ç›®æ¨™

å¾å¥ä¿ç½² `form4-001.pdf` èƒå–ã€Œç¬¬ä¸ƒç¯€ æ‰‹è¡“ã€çš„ï¼š
- æ‰‹è¡“ç¢¼ (code)
- é»æ•¸ (points)
- åç¨± (name)
- ç« ç¯€åˆ†é¡ (group/subgroup)

ç”¢å‡º Claude Code / MIRS å¯ç›´æ¥åŒ¯å…¥çš„æ ¼å¼ã€‚

---

## 2. è³‡æ–™ä¾†æº

| é …ç›® | èªªæ˜ |
|------|------|
| æª”æ¡ˆ | form4-001.pdf |
| ä¾†æº | å¥ä¿ç½²ã€Œå…¨æ°‘å¥åº·ä¿éšªé†«ç™‚æœå‹™çµ¦ä»˜é …ç›®åŠæ”¯ä»˜æ¨™æº–ã€ |
| å€æ®µ | ç¬¬äºŒéƒ¨ç¬¬äºŒç« ç¬¬ä¸ƒç¯€ (æ‰‹è¡“) |
| é æœŸç­†æ•¸ | ~1,621 å€‹å”¯ä¸€ code |

---

## 3. è¼¸å…¥/è¼¸å‡º

### è¼¸å…¥
```
/path/to/form4-001.pdf
```

### è¼¸å‡º
```
data/packs/nhi_sec7/
â”œâ”€â”€ nhi_surgery_codes_sec7.csv    # äººå·¥æª¢è¦–/ç‰ˆæ§
â”œâ”€â”€ nhi_surgery_codes_sec7.json   # å¾Œç«¯ import
â””â”€â”€ (å¯é¸) nhi_surgery_codes_sec7.ts   # å‰ç«¯å¸¸æ•¸
```

### æ¬„ä½å®šç¾©

| æ¬„ä½ | å‹æ…‹ | èªªæ˜ |
|------|------|------|
| code | string | 5 ä½æ•¸å­— + 1 å¤§å¯«è‹±æ–‡ (å¦‚ `62001C`) |
| points | integer | å¥ä¿é»æ•¸ |
| name | string | ä¸­æ–‡åç¨± |
| group | string | ã€Œç¬¬Xé …ã€æ¨™é¡Œ |
| subgroup | string | ã€Œç¬¬Xæ¬¾/ç›®ã€æ¨™é¡Œ |

---

## 4. èƒå–è¦å‰‡

### 4.1 ç¬¬ä¸ƒç¯€ç¯„åœå®šä½

```
é–‹å§‹æ¨™è¨˜: "ç¬¬äºŒéƒ¨ç¬¬äºŒç« ç¬¬ä¸ƒç¯€"
çµæŸæ¨™è¨˜: "ç¬¬äºŒéƒ¨ç¬¬äºŒç« ç¬¬å…«ç¯€" (æ­¤é ä¹‹å‰)
```

**å¿½ç•¥ç›®éŒ„é **ï¼šåªå–é ç¢¼ > 10 çš„æ¨™è¨˜

### 4.2 è¡¨æ ¼åˆ—è¾¨è­˜

**æ¥å—**ï¼š
```regex
^(\d{5}[A-Z])\s+    # è¡Œé¦–æ˜¯ codeï¼Œå¾Œæ¥ç©ºç™½
```

**æ’é™¤**ï¼š
```regex
\d{5}[A-Z][ã€ï¼Œ]    # code å¾Œæ¥é “è™Ÿ (æ•˜è¿°æ–‡å­—)
```

ä¾‹å¦‚æ’é™¤ï¼š
- `63005Cã€63006C...` (æ•˜è¿°æ®µè½)
- `ä¸å¾—åŒæ™‚ç”³å ±é …ç›®: 32026C` (è¦ç¯„èªªæ˜)

### 4.3 é»æ•¸ç¶å®š (ç‹€æ…‹æ©Ÿ)

PDF è¡¨æ ¼çš„é»æ•¸å¸¸åœ¨ code è¡Œä¹‹å¾Œï¼Œä¸­é–“å¯èƒ½æœ‰ `v v v` åˆ†éš”è¡Œã€‚

```
ç‹€æ…‹æ©Ÿé‚è¼¯ï¼š

1. çœ‹åˆ° code è¡Œ â†’ å­˜ç‚º pendingRow
2. å¾€ä¸‹æƒæï¼Œè‹¥é‡åˆ°ï¼š
   - ç´”æ•¸å­—è¡Œ ^\d{2,6}$
   - ä¸”ä¸Šä¸€è¡Œå« 'v' æˆ– 'ï½–'
   - ä¸”è·é›¢ pendingRow <= 8 è¡Œ
   â†’ ç¶å®šç‚º pointsï¼Œè¼¸å‡ºè¨˜éŒ„

3. å‚™æ´ï¼šè‹¥é»æ•¸åœ¨ code ä¹‹å‰ï¼Œå…è¨± lastPointsCandidate å›å¡« (<=4 è¡Œ)
```

### 4.4 å»é‡èˆ‡æ­£è¦åŒ–

```python
# ä»¥ code åˆ†çµ„
# å–åç¨±å­—ä¸²æœ€é•·çš„ä¸€ç­† (é¿å…è·¨é æˆªæ–·)
# è‹¥åŒä¸€ code æœ‰å¤šå€‹ä¸åŒ points â†’ è­¦å‘Š
```

---

## 5. é©—æ”¶æ¸¬è©¦

| æ¸¬è©¦é …ç›® | æ¢ä»¶ |
|----------|------|
| code æ ¼å¼ | æ¯ç­†ç¬¦åˆ `^\d{5}[A-Z]$` |
| å®Œæ•´æ€§ | å”¯ä¸€ code æ•¸é‡ > 1,000 |
| ç„¡æ±¡æŸ“ | ã€Œä¸å¾—åŒæ™‚ç”³å ±ã€æ®µè½ä¸æœƒè®Šæˆè¨˜éŒ„ |
| å¯é‡ç¾ | åŒä¸€ PDF é‡è·‘ï¼Œè¼¸å‡º hash ä¸€è‡´ |

---

## 6. ä½¿ç”¨æ–¹å¼

### 6.1 å®‰è£ä¾è³´

```bash
pip install PyMuPDF
```

### 6.2 åŸ·è¡Œèƒå–

```bash
cd /Users/QmoMBA/Downloads/MIRS-v2.0-single-station

python3 scripts/extract_nhi_surgery_codes.py \
  --pdf /path/to/form4-001.pdf \
  --out ./data/packs/nhi_sec7
```

### 6.3 è¼¸å‡ºç¯„ä¾‹

```
ğŸ“„ é–‹å•Ÿ PDF: form4-001.pdf
   ç¸½é æ•¸: 1234

ğŸ” å®šä½ç¬¬ä¸ƒç¯€ç¯„åœ...
   ç¬¬ä¸ƒç¯€: ç¬¬ 456 é  ~ ç¬¬ 567 é  (112 é )

ğŸ“Š èƒå–è¡“å¼ç¢¼...
   åŸå§‹ç­†æ•¸: 1892

ğŸ”„ å»é‡èˆ‡æ­£è¦åŒ–...
   å”¯ä¸€ code: 1621

âœ… é©—æ”¶æ¸¬è©¦...
   code æ ¼å¼æ­£ç¢º: âœ“
   æ•¸é‡ > 1000: âœ“ (1621)

ğŸ’¾ å¯«å…¥æª”æ¡ˆ...
   nhi_surgery_codes_sec7.csv (SHA256: a1b2c3d4...)
   nhi_surgery_codes_sec7.json (SHA256: e5f6g7h8...)
```

---

## 7. èˆ‡ç¾æœ‰è³‡æ–™æ•´åˆ

### 7.1 ç›®å‰ MIRS è³‡æ–™

| ä¾†æº | ç­†æ•¸ | èªªæ˜ |
|------|------|------|
| OrthoAssistance CSV | 255 | éª¨ç§‘å¸¸ç”¨è¡“å¼ï¼Œå·²æ¨™è¨˜ `is_common=1` |
| å¥ä¿ç½² PDF (å¾…åŒ¯å…¥) | ~1,621 | å®Œæ•´ç¬¬ä¸ƒç¯€æ‰‹è¡“ç¢¼ |

### 7.2 æ•´åˆç­–ç•¥

```sql
-- æ­¥é©Ÿ 1: åŒ¯å…¥å¥ä¿è³‡æ–™ (INSERT OR IGNORE)
INSERT OR IGNORE INTO surgery_codes (code, name_zh, points, ...)
SELECT code, name, points, ... FROM nhi_import;

-- æ­¥é©Ÿ 2: æ›´æ–° is_common æ¨™è¨˜ (ä¿ç•™åŸæœ¬ OrthoAssistance çš„æ¨™è¨˜)
-- (ç¾æœ‰ 255 ç­†å·²æœ‰ is_common=1ï¼Œä¸éœ€è®Šå‹•)

-- æ­¥é©Ÿ 3: å°æ¯”é»æ•¸å·®ç•° (é©—è­‰ç”¨)
SELECT
    s.code,
    s.points as current_points,
    n.points as nhi_points
FROM surgery_codes s
JOIN nhi_import n ON s.code = n.code
WHERE s.points != n.points;
```

### 7.3 åˆä½µå¾Œé æœŸçµæœ

| é …ç›® | æ•¸é‡ |
|------|------|
| ç¸½è¡“å¼ç¢¼ | ~1,700+ (å»é‡å¾Œ) |
| is_common=1 | 255 (éª¨ç§‘å¸¸ç”¨) |
| æ–°å¢ç¢¼ | ~1,400+ |

---

## 8. ChatGPT å·²èƒå–è³‡æ–™

å¦‚æœä¸æƒ³é‡è·‘ PDF èƒå–ï¼ŒChatGPT å·²æä¾›ï¼š
- `sec7_surgery_codes_points.csv`
- `sec7_surgery_codes_points.json`
- `sec7_surgery_codes_points.ts`

å¯ç›´æ¥ä¸‹è¼‰å¾Œæ”¾å…¥ `data/packs/nhi_sec7/` ä½¿ç”¨ã€‚

---

## é™„éŒ„ A: è…³æœ¬ä½ç½®

```
scripts/extract_nhi_surgery_codes.py
```

## é™„éŒ„ B: ç›¸ä¾å¥—ä»¶

```
PyMuPDF (fitz) - PDF æ–‡å­—èƒå–
```

---

*æ–‡ä»¶çµæŸ*
