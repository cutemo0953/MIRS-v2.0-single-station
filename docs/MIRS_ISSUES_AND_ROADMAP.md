# MIRS 開發議題與路線圖

> 記錄待解決問題、設計討論、與未來規劃

**更新日期**: 2025-12-20
**版本**: v0.2 (Phase 2.1 完成)

---

## 1. 當前待解決問題

### 1.1 PWA 設備檢查後載入緩慢 ✅ 已解決

**問題描述**：
- PWA 提交設備檢查後，重新載入設備列表時有明顯延遲

**原因分析**：
- 設備檢查後依序呼叫：
  1. `POST /equipment/{id}/check` - 提交檢查
  2. `GET /equipment` - 重載設備列表
  3. `checkAlerts()` - 檢查警示
- 網路延遲累加造成感知緩慢

**已實作解決方案** (2025-12-20)：
- [x] 本地狀態即時更新（Optimistic UI）
- [x] 背景靜默刷新，不阻塞 UI
- [x] Toast 提示取代 alert() 彈窗

---

### 1.2 設備電量/容量百分比輸入缺失 ✅ PWA 已完成

**問題描述**：
- 行動電源站、氧氣瓶等設備需要回報剩餘電量/容量百分比
- PWA 設備模態窗沒有電量輸入欄位
- Hub 設備管理也沒有編輯電量的功能

**影響範圍**：
- 韌性估算依賴準確的電量/容量資訊
- 目前只能透過「設備巡檢」的備註欄位手動填寫

**已實作解決方案** (2025-12-20)：
- [x] 在 PWA 設備模態窗加入電量滑桿（0-100%）+ 數字輸入
- [x] 區分設備類型：
  - 供電設備（發電機、UPS、電源站）→ 顯示「電量」
  - 供氧設備（氧氣瓶）→ 顯示「氧氣容量」
  - 發電機 → 顯示「油量」
  - 非耗電設備 → 不顯示電量欄位
- [x] 後端 API 支援 `level_percent` 參數
- [ ] Hub 設備編輯加入電量欄位（Phase 2.2）

**資料結構建議**：
```json
{
  "equipment_id": "UTIL-001",
  "status": "normal",
  "level_percent": 85,     // 新增：電量/容量百分比
  "level_type": "power",   // 新增：類型 (power/oxygen/none)
  "location": "急救區",     // 待討論
  "notes": ""
}
```

---

### 1.3 設備位置（Location）欄位設計

**問題描述**：
- PWA 設備模態窗有「位置」欄位
- Hub 設備管理沒有此欄位，也無法設定
- 位置資料該從哪裡來？

**現況**：
- CIRS 有「區域」概念，但是針對「人員報到區域」
- MIRS/CIRS 都沒有「設備區域」的設定

**設計選項**：

| 選項 | 說明 | 優點 | 缺點 |
|------|------|------|------|
| A. 手動輸入 | PWA 自由輸入位置文字 | 簡單、彈性 | 無法標準化查詢 |
| B. Hub 預設 | Hub 設備編輯時設定「預設位置」 | 可標準化 | 需改 Hub UI |
| C. 整合 CIRS 區域 | 從 CIRS 讀取區域清單 | 資料一致 | 需 CIRS-MIRS 整合 |
| D. MIRS 獨立區域 | MIRS 自己管理區域清單 | 獨立運作 | 可能與 CIRS 不一致 |

**建議**：
- 短期：選項 A（手動輸入），快速可用
- 中期：選項 B（Hub 設定預設位置）
- 長期：選項 C（整合 CIRS 區域資料庫）

---

### 1.4 MIRS-CIRS 資料整合現況

**問題**：MIRS 是否會向 CIRS 詢問病患資訊？

**現況答案**：
- 目前 MIRS 單站版是獨立運作
- 沒有實作 CIRS-MIRS 的資料共享
- 病患資訊（病歷號等）目前是手動輸入

**未來整合需求**：

| 資料類型 | 來源 | 整合方式 |
|---------|------|---------|
| 病患清單 | CIRS | MIRS 查詢 CIRS API |
| 區域/位置 | CIRS | 共用區域定義表 |
| 人員名冊 | CIRS | 共用人員資料庫 |
| 物資發放記錄 | CIRS | 獨立記錄，可匯總 |

---

## 2. 新增 Spec 需求

### 2.1 建站/關站/轉移/併站流程 Spec

**需求背景**：
- 災害應變時需要快速建立新站點
- 站點可能需要轉移、併站
- 資料如何遷移？設備如何重新分配？

**建議文件結構**：

```
STATION_LIFECYCLE_SPEC.md
├── 1. 建站流程
│   ├── 1.1 硬體準備（Pi、網路、電源）
│   ├── 1.2 軟體初始化（MIRS 啟動、資料庫初始化）
│   ├── 1.3 與 CIRS Hub 連線（如適用）
│   ├── 1.4 區域定義導入（從 CIRS 或手動）
│   └── 1.5 設備登記與初始庫存
│
├── 2. 關站流程
│   ├── 2.1 資料備份（離線包產生）
│   ├── 2.2 設備歸還/轉移
│   ├── 2.3 庫存清點與處理
│   └── 2.4 站點標記為「已關閉」
│
├── 3. 轉移流程（A站 → B站）
│   ├── 3.1 資料匯出（A站）
│   ├── 3.2 設備實體移動
│   ├── 3.3 資料匯入（B站）
│   └── 3.4 原站點處理
│
├── 4. 併站流程（A站 + B站 → C站）
│   ├── 4.1 資料合併策略
│   ├── 4.2 設備整併
│   ├── 4.3 庫存合計
│   └── 4.4 人員名冊合併
│
└── 5. CIRS 整合考量
    ├── 5.1 區域資料共享
    ├── 5.2 病患資料查詢
    └── 5.3 人員名冊同步
```

---

## 3. 設計討論待決

### 3.1 PWA 同步時機

**選項**：

| 時機 | 說明 | 適用場景 |
|------|------|---------|
| 即時同步 | 操作完成後立即同步 | 網路穩定環境 |
| 手動同步 | 使用者點擊「同步」按鈕 | 網路不穩環境 |
| 混合模式 | 線上即時、離線暫存 | 目前實作 |

**目前實作**：混合模式
- 線上時：操作完成立即 POST 到 Hub
- 離線時：暫存到 pendingActions，恢復連線後自動同步

---

### 3.2 設備 Level 輸入方式

**選項**：

| 方式 | UI 元件 | 精確度 |
|------|---------|--------|
| 滑桿 | `<input type="range">` | 5-10% 級距 |
| 數字輸入 | `<input type="number">` | 精確到 1% |
| 快速按鈕 | 25% / 50% / 75% / 100% | 粗略快速 |
| 混合 | 滑桿 + 數字顯示 | 兼顧速度與精確 |

**建議**：混合模式（滑桿 + 數字顯示）

---

## 4. 路線圖

### Phase 2.1（優先）✅ 已完成
- [x] 修正 PWA 設備檢查後的載入效能（Optimistic UI）
- [x] PWA 設備模態窗加入電量/容量百分比輸入（滑桿+數字）
- [x] PWA 錯誤回報 UX 優化
- [x] Hub 配對記錄查詢功能
- [x] Hub 庫存盤點記錄顏色簡化

### Phase 2.2
- [ ] Hub 設備編輯加入電量欄位
- [ ] Hub 設備管理加入「預設位置」欄位
- [ ] PWA 位置欄位改為下拉選單（從 Hub 設定讀取）
- [x] Hub 同步通知功能

### Phase 2.3
- [ ] 撰寫 STATION_LIFECYCLE_SPEC.md
- [ ] 規劃 CIRS-MIRS 資料整合架構

### Phase 3（未來）
- [ ] CIRS 區域資料共享
- [ ] 病患資料查詢整合
- [ ] 多站點資料同步

---

## 附錄：相關文件

- `MIRS_MOBILE_PWA_SPEC.md` - PWA 主要規格
- `EQUIPMENT_RESILIENCE_SPEC.md` - 設備韌性估算
- `xIRS_SECURE_EXCHANGE_SPEC_v2.md` - 站點間安全交換協議

---

*Document Created: 2025-12-20*
*Author: De Novo Orthopedics Inc.*
