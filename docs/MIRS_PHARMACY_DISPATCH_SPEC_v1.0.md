# MIRS Pharmacy Sub-Hub Dispatch Specification v1.0

**Version**: 1.0
**Date**: 2025-12-23
**Status**: Draft
**Target**: MIRS v1.4.3+

---

## 1. Overview

### 1.1 Problem Statement

MIRS currently supports:
- âœ… Patient dispensing (emergency/normal with pharmacist approval)
- âœ… Secure data exchange via xIRS envelopes (USB-based)
- âŒ **Dispatching medication inventory to Pharmacy Sub-Hubs**

In disaster response scenarios, a central MIRS station needs to distribute medications to satellite pharmacy stations (xIRS Pharmacy PWAs) for decentralized dispensing.

### 1.2 Solution: Dispatch Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  MIRS (Central)   â”‚   QR    â”‚   xIRS Pharmacy PWA    â”‚
â”‚  è—¥å“ç‰©è³‡ä¸­å¿ƒ      â”‚ â”€â”€â”€â”€â”€â”€â–º â”‚   Sub-Hub #1           â”‚
â”‚                   â”‚   or    â”‚                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  USB    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Med Stock   â”‚  â”‚         â”‚  â”‚ Local Inventory â”‚   â”‚
â”‚  â”‚ 1000 units  â”‚  â”‚         â”‚  â”‚ + 200 units     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚         â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â”‚ Same QR/USB
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   xIRS Pharmacy PWA    â”‚
â”‚   Sub-Hub #2           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. Data Model

### 2.1 Dispatch Order (æ–°å¢)

```sql
CREATE TABLE pharmacy_dispatch_orders (
    dispatch_id TEXT PRIMARY KEY,           -- DISP-20251223-001
    created_at TEXT NOT NULL,               -- ISO timestamp
    created_by TEXT NOT NULL,               -- æ“ä½œäººå“¡
    target_station_id TEXT,                 -- ç›®æ¨™ç«™é» (å¯é¸, null=ä»»ä½•ç«™)
    target_station_name TEXT,               -- ç›®æ¨™ç«™é»åç¨±
    status TEXT DEFAULT 'PENDING',          -- PENDING | DISPATCHED | RECEIVED | CANCELLED
    dispatch_method TEXT DEFAULT 'QR',      -- QR | USB | MANUAL

    -- Manifest
    total_items INTEGER NOT NULL,           -- ç¸½å“é …æ•¸
    total_quantity INTEGER NOT NULL,        -- ç¸½æ•¸é‡

    -- Tracking
    dispatched_at TEXT,                     -- å¯¦éš›ç™¼å‡ºæ™‚é–“
    received_at TEXT,                       -- ç¢ºèªæ”¶åˆ°æ™‚é–“
    received_by TEXT,                       -- æ”¶è²¨äºº
    notes TEXT,                             -- å‚™è¨»

    -- Security
    signature TEXT,                         -- Ed25519 ç°½ç« 
    qr_chunks INTEGER DEFAULT 1             -- QR åˆ†å¡Šæ•¸
);

CREATE TABLE pharmacy_dispatch_items (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    dispatch_id TEXT NOT NULL,
    medicine_code TEXT NOT NULL,
    medicine_name TEXT NOT NULL,
    quantity INTEGER NOT NULL,
    unit TEXT DEFAULT 'å–®ä½',
    batch_number TEXT,                      -- æ‰¹è™Ÿ
    expiry_date TEXT,                       -- æ•ˆæœŸ
    is_controlled BOOLEAN DEFAULT FALSE,   -- ç®¡åˆ¶è—¥å“

    FOREIGN KEY (dispatch_id) REFERENCES pharmacy_dispatch_orders(dispatch_id)
);

CREATE INDEX idx_dispatch_status ON pharmacy_dispatch_orders(status);
CREATE INDEX idx_dispatch_target ON pharmacy_dispatch_orders(target_station_id);
CREATE INDEX idx_dispatch_items_order ON pharmacy_dispatch_items(dispatch_id);
```

### 2.2 Dispatch Payload (QR/USB)

```json
{
  "type": "MED_DISPATCH",
  "v": "1.0",
  "dispatch_id": "DISP-20251223-001",
  "source_station": "MIRS-DNO-01",
  "target_station": null,
  "items": [
    {
      "code": "MED-PARA-500",
      "name": "Paracetamol 500mg",
      "qty": 200,
      "unit": "tablets",
      "batch": "B2024001",
      "expiry": "2026-06"
    },
    {
      "code": "MED-IBUP-400",
      "name": "Ibuprofen 400mg",
      "qty": 100,
      "unit": "tablets"
    }
  ],
  "total_items": 2,
  "total_qty": 300,
  "ts": 1735012345,
  "nonce": "abc123def456789012345678",
  "signature": "<Ed25519>"
}
```

---

## 3. API Endpoints (æ–°å¢)

### 3.1 Create Dispatch Order

```http
POST /api/pharmacy/dispatch
Content-Type: application/json

{
  "items": [
    { "medicine_code": "MED-PARA-500", "quantity": 200 },
    { "medicine_code": "MED-IBUP-400", "quantity": 100 }
  ],
  "target_station_id": "PHARM-SUB-01",  // optional
  "target_station_name": "å‰ç·šè—¥å±€ A",    // optional
  "notes": "ç·Šæ€¥è£œçµ¦",
  "created_by": "admin001"
}
```

**Response:**
```json
{
  "success": true,
  "dispatch_id": "DISP-20251223-001",
  "qr_chunks": 1,
  "qr_data": ["XIR1|MF|1/1|eyJ0eXBlIjoi...|a1b2c3d4"],
  "message": "æ’¥ç™¼å–®å·²å»ºç«‹"
}
```

### 3.2 Get Dispatch QR Codes

```http
GET /api/pharmacy/dispatch/{dispatch_id}/qr
```

**Response:**
```json
{
  "dispatch_id": "DISP-20251223-001",
  "status": "PENDING",
  "chunks": 1,
  "qr_data": ["XIR1|MF|1/1|eyJ0eXBlIjoi...|a1b2c3d4"],
  "qr_images": ["data:image/png;base64,..."]
}
```

### 3.3 Confirm Dispatch

```http
POST /api/pharmacy/dispatch/{dispatch_id}/confirm
Content-Type: application/json

{
  "dispatched_by": "admin001"
}
```

**Effect:**
- Status â†’ `DISPATCHED`
- Deduct inventory from MIRS

### 3.4 List Dispatch Orders

```http
GET /api/pharmacy/dispatch?status=PENDING&limit=50
```

### 3.5 Cancel Dispatch

```http
DELETE /api/pharmacy/dispatch/{dispatch_id}
```

---

## 4. Frontend UI Design

### 4.1 Entry Point

**Location:** è—¥å“ç®¡ç† Tab â†’ æ–°å¢ã€Œæ’¥ç™¼çµ¦è—¥å±€ã€æŒ‰éˆ•

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ’Š è—¥å“ç®¡ç†                                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  ğŸ“¥ é€²è²¨   â”‚  â”‚  ğŸ“¤ é ˜ç”¨   â”‚  â”‚  ğŸ¥ æ’¥ç™¼çµ¦è—¥å±€    â”‚ â”‚
â”‚  â”‚            â”‚  â”‚            â”‚  â”‚   (NEW)            â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                          â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                                          â”‚
â”‚  [è—¥å“åº«å­˜åˆ—è¡¨...]                                        â”‚
â”‚                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2 Dispatch Modal (æ’¥ç™¼çµ¦è—¥å±€)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ¥ æ’¥ç™¼è—¥å“çµ¦ Pharmacy Sub-Hub                    [âœ•]  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                          â”‚
â”‚  ç›®æ¨™ç«™é» (å¯é¸)                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ [ä¸‹æ‹‰é¸å–®] é¸æ“‡ç«™é»... / ä»»ä½•ç«™é»å¯æ¥æ”¶           â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                          â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ æ’¥ç™¼è—¥å“æ¸…å–® â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                  â”‚
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ ğŸ” æœå°‹è—¥å“...                                   â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ è—¥å“                  åº«å­˜    æ’¥ç™¼æ•¸é‡    æ“ä½œ    â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚ Paracetamol 500mg    1000   [___200__]  [â•][ğŸ—‘ï¸] â”‚  â”‚
â”‚  â”‚ Ibuprofen 400mg       500   [___100__]  [â•][ğŸ—‘ï¸] â”‚  â”‚
â”‚  â”‚ Amoxicillin 250mg     300   [____50__]  [â•][ğŸ—‘ï¸] â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ [+ æ–°å¢è—¥å“]                                     â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                          â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                                          â”‚
â”‚  ğŸ“Š æ’¥ç™¼æ‘˜è¦                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  å“é …æ•¸: 3     ç¸½æ•¸é‡: 350                       â”‚    â”‚
â”‚  â”‚  ç®¡åˆ¶è—¥: 0     éœ€å¯©æ ¸: å¦                        â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                          â”‚
â”‚  å‚™è¨»                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ å‰ç·šç·Šæ€¥è£œçµ¦...                                  â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚      å–æ¶ˆ        â”‚  â”‚   ğŸ“± ç”¢ç”Ÿæ’¥ç™¼ QR Code    â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.3 QR Display Modal

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  âœ… æ’¥ç™¼å–®å·²å»ºç«‹                                   [âœ•]  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                          â”‚
â”‚              DISP-20251223-001                           â”‚
â”‚                                                          â”‚
â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚           â”‚                      â”‚                       â”‚
â”‚           â”‚      [QR CODE]       â”‚                       â”‚
â”‚           â”‚       250x250        â”‚                       â”‚
â”‚           â”‚                      â”‚                       â”‚
â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚                   1 / 2                                  â”‚
â”‚           [â—€ ä¸Šä¸€å¼µ]  [ä¸‹ä¸€å¼µ â–¶]                         â”‚
â”‚                                                          â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚
â”‚                                                          â”‚
â”‚  ğŸ“‹ æ’¥ç™¼å…§å®¹                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  â€¢ Paracetamol 500mg Ã— 200                      â”‚    â”‚
â”‚  â”‚  â€¢ Ibuprofen 400mg Ã— 100                        â”‚    â”‚
â”‚  â”‚  â€¢ Amoxicillin 250mg Ã— 50                       â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                          â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚
â”‚                                                          â”‚
â”‚  DISP-20251223-001                        [ğŸ“‹ è¤‡è£½]      â”‚
â”‚                                                          â”‚
â”‚  âš ï¸ è«‹è®“è—¥å±€äººå“¡æƒææ­¤ QR Code æ¥æ”¶è—¥å“                   â”‚
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚           âœ… ç¢ºèªå·²ç™¼å‡º (æ‰£é™¤åº«å­˜)                â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.4 Dispatch History Tab

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ“¦ æ’¥ç™¼ç´€éŒ„                              [ğŸ”„ é‡æ•´]      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                          â”‚
â”‚  [å…¨éƒ¨] [å¾…ç™¼å‡º] [å·²ç™¼å‡º] [å·²æ¥æ”¶]                        â”‚
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ ğŸ“¤ DISP-20251223-001                            â”‚    â”‚
â”‚  â”‚ 2025-12-23 14:30 â†’ å‰ç·šè—¥å±€ A                   â”‚    â”‚
â”‚  â”‚ 3 å“é … / 350 å–®ä½                               â”‚    â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”                                      â”‚    â”‚
â”‚  â”‚ â”‚ å·²ç™¼å‡º  â”‚                                     â”‚    â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                      â”‚    â”‚
â”‚  â”‚                            [ğŸ“± QR] [ğŸ“‹ è©³æƒ…]    â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ â³ DISP-20251223-002                            â”‚    â”‚
â”‚  â”‚ 2025-12-23 15:00 â†’ ä»»ä½•ç«™é»                     â”‚    â”‚
â”‚  â”‚ 5 å“é … / 1200 å–®ä½                              â”‚    â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”                                      â”‚    â”‚
â”‚  â”‚ â”‚ å¾…ç™¼å‡º  â”‚                                     â”‚    â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                      â”‚    â”‚
â”‚  â”‚                       [ğŸ“± QR] [âœ… ç¢ºèª] [ğŸ—‘ï¸]   â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 5. Receiver Side (xIRS Pharmacy PWA)

### 5.1 Scan Dispatch QR

The existing "æƒæè™•æ–¹" modal now supports MED_DISPATCH type:

```javascript
async processScannedRx(data) {
    if (data.type === 'MED_DISPATCH') {
        // Handle inventory dispatch
        await this.processInventoryDispatch(data);
        return;
    }
    // ... existing RX_ORDER handling
}

async processInventoryDispatch(dispatch) {
    // 1. Show dispatch summary for confirmation
    // 2. On confirm: Add items to local inventory
    // 3. Record receipt in IndexedDB
    // 4. Generate DISPATCH_RECEIPT for return (optional)
}
```

### 5.2 Inventory Receive Modal

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ“¦ æ”¶åˆ°è—¥å“æ’¥ç™¼                                   [âœ•]  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                          â”‚
â”‚  æ’¥ç™¼ç·¨è™Ÿ: DISP-20251223-001                            â”‚
â”‚  ä¾†æºç«™é»: MIRS-DNO-01                                  â”‚
â”‚                                                          â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚
â”‚                                                          â”‚
â”‚  ğŸ“‹ è—¥å“æ¸…å–®                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  âœ“ Paracetamol 500mg        Ã— 200              â”‚    â”‚
â”‚  â”‚  âœ“ Ibuprofen 400mg          Ã— 100              â”‚    â”‚
â”‚  â”‚  âœ“ Amoxicillin 250mg        Ã— 50               â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                          â”‚
â”‚  ç¸½è¨ˆ: 3 å“é … / 350 å–®ä½                                 â”‚
â”‚                                                          â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚      å–æ¶ˆ        â”‚  â”‚   âœ… ç¢ºèªæ”¶è²¨å…¥åº«        â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 6. XIR1 Protocol Integration

### 6.1 Packet Type: MF (Manifest)

Use existing XIR1 chunking protocol with type `MF`:

```
XIR1|MF|1/1|{base64_payload}|{crc32}
```

### 6.2 Max Chunks

From xIRS_QR_PROTOCOL_SPEC_v2.0.md:

| Type | Max Chunks |
|------|------------|
| MF   | 20         |

This allows dispatching ~12,000 chars of payload = ~100+ items per dispatch.

---

## 7. Security Considerations

### 7.1 Signature Verification

- Dispatch payload MUST be signed by MIRS station
- Pharmacy PWA SHOULD verify signature against trusted key registry
- For offline scenarios, signature verification is OPTIONAL

### 7.2 Replay Protection

- Each dispatch_id is unique
- Pharmacy PWA tracks received dispatches in IndexedDB
- Duplicate dispatch_id â†’ Reject with warning

### 7.3 Inventory Deduction

- MIRS deducts inventory ONLY after "ç¢ºèªå·²ç™¼å‡º" button
- This prevents accidental over-deduction
- Pending dispatches are NOT deducted

---

## 8. Implementation Checklist

### 8.1 MIRS Backend

- [ ] Add `pharmacy_dispatch_orders` table
- [ ] Add `pharmacy_dispatch_items` table
- [ ] `POST /api/pharmacy/dispatch` - Create dispatch order
- [ ] `GET /api/pharmacy/dispatch/{id}/qr` - Get QR codes
- [ ] `POST /api/pharmacy/dispatch/{id}/confirm` - Confirm & deduct inventory
- [ ] `GET /api/pharmacy/dispatch` - List orders
- [ ] `DELETE /api/pharmacy/dispatch/{id}` - Cancel order

### 8.2 MIRS Frontend

- [ ] Add "ğŸ¥ æ’¥ç™¼çµ¦è—¥å±€" button to è—¥å“ç®¡ç† tab
- [ ] Dispatch modal with item selection
- [ ] QR display modal with chunking support
- [ ] Dispatch history tab/section
- [ ] Confirm dispatch action

### 8.3 xIRS Pharmacy PWA

- [ ] Handle `MED_DISPATCH` type in scanner
- [ ] Inventory receive confirmation modal
- [ ] Add received items to local `medication_inventory`
- [ ] Track received dispatches in IndexedDB

---

## 9. Future Enhancements

1. **USB Export**: Generate .xirs envelope file for USB transfer
2. **Receipt QR**: Pharmacy generates receipt QR for MIRS to scan
3. **Partial Receipt**: Allow receiving partial quantities
4. **Controlled Drug Audit**: Special handling for controlled substances
5. **Expiry Alerts**: Warn when dispatching near-expiry items

---

## Appendix A: Example Workflow

1. **MIRS Operator** opens è—¥å“ç®¡ç† â†’ clicks "æ’¥ç™¼çµ¦è—¥å±€"
2. Selects medications and quantities from inventory
3. Clicks "ç”¢ç”Ÿæ’¥ç™¼ QR Code"
4. System generates XIR1 QR chunks
5. **Pharmacy Staff** scans QR with xIRS Pharmacy PWA
6. Reviews dispatch summary â†’ clicks "ç¢ºèªæ”¶è²¨å…¥åº«"
7. Medications added to Pharmacy local inventory
8. **MIRS Operator** clicks "ç¢ºèªå·²ç™¼å‡º"
9. MIRS deducts inventory, marks dispatch as DISPATCHED
