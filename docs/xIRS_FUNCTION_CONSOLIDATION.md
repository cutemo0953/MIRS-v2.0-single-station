# xIRS 功能整併分析

**版本**: v1.0
**日期**: 2026-01-07
**目的**: 決定 Tab vs PWA、保留 vs 整併

---

## 1. 現況盤點

### 1.1 MIRS 功能分佈

#### Index.html (6 Tabs)

| Tab | 中文 | 主要使用者 | 功能 | 離線需求 |
|-----|------|-----------|------|----------|
| `items` | 庫存查詢 | 庫房/護理長 | 查詢庫存、新增品項、分類篩選 | 低 |
| `receive` | 進貨 | 庫房 | 入庫登記、數量輸入 | 中 |
| `treatment` | 處置 | 護理師/醫師 | 處置耗材、一般消耗、藥品領用 | 中 |
| `blood` | 血袋管理 | 護理師/血庫 | 血型庫存、入庫、領用 | 高 |
| `equipment` | 設備管理 | 護理師/庫房 | 設備追蹤、檢查、維護 | 中 |
| `resilience` | 韌性估算 | 站長/管理 | 孤立天數、韌性評估 | 低 |

#### PWAs (3 個)

| PWA | 位置 | 主要使用者 | 功能 | 離線需求 |
|-----|------|-----------|------|----------|
| Mobile | `/static/mobile/` | 庫房巡房 | 設備檢查、緊急領藥 | **高** |
| Anesthesia | `/static/anesthesia/` | 麻醉科 | 麻醉記錄、PSI 追蹤 | **高** |
| EMT | `/static/emt/` | 轉送員 | 轉送任務、交班 | **高** |

### 1.2 CIRS 功能分佈

#### Portal/Admin (推測)

| 功能區 | 主要使用者 | 說明 |
|--------|-----------|------|
| 掛號管理 | 行政 | 病患登記、排隊 |
| 候診管理 | 行政 | 叫號、狀態 |
| 報表 | 站長 | 統計、匯出 |
| 系統設定 | 管理員 | 帳號、配對 |

#### PWAs (6 個)

| PWA | 主要使用者 | 功能 | 離線需求 |
|-----|-----------|------|----------|
| Doctor | 醫師 | 看診、開處方、處置決策 | 中 |
| Nurse | 護理師 | 檢傷分流 | 中 |
| Pharmacy | 藥師 | 調劑、發藥 | 中 |
| Cashdesk | 收費員 | 批價、收費 | 低 |
| Runner | 志工 | 跑腿、傳送 | 高 |
| Files | 行政 | 檔案管理 | 低 |

### 1.3 HIRS 功能分佈

| 功能 | 說明 |
|------|------|
| 傷患登記 | 戶外快速登記 |
| 檢傷標記 | START 分流 |
| 範本指引 | 急救指引 |
| 離線運作 | 完全獨立 |

---

## 2. 問題分析

### 2.1 功能重疊

```
                    重疊區域標示

MIRS Index                              CIRS PWAs
┌─────────────┐                        ┌─────────────┐
│ 處置 Tab    │◄─────── 重疊 ────────►│ Doctor PWA  │
│ (耗材記錄)  │                        │ (處置決策)  │
└─────────────┘                        └─────────────┘

┌─────────────┐                        ┌─────────────┐
│ 處置 Tab    │◄─────── 重疊 ────────►│ Pharmacy PWA│
│ (藥品領用)  │                        │ (發藥)      │
└─────────────┘                        └─────────────┘

MIRS Index                              MIRS PWA
┌─────────────┐                        ┌─────────────┐
│ 設備 Tab    │◄─────── 重疊 ────────►│ Mobile PWA  │
│ (設備管理)  │                        │ (設備檢查)  │
└─────────────┘                        └─────────────┘

┌─────────────┐                        ┌─────────────┐
│ 血袋 Tab    │◄─────── 無 PWA ──────►│    ???      │
│ (血庫管理)  │                        │             │
└─────────────┘                        └─────────────┘
```

### 2.2 角色與使用場景

| 角色 | 場景 | 裝置 | 現用工具 | 問題 |
|------|------|------|----------|------|
| 庫房人員 | 物資站(無WiFi) | 手機 | Mobile PWA | ✓ OK |
| 庫房人員 | 辦公桌 | 電腦 | MIRS Index | ✓ OK |
| 護理師 | 病房巡房 | 手機 | ??? | **缺工具** |
| 護理師 | 護理站 | 電腦 | CIRS Nurse? | **只有檢傷** |
| 護理師 | 急診處置 | 手機 | ??? | **要開電腦?** |
| 麻醉師 | 手術室 | 平板 | Anesthesia PWA | ✓ OK |
| 轉送員 | 救護車 | 手機 | EMT PWA | ✓ OK |
| 醫師 | 診間 | 電腦 | Doctor PWA | ✓ OK |
| 藥師 | 藥局 | 電腦 | Pharmacy PWA | ✓ OK |
| 站長 | 辦公室 | 電腦 | MIRS Index + CIRS Portal | **切換麻煩** |

### 2.3 主要缺口

| 缺口 | 說明 | 影響 |
|------|------|------|
| **護理執行 PWA** | 護理師在病房需要手機工具 | 給藥確認、VS 記錄無法行動化 |
| **血庫 PWA** | 血袋操作只能用電腦 | 緊急輸血時不便 |
| **統一儀表板** | 站長需切換 CIRS/MIRS | 全局觀不足 |

---

## 3. 重整建議

### 3.1 設計原則

```
原則 1: 電腦 Tab = 管理視角 (Overview + Admin)
原則 2: 手機 PWA = 執行視角 (Action + Recording)
原則 3: 同一功能不做兩次，而是共用 API
原則 4: 護理為核心，串聯所有執行
```

### 3.2 MIRS Index.html Tab 處理

| Tab | 決定 | 理由 | 執行方式 |
|-----|------|------|----------|
| 庫存查詢 | **保留** | 管理視角、報表用 | 維持現狀 |
| 進貨 | **保留** | 桌面作業為主 | 維持現狀 |
| 處置 | **拆分** | 執行面由 Nursing PWA 接手 | 見下方 |
| 血袋管理 | **拆分** | 管理保留，執行做 PWA | 見下方 |
| 設備管理 | **保留** | 管理視角 | Mobile PWA 已處理執行面 |
| 韌性估算 | **保留** | 純管理功能 | 維持現狀 |

### 3.3 處置 Tab 拆分

```
現況：處置 Tab 有三個模式
├── 處置耗材記錄 (surgery) ─────► 保留在 Index (管理/報表)
├── 一般消耗 (consume) ─────────► 移至 Nursing PWA
└── 藥品領用 (dispense) ─────────► 移至 Nursing PWA

拆分後：
┌────────────────────────────┐    ┌────────────────────────────┐
│ MIRS Index - 處置 Tab      │    │ Nursing PWA                │
├────────────────────────────┤    ├────────────────────────────┤
│ • 處置記錄列表 (唯讀)      │    │ • 一般消耗登記             │
│ • 術式統計報表             │    │ • 藥品領用 (MAR)           │
│ • 耗材用量分析             │    │ • 掃碼確認給藥             │
│ • 匯出功能                 │    │ • VS 記錄                  │
└────────────────────────────┘    └────────────────────────────┘
```

### 3.4 血袋 Tab 拆分

```
現況：血袋 Tab
├── 血型庫存統計 ─────────────► 保留在 Index
├── 血袋入庫 ────────────────► 保留在 Index (桌面作業)
├── 血袋領用 ────────────────► **也加到 Nursing PWA**
└── 使用記錄 ────────────────► 保留在 Index

新增：Nursing PWA 血袋功能
┌────────────────────────────┐
│ Nursing PWA - 血袋模式     │
├────────────────────────────┤
│ • 掃碼領用血袋             │
│ • 確認輸血 (寫 executions)  │
│ • 輸血反應記錄             │
│ • 緊急用血快速通道         │
└────────────────────────────┘
```

### 3.5 CIRS PWA 處理

| PWA | 決定 | 理由 |
|-----|------|------|
| Doctor | **保留** | 核心臨床功能 |
| Nurse | **大幅擴充** | 成為 Nursing Workstation |
| Pharmacy | **保留** | 核心調劑功能 |
| Cashdesk | **評估** | 災難情境收費暫停？ |
| Runner | **保留** | 任務執行 |
| Files | **評估** | 可整合至 Admin |

### 3.6 新增 PWA

| 新 PWA | 功能 | 來源 |
|--------|------|------|
| **Nursing PWA (擴充)** | 檢傷 + 病房 + MAR + VS + 交班 | CIRS Nurse + MIRS 處置/血袋 |
| **Dashboard PWA** | 站長統一儀表板 | CIRS Portal + MIRS Index 統計 |

---

## 4. Nursing PWA 完整設計

### 4.1 多模式架構

```
┌─────────────────────────────────────────────────────────┐
│                    Nursing PWA                          │
│                                                         │
│  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐       │
│  │  檢傷   │ │  急診   │ │  病房   │ │  交班   │       │
│  │ Triage │ │   ER    │ │  Ward   │ │ Handoff │       │
│  └────┬────┘ └────┬────┘ └────┬────┘ └────┬────┘       │
│       │           │           │           │             │
│  ┌────┴───────────┴───────────┴───────────┴────┐       │
│  │              共用核心功能                    │       │
│  ├─────────────────────────────────────────────┤       │
│  │  VS 採集   │ 給藥 MAR │ 消耗登記 │ 血袋操作 │       │
│  │  護理紀錄  │ 待辦清單 │ 掃碼確認 │ 位置更新 │       │
│  └─────────────────────────────────────────────┘       │
│                                                         │
│  ┌─────────────────────────────────────────────┐       │
│  │              模式特殊功能                    │       │
│  ├─────────────────────────────────────────────┤       │
│  │  檢傷: START 分流、優先序、等候時間         │       │
│  │  急診: 快速處置、監測警示、醫囑執行         │       │
│  │  病房: Q4H 提醒、傷口評估、I/O、翻身        │       │
│  │  交班: ISBAR 產生、待辦移交、問題追蹤       │       │
│  └─────────────────────────────────────────────┘       │
└─────────────────────────────────────────────────────────┘
```

### 4.2 資料寫入對應

| 功能 | 寫入表 | 呼叫 API |
|------|--------|----------|
| VS 採集 | `vital_signs` | CIRS/MIRS 共用 |
| 給藥 MAR | `executions` | CIRS API |
| 消耗登記 | `executions` + MIRS | MIRS 庫存扣減 |
| 血袋操作 | `executions` + MIRS | MIRS 血庫扣減 |
| 護理紀錄 | `nursing_notes` | CIRS API |
| 交班 | `handoff_records` | CIRS API |
| 位置更新 | `location_logs` | CIRS API |

---

## 5. 功能歸屬總表

### 5.1 最終歸屬

```
┌─────────────────────────────────────────────────────────────────────┐
│                           xIRS v3.0 功能歸屬                         │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  ┌─────────────────┐      ┌─────────────────┐                       │
│  │ CIRS Hub        │      │ MIRS Satellite  │                       │
│  │ (臨床流程)      │      │ (物資韌性)      │                       │
│  ├─────────────────┤      ├─────────────────┤                       │
│  │ Admin Portal    │      │ Index.html      │                       │
│  │ ├─ 掛號管理     │      │ ├─ 庫存查詢     │                       │
│  │ ├─ 候診管理     │      │ ├─ 進貨         │                       │
│  │ ├─ 報表        │      │ ├─ 處置報表     │  ← 執行面移至 Nursing │
│  │ └─ 系統設定    │      │ ├─ 血庫管理     │  ← 執行面移至 Nursing │
│  │                │      │ ├─ 設備管理     │                       │
│  │                │      │ └─ 韌性估算     │                       │
│  └─────────────────┘      └─────────────────┘                       │
│                                                                      │
│  ┌─────────────────────────────────────────────────────────────┐    │
│  │                        PWAs                                  │    │
│  ├─────────────────────────────────────────────────────────────┤    │
│  │                                                              │    │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐     │    │
│  │  │Clinician │  │ Nursing  │  │ Pharmacy │  │ Logistics│     │    │
│  │  │(醫師)    │  │(護理師)  │  │(藥師)    │  │(庫房/EMT)│     │    │
│  │  ├──────────┤  ├──────────┤  ├──────────┤  ├──────────┤     │    │
│  │  │看診      │  │檢傷      │  │調劑      │  │設備檢查  │     │    │
│  │  │開處方    │  │急診執行  │  │發藥      │  │庫存盤點  │     │    │
│  │  │處置決策  │  │病房照護  │  │藥品核對  │  │轉送任務  │     │    │
│  │  │查房      │  │給藥MAR   │  │          │  │物資調撥  │     │    │
│  │  │          │  │消耗登記  │  │          │  │          │     │    │
│  │  │          │  │血袋操作  │  │          │  │          │     │    │
│  │  │          │  │VS記錄    │  │          │  │          │     │    │
│  │  │          │  │交班      │  │          │  │          │     │    │
│  │  └──────────┘  └──────────┘  └──────────┘  └──────────┘     │    │
│  │                                                              │    │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐                   │    │
│  │  │Anesthesia│  │ Dashboard│  │  Runner  │                   │    │
│  │  │(麻醉)    │  │(站長)    │  │(志工)    │                   │    │
│  │  ├──────────┤  ├──────────┤  ├──────────┤                   │    │
│  │  │PIO追蹤   │  │全站總覽  │  │任務接收  │                   │    │
│  │  │麻醉記錄  │  │CIRS+MIRS │  │跑腿確認  │                   │    │
│  │  │PSI互鎖   │  │統計報表  │  │傳送物品  │                   │    │
│  │  └──────────┘  └──────────┘  └──────────┘                   │    │
│  │                                                              │    │
│  └──────────────────────────────────────────────────────────────┘    │
│                                                                      │
│  ┌─────────────────┐                                                │
│  │ HIRS Standalone │  完全獨立，野外救護                            │
│  └─────────────────┘                                                │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

### 5.2 淘汰/整併清單

| 原功能 | 處理 | 去向 |
|--------|------|------|
| MIRS 處置 Tab (一般消耗) | 移除 | Nursing PWA |
| MIRS 處置 Tab (藥品領用) | 移除 | Nursing PWA |
| MIRS 處置 Tab (處置耗材) | 保留 | 報表視角 |
| MIRS 血袋 Tab (領用) | 保留 + PWA | 兩邊都可操作 |
| CIRS Nurse PWA | 大幅擴充 | 成為 Nursing Workstation |
| CIRS Cashdesk | 評估 | 災難情境可能暫停 |
| CIRS Files | 整併 | 移至 Admin Portal |

---

## 6. API 共用策略

### 6.1 庫存扣減統一入口

```
所有庫存扣減都走 MIRS API，不管從哪個 PWA 呼叫

Nursing PWA ──────┐
                  │
Pharmacy PWA ─────┼───► MIRS /api/inventory/consume
                  │
Anesthesia PWA ───┘

好處：
- 單一真相來源
- 不會重複扣
- 離線時 queue intent，上線同步
```

### 6.2 VS 記錄統一入口

```
所有 VS 都寫入統一 vital_signs 表

Nursing PWA ──────┐
                  │
Anesthesia PWA ───┼───► CIRS /api/vital-signs
                  │
EMT PWA ──────────┘

欄位 source_context 標示來源：
- TRIAGE
- ER
- OR
- PACU
- WARD
- AMBULANCE
```

---

## 7. 遷移路徑

### Phase 1: API 統一 (v3.0)

```
□ 建立 /api/vital-signs (統一 VS)
□ 建立 /api/executions (統一執行)
□ MIRS /api/inventory/consume 開放跨系統呼叫
□ MIRS /api/blood/consume 開放跨系統呼叫
```

### Phase 2: Nursing PWA 擴充 (v3.1)

```
□ 新增 Ward Mode
□ 新增 MAR 給藥確認
□ 新增 消耗登記 (呼叫 MIRS)
□ 新增 血袋操作 (呼叫 MIRS)
□ 新增 交班模式
```

### Phase 3: Tab 精簡 (v3.2)

```
□ MIRS 處置 Tab 移除一般消耗/藥品領用
□ MIRS 處置 Tab 改為報表視角
□ 新增 Dashboard PWA
```

### Phase 4: 清理 (v3.3)

```
□ 移除重複功能
□ 統一 UI/UX 風格
□ 文件更新
```

---

## 8. 決策清單

請確認以下決策：

### 8.1 MIRS Tab

| 決策項目 | 建議 | 確認 |
|----------|------|------|
| 庫存查詢 Tab | 保留 | □ |
| 進貨 Tab | 保留 | □ |
| 處置 Tab - 處置耗材 | 保留 (報表) | □ |
| 處置 Tab - 一般消耗 | 移至 Nursing PWA | □ |
| 處置 Tab - 藥品領用 | 移至 Nursing PWA | □ |
| 血袋 Tab | 保留 + PWA 雙軌 | □ |
| 設備 Tab | 保留 | □ |
| 韌性估算 Tab | 保留 | □ |

### 8.2 CIRS PWA

| 決策項目 | 建議 | 確認 |
|----------|------|------|
| Doctor PWA | 保留 | □ |
| Nurse PWA | 大幅擴充為 Nursing | □ |
| Pharmacy PWA | 保留 | □ |
| Cashdesk PWA | 評估保留/暫停 | □ |
| Runner PWA | 保留 | □ |
| Files PWA | 整併至 Admin | □ |

### 8.3 新增

| 決策項目 | 建議 | 確認 |
|----------|------|------|
| Dashboard PWA | 新增 | □ |
| Blood PWA | 整合至 Nursing | □ |

---

## Changelog

| 版本 | 日期 | 變更 |
|------|------|------|
| v1.0 | 2026-01-07 | 初版 |
