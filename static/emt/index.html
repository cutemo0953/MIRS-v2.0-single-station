<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#f59e0b">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>EMT Transfer | MIRS</title>
    <link rel="manifest" href="/static/emt/manifest.json">
    <link rel="icon" type="image/png" href="/static/icons/icon-192.png">
    <link rel="apple-touch-icon" href="/static/icons/icon-192.png">
    <link rel="stylesheet" href="/static/css/tailwind.min.css">
    <link rel="stylesheet" href="/static/css/mirs-colors.css">
    <script defer src="/static/js/alpine.min.js"></script>
    <style>
        [x-cloak] { display: none !important; }
        .status-dot { width: 12px; height: 12px; border-radius: 50%; }
        .status-planning { background-color: #fbbf24; }
        .status-ready { background-color: #22c55e; }
        .status-en_route { background-color: #3b82f6; }
        .status-arrived { background-color: #8b5cf6; }
        .status-completed { background-color: #6b7280; }
        .status-aborted { background-color: #ef4444; }
    </style>
</head>
<body class="bg-amber-50 min-h-screen" x-data="emtTransfer()" x-init="init()">
    <!-- Header -->
    <header class="bg-amber-500 text-white px-4 py-3 shadow-lg sticky top-0 z-50">
        <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
                <a href="/" class="text-white hover:text-amber-100">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
                    </svg>
                </a>
                <h1 class="text-xl font-bold">EMT Transfer</h1>
            </div>
            <div class="flex items-center gap-2">
                <span x-show="!isOnline" class="bg-red-600 text-white text-xs px-2 py-1 rounded">
                    Offline
                </span>
                <button @click="showMissionList = true" class="p-2 hover:bg-amber-600 rounded-lg">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
                    </svg>
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="p-4 pb-24">
        <!-- Step Indicator -->
        <div class="flex justify-center mb-6" x-show="currentMission">
            <div class="flex items-center gap-2 text-sm">
                <template x-for="(step, idx) in ['設定', '整備', '轉送', '結案']" :key="idx">
                    <div class="flex items-center">
                        <div :class="currentStep >= idx ? 'bg-amber-500 text-white' : 'bg-gray-200 text-gray-500'"
                             class="w-8 h-8 rounded-full flex items-center justify-center font-bold">
                            <span x-text="idx + 1"></span>
                        </div>
                        <span class="ml-1 hidden sm:inline" x-text="step"
                              :class="currentStep >= idx ? 'text-amber-700' : 'text-gray-400'"></span>
                        <div x-show="idx < 3" class="w-8 h-0.5 mx-2"
                             :class="currentStep > idx ? 'bg-amber-500' : 'bg-gray-200'"></div>
                    </div>
                </template>
            </div>
        </div>

        <!-- No Mission State -->
        <div x-show="!currentMission" class="text-center py-12">
            <div class="bg-white rounded-2xl shadow-lg p-8 max-w-md mx-auto">
                <div class="w-20 h-20 bg-amber-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg class="w-10 h-10 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M13 10V3L4 14h7v7l9-11h-7z"/>
                    </svg>
                </div>
                <h2 class="text-xl font-bold text-gray-800 mb-2">準備轉送病患</h2>
                <p class="text-gray-500 mb-6">建立新任務以開始物資規劃</p>
                <button @click="showNewMission = true"
                        class="w-full bg-amber-500 hover:bg-amber-600 text-white font-bold py-3 px-6 rounded-xl transition">
                    + 新增轉送任務
                </button>
            </div>
        </div>

        <!-- Step 1: Mission Setup (PLANNING) -->
        <div x-show="currentMission && currentStep === 0" x-cloak>
            <div class="bg-white rounded-xl shadow-lg p-6 mb-4">
                <h2 class="text-lg font-bold text-amber-700 mb-4">任務設定</h2>

                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">目的地</label>
                        <input type="text" x-model="currentMission.destination" readonly
                               class="w-full border border-gray-300 rounded-lg px-3 py-2 bg-gray-50">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">預估路程</label>
                        <div class="flex items-center gap-2">
                            <input type="number" x-model="currentMission.estimated_duration_min" readonly
                                   class="w-20 border border-gray-300 rounded-lg px-3 py-2 bg-gray-50 text-center">
                            <span class="text-gray-500">分鐘</span>
                            <span class="text-amber-600 font-medium" x-text="'(' + (currentMission.estimated_duration_min / 60).toFixed(1) + ' 小時)'"></span>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">病患狀況</label>
                        <div class="flex gap-2 flex-wrap">
                            <span class="px-3 py-1 rounded-full text-sm"
                                  :class="currentMission.patient_condition === 'INTUBATED' ? 'bg-red-100 text-red-700' :
                                          currentMission.patient_condition === 'CRITICAL' ? 'bg-orange-100 text-orange-700' :
                                          'bg-green-100 text-green-700'"
                                  x-text="currentMission.patient_condition === 'INTUBATED' ? '插管' :
                                          currentMission.patient_condition === 'CRITICAL' ? '危急' : '穩定'">
                            </span>
                            <span x-show="currentMission.oxygen_requirement_lpm > 0"
                                  class="px-3 py-1 rounded-full bg-blue-100 text-blue-700 text-sm"
                                  x-text="'O2: ' + currentMission.oxygen_requirement_lpm + ' L/min'">
                            </span>
                            <span x-show="currentMission.iv_rate_mlhr > 0"
                                  class="px-3 py-1 rounded-full bg-purple-100 text-purple-700 text-sm"
                                  x-text="'IV: ' + currentMission.iv_rate_mlhr + ' mL/hr'">
                            </span>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">安全係數</label>
                        <div class="flex items-center gap-2">
                            <span class="text-2xl font-bold text-amber-600" x-text="currentMission.safety_factor + '×'"></span>
                            <span class="text-gray-500">備量</span>
                        </div>
                    </div>
                </div>
            </div>

            <button @click="goToStep(1)"
                    class="w-full bg-amber-500 hover:bg-amber-600 text-white font-bold py-4 rounded-xl transition flex items-center justify-center gap-2">
                <span>查看物資清單</span>
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                </svg>
            </button>
        </div>

        <!-- Step 2: Loadout Confirmation (PLANNING → READY) -->
        <div x-show="currentMission && currentStep === 1" x-cloak>
            <div class="bg-white rounded-xl shadow-lg p-6 mb-4">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-bold text-amber-700">物資整備</h2>
                    <span class="text-sm text-gray-500" x-text="currentMission.estimated_duration_min + '分 × ' + currentMission.safety_factor + '倍'"></span>
                </div>

                <div class="space-y-3">
                    <template x-for="item in missionItems" :key="item.id">
                        <div class="border border-amber-200 rounded-lg p-4 bg-amber-50">
                            <div class="flex justify-between items-start mb-2">
                                <div>
                                    <span class="font-medium text-gray-800" x-text="item.item_name"></span>
                                    <span class="text-xs text-gray-500 ml-2" x-text="item.item_type"></span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <input type="number" x-model.number="item.carried_qty"
                                           class="w-16 border border-amber-300 rounded px-2 py-1 text-center"
                                           :placeholder="item.suggested_qty">
                                    <span class="text-gray-500" x-text="item.unit"></span>
                                </div>
                            </div>
                            <div class="text-xs text-gray-500" x-text="item.calculation_explain"></div>

                            <!-- Special input for oxygen PSI -->
                            <div x-show="item.item_type === 'OXYGEN'" class="mt-2">
                                <input type="text" x-model="item.initial_status"
                                       placeholder="鋼瓶壓力 (如: PSI 2100)"
                                       class="w-full border border-gray-300 rounded px-2 py-1 text-sm">
                            </div>

                            <label class="flex items-center gap-2 mt-2 cursor-pointer">
                                <input type="checkbox" x-model="item.checked" class="w-5 h-5 text-amber-500 rounded">
                                <span class="text-sm text-gray-600">已確認</span>
                            </label>
                        </div>
                    </template>
                </div>
            </div>

            <div class="flex gap-3">
                <button @click="goToStep(0)"
                        class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-4 rounded-xl transition">
                    返回
                </button>
                <button @click="confirmLoadout()"
                        :disabled="!allItemsChecked"
                        :class="allItemsChecked ? 'bg-amber-500 hover:bg-amber-600' : 'bg-gray-300 cursor-not-allowed'"
                        class="flex-1 text-white font-bold py-4 rounded-xl transition">
                    確認攜帶
                </button>
            </div>
        </div>

        <!-- Step 3: En Route (EN_ROUTE) -->
        <div x-show="currentMission && currentStep === 2" x-cloak>
            <div class="bg-gradient-to-br from-amber-500 to-orange-500 rounded-xl shadow-lg p-6 text-white mb-4">
                <div class="text-center mb-4">
                    <div class="text-sm opacity-80">目的地</div>
                    <div class="text-2xl font-bold" x-text="currentMission.destination"></div>
                </div>

                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div class="bg-white/20 rounded-lg p-3 text-center">
                        <div class="text-xs opacity-80">已行駛</div>
                        <div class="text-xl font-bold" x-text="elapsedTime + ' min'"></div>
                    </div>
                    <div class="bg-white/20 rounded-lg p-3 text-center">
                        <div class="text-xs opacity-80">預估</div>
                        <div class="text-xl font-bold" x-text="currentMission.estimated_duration_min + ' min'"></div>
                    </div>
                </div>

                <!-- Progress bar -->
                <div class="h-3 bg-white/30 rounded-full overflow-hidden">
                    <div class="h-full bg-white transition-all duration-1000"
                         :style="'width: ' + Math.min(100, (elapsedTime / currentMission.estimated_duration_min) * 100) + '%'"></div>
                </div>
            </div>

            <!-- Supplies Status -->
            <div class="bg-white rounded-xl shadow-lg p-6 mb-4">
                <h3 class="font-bold text-gray-700 mb-3">物資狀態</h3>
                <div class="space-y-2">
                    <template x-for="item in missionItems.filter(i => i.carried_qty > 0)" :key="item.id">
                        <div class="flex justify-between items-center py-2 border-b border-gray-100">
                            <span x-text="item.item_name"></span>
                            <span class="font-medium" x-text="item.carried_qty + ' ' + item.unit"></span>
                        </div>
                    </template>
                </div>
            </div>

            <button @click="arriveMission()"
                    class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-4 rounded-xl transition">
                抵達目的地
            </button>
        </div>

        <!-- Step 4: Recheck & Finalize (ARRIVED) -->
        <div x-show="currentMission && currentStep === 3" x-cloak>
            <div class="bg-white rounded-xl shadow-lg p-6 mb-4">
                <h2 class="text-lg font-bold text-amber-700 mb-4">返站物資確認</h2>

                <div class="space-y-3">
                    <template x-for="item in missionItems.filter(i => i.carried_qty > 0)" :key="item.id">
                        <div class="border border-gray-200 rounded-lg p-4">
                            <div class="flex justify-between items-center mb-2">
                                <span class="font-medium" x-text="item.item_name"></span>
                                <span class="text-gray-500" x-text="'攜帶: ' + item.carried_qty + ' ' + item.unit"></span>
                            </div>
                            <div class="flex items-center gap-2">
                                <label class="text-sm text-gray-600">剩餘:</label>
                                <input type="number" x-model.number="item.returned_qty"
                                       :max="item.carried_qty" min="0"
                                       class="w-20 border border-gray-300 rounded px-2 py-1 text-center">
                                <span class="text-gray-500" x-text="item.unit"></span>
                                <span class="text-sm ml-auto"
                                      :class="(item.carried_qty - (item.returned_qty || 0)) > 0 ? 'text-red-500' : 'text-green-500'"
                                      x-text="'消耗: ' + (item.carried_qty - (item.returned_qty || 0))">
                                </span>
                            </div>

                            <!-- Final status for oxygen -->
                            <div x-show="item.item_type === 'OXYGEN'" class="mt-2">
                                <input type="text" x-model="item.final_status"
                                       placeholder="剩餘壓力 (如: PSI 500)"
                                       class="w-full border border-gray-300 rounded px-2 py-1 text-sm">
                            </div>
                        </div>
                    </template>
                </div>
            </div>

            <!-- Incoming Items -->
            <div class="bg-white rounded-xl shadow-lg p-6 mb-4">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-gray-700">外帶物資</h3>
                    <button @click="showAddIncoming = true" class="text-amber-600 hover:text-amber-700 text-sm font-medium">
                        + 新增
                    </button>
                </div>

                <div x-show="incomingItems.length === 0" class="text-center py-4 text-gray-400">
                    無外帶物資
                </div>

                <div class="space-y-2">
                    <template x-for="(item, idx) in incomingItems" :key="idx">
                        <div class="flex justify-between items-center py-2 border-b border-gray-100">
                            <div>
                                <span x-text="item.item_name"></span>
                                <span class="text-xs text-gray-500 ml-1" x-text="'(' + item.source_station + ')'"></span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span x-text="item.quantity + ' ' + item.unit"></span>
                                <button @click="incomingItems.splice(idx, 1)" class="text-red-400 hover:text-red-600">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </template>
                </div>
            </div>

            <button @click="finalizeMission()"
                    class="w-full bg-amber-500 hover:bg-amber-600 text-white font-bold py-4 rounded-xl transition">
                結案歸檔
            </button>
        </div>

        <!-- Completed State -->
        <div x-show="currentMission && currentMission.status === 'COMPLETED'" x-cloak>
            <div class="bg-green-50 rounded-xl p-8 text-center">
                <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                    </svg>
                </div>
                <h2 class="text-xl font-bold text-green-700 mb-2">任務完成</h2>
                <p class="text-gray-500 mb-6" x-text="'任務編號: ' + currentMission.mission_id"></p>
                <button @click="currentMission = null; currentStep = 0"
                        class="bg-amber-500 hover:bg-amber-600 text-white font-bold py-3 px-6 rounded-xl transition">
                    開始新任務
                </button>
            </div>
        </div>
    </main>

    <!-- New Mission Modal -->
    <div x-show="showNewMission" x-cloak
         class="fixed inset-0 bg-black/50 z-50 flex items-end sm:items-center justify-center"
         @click.self="showNewMission = false">
        <div class="bg-white rounded-t-2xl sm:rounded-2xl w-full sm:max-w-md max-h-[90vh] overflow-y-auto"
             @click.stop>
            <div class="p-6">
                <h2 class="text-xl font-bold text-amber-700 mb-4">新增轉送任務</h2>

                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">目的地 *</label>
                        <input type="text" x-model="newMission.destination"
                               placeholder="如: 國軍台中總醫院"
                               class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-amber-500 focus:border-amber-500">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">預估路程 (分鐘) *</label>
                        <input type="number" x-model.number="newMission.estimated_duration_min"
                               min="10" max="720" placeholder="120"
                               class="w-full border border-gray-300 rounded-lg px-3 py-2">
                        <div class="mt-1 flex gap-2">
                            <button @click="newMission.estimated_duration_min = 30" class="text-xs px-2 py-1 bg-gray-100 rounded hover:bg-gray-200">30分</button>
                            <button @click="newMission.estimated_duration_min = 60" class="text-xs px-2 py-1 bg-gray-100 rounded hover:bg-gray-200">1時</button>
                            <button @click="newMission.estimated_duration_min = 120" class="text-xs px-2 py-1 bg-gray-100 rounded hover:bg-gray-200">2時</button>
                            <button @click="newMission.estimated_duration_min = 180" class="text-xs px-2 py-1 bg-gray-100 rounded hover:bg-gray-200">3時</button>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">病患狀況</label>
                        <div class="flex gap-2">
                            <button @click="newMission.patient_condition = 'STABLE'"
                                    :class="newMission.patient_condition === 'STABLE' ? 'bg-green-500 text-white' : 'bg-gray-100'"
                                    class="flex-1 py-2 rounded-lg transition">穩定</button>
                            <button @click="newMission.patient_condition = 'CRITICAL'"
                                    :class="newMission.patient_condition === 'CRITICAL' ? 'bg-orange-500 text-white' : 'bg-gray-100'"
                                    class="flex-1 py-2 rounded-lg transition">危急</button>
                            <button @click="newMission.patient_condition = 'INTUBATED'"
                                    :class="newMission.patient_condition === 'INTUBATED' ? 'bg-red-500 text-white' : 'bg-gray-100'"
                                    class="flex-1 py-2 rounded-lg transition">插管</button>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">氧氣需求 (L/min)</label>
                        <div class="flex gap-2">
                            <button @click="newMission.oxygen_requirement_lpm = 0"
                                    :class="newMission.oxygen_requirement_lpm === 0 ? 'bg-amber-500 text-white' : 'bg-gray-100'"
                                    class="flex-1 py-2 rounded-lg transition">無</button>
                            <button @click="newMission.oxygen_requirement_lpm = 2"
                                    :class="newMission.oxygen_requirement_lpm === 2 ? 'bg-amber-500 text-white' : 'bg-gray-100'"
                                    class="flex-1 py-2 rounded-lg transition">2</button>
                            <button @click="newMission.oxygen_requirement_lpm = 6"
                                    :class="newMission.oxygen_requirement_lpm === 6 ? 'bg-amber-500 text-white' : 'bg-gray-100'"
                                    class="flex-1 py-2 rounded-lg transition">6</button>
                            <button @click="newMission.oxygen_requirement_lpm = 10"
                                    :class="newMission.oxygen_requirement_lpm === 10 ? 'bg-amber-500 text-white' : 'bg-gray-100'"
                                    class="flex-1 py-2 rounded-lg transition">10</button>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">輸液速度</label>
                        <div class="flex gap-2">
                            <button @click="newMission.iv_rate_mlhr = 0"
                                    :class="newMission.iv_rate_mlhr === 0 ? 'bg-amber-500 text-white' : 'bg-gray-100'"
                                    class="flex-1 py-2 rounded-lg transition text-sm">無</button>
                            <button @click="newMission.iv_rate_mlhr = 30"
                                    :class="newMission.iv_rate_mlhr === 30 ? 'bg-amber-500 text-white' : 'bg-gray-100'"
                                    class="flex-1 py-2 rounded-lg transition text-sm">KVO</button>
                            <button @click="newMission.iv_rate_mlhr = 100"
                                    :class="newMission.iv_rate_mlhr === 100 ? 'bg-amber-500 text-white' : 'bg-gray-100'"
                                    class="flex-1 py-2 rounded-lg transition text-sm">維持</button>
                            <button @click="newMission.iv_rate_mlhr = 200"
                                    :class="newMission.iv_rate_mlhr === 200 ? 'bg-amber-500 text-white' : 'bg-gray-100'"
                                    class="flex-1 py-2 rounded-lg transition text-sm">快速</button>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">安全係數</label>
                        <div class="flex items-center gap-4">
                            <input type="range" x-model.number="newMission.safety_factor"
                                   min="1" max="5" step="0.5"
                                   class="flex-1">
                            <span class="text-xl font-bold text-amber-600" x-text="newMission.safety_factor + '×'"></span>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">EMT 姓名</label>
                        <input type="text" x-model="newMission.emt_name"
                               placeholder="選填"
                               class="w-full border border-gray-300 rounded-lg px-3 py-2">
                    </div>
                </div>

                <div class="flex gap-3 mt-6">
                    <button @click="showNewMission = false"
                            class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-3 rounded-xl transition">
                        取消
                    </button>
                    <button @click="createMission()"
                            :disabled="!newMission.destination || !newMission.estimated_duration_min"
                            :class="newMission.destination && newMission.estimated_duration_min ? 'bg-amber-500 hover:bg-amber-600' : 'bg-gray-300 cursor-not-allowed'"
                            class="flex-1 text-white font-bold py-3 rounded-xl transition">
                        建立任務
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Incoming Item Modal -->
    <div x-show="showAddIncoming" x-cloak
         class="fixed inset-0 bg-black/50 z-50 flex items-end sm:items-center justify-center"
         @click.self="showAddIncoming = false">
        <div class="bg-white rounded-t-2xl sm:rounded-2xl w-full sm:max-w-md p-6" @click.stop>
            <h3 class="text-lg font-bold text-amber-700 mb-4">新增外帶物資</h3>

            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">物資名稱</label>
                    <input type="text" x-model="newIncoming.item_name"
                           class="w-full border border-gray-300 rounded-lg px-3 py-2">
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">數量</label>
                        <input type="number" x-model.number="newIncoming.quantity"
                               class="w-full border border-gray-300 rounded-lg px-3 py-2">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">單位</label>
                        <input type="text" x-model="newIncoming.unit" placeholder="個"
                               class="w-full border border-gray-300 rounded-lg px-3 py-2">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">來源站點</label>
                    <input type="text" x-model="newIncoming.source_station"
                           placeholder="如: 野戰醫院"
                           class="w-full border border-gray-300 rounded-lg px-3 py-2">
                </div>
            </div>

            <div class="flex gap-3 mt-6">
                <button @click="showAddIncoming = false"
                        class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-3 rounded-xl">
                    取消
                </button>
                <button @click="addIncomingItem()"
                        class="flex-1 bg-amber-500 hover:bg-amber-600 text-white font-bold py-3 rounded-xl">
                    新增
                </button>
            </div>
        </div>
    </div>

    <!-- Mission List Sidebar -->
    <div x-show="showMissionList" x-cloak
         class="fixed inset-0 bg-black/50 z-50"
         @click.self="showMissionList = false">
        <div class="absolute right-0 top-0 bottom-0 w-80 bg-white shadow-xl overflow-y-auto"
             x-transition:enter="transition ease-out duration-200"
             x-transition:enter-start="translate-x-full"
             x-transition:enter-end="translate-x-0"
             x-transition:leave="transition ease-in duration-150"
             x-transition:leave-start="translate-x-0"
             x-transition:leave-end="translate-x-full">
            <div class="p-4 border-b border-gray-200 flex justify-between items-center">
                <h2 class="font-bold text-gray-800">任務列表</h2>
                <button @click="showMissionList = false" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <div class="p-4 space-y-3">
                <template x-for="m in missionList" :key="m.mission_id">
                    <button @click="loadMission(m.mission_id); showMissionList = false"
                            class="w-full text-left bg-gray-50 hover:bg-amber-50 rounded-lg p-3 transition">
                        <div class="flex justify-between items-start">
                            <div>
                                <div class="font-medium text-gray-800" x-text="m.destination"></div>
                                <div class="text-xs text-gray-500" x-text="m.mission_id"></div>
                            </div>
                            <div class="status-dot" :class="'status-' + m.status.toLowerCase()"></div>
                        </div>
                    </button>
                </template>
                <div x-show="missionList.length === 0" class="text-center py-8 text-gray-400">
                    無任務記錄
                </div>
            </div>
        </div>
    </div>

    <script>
        function emtTransfer() {
            return {
                // State
                isOnline: navigator.onLine,
                showNewMission: false,
                showMissionList: false,
                showAddIncoming: false,
                currentMission: null,
                missionItems: [],
                incomingItems: [],
                missionList: [],
                currentStep: 0,
                elapsedTime: 0,
                elapsedTimer: null,

                // New mission form
                newMission: {
                    destination: '',
                    estimated_duration_min: 120,
                    patient_condition: 'STABLE',
                    oxygen_requirement_lpm: 0,
                    iv_rate_mlhr: 0,
                    ventilator_required: false,
                    safety_factor: 3.0,
                    emt_name: ''
                },

                // New incoming item form
                newIncoming: {
                    item_type: 'CONSUMABLE',
                    item_name: '',
                    quantity: 1,
                    unit: '個',
                    source_station: ''
                },

                // Computed
                get allItemsChecked() {
                    return this.missionItems.every(i => i.checked);
                },

                // Methods
                async init() {
                    // Online/offline detection
                    window.addEventListener('online', () => this.isOnline = true);
                    window.addEventListener('offline', () => this.isOnline = false);

                    // Load mission list
                    await this.loadMissionList();

                    // Check for active mission
                    const activeMissions = this.missionList.filter(m => !['COMPLETED', 'ABORTED'].includes(m.status));
                    if (activeMissions.length > 0) {
                        await this.loadMission(activeMissions[0].mission_id);
                    }
                },

                async loadMissionList() {
                    try {
                        const res = await fetch('/api/transfer/missions?limit=20');
                        const data = await res.json();
                        this.missionList = data.missions || [];
                    } catch (e) {
                        console.error('Failed to load missions:', e);
                    }
                },

                async loadMission(missionId) {
                    try {
                        const res = await fetch(`/api/transfer/missions/${missionId}`);
                        const data = await res.json();
                        this.currentMission = data.mission;
                        this.missionItems = data.items || [];
                        this.incomingItems = data.incoming_items || [];

                        // Set initial values
                        this.missionItems.forEach(item => {
                            if (!item.carried_qty) item.carried_qty = item.suggested_qty;
                            if (!item.returned_qty) item.returned_qty = item.carried_qty;
                        });

                        // Determine current step based on status
                        this.updateStepFromStatus();

                        // Start elapsed timer if en route
                        if (this.currentMission.status === 'EN_ROUTE') {
                            this.startElapsedTimer();
                        }
                    } catch (e) {
                        console.error('Failed to load mission:', e);
                    }
                },

                updateStepFromStatus() {
                    const status = this.currentMission?.status;
                    if (status === 'PLANNING') this.currentStep = 0;
                    else if (status === 'READY') this.currentStep = 1;
                    else if (status === 'EN_ROUTE') this.currentStep = 2;
                    else if (status === 'ARRIVED') this.currentStep = 3;
                    else this.currentStep = 0;
                },

                goToStep(step) {
                    this.currentStep = step;
                },

                async createMission() {
                    try {
                        const res = await fetch('/api/transfer/missions', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(this.newMission)
                        });
                        const data = await res.json();

                        this.showNewMission = false;
                        await this.loadMission(data.mission_id);
                        await this.loadMissionList();

                        // Reset form
                        this.newMission = {
                            destination: '',
                            estimated_duration_min: 120,
                            patient_condition: 'STABLE',
                            oxygen_requirement_lpm: 0,
                            iv_rate_mlhr: 0,
                            ventilator_required: false,
                            safety_factor: 3.0,
                            emt_name: ''
                        };
                    } catch (e) {
                        console.error('Failed to create mission:', e);
                        alert('建立任務失敗');
                    }
                },

                async confirmLoadout() {
                    try {
                        const items = this.missionItems.map(i => ({
                            item_id: i.id,
                            carried_qty: i.carried_qty,
                            initial_status: i.initial_status
                        }));

                        const res = await fetch(`/api/transfer/missions/${this.currentMission.mission_id}/confirm`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(items)
                        });

                        if (res.ok) {
                            // Depart immediately after confirm
                            await this.departMission();
                        }
                    } catch (e) {
                        console.error('Failed to confirm:', e);
                        alert('確認失敗');
                    }
                },

                async departMission() {
                    try {
                        const res = await fetch(`/api/transfer/missions/${this.currentMission.mission_id}/depart`, {
                            method: 'POST'
                        });
                        if (res.ok) {
                            this.currentMission.status = 'EN_ROUTE';
                            this.currentStep = 2;
                            this.startElapsedTimer();
                        }
                    } catch (e) {
                        console.error('Failed to depart:', e);
                    }
                },

                startElapsedTimer() {
                    if (this.elapsedTimer) clearInterval(this.elapsedTimer);

                    const departed = new Date(this.currentMission.departed_at);
                    this.elapsedTimer = setInterval(() => {
                        this.elapsedTime = Math.floor((Date.now() - departed.getTime()) / 60000);
                    }, 1000);
                },

                async arriveMission() {
                    try {
                        const res = await fetch(`/api/transfer/missions/${this.currentMission.mission_id}/arrive`, {
                            method: 'POST'
                        });
                        if (res.ok) {
                            if (this.elapsedTimer) clearInterval(this.elapsedTimer);
                            this.currentMission.status = 'ARRIVED';
                            this.currentStep = 3;
                        }
                    } catch (e) {
                        console.error('Failed to arrive:', e);
                    }
                },

                addIncomingItem() {
                    this.incomingItems.push({...this.newIncoming});
                    this.newIncoming = {
                        item_type: 'CONSUMABLE',
                        item_name: '',
                        quantity: 1,
                        unit: '個',
                        source_station: ''
                    };
                    this.showAddIncoming = false;
                },

                async finalizeMission() {
                    try {
                        // Submit recheck
                        const recheckItems = this.missionItems
                            .filter(i => i.carried_qty > 0)
                            .map(i => ({
                                item_id: i.id,
                                returned_qty: i.returned_qty || 0,
                                final_status: i.final_status
                            }));

                        await fetch(`/api/transfer/missions/${this.currentMission.mission_id}/recheck`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(recheckItems)
                        });

                        // Submit incoming items
                        if (this.incomingItems.length > 0) {
                            await fetch(`/api/transfer/missions/${this.currentMission.mission_id}/incoming`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(this.incomingItems)
                            });
                        }

                        // Finalize
                        const res = await fetch(`/api/transfer/missions/${this.currentMission.mission_id}/finalize`, {
                            method: 'POST'
                        });

                        if (res.ok) {
                            this.currentMission.status = 'COMPLETED';
                            await this.loadMissionList();
                        }
                    } catch (e) {
                        console.error('Failed to finalize:', e);
                        alert('結案失敗');
                    }
                }
            };
        }
    </script>
</body>
</html>
