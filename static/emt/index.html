<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#f59e0b">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>EMT Transfer | MIRS</title>
    <link rel="manifest" href="/static/emt/manifest.json">
    <link rel="icon" type="image/png" href="/static/icons/icon-192.png">
    <link rel="apple-touch-icon" href="/static/icons/icon-192.png">
    <link rel="stylesheet" href="/static/css/tailwind.min.css">
    <link rel="stylesheet" href="/static/css/mirs-colors.css">
    <script defer src="/static/js/alpine.min.js"></script>
    <style>
        [x-cloak] { display: none !important; }
        /* 解決 sticky header 遮住內容的問題 */
        html { scroll-padding-top: 60px; }

        /* iOS Safari 捲動修復 */
        .ios-scroll {
            -webkit-overflow-scrolling: touch;
            overscroll-behavior: contain;
        }

        .status-dot { width: 12px; height: 12px; border-radius: 50%; }
        .status-planning { background-color: #fbbf24; }
        .status-ready { background-color: #22c55e; }
        .status-en_route { background-color: #3b82f6; }
        .status-arrived { background-color: #8b5cf6; }
        .status-completed { background-color: #6b7280; }
        .status-aborted { background-color: #ef4444; }
    </style>
</head>
<body class="bg-amber-50 min-h-screen" x-data="emtTransfer()" x-init="init()">
    <!-- Header -->
    <header class="bg-amber-500 text-white px-4 py-3 shadow-lg sticky top-0 z-50">
        <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
                <!-- v3.2.3: Smart back button - returns to previous step or MIRS -->
                <button @click="handleBackButton()" class="text-white hover:text-amber-100">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
                    </svg>
                </button>
                <h1 class="text-xl font-bold">EMT Transfer</h1>
            </div>
            <div class="flex items-center gap-2">
                <span x-show="!isOnline" class="bg-red-600 text-white text-xs px-2 py-1 rounded">
                    Offline
                </span>
                <button @click="showMissionList = true" class="p-2 hover:bg-amber-600 rounded-lg">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
                    </svg>
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="p-4 pb-24">
        <!-- Step Indicator (可點擊返回) -->
        <div class="flex justify-center mb-6" x-show="currentMission">
            <div class="flex items-center gap-2 text-sm">
                <template x-for="(step, idx) in ['設定', '整備', '轉送', '結案']" :key="idx">
                    <div class="flex items-center">
                        <button @click="idx <= currentStep && goToStep(idx)"
                             :class="[
                                 currentStep >= idx ? 'bg-amber-500 text-white' : 'bg-gray-200 text-gray-500',
                                 idx < currentStep ? 'hover:bg-amber-600 cursor-pointer ring-2 ring-amber-300' : '',
                                 idx === currentStep ? 'ring-2 ring-amber-400' : ''
                             ]"
                             class="w-8 h-8 rounded-full flex items-center justify-center font-bold transition-all"
                             :disabled="idx > currentStep">
                            <span x-text="idx + 1"></span>
                        </button>
                        <span class="ml-1 hidden sm:inline" x-text="step"
                              :class="currentStep >= idx ? 'text-amber-700' : 'text-gray-400'"
                              @click="idx <= currentStep && goToStep(idx)"
                              :style="idx < currentStep ? 'cursor: pointer' : ''"></span>
                        <div x-show="idx < 3" class="w-8 h-0.5 mx-2"
                             :class="currentStep > idx ? 'bg-amber-500' : 'bg-gray-200'"></div>
                    </div>
                </template>
            </div>
        </div>

        <!-- No Mission State - v3.0: Show Pending Handoffs from CIRS -->
        <div x-show="!currentMission" class="py-4">
            <!-- Pending Handoffs Section -->
            <div class="bg-white rounded-2xl shadow-lg p-4 mb-4">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-lg font-bold text-gray-800">待接收交班</h2>
                    <button @click="fetchPendingHandoffs()"
                            class="flex items-center gap-1 px-3 py-1.5 text-sm bg-amber-100 text-amber-700 rounded-lg hover:bg-amber-200"
                            :disabled="loadingHandoffs">
                        <svg class="w-4 h-4" :class="loadingHandoffs ? 'animate-spin' : ''" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                        </svg>
                        <span x-text="loadingHandoffs ? '載入中...' : '重新整理'"></span>
                    </button>
                </div>

                <!-- Handoff List -->
                <div x-show="pendingHandoffs.length > 0" class="space-y-3">
                    <template x-for="handoff in pendingHandoffs" :key="handoff.handoff_id">
                        <div class="border rounded-xl p-4 hover:border-amber-300 transition cursor-pointer"
                             :class="handoff.priority === 'STAT' ? 'border-red-300 bg-red-50' : handoff.priority === 'URGENT' ? 'border-orange-300 bg-orange-50' : 'border-gray-200'"
                             @click="viewHandoffDetail(handoff)">
                            <div class="flex items-start justify-between mb-2">
                                <div class="flex items-center gap-2">
                                    <span class="px-2 py-0.5 text-xs font-bold rounded"
                                          :class="handoff.priority === 'STAT' ? 'bg-red-500 text-white' : handoff.priority === 'URGENT' ? 'bg-orange-500 text-white' : 'bg-gray-200 text-gray-700'"
                                          x-text="handoff.priority || 'NORMAL'"></span>
                                    <span class="text-xs text-gray-500" x-text="handoff.format"></span>
                                </div>
                                <span class="text-xs text-gray-400" x-text="formatTime(handoff.created_at)"></span>
                            </div>
                            <div class="font-bold text-gray-800 mb-1">
                                <span x-text="handoff.patient_name || '未知'"></span>
                                <span class="text-gray-500 font-normal" x-text="handoff.patient_age ? ' ' + handoff.patient_age : ''"></span>
                            </div>
                            <div class="text-sm text-gray-600 mb-2" x-text="handoff.chief_complaint || '無主訴'"></div>
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-2 text-xs text-gray-500">
                                    <span x-show="handoff.destination">目的地: <span x-text="handoff.destination"></span></span>
                                    <span x-show="handoff.latest_vs?.o2_lpm" class="text-blue-600">O2: <span x-text="handoff.latest_vs?.o2_lpm"></span> L/min</span>
                                </div>
                                <button @click.stop="viewHandoffDetail(handoff)"
                                        class="px-3 py-1.5 text-sm bg-amber-500 text-white rounded-lg hover:bg-amber-600">
                                    接收此交班
                                </button>
                            </div>
                        </div>
                    </template>
                </div>

                <!-- Empty State -->
                <div x-show="pendingHandoffs.length === 0 && !loadingHandoffs" class="text-center py-8">
                    <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-3">
                        <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                        </svg>
                    </div>
                    <p class="text-gray-500 mb-2">目前沒有待接收的交班</p>
                    <p class="text-xs text-gray-400">CIRS Hub: <span x-text="cirsHubUrl"></span></p>
                </div>
            </div>

            <!-- Manual Mission Button -->
            <div class="bg-white rounded-2xl shadow-lg p-4">
                <div class="flex items-center gap-3">
                    <div class="w-12 h-12 bg-amber-100 rounded-full flex items-center justify-center">
                        <svg class="w-6 h-6 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                        </svg>
                    </div>
                    <div class="flex-1">
                        <h3 class="font-bold text-gray-800">手動新增任務</h3>
                        <p class="text-sm text-gray-500">無 CIRS 交班時使用</p>
                    </div>
                    <button @click="showNewMission = true"
                            class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition">
                        新增
                    </button>
                </div>
            </div>
        </div>

        <!-- Step 0: Mission Setup (PLANNING) - v3.2.5 完整欄位 -->
        <div x-show="currentMission && currentStep === 0" x-cloak>
            <div class="bg-white rounded-xl shadow-lg p-6 mb-4">
                <h2 class="text-lg font-bold text-amber-700 mb-4">任務設定</h2>

                <div class="space-y-4">
                    <!-- 目的地 -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">目的地 <span class="text-red-500">*</span></label>
                        <input type="text" x-model="editMission.destination"
                               placeholder="輸入目的地醫院/單位"
                               class="w-full border border-amber-300 rounded-lg px-3 py-2 focus:border-amber-500 focus:ring-1 focus:ring-amber-500">
                    </div>

                    <!-- 單程 ETA -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">單程 ETA</label>
                        <div class="flex items-center gap-2 flex-wrap">
                            <input type="number" x-model.number="editMission.eta_min" min="5" max="240"
                                   class="w-20 border border-amber-300 rounded-lg px-3 py-2 text-center focus:border-amber-500">
                            <span class="text-gray-500">分鐘</span>
                            <div class="flex gap-1">
                                <button @click="editMission.eta_min = 30" type="button" class="text-xs px-2 py-1 bg-gray-100 rounded hover:bg-gray-200">30分</button>
                                <button @click="editMission.eta_min = 60" type="button" class="text-xs px-2 py-1 bg-gray-100 rounded hover:bg-gray-200">1時</button>
                                <button @click="editMission.eta_min = 90" type="button" class="text-xs px-2 py-1 bg-gray-100 rounded hover:bg-gray-200">1.5時</button>
                            </div>
                        </div>
                    </div>

                    <!-- 預估總時間 (來回+處置) -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">預估總時間 (來回+處置)</label>
                        <div class="flex items-center gap-2 flex-wrap">
                            <input type="number" x-model.number="editMission.estimated_duration_min" min="10" max="480"
                                   class="w-20 border border-amber-300 rounded-lg px-3 py-2 text-center focus:border-amber-500">
                            <span class="text-gray-500">分鐘</span>
                            <span class="text-amber-600 font-medium" x-text="'(' + (editMission.estimated_duration_min / 60).toFixed(1) + ' 小時)'"></span>
                            <div class="flex gap-1">
                                <button @click="editMission.estimated_duration_min = (editMission.eta_min || 30) * 2" type="button" class="text-xs px-2 py-1 bg-gray-100 rounded hover:bg-gray-200">來回</button>
                                <button @click="editMission.estimated_duration_min = (editMission.eta_min || 30) * 2 + 30" type="button" class="text-xs px-2 py-1 bg-gray-100 rounded hover:bg-gray-200">+30分</button>
                                <button @click="editMission.estimated_duration_min = (editMission.eta_min || 30) * 2 + 60" type="button" class="text-xs px-2 py-1 bg-gray-100 rounded hover:bg-gray-200">+1時</button>
                            </div>
                        </div>
                    </div>

                    <!-- 病患狀況 -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">病患狀況</label>
                        <div class="flex gap-2 flex-wrap">
                            <button @click="editMission.patient_condition = 'STABLE'" type="button"
                                    :class="editMission.patient_condition === 'STABLE' ? 'bg-green-500 text-white' : 'bg-gray-100 text-gray-700'"
                                    class="px-3 py-1.5 rounded-lg text-sm font-medium transition">穩定</button>
                            <button @click="editMission.patient_condition = 'CRITICAL'" type="button"
                                    :class="editMission.patient_condition === 'CRITICAL' ? 'bg-orange-500 text-white' : 'bg-gray-100 text-gray-700'"
                                    class="px-3 py-1.5 rounded-lg text-sm font-medium transition">危急</button>
                            <button @click="editMission.patient_condition = 'INTUBATED'" type="button"
                                    :class="editMission.patient_condition === 'INTUBATED' ? 'bg-red-500 text-white' : 'bg-gray-100 text-gray-700'"
                                    class="px-3 py-1.5 rounded-lg text-sm font-medium transition">插管</button>
                        </div>
                    </div>

                    <!-- 氧氣需求 -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">氧氣需求</label>
                        <div class="flex gap-2 flex-wrap">
                            <button @click="editMission.o2_lpm = 0" type="button"
                                    :class="editMission.o2_lpm === 0 ? 'bg-amber-500 text-white' : 'bg-gray-100 text-gray-700'"
                                    class="px-3 py-1.5 rounded-lg text-sm font-medium transition">無</button>
                            <button @click="editMission.o2_lpm = 3" type="button"
                                    :class="editMission.o2_lpm === 3 ? 'bg-amber-500 text-white' : 'bg-gray-100 text-gray-700'"
                                    class="px-3 py-1.5 rounded-lg text-sm font-medium transition">3L</button>
                            <button @click="editMission.o2_lpm = 6" type="button"
                                    :class="editMission.o2_lpm === 6 ? 'bg-amber-500 text-white' : 'bg-gray-100 text-gray-700'"
                                    class="px-3 py-1.5 rounded-lg text-sm font-medium transition">6L</button>
                            <button @click="editMission.o2_lpm = 10" type="button"
                                    :class="editMission.o2_lpm === 10 ? 'bg-amber-500 text-white' : 'bg-gray-100 text-gray-700'"
                                    class="px-3 py-1.5 rounded-lg text-sm font-medium transition">10L</button>
                            <button @click="editMission.o2_lpm = 15" type="button"
                                    :class="editMission.o2_lpm === 15 ? 'bg-amber-500 text-white' : 'bg-gray-100 text-gray-700'"
                                    class="px-3 py-1.5 rounded-lg text-sm font-medium transition">15L</button>
                        </div>
                    </div>

                    <!-- 輸液需求 -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">輸液需求</label>
                        <div class="flex gap-2 flex-wrap">
                            <button @click="editMission.iv_mode = 'NONE'" type="button"
                                    :class="editMission.iv_mode === 'NONE' ? 'bg-amber-500 text-white' : 'bg-gray-100 text-gray-700'"
                                    class="px-3 py-1.5 rounded-lg text-sm font-medium transition">無</button>
                            <button @click="editMission.iv_mode = 'KVO'" type="button"
                                    :class="editMission.iv_mode === 'KVO' ? 'bg-amber-500 text-white' : 'bg-gray-100 text-gray-700'"
                                    class="px-3 py-1.5 rounded-lg text-sm font-medium transition">KVO</button>
                            <button @click="editMission.iv_mode = 'MAINTENANCE'" type="button"
                                    :class="editMission.iv_mode === 'MAINTENANCE' ? 'bg-amber-500 text-white' : 'bg-gray-100 text-gray-700'"
                                    class="px-3 py-1.5 rounded-lg text-sm font-medium transition">維持</button>
                            <button @click="editMission.iv_mode = 'BOLUS'" type="button"
                                    :class="editMission.iv_mode === 'BOLUS' ? 'bg-amber-500 text-white' : 'bg-gray-100 text-gray-700'"
                                    class="px-3 py-1.5 rounded-lg text-sm font-medium transition">快補</button>
                        </div>
                        <div class="text-xs text-gray-500 mt-1">
                            <span x-show="editMission.iv_mode === 'NONE'">不需輸液</span>
                            <span x-show="editMission.iv_mode === 'KVO'">Keep Vein Open: 30 mL/hr</span>
                            <span x-show="editMission.iv_mode === 'MAINTENANCE'">一般維持: 100 mL/hr</span>
                            <span x-show="editMission.iv_mode === 'BOLUS'">快速補液: 500mL/30min</span>
                        </div>
                    </div>

                    <!-- 安全係數 -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">安全係數</label>
                        <div class="flex items-center gap-2">
                            <select x-model.number="editMission.safety_factor"
                                    class="border border-amber-300 rounded-lg px-3 py-2 focus:border-amber-500">
                                <option value="2">2× (最低)</option>
                                <option value="3">3× (標準)</option>
                                <option value="5">5× (保守)</option>
                                <option value="10">10× (長途)</option>
                                <option value="15">15× (極端)</option>
                            </select>
                            <span class="text-gray-500">備量</span>
                        </div>
                    </div>

                    <!-- EMT 姓名 -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">EMT 姓名</label>
                        <input type="text" x-model="editMission.emt_name"
                               placeholder="輸入負責 EMT 姓名"
                               class="w-full border border-amber-300 rounded-lg px-3 py-2 focus:border-amber-500">
                    </div>
                </div>
            </div>

            <button @click="updateMissionAndProceed()"
                    :disabled="!editMission.destination?.trim()"
                    :class="editMission.destination?.trim() ? 'bg-amber-500 hover:bg-amber-600' : 'bg-gray-300 cursor-not-allowed'"
                    class="w-full text-white font-bold py-4 rounded-xl transition flex items-center justify-center gap-2">
                <span>確認並計算物資需求</span>
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                </svg>
            </button>
        </div>

        <!-- Step 2: Loadout Confirmation (PLANNING → READY) -->
        <div x-show="currentMission && currentStep === 1" x-cloak>
            <!-- 一般物資 (輸液/設備) -->
            <div class="bg-white rounded-xl shadow-lg p-6 mb-4">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-bold text-amber-700">物資整備</h2>
                    <span class="text-sm text-gray-500" x-text="(currentMission?.estimated_duration_min || 0) + '分 × ' + (currentMission?.safety_factor || 3) + '倍'"></span>
                </div>

                <div class="space-y-3">
                    <template x-for="item in missionItems.filter(i => i.item_type !== 'OXYGEN' && i.item_type !== 'MEDICATION')" :key="item.id">
                        <div class="border border-amber-200 rounded-lg p-4 bg-amber-50">
                            <div class="flex justify-between items-start mb-2">
                                <div>
                                    <span class="font-medium text-gray-800" x-text="item.item_name"></span>
                                    <span class="text-xs text-gray-500 ml-2" x-text="item.item_type"></span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <input type="number" x-model.number="item.carried_qty"
                                           class="w-16 border border-amber-300 rounded px-2 py-1 text-center"
                                           :placeholder="item.suggested_qty">
                                    <span class="text-gray-500" x-text="item.unit"></span>
                                </div>
                            </div>
                            <div class="text-xs text-gray-500" x-text="item.calculation_explain"></div>
                            <label class="flex items-center gap-2 mt-2 cursor-pointer">
                                <input type="checkbox" x-model="item.checked" class="w-5 h-5 text-amber-500 rounded">
                                <span class="text-sm text-gray-600">已確認</span>
                            </label>
                        </div>
                    </template>
                </div>
            </div>

            <!-- 藥物/耗材 (可增減) - MIRS 紫紅色 -->
            <div class="bg-white rounded-xl shadow-lg p-6 mb-4">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-bold text-dispense-purple-700">藥物/耗材</h2>
                    <button @click="showAddMedication = true" class="text-dispense-purple-700 hover:text-dispense-purple-900 text-sm font-medium">
                        + 新增項目
                    </button>
                </div>

                <div class="space-y-3">
                    <template x-for="(item, idx) in missionItems.filter(i => i.item_type === 'MEDICATION')" :key="item.id || idx">
                        <div class="border border-dispense-purple-50 rounded-lg p-4 bg-dispense-purple-50">
                            <div class="flex justify-between items-start mb-2">
                                <div class="flex-1">
                                    <span class="font-medium text-gray-800" x-text="item.item_name"></span>
                                    <span class="text-xs text-dispense-purple-700 ml-2" x-text="item.calculation_explain || '手動新增'"></span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <input type="number" x-model.number="item.carried_qty"
                                           class="w-16 border border-purple-300 rounded px-2 py-1 text-center"
                                           :placeholder="item.suggested_qty || 1" min="0">
                                    <span class="text-gray-500" x-text="item.unit"></span>
                                    <button @click="removeMedicationItem(item)"
                                            x-show="item.is_custom"
                                            class="text-red-400 hover:text-red-600 ml-1">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            <label class="flex items-center gap-2 mt-2 cursor-pointer">
                                <input type="checkbox" x-model="item.checked" class="w-5 h-5 text-purple-500 rounded">
                                <span class="text-sm text-gray-600">已確認</span>
                            </label>
                        </div>
                    </template>

                    <template x-for="(item, idx) in customMedications" :key="'custom-' + idx">
                        <div class="border border-dispense-purple-50 rounded-lg p-4 bg-dispense-purple-50">
                            <div class="flex justify-between items-start mb-2">
                                <div class="flex-1">
                                    <span class="font-medium text-gray-800" x-text="item.item_name"></span>
                                    <span class="text-xs text-dispense-purple-700 ml-2">手動新增</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <input type="number" x-model.number="item.carried_qty"
                                           class="w-16 border border-purple-300 rounded px-2 py-1 text-center"
                                           min="0">
                                    <span class="text-gray-500" x-text="item.unit"></span>
                                    <button @click="customMedications.splice(idx, 1)"
                                            class="text-red-400 hover:text-red-600 ml-1">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            <label class="flex items-center gap-2 mt-2 cursor-pointer">
                                <input type="checkbox" x-model="item.checked" class="w-5 h-5 text-purple-500 rounded">
                                <span class="text-sm text-gray-600">已確認</span>
                            </label>
                        </div>
                    </template>

                    <div x-show="missionItems.filter(i => i.item_type === 'MEDICATION').length === 0 && customMedications.length === 0"
                         class="text-center py-4 text-gray-400">
                        點擊「+ 新增項目」加入藥物或耗材
                    </div>
                </div>
            </div>

            <!-- v2.0: 氧氣鋼瓶 PSI 追蹤 (認領 + 手動) - 琥珀色 -->
            <div class="bg-white rounded-xl shadow-lg p-6 mb-4" x-show="(currentMission?.oxygen_requirement_lpm || currentMission?.o2_lpm || 0) > 0" x-init="loadAvailableCylinders()">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-bold text-amber-700">氧氣鋼瓶</h2>
                    <span class="text-xs text-gray-500" x-show="oxygenCylinders.filter(c => c.claimed).length > 0"
                          x-text="oxygenCylinders.filter(c => c.claimed).length + ' 已認領'"></span>
                </div>

                <!-- 模式切換 Tab -->
                <div class="flex border-b border-gray-200 mb-4">
                    <button @click="cylinderMode = 'claim'; loadAvailableCylinders()"
                            class="flex-1 py-2 text-sm font-medium border-b-2 transition"
                            :class="cylinderMode === 'claim' ? 'text-amber-600 border-amber-500' : 'text-gray-500 border-transparent hover:text-gray-700'">
                        認領 (庫存)
                    </button>
                    <button @click="cylinderMode = 'manual'"
                            class="flex-1 py-2 text-sm font-medium border-b-2 transition"
                            :class="cylinderMode === 'manual' ? 'text-amber-600 border-amber-500' : 'text-gray-500 border-transparent hover:text-gray-700'">
                        手動輸入
                    </button>
                </div>

                <!-- 認領模式: 可用鋼瓶列表 -->
                <div x-show="cylinderMode === 'claim'" class="space-y-2 mb-4">
                    <div class="text-xs text-gray-500 mb-2">從庫存認領的鋼瓶會影響韌性估算</div>
                    <div x-show="loadingCylinders" class="text-center py-4 text-gray-400">載入中...</div>
                    <template x-for="cyl in availableCylinders" :key="cyl.id">
                        <div class="flex items-center justify-between border border-amber-200 rounded-lg p-3 bg-amber-50/50">
                            <div>
                                <span class="font-medium text-gray-800" x-text="cyl.unit_label"></span>
                                <span class="text-xs text-gray-500 ml-1" x-text="'(' + cyl.cylinder_type + ')'"></span>
                                <div class="text-xs text-amber-600" x-text="cyl.estimated_psi + ' PSI (' + cyl.level_percent + '%)'"></div>
                            </div>
                            <button @click="claimCylinder(cyl)"
                                    :disabled="oxygenCylinders.some(c => c.cylinder_id === cyl.id)"
                                    class="px-3 py-1 text-sm rounded font-medium transition"
                                    :class="oxygenCylinders.some(c => c.cylinder_id === cyl.id)
                                            ? 'bg-gray-200 text-gray-400 cursor-not-allowed'
                                            : 'bg-amber-500 text-white hover:bg-amber-600'">
                                <span x-text="oxygenCylinders.some(c => c.cylinder_id === cyl.id) ? '已認領' : '認領'"></span>
                            </button>
                        </div>
                    </template>
                    <div x-show="!loadingCylinders && availableCylinders.length === 0" class="text-center py-4 text-gray-400">
                        目前無可用鋼瓶
                    </div>
                </div>

                <!-- 手動模式: 手動新增 -->
                <div x-show="cylinderMode === 'manual'" class="mb-4">
                    <div class="text-xs text-gray-500 mb-2">手動輸入的鋼瓶不影響韌性估算</div>
                    <button @click="addCylinder()" class="w-full border-2 border-dashed border-amber-300 rounded-lg p-3 text-amber-600 hover:bg-amber-50 transition">
                        + 手動新增鋼瓶
                    </button>
                </div>

                <!-- 已選鋼瓶列表 -->
                <div class="space-y-3" x-show="oxygenCylinders.length > 0">
                    <div class="text-sm font-medium text-gray-700">已選鋼瓶 (<span x-text="oxygenCylinders.length"></span>)</div>
                    <template x-for="(cyl, idx) in oxygenCylinders" :key="idx">
                        <div class="border rounded-lg p-4"
                             :class="cyl.claimed ? 'border-amber-300 bg-amber-50' : 'border-gray-200 bg-gray-50'">
                            <div class="flex justify-between items-start mb-3">
                                <div class="flex items-center gap-2">
                                    <span x-show="cyl.claimed" class="text-xs bg-amber-500 text-white px-1.5 py-0.5 rounded">庫存</span>
                                    <span x-show="!cyl.claimed" class="text-xs bg-gray-400 text-white px-1.5 py-0.5 rounded">手動</span>
                                    <template x-if="cyl.claimed">
                                        <span class="font-medium text-gray-800" x-text="cyl.unit_label + ' (' + cyl.cylinder_type + ')'"></span>
                                    </template>
                                    <template x-if="!cyl.claimed">
                                        <div class="flex items-center gap-2">
                                            <select x-model="cyl.cylinder_type" class="border border-gray-300 rounded px-2 py-1 text-sm bg-white">
                                                <template x-for="(info, type) in cylinderTypes" :key="type">
                                                    <option :value="type" x-text="type + ' (' + info.capacity + 'L)'"></option>
                                                </template>
                                            </select>
                                            <input type="text" x-model="cyl.unit_label" placeholder="編號"
                                                   class="w-20 border border-gray-300 rounded px-2 py-1 text-sm">
                                        </div>
                                    </template>
                                </div>
                                <button @click="oxygenCylinders.splice(idx, 1)" class="text-red-400 hover:text-red-600">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                    </svg>
                                </button>
                            </div>
                            <div class="flex items-center gap-3">
                                <label class="text-sm text-gray-600">起始 PSI:</label>
                                <input type="number" x-model.number="cyl.starting_psi"
                                       min="0" max="3000" placeholder="2100"
                                       :readonly="cyl.claimed"
                                       class="w-24 border rounded px-2 py-1 text-center"
                                       :class="cyl.claimed ? 'bg-gray-100 border-gray-200' : 'border-amber-300'">
                                <span class="text-xs text-gray-500" x-text="'/ ' + (cylinderTypes[cyl.cylinder_type]?.full_psi || 2100)"></span>
                            </div>
                            <div class="text-xs text-amber-600 mt-2" x-show="cyl.starting_psi > 0"
                                 x-text="'可用: ' + Math.round((cyl.starting_psi / (cylinderTypes[cyl.cylinder_type]?.full_psi || 2100)) * (cylinderTypes[cyl.cylinder_type]?.capacity || 660)) + ' L'">
                            </div>
                            <label class="flex items-center gap-2 mt-2 cursor-pointer">
                                <input type="checkbox" x-model="cyl.checked" class="w-5 h-5 text-amber-500 rounded">
                                <span class="text-sm text-gray-600">已確認</span>
                            </label>
                        </div>
                    </template>
                </div>

                <div x-show="oxygenCylinders.length === 0" class="text-center py-4 text-gray-400">
                    從上方認領或手動新增氧氣鋼瓶
                </div>
            </div>

            <!-- v2.0: 設備電量追蹤 - MIRS 設備色 -->
            <div class="bg-white rounded-xl shadow-lg p-6 mb-4">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-bold text-equipment-500">設備電量</h2>
                    <button @click="addEquipment()" class="text-equipment-500 hover:text-equipment-900 text-sm font-medium">
                        + 新增設備
                    </button>
                </div>

                <div class="space-y-3">
                    <template x-for="(eq, idx) in equipmentBattery" :key="idx">
                        <div class="border border-equipment-500 rounded-lg p-4 bg-equipment-100">
                            <div class="flex justify-between items-start mb-3">
                                <div class="flex items-center gap-2 flex-wrap">
                                    <select x-model="eq.equipment_type" class="border border-equipment-500 rounded px-2 py-1 text-sm bg-white">
                                        <option value="MONITOR">監視器</option>
                                        <option value="VENTILATOR">呼吸器</option>
                                        <option value="SUCTION">抽吸機</option>
                                        <option value="PUMP">輸液幫浦</option>
                                        <option value="DEFIBRILLATOR">AED</option>
                                        <option value="OTHER">其他</option>
                                    </select>
                                    <input type="text" x-model="eq.equipment_name" placeholder="名稱"
                                           class="w-28 border border-equipment-500 rounded px-2 py-1 text-sm">
                                </div>
                                <button @click="equipmentBattery.splice(idx, 1)" class="text-red-400 hover:text-red-600">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                    </svg>
                                </button>
                            </div>
                            <div class="flex items-center gap-3">
                                <label class="text-sm text-gray-600">電量:</label>
                                <input type="number" x-model.number="eq.starting_battery_pct"
                                       min="0" max="100" placeholder="100"
                                       class="w-20 border border-equipment-500 rounded px-2 py-1 text-center">
                                <span class="text-gray-500">%</span>
                                <div class="flex-1 h-2 bg-gray-200 rounded-full overflow-hidden">
                                    <div class="h-full transition-all"
                                         :class="eq.starting_battery_pct >= 50 ? 'bg-green-500' : eq.starting_battery_pct >= 20 ? 'bg-yellow-500' : 'bg-red-500'"
                                         :style="'width: ' + (eq.starting_battery_pct || 0) + '%'"></div>
                                </div>
                            </div>
                            <label class="flex items-center gap-2 mt-2 cursor-pointer">
                                <input type="checkbox" x-model="eq.checked" class="w-5 h-5 text-equipment-500 rounded">
                                <span class="text-sm text-gray-600">已確認</span>
                            </label>
                        </div>
                    </template>

                    <div x-show="equipmentBattery.length === 0" class="text-center py-4 text-gray-400">
                        點擊「+ 新增設備」追蹤電量
                    </div>
                </div>
            </div>

            <div class="flex gap-3">
                <button @click="goToStep(0)"
                        class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-4 rounded-xl transition">
                    返回
                </button>
                <button @click="confirmLoadoutV2()"
                        :disabled="!allItemsCheckedV2"
                        :class="allItemsCheckedV2 ? 'bg-amber-500 hover:bg-amber-600' : 'bg-gray-300 cursor-not-allowed'"
                        class="flex-1 text-white font-bold py-4 rounded-xl transition">
                    確認攜帶
                </button>
            </div>
        </div>

        <!-- Step 3: En Route (EN_ROUTE) -->
        <div x-show="currentMission && currentStep === 2" x-cloak>
            <div class="bg-gradient-to-br from-amber-500 to-orange-500 rounded-xl shadow-lg p-6 text-white mb-4">
                <div class="text-center mb-4">
                    <div class="text-sm opacity-80">目的地</div>
                    <div class="text-2xl font-bold" x-text="currentMission?.destination || '-'"></div>
                </div>

                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div class="bg-white/20 rounded-lg p-3 text-center">
                        <div class="text-xs opacity-80">已行駛</div>
                        <div class="text-xl font-bold" x-text="elapsedTime + ' min'"></div>
                    </div>
                    <div class="bg-white/20 rounded-lg p-3 text-center">
                        <div class="text-xs opacity-80">預估</div>
                        <div class="text-xl font-bold" x-text="(currentMission?.estimated_duration_min || 0) + ' min'"></div>
                    </div>
                </div>

                <!-- Progress bar -->
                <div class="h-3 bg-white/30 rounded-full overflow-hidden">
                    <div class="h-full bg-white transition-all duration-1000"
                         :style="'width: ' + Math.min(100, (elapsedTime / (currentMission?.estimated_duration_min || 60)) * 100) + '%'"></div>
                </div>
            </div>

            <!-- Supplies Status -->
            <div class="bg-white rounded-xl shadow-lg p-6 mb-4">
                <h3 class="font-bold text-gray-700 mb-3">物資狀態</h3>
                <div class="space-y-2">
                    <template x-for="item in missionItems.filter(i => i.carried_qty > 0)" :key="item.id">
                        <div class="flex justify-between items-center py-2 border-b border-gray-100">
                            <span x-text="item.item_name"></span>
                            <span class="font-medium" x-text="item.carried_qty + ' ' + item.unit"></span>
                        </div>
                    </template>
                </div>
            </div>

            <button @click="arriveMission()"
                    class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-4 rounded-xl transition">
                抵達目的地
            </button>
        </div>

        <!-- Step 4: Recheck & Finalize (ARRIVED) -->
        <div x-show="currentMission && currentStep === 3" x-cloak>
            <!-- 一般物資確認 -->
            <div class="bg-white rounded-xl shadow-lg p-6 mb-4">
                <h2 class="text-lg font-bold text-amber-700 mb-4">返站物資確認</h2>

                <div class="space-y-3">
                    <template x-for="item in missionItems.filter(i => i.carried_qty > 0 && i.item_type !== 'OXYGEN')" :key="item.id">
                        <div class="border border-gray-200 rounded-lg p-4">
                            <div class="flex justify-between items-center mb-2">
                                <span class="font-medium" x-text="item.item_name"></span>
                                <span class="text-gray-500" x-text="'攜帶: ' + item.carried_qty + ' ' + item.unit"></span>
                            </div>
                            <div class="flex items-center gap-2">
                                <label class="text-sm text-gray-600">剩餘:</label>
                                <input type="number" x-model.number="item.returned_qty"
                                       :max="item.carried_qty" min="0"
                                       class="w-20 border border-gray-300 rounded px-2 py-1 text-center">
                                <span class="text-gray-500" x-text="item.unit"></span>
                                <span class="text-sm ml-auto"
                                      :class="(item.carried_qty - (item.returned_qty || 0)) > 0 ? 'text-red-500' : 'text-green-500'"
                                      x-text="'消耗: ' + (item.carried_qty - (item.returned_qty || 0))">
                                </span>
                            </div>
                        </div>
                    </template>
                </div>
            </div>

            <!-- v2.0: 氧氣鋼瓶結束 PSI - 琥珀色 -->
            <div class="bg-white rounded-xl shadow-lg p-6 mb-4" x-show="oxygenCylinders.length > 0">
                <h2 class="text-lg font-bold text-amber-700 mb-4">氧氣消耗統計</h2>

                <div class="space-y-3">
                    <template x-for="(cyl, idx) in oxygenCylinders" :key="idx">
                        <div class="border border-amber-200 rounded-lg p-4 bg-amber-50">
                            <div class="flex justify-between items-center mb-2">
                                <span class="font-medium text-gray-800" x-text="cyl.cylinder_type + (cyl.unit_label ? ' #' + cyl.unit_label : '')"></span>
                                <span class="text-amber-600" x-text="'起始: ' + cyl.starting_psi + ' PSI'"></span>
                            </div>
                            <div class="flex items-center gap-3 mb-2">
                                <label class="text-sm text-gray-600">結束 PSI:</label>
                                <input type="number" x-model.number="cyl.ending_psi"
                                       min="0" :max="cyl.starting_psi" placeholder="0"
                                       class="w-24 border border-amber-300 rounded px-2 py-1 text-center">
                            </div>
                            <div class="text-sm" x-show="cyl.starting_psi > 0 && cyl.ending_psi !== undefined">
                                <span class="text-red-600 font-medium"
                                      x-text="'消耗: ' + Math.round(((cyl.starting_psi - (cyl.ending_psi || 0)) / (cylinderTypes[cyl.cylinder_type]?.full_psi || 2100)) * (cylinderTypes[cyl.cylinder_type]?.capacity || 660)) + ' L'">
                                </span>
                                <span class="text-gray-500 ml-2"
                                      x-text="'(' + (cyl.starting_psi - (cyl.ending_psi || 0)) + ' PSI)'">
                                </span>
                            </div>
                            <!-- PSI 可視化 -->
                            <div class="mt-2 h-3 bg-gray-200 rounded-full overflow-hidden">
                                <div class="h-full bg-amber-500 transition-all"
                                     :style="'width: ' + ((cyl.ending_psi || 0) / (cylinderTypes[cyl.cylinder_type]?.full_psi || 2100) * 100) + '%'"></div>
                            </div>
                        </div>
                    </template>
                </div>

                <!-- 總消耗統計 -->
                <div class="mt-4 p-3 bg-amber-100 rounded-lg" x-show="oxygenCylinders.length > 0">
                    <div class="flex justify-between items-center">
                        <span class="font-medium text-amber-800">總氧氣消耗</span>
                        <span class="text-lg font-bold text-amber-700" x-text="totalO2Consumed + ' L'"></span>
                    </div>
                </div>
            </div>

            <!-- v2.0: 設備電量結算 - MIRS 設備色 -->
            <div class="bg-white rounded-xl shadow-lg p-6 mb-4" x-show="equipmentBattery.length > 0">
                <h2 class="text-lg font-bold text-equipment-500 mb-4">設備電量結算</h2>

                <div class="space-y-3">
                    <template x-for="(eq, idx) in equipmentBattery" :key="idx">
                        <div class="border border-equipment-500 rounded-lg p-4 bg-equipment-100">
                            <div class="flex justify-between items-center mb-2">
                                <span class="font-medium text-gray-800" x-text="eq.equipment_name || eq.equipment_type"></span>
                                <span class="text-equipment-500" x-text="'起始: ' + eq.starting_battery_pct + '%'"></span>
                            </div>
                            <div class="flex items-center gap-3">
                                <label class="text-sm text-gray-600">結束:</label>
                                <input type="number" x-model.number="eq.ending_battery_pct"
                                       min="0" :max="eq.starting_battery_pct" placeholder="0"
                                       class="w-20 border border-equipment-500 rounded px-2 py-1 text-center">
                                <span class="text-gray-500">%</span>
                                <span class="text-sm ml-auto"
                                      :class="(eq.starting_battery_pct - (eq.ending_battery_pct || 0)) > 30 ? 'text-red-500' : 'text-green-500'"
                                      x-text="'消耗: ' + (eq.starting_battery_pct - (eq.ending_battery_pct || 0)) + '%'">
                                </span>
                            </div>
                            <!-- 電量可視化 -->
                            <div class="mt-2 h-3 bg-gray-200 rounded-full overflow-hidden">
                                <div class="h-full transition-all"
                                     :class="(eq.ending_battery_pct || 0) >= 50 ? 'bg-green-500' : (eq.ending_battery_pct || 0) >= 20 ? 'bg-yellow-500' : 'bg-red-500'"
                                     :style="'width: ' + (eq.ending_battery_pct || 0) + '%'"></div>
                            </div>
                        </div>
                    </template>
                </div>
            </div>

            <!-- Incoming Items -->
            <div class="bg-white rounded-xl shadow-lg p-6 mb-4">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-gray-700">外帶物資</h3>
                    <button @click="showAddIncoming = true" class="text-amber-600 hover:text-amber-700 text-sm font-medium">
                        + 新增
                    </button>
                </div>

                <div x-show="incomingItems.length === 0" class="text-center py-4 text-gray-400">
                    無外帶物資
                </div>

                <div class="space-y-2">
                    <template x-for="(item, idx) in incomingItems" :key="idx">
                        <div class="flex justify-between items-center py-2 border-b border-gray-100">
                            <div>
                                <span x-text="item.item_name"></span>
                                <span class="text-xs text-gray-500 ml-1" x-text="'(' + item.source_station + ')'"></span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span x-text="item.quantity + ' ' + item.unit"></span>
                                <button @click="incomingItems.splice(idx, 1)" class="text-red-400 hover:text-red-600">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </template>
                </div>
            </div>

            <button @click="finalizeMission()"
                    class="w-full bg-amber-500 hover:bg-amber-600 text-white font-bold py-4 rounded-xl transition">
                結案歸檔
            </button>
        </div>

        <!-- Completed State -->
        <div x-show="currentMission && currentMission.status === 'COMPLETED'" x-cloak>
            <div class="bg-green-50 rounded-xl p-8 text-center">
                <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                    </svg>
                </div>
                <h2 class="text-xl font-bold text-green-700 mb-2">任務完成</h2>
                <p class="text-gray-500 mb-6" x-text="'任務編號: ' + (currentMission?.mission_id || '')"></p>
                <button @click="currentMission = null; currentStep = 0"
                        class="bg-amber-500 hover:bg-amber-600 text-white font-bold py-3 px-6 rounded-xl transition">
                    開始新任務
                </button>
            </div>
        </div>
    </main>

    <!-- New Mission Modal (全螢幕頁面式，解決 iOS Safari 捲動問題) -->
    <div x-show="showNewMission" x-cloak
         class="fixed inset-0 bg-white z-50 overflow-y-auto ios-scroll">
        <!-- 固定頂部 Header -->
        <div class="sticky top-0 bg-amber-500 text-white px-4 py-3 shadow-lg z-10">
            <div class="flex items-center justify-between">
                <button @click="showNewMission = false" class="p-1">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
                <h2 class="text-lg font-bold">新增轉送任務</h2>
                <div class="w-6"></div>
            </div>
        </div>

        <!-- 內容區 (自然頁面捲動) -->
        <div class="p-4 pb-24">
                <div class="space-y-4">
                    <!-- v3.1: Source Type Selection -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">來源類型</label>
                        <div class="grid grid-cols-2 gap-2">
                            <button @click="newMission.source_type = 'CIRS'"
                                    class="py-2 rounded-lg text-center font-medium text-sm transition"
                                    :class="newMission.source_type === 'CIRS' ? 'bg-amber-500 text-white' : 'bg-gray-100 text-gray-700'">
                                內部轉送 (CIRS)
                            </button>
                            <button @click="newMission.source_type = 'EXTERNAL'"
                                    class="py-2 rounded-lg text-center font-medium text-sm transition"
                                    :class="newMission.source_type === 'EXTERNAL' ? 'bg-teal-600 text-white' : 'bg-gray-100 text-gray-700'">
                                外部轉入
                            </button>
                        </div>
                    </div>

                    <!-- v3.1: External Source Info (只有外部轉入需要填來源單位) -->
                    <div x-show="newMission.source_type === 'EXTERNAL'" class="bg-teal-50 rounded-xl p-4 space-y-3">
                        <div>
                            <label class="block text-sm font-medium text-teal-800 mb-1">來源單位 *</label>
                            <input type="text" x-model="newMission.source_org"
                                   placeholder="如: 台中榮總急診、119 救護車"
                                   class="w-full border border-teal-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-teal-500">
                        </div>
                        <!-- v3.2: Display local station for external transfers -->
                        <div class="flex items-center gap-2 text-sm text-teal-700">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                            </svg>
                            <span>接收站點: <strong x-text="stationName"></strong></span>
                        </div>
                    </div>

                    <!-- v3.2: Display source station for internal (CIRS) transfers -->
                    <div x-show="newMission.source_type === 'CIRS'" class="bg-gray-50 rounded-xl p-3">
                        <div class="flex items-center gap-2 text-sm text-gray-600">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                            </svg>
                            <span>出發站點: <strong x-text="stationName"></strong></span>
                        </div>
                    </div>

                    <!-- v3.2: Patient & Handoff Info (內部/外部轉送都可填) -->
                    <div class="bg-amber-50 rounded-xl p-4 space-y-3">
                        <div class="flex items-center justify-between">
                            <h4 class="text-sm font-bold text-amber-800">病患與交班資訊</h4>
                            <span class="text-xs text-amber-600"
                                  x-text="newMission.source_type === 'CIRS' ? '緊急/直接轉送用' : '外部轉入'"></span>
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label class="block text-sm font-medium text-amber-800 mb-1">病患姓名</label>
                                <input type="text" x-model="newMission.patient_name"
                                       placeholder="王大明"
                                       class="w-full border border-amber-300 rounded-lg px-3 py-2">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-amber-800 mb-1">年齡</label>
                                <input type="text" x-model="newMission.patient_age"
                                       placeholder="45歲"
                                       class="w-full border border-amber-300 rounded-lg px-3 py-2">
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label class="block text-sm font-medium text-amber-800 mb-1">主訴</label>
                                <input type="text" x-model="newMission.chief_complaint"
                                       placeholder="右腿開放性骨折"
                                       class="w-full border border-amber-300 rounded-lg px-3 py-2">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-amber-800 mb-1">檢傷 (綠-黃-紅)</label>
                                <div class="grid grid-cols-3 gap-1">
                                    <button @click="newMission.triage = 'GREEN'"
                                            class="py-1.5 rounded text-xs font-bold transition"
                                            :class="newMission.triage === 'GREEN' ? 'bg-green-600 text-white' : 'bg-green-100 text-green-700'">綠</button>
                                    <button @click="newMission.triage = 'YELLOW'"
                                            class="py-1.5 rounded text-xs font-bold transition"
                                            :class="newMission.triage === 'YELLOW' ? 'bg-yellow-500 text-white' : 'bg-yellow-100 text-yellow-700'">黃</button>
                                    <button @click="newMission.triage = 'RED'"
                                            class="py-1.5 rounded text-xs font-bold transition"
                                            :class="newMission.triage === 'RED' ? 'bg-red-600 text-white' : 'bg-red-100 text-red-700'">紅</button>
                                </div>
                            </div>
                        </div>

                        <!-- ISBAR/MIST Format Selection -->
                        <div class="border-t border-amber-200 pt-3 mt-3">
                            <div class="flex items-center justify-between mb-2">
                                <h4 class="text-sm font-bold text-amber-800">交班格式</h4>
                                <div class="flex gap-1">
                                    <button @click="newMission.handoff_format = 'ISBAR'"
                                            class="px-3 py-1 rounded text-xs font-bold transition"
                                            :class="newMission.handoff_format === 'ISBAR' ? 'bg-amber-600 text-white' : 'bg-amber-200 text-amber-700'">ISBAR</button>
                                    <button @click="newMission.handoff_format = 'MIST'"
                                            class="px-3 py-1 rounded text-xs font-bold transition"
                                            :class="newMission.handoff_format === 'MIST' ? 'bg-amber-600 text-white' : 'bg-amber-200 text-amber-700'">MIST</button>
                                </div>
                            </div>

                            <!-- ISBAR Fields -->
                            <div x-show="newMission.handoff_format === 'ISBAR'" class="space-y-2">
                                <div>
                                    <label class="text-xs text-amber-700">I - Identify (識別)</label>
                                    <input type="text" x-model="newMission.isbar_identify"
                                           placeholder="姓名、年齡、性別..."
                                           class="w-full border border-amber-300 rounded-lg px-3 py-2 text-sm">
                                </div>
                                <div>
                                    <label class="text-xs text-amber-700">S - Situation (現況)</label>
                                    <textarea x-model="newMission.isbar_situation" rows="2"
                                              placeholder="主訴、目前狀況..."
                                              class="w-full border border-amber-300 rounded-lg px-3 py-2 text-sm"></textarea>
                                </div>
                                <div>
                                    <label class="text-xs text-amber-700">B - Background (背景)</label>
                                    <textarea x-model="newMission.isbar_background" rows="2"
                                              placeholder="病史、過敏史、用藥..."
                                              class="w-full border border-amber-300 rounded-lg px-3 py-2 text-sm"></textarea>
                                </div>
                                <div>
                                    <label class="text-xs text-amber-700">A - Assessment (評估)</label>
                                    <textarea x-model="newMission.isbar_assessment" rows="2"
                                              placeholder="生命徵象、檢驗結果..."
                                              class="w-full border border-amber-300 rounded-lg px-3 py-2 text-sm"></textarea>
                                </div>
                                <div>
                                    <label class="text-xs text-amber-700">R - Recommendation (建議)</label>
                                    <textarea x-model="newMission.isbar_recommendation" rows="2"
                                              placeholder="後續處置建議..."
                                              class="w-full border border-amber-300 rounded-lg px-3 py-2 text-sm"></textarea>
                                </div>
                            </div>

                            <!-- MIST Fields -->
                            <div x-show="newMission.handoff_format === 'MIST'" class="space-y-2">
                                <div>
                                    <label class="text-xs text-amber-700">M - Mechanism (機轉)</label>
                                    <textarea x-model="newMission.mist_mechanism" rows="2"
                                              placeholder="車禍、高處墜落、穿刺傷..."
                                              class="w-full border border-amber-300 rounded-lg px-3 py-2 text-sm"></textarea>
                                </div>
                                <div>
                                    <label class="text-xs text-amber-700">I - Injuries (傷勢)</label>
                                    <textarea x-model="newMission.mist_injuries" rows="2"
                                              placeholder="右脛骨開放性骨折、左手撕裂傷..."
                                              class="w-full border border-amber-300 rounded-lg px-3 py-2 text-sm"></textarea>
                                </div>
                                <div>
                                    <label class="text-xs text-amber-700">S - Signs (徵象)</label>
                                    <textarea x-model="newMission.mist_signs" rows="2"
                                              placeholder="BP 110/70, HR 95, SpO2 96%, GCS E4V5M6=15..."
                                              class="w-full border border-amber-300 rounded-lg px-3 py-2 text-sm"></textarea>
                                </div>
                                <div>
                                    <label class="text-xs text-amber-700">T - Treatment (處置)</label>
                                    <textarea x-model="newMission.mist_treatment" rows="2"
                                              placeholder="傷口止血包紮、夾板固定、IV N/S 1000mL..."
                                              class="w-full border border-amber-300 rounded-lg px-3 py-2 text-sm"></textarea>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">目的地 *</label>
                        <input type="text" x-model="newMission.destination"
                               placeholder="如: 國軍台中總醫院"
                               class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-amber-500 focus:border-amber-500">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">單程 ETA (分鐘)</label>
                        <input type="number" x-model.number="newMission.eta_min"
                               min="10" max="480" placeholder="60"
                               class="w-full border border-gray-300 rounded-lg px-3 py-2">
                        <div class="mt-1 flex gap-2">
                            <button @click="newMission.eta_min = 30" class="text-xs px-2 py-1 bg-gray-100 rounded hover:bg-gray-200">30分</button>
                            <button @click="newMission.eta_min = 60" class="text-xs px-2 py-1 bg-gray-100 rounded hover:bg-gray-200">1時</button>
                            <button @click="newMission.eta_min = 90" class="text-xs px-2 py-1 bg-gray-100 rounded hover:bg-gray-200">1.5時</button>
                            <button @click="newMission.eta_min = 120" class="text-xs px-2 py-1 bg-gray-100 rounded hover:bg-gray-200">2時</button>
                        </div>
                        <div class="text-xs text-gray-500 mt-1" x-show="newMission.eta_min > 0"
                             x-text="'來回約 ' + (newMission.eta_min * 2) + ' 分鐘'"></div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">總任務時間 (含轉運停留)</label>
                        <input type="number" x-model.number="newMission.estimated_duration_min"
                               min="10" max="720" placeholder="120"
                               class="w-full border border-gray-300 rounded-lg px-3 py-2">
                        <div class="mt-1 flex gap-2">
                            <button @click="newMission.estimated_duration_min = newMission.eta_min * 2 || 60"
                                    class="text-xs px-2 py-1 bg-amber-100 text-amber-700 rounded hover:bg-amber-200">= 來回</button>
                            <button @click="newMission.estimated_duration_min = (newMission.eta_min * 2 || 60) + 30"
                                    class="text-xs px-2 py-1 bg-gray-100 rounded hover:bg-gray-200">+30分</button>
                            <button @click="newMission.estimated_duration_min = (newMission.eta_min * 2 || 60) + 60"
                                    class="text-xs px-2 py-1 bg-gray-100 rounded hover:bg-gray-200">+1時</button>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">病患狀況</label>
                        <div class="flex gap-2">
                            <button @click="newMission.patient_condition = 'STABLE'"
                                    :class="newMission.patient_condition === 'STABLE' ? 'bg-green-500 text-white' : 'bg-gray-100'"
                                    class="flex-1 py-2 rounded-lg transition">穩定</button>
                            <button @click="newMission.patient_condition = 'CRITICAL'"
                                    :class="newMission.patient_condition === 'CRITICAL' ? 'bg-orange-500 text-white' : 'bg-gray-100'"
                                    class="flex-1 py-2 rounded-lg transition">危急</button>
                            <button @click="newMission.patient_condition = 'INTUBATED'"
                                    :class="newMission.patient_condition === 'INTUBATED' ? 'bg-red-500 text-white' : 'bg-gray-100'"
                                    class="flex-1 py-2 rounded-lg transition">插管</button>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">氧氣需求 (L/min)</label>
                        <div class="flex gap-2 flex-wrap">
                            <button @click="newMission.o2_lpm = 0"
                                    :class="newMission.o2_lpm === 0 ? 'bg-amber-500 text-white' : 'bg-gray-100'"
                                    class="flex-1 py-2 rounded-lg transition min-w-[50px]">無</button>
                            <button @click="newMission.o2_lpm = 3"
                                    :class="newMission.o2_lpm === 3 ? 'bg-amber-500 text-white' : 'bg-gray-100'"
                                    class="flex-1 py-2 rounded-lg transition min-w-[50px]">3</button>
                            <button @click="newMission.o2_lpm = 6"
                                    :class="newMission.o2_lpm === 6 ? 'bg-amber-500 text-white' : 'bg-gray-100'"
                                    class="flex-1 py-2 rounded-lg transition min-w-[50px]">6</button>
                            <button @click="newMission.o2_lpm = 10"
                                    :class="newMission.o2_lpm === 10 ? 'bg-amber-500 text-white' : 'bg-gray-100'"
                                    class="flex-1 py-2 rounded-lg transition min-w-[50px]">10</button>
                            <button @click="newMission.o2_lpm = 15"
                                    :class="newMission.o2_lpm === 15 ? 'bg-amber-500 text-white' : 'bg-gray-100'"
                                    class="flex-1 py-2 rounded-lg transition min-w-[50px]">15</button>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">輸液模式</label>
                        <div class="flex gap-2 flex-wrap">
                            <button @click="newMission.iv_mode = 'NONE'"
                                    :class="newMission.iv_mode === 'NONE' ? 'bg-amber-500 text-white' : 'bg-gray-100'"
                                    class="flex-1 py-2 rounded-lg transition text-sm min-w-[60px]">無</button>
                            <button @click="newMission.iv_mode = 'KVO'"
                                    :class="newMission.iv_mode === 'KVO' ? 'bg-amber-500 text-white' : 'bg-gray-100'"
                                    class="flex-1 py-2 rounded-lg transition text-sm min-w-[60px]">KVO</button>
                            <button @click="newMission.iv_mode = 'MAINTENANCE'"
                                    :class="newMission.iv_mode === 'MAINTENANCE' ? 'bg-amber-500 text-white' : 'bg-gray-100'"
                                    class="flex-1 py-2 rounded-lg transition text-sm min-w-[60px]">維持</button>
                            <button @click="newMission.iv_mode = 'BOLUS'"
                                    :class="newMission.iv_mode === 'BOLUS' ? 'bg-amber-500 text-white' : 'bg-gray-100'"
                                    class="flex-1 py-2 rounded-lg transition text-sm min-w-[60px]">快速</button>
                            <button @click="newMission.iv_mode = 'CUSTOM'"
                                    :class="newMission.iv_mode === 'CUSTOM' ? 'bg-amber-500 text-white' : 'bg-gray-100'"
                                    class="flex-1 py-2 rounded-lg transition text-sm min-w-[60px]">自訂</button>
                        </div>
                        <div x-show="newMission.iv_mode === 'CUSTOM'" class="mt-2">
                            <div class="flex items-center gap-2">
                                <input type="number" x-model.number="newMission.iv_mlhr_override"
                                       min="0" max="1000" placeholder="100"
                                       class="w-24 border border-gray-300 rounded-lg px-3 py-2 text-center">
                                <span class="text-gray-500">mL/hr</span>
                            </div>
                        </div>
                        <div class="text-xs text-gray-500 mt-1">
                            <span x-show="newMission.iv_mode === 'NONE'">不需輸液</span>
                            <span x-show="newMission.iv_mode === 'KVO'">Keep Vein Open: 30 mL/hr</span>
                            <span x-show="newMission.iv_mode === 'MAINTENANCE'">一般維持: 100 mL/hr</span>
                            <span x-show="newMission.iv_mode === 'BOLUS'">快速補液: 500mL/30min</span>
                            <span x-show="newMission.iv_mode === 'CUSTOM'" x-text="'自訂: ' + (newMission.iv_mlhr_override || 0) + ' mL/hr'"></span>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">安全係數</label>
                        <div class="flex items-center gap-4">
                            <input type="range" x-model.number="newMission.safety_factor"
                                   min="1" max="15" step="0.5"
                                   class="flex-1">
                            <span class="text-xl font-bold text-amber-600" x-text="newMission.safety_factor + '×'"></span>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">EMT 姓名</label>
                        <input type="text" x-model="newMission.emt_name"
                               placeholder="選填"
                               class="w-full border border-gray-300 rounded-lg px-3 py-2">
                    </div>
                </div>

                <!-- 底部按鈕 -->
                <div class="flex gap-3 mt-6">
                    <button @click="createMission()"
                            :disabled="!newMission.destination || !newMission.estimated_duration_min"
                            :class="newMission.destination && newMission.estimated_duration_min ? 'bg-amber-500 hover:bg-amber-600' : 'bg-gray-300 cursor-not-allowed'"
                            class="flex-1 text-white font-bold py-4 rounded-xl transition text-lg">
                        建立任務
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Medication Modal (全螢幕頁面式) - MIRS 紫紅色 -->
    <div x-show="showAddMedication" x-cloak
         class="fixed inset-0 bg-white z-50 overflow-y-auto ios-scroll">
        <!-- 固定頂部 Header -->
        <div class="sticky top-0 bg-dispense-purple-700 text-white px-4 py-3 shadow-lg z-10">
            <div class="flex items-center justify-between">
                <button @click="showAddMedication = false" class="p-1">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
                <h2 class="text-lg font-bold">新增藥物/耗材</h2>
                <div class="w-6"></div>
            </div>
        </div>

        <!-- 內容區 -->
        <div class="p-4 pb-24">
            <div class="space-y-4">
                <!-- 常用藥物快捷 -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">常用項目 (點擊直接新增)</label>
                    <div class="flex flex-wrap gap-2">
                        <button @click="quickAddMedication('Epinephrine 1mg', '支', 2)"
                                class="px-3 py-2 rounded-full text-sm" style="background:#f3e8ff; color:#7e22ce;">Epinephrine</button>
                        <button @click="quickAddMedication('Atropine 0.5mg', '支', 2)"
                                class="px-3 py-2 rounded-full text-sm" style="background:#f3e8ff; color:#7e22ce;">Atropine</button>
                        <button @click="quickAddMedication('Morphine 10mg', '支', 1)"
                                class="px-3 py-2 rounded-full text-sm" style="background:#f3e8ff; color:#7e22ce;">Morphine</button>
                        <button @click="quickAddMedication('Ketamine 500mg', '瓶', 1)"
                                class="px-3 py-2 rounded-full text-sm" style="background:#f3e8ff; color:#7e22ce;">Ketamine</button>
                        <button @click="quickAddMedication('TXA 1g', '支', 2)"
                                class="px-3 py-2 rounded-full text-sm" style="background:#f3e8ff; color:#7e22ce;">TXA</button>
                        <button @click="quickAddMedication('止血帶', '條', 2)"
                                class="px-3 py-2 bg-amber-100 text-amber-700 rounded-full text-sm hover:bg-amber-200">止血帶</button>
                        <button @click="quickAddMedication('胸腔封閉貼', '片', 1)"
                                class="px-3 py-2 bg-amber-100 text-amber-700 rounded-full text-sm hover:bg-amber-200">胸封貼</button>
                    </div>
                </div>

                <div class="border-t pt-4">
                    <label class="block text-sm font-bold text-gray-700 mb-3">或自訂項目</label>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">品項名稱</label>
                    <input type="text" x-model="newMedication.item_name"
                           placeholder="如: Midazolam 5mg"
                           class="w-full border border-gray-300 rounded-lg px-3 py-3 text-lg">
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">數量</label>
                        <input type="number" x-model.number="newMedication.carried_qty"
                               min="1" placeholder="1"
                               class="w-full border border-gray-300 rounded-lg px-3 py-3 text-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">單位</label>
                        <select x-model="newMedication.unit"
                                class="w-full border border-gray-300 rounded-lg px-3 py-3 text-lg bg-white">
                            <option value="支">支</option>
                            <option value="瓶">瓶</option>
                            <option value="袋">袋</option>
                            <option value="片">片</option>
                            <option value="條">條</option>
                            <option value="組">組</option>
                            <option value="個">個</option>
                        </select>
                    </div>
                </div>

                <!-- 底部按鈕 -->
                <div class="mt-6">
                    <button @click="addMedication()"
                            :disabled="!newMedication.item_name"
                            :class="newMedication.item_name ? 'bg-dispense-purple-700 hover:bg-dispense-purple-900' : 'bg-gray-300 cursor-not-allowed'"
                            class="w-full text-white font-bold py-4 rounded-xl text-lg">
                        新增藥物/耗材
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Incoming Item Modal (全螢幕頁面式) -->
    <div x-show="showAddIncoming" x-cloak
         class="fixed inset-0 bg-white z-50 overflow-y-auto ios-scroll">
        <!-- 固定頂部 Header -->
        <div class="sticky top-0 bg-amber-600 text-white px-4 py-3 shadow-lg z-10">
            <div class="flex items-center justify-between">
                <button @click="showAddIncoming = false" class="p-1">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
                <h2 class="text-lg font-bold">新增外帶物資</h2>
                <div class="w-6"></div>
            </div>
        </div>

        <!-- 內容區 -->
        <div class="p-4 pb-24">
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">物資名稱</label>
                    <input type="text" x-model="newIncoming.item_name"
                           placeholder="如: 血袋 O型"
                           class="w-full border border-gray-300 rounded-lg px-3 py-3 text-lg">
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">數量</label>
                        <input type="number" x-model.number="newIncoming.quantity"
                               min="1" placeholder="1"
                               class="w-full border border-gray-300 rounded-lg px-3 py-3 text-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">單位</label>
                        <input type="text" x-model="newIncoming.unit" placeholder="個"
                               class="w-full border border-gray-300 rounded-lg px-3 py-3 text-lg">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">來源站點</label>
                    <input type="text" x-model="newIncoming.source_station"
                           placeholder="如: 野戰醫院"
                           class="w-full border border-gray-300 rounded-lg px-3 py-3 text-lg">
                </div>

                <!-- 底部按鈕 -->
                <div class="mt-6">
                    <button @click="addIncomingItem()"
                            class="w-full bg-amber-500 hover:bg-amber-600 text-white font-bold py-4 rounded-xl text-lg">
                        新增外帶物資
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- v3.0: Handoff Detail Modal (全螢幕) -->
    <div x-show="showHandoffDetail" x-cloak
         class="fixed inset-0 bg-white z-50 overflow-y-auto ios-scroll">
        <!-- Header -->
        <div class="sticky top-0 bg-pink-600 text-white px-4 py-3 shadow-lg z-10">
            <div class="flex items-center justify-between">
                <button @click="showHandoffDetail = false; selectedHandoff = null" class="p-1">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
                <h2 class="text-lg font-bold">交班詳情</h2>
                <!-- v3.2: Tab-style format selector -->
                <div class="flex gap-1">
                    <button @click="handoffFormat = 'ISBAR'"
                            class="px-3 py-1 rounded text-xs font-bold transition"
                            :class="handoffFormat === 'ISBAR' ? 'bg-white text-pink-600' : 'bg-pink-500 text-white hover:bg-pink-400'">
                        ISBAR
                    </button>
                    <button @click="handoffFormat = 'MIST'"
                            class="px-3 py-1 rounded text-xs font-bold transition"
                            :class="handoffFormat === 'MIST' ? 'bg-white text-pink-600' : 'bg-pink-500 text-white hover:bg-pink-400'">
                        MIST
                    </button>
                </div>
            </div>
        </div>

        <!-- Content -->
        <div class="p-4 pb-32" x-show="selectedHandoff">
            <!-- ISBAR Format Content -->
            <div x-show="handoffFormat === 'ISBAR'" class="space-y-3 mb-4">
                <!-- I - Identify -->
                <div class="bg-white rounded-xl border shadow-sm p-4">
                    <div class="flex items-center gap-2 mb-2">
                        <span class="w-7 h-7 rounded-full bg-pink-600 text-white flex items-center justify-center font-bold text-sm">I</span>
                        <span class="font-bold text-gray-700">Identify 識別</span>
                        <span class="px-2 py-0.5 text-xs font-bold rounded ml-auto"
                              :class="selectedHandoff?.priority === 'STAT' ? 'bg-red-500 text-white' : selectedHandoff?.priority === 'URGENT' ? 'bg-orange-500 text-white' : 'bg-gray-200 text-gray-700'"
                              x-text="selectedHandoff?.priority || 'NORMAL'"></span>
                    </div>
                    <div class="text-xl font-bold text-gray-800">
                        <span x-text="selectedHandoff?.patient_name || '未知'"></span>
                        <span class="text-gray-500 font-normal text-lg" x-text="selectedHandoff?.patient_age ? ' ' + selectedHandoff?.patient_age : ''"></span>
                    </div>
                    <div class="text-xs text-gray-500 mt-1" x-text="'交班單: ' + (selectedHandoff?.display_id || '-')"></div>
                </div>

                <!-- S - Situation -->
                <div class="bg-white rounded-xl border shadow-sm p-4">
                    <div class="flex items-center gap-2 mb-2">
                        <span class="w-7 h-7 rounded-full bg-pink-500 text-white flex items-center justify-center font-bold text-sm">S</span>
                        <span class="font-bold text-gray-700">Situation 現況</span>
                    </div>
                    <div class="text-gray-800 font-medium" x-text="selectedHandoff?.chief_complaint || '無主訴'"></div>
                    <div class="text-sm text-gray-600 mt-1" x-text="selectedHandoff?.content?.S?.situation || ''"></div>
                    <div class="mt-2 text-sm" x-show="selectedHandoff?.content?.S?.destination">
                        <span class="text-gray-500">目的地:</span>
                        <span class="font-medium" x-text="selectedHandoff?.content?.S?.destination"></span>
                    </div>
                </div>

                <!-- B - Background -->
                <div class="bg-white rounded-xl border shadow-sm p-4">
                    <div class="flex items-center gap-2 mb-2">
                        <span class="w-7 h-7 rounded-full bg-pink-400 text-white flex items-center justify-center font-bold text-sm">B</span>
                        <span class="font-bold text-gray-700">Background 背景</span>
                    </div>
                    <div class="space-y-1 text-sm">
                        <div x-show="selectedHandoff?.content?.B?.medical_history">
                            <span class="text-gray-500">病史:</span>
                            <span x-text="Array.isArray(selectedHandoff?.content?.B?.medical_history) ? selectedHandoff?.content?.B?.medical_history.join(', ') : (selectedHandoff?.content?.B?.medical_history || '-')"></span>
                        </div>
                        <div x-show="selectedHandoff?.content?.B?.allergies">
                            <span class="text-gray-500">過敏:</span>
                            <span class="text-red-600 font-medium" x-text="Array.isArray(selectedHandoff?.content?.B?.allergies) ? selectedHandoff?.content?.B?.allergies.join(', ') : (selectedHandoff?.content?.B?.allergies || '-')"></span>
                        </div>
                        <div x-show="selectedHandoff?.content?.B?.current_medications">
                            <span class="text-gray-500">用藥:</span>
                            <span x-text="Array.isArray(selectedHandoff?.content?.B?.current_medications) ? selectedHandoff?.content?.B?.current_medications.join(', ') : (selectedHandoff?.content?.B?.current_medications || '-')"></span>
                        </div>
                    </div>
                </div>

                <!-- A - Assessment (Vital Signs) -->
                <div class="bg-white rounded-xl border shadow-sm p-4">
                    <div class="flex items-center gap-2 mb-2">
                        <span class="w-7 h-7 rounded-full bg-pink-300 text-white flex items-center justify-center font-bold text-sm">A</span>
                        <span class="font-bold text-gray-700">Assessment 評估</span>
                    </div>
                    <div class="grid grid-cols-4 gap-2 text-center text-sm">
                        <div class="bg-gray-50 rounded-lg p-2">
                            <div class="text-gray-500 text-xs">BP</div>
                            <div class="font-bold" x-text="(selectedHandoff?.latest_vs?.bp_sys || '-') + '/' + (selectedHandoff?.latest_vs?.bp_dia || '-')"></div>
                        </div>
                        <div class="bg-gray-50 rounded-lg p-2">
                            <div class="text-gray-500 text-xs">HR</div>
                            <div class="font-bold" x-text="selectedHandoff?.latest_vs?.hr || '-'"></div>
                        </div>
                        <div class="bg-gray-50 rounded-lg p-2">
                            <div class="text-gray-500 text-xs">SpO2</div>
                            <div class="font-bold" x-text="selectedHandoff?.latest_vs?.spo2 ? selectedHandoff?.latest_vs?.spo2 + '%' : '-'"></div>
                        </div>
                        <div class="bg-gray-50 rounded-lg p-2">
                            <div class="text-gray-500 text-xs">GCS</div>
                            <div class="font-bold" x-text="selectedHandoff?.content?.A?.gcs || selectedHandoff?.latest_vs?.gcs || '-'"></div>
                        </div>
                    </div>
                </div>

                <!-- R - Recommendation -->
                <div class="bg-white rounded-xl border shadow-sm p-4">
                    <div class="flex items-center gap-2 mb-2">
                        <span class="w-7 h-7 rounded-full bg-pink-200 text-pink-800 flex items-center justify-center font-bold text-sm">R</span>
                        <span class="font-bold text-gray-700">Recommendation 建議</span>
                    </div>
                    <div class="text-gray-800" x-text="selectedHandoff?.content?.R?.recommendation || '無特別建議'"></div>
                    <div class="mt-2 text-xs text-gray-500" x-text="'來源: ' + (selectedHandoff?.source_name || '-') + ' | ' + formatTime(selectedHandoff?.created_at)"></div>
                </div>
            </div>

            <!-- MIST Format Content (外傷專用) -->
            <div x-show="handoffFormat === 'MIST'" class="space-y-3 mb-4">
                <!-- Patient Header -->
                <div class="bg-red-50 rounded-xl border border-red-200 p-4">
                    <div class="flex items-center gap-2 mb-2">
                        <span class="px-2 py-0.5 text-xs font-bold rounded bg-red-500 text-white">外傷</span>
                        <span class="px-2 py-0.5 text-xs font-bold rounded"
                              :class="selectedHandoff?.priority === 'STAT' ? 'bg-red-700 text-white' : selectedHandoff?.priority === 'URGENT' ? 'bg-orange-500 text-white' : 'bg-gray-200 text-gray-700'"
                              x-text="selectedHandoff?.priority || 'NORMAL'"></span>
                    </div>
                    <div class="text-xl font-bold text-gray-800">
                        <span x-text="selectedHandoff?.patient_name || '未知'"></span>
                        <span class="text-gray-500 font-normal text-lg" x-text="selectedHandoff?.patient_age ? ' ' + selectedHandoff?.patient_age : ''"></span>
                    </div>
                </div>

                <!-- M - Mechanism -->
                <div class="bg-white rounded-xl border shadow-sm p-4">
                    <div class="flex items-center gap-2 mb-2">
                        <span class="w-7 h-7 rounded-full bg-red-600 text-white flex items-center justify-center font-bold text-sm">M</span>
                        <span class="font-bold text-gray-700">Mechanism 機轉</span>
                    </div>
                    <div class="text-gray-800 font-medium" x-text="selectedHandoff?.content?.M?.mechanism_type || selectedHandoff?.content?.mechanism || '未知機轉'"></div>
                    <div class="text-sm text-gray-600 mt-1" x-text="selectedHandoff?.content?.M?.mechanism_detail || ''"></div>
                    <div class="text-xs text-gray-500 mt-1" x-show="selectedHandoff?.content?.M?.time_of_injury" x-text="'受傷時間: ' + selectedHandoff?.content?.M?.time_of_injury"></div>
                </div>

                <!-- I - Injuries -->
                <div class="bg-white rounded-xl border shadow-sm p-4">
                    <div class="flex items-center gap-2 mb-2">
                        <span class="w-7 h-7 rounded-full bg-red-500 text-white flex items-center justify-center font-bold text-sm">I</span>
                        <span class="font-bold text-gray-700">Injuries 傷勢</span>
                    </div>
                    <div class="text-gray-800" x-text="selectedHandoff?.content?.I?.injuries_detail || selectedHandoff?.content?.injuries || selectedHandoff?.chief_complaint || '無詳細傷勢'"></div>
                    <!-- Injury locations if available -->
                    <div class="flex flex-wrap gap-2 mt-2" x-show="selectedHandoff?.content?.I?.injuries">
                        <template x-for="(val, part) in (selectedHandoff?.content?.I?.injuries || {})" :key="part">
                            <span x-show="val" class="px-2 py-1 text-xs rounded bg-red-100 text-red-700" x-text="part"></span>
                        </template>
                    </div>
                </div>

                <!-- S - Signs (Vital Signs) -->
                <div class="bg-white rounded-xl border shadow-sm p-4">
                    <div class="flex items-center gap-2 mb-2">
                        <span class="w-7 h-7 rounded-full bg-red-400 text-white flex items-center justify-center font-bold text-sm">S</span>
                        <span class="font-bold text-gray-700">Signs 生命徵象</span>
                    </div>
                    <div class="grid grid-cols-4 gap-2 text-center text-sm">
                        <div class="bg-gray-50 rounded-lg p-2">
                            <div class="text-gray-500 text-xs">BP</div>
                            <div class="font-bold" x-text="(selectedHandoff?.latest_vs?.bp_sys || selectedHandoff?.content?.S?.bp?.split('/')[0] || '-') + '/' + (selectedHandoff?.latest_vs?.bp_dia || selectedHandoff?.content?.S?.bp?.split('/')[1] || '-')"></div>
                        </div>
                        <div class="bg-gray-50 rounded-lg p-2">
                            <div class="text-gray-500 text-xs">HR</div>
                            <div class="font-bold" x-text="selectedHandoff?.latest_vs?.hr || selectedHandoff?.content?.S?.hr || '-'"></div>
                        </div>
                        <div class="bg-gray-50 rounded-lg p-2">
                            <div class="text-gray-500 text-xs">SpO2</div>
                            <div class="font-bold" x-text="(selectedHandoff?.latest_vs?.spo2 || selectedHandoff?.content?.S?.spo2 || '-') + '%'"></div>
                        </div>
                        <div class="bg-gray-50 rounded-lg p-2">
                            <div class="text-gray-500 text-xs">GCS</div>
                            <div class="font-bold" x-text="selectedHandoff?.content?.S?.gcs || selectedHandoff?.latest_vs?.gcs || '-'"></div>
                        </div>
                    </div>
                    <div class="mt-2 text-center" x-show="selectedHandoff?.content?.S?.shock_index">
                        <span class="text-xs text-gray-500">Shock Index:</span>
                        <span class="font-bold" :class="(selectedHandoff?.content?.S?.shock_index || 0) > 1 ? 'text-red-600' : 'text-gray-700'" x-text="selectedHandoff?.content?.S?.shock_index"></span>
                    </div>
                </div>

                <!-- T - Treatment -->
                <div class="bg-white rounded-xl border shadow-sm p-4">
                    <div class="flex items-center gap-2 mb-2">
                        <span class="w-7 h-7 rounded-full bg-red-300 text-white flex items-center justify-center font-bold text-sm">T</span>
                        <span class="font-bold text-gray-700">Treatment 處置</span>
                    </div>
                    <div class="space-y-2 text-sm">
                        <div x-show="selectedHandoff?.content?.T?.treatments">
                            <span class="text-gray-500">已執行:</span>
                            <span x-text="Array.isArray(selectedHandoff?.content?.T?.treatments) ? selectedHandoff?.content?.T?.treatments.join(', ') : (selectedHandoff?.content?.T?.treatments || '-')"></span>
                        </div>
                        <div class="flex gap-4">
                            <div x-show="selectedHandoff?.content?.T?.o2_lpm">
                                <span class="text-gray-500">O2:</span>
                                <span class="font-medium" x-text="selectedHandoff?.content?.T?.o2_lpm + ' L/min'"></span>
                            </div>
                            <div x-show="selectedHandoff?.content?.T?.iv_type">
                                <span class="text-gray-500">IV:</span>
                                <span class="font-medium" x-text="selectedHandoff?.content?.T?.iv_type + (selectedHandoff?.content?.T?.iv_rate_ml_hr ? ' ' + selectedHandoff?.content?.T?.iv_rate_ml_hr + ' ml/hr' : '')"></span>
                            </div>
                        </div>
                        <div x-show="selectedHandoff?.content?.T?.notes" class="text-gray-600" x-text="selectedHandoff?.content?.T?.notes"></div>
                    </div>
                    <div class="mt-2 text-xs text-gray-500" x-text="'來源: ' + (selectedHandoff?.source_name || '-') + ' | ' + formatTime(selectedHandoff?.created_at)"></div>
                </div>
            </div>

            <!-- Arrival Vitals Section (交班時重測) -->
            <div class="bg-pink-50 rounded-xl p-4 mb-4 border-2 border-pink-200">
                <div class="flex items-center gap-2 mb-3">
                    <svg class="w-5 h-5 text-pink-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    <h3 class="font-bold text-pink-800">交班時重測 (建議)</h3>
                </div>
                <p class="text-sm text-pink-700 mb-3">重測生命徵象可保護 EMT 責任，記錄接手時病患真實狀態</p>

                <div class="grid grid-cols-2 gap-3 mb-3">
                    <div>
                        <label class="text-xs text-gray-600">收縮壓 (mmHg)</label>
                        <input type="number" x-model="arrivalVitals.bp_sys" placeholder="120"
                               class="w-full border border-pink-200 rounded-lg px-3 py-2 text-center focus:border-pink-400 focus:ring-1 focus:ring-pink-400">
                    </div>
                    <div>
                        <label class="text-xs text-gray-600">舒張壓 (mmHg)</label>
                        <input type="number" x-model="arrivalVitals.bp_dia" placeholder="80"
                               class="w-full border border-pink-200 rounded-lg px-3 py-2 text-center focus:border-pink-400 focus:ring-1 focus:ring-pink-400">
                    </div>
                    <div>
                        <label class="text-xs text-gray-600">心率 (bpm)</label>
                        <input type="number" x-model="arrivalVitals.hr" placeholder="72"
                               class="w-full border border-pink-200 rounded-lg px-3 py-2 text-center focus:border-pink-400 focus:ring-1 focus:ring-pink-400">
                    </div>
                    <div>
                        <label class="text-xs text-gray-600">SpO2 (%)</label>
                        <input type="number" x-model="arrivalVitals.spo2" placeholder="98"
                               class="w-full border border-pink-200 rounded-lg px-3 py-2 text-center focus:border-pink-400 focus:ring-1 focus:ring-pink-400">
                    </div>
                </div>
                <!-- GCS E/V/M 分項輸入 -->
                <div class="mb-3">
                    <label class="text-xs text-gray-600 mb-1 block">GCS = <span class="font-bold text-pink-600" x-text="(parseInt(arrivalVitals.gcs_e) || 0) + (parseInt(arrivalVitals.gcs_v) || 0) + (parseInt(arrivalVitals.gcs_m) || 0)"></span></label>
                    <div class="grid grid-cols-3 gap-2">
                        <div>
                            <label class="text-xs text-gray-500">E (睜眼)</label>
                            <select x-model="arrivalVitals.gcs_e"
                                    class="w-full border border-pink-200 rounded-lg px-2 py-2 text-sm focus:border-pink-400">
                                <option value="4">4 自發</option>
                                <option value="3">3 呼喚</option>
                                <option value="2">2 刺痛</option>
                                <option value="1">1 無</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-xs text-gray-500">V (語言)</label>
                            <select x-model="arrivalVitals.gcs_v"
                                    class="w-full border border-pink-200 rounded-lg px-2 py-2 text-sm focus:border-pink-400">
                                <option value="5">5 正常</option>
                                <option value="4">4 混亂</option>
                                <option value="3">3 不當</option>
                                <option value="2">2 發聲</option>
                                <option value="1">1 無</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-xs text-gray-500">M (運動)</label>
                            <select x-model="arrivalVitals.gcs_m"
                                    class="w-full border border-pink-200 rounded-lg px-2 py-2 text-sm focus:border-pink-400">
                                <option value="6">6 服從</option>
                                <option value="5">5 定位</option>
                                <option value="4">4 退縮</option>
                                <option value="3">3 屈曲</option>
                                <option value="2">2 伸展</option>
                                <option value="1">1 無</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div>
                    <label class="text-xs text-gray-600">備註</label>
                    <textarea x-model="arrivalVitals.note" rows="2"
                              placeholder="病患意識、配合程度等..."
                              class="w-full border border-pink-200 rounded-lg px-3 py-2 text-sm mt-1 focus:border-pink-400 focus:ring-1 focus:ring-pink-400"></textarea>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="fixed bottom-0 left-0 right-0 bg-white border-t p-4 flex gap-3">
                <button @click="showRejectModal = true"
                        class="flex-1 py-3 bg-gray-100 text-gray-700 rounded-xl font-bold hover:bg-gray-200">
                    拒絕交班
                </button>
                <button @click="acceptHandoff(selectedHandoff?.handoff_id)"
                        class="flex-1 py-3 bg-pink-600 text-white rounded-xl font-bold hover:bg-pink-700">
                    確認接收
                </button>
            </div>
        </div>
    </div>

    <!-- v3.0: Reject Handoff Modal -->
    <div x-show="showRejectModal" x-cloak
         class="fixed inset-0 bg-black/50 z-[60] flex items-center justify-center p-4"
         @click.self="showRejectModal = false">
        <div class="bg-white rounded-2xl w-full max-w-sm p-6">
            <h3 class="text-lg font-bold text-gray-800 mb-4">拒絕交班</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">拒絕原因</label>
                    <select x-model="rejectForm.code"
                            class="w-full border rounded-lg px-3 py-2">
                        <option value="NO_CAPACITY">人力/設備不足</option>
                        <option value="PATIENT_UNSTABLE">病患狀態不適合轉送</option>
                        <option value="DESTINATION_UNAVAILABLE">目的地無法接收</option>
                        <option value="OTHER">其他原因</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">詳細說明</label>
                    <textarea x-model="rejectForm.reason" rows="3"
                              placeholder="請說明拒絕原因..."
                              class="w-full border rounded-lg px-3 py-2"></textarea>
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                <button @click="showRejectModal = false"
                        class="flex-1 py-2 bg-gray-100 text-gray-700 rounded-lg font-medium">
                    取消
                </button>
                <button @click="rejectHandoff(selectedHandoff?.handoff_id)"
                        class="flex-1 py-2 bg-red-600 text-white rounded-lg font-medium">
                    確認拒絕
                </button>
            </div>
        </div>
    </div>

    <!-- Mission List Sidebar -->
    <div x-show="showMissionList" x-cloak
         class="fixed inset-0 bg-black/50 z-50"
         @click.self="showMissionList = false">
        <div class="absolute right-0 top-0 bottom-0 w-80 bg-white shadow-xl overflow-y-auto ios-scroll"
             x-transition:enter="transition ease-out duration-200"
             x-transition:enter-start="translate-x-full"
             x-transition:enter-end="translate-x-0"
             x-transition:leave="transition ease-in duration-150"
             x-transition:leave-start="translate-x-0"
             x-transition:leave-end="translate-x-full">
            <div class="p-4 border-b border-gray-200 flex justify-between items-center">
                <h2 class="font-bold text-gray-800">任務列表</h2>
                <button @click="showMissionList = false" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <div class="p-4 space-y-3">
                <template x-for="m in missionList" :key="m.mission_id">
                    <button @click="loadMission(m.mission_id); showMissionList = false"
                            class="w-full text-left bg-gray-50 hover:bg-amber-50 rounded-lg p-3 transition">
                        <div class="flex justify-between items-start">
                            <div>
                                <div class="font-medium text-gray-800" x-text="m.destination"></div>
                                <div class="text-xs text-gray-500" x-text="m.mission_id"></div>
                            </div>
                            <div class="status-dot" :class="'status-' + m.status.toLowerCase()"></div>
                        </div>
                    </button>
                </template>
                <div x-show="missionList.length === 0" class="text-center py-8 text-gray-400">
                    無任務記錄
                </div>
            </div>
        </div>
    </div>

    <script>
        function emtTransfer() {
            return {
                // State
                isOnline: navigator.onLine,
                showNewMission: false,
                showMissionList: false,
                showAddIncoming: false,
                currentMission: null,
                missionItems: [],
                incomingItems: [],
                missionList: [],
                currentStep: 0,
                elapsedTime: 0,
                // v3.2.1: Editable mission fields for Step 0
                editMission: {
                    destination: '',
                    estimated_duration_min: 120,
                    safety_factor: 3
                },
                elapsedTimer: null,
                stationName: '醫療站',  // v3.2: Local station name

                // v3.0: CIRS Handoff Integration
                // Auto-detect Vercel demo: use cirs-demo.vercel.app for cross-origin handoffs
                cirsHubUrl: localStorage.getItem('cirs_hub_url') ||
                    (window.location.hostname.includes('vercel.app') ? 'https://cirs-demo.vercel.app' : 'http://localhost:8090'),
                pendingHandoffs: [],
                selectedHandoff: null,
                showHandoffDetail: false,
                showRejectModal: false,
                showArrivalVitals: false,
                loadingHandoffs: false,
                rejectForm: {
                    code: 'NO_CAPACITY',
                    reason: ''
                },
                arrivalVitals: {
                    bp_sys: '',
                    bp_dia: '',
                    hr: '',
                    spo2: '',
                    gcs_e: '4',
                    gcs_v: '5',
                    gcs_m: '6',
                    note: ''
                },
                handoffFormat: 'ISBAR',  // v3.0.2: 使用者可選 ISBAR/MIST
                emtCredentials: JSON.parse(localStorage.getItem('emt_credentials') || '{"id":"emt001","name":"EMT"}'),

                // New mission form (v2.0)
                newMission: {
                    destination: '',
                    eta_min: 60,
                    estimated_duration_min: 120,
                    patient_condition: 'STABLE',
                    o2_lpm: 0,
                    iv_mode: 'NONE',
                    iv_mlhr_override: null,
                    ventilator_required: false,
                    safety_factor: 3.0,
                    emt_name: '',
                    // v3.1: External source handoff support
                    source_type: 'CIRS',  // CIRS | EXTERNAL
                    source_org: '',       // External source organization name
                    // v3.2: Patient info (both internal/external)
                    patient_name: '',
                    patient_age: '',
                    chief_complaint: '',
                    triage: 'YELLOW',     // GREEN | YELLOW | RED
                    // v3.2: Handoff format selection (ISBAR or MIST)
                    handoff_format: 'MIST',  // ISBAR | MIST
                    // ISBAR format fields
                    isbar_identify: '',
                    isbar_situation: '',
                    isbar_background: '',
                    isbar_assessment: '',
                    isbar_recommendation: '',
                    // MIST format fields
                    mist_mechanism: '',
                    mist_injuries: '',
                    mist_signs: '',
                    mist_treatment: ''
                },

                // v2.0: 氧氣鋼瓶追蹤
                oxygenCylinders: [],
                cylinderMode: 'claim',  // 'claim' 認領模式, 'manual' 手動模式
                availableCylinders: [], // 可認領的鋼瓶列表
                loadingCylinders: false,
                // v2.0: 設備電量追蹤
                equipmentBattery: [],
                // v2.0: 自訂藥物/耗材
                customMedications: [],
                showAddMedication: false,
                newMedication: {
                    item_name: '',
                    carried_qty: 1,
                    unit: '支'
                },

                // 鋼瓶類型參考
                cylinderTypes: {
                    'E': { name: 'E-Tank (攜帶型)', capacity: 660, full_psi: 2100 },
                    'D': { name: 'D-Tank (小型)', capacity: 350, full_psi: 2100 },
                    'M': { name: 'M-Tank (中型)', capacity: 3000, full_psi: 2200 },
                    'H': { name: 'H-Tank (大型)', capacity: 6900, full_psi: 2200 },
                    'Jumbo-D': { name: 'Jumbo D-Tank', capacity: 640, full_psi: 2200 }
                },

                // New incoming item form
                newIncoming: {
                    item_type: 'CONSUMABLE',
                    item_name: '',
                    quantity: 1,
                    unit: '個',
                    source_station: ''
                },

                // Computed
                get allItemsChecked() {
                    return this.missionItems.every(i => i.checked);
                },

                // v2.0: 檢查所有項目 (含鋼瓶、設備、自訂藥物)
                get allItemsCheckedV2() {
                    const itemsOk = this.missionItems.filter(i => i.item_type !== 'OXYGEN').every(i => i.checked);
                    const cylindersOk = this.oxygenCylinders.length === 0 || this.oxygenCylinders.every(c => c.checked && c.starting_psi > 0);
                    const equipmentOk = this.equipmentBattery.length === 0 || this.equipmentBattery.every(e => e.checked);
                    const medsOk = this.customMedications.length === 0 || this.customMedications.every(m => m.checked);
                    return itemsOk && cylindersOk && equipmentOk && medsOk;
                },

                // v2.0: 總氧氣消耗量
                get totalO2Consumed() {
                    return this.oxygenCylinders.reduce((sum, cyl) => {
                        if (!cyl.starting_psi || cyl.ending_psi === undefined) return sum;
                        const cap = this.cylinderTypes[cyl.cylinder_type] || { capacity: 660, full_psi: 2100 };
                        const consumed = ((cyl.starting_psi - (cyl.ending_psi || 0)) / cap.full_psi) * cap.capacity;
                        return sum + Math.max(0, Math.round(consumed));
                    }, 0);
                },

                // Methods
                async init() {
                    // Online/offline detection
                    window.addEventListener('online', () => {
                        this.isOnline = true;
                        this.fetchPendingHandoffs();  // v3.0: refresh on reconnect
                    });
                    window.addEventListener('offline', () => this.isOnline = false);

                    // v3.2: Load station name for handoff source
                    try {
                        const stationRes = await fetch('/api/station/info');
                        if (stationRes.ok) {
                            const stationData = await stationRes.json();
                            this.stationName = stationData.station?.name || '醫療站';
                        }
                    } catch (e) {
                        console.error('[EMT] Load station info error:', e);
                    }

                    // Load mission list
                    await this.loadMissionList();

                    // Check for active mission
                    const activeMissions = this.missionList.filter(m => !['COMPLETED', 'ABORTED'].includes(m.status));
                    if (activeMissions.length > 0) {
                        await this.loadMission(activeMissions[0].mission_id);
                    }

                    // v3.0: Fetch pending handoffs from CIRS
                    if (this.isOnline && !this.currentMission) {
                        await this.fetchPendingHandoffs();
                    }
                },

                // ============================================================
                // v3.0: CIRS Handoff Integration Methods
                // ============================================================

                async fetchPendingHandoffs() {
                    if (this.loadingHandoffs) return;
                    this.loadingHandoffs = true;

                    try {
                        // v3.2.6: Vercel demo mode - return mock handoffs
                        const isVercelDemo = window.location.hostname.includes('vercel.app');
                        if (isVercelDemo) {
                            this.pendingHandoffs = [
                                {
                                    handoff_id: 'HO-DEMO-001',
                                    display_id: 'HO-001',
                                    patient_name: '王大明',
                                    patient_age: '45歲',
                                    chief_complaint: '右腿開放性骨折',
                                    priority: 'URGENT',
                                    format: 'MIST',
                                    destination: '台大醫院急診',
                                    created_at: new Date().toISOString(),
                                    content: {
                                        M: { mechanism: '機車車禍，右腿遭撞擊' },
                                        I: { injuries: '右腿開放性骨折，出血已控制' },
                                        S: { signs: 'BP 120/80, HR 95, SpO2 98%, GCS E4V5M6', o2_lpm: 3 },
                                        T: { treatment: '止血包紮、夾板固定、建立 IV' }
                                    },
                                    latest_vs: { bp_sys: 120, bp_dia: 80, hr: 95, spo2: 98, o2_lpm: 3 }
                                },
                                {
                                    handoff_id: 'HO-DEMO-002',
                                    display_id: 'HO-002',
                                    patient_name: '林小華',
                                    patient_age: '32歲',
                                    chief_complaint: '胸痛、呼吸困難',
                                    priority: 'STAT',
                                    format: 'ISBAR',
                                    destination: '榮總心臟科',
                                    created_at: new Date(Date.now() - 600000).toISOString(),
                                    content: {
                                        I: { identify: '林小華，32歲女性' },
                                        S: { situation: '突發性胸痛2小時，伴隨呼吸困難' },
                                        B: { background: '無心臟病史，近期無運動' },
                                        A: { assessment: '疑似心肌梗塞，需緊急心導管' },
                                        R: { recommendation: '緊急轉送心臟科', destination: '榮總心臟科' }
                                    },
                                    latest_vs: { bp_sys: 90, bp_dia: 60, hr: 110, spo2: 94, o2_lpm: 6 }
                                }
                            ];
                            console.log('[EMT] Vercel demo mode - loaded mock handoffs');
                            this.loadingHandoffs = false;
                            return;
                        }

                        const res = await fetch(`${this.cirsHubUrl}/api/handoff/pending?target_role=EMT`);
                        if (!res.ok) throw new Error('Failed to fetch handoffs');
                        const data = await res.json();
                        this.pendingHandoffs = data.handoffs || [];
                        console.log('[EMT] Loaded pending handoffs:', this.pendingHandoffs.length);
                    } catch (e) {
                        console.error('[EMT] Failed to fetch pending handoffs:', e);
                        // Don't show alert, just log - might be offline or CIRS not configured
                    } finally {
                        this.loadingHandoffs = false;
                    }
                },

                viewHandoffDetail(handoff) {
                    this.selectedHandoff = handoff;
                    this.showHandoffDetail = true;
                    // v3.0.2: 初始化格式為原交班格式，但允許使用者修改
                    this.handoffFormat = handoff?.format || 'ISBAR';
                    // Reset arrival vitals form with E/V/M GCS
                    this.arrivalVitals = {
                        bp_sys: '',
                        bp_dia: '',
                        hr: '',
                        spo2: '',
                        gcs_e: '4',
                        gcs_v: '5',
                        gcs_m: '6',
                        note: ''
                    };
                },

                async acceptHandoff(handoffId) {
                    if (!handoffId) return;

                    try {
                        // v3.2.6: Vercel demo mode - skip CIRS API calls
                        const isVercelDemo = window.location.hostname.includes('vercel.app');
                        let handoffData;

                        if (isVercelDemo) {
                            // Use selected handoff data directly
                            handoffData = {
                                ...this.selectedHandoff,
                                snapshot: {
                                    patient: {
                                        name: this.selectedHandoff.patient_name,
                                        age: this.selectedHandoff.patient_age
                                    },
                                    registration: {
                                        chief_complaint: this.selectedHandoff.chief_complaint,
                                        priority: this.selectedHandoff.priority
                                    },
                                    vital_signs: this.selectedHandoff.latest_vs || {}
                                }
                            };
                            console.log('[EMT] Vercel demo - using mock handoff data');
                        } else {
                            // 1. Send accept to CIRS
                            const acceptRes = await fetch(`${this.cirsHubUrl}/api/handoff/${handoffId}/accept`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    acceptor_id: this.emtCredentials.id,
                                    acceptor_name: this.emtCredentials.name,
                                    device_id: `MIRS-EMT-${Date.now()}`
                                })
                            });

                            if (!acceptRes.ok) {
                                const err = await acceptRes.json();
                                throw new Error(err.detail || '接收失敗');
                            }

                            // 2. Record arrival vitals if provided
                            if (this.arrivalVitals.bp_sys || this.arrivalVitals.hr || this.arrivalVitals.spo2) {
                                await this.recordArrivalVitals(handoffId);
                            }

                            // 3. Get full handoff details
                            const detailRes = await fetch(`${this.cirsHubUrl}/api/handoff/${handoffId}`);
                            handoffData = await detailRes.json();
                        }

                        // 4. Create local mission from handoff
                        await this.createMissionFromHandoff(handoffData);

                        // 5. Close modal and refresh
                        this.showHandoffDetail = false;
                        this.selectedHandoff = null;
                        await this.fetchPendingHandoffs();

                        // v3.2.4: Force Step 0 for new handoff missions
                        this.currentStep = 0;
                        console.log('[EMT] acceptHandoff complete, forced currentStep:', this.currentStep);

                        alert('已接收交班，請確認任務設定');

                    } catch (e) {
                        console.error('[EMT] Accept handoff error:', e);
                        alert('接收交班失敗: ' + e.message);
                    }
                },

                async recordArrivalVitals(handoffId) {
                    const vitals = {};
                    if (this.arrivalVitals.bp_sys) vitals.bp_sys = parseInt(this.arrivalVitals.bp_sys);
                    if (this.arrivalVitals.bp_dia) vitals.bp_dia = parseInt(this.arrivalVitals.bp_dia);
                    if (this.arrivalVitals.hr) vitals.hr = parseInt(this.arrivalVitals.hr);
                    if (this.arrivalVitals.spo2) vitals.spo2 = parseInt(this.arrivalVitals.spo2);
                    // v3.0.2: GCS E/V/M format
                    const gcsE = parseInt(this.arrivalVitals.gcs_e) || 4;
                    const gcsV = parseInt(this.arrivalVitals.gcs_v) || 5;
                    const gcsM = parseInt(this.arrivalVitals.gcs_m) || 6;
                    vitals.gcs = `E${gcsE}V${gcsV}M${gcsM}`;
                    vitals.gcs_total = gcsE + gcsV + gcsM;

                    await fetch(`${this.cirsHubUrl}/api/handoff/${handoffId}/addendum`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            addendum_type: 'ARRIVAL_VITALS',
                            source: 'EMT',
                            recorded_by: this.emtCredentials.id,
                            content: {
                                vital_signs: vitals,
                                note: this.arrivalVitals.note || null
                            }
                        })
                    });
                    console.log('[EMT] Recorded arrival vitals');
                },

                async createMissionFromHandoff(handoff) {
                    // Extract data from handoff snapshot
                    const snapshot = handoff.snapshot || {};
                    const patient = snapshot.patient || {};
                    const registration = snapshot.registration || {};
                    const content = handoff.content || {};

                    // Determine O2 requirement from content or snapshot
                    let o2Lpm = 0;
                    if (content.S?.o2_lpm) o2Lpm = content.S.o2_lpm;
                    else if (snapshot.vital_signs?.o2_lpm) o2Lpm = snapshot.vital_signs.o2_lpm;

                    // Create mission via API
                    const missionData = {
                        destination: content.R?.destination || content.S?.destination || '待確認',
                        patient_name: patient.name || handoff.patient_name || '未知',
                        patient_age: patient.age || '',
                        patient_condition: registration.priority === 'STAT' ? 'CRITICAL' : 'STABLE',
                        chief_complaint: registration.chief_complaint || '',
                        o2_lpm: o2Lpm,
                        estimated_duration_min: 120,
                        safety_factor: 3.0,
                        cirs_handoff_id: handoff.handoff_id,
                        cirs_display_id: handoff.display_id,
                        handoff_format: handoff.format,
                        handoff_snapshot: snapshot,
                        emt_name: this.emtCredentials.name
                    };

                    const res = await fetch('/api/transfer/missions', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(missionData)
                    });

                    const data = await res.json();
                    await this.loadMission(data.mission_id);
                    console.log('[EMT] Mission created from handoff:', data.mission_id);
                },

                async rejectHandoff(handoffId) {
                    if (!handoffId) return;

                    try {
                        const res = await fetch(`${this.cirsHubUrl}/api/handoff/${handoffId}/reject`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                rejector_id: this.emtCredentials.id,
                                rejector_name: this.emtCredentials.name,
                                rejection_code: this.rejectForm.code,
                                rejection_reason: this.rejectForm.reason
                            })
                        });

                        if (!res.ok) {
                            const err = await res.json();
                            throw new Error(err.detail || '拒絕失敗');
                        }

                        // Close modals and refresh
                        this.showRejectModal = false;
                        this.showHandoffDetail = false;
                        this.selectedHandoff = null;
                        this.rejectForm = { code: 'NO_CAPACITY', reason: '' };
                        await this.fetchPendingHandoffs();

                        alert('已拒絕此交班');

                    } catch (e) {
                        console.error('[EMT] Reject handoff error:', e);
                        alert('拒絕交班失敗: ' + e.message);
                    }
                },

                formatTime(timestamp) {
                    if (!timestamp) return '-';
                    const date = new Date(timestamp);
                    return date.toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' });
                },

                async loadMissionList() {
                    try {
                        const res = await fetch('/api/transfer/missions?limit=20');
                        const data = await res.json();
                        this.missionList = data.missions || [];
                    } catch (e) {
                        console.error('Failed to load missions:', e);
                    }
                },

                async loadMission(missionId) {
                    try {
                        const res = await fetch(`/api/transfer/missions/${missionId}`);
                        const data = await res.json();
                        this.currentMission = data.mission;
                        this.missionItems = data.items || [];
                        this.incomingItems = data.incoming_items || [];

                        // v3.2.3: Debug logging
                        console.log('[EMT] loadMission:', missionId, 'status:', this.currentMission?.status);

                        // v3.2.5: Initialize editMission with all fields
                        this.editMission = {
                            destination: this.currentMission.destination || '',
                            eta_min: this.currentMission.eta_min || Math.round((this.currentMission.estimated_duration_min || 120) / 2),
                            estimated_duration_min: this.currentMission.estimated_duration_min || 120,
                            patient_condition: this.currentMission.patient_condition || 'STABLE',
                            o2_lpm: this.currentMission.oxygen_requirement_lpm || 0,
                            iv_mode: this.currentMission.iv_mode || 'NONE',
                            safety_factor: this.currentMission.safety_factor || 3,
                            emt_name: this.currentMission.emt_name || ''
                        };

                        // Set initial values
                        this.missionItems.forEach(item => {
                            if (!item.carried_qty) item.carried_qty = item.suggested_qty;
                            if (!item.returned_qty) item.returned_qty = item.carried_qty;
                        });

                        // Determine current step based on status
                        this.updateStepFromStatus();
                        console.log('[EMT] updateStepFromStatus -> currentStep:', this.currentStep);

                        // Start elapsed timer if en route
                        if (this.currentMission.status === 'EN_ROUTE') {
                            this.startElapsedTimer();
                        }
                    } catch (e) {
                        console.error('Failed to load mission:', e);
                    }
                },

                updateStepFromStatus() {
                    const status = this.currentMission?.status;
                    if (status === 'PLANNING') this.currentStep = 0;
                    else if (status === 'READY') this.currentStep = 1;
                    else if (status === 'EN_ROUTE') this.currentStep = 2;
                    else if (status === 'ARRIVED') this.currentStep = 3;
                    else this.currentStep = 0;
                },

                goToStep(step) {
                    this.currentStep = step;
                    // 切換步驟時捲動到頂部
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                },

                // v3.2.3: Smart back button handler
                handleBackButton() {
                    if (!this.currentMission) {
                        // No mission, go back to MIRS
                        window.location.href = '/';
                        return;
                    }

                    if (this.currentStep > 0) {
                        // Go to previous step
                        this.goToStep(this.currentStep - 1);
                    } else {
                        // At Step 0, confirm before abandoning mission
                        if (confirm('離開將放棄此任務，確定要返回嗎？')) {
                            this.currentMission = null;
                            this.currentStep = 0;
                        }
                    }
                },

                // v3.2.5: Update mission settings and proceed to loadout
                async updateMissionAndProceed() {
                    if (!this.currentMission?.mission_id || !this.editMission.destination?.trim()) {
                        alert('請輸入目的地');
                        return;
                    }
                    try {
                        const res = await fetch(`/api/transfer/missions/${this.currentMission.mission_id}`, {
                            method: 'PATCH',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                destination: this.editMission.destination.trim(),
                                eta_min: this.editMission.eta_min,
                                estimated_duration_min: this.editMission.estimated_duration_min,
                                patient_condition: this.editMission.patient_condition,
                                oxygen_requirement_lpm: this.editMission.o2_lpm,
                                iv_mode: this.editMission.iv_mode,
                                safety_factor: this.editMission.safety_factor,
                                emt_name: this.editMission.emt_name
                            })
                        });
                        if (res.ok) {
                            // Reload mission to get recalculated items
                            await this.loadMission(this.currentMission.mission_id);
                            this.goToStep(1);
                        } else {
                            const err = await res.json();
                            alert('更新失敗: ' + (err.detail || res.status));
                        }
                    } catch (e) {
                        console.error('Failed to update mission:', e);
                        alert('更新任務失敗');
                    }
                },

                // v2.0: 載入可認領的氧氣鋼瓶
                async loadAvailableCylinders() {
                    this.loadingCylinders = true;
                    try {
                        const res = await fetch('/api/transfer/available-cylinders');
                        const data = await res.json();
                        this.availableCylinders = data.cylinders || [];
                    } catch (e) {
                        console.error('Failed to load available cylinders:', e);
                        this.availableCylinders = [];
                    } finally {
                        this.loadingCylinders = false;
                    }
                },

                // v2.0: 認領鋼瓶 (從庫存)
                claimCylinder(cyl) {
                    // 檢查是否已認領
                    if (this.oxygenCylinders.some(c => c.cylinder_id === cyl.id)) {
                        alert('此鋼瓶已在清單中');
                        return;
                    }
                    this.oxygenCylinders.push({
                        cylinder_id: cyl.id,  // 連結到庫存 (後端用 cylinder_id)
                        cylinder_type: cyl.cylinder_type,
                        unit_label: cyl.unit_label,
                        starting_psi: cyl.estimated_psi,
                        ending_psi: null,
                        checked: false,
                        claimed: true  // 標記為認領
                    });
                },

                // v2.0: 新增氧氣鋼瓶 (手動)
                addCylinder() {
                    this.oxygenCylinders.push({
                        cylinder_id: null,  // 無庫存連結
                        cylinder_type: 'E',
                        unit_label: '',
                        starting_psi: 2100,
                        ending_psi: null,
                        checked: false,
                        claimed: false  // 標記為手動
                    });
                },

                // v2.0: 新增設備
                addEquipment() {
                    this.equipmentBattery.push({
                        equipment_type: 'MONITOR',
                        equipment_name: '',
                        starting_battery_pct: 100,
                        ending_battery_pct: null,
                        checked: false
                    });
                },

                // v2.0: 新增藥物/耗材
                addMedication() {
                    if (!this.newMedication.item_name) return;
                    this.customMedications.push({
                        item_type: 'MEDICATION',
                        item_name: this.newMedication.item_name,
                        carried_qty: this.newMedication.carried_qty || 1,
                        unit: this.newMedication.unit || '支',
                        checked: false,
                        is_custom: true
                    });
                    this.newMedication = { item_name: '', carried_qty: 1, unit: '支' };
                    this.showAddMedication = false;
                },

                // v2.0: 快速新增常用藥物
                quickAddMedication(name, unit, qty) {
                    this.customMedications.push({
                        item_type: 'MEDICATION',
                        item_name: name,
                        carried_qty: qty,
                        unit: unit,
                        checked: false,
                        is_custom: true
                    });
                    this.showAddMedication = false;
                },

                // v2.0: 移除藥物
                removeMedicationItem(item) {
                    const idx = this.missionItems.indexOf(item);
                    if (idx > -1) {
                        this.missionItems.splice(idx, 1);
                    }
                },

                async createMission() {
                    // v3.1: Validate external source fields
                    if (this.newMission.source_type === 'EXTERNAL' && !this.newMission.source_org) {
                        alert('請填寫來源單位');
                        return;
                    }

                    try {
                        // v3.2: Build handoff_data for both internal and external
                        // When patient info is provided (for urgent/direct transfers or external)
                        const hasPatientInfo = this.newMission.patient_name || this.newMission.chief_complaint;
                        const format = this.newMission.handoff_format;

                        // Build report_content based on selected format
                        let report_content = null;
                        if (format === 'ISBAR') {
                            report_content = {
                                identify: this.newMission.isbar_identify,
                                situation: this.newMission.isbar_situation,
                                background: this.newMission.isbar_background,
                                assessment: this.newMission.isbar_assessment,
                                recommendation: this.newMission.isbar_recommendation
                            };
                        } else {  // MIST
                            report_content = {
                                mechanism: this.newMission.mist_mechanism,
                                injuries: this.newMission.mist_injuries,
                                signs: this.newMission.mist_signs,
                                treatment: this.newMission.mist_treatment
                            };
                        }

                        // Build payload
                        const payload = {
                            ...this.newMission,
                            // v3.2: Include handoff_data for both internal (urgent) and external
                            handoff_data: hasPatientInfo || this.newMission.source_type === 'EXTERNAL' ? {
                                source_type: this.newMission.source_type,
                                // v3.2: source_station for CIRS, source_org for EXTERNAL
                                source_station: this.newMission.source_type === 'CIRS' ? this.stationName : null,
                                source_org: this.newMission.source_org || null,
                                // v3.2: local_station is receiving station for EXTERNAL
                                local_station: this.newMission.source_type === 'EXTERNAL' ? this.stationName : null,
                                patient_name: this.newMission.patient_name,
                                patient_age: this.newMission.patient_age,
                                chief_complaint: this.newMission.chief_complaint,
                                triage: this.newMission.triage,
                                format: format,
                                report_content: report_content
                            } : null
                        };

                        const res = await fetch('/api/transfer/missions', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        const data = await res.json();

                        this.showNewMission = false;
                        await this.loadMission(data.mission_id);
                        await this.loadMissionList();

                        // 捲動到頂部，避免內容被 header 遮住
                        window.scrollTo({ top: 0, behavior: 'smooth' });

                        // Reset form (v3.2: include ISBAR fields)
                        this.newMission = {
                            destination: '',
                            eta_min: 60,
                            estimated_duration_min: 120,
                            patient_condition: 'STABLE',
                            o2_lpm: 0,
                            iv_mode: 'NONE',
                            iv_mlhr_override: null,
                            ventilator_required: false,
                            safety_factor: 3.0,
                            emt_name: '',
                            source_type: 'CIRS',
                            source_org: '',
                            patient_name: '',
                            patient_age: '',
                            chief_complaint: '',
                            triage: 'YELLOW',
                            handoff_format: 'MIST',
                            isbar_identify: '',
                            isbar_situation: '',
                            isbar_background: '',
                            isbar_assessment: '',
                            isbar_recommendation: '',
                            mist_mechanism: '',
                            mist_injuries: '',
                            mist_signs: '',
                            mist_treatment: ''
                        };
                        // 清空 v2.0 追蹤資料
                        this.oxygenCylinders = [];
                        this.equipmentBattery = [];
                        this.customMedications = [];

                        // v3.2: Show success message with handoff info
                        if (payload.handoff_data) {
                            const srcType = payload.handoff_data.source_type === 'EXTERNAL' ? '外部轉入' : '內部直轉';
                            const srcOrg = payload.handoff_data.source_org ? `\n來源: ${payload.handoff_data.source_org}` : '';
                            const patient = payload.handoff_data.patient_name ? `\n病患: ${payload.handoff_data.patient_name}` : '';
                            alert(`已建立${srcType}任務${srcOrg}${patient}`);
                        }
                    } catch (e) {
                        console.error('Failed to create mission:', e);
                        alert('建立任務失敗');
                    }
                },

                async confirmLoadout() {
                    if (!this.currentMission?.mission_id) {
                        alert('錯誤：未載入任務資料');
                        return;
                    }
                    try {
                        const items = this.missionItems.map(i => ({
                            item_id: i.id,
                            carried_qty: i.carried_qty,
                            initial_status: i.initial_status
                        }));

                        const res = await fetch(`/api/transfer/missions/${this.currentMission.mission_id}/confirm`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(items)
                        });

                        if (res.ok) {
                            // Depart immediately after confirm
                            await this.departMission();
                        }
                    } catch (e) {
                        console.error('Failed to confirm:', e);
                        alert('確認失敗');
                    }
                },

                // v2.0: 確認攜帶 (含 PSI/電量)
                async confirmLoadoutV2() {
                    if (!this.currentMission?.mission_id) {
                        alert('錯誤：未載入任務資料');
                        return;
                    }
                    try {
                        // 一般物資 (排除 OXYGEN，含 MEDICATION)
                        const items = this.missionItems
                            .filter(i => i.item_type !== 'OXYGEN')
                            .map(i => ({
                                item_id: i.id,
                                carried_qty: i.carried_qty
                            }));

                        // 加入自訂藥物
                        const customMeds = this.customMedications.map(m => ({
                            item_id: null,  // 無 ID，為自訂項目
                            item_type: 'MEDICATION',
                            item_name: m.item_name,
                            carried_qty: m.carried_qty,
                            unit: m.unit,
                            is_custom: true
                        }));

                        // 氧氣鋼瓶 (v2.0) - 含認領資訊
                        const oxygen_cylinders = this.oxygenCylinders.map(c => ({
                            cylinder_id: c.cylinder_id || null,  // 庫存連結 (後端用 cylinder_id)
                            cylinder_type: c.cylinder_type,
                            unit_label: c.unit_label || null,
                            starting_psi: c.starting_psi,
                            claimed: c.claimed || false  // 是否從庫存認領
                        }));

                        // 設備電量 (v2.0)
                        const equipment = this.equipmentBattery.map(e => ({
                            equipment_type: e.equipment_type,
                            equipment_name: e.equipment_name || e.equipment_type,
                            starting_battery_pct: e.starting_battery_pct
                        }));

                        const payload = { items: [...items, ...customMeds], oxygen_cylinders, equipment };

                        // 使用 v2.0 端點
                        const res = await fetch(`/api/transfer/missions/${this.currentMission.mission_id}/confirm/v2`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (res.ok) {
                            await this.departMission();
                        } else {
                            const err = await res.json();
                            alert('確認失敗: ' + (err.detail || res.status));
                        }
                    } catch (e) {
                        console.error('Failed to confirm v2:', e);
                        alert('確認失敗');
                    }
                },

                async departMission() {
                    try {
                        const res = await fetch(`/api/transfer/missions/${this.currentMission.mission_id}/depart`, {
                            method: 'POST'
                        });
                        if (res.ok) {
                            this.currentMission.status = 'EN_ROUTE';
                            this.currentStep = 2;
                            this.startElapsedTimer();
                        }
                    } catch (e) {
                        console.error('Failed to depart:', e);
                    }
                },

                startElapsedTimer() {
                    if (this.elapsedTimer) clearInterval(this.elapsedTimer);
                    if (!this.currentMission?.departed_at) {
                        this.elapsedTime = 0;
                        return;
                    }

                    const departed = new Date(this.currentMission.departed_at);
                    // Validate departed date
                    if (isNaN(departed.getTime())) {
                        this.elapsedTime = 0;
                        return;
                    }

                    this.elapsedTimer = setInterval(() => {
                        this.elapsedTime = Math.floor((Date.now() - departed.getTime()) / 60000);
                        // Cap at reasonable maximum (24 hours = 1440 min)
                        if (this.elapsedTime > 1440) this.elapsedTime = 1440;
                    }, 1000);
                },

                async arriveMission() {
                    if (!this.currentMission?.mission_id) {
                        console.error('No current mission');
                        alert('錯誤：未載入任務資料');
                        return;
                    }
                    try {
                        const res = await fetch(`/api/transfer/missions/${this.currentMission.mission_id}/arrive`, {
                            method: 'POST'
                        });
                        if (res.ok) {
                            if (this.elapsedTimer) clearInterval(this.elapsedTimer);
                            this.currentMission.status = 'ARRIVED';
                            this.currentStep = 3;
                        } else {
                            const err = await res.json();
                            alert('抵達失敗: ' + (err.detail || res.status));
                        }
                    } catch (e) {
                        console.error('Failed to arrive:', e);
                        alert('網路錯誤，請重試');
                    }
                },

                addIncomingItem() {
                    this.incomingItems.push({...this.newIncoming});
                    this.newIncoming = {
                        item_type: 'CONSUMABLE',
                        item_name: '',
                        quantity: 1,
                        unit: '個',
                        source_station: ''
                    };
                    this.showAddIncoming = false;
                },

                async finalizeMission() {
                    try {
                        // v2.0: 使用 finalize/v2 端點
                        const items = this.missionItems
                            .filter(i => i.carried_qty > 0 && i.item_type !== 'OXYGEN')
                            .map(i => ({
                                item_id: i.id,
                                returned_qty: i.returned_qty || 0
                            }));

                        const oxygen_cylinders = this.oxygenCylinders.map(c => ({
                            cylinder_type: c.cylinder_type,
                            unit_label: c.unit_label || null,
                            ending_psi: c.ending_psi || 0
                        }));

                        const equipment = this.equipmentBattery.map(e => ({
                            equipment_type: e.equipment_type,
                            equipment_name: e.equipment_name || e.equipment_type,
                            ending_battery_pct: e.ending_battery_pct || 0
                        }));

                        const payload = { items, oxygen_cylinders, equipment };

                        // 嘗試 v2.0 端點
                        let res = await fetch(`/api/transfer/missions/${this.currentMission.mission_id}/finalize/v2`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        // 若 v2 失敗，fallback 到 v1
                        if (!res.ok && res.status === 404) {
                            // 提交 recheck
                            await fetch(`/api/transfer/missions/${this.currentMission.mission_id}/recheck`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(items.map(i => ({ ...i, final_status: null })))
                            });

                            // 提交 incoming
                            if (this.incomingItems.length > 0) {
                                await fetch(`/api/transfer/missions/${this.currentMission.mission_id}/incoming`, {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify(this.incomingItems)
                                });
                            }

                            res = await fetch(`/api/transfer/missions/${this.currentMission.mission_id}/finalize`, {
                                method: 'POST'
                            });
                        }

                        if (res.ok) {
                            this.currentMission.status = 'COMPLETED';

                            // v3.3: 通知 CIRS Hub 交班完成
                            if (this.currentMission.cirs_handoff_id && this.cirsHubUrl) {
                                try {
                                    const completeRes = await fetch(`${this.cirsHubUrl}/api/handoff/${this.currentMission.cirs_handoff_id}/complete`, {
                                        method: 'POST',
                                        headers: { 'Content-Type': 'application/json' },
                                        body: JSON.stringify({
                                            completed_by: this.emtCredentials.id,
                                            completed_by_name: this.emtCredentials.name,
                                            arrival_notes: `任務完成於 ${new Date().toLocaleTimeString('zh-TW')}`,
                                            destination_confirmed: true
                                        })
                                    });
                                    if (completeRes.ok) {
                                        console.log('[EMT] CIRS handoff completed:', this.currentMission.cirs_handoff_id);
                                    } else {
                                        console.warn('[EMT] Failed to notify CIRS:', await completeRes.text());
                                    }
                                } catch (e) {
                                    console.warn('[EMT] CIRS notification error (non-blocking):', e);
                                }
                            }

                            // 清空追蹤資料
                            this.oxygenCylinders = [];
                            this.equipmentBattery = [];
                            this.customMedications = [];
                            await this.loadMissionList();
                        } else {
                            const err = await res.json();
                            alert('結案失敗: ' + (err.detail || res.status));
                        }
                    } catch (e) {
                        console.error('Failed to finalize:', e);
                        alert('結案失敗');
                    }
                }
            };
        }
    </script>
</body>
</html>
