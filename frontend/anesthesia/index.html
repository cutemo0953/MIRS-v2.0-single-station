<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>麻醉站 - MIRS</title>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icons/icon-192.png">
    <style>
        :root {
            /* Primary: Indigo (original) */
            --primary: #6366f1;      /* indigo-500 */
            --primary-dark: #4f46e5; /* indigo-600 */
            /* Grayscale for status/alerts (replacing yellow/red) */
            --success: #71717a;      /* zinc-500 */
            --warning: #a1a1aa;      /* zinc-400 */
            --danger: #52525b;       /* zinc-600 */
            --bg: #0f172a;
            --card: #1e293b;
            --card-hover: #334155;
            --text: #f1f5f9;
            --text-muted: #94a3b8;
            --border: #334155;
            /* Controlled drug color - purple-pink */
            --controlled: #c026d3;   /* fuchsia-600 */
            --controlled-dark: #a21caf; /* fuchsia-700 */
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            padding: 16px;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-title {
            font-size: 1.25rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .header-subtitle {
            font-size: 0.875rem;
            opacity: 0.8;
            margin-top: 4px;
        }

        /* Resource Bar */
        .resource-bar {
            display: flex;
            gap: 16px;
            padding: 12px 16px;
            background: var(--card);
            border-bottom: 1px solid var(--border);
            overflow-x: auto;
        }

        .resource-item {
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
        }

        .resource-value {
            font-weight: 600;
            font-size: 1.1rem;
        }

        .resource-value.warning {
            color: var(--warning);
        }

        .resource-value.danger {
            color: var(--danger);
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Main Content */
        .main {
            padding: 16px;
            padding-bottom: 100px;
        }

        /* Case Info Card */
        .case-card {
            background: var(--card);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .case-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .case-id {
            font-size: 0.875rem;
            color: var(--primary);
            font-weight: 600;
        }

        .patient-name {
            font-size: 1.25rem;
            font-weight: 600;
            margin-top: 4px;
        }

        .case-status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .case-status.preop { background: #71717a; color: #fff; }
        .case-status.in_progress { background: #52525b; color: #fff; }
        .case-status.pacu { background: #64748b; color: #fff; }
        .case-status.closed { background: #3f3f46; color: #a1a1aa; }

        /* Quick Actions */
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 16px;
        }

        .quick-btn {
            background: var(--card);
            border: 2px solid var(--border);
            border-radius: 10px;
            padding: 12px 8px;
            color: var(--text);
            font-size: 0.8rem;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            transition: all 0.2s;
        }

        .quick-btn .icon {
            width: 20px !important;
            height: 20px !important;
        }

        .quick-btn:active {
            transform: scale(0.95);
            background: var(--card-hover);
        }

        .quick-btn.primary {
            background: var(--primary);
            border-color: var(--primary);
        }

        .quick-btn.success {
            background: var(--success);
            border-color: var(--success);
        }

        .quick-btn.warning {
            background: var(--warning);
            border-color: var(--warning);
            color: #000;
        }

        .quick-btn.controlled {
            background: var(--controlled);
            border-color: var(--controlled);
        }

        .quick-btn.controlled:active {
            background: var(--controlled-dark);
        }

        /* Vitals Grid */
        .vitals-section {
            background: var(--card);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .section-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-muted);
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .vitals-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
        }

        .vital-input {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px;
            text-align: center;
        }

        .vital-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-bottom: 4px;
        }

        .vital-value {
            background: transparent;
            border: none;
            color: var(--text);
            font-size: 1.5rem;
            font-weight: 600;
            width: 100%;
            text-align: center;
            outline: none;
        }

        .vital-value::placeholder {
            color: var(--text-muted);
            font-size: 1rem;
        }

        .vital-unit {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        /* Timeline */
        .timeline-section {
            background: var(--card);
            border-radius: 12px;
            padding: 16px;
        }

        .timeline {
            max-height: 300px;
            overflow-y: auto;
        }

        .timeline-item {
            display: flex;
            gap: 12px;
            padding: 12px 0;
            border-bottom: 1px solid var(--border);
        }

        .timeline-item:last-child {
            border-bottom: none;
        }

        .timeline-time {
            font-size: 0.875rem;
            color: var(--text-muted);
            min-width: 50px;
        }

        .timeline-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--primary);
            margin-top: 4px;
        }

        .timeline-dot.vital { background: #71717a; }
        .timeline-dot.med { background: var(--controlled); }
        .timeline-dot.milestone { background: #52525b; }

        .timeline-content {
            flex: 1;
        }

        .timeline-type {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .timeline-desc {
            font-size: 0.9rem;
            margin-top: 2px;
        }

        /* Bottom Nav */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--card);
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: space-around;
            padding: 12px 0;
            padding-bottom: calc(12px + env(safe-area-inset-bottom));
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            color: var(--text-muted);
            font-size: 0.75rem;
            cursor: pointer;
            padding: 8px 16px;
        }

        .nav-item.active {
            color: var(--primary);
        }

        /* Controlled nav only shows purple-pink when active */
        .nav-item.controlled-nav.active {
            color: var(--controlled);
        }

        .nav-item .icon {
            font-size: 1.25rem;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 200;
            align-items: flex-end;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--card);
            border-radius: 20px 20px 0 0;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            padding: 20px;
            padding-bottom: calc(20px + env(safe-area-inset-bottom));
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 1.5rem;
            cursor: pointer;
        }

        /* Quick Med Buttons */
        .med-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .med-btn {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            color: var(--text);
            cursor: pointer;
            text-align: left;
        }

        .med-btn:active {
            background: var(--card-hover);
        }

        .med-btn.controlled-drug {
            border-color: var(--controlled);
        }

        .med-btn.controlled-drug .med-name {
            color: var(--controlled);
        }

        .med-name {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .med-dose {
            font-size: 0.875rem;
            color: var(--text-muted);
        }

        /* Dose Adjustment UI */
        .selected-drug-card {
            background: var(--bg);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            margin-bottom: 20px;
        }

        .selected-drug-name {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .selected-drug-tag {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .selected-drug-tag.controlled {
            background: var(--controlled);
            color: white;
        }

        .dose-adjust-section {
            background: var(--bg);
            border-radius: 12px;
            padding: 16px;
        }

        .dose-btn {
            background: var(--card-hover);
            border: none;
            border-radius: 8px;
            padding: 12px 16px;
            color: var(--text);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
        }

        .dose-btn:active {
            background: var(--primary);
        }

        .dose-input {
            width: 100px;
            text-align: center;
            font-size: 1.5rem;
            font-weight: 700;
        }

        .dose-unit {
            text-align: center;
            color: var(--text-muted);
            margin-top: 8px;
        }

        /* Form */
        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            font-size: 0.875rem;
            color: var(--text-muted);
            margin-bottom: 8px;
            display: block;
        }

        .form-input {
            width: 100%;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px;
            color: var(--text);
            font-size: 1rem;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .btn {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:active {
            background: var(--primary-dark);
        }

        /* Case List (No Active Case View) */
        .case-list {
            margin-top: 16px;
        }

        .case-list-item {
            background: var(--card);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            cursor: pointer;
        }

        .case-list-item:active {
            background: var(--card-hover);
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
        }

        .empty-state .icon {
            font-size: 4rem;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .empty-state p {
            color: var(--text-muted);
            margin-bottom: 20px;
        }

        /* Hidden */
        .hidden {
            display: none !important;
        }

        /* Time Offset Selector v1.6.1 */
        .time-offset-selector {
            margin-bottom: 16px;
            padding: 12px;
            background: var(--bg-secondary);
            border-radius: 8px;
        }

        .time-offset-label {
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .time-offset-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .time-offset-btn {
            padding: 8px 14px;
            border: 1px solid var(--border);
            background: var(--bg-card);
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.15s;
        }

        .time-offset-btn:hover {
            background: var(--bg-hover);
        }

        .time-offset-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .time-offset-custom {
            display: none;
            margin-top: 10px;
            gap: 8px;
            align-items: center;
        }

        .time-offset-custom.show {
            display: flex;
        }

        .time-offset-custom input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: var(--bg-card);
            color: var(--text-primary);
            font-size: 14px;
        }

        .late-entry-reason {
            display: none;
            margin-top: 10px;
            padding: 10px;
            background: rgba(251, 191, 36, 0.1);
            border: 1px solid rgba(251, 191, 36, 0.3);
            border-radius: 6px;
        }

        .late-entry-reason.show {
            display: block;
        }

        .late-entry-reason label {
            font-size: 12px;
            color: #f59e0b;
            display: block;
            margin-bottom: 6px;
        }

        .late-entry-reason select,
        .late-entry-reason input {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border);
            border-radius: 4px;
            background: var(--bg-card);
            color: var(--text-primary);
            font-size: 13px;
            margin-bottom: 6px;
        }

        .computed-time {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 6px;
            padding: 6px 10px;
            background: var(--bg-card);
            border-radius: 4px;
            display: inline-block;
        }
    </style>
    <!-- Note: xirs-fallback-guard.js 已移除 - MIRS Anesthesia 使用 CIRS Hub 連線 -->
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-title">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width:20px;height:20px;">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
            </svg>
            <span>麻醉站</span>
            <span id="contextBadge" class="case-status hidden">BATTLEFIELD</span>
            <span id="syncIndicator" class="sync-indicator" title="同步狀態">
                <svg class="sync-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width:16px;height:16px;">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                </svg>
                <span id="syncBadge" class="sync-badge hidden">0</span>
            </span>
        </div>
        <div class="header-subtitle" id="stationInfo">MIRS v1.5.1</div>
    </header>

    <!-- Resource Bar (shown when case is active) -->
    <div class="resource-bar hidden" id="resourceBar">
        <div class="resource-item o2-item" onclick="showO2Modal()" style="cursor:pointer; padding: 4px 8px; border-radius: 8px; transition: background 0.2s;">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width:18px;height:18px;opacity:0.7;">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path>
            </svg>
            <span id="o2Label">O2</span>
            <span class="resource-value" id="o2Status">未認領</span>
            <span id="o2Unit"></span>
        </div>
        <div class="resource-item">
            <span>SpO2</span>
            <span class="resource-value" id="lastSpo2">--</span>
            <span>%</span>
        </div>
        <div class="resource-item">
            <span>HR</span>
            <span class="resource-value" id="lastHr">--</span>
        </div>
        <div class="resource-item">
            <span>BP</span>
            <span class="resource-value" id="lastBp">--/--</span>
        </div>
    </div>

    <!-- Main Content -->
    <main class="main">
        <!-- No Case View -->
        <div id="noCaseView">
            <div class="quick-actions">
                <button class="quick-btn primary" onclick="showNewCaseModal()">
                    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width:24px;height:24px;">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                    </svg>
                    <span>新增案例</span>
                </button>
                <button class="quick-btn" onclick="loadCases()">
                    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width:24px;height:24px;">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path>
                    </svg>
                    <span>今日案例</span>
                </button>
            </div>

            <div class="case-list" id="caseList">
                <div class="empty-state">
                    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width:64px;height:64px;opacity:0.5;">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
                    </svg>
                    <p>尚無進行中的案例</p>
                </div>
            </div>
        </div>

        <!-- Active Case View -->
        <div id="activeCaseView" class="hidden">
            <!-- Case Info -->
            <div class="case-card">
                <div class="case-header">
                    <div>
                        <div class="case-id" id="caseId">ANES-20251229-ABC</div>
                        <div class="patient-name" id="patientName">病患姓名</div>
                    </div>
                    <span class="case-status preop" id="caseStatus">PREOP</span>
                </div>
                <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                    <span style="font-size: 0.875rem; color: var(--text-muted);" id="techniqueInfo">GA_ETT</span>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="quick-actions">
                <button class="quick-btn primary" onclick="showVitalsModal()">
                    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width:24px;height:24px;">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
                    </svg>
                    <span>記錄 Vitals</span>
                </button>
                <button class="quick-btn controlled" onclick="showMedModal()">
                    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width:24px;height:24px;">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path>
                    </svg>
                    <span>給藥</span>
                </button>
                <button class="quick-btn" onclick="addMilestone('ANESTHESIA_START')" id="btnStart">
                    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width:24px;height:24px;">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <span>開始麻醉</span>
                </button>
                <button class="quick-btn" onclick="showO2Modal()">
                    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width:24px;height:24px;">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path>
                    </svg>
                    <span>氧氣</span>
                </button>
                <button class="quick-btn" onclick="showMilestoneMenu()">
                    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width:24px;height:24px;">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path>
                    </svg>
                    <span>里程碑</span>
                </button>
                <button class="quick-btn" onclick="closeCase()" style="background: var(--danger); border-color: var(--danger);">
                    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width:24px;height:24px;">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <span>結案</span>
                </button>
            </div>

            <!-- Timeline -->
            <div class="timeline-section">
                <div class="section-title">事件時間軸</div>
                <div class="timeline" id="timeline">
                    <div class="empty-state">
                        <p>尚無事件</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Bottom Nav -->
    <nav class="bottom-nav">
        <div class="nav-item active" onclick="switchTab('case')">
            <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width:20px;height:20px;">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
            </svg>
            <span>案例</span>
        </div>
        <div class="nav-item" onclick="switchTab('preop')">
            <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width:20px;height:20px;">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path>
            </svg>
            <span>術前</span>
        </div>
        <div class="nav-item controlled-nav" onclick="switchTab('drugs')">
            <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width:20px;height:20px;">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path>
            </svg>
            <span>管藥</span>
        </div>
        <div class="nav-item" onclick="switchTab('o2')">
            <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width:20px;height:20px;">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.999 5.002 5.002 0 10-9.78 2.096A4.001 4.001 0 003 15z"></path>
            </svg>
            <span>氧氣</span>
        </div>
    </nav>

    <!-- New Case Modal -->
    <div class="modal" id="newCaseModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">新增麻醉案例</h2>
                <button class="modal-close" onclick="closeModal('newCaseModal')">&times;</button>
            </div>

            <!-- CIRS Waiting List Section -->
            <div id="cirsWaitingSection" style="margin-bottom: 16px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <label class="form-label" style="margin: 0;">CIRS 候診名單</label>
                    <span id="cirsStatus" style="font-size: 12px; color: var(--text-secondary);">檢查中...</span>
                </div>
                <div id="cirsPatientList" style="max-height: 150px; overflow-y: auto; background: var(--bg-tertiary); border-radius: 8px; padding: 8px;">
                    <div style="text-align: center; color: var(--text-secondary); padding: 16px;">載入中...</div>
                </div>
            </div>

            <div style="text-align: center; color: var(--text-secondary); margin-bottom: 12px; font-size: 13px;">
                ─── 或手動輸入 ───
            </div>

            <form onsubmit="createCase(event)">
                <input type="hidden" id="cirsRegistrationRef" value="">
                <input type="hidden" id="patientSnapshot" value="">

                <div class="form-group">
                    <label class="form-label">病歷號 / 病患 ID</label>
                    <input type="text" class="form-input" id="newPatientId" required placeholder="輸入病歷號">
                </div>
                <div class="form-group">
                    <label class="form-label">病患姓名</label>
                    <input type="text" class="form-input" id="newPatientName" placeholder="選填">
                </div>
                <div class="form-group">
                    <label class="form-label">麻醉方式</label>
                    <select class="form-input" id="newTechnique">
                        <option value="GA_ETT">全身麻醉 (ETT)</option>
                        <option value="GA_LMA">全身麻醉 (LMA)</option>
                        <option value="RA_SPINAL">脊椎麻醉</option>
                        <option value="RA_EPIDURAL">硬膜外麻醉</option>
                        <option value="LA">局部麻醉</option>
                        <option value="SEDATION">鎮靜</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">模式</label>
                    <select class="form-input" id="newContextMode">
                        <option value="STANDARD">標準模式</option>
                        <option value="BATTLEFIELD">戰時模式</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary">建立案例</button>
            </form>
        </div>
    </div>

    <!-- Vitals Modal -->
    <div class="modal" id="vitalsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">記錄 Vital Signs</h2>
                <button class="modal-close" onclick="closeModal('vitalsModal')">&times;</button>
            </div>
            <form onsubmit="submitVitals(event)">
                <!-- Time Offset Selector v1.6.1 -->
                <div class="time-offset-selector" id="vitalsTimeSelector">
                    <div class="time-offset-label">
                        <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="10" stroke-width="2"/>
                            <path stroke-width="2" d="M12 6v6l4 2"/>
                        </svg>
                        事件時間
                    </div>
                    <div class="time-offset-buttons">
                        <button type="button" class="time-offset-btn active" data-offset="0" onclick="selectTimeOffset(this, 'vitals')">現在</button>
                        <button type="button" class="time-offset-btn" data-offset="-300" onclick="selectTimeOffset(this, 'vitals')">-5分</button>
                        <button type="button" class="time-offset-btn" data-offset="-600" onclick="selectTimeOffset(this, 'vitals')">-10分</button>
                        <button type="button" class="time-offset-btn" data-offset="-900" onclick="selectTimeOffset(this, 'vitals')">-15分</button>
                        <button type="button" class="time-offset-btn" data-offset="custom" onclick="selectTimeOffset(this, 'vitals')">自訂</button>
                    </div>
                    <div class="time-offset-custom" id="vitalsTimeCustom">
                        <input type="datetime-local" id="vitalsCustomTime" onchange="updateComputedTime('vitals')">
                    </div>
                    <div class="late-entry-reason" id="vitalsLateEntry">
                        <label>遲補登錄原因 (超過5分鐘需填寫)</label>
                        <select id="vitalsLateReason">
                            <option value="EMERGENCY_HANDLING">緊急處置中</option>
                            <option value="EQUIPMENT_ISSUE">設備問題</option>
                            <option value="SHIFT_HANDOFF">交班中</option>
                            <option value="DOCUMENTATION_CATCH_UP">補登文件</option>
                            <option value="OTHER">其他</option>
                        </select>
                        <input type="text" id="vitalsLateNote" placeholder="備註 (選填)">
                    </div>
                    <div class="computed-time" id="vitalsComputedTime">記錄時間: 現在</div>
                </div>

                <div class="vitals-grid">
                    <div class="vital-input">
                        <div class="vital-label">BP (sys)</div>
                        <input type="number" class="vital-value" id="vBpSys" placeholder="120">
                        <div class="vital-unit">mmHg</div>
                    </div>
                    <div class="vital-input">
                        <div class="vital-label">BP (dia)</div>
                        <input type="number" class="vital-value" id="vBpDia" placeholder="80">
                        <div class="vital-unit">mmHg</div>
                    </div>
                    <div class="vital-input">
                        <div class="vital-label">HR</div>
                        <input type="number" class="vital-value" id="vHr" placeholder="72">
                        <div class="vital-unit">bpm</div>
                    </div>
                    <div class="vital-input">
                        <div class="vital-label">SpO2</div>
                        <input type="number" class="vital-value" id="vSpo2" placeholder="99">
                        <div class="vital-unit">%</div>
                    </div>
                    <div class="vital-input">
                        <div class="vital-label">EtCO2</div>
                        <input type="number" class="vital-value" id="vEtco2" placeholder="35">
                        <div class="vital-unit">mmHg</div>
                    </div>
                    <div class="vital-input">
                        <div class="vital-label">O2 Flow</div>
                        <input type="number" step="0.5" class="vital-value" id="vO2Flow" placeholder="2">
                        <div class="vital-unit">L/min</div>
                    </div>
                </div>
                <div style="margin-top: 20px;">
                    <button type="submit" class="btn btn-primary">記錄</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Medication Modal -->
    <div class="modal" id="medModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">給藥記錄</h2>
                <button class="modal-close" onclick="closeModal('medModal')">&times;</button>
            </div>

            <!-- Drug Selection View -->
            <div id="medSelectView">
                <div class="section-title">常用藥物</div>
                <div class="med-grid">
                    <button class="med-btn" onclick="selectMed('PROPO001', 'Propofol', 100, 'mg', false)">
                        <div class="med-name">Propofol</div>
                        <div class="med-dose">100 mg IV</div>
                    </button>
                    <button class="med-btn controlled-drug" onclick="selectMed('FENTA001', 'Fentanyl', 50, 'mcg', true)">
                        <div class="med-name">Fentanyl</div>
                        <div class="med-dose">50 mcg IV</div>
                    </button>
                    <button class="med-btn" onclick="selectMed('ROCUR001', 'Rocuronium', 50, 'mg', false)">
                        <div class="med-name">Rocuronium</div>
                        <div class="med-dose">50 mg IV</div>
                    </button>
                    <button class="med-btn controlled-drug" onclick="selectMed('MIDAZ001', 'Midazolam', 2, 'mg', true)">
                        <div class="med-name">Midazolam</div>
                        <div class="med-dose">2 mg IV</div>
                    </button>
                    <button class="med-btn" onclick="selectMed('ATRO001', 'Atropine', 0.5, 'mg', false)">
                        <div class="med-name">Atropine</div>
                        <div class="med-dose">0.5 mg IV</div>
                    </button>
                    <button class="med-btn" onclick="selectMed('EPHED001', 'Ephedrine', 5, 'mg', false)">
                        <div class="med-name">Ephedrine</div>
                        <div class="med-dose">5 mg IV</div>
                    </button>
                </div>
                <div style="margin-top: 20px;">
                    <button class="btn" style="background: var(--card-hover);" onclick="showCustomMedForm()">自訂藥物</button>
                </div>
            </div>

            <!-- Dose Adjustment View -->
            <div id="medConfirmView" class="hidden">
                <div class="selected-drug-card">
                    <div class="selected-drug-name" id="selectedDrugName">Propofol</div>
                    <div class="selected-drug-tag" id="selectedDrugTag"></div>
                </div>

                <!-- Time Offset Selector v1.6.1 -->
                <div class="time-offset-selector" id="medTimeSelector">
                    <div class="time-offset-label">
                        <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="10" stroke-width="2"/>
                            <path stroke-width="2" d="M12 6v6l4 2"/>
                        </svg>
                        給藥時間
                    </div>
                    <div class="time-offset-buttons">
                        <button type="button" class="time-offset-btn active" data-offset="0" onclick="selectTimeOffset(this, 'med')">現在</button>
                        <button type="button" class="time-offset-btn" data-offset="-300" onclick="selectTimeOffset(this, 'med')">-5分</button>
                        <button type="button" class="time-offset-btn" data-offset="-600" onclick="selectTimeOffset(this, 'med')">-10分</button>
                        <button type="button" class="time-offset-btn" data-offset="-900" onclick="selectTimeOffset(this, 'med')">-15分</button>
                        <button type="button" class="time-offset-btn" data-offset="custom" onclick="selectTimeOffset(this, 'med')">自訂</button>
                    </div>
                    <div class="time-offset-custom" id="medTimeCustom">
                        <input type="datetime-local" id="medCustomTime" onchange="updateComputedTime('med')">
                    </div>
                    <div class="late-entry-reason" id="medLateEntry">
                        <label>遲補登錄原因 (超過5分鐘需填寫)</label>
                        <select id="medLateReason">
                            <option value="EMERGENCY_HANDLING">緊急處置中</option>
                            <option value="EQUIPMENT_ISSUE">設備問題</option>
                            <option value="SHIFT_HANDOFF">交班中</option>
                            <option value="DOCUMENTATION_CATCH_UP">補登文件</option>
                            <option value="OTHER">其他</option>
                        </select>
                        <input type="text" id="medLateNote" placeholder="備註 (選填)">
                    </div>
                    <div class="computed-time" id="medComputedTime">記錄時間: 現在</div>
                </div>

                <div class="dose-adjust-section">
                    <div class="form-group">
                        <label class="form-label">劑量</label>
                        <div style="display: flex; gap: 12px; align-items: center;">
                            <button class="dose-btn" onclick="adjustDose(-10)">-10</button>
                            <button class="dose-btn" onclick="adjustDose(-1)">-1</button>
                            <input type="number" class="form-input dose-input" id="selectedDose" step="0.1">
                            <button class="dose-btn" onclick="adjustDose(1)">+1</button>
                            <button class="dose-btn" onclick="adjustDose(10)">+10</button>
                        </div>
                        <div class="dose-unit" id="selectedUnit">mg</div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">給藥途徑</label>
                        <select class="form-input" id="selectedRoute">
                            <option value="IV">IV 靜脈注射</option>
                            <option value="IM">IM 肌肉注射</option>
                            <option value="SC">SC 皮下注射</option>
                            <option value="PO">PO 口服</option>
                            <option value="INH">INH 吸入</option>
                        </select>
                    </div>
                </div>
                <div style="display: flex; gap: 12px; margin-top: 20px;">
                    <button class="btn" style="background: var(--card-hover); flex: 1;" onclick="backToMedSelect()">返回</button>
                    <button class="btn btn-primary" style="flex: 2;" onclick="confirmMed()">確認給藥</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Battlefield Preop Modal -->
    <div class="modal" id="preopModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">術前快速評估</h2>
                <button class="modal-close" onclick="closeModal('preopModal')">&times;</button>
            </div>
            <div id="preopContent">
                <div class="section-title">戰場模式 - 快速5項評估</div>
                <div style="display: flex; flex-direction: column; gap: 12px; margin-top: 16px;">
                    <label class="preop-flag">
                        <input type="checkbox" id="flagAllergic">
                        <span class="flag-label">
                            <svg class="flag-icon warning-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width:20px;height:20px;">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                            </svg>
                            已知過敏 (Known Allergy)
                        </span>
                    </label>
                    <label class="preop-flag">
                        <input type="checkbox" id="flagFullStomach">
                        <span class="flag-label">
                            <svg class="flag-icon warning-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width:20px;height:20px;">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                            </svg>
                            未禁食 (Full Stomach)
                        </span>
                    </label>
                    <label class="preop-flag">
                        <input type="checkbox" id="flagDifficultAirway">
                        <span class="flag-label">
                            <svg class="flag-icon danger-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width:20px;height:20px;">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            困難呼吸道 (Difficult Airway)
                        </span>
                    </label>
                    <label class="preop-flag">
                        <input type="checkbox" id="flagUnstable">
                        <span class="flag-label">
                            <svg class="flag-icon danger-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width:20px;height:20px;">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            血行動力不穩 (Hemodynamically Unstable)
                        </span>
                    </label>
                    <label class="preop-flag">
                        <input type="checkbox" id="flagHighRisk">
                        <span class="flag-label">
                            <svg class="flag-icon danger-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width:20px;height:20px;">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            高風險 (High Risk)
                        </span>
                    </label>
                </div>
                <div class="form-group" style="margin-top: 16px;">
                    <label class="form-label">快速備註</label>
                    <textarea class="form-input" id="preopQuickNote" rows="2" placeholder="其他重要資訊..."></textarea>
                </div>
                <div style="margin-top: 20px; display: flex; gap: 12px;">
                    <button class="btn btn-primary" onclick="savePreop()">儲存評估</button>
                    <button class="btn" style="background: var(--card-hover);" onclick="closeModal('preopModal')">取消</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Phase B: Controlled Drugs Modal -->
    <div class="modal" id="drugsModal">
        <div class="modal-content" style="max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h2 class="modal-title">管制藥品</h2>
                <button class="modal-close" onclick="closeModal('drugsModal')">&times;</button>
            </div>

            <!-- Holdings Summary -->
            <div id="drugHoldingsSummary" class="holdings-summary">
                <div class="holdings-header">
                    <span>藥品餘額</span>
                    <span id="holdingsStatus" class="holdings-status reconciled">已結清</span>
                </div>
                <div id="holdingsList" class="holdings-list">
                    <!-- Populated by JS -->
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="drug-actions">
                <button class="drug-action-btn" onclick="showDrugDispenseForm()">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width:20px;height:20px;">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                    </svg>
                    <span>領藥</span>
                </button>
                <button class="drug-action-btn" onclick="showDrugAdminForm()">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width:20px;height:20px;">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path>
                    </svg>
                    <span>給藥</span>
                </button>
                <button class="drug-action-btn" onclick="showDrugWasteForm()">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width:20px;height:20px;">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                    </svg>
                    <span>廢棄</span>
                </button>
                <button class="drug-action-btn" onclick="showDrugReturnForm()">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width:20px;height:20px;">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"></path>
                    </svg>
                    <span>退回</span>
                </button>
            </div>

            <!-- Transaction Form (hidden by default) -->
            <div id="drugTxForm" class="hidden">
                <div class="section-title" id="drugTxTitle">給藥記錄</div>
                <div class="form-group">
                    <label class="form-label">藥品</label>
                    <select class="form-input" id="drugTxDrugSelect">
                        <option value="">選擇藥品...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">劑量</label>
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <input type="number" class="form-input" id="drugTxQuantity" step="0.1" style="flex: 1;">
                        <span id="drugTxUnit" class="dose-unit" style="min-width: 40px;">mg</span>
                    </div>
                    <div id="drugTxAvailable" class="drug-available">可用: --</div>
                </div>
                <div id="drugTxWitnessGroup" class="form-group hidden">
                    <label class="form-label">見證人 ID (必填)</label>
                    <input type="text" class="form-input" id="drugTxWitness" placeholder="輸入見證人 ID">
                    <div class="form-hint">管藥廢棄需要見證人簽核</div>
                </div>
                <div class="form-group">
                    <label class="form-label">備註</label>
                    <input type="text" class="form-input" id="drugTxNotes" placeholder="選填">
                </div>
                <div style="display: flex; gap: 12px; margin-top: 16px;">
                    <button class="btn" style="background: var(--card-hover); flex: 1;" onclick="hideDrugTxForm()">取消</button>
                    <button class="btn controlled" style="flex: 2;" onclick="submitDrugTx()">確認</button>
                </div>
            </div>

            <!-- Transaction History -->
            <div class="section-title" style="margin-top: 20px;">交易記錄</div>
            <div id="drugTxHistory" class="tx-history">
                <div class="empty-state" style="padding: 20px;">
                    <p>尚無交易記錄</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Phase C: O2 Cylinder Modal -->
    <div class="modal" id="o2Modal">
        <div class="modal-content" style="max-height: 80vh; overflow-y: auto;">
            <div class="modal-header">
                <h2 class="modal-title">氧氣管理</h2>
                <button class="modal-close" onclick="closeModal('o2Modal')">&times;</button>
            </div>

            <!-- Current O2 Status -->
            <div class="o2-current-status" id="o2CurrentStatus">
                <div class="holdings-header">
                    <span>目前狀態</span>
                    <span class="holdings-status" id="o2ClaimStatus">未認領</span>
                </div>
                <div id="o2ClaimedInfo" class="hidden" style="padding: 12px; background: var(--card); border-radius: 8px; margin-bottom: 12px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span>氧氣瓶</span>
                        <span id="o2CylinderSerial" style="font-weight: 600;">--</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span>剩餘量</span>
                        <span id="o2LevelPercent" style="font-weight: 600;">--%</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span>預估剩餘</span>
                        <span id="o2EstTime" style="font-weight: 600;">-- min</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span>流速</span>
                        <span id="o2FlowRate" style="font-weight: 600;">-- L/min</span>
                    </div>
                </div>
                <button id="o2ReleaseBtn" class="quick-btn hidden" onclick="releaseO2Cylinder()" style="width: 100%; background: var(--danger); border-color: var(--danger);">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width:20px;height:20px;">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                    <span>釋放氧氣瓶</span>
                </button>
            </div>

            <!-- Available Cylinders List -->
            <div id="o2AvailableSection">
                <div class="holdings-header" style="margin-top: 16px;">
                    <span>可用氧氣瓶</span>
                    <button onclick="loadAvailableCylinders()" style="background: none; border: none; color: var(--primary); cursor: pointer;">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width:20px;height:20px;">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                        </svg>
                    </button>
                </div>
                <div id="o2CylinderList" class="holdings-list">
                    <div class="empty-state" style="padding: 24px; text-align: center;">
                        <p style="color: var(--text-muted);">載入中...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <style>
        /* Phase C: O2 Modal Styles */
        .o2-current-status {
            background: var(--bg);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
        }
        .o2-cylinder-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: var(--card);
            border-radius: 8px;
            border-left: 3px solid var(--primary);
            cursor: pointer;
            transition: all 0.2s;
        }
        .o2-cylinder-item:hover {
            background: var(--card-hover);
        }
        .o2-cylinder-item.claimed {
            border-left-color: var(--warning);
            opacity: 0.6;
            cursor: not-allowed;
        }
        .o2-cylinder-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .o2-cylinder-serial {
            font-weight: 600;
        }
        .o2-cylinder-level {
            font-size: 0.875rem;
            color: var(--text-muted);
        }
        .o2-level-bar {
            width: 60px;
            height: 8px;
            background: var(--border);
            border-radius: 4px;
            overflow: hidden;
        }
        .o2-level-fill {
            height: 100%;
            background: var(--primary);
            transition: width 0.3s;
        }
        .o2-level-fill.low {
            background: var(--warning);
        }
        .o2-level-fill.critical {
            background: var(--danger);
        }
        .o2-item:hover {
            background: rgba(255,255,255,0.1);
        }
    </style>

    <style>
        /* Phase B: Drug Modal Styles */
        .holdings-summary {
            background: var(--bg);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
        }
        .holdings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            font-weight: 600;
        }
        .holdings-status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .holdings-status.reconciled {
            background: #71717a;
            color: white;
        }
        .holdings-status.pending {
            background: var(--controlled);
            color: white;
        }
        .holdings-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .holding-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: var(--card);
            border-radius: 8px;
            border-left: 3px solid var(--controlled);
        }
        .holding-drug-name {
            font-weight: 500;
        }
        .holding-balance {
            font-weight: 700;
            color: var(--controlled);
        }
        .holding-balance.zero {
            color: #71717a;
        }
        .drug-actions {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-bottom: 16px;
        }
        .drug-action-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 12px 8px;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-size: 0.75rem;
            cursor: pointer;
        }
        .drug-action-btn:active {
            background: var(--card-hover);
        }
        .drug-available {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 4px;
        }
        .form-hint {
            font-size: 0.75rem;
            color: var(--controlled);
            margin-top: 4px;
        }
        .btn.controlled {
            background: var(--controlled);
        }
        .btn.controlled:active {
            background: var(--controlled-dark);
        }
        .tx-history {
            max-height: 200px;
            overflow-y: auto;
        }
        .tx-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 12px;
            border-bottom: 1px solid var(--border);
        }
        .tx-item:last-child {
            border-bottom: none;
        }
        .tx-type {
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 600;
        }
        .tx-type.DISPENSE { background: #6366f1; color: white; }
        .tx-type.ADMIN { background: var(--controlled); color: white; }
        .tx-type.WASTE { background: #71717a; color: white; }
        .tx-type.RETURN { background: #52525b; color: white; }
        .tx-info {
            flex: 1;
            margin-left: 8px;
        }
        .tx-drug {
            font-weight: 500;
            font-size: 0.875rem;
        }
        .tx-detail {
            font-size: 0.75rem;
            color: var(--text-muted);
        }
        .tx-amount {
            font-weight: 600;
            text-align: right;
        }
    </style>

    <style>
        .preop-flag {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .preop-flag:hover {
            background: var(--card-hover);
        }
        .preop-flag input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin-right: 12px;
        }
        .preop-flag input[type="checkbox"]:checked + .flag-label {
            color: var(--warning);
        }
        .flag-label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1rem;
        }
        .flag-icon {
            flex-shrink: 0;
        }
        .flag-icon.warning-icon { color: #a1a1aa; }
        .flag-icon.danger-icon { color: #71717a; }

        /* Phase A-6: Sync Indicator Styles */
        .sync-indicator {
            display: flex;
            align-items: center;
            margin-left: auto;
            padding: 4px 8px;
            border-radius: 4px;
            background: rgba(255,255,255,0.1);
        }
        .sync-icon {
            font-size: 1rem;
        }
        .sync-indicator.syncing .sync-icon {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .sync-badge {
            background: #a1a1aa;
            color: #18181b;
            font-size: 0.7rem;
            font-weight: bold;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: 4px;
        }
        .sync-badge.hidden {
            display: none;
        }

        /* Offline mode indicator */
        body.offline::before {
            content: '離線模式 - 操作將在連線後同步';
            display: block;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            padding: 8px 8px 8px 32px;
            background: #52525b;
            color: #f1f5f9;
            text-align: center;
            font-size: 0.875rem;
            font-weight: 500;
            z-index: 1000;
        }
        body.offline .header {
            margin-top: 36px;
        }
    </style>

    <!-- xIRS SDK v1.1 (Strangler Pattern Phase 1) -->
    <script src="/shared/sdk/xirs-config.js"></script>
    <script src="/shared/sdk/xirs-api.js"></script>
    <script src="/shared/sdk/xirs-bus.js"></script>
    <script src="/shared/sdk/xirs-offline.js"></script>
    <script src="/shared/sdk/xirs-ui.js"></script>
    <script src="/shared/sdk/index.js"></script>

    <script>
        // State
        let currentCase = null;
        let actorId = 'ANES001'; // TODO: Get from auth
        let isOnline = navigator.onLine;
        let syncQueue = [];
        let deviceId = localStorage.getItem('deviceId') || generateDeviceId();

        const API_BASE = '/api/anesthesia';

        // =================================================================
        // v1.6.1: Time Offset Helper Functions
        // =================================================================

        // Track selected time offset per modal (vitals, med, etc.)
        const timeOffsetState = {
            vitals: { offset: 0, customTime: null },
            med: { offset: 0, customTime: null }
        };

        function selectTimeOffset(btn, modalType) {
            const container = btn.closest('.time-offset-selector');
            const buttons = container.querySelectorAll('.time-offset-btn');
            const customDiv = document.getElementById(`${modalType}TimeCustom`);
            const lateEntryDiv = document.getElementById(`${modalType}LateEntry`);

            // Update active button
            buttons.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            const offset = btn.dataset.offset;

            if (offset === 'custom') {
                customDiv.classList.add('show');
                timeOffsetState[modalType].offset = null;
                // Set default to now
                const now = new Date();
                now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
                document.getElementById(`${modalType}CustomTime`).value = now.toISOString().slice(0, 16);
                updateComputedTime(modalType);
            } else {
                customDiv.classList.remove('show');
                timeOffsetState[modalType].offset = parseInt(offset);
                timeOffsetState[modalType].customTime = null;

                // Show late entry if > 5 min (300 sec)
                if (Math.abs(parseInt(offset)) > 300) {
                    lateEntryDiv.classList.add('show');
                } else {
                    lateEntryDiv.classList.remove('show');
                }

                updateComputedTime(modalType);
            }
        }

        function updateComputedTime(modalType) {
            const displayEl = document.getElementById(`${modalType}ComputedTime`);
            const lateEntryDiv = document.getElementById(`${modalType}LateEntry`);
            const customInput = document.getElementById(`${modalType}CustomTime`);

            let computedTime;
            let offsetSeconds = 0;

            if (customInput && customInput.value && timeOffsetState[modalType].offset === null) {
                computedTime = new Date(customInput.value);
                timeOffsetState[modalType].customTime = computedTime.toISOString();
                offsetSeconds = Math.floor((computedTime - new Date()) / 1000);
            } else {
                offsetSeconds = timeOffsetState[modalType].offset || 0;
                computedTime = new Date(Date.now() + offsetSeconds * 1000);
            }

            const timeStr = computedTime.toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' });
            displayEl.textContent = `記錄時間: ${timeStr}`;

            // Show late entry if > 5 min ago
            if (Math.abs(offsetSeconds) > 300) {
                lateEntryDiv.classList.add('show');
            } else {
                lateEntryDiv.classList.remove('show');
            }
        }

        function getTimeOffsetData(modalType) {
            const state = timeOffsetState[modalType];
            const lateEntryDiv = document.getElementById(`${modalType}LateEntry`);
            const result = {};

            if (state.customTime) {
                result.clinical_time = state.customTime;
            } else if (state.offset && state.offset !== 0) {
                result.clinical_time_offset_seconds = state.offset;
            }

            // If late entry is shown, include reason
            if (lateEntryDiv && lateEntryDiv.classList.contains('show')) {
                const reasonEl = document.getElementById(`${modalType}LateReason`);
                const noteEl = document.getElementById(`${modalType}LateNote`);
                if (reasonEl) result.late_entry_reason = reasonEl.value;
                if (noteEl && noteEl.value) result.late_entry_note = noteEl.value;
            }

            return result;
        }

        function resetTimeSelector(modalType) {
            const container = document.getElementById(`${modalType}TimeSelector`);
            if (!container) return;

            const buttons = container.querySelectorAll('.time-offset-btn');
            buttons.forEach(b => {
                b.classList.toggle('active', b.dataset.offset === '0');
            });

            const customDiv = document.getElementById(`${modalType}TimeCustom`);
            const lateEntryDiv = document.getElementById(`${modalType}LateEntry`);

            if (customDiv) customDiv.classList.remove('show');
            if (lateEntryDiv) lateEntryDiv.classList.remove('show');

            timeOffsetState[modalType] = { offset: 0, customTime: null };

            const displayEl = document.getElementById(`${modalType}ComputedTime`);
            if (displayEl) displayEl.textContent = '記錄時間: 現在';
        }

        // =================================================================
        // Phase A-6: WAL Offline Queue
        // =================================================================

        function generateDeviceId() {
            const id = 'DEV-' + Date.now().toString(36) + '-' + Math.random().toString(36).substr(2, 6);
            localStorage.setItem('deviceId', id);
            return id;
        }

        function generateIdempotencyKey(caseId, action) {
            return `${caseId}:${deviceId}:${Date.now()}:${action}`;
        }

        // Load queue from localStorage
        function loadSyncQueue() {
            try {
                const stored = localStorage.getItem('anesOfflineQueue');
                syncQueue = stored ? JSON.parse(stored) : [];
                updateSyncBadge();
            } catch (e) {
                syncQueue = [];
            }
        }

        // Save queue to localStorage
        function saveSyncQueue() {
            localStorage.setItem('anesOfflineQueue', JSON.stringify(syncQueue));
            updateSyncBadge();
        }

        // Add to offline queue
        function queueOfflineAction(endpoint, operation, payload) {
            const item = {
                id: 'Q-' + Date.now(),
                device_id: deviceId,
                operation: operation,
                endpoint: endpoint,
                payload: payload,
                idempotency_key: generateIdempotencyKey(currentCase?.id || 'new', endpoint),
                created_at: new Date().toISOString()
            };
            syncQueue.push(item);
            saveSyncQueue();
            console.log('[Offline] Queued:', item.endpoint);
            return item;
        }

        // Update sync badge
        function updateSyncBadge() {
            const badge = document.getElementById('syncBadge');
            if (badge) {
                if (syncQueue.length > 0) {
                    badge.textContent = syncQueue.length;
                    badge.classList.remove('hidden');
                } else {
                    badge.classList.add('hidden');
                }
            }
        }

        // Sync with server
        async function syncWithServer() {
            if (!isOnline || syncQueue.length === 0) return;

            console.log('[Sync] Starting sync of', syncQueue.length, 'items');
            const indicator = document.getElementById('syncIndicator');
            if (indicator) indicator.classList.add('syncing');

            try {
                const res = await apiFetch(`${API_BASE}/sync/batch`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        device_id: deviceId,
                        items: syncQueue
                    })
                });

                if (res.ok) {
                    const data = await res.json();
                    console.log('[Sync] Results:', data);

                    // Remove synced items
                    const syncedIds = data.results
                        .filter(r => r.status === 'synced' || r.status === 'duplicate')
                        .map(r => r.id);
                    syncQueue = syncQueue.filter(item => !syncedIds.includes(item.id));
                    saveSyncQueue();

                    // Reload timeline if we're viewing a case
                    if (currentCase) {
                        loadTimeline(currentCase.id);
                    }
                }
            } catch (e) {
                console.error('[Sync] Failed:', e);
            } finally {
                if (indicator) indicator.classList.remove('syncing');
            }
        }

        // Network status listeners
        window.addEventListener('online', () => {
            isOnline = true;
            console.log('[Network] Online - syncing...');
            document.body.classList.remove('offline');
            syncWithServer();
        });

        window.addEventListener('offline', () => {
            isOnline = false;
            console.log('[Network] Offline');
            document.body.classList.add('offline');
        });

        // Wrapped fetch for offline support
        // Phase 2: Helper function that uses xIRS.API
        async function apiFetch(url, options = {}) {
            const method = options.method || 'GET';
            const body = options.body ? JSON.parse(options.body) : null;

            let result;
            if (method === 'GET') {
                result = await xIRS.API.get(url);
            } else if (method === 'POST') {
                result = await xIRS.API.post(url, body);
            } else if (method === 'PUT') {
                result = await xIRS.API.put(url, body);
            } else if (method === 'DELETE') {
                result = await xIRS.API.delete(url);
            } else {
                result = await xIRS.API.request(url, { method, body });
            }

            // Return in fetch-compatible format for backwards compatibility
            return {
                ok: result.ok,
                status: result.status,
                json: () => Promise.resolve(result.data)
            };
        }

        async function offlineFetch(url, options = {}) {
            if (!isOnline) {
                // Queue the request for later
                const endpoint = url.replace(API_BASE, '');
                const operation = options.method || 'GET';

                if (operation !== 'GET') {
                    const payload = options.body ? JSON.parse(options.body) : {};
                    queueOfflineAction(endpoint, operation, payload);
                    return { ok: true, offline: true, json: () => Promise.resolve({ queued: true }) };
                } else {
                    throw new Error('Offline - cannot fetch data');
                }
            }

            // Phase 2: Use xIRS.API instead of fetch
            return apiFetch(url, options);
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadSyncQueue();
            loadCases();

            // Periodic sync attempt
            setInterval(() => {
                if (isOnline && syncQueue.length > 0) {
                    syncWithServer();
                }
            }, 30000); // Every 30 seconds
        });

        // Modal Functions
        function showNewCaseModal() {
            document.getElementById('newCaseModal').classList.add('active');
            // Reset CIRS selection
            document.getElementById('cirsRegistrationRef').value = '';
            document.getElementById('patientSnapshot').value = '';
            document.getElementById('newPatientId').value = '';
            document.getElementById('newPatientName').value = '';
            // Load CIRS waiting list
            loadCirsWaitingList();
        }

        async function loadCirsWaitingList() {
            const statusEl = document.getElementById('cirsStatus');
            const listEl = document.getElementById('cirsPatientList');

            statusEl.textContent = '檢查中...';
            statusEl.style.color = 'var(--text-secondary)';

            try {
                // v1.1: 使用新的 waiting-anesthesia 端點
                // 只顯示醫師看診後勾選「需麻醉」的病患
                const res = await apiFetch(`${API_BASE}/proxy/cirs/waiting-anesthesia`);
                const data = await res.json();

                if (data.online && data.patients.length > 0) {
                    statusEl.innerHTML = `<span style="display:inline-block;width:8px;height:8px;background:#10b981;border-radius:50%;margin-right:4px;"></span>連線 (${data.count} 位待麻醉)`;
                    statusEl.style.color = '#10b981';

                    listEl.innerHTML = data.patients.map(p => `
                        <div class="cirs-patient-item" onclick="selectCirsPatient('${p.registration_id}', '${p.patient_id || ''}', '${p.name || ''}', ${JSON.stringify(p).replace(/"/g, '&quot;')})"
                             style="padding: 10px; margin-bottom: 6px; background: var(--bg-secondary); border-radius: 6px; cursor: pointer; border: 2px solid transparent; transition: all 0.2s;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <span style="font-weight: 500;">${p.name || p.patient_ref || '未知'}</span>
                                    <span style="color: var(--text-secondary); margin-left: 8px; font-size: 13px;">${p.patient_id || ''}</span>
                                </div>
                                <div style="display: flex; gap: 6px; align-items: center;">
                                    ${p.waiting_minutes ? `<span style="font-size: 11px; color: var(--text-secondary);">等待 ${p.waiting_minutes} 分</span>` : ''}
                                    <span style="font-size: 12px; padding: 2px 8px; background: ${getTriageColor(p.triage_category)}; border-radius: 4px;">${getPriorityLabel(p.priority) || p.triage_category || '待麻醉'}</span>
                                </div>
                            </div>
                            <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">
                                ${p.chief_complaint ? `<div>${p.chief_complaint}</div>` : ''}
                                ${p.anesthesia_notes ? `<div style="color: var(--primary);">[備註] ${p.anesthesia_notes}</div>` : ''}
                                ${p.consultation_by ? `<div>[診] ${p.consultation_by}</div>` : ''}
                            </div>
                            ${p.claimed_by ? `<div style="font-size: 11px; color: #f59e0b; margin-top: 4px;">[!] 已被 ${p.claimed_by} 接手</div>` : ''}
                        </div>
                    `).join('');
                } else if (data.online && data.patients.length === 0) {
                    statusEl.innerHTML = '<span style="display:inline-block;width:8px;height:8px;background:#10b981;border-radius:50%;margin-right:4px;"></span>連線 (無待麻醉)';
                    statusEl.style.color = '#10b981';
                    listEl.innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 16px;">目前無待麻醉病患<br><small>醫師完成看診並勾選「需麻醉」後，病患會出現在此</small></div>';
                } else {
                    statusEl.innerHTML = '<span style="display:inline-block;width:8px;height:8px;background:#ef4444;border-radius:50%;margin-right:4px;"></span>離線';
                    statusEl.style.color = '#f59e0b';
                    listEl.innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 16px;">CIRS 未連線，請手動輸入或掃描傷票</div>';
                }
            } catch (err) {
                console.error('Failed to load CIRS waiting list:', err);
                statusEl.innerHTML = '<span style="display:inline-block;width:8px;height:8px;background:#ef4444;border-radius:50%;margin-right:4px;"></span>離線';
                statusEl.style.color = '#ef4444';
                listEl.innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 16px;">CIRS 未連線，請手動輸入或掃描傷票</div>';
            }
        }

        function getPriorityLabel(priority) {
            const labels = {
                'STAT': '急',
                'URGENT': '緊',
                'ROUTINE': '常'
            };
            return labels[priority] || '';
        }

        function getTriageColor(category) {
            const colors = {
                'immediate': '#ef4444',
                'urgent': '#f59e0b',
                'delayed': '#10b981',
                'minor': '#3b82f6',
                'deceased': '#6b7280'
            };
            return colors[category?.toLowerCase()] || 'var(--bg-tertiary)';
        }

        function selectCirsPatient(registrationId, patientId, name, patientData) {
            // Parse patient data if it's a string
            const patient = typeof patientData === 'string' ? JSON.parse(patientData) : patientData;

            // Fill in form fields
            document.getElementById('newPatientId').value = patientId || registrationId;
            document.getElementById('newPatientName').value = name || '';
            document.getElementById('cirsRegistrationRef').value = registrationId;

            // Store patient snapshot
            const snapshot = {
                name: patient.name,
                dob: patient.dob,
                sex: patient.sex,
                allergies: patient.allergies || [],
                weight_kg: patient.weight_kg,
                blood_type: patient.blood_type,
                triage_category: patient.triage_category,
                chief_complaint: patient.chief_complaint
            };
            document.getElementById('patientSnapshot').value = JSON.stringify(snapshot);

            // Visual feedback - highlight selected item
            document.querySelectorAll('.cirs-patient-item').forEach(el => {
                el.style.borderColor = 'transparent';
            });
            event.currentTarget.style.borderColor = 'var(--primary)';
        }

        function showVitalsModal() {
            document.getElementById('vitalsModal').classList.add('active');
        }

        function showMedModal() {
            document.getElementById('medModal').classList.add('active');
        }

        function closeModal(id) {
            document.getElementById(id).classList.remove('active');
        }

        // API Functions
        async function loadCases() {
            try {
                const today = new Date().toISOString().split('T')[0];
                const res = await apiFetch(`${API_BASE}/cases?date=${today}&limit=20`);
                const data = await res.json();

                const listEl = document.getElementById('caseList');

                // v1.1: Filter out CLOSED cases from main list
                const activeCases = data.cases.filter(c => c.status !== 'CLOSED');

                if (activeCases.length === 0) {
                    listEl.innerHTML = `
                        <div class="empty-state">
                            <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width:64px;height:64px;opacity:0.5;">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
                            </svg>
                            <p>今日尚無案例</p>
                        </div>
                    `;
                    return;
                }

                listEl.innerHTML = activeCases.map(c => `
                    <div class="case-list-item" onclick="selectCase('${c.id}')">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div class="case-id">${c.id}</div>
                                <div style="font-weight: 600;">${c.patient_name || c.patient_id}</div>
                            </div>
                            <span class="case-status ${c.status.toLowerCase()}">${c.status}</span>
                        </div>
                    </div>
                `).join('');

                // Auto-select if there's an in-progress case
                const inProgress = activeCases.find(c => c.status === 'IN_PROGRESS');
                if (inProgress) {
                    selectCase(inProgress.id);
                }
            } catch (err) {
                console.error('Failed to load cases:', err);
            }
        }

        async function selectCase(caseId) {
            try {
                const res = await apiFetch(`${API_BASE}/cases/${caseId}`);
                currentCase = await res.json();

                // Update UI
                document.getElementById('noCaseView').classList.add('hidden');
                document.getElementById('activeCaseView').classList.remove('hidden');
                document.getElementById('resourceBar').classList.remove('hidden');

                document.getElementById('caseId').textContent = currentCase.id;
                document.getElementById('patientName').textContent = currentCase.patient_name || currentCase.patient_id;
                document.getElementById('caseStatus').textContent = currentCase.status;
                document.getElementById('caseStatus').className = `case-status ${currentCase.status.toLowerCase()}`;
                document.getElementById('techniqueInfo').textContent = currentCase.planned_technique || '';

                if (currentCase.context_mode === 'BATTLEFIELD') {
                    document.getElementById('contextBadge').classList.remove('hidden');
                }

                // Load timeline
                loadTimeline(caseId);

                // Load O2 status
                loadO2Status(caseId);

            } catch (err) {
                console.error('Failed to load case:', err);
            }
        }

        async function loadTimeline(caseId) {
            try {
                const res = await apiFetch(`${API_BASE}/cases/${caseId}/timeline`);
                const data = await res.json();

                const timelineEl = document.getElementById('timeline');

                if (data.all.length === 0) {
                    timelineEl.innerHTML = `<div class="empty-state"><p>尚無事件</p></div>`;
                    return;
                }

                // Sort by clinical_time desc
                const events = data.all.sort((a, b) =>
                    new Date(b.clinical_time) - new Date(a.clinical_time)
                );

                timelineEl.innerHTML = events.slice(0, 20).map(e => {
                    const time = new Date(e.clinical_time).toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' });
                    const dotClass = e.event_type === 'VITAL_SIGN' ? 'vital' :
                                    e.event_type === 'MEDICATION_ADMIN' ? 'med' :
                                    e.event_type === 'MILESTONE' ? 'milestone' : '';

                    let desc = '';
                    if (e.event_type === 'VITAL_SIGN') {
                        const p = e.payload;
                        desc = `BP ${p.bp_sys || '--'}/${p.bp_dia || '--'}, HR ${p.hr || '--'}, SpO2 ${p.spo2 || '--'}%`;
                    } else if (e.event_type === 'MEDICATION_ADMIN') {
                        desc = `${e.payload.drug_name} ${e.payload.dose}${e.payload.unit} ${e.payload.route}`;
                    } else if (e.event_type === 'MILESTONE') {
                        desc = e.payload.type;
                    } else {
                        desc = JSON.stringify(e.payload).substring(0, 50);
                    }

                    return `
                        <div class="timeline-item">
                            <div class="timeline-time">${time}</div>
                            <div class="timeline-dot ${dotClass}"></div>
                            <div class="timeline-content">
                                <div class="timeline-type">${e.event_type}</div>
                                <div class="timeline-desc">${desc}</div>
                            </div>
                        </div>
                    `;
                }).join('');

                // Update last values in resource bar
                const lastVital = data.vitals[data.vitals.length - 1];
                if (lastVital) {
                    document.getElementById('lastSpo2').textContent = lastVital.payload.spo2 || '--';
                    document.getElementById('lastHr').textContent = lastVital.payload.hr || '--';
                    document.getElementById('lastBp').textContent =
                        `${lastVital.payload.bp_sys || '--'}/${lastVital.payload.bp_dia || '--'}`;
                }

            } catch (err) {
                console.error('Failed to load timeline:', err);
            }
        }

        // =================================================================
        // Phase C: Oxygen Cylinder Management
        // =================================================================
        let currentO2Status = null;

        async function loadO2Status(caseId) {
            try {
                const res = await apiFetch(`${API_BASE}/cases/${caseId}/oxygen-status`);
                const data = await res.json();
                currentO2Status = data;

                const statusEl = document.getElementById('o2Status');
                const unitEl = document.getElementById('o2Unit');

                if (data.source_type === 'CYLINDER' && data.cylinder_serial) {
                    // Cylinder claimed
                    statusEl.textContent = data.est_minutes_remaining || '--';
                    unitEl.textContent = 'min';

                    // Apply warning/danger classes
                    statusEl.classList.remove('warning', 'danger');
                    if (data.est_minutes_remaining && data.est_minutes_remaining < 30) {
                        statusEl.classList.add('danger');
                    } else if (data.est_minutes_remaining && data.est_minutes_remaining < 60) {
                        statusEl.classList.add('warning');
                    }
                } else {
                    // No cylinder claimed
                    statusEl.textContent = '未認領';
                    unitEl.textContent = '';
                    statusEl.classList.remove('warning', 'danger');
                }
            } catch (err) {
                console.error('Failed to load O2 status:', err);
                document.getElementById('o2Status').textContent = '--';
            }
        }

        async function showO2Modal() {
            if (!currentCase) {
                alert('請先選擇案例');
                return;
            }

            document.getElementById('o2Modal').classList.add('active');

            // Load current status
            await loadO2Status(currentCase.id);
            updateO2ModalStatus();

            // Load available cylinders
            await loadAvailableCylinders();
        }

        function updateO2ModalStatus() {
            const claimStatusEl = document.getElementById('o2ClaimStatus');
            const claimedInfoEl = document.getElementById('o2ClaimedInfo');
            const releaseBtn = document.getElementById('o2ReleaseBtn');
            const availableSection = document.getElementById('o2AvailableSection');

            if (currentO2Status && currentO2Status.source_type === 'CYLINDER' && currentO2Status.cylinder_serial) {
                // Cylinder is claimed
                claimStatusEl.textContent = '已認領';
                claimStatusEl.classList.remove('reconciled');
                claimStatusEl.classList.add('pending');
                claimedInfoEl.classList.remove('hidden');
                releaseBtn.classList.remove('hidden');
                availableSection.classList.add('hidden');

                document.getElementById('o2CylinderSerial').textContent = currentO2Status.cylinder_serial;
                document.getElementById('o2LevelPercent').textContent = `${currentO2Status.level_percent || '--'}%`;
                document.getElementById('o2EstTime').textContent = `${currentO2Status.est_minutes_remaining || '--'} min`;
                document.getElementById('o2FlowRate').textContent = `${currentO2Status.avg_flow_lpm || '--'} L/min`;
            } else {
                // No cylinder claimed
                claimStatusEl.textContent = '未認領';
                claimStatusEl.classList.add('reconciled');
                claimStatusEl.classList.remove('pending');
                claimedInfoEl.classList.add('hidden');
                releaseBtn.classList.add('hidden');
                availableSection.classList.remove('hidden');
            }
        }

        async function loadAvailableCylinders() {
            const listEl = document.getElementById('o2CylinderList');
            listEl.innerHTML = '<div class="empty-state" style="padding: 24px; text-align: center;"><p style="color: var(--text-muted);">載入中...</p></div>';

            try {
                // Load E-size cylinders
                // Phase 2: Use apiFetch instead of fetch
                const eRes = await apiFetch('/api/v2/equipment/EMER-EQ-006/units');
                const eData = await eRes.json();

                // Load H-size cylinders
                // Phase 2: Use apiFetch instead of fetch
                const hRes = await apiFetch('/api/v2/equipment/RESP-001/units');
                const hData = await hRes.json();

                const allUnits = [
                    ...(eData.units || []).map(u => ({ ...u, type: 'E型' })),
                    ...(hData.units || []).map(u => ({ ...u, type: 'H型' }))
                ];

                if (allUnits.length === 0) {
                    listEl.innerHTML = '<div class="empty-state" style="padding: 24px; text-align: center;"><p style="color: var(--text-muted);">無可用氧氣瓶</p></div>';
                    return;
                }

                listEl.innerHTML = allUnits.map(unit => {
                    const isClaimed = unit.claimed_by_case_id && unit.claimed_by_case_id !== currentCase?.id;
                    const isMyself = unit.claimed_by_case_id === currentCase?.id;
                    const levelClass = unit.level_percent < 30 ? 'critical' : (unit.level_percent < 60 ? 'low' : '');

                    return `
                        <div class="o2-cylinder-item ${isClaimed ? 'claimed' : ''}"
                             onclick="${isClaimed ? '' : `claimO2Cylinder(${unit.id})`}"
                             style="${isMyself ? 'border-left-color: var(--primary); background: var(--card-hover);' : ''}">
                            <div class="o2-cylinder-info">
                                <span class="o2-cylinder-serial">${unit.unit_label} (${unit.type})</span>
                                <span class="o2-cylinder-level">${unit.level_percent}% ${isClaimed ? '- 使用中' : (isMyself ? '- 目前使用' : '')}</span>
                            </div>
                            <div class="o2-level-bar">
                                <div class="o2-level-fill ${levelClass}" style="width: ${unit.level_percent}%"></div>
                            </div>
                        </div>
                    `;
                }).join('');

            } catch (err) {
                console.error('Failed to load cylinders:', err);
                listEl.innerHTML = '<div class="empty-state" style="padding: 24px; text-align: center;"><p style="color: var(--text-muted);">載入失敗</p></div>';
            }
        }

        async function claimO2Cylinder(unitId) {
            if (!currentCase) return;

            try {
                const res = await apiFetch(`${API_BASE}/cases/${currentCase.id}/claim-oxygen?actor_id=${actorId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ cylinder_unit_id: unitId })
                });

                if (!res.ok) {
                    const err = await res.json();
                    alert(err.detail || '認領失敗');
                    return;
                }

                const data = await res.json();
                alert(`已認領氧氣瓶: ${data.cylinder_serial} (${data.level_percent}%)`);

                // Reload status
                await loadO2Status(currentCase.id);
                updateO2ModalStatus();
                await loadAvailableCylinders();

            } catch (err) {
                console.error('Failed to claim cylinder:', err);
                alert('認領失敗: ' + err.message);
            }
        }

        async function releaseO2Cylinder() {
            if (!currentCase) return;

            if (!confirm('確定要釋放氧氣瓶嗎？')) return;

            try {
                const res = await apiFetch(`${API_BASE}/cases/${currentCase.id}/claim-oxygen?actor_id=${actorId}`, {
                    method: 'DELETE'
                });

                if (!res.ok) {
                    const err = await res.json();
                    alert(err.detail || '釋放失敗');
                    return;
                }

                // Clear status
                currentO2Status = null;
                await loadO2Status(currentCase.id);
                updateO2ModalStatus();
                await loadAvailableCylinders();

            } catch (err) {
                console.error('Failed to release cylinder:', err);
                alert('釋放失敗: ' + err.message);
            }
        }

        async function createCase(event) {
            event.preventDefault();

            // Get CIRS reference and patient snapshot if available
            const cirsRef = document.getElementById('cirsRegistrationRef').value;
            const snapshotJson = document.getElementById('patientSnapshot').value;
            let patientSnapshot = null;
            if (snapshotJson) {
                try {
                    patientSnapshot = JSON.parse(snapshotJson);
                } catch (e) {
                    console.warn('Failed to parse patient snapshot:', e);
                }
            }

            const body = {
                patient_id: document.getElementById('newPatientId').value,
                patient_name: document.getElementById('newPatientName').value || null,
                planned_technique: document.getElementById('newTechnique').value,
                context_mode: document.getElementById('newContextMode').value,
                cirs_registration_ref: cirsRef || null,
                patient_snapshot: patientSnapshot
            };

            try {
                const res = await apiFetch(`${API_BASE}/cases?actor_id=${actorId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });

                if (!res.ok) throw new Error('Failed to create case');

                const newCase = await res.json();
                closeModal('newCaseModal');
                selectCase(newCase.id);
            } catch (err) {
                alert('建立失敗: ' + err.message);
            }
        }

        async function submitVitals(event) {
            event.preventDefault();

            if (!currentCase) return;

            const body = {
                bp_sys: parseInt(document.getElementById('vBpSys').value) || null,
                bp_dia: parseInt(document.getElementById('vBpDia').value) || null,
                hr: parseInt(document.getElementById('vHr').value) || null,
                spo2: parseInt(document.getElementById('vSpo2').value) || null,
                etco2: parseInt(document.getElementById('vEtco2').value) || null,
                o2_flow_lpm: parseFloat(document.getElementById('vO2Flow').value) || null
            };

            // v1.6.1: Add time offset support
            const timeData = getTimeOffsetData('vitals');
            if (timeData.clinical_time) {
                body.clinical_time = timeData.clinical_time;
            }
            if (timeData.clinical_time_offset_seconds) {
                body.clinical_time_offset_seconds = timeData.clinical_time_offset_seconds;
            }
            if (timeData.late_entry_reason) {
                body.late_entry_reason = timeData.late_entry_reason;
                body.late_entry_note = timeData.late_entry_note;
            }

            try {
                const res = await apiFetch(`${API_BASE}/cases/${currentCase.id}/vitals?actor_id=${actorId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });

                if (res.status === 404) {
                    handleCaseNotFound();
                    return;
                }
                if (!res.ok) throw new Error('Failed');

                closeModal('vitalsModal');
                loadTimeline(currentCase.id);

                // Clear form
                ['vBpSys', 'vBpDia', 'vHr', 'vSpo2', 'vEtco2', 'vO2Flow'].forEach(id => {
                    document.getElementById(id).value = '';
                });
                // Reset time selector
                resetTimeSelector('vitals');
            } catch (err) {
                alert('記錄失敗');
            }
        }

        // =================================================================
        // Medication Selection with Dose Adjustment
        // =================================================================
        let selectedMed = null;

        function selectMed(code, name, defaultDose, unit, isControlled) {
            if (!currentCase) {
                alert('請先選擇或建立案例');
                return;
            }

            selectedMed = { code, name, defaultDose, unit, isControlled };

            // Update UI
            document.getElementById('selectedDrugName').textContent = name;
            document.getElementById('selectedDose').value = defaultDose;
            document.getElementById('selectedUnit').textContent = unit;
            document.getElementById('selectedRoute').value = 'IV';

            // Show controlled tag if applicable
            const tagEl = document.getElementById('selectedDrugTag');
            if (isControlled) {
                tagEl.textContent = '管制藥品';
                tagEl.className = 'selected-drug-tag controlled';
                document.getElementById('selectedDrugName').style.color = 'var(--controlled)';
            } else {
                tagEl.textContent = '';
                tagEl.className = 'selected-drug-tag';
                document.getElementById('selectedDrugName').style.color = 'var(--text)';
            }

            // Switch views
            document.getElementById('medSelectView').classList.add('hidden');
            document.getElementById('medConfirmView').classList.remove('hidden');
        }

        function adjustDose(delta) {
            const input = document.getElementById('selectedDose');
            let current = parseFloat(input.value) || 0;
            current = Math.max(0, current + delta);
            // Round to 1 decimal
            input.value = Math.round(current * 10) / 10;
        }

        function backToMedSelect() {
            document.getElementById('medSelectView').classList.remove('hidden');
            document.getElementById('medConfirmView').classList.add('hidden');
            selectedMed = null;
        }

        async function confirmMed() {
            if (!currentCase || !selectedMed) return;

            const dose = parseFloat(document.getElementById('selectedDose').value);
            if (!dose || dose <= 0) {
                alert('請輸入有效劑量');
                return;
            }

            const route = document.getElementById('selectedRoute').value;

            const body = {
                drug_code: selectedMed.code,
                drug_name: selectedMed.name,
                dose: dose,
                unit: selectedMed.unit,
                route: route,
                is_controlled: selectedMed.isControlled
            };

            // v1.6.1: Add time offset support
            const timeData = getTimeOffsetData('med');
            if (timeData.clinical_time) {
                body.clinical_time = timeData.clinical_time;
            }
            if (timeData.clinical_time_offset_seconds) {
                body.clinical_time_offset_seconds = timeData.clinical_time_offset_seconds;
            }
            if (timeData.late_entry_reason) {
                body.late_entry_reason = timeData.late_entry_reason;
                body.late_entry_note = timeData.late_entry_note;
            }

            try {
                const res = await apiFetch(`${API_BASE}/cases/${currentCase.id}/medication?actor_id=${actorId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });

                if (!res.ok) throw new Error('Failed');

                closeModal('medModal');
                backToMedSelect(); // Reset view for next time
                resetTimeSelector('med'); // Reset time selector
                loadTimeline(currentCase.id);
            } catch (err) {
                alert('記錄失敗');
            }
        }

        // Legacy function for custom med form
        async function quickMed(code, name, dose, unit) {
            if (!currentCase) return;

            const body = {
                drug_code: code,
                drug_name: name,
                dose: dose,
                unit: unit,
                route: 'IV'
            };

            try {
                const res = await apiFetch(`${API_BASE}/cases/${currentCase.id}/medication?actor_id=${actorId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });

                if (!res.ok) throw new Error('Failed');

                closeModal('medModal');
                loadTimeline(currentCase.id);
            } catch (err) {
                alert('記錄失敗');
            }
        }

        async function addMilestone(type) {
            if (!currentCase) return;

            try {
                const res = await apiFetch(
                    `${API_BASE}/cases/${currentCase.id}/milestone?milestone_type=${type}&actor_id=${actorId}`,
                    { method: 'POST' }
                );

                if (res.status === 404) {
                    handleCaseNotFound();
                    return;
                }
                if (!res.ok) throw new Error('Failed');

                // Reload case to get updated status
                selectCase(currentCase.id);
            } catch (err) {
                alert('記錄失敗');
            }
        }

        // Handle case not found (e.g., after database reset)
        function handleCaseNotFound() {
            alert('案例不存在或已被重置，請重新建立案例。');
            currentCase = null;
            document.getElementById('activeCaseView').classList.add('hidden');
            document.getElementById('noCaseView').classList.remove('hidden');
            document.getElementById('resourceBar').classList.add('hidden');
            // Close any open modals
            document.querySelectorAll('.modal.active').forEach(m => m.classList.remove('active'));
            loadCases();
        }

        function switchTab(tab) {
            // Update nav items
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            event.target.closest('.nav-item').classList.add('active');

            if (tab === 'case') {
                // Go back to case list
                currentCase = null;
                document.getElementById('activeCaseView').classList.add('hidden');
                document.getElementById('noCaseView').classList.remove('hidden');
                document.getElementById('resourceBar').classList.add('hidden');
                loadCases();
            } else if (tab === 'preop') {
                if (!currentCase) {
                    alert('請先選擇或建立案例');
                    return;
                }
                // Load existing preop data if available
                loadPreopData(currentCase.id);
                openModal('preopModal');
            } else if (tab === 'drugs') {
                if (!currentCase) {
                    alert('請先選擇或建立案例');
                    return;
                }
                loadDrugHoldings();
                loadDrugTransactions();
                openModal('drugsModal');
            } else if (tab === 'o2') {
                showO2Modal();
            }
        }

        // =================================================================
        // Phase B: Controlled Drugs Functions
        // =================================================================

        let drugHoldings = [];
        let currentDrugTxType = 'ADMIN';

        // Controlled drug list for quick selection
        const CONTROLLED_DRUGS = [
            { code: 'FENT001', name: 'Fentanyl', unit: 'mcg', schedule_class: 2 },
            { code: 'MIDA001', name: 'Midazolam', unit: 'mg', schedule_class: 4 },
            { code: 'PROP001', name: 'Propofol', unit: 'mg', schedule_class: 4 },
            { code: 'KETA001', name: 'Ketamine', unit: 'mg', schedule_class: 3 },
            { code: 'MORP001', name: 'Morphine', unit: 'mg', schedule_class: 2 },
            { code: 'REMI001', name: 'Remifentanil', unit: 'mcg', schedule_class: 2 },
        ];

        async function loadDrugHoldings() {
            if (!currentCase) return;

            try {
                const res = await apiFetch(`${API_BASE}/cases/${currentCase.id}/drugs/holdings`);
                const data = await res.json();

                drugHoldings = data.holdings || [];
                const totalBalance = data.total_balance || 0;

                // Update status badge
                const statusEl = document.getElementById('holdingsStatus');
                if (totalBalance === 0) {
                    statusEl.textContent = '已結清';
                    statusEl.className = 'holdings-status reconciled';
                } else {
                    statusEl.textContent = `餘額: ${totalBalance}`;
                    statusEl.className = 'holdings-status pending';
                }

                // Update holdings list
                const listEl = document.getElementById('holdingsList');
                if (drugHoldings.length === 0) {
                    listEl.innerHTML = `<div style="color: var(--text-muted); text-align: center; padding: 12px;">尚無領藥記錄</div>`;
                } else {
                    listEl.innerHTML = drugHoldings.map(h => `
                        <div class="holding-item">
                            <div class="holding-drug-name">${h.drug_name}</div>
                            <div class="holding-balance ${h.balance === 0 ? 'zero' : ''}">${h.balance} ${h.unit}</div>
                        </div>
                    `).join('');
                }
            } catch (err) {
                console.error('Failed to load drug holdings:', err);
            }
        }

        async function loadDrugTransactions() {
            if (!currentCase) return;

            try {
                const res = await apiFetch(`${API_BASE}/cases/${currentCase.id}/drugs/transactions`);
                const data = await res.json();

                const historyEl = document.getElementById('drugTxHistory');
                if (!data.transactions || data.transactions.length === 0) {
                    historyEl.innerHTML = `<div class="empty-state" style="padding: 20px;"><p>尚無交易記錄</p></div>`;
                } else {
                    historyEl.innerHTML = data.transactions.map(tx => `
                        <div class="tx-item">
                            <span class="tx-type ${tx.tx_type}">${tx.tx_type}</span>
                            <div class="tx-info">
                                <div class="tx-drug">${tx.drug_name}</div>
                                <div class="tx-detail">${tx.tx_time?.substring(11, 16) || ''} · ${tx.actor_id}${tx.witness_id ? ' (見證: ' + tx.witness_id + ')' : ''}</div>
                            </div>
                            <div class="tx-amount">${tx.tx_type === 'DISPENSE' ? '+' : '-'}${tx.quantity} ${tx.unit}</div>
                        </div>
                    `).join('');
                }
            } catch (err) {
                console.error('Failed to load drug transactions:', err);
            }
        }

        function updateDrugSelect(includeAllDrugs = false) {
            const select = document.getElementById('drugTxDrugSelect');
            let options = '<option value="">選擇藥品...</option>';

            if (includeAllDrugs) {
                // For DISPENSE, show all controlled drugs
                CONTROLLED_DRUGS.forEach(d => {
                    options += `<option value="${d.code}" data-name="${d.name}" data-unit="${d.unit}" data-class="${d.schedule_class}">${d.name}</option>`;
                });
            } else {
                // For ADMIN/WASTE/RETURN, only show drugs with balance > 0
                drugHoldings.filter(h => h.balance > 0).forEach(h => {
                    options += `<option value="${h.drug_code}" data-name="${h.drug_name}" data-unit="${h.unit}" data-balance="${h.balance}">${h.drug_name} (餘 ${h.balance} ${h.unit})</option>`;
                });
            }

            select.innerHTML = options;
        }

        function showDrugDispenseForm() {
            currentDrugTxType = 'DISPENSE';
            document.getElementById('drugTxTitle').textContent = '領藥記錄';
            document.getElementById('drugTxWitnessGroup').classList.add('hidden');
            updateDrugSelect(true);
            document.getElementById('drugTxForm').classList.remove('hidden');
            document.getElementById('drugTxAvailable').textContent = '';
        }

        function showDrugAdminForm() {
            if (drugHoldings.filter(h => h.balance > 0).length === 0) {
                alert('目前無可用藥品，請先領藥');
                return;
            }
            currentDrugTxType = 'ADMIN';
            document.getElementById('drugTxTitle').textContent = '給藥記錄';
            document.getElementById('drugTxWitnessGroup').classList.add('hidden');
            updateDrugSelect(false);
            document.getElementById('drugTxForm').classList.remove('hidden');
        }

        function showDrugWasteForm() {
            if (drugHoldings.filter(h => h.balance > 0).length === 0) {
                alert('目前無可廢棄藥品');
                return;
            }
            currentDrugTxType = 'WASTE';
            document.getElementById('drugTxTitle').textContent = '廢棄記錄 (需見證人)';
            document.getElementById('drugTxWitnessGroup').classList.remove('hidden');
            updateDrugSelect(false);
            document.getElementById('drugTxForm').classList.remove('hidden');
        }

        function showDrugReturnForm() {
            if (drugHoldings.filter(h => h.balance > 0).length === 0) {
                alert('目前無可退回藥品');
                return;
            }
            currentDrugTxType = 'RETURN';
            document.getElementById('drugTxTitle').textContent = '退回藥品';
            document.getElementById('drugTxWitnessGroup').classList.add('hidden');
            updateDrugSelect(false);
            document.getElementById('drugTxForm').classList.remove('hidden');
        }

        function hideDrugTxForm() {
            document.getElementById('drugTxForm').classList.add('hidden');
            document.getElementById('drugTxQuantity').value = '';
            document.getElementById('drugTxWitness').value = '';
            document.getElementById('drugTxNotes').value = '';
        }

        // Update available balance when drug is selected
        document.addEventListener('DOMContentLoaded', () => {
            const drugSelect = document.getElementById('drugTxDrugSelect');
            if (drugSelect) {
                drugSelect.addEventListener('change', function() {
                    const option = this.options[this.selectedIndex];
                    const unit = option.dataset.unit || 'mg';
                    const balance = option.dataset.balance || '';
                    document.getElementById('drugTxUnit').textContent = unit;
                    if (balance && currentDrugTxType !== 'DISPENSE') {
                        document.getElementById('drugTxAvailable').textContent = `可用: ${balance} ${unit}`;
                    } else {
                        document.getElementById('drugTxAvailable').textContent = '';
                    }
                });
            }
        });

        async function submitDrugTx() {
            if (!currentCase) return;

            const drugSelect = document.getElementById('drugTxDrugSelect');
            const option = drugSelect.options[drugSelect.selectedIndex];

            if (!option.value) {
                alert('請選擇藥品');
                return;
            }

            const quantity = parseFloat(document.getElementById('drugTxQuantity').value);
            if (!quantity || quantity <= 0) {
                alert('請輸入有效劑量');
                return;
            }

            // Check witness for WASTE
            let witnessId = null;
            if (currentDrugTxType === 'WASTE') {
                witnessId = document.getElementById('drugTxWitness').value.trim();
                if (!witnessId) {
                    alert('廢棄管藥需要見證人 ID');
                    return;
                }
            }

            const body = {
                drug_code: option.value,
                drug_name: option.dataset.name || option.text.split(' (')[0],
                quantity: quantity,
                unit: option.dataset.unit || 'mg',
                tx_type: currentDrugTxType,
                schedule_class: parseInt(option.dataset.class) || 4,
                witness_id: witnessId,
                notes: document.getElementById('drugTxNotes').value.trim() || null
            };

            try {
                const res = await apiFetch(`${API_BASE}/cases/${currentCase.id}/drugs/transaction?actor_id=${actorId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });

                if (!res.ok) {
                    const err = await res.json();
                    throw new Error(err.detail || 'Transaction failed');
                }

                // Refresh data
                hideDrugTxForm();
                await loadDrugHoldings();
                await loadDrugTransactions();
            } catch (err) {
                alert('記錄失敗: ' + err.message);
            }
        }

        async function loadPreopData(caseId) {
            try {
                // Reset checkboxes first
                document.getElementById('flagAllergic').checked = false;
                document.getElementById('flagFullStomach').checked = false;
                document.getElementById('flagDifficultAirway').checked = false;
                document.getElementById('flagUnstable').checked = false;
                document.getElementById('flagHighRisk').checked = false;
                document.getElementById('preopQuickNote').value = '';

                const res = await apiFetch(`${API_BASE}/cases/${caseId}/battlefield-preop`);
                if (res.ok) {
                    const data = await res.json();
                    if (data.battlefield_preop) {
                        document.getElementById('flagAllergic').checked = data.battlefield_preop.is_allergic;
                        document.getElementById('flagFullStomach').checked = data.battlefield_preop.is_full_stomach;
                        document.getElementById('flagDifficultAirway').checked = data.battlefield_preop.is_difficult_airway;
                        document.getElementById('flagUnstable').checked = data.battlefield_preop.is_hemodynamically_unstable;
                        document.getElementById('flagHighRisk').checked = data.battlefield_preop.is_high_risk;
                        document.getElementById('preopQuickNote').value = data.battlefield_preop.quick_note || '';
                    }
                }
            } catch (err) {
                console.log('No preop data yet');
            }
        }

        async function savePreop() {
            if (!currentCase) return;

            const payload = {
                is_allergic: document.getElementById('flagAllergic').checked,
                is_full_stomach: document.getElementById('flagFullStomach').checked,
                is_difficult_airway: document.getElementById('flagDifficultAirway').checked,
                is_hemodynamically_unstable: document.getElementById('flagUnstable').checked,
                is_high_risk: document.getElementById('flagHighRisk').checked,
                quick_note: document.getElementById('preopQuickNote').value
            };

            try {
                const res = await apiFetch(`${API_BASE}/cases/${currentCase.id}/battlefield-preop?actor_id=${actorId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!res.ok) throw new Error('Failed');

                closeModal('preopModal');
                alert('術前評估已儲存');
            } catch (err) {
                alert('儲存失敗: ' + err.message);
            }
        }

        function showMilestoneMenu() {
            const milestones = [
                { label: '麻醉開始', value: 'ANESTHESIA_START' },
                { label: '插管 Intubation', value: 'INTUBATION', isAirway: true },
                { label: '手術開始', value: 'SURGERY_START' },
                { label: '手術結束', value: 'SURGERY_END' },
                { label: '拔管 Extubation', value: 'EXTUBATION', isAirway: true },
                { label: '麻醉結束', value: 'ANESTHESIA_END' }
            ];

            const choice = prompt(
                '選擇里程碑:\n\n' +
                milestones.map((m, i) => `${i + 1}. ${m.label}`).join('\n') +
                '\n\n請輸入編號:'
            );

            const idx = parseInt(choice) - 1;
            if (idx >= 0 && idx < milestones.length) {
                const m = milestones[idx];
                if (m.isAirway) {
                    addAirwayEvent(m.value);
                } else {
                    addMilestone(m.value);
                }
            }
        }

        function showMoreActions() {
            // Keep for backwards compatibility
            showMilestoneMenu();
        }

        async function addAirwayEvent(action) {
            if (!currentCase) return;

            const body = {
                event_type: 'AIRWAY_EVENT',
                payload: { action: action }
            };

            try {
                const res = await apiFetch(`${API_BASE}/cases/${currentCase.id}/events?actor_id=${actorId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });

                if (!res.ok) throw new Error('Failed');
                loadTimeline(currentCase.id);
            } catch (err) {
                alert('記錄失敗');
            }
        }

        async function closeCase() {
            if (!currentCase) return;
            if (!confirm('確定要關閉此案例?')) return;

            try {
                const res = await apiFetch(`${API_BASE}/cases/${currentCase.id}/close?actor_id=${actorId}`, {
                    method: 'POST'
                });

                if (!res.ok) throw new Error('Failed');

                currentCase = null;
                document.getElementById('activeCaseView').classList.add('hidden');
                document.getElementById('resourceBar').classList.add('hidden');
                document.getElementById('noCaseView').classList.remove('hidden');
                loadCases();
            } catch (err) {
                alert('關閉失敗: ' + err.message);
            }
        }

        function showCustomMedForm() {
            const code = prompt('藥物代碼:');
            const name = prompt('藥物名稱:');
            const dose = parseFloat(prompt('劑量:'));
            const unit = prompt('單位 (mg/mcg/ml):');

            if (code && name && dose && unit) {
                quickMed(code, name, dose, unit);
            }
        }
    </script>
</body>
</html>
