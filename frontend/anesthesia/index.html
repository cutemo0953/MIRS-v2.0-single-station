<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>麻醉站 - MIRS</title>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icons/icon-192.png">
    <style>
        :root {
            /* Primary: Indigo (original) */
            --primary: #6366f1;      /* indigo-500 */
            --primary-dark: #4f46e5; /* indigo-600 */
            /* Grayscale for status/alerts (replacing yellow/red) */
            --success: #71717a;      /* zinc-500 */
            --warning: #a1a1aa;      /* zinc-400 */
            --danger: #52525b;       /* zinc-600 */
            --bg: #0f172a;
            --card: #1e293b;
            --card-hover: #334155;
            --text: #f1f5f9;
            --text-muted: #94a3b8;
            --border: #334155;
            /* Controlled drug color - purple-pink */
            --controlled: #c026d3;   /* fuchsia-600 */
            --controlled-dark: #a21caf; /* fuchsia-700 */
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            padding: 16px;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-title {
            font-size: 1.25rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .header-subtitle {
            font-size: 0.875rem;
            opacity: 0.8;
            margin-top: 4px;
        }

        /* Resource Bar */
        .resource-bar {
            display: flex;
            gap: 16px;
            padding: 12px 16px;
            background: var(--card);
            border-bottom: 1px solid var(--border);
            overflow-x: auto;
        }

        .resource-item {
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
        }

        .resource-value {
            font-weight: 600;
            font-size: 1.1rem;
        }

        .resource-value.warning {
            color: var(--warning);
        }

        .resource-value.danger {
            color: var(--danger);
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Main Content */
        .main {
            padding: 16px;
            padding-bottom: 100px;
        }

        /* Case Info Card */
        .case-card {
            background: var(--card);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .case-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .case-id {
            font-size: 0.875rem;
            color: var(--primary);
            font-weight: 600;
        }

        .patient-name {
            font-size: 1.25rem;
            font-weight: 600;
            margin-top: 4px;
        }

        .case-status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .case-status.preop { background: #71717a; color: #fff; }
        .case-status.in_progress { background: #52525b; color: #fff; }
        .case-status.pacu { background: #64748b; color: #fff; }
        .case-status.closed { background: #3f3f46; color: #a1a1aa; }
        /* v1.1: Case tags for technique and ASA */
        .case-tag {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }
        .case-tag.technique {
            background: rgba(59, 130, 246, 0.15);
            color: #60a5fa;
            border: 1px solid rgba(59, 130, 246, 0.3);
        }
        .case-tag.asa {
            background: rgba(251, 191, 36, 0.15);
            color: #fbbf24;
            border: 1px solid rgba(251, 191, 36, 0.3);
        }
        .case-tag.asa.emergency {
            background: rgba(239, 68, 68, 0.15);
            color: #f87171;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }
        .case-tag:hover {
            filter: brightness(1.1);
        }

        /* Quick Actions */
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 16px;
        }

        .quick-btn {
            background: var(--card);
            border: 2px solid var(--border);
            border-radius: 10px;
            padding: 12px 8px;
            color: var(--text);
            font-size: 0.8rem;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            transition: all 0.2s;
        }

        .quick-btn .icon {
            width: 20px !important;
            height: 20px !important;
        }

        .quick-btn:active {
            transform: scale(0.95);
            background: var(--card-hover);
        }

        .quick-btn.primary {
            background: var(--primary);
            border-color: var(--primary);
        }

        .quick-btn.success {
            background: var(--success);
            border-color: var(--success);
        }

        .quick-btn.warning {
            background: var(--warning);
            border-color: var(--warning);
            color: #000;
        }

        .quick-btn.controlled {
            background: var(--controlled);
            border-color: var(--controlled);
        }

        .quick-btn.controlled:active {
            background: var(--controlled-dark);
        }

        .quick-btn.blood {
            background: #b91c1c;
            border-color: #b91c1c;
        }

        .quick-btn.blood:active {
            background: #991b1b;
        }
        .quick-btn.vasoactive {
            background: #7c3aed;
            border-color: #7c3aed;
        }
        .quick-btn.vasoactive:active {
            background: #6d28d9;
        }
        .quick-btn.vent {
            background: #0891b2;
            border-color: #0891b2;
        }
        .quick-btn.vent:active {
            background: #0e7490;
        }

        /* Vitals Grid */
        .vitals-section {
            background: var(--card);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .section-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-muted);
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .vitals-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
        }

        .vital-input {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px;
            text-align: center;
        }

        .vital-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-bottom: 4px;
        }

        .vital-value {
            background: transparent;
            border: none;
            color: var(--text);
            font-size: 1.5rem;
            font-weight: 600;
            width: 100%;
            text-align: center;
            outline: none;
        }

        .vital-value::placeholder {
            color: var(--text-muted);
            font-size: 1rem;
        }

        .vital-unit {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        /* ===== Timeline v1.2 - Graphical Chart UI ===== */
        @import url('/shared/xirs-ui/core/xirs-colors.css');

        /* CSS Variables for Vitals (xIRS integrated) */
        :root {
            --vital-sbp: #dc2626;
            --vital-dbp: #dc2626;
            --vital-hr: #2563eb;
            --vital-spo2: #10b981;
            --vital-rr: #7c3aed;
            --vital-warning: #f59e0b;
            --vital-critical: #dc2626;
            --event-medication: #3b82f6;
            --event-procedure: #8b5cf6;
            --event-milestone: #14b8a6;
            --event-stat: #dc2626;
            --grid-line: #334155;
            --now-indicator: #f59e0b;
        }

        .timeline-section {
            background: var(--card);
            border-radius: 12px;
            padding: 16px;
            position: relative;
        }

        /* Hour Pagination Header */
        .timeline-pagination {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
            padding: 8px;
            background: var(--bg);
            border-radius: 8px;
        }

        .timeline-pagination button {
            background: var(--card-hover);
            border: none;
            color: var(--text);
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .timeline-pagination button:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .timeline-pagination button:not(:disabled):active {
            background: var(--primary);
        }

        .timeline-hour-display {
            font-weight: 600;
            font-size: 1rem;
        }

        .timeline-hour-chips {
            display: flex;
            gap: 4px;
            overflow-x: auto;
            padding: 4px 0;
        }

        .hour-chip {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            background: var(--card-hover);
            color: var(--text-muted);
            cursor: pointer;
            white-space: nowrap;
        }

        .hour-chip.active {
            background: var(--primary);
            color: white;
        }

        .hour-chip.has-events {
            border: 1px solid var(--primary);
        }

        /* Timeline Canvas Container */
        .timeline-chart {
            position: relative;
            width: 100%;
            height: 280px;
            overflow: hidden;
            touch-action: pan-x;
        }

        .timeline-chart canvas {
            display: block;
        }

        /* NOW Indicator - iOS compatible */
        .now-indicator {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 2px;
            background: var(--now-indicator);
            z-index: 10;
            pointer-events: none;
            /* iOS Safari fix */
            -webkit-transform: translateZ(0);
            transform: translateZ(0);
        }

        .now-indicator::before {
            content: 'NOW';
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            -webkit-transform: translateX(-50%);
            background: var(--now-indicator);
            color: #000;
            font-size: 10px;
            font-weight: 700;
            padding: 2px 6px;
            border-radius: 0 0 4px 4px;
            /* iOS Safari fix for pseudo-elements */
            display: block;
            white-space: nowrap;
        }

        /* NOW Indicator label as separate element for better iOS support */
        .now-indicator-label {
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            -webkit-transform: translateX(-50%);
            background: var(--now-indicator);
            color: #000;
            font-size: 10px;
            font-weight: 700;
            padding: 2px 6px;
            border-radius: 0 0 4px 4px;
            white-space: nowrap;
        }

        /* Milestone Track */
        .milestone-track {
            display: flex;
            gap: 8px;
            padding: 8px 0;
            border-bottom: 1px solid var(--border);
            margin-bottom: 8px;
            overflow-x: auto;
        }

        .milestone-chip {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            border-radius: 16px;
            font-size: 0.75rem;
            white-space: nowrap;
            background: var(--event-milestone);
            color: white;
        }

        .milestone-chip.pending {
            background: var(--card-hover);
            color: var(--text-muted);
            border: 1px dashed var(--border);
            cursor: pointer;
            transition: all 0.2s;
        }

        .milestone-chip.pending:hover {
            background: var(--primary);
            color: white;
            border-style: solid;
        }

        .milestone-chip.pending:active {
            transform: scale(0.95);
        }

        /* Timeline View Toggle v1.3 */
        .timeline-view-toggle {
            display: flex;
            gap: 4px;
            background: var(--bg);
            padding: 4px;
            border-radius: 8px;
        }

        .view-toggle-btn {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            background: transparent;
            color: var(--text-muted);
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .view-toggle-btn:hover {
            background: var(--card-hover);
        }

        .view-toggle-btn.active {
            background: var(--primary);
            color: white;
        }

        .view-toggle-btn svg {
            flex-shrink: 0;
        }

        .quick-btn.success {
            background: #10b981;
            border-color: #10b981;
        }

        .quick-btn.success:active {
            background: #059669;
        }

        /* Event Legend */
        .timeline-legend {
            display: flex;
            gap: 12px;
            padding: 8px 0;
            font-size: 0.7rem;
            color: var(--text-muted);
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .legend-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        /* STAT Button - Fixed Position */
        .stat-button {
            position: fixed;
            bottom: 90px;
            right: 16px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--event-stat);
            border: 3px solid #fff;
            color: white;
            font-weight: 700;
            font-size: 0.9rem;
            cursor: pointer;
            z-index: 50;
            box-shadow: 0 4px 12px rgba(220, 38, 38, 0.4);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            animation: pulse-stat 2s infinite;
        }

        .stat-button:active {
            transform: scale(0.95);
        }

        @keyframes pulse-stat {
            0%, 100% { box-shadow: 0 4px 12px rgba(220, 38, 38, 0.4); }
            50% { box-shadow: 0 4px 20px rgba(220, 38, 38, 0.7); }
        }

        .stat-button.hidden {
            display: none;
        }

        /* Legacy Timeline List (toggle view) */
        .timeline-list-toggle {
            text-align: right;
            margin-bottom: 8px;
        }

        .timeline-list-toggle button {
            background: none;
            border: none;
            color: var(--primary);
            font-size: 0.75rem;
            cursor: pointer;
            text-decoration: underline;
        }

        .timeline {
            max-height: 300px;
            overflow-y: auto;
        }

        .timeline.hidden {
            display: none;
        }

        .timeline-item {
            display: flex;
            gap: 12px;
            padding: 12px 0;
            border-bottom: 1px solid var(--border);
        }

        .timeline-item:last-child {
            border-bottom: none;
        }

        .timeline-time {
            font-size: 0.875rem;
            color: var(--text-muted);
            min-width: 50px;
        }

        .timeline-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--primary);
            margin-top: 4px;
        }

        .timeline-dot.vital { background: #71717a; }
        .timeline-dot.med { background: var(--controlled); }
        .timeline-dot.milestone { background: #52525b; }
        .timeline-dot.blood { background: #b91c1c; }

        .timeline-content {
            flex: 1;
        }

        .timeline-type {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .timeline-desc {
            font-size: 0.9rem;
            margin-top: 2px;
        }

        /* Bottom Nav */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--card);
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: space-around;
            padding: 12px 0;
            padding-bottom: calc(12px + env(safe-area-inset-bottom));
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            color: var(--text-muted);
            font-size: 0.75rem;
            cursor: pointer;
            padding: 8px 16px;
        }

        .nav-item.active {
            color: var(--primary);
        }

        /* Controlled nav only shows purple-pink when active */
        .nav-item.controlled-nav.active {
            color: var(--controlled);
        }

        .nav-item .icon {
            font-size: 1.25rem;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 200;
            align-items: flex-end;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--card);
            border-radius: 20px 20px 0 0;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            padding: 20px;
            padding-bottom: calc(20px + env(safe-area-inset-bottom));
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 1.5rem;
            cursor: pointer;
        }

        /* Quick Med Buttons */
        .med-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .med-btn {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            color: var(--text);
            cursor: pointer;
            text-align: left;
        }

        .med-btn:active {
            background: var(--card-hover);
        }

        .med-btn.controlled-drug {
            border-color: var(--controlled);
        }

        .med-btn.controlled-drug .med-name {
            color: var(--controlled);
        }

        .med-name {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .med-dose {
            font-size: 0.875rem;
            color: var(--text-muted);
        }

        /* Inventory Stock Badge */
        .med-stock {
            display: flex;
            align-items: center;
            gap: 4px;
            margin-top: 6px;
            font-size: 0.75rem;
        }

        .stock-badge {
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 600;
        }

        .stock-badge.in-stock {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
        }

        .stock-badge.low-stock {
            background: rgba(234, 179, 8, 0.2);
            color: #eab308;
        }

        .stock-badge.out-of-stock {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .med-btn.out-of-stock {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .med-loading {
            grid-column: span 2;
            text-align: center;
            padding: 40px;
            color: var(--text-muted);
        }

        /* Dose Adjustment UI */
        .selected-drug-card {
            background: var(--bg);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            margin-bottom: 20px;
        }

        .selected-drug-name {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .selected-drug-tag {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .selected-drug-tag.controlled {
            background: var(--controlled);
            color: white;
        }

        .dose-adjust-section {
            background: var(--bg);
            border-radius: 12px;
            padding: 16px;
        }

        .dose-btn {
            background: var(--card-hover);
            border: none;
            border-radius: 8px;
            padding: 12px 16px;
            color: var(--text);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
        }

        .dose-btn:active {
            background: var(--primary);
        }

        .dose-input {
            width: 100px;
            text-align: center;
            font-size: 1.5rem;
            font-weight: 700;
        }

        .dose-unit {
            text-align: center;
            color: var(--text-muted);
            margin-top: 8px;
        }

        /* Form */
        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            font-size: 0.875rem;
            color: var(--text-muted);
            margin-bottom: 8px;
            display: block;
        }

        .form-input {
            width: 100%;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px;
            color: var(--text);
            font-size: 1rem;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .btn {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:active {
            background: var(--primary-dark);
        }

        .btn-small {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            background: var(--primary);
            color: white;
        }

        .btn-small:active {
            background: var(--primary-dark);
        }

        /* Case List (No Active Case View) */
        .case-list {
            margin-top: 16px;
        }

        .case-list-item {
            background: var(--card);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            cursor: pointer;
        }

        .case-list-item:active {
            background: var(--card-hover);
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
        }

        .empty-state .icon {
            font-size: 4rem;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .empty-state p {
            color: var(--text-muted);
            margin-bottom: 20px;
        }

        /* Hidden */
        .hidden {
            display: none !important;
        }

        /* Time Offset Selector v1.6.1 */
        .time-offset-selector {
            margin-bottom: 16px;
            padding: 12px;
            background: var(--bg-secondary);
            border-radius: 8px;
        }

        .time-offset-label {
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .time-offset-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .time-offset-btn {
            padding: 8px 14px;
            border: 1px solid var(--border);
            background: var(--bg-card);
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.15s;
        }

        .time-offset-btn:hover {
            background: var(--bg-hover);
        }

        .time-offset-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .time-offset-custom {
            display: none;
            margin-top: 10px;
            gap: 8px;
            align-items: center;
        }

        .time-offset-custom.show {
            display: flex;
        }

        .time-offset-custom input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: var(--bg-card);
            color: var(--text-primary);
            font-size: 14px;
        }

        .late-entry-reason {
            display: none;
            margin-top: 10px;
            padding: 10px;
            background: rgba(251, 191, 36, 0.1);
            border: 1px solid rgba(251, 191, 36, 0.3);
            border-radius: 6px;
        }

        .late-entry-reason.show {
            display: block;
        }

        .late-entry-reason label {
            font-size: 12px;
            color: #f59e0b;
            display: block;
            margin-bottom: 6px;
        }

        .late-entry-reason select,
        .late-entry-reason input {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border);
            border-radius: 4px;
            background: var(--bg-card);
            color: var(--text-primary);
            font-size: 13px;
            margin-bottom: 6px;
        }

        .computed-time {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 6px;
            padding: 6px 10px;
            background: var(--bg-card);
            border-radius: 4px;
            display: inline-block;
        }
    </style>
    <!-- Note: xirs-fallback-guard.js 已移除 - MIRS Anesthesia 使用 CIRS Hub 連線 -->
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-title">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width:20px;height:20px;">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
            </svg>
            <span>麻醉站</span>
            <span id="contextBadge" class="case-status hidden">BATTLEFIELD</span>
            <span id="syncIndicator" class="sync-indicator" title="同步狀態">
                <svg class="sync-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width:16px;height:16px;">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                </svg>
                <span id="syncBadge" class="sync-badge hidden">0</span>
            </span>
        </div>
        <div class="header-subtitle" id="stationInfo">MIRS v1.5.1</div>
    </header>

    <!-- Resource Bar (shown when case is active) -->
    <div class="resource-bar hidden" id="resourceBar">
        <div class="resource-item o2-item" onclick="showO2Modal()" style="cursor:pointer; padding: 4px 8px; border-radius: 8px; transition: background 0.2s;">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width:18px;height:18px;opacity:0.7;">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path>
            </svg>
            <span id="o2Label">O2</span>
            <span class="resource-value" id="o2Status">未認領</span>
            <span id="o2Unit"></span>
        </div>
        <div class="resource-item">
            <span>SpO2</span>
            <span class="resource-value" id="lastSpo2">--</span>
            <span>%</span>
        </div>
        <div class="resource-item">
            <span>HR</span>
            <span class="resource-value" id="lastHr">--</span>
        </div>
        <div class="resource-item">
            <span>BP</span>
            <span class="resource-value" id="lastBp">--/--</span>
        </div>
    </div>

    <!-- Main Content -->
    <main class="main">
        <!-- No Case View -->
        <div id="noCaseView">
            <div class="quick-actions">
                <button class="quick-btn primary" onclick="showNewCaseModal()">
                    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width:24px;height:24px;">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                    </svg>
                    <span>新增案例</span>
                </button>
                <button class="quick-btn" onclick="loadCases()">
                    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width:24px;height:24px;">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path>
                    </svg>
                    <span>今日案例</span>
                </button>
            </div>

            <div class="case-list" id="caseList">
                <div class="empty-state">
                    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width:64px;height:64px;opacity:0.5;">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
                    </svg>
                    <p>尚無進行中的案例</p>
                </div>
            </div>
        </div>

        <!-- Active Case View -->
        <div id="activeCaseView" class="hidden">
            <!-- Back to List Button -->
            <button onclick="backToList()" style="background: none; border: none; color: var(--primary); font-size: 0.9rem; padding: 8px 0; margin-bottom: 8px; cursor: pointer; display: flex; align-items: center; gap: 4px;">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 18px; height: 18px;">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                </svg>
                返回案件清單
            </button>
            <!-- Case Info -->
            <div class="case-card">
                <div class="case-header">
                    <div>
                        <div class="case-id" id="caseId">ANES-20251229-ABC</div>
                        <div class="patient-name" id="patientName">病患姓名</div>
                    </div>
                    <span class="case-status preop" id="caseStatus">PREOP</span>
                </div>
                <!-- v2.1.1: 診斷 + 術式 -->
                <div style="margin-top: 6px; font-size: 0.8rem; color: var(--text-muted);">
                    <div id="diagnosisInfo" style="margin-bottom: 2px;"></div>
                    <div id="operationInfo" style="font-weight: 500; color: var(--text-primary);"></div>
                </div>
                <!-- v1.1: 麻醉方式 + ASA 分級顯示 (可點擊編輯) -->
                <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-top: 8px;">
                    <span class="case-tag technique" id="techniqueInfo" onclick="showEditCaseInfoModal()" style="cursor: pointer;">GA_ETT</span>
                    <span class="case-tag asa" id="asaInfo" onclick="showEditCaseInfoModal()" style="cursor: pointer;">ASA II</span>
                </div>
            </div>

            <!-- Quick Actions: Record Events -->
            <div class="section-title" style="margin: 12px 0 8px 0; font-size: 0.75rem; color: var(--text-muted);">
                記錄麻醉事件
            </div>
            <div class="quick-actions">
                <button class="quick-btn primary" onclick="showVitalsModal()">
                    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width:24px;height:24px;">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
                    </svg>
                    <span>記錄 Vitals</span>
                </button>
                <button class="quick-btn controlled" onclick="showMedModal()">
                    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width:24px;height:24px;">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path>
                    </svg>
                    <span>給藥</span>
                </button>
                <button class="quick-btn" onclick="showO2Modal()">
                    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width:24px;height:24px;">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.999 5.002 5.002 0 10-9.78 2.096A4.001 4.001 0 003 15z"></path>
                    </svg>
                    <span>氧氣</span>
                </button>
                <button class="quick-btn blood" onclick="showBloodModal()">
                    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width:24px;height:24px;">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z"></path>
                    </svg>
                    <span>輸血</span>
                </button>
                <button class="quick-btn success" onclick="startAnesthesiaWithTimeSelector()" id="btnStart">
                    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width:24px;height:24px;">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <span>開始麻醉</span>
                </button>
                <button class="quick-btn" onclick="showMilestoneModal()">
                    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width:24px;height:24px;">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 21v-4m0 0V5a2 2 0 012-2h6.5l1 1H21l-3 6 3 6h-8.5l-1-1H5a2 2 0 00-2 2zm9-13.5V9"></path>
                    </svg>
                    <span>里程碑</span>
                </button>
                <button class="quick-btn" onclick="closeCase()" style="background: var(--danger); border-color: var(--danger);">
                    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width:24px;height:24px;">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <span>結案</span>
                </button>
                <button class="quick-btn" onclick="downloadPDF()" style="background: #6366f1; border-color: #6366f1;">
                    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width:24px;height:24px;">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 11v6m0 0l-2-2m2 2l2-2"></path>
                    </svg>
                    <span>PDF</span>
                </button>
            </div>

            <!-- Advanced Events Row -->
            <div class="section-title" style="margin: 12px 0 8px 0; font-size: 0.75rem; color: var(--text-muted);">
                進階事件
            </div>
            <div class="quick-actions">
                <button class="quick-btn vasoactive" onclick="showVasoactiveModal()">
                    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width:24px;height:24px;">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                    </svg>
                    <span>昇壓劑</span>
                </button>
                <button class="quick-btn vent" onclick="showVentModal()">
                    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width:24px;height:24px;">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                    </svg>
                    <span>呼吸器</span>
                </button>
                <button class="quick-btn" onclick="showDepthModal()">
                    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width:24px;height:24px;">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                    </svg>
                    <span>麻醉深度</span>
                </button>
                <button class="quick-btn" onclick="showPositionModal()">
                    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width:24px;height:24px;">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                    </svg>
                    <span>姿勢</span>
                </button>
                <button class="quick-btn" onclick="showTechniqueModal()" style="background: linear-gradient(135deg, #7c3aed 0%, #5b21b6 100%);">
                    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width:24px;height:24px;">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z"></path>
                    </svg>
                    <span>特殊技術</span>
                </button>
            </div>

            <!-- Timeline v1.4 - Default to Chart View (horizontal scroll like traditional anesthesia record) -->
            <div class="timeline-section">
                <div class="section-title" style="display: flex; justify-content: space-between; align-items: center;">
                    <span>麻醉記錄時間軸</span>
                    <div class="timeline-view-toggle">
                        <button class="view-toggle-btn" id="btnListView" onclick="setTimelineView('list')">
                            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"/>
                            </svg>
                            列表
                        </button>
                        <button class="view-toggle-btn active" id="btnChartView" onclick="setTimelineView('chart')">
                            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                            </svg>
                            圖表
                        </button>
                    </div>
                </div>

                <!-- Milestone Track (可點擊記錄) -->
                <div class="milestone-track" id="milestoneTrack">
                    <span class="milestone-chip pending" id="msInduction" onclick="recordMilestoneFromChip('ANESTHESIA_START', this)">誘導</span>
                    <span class="milestone-chip pending" id="msIntubation" onclick="recordMilestoneFromChip('INTUBATION', this)">插管</span>
                    <span class="milestone-chip pending" id="msIncision" onclick="recordMilestoneFromChip('SURGERY_START', this)">劃刀</span>
                    <span class="milestone-chip pending" id="msSkinClose" onclick="recordMilestoneFromChip('SURGERY_END', this)">關皮</span>
                    <span class="milestone-chip pending" id="msExtubation" onclick="recordMilestoneFromChip('EXTUBATION', this)">拔管</span>
                    <span class="milestone-chip pending" id="msPacu" onclick="recordMilestoneFromChip('ANESTHESIA_END', this)">送PACU</span>
                </div>

                <!-- Chart View Container (default - horizontal scroll like traditional anesthesia record) -->
                <div id="chartViewContainer">
                    <!-- Hour Pagination -->
                    <div class="timeline-pagination">
                        <button onclick="timelineChart.prevHour()" id="btnPrevHour">
                            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                            </svg>
                        </button>
                        <div class="timeline-hour-chips" id="hourChips">
                            <!-- Populated by JS -->
                        </div>
                        <button onclick="timelineChart.nextHour()" id="btnNextHour">
                            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                            </svg>
                        </button>
                    </div>

                    <!-- Canvas Chart -->
                    <div class="timeline-chart" id="timelineChartContainer">
                        <canvas id="vitalsCanvas"></canvas>
                        <div class="now-indicator" id="nowIndicator" style="display: none;">
                            <span class="now-indicator-label">NOW</span>
                        </div>
                    </div>

                    <!-- Legend -->
                    <div class="timeline-legend">
                        <div class="legend-item"><span class="legend-dot" style="background: var(--vital-sbp);"></span> BP</div>
                        <div class="legend-item"><span class="legend-dot" style="background: var(--vital-hr);"></span> HR</div>
                        <div class="legend-item"><span class="legend-dot" style="background: var(--vital-spo2);"></span> SpO2</div>
                        <div class="legend-item"><span class="legend-dot" style="background: var(--event-medication);"></span> 藥物</div>
                        <div class="legend-item"><span class="legend-dot" style="background: var(--event-milestone);"></span> 里程碑</div>
                    </div>
                </div>

                <!-- List View (alternative view) -->
                <div class="timeline hidden" id="timeline">
                    <div class="empty-state">
                        <p>尚無事件</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- STAT Button (Emergency) -->
    <button class="stat-button hidden" id="statButton" onclick="showStatModal()">
        <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24">
            <path d="M13 10V3L4 14h7v7l9-11h-7z"/>
        </svg>
        STAT
    </button>

    <!-- Bottom Nav -->
    <nav class="bottom-nav">
        <div class="nav-item active" onclick="switchTab('case')">
            <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width:20px;height:20px;">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
            </svg>
            <span>案例</span>
        </div>
        <div class="nav-item" onclick="switchTab('preop')">
            <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width:20px;height:20px;">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path>
            </svg>
            <span>術前</span>
        </div>
        <div class="nav-item controlled-nav" onclick="switchTab('drugs')">
            <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width:20px;height:20px;">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path>
            </svg>
            <span>管藥</span>
        </div>
        <div class="nav-item" onclick="switchTab('o2')">
            <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width:20px;height:20px;">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.999 5.002 5.002 0 10-9.78 2.096A4.001 4.001 0 003 15z"></path>
            </svg>
            <span>氧氣</span>
        </div>
        <div class="nav-item" onclick="switchTab('ivio')" style="color: #22c55e;">
            <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width:20px;height:20px;">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
            </svg>
            <span>IV/IO</span>
        </div>
    </nav>

    <!-- New Case Modal -->
    <div class="modal" id="newCaseModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">新增麻醉案例</h2>
                <button class="modal-close" onclick="closeModal('newCaseModal')">&times;</button>
            </div>

            <!-- CIRS Waiting List Section -->
            <div id="cirsWaitingSection" style="margin-bottom: 16px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <label class="form-label" style="margin: 0;">CIRS 候診名單</label>
                    <span id="cirsStatus" style="font-size: 12px; color: var(--text-secondary);">檢查中...</span>
                </div>
                <div id="cirsPatientList" style="max-height: 150px; overflow-y: auto; background: var(--bg-tertiary); border-radius: 8px; padding: 8px;">
                    <div style="text-align: center; color: var(--text-secondary); padding: 16px;">載入中...</div>
                </div>
            </div>

            <div style="text-align: center; color: var(--text-secondary); margin-bottom: 12px; font-size: 13px;">
                ─── 或手動輸入 ───
            </div>

            <form onsubmit="createCase(event)">
                <input type="hidden" id="cirsRegistrationRef" value="">
                <input type="hidden" id="patientSnapshot" value="">

                <div class="form-group">
                    <label class="form-label">病歷號 / 病患 ID</label>
                    <input type="text" class="form-input" id="newPatientId" required placeholder="輸入病歷號">
                </div>
                <div class="form-group">
                    <label class="form-label">病患姓名</label>
                    <input type="text" class="form-input" id="newPatientName" placeholder="選填">
                </div>
                <div class="form-group">
                    <label class="form-label">診斷 (Diagnosis)</label>
                    <input type="text" class="form-input" id="newDiagnosis" placeholder="選填">
                </div>
                <div class="form-group">
                    <label class="form-label">手術名稱 (Operation)</label>
                    <input type="text" class="form-input" id="newOperation" placeholder="選填">
                </div>
                <div class="form-group">
                    <label class="form-label">麻醉方式</label>
                    <select class="form-input" id="newTechnique">
                        <option value="GA">全身麻醉 (GA)</option>
                        <option value="GA_ETT">全身麻醉 - 插管 (ETT)</option>
                        <option value="GA_LMA">全身麻醉 - 喉罩 (LMA)</option>
                        <option value="RA_SPINAL">脊椎麻醉 (Spinal)</option>
                        <option value="RA_EPIDURAL">硬膜外麻醉 (Epidural)</option>
                        <option value="RA_NERVE">神經阻斷 (Nerve Block)</option>
                        <option value="MAC">監測麻醉照護 (MAC)</option>
                        <option value="LA">局部麻醉 (Local)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">ASA 分級</label>
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <select class="form-input" id="newAsaClass" style="flex: 1;">
                            <option value="I">ASA I - 健康</option>
                            <option value="II">ASA II - 輕度全身疾病</option>
                            <option value="III">ASA III - 嚴重全身疾病</option>
                            <option value="IV">ASA IV - 危及生命</option>
                            <option value="V">ASA V - 瀕死</option>
                        </select>
                        <label style="display: flex; align-items: center; gap: 4px; white-space: nowrap; font-size: 14px;">
                            <input type="checkbox" id="newAsaEmergency" style="width: 18px; height: 18px;">
                            <span style="color: var(--warning-color);">+E 急診</span>
                        </label>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">模式</label>
                    <select class="form-input" id="newContextMode">
                        <option value="STANDARD">標準模式</option>
                        <option value="BATTLEFIELD">戰時模式</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary">建立案例</button>
            </form>
        </div>
    </div>

    <!-- Vitals Modal -->
    <div class="modal" id="vitalsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">記錄 Vital Signs</h2>
                <button class="modal-close" onclick="closeModal('vitalsModal')">&times;</button>
            </div>
            <form onsubmit="submitVitals(event)">
                <!-- Time Offset Selector v1.6.1 -->
                <div class="time-offset-selector" id="vitalsTimeSelector">
                    <div class="time-offset-label">
                        <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="10" stroke-width="2"/>
                            <path stroke-width="2" d="M12 6v6l4 2"/>
                        </svg>
                        事件時間
                    </div>
                    <div class="time-offset-buttons">
                        <button type="button" class="time-offset-btn active" data-offset="0" onclick="selectTimeOffset(this, 'vitals')">現在</button>
                        <button type="button" class="time-offset-btn" data-offset="-300" onclick="selectTimeOffset(this, 'vitals')">-5分</button>
                        <button type="button" class="time-offset-btn" data-offset="-600" onclick="selectTimeOffset(this, 'vitals')">-10分</button>
                        <button type="button" class="time-offset-btn" data-offset="-900" onclick="selectTimeOffset(this, 'vitals')">-15分</button>
                        <button type="button" class="time-offset-btn" data-offset="custom" onclick="selectTimeOffset(this, 'vitals')">自訂</button>
                    </div>
                    <div class="time-offset-custom" id="vitalsTimeCustom">
                        <input type="datetime-local" id="vitalsCustomTime" onchange="updateComputedTime('vitals')">
                    </div>
                    <div class="late-entry-reason" id="vitalsLateEntry">
                        <label>遲補登錄原因 (超過5分鐘需填寫)</label>
                        <select id="vitalsLateReason">
                            <option value="EMERGENCY_HANDLING">緊急處置中</option>
                            <option value="EQUIPMENT_ISSUE">設備問題</option>
                            <option value="SHIFT_HANDOFF">交班中</option>
                            <option value="DOCUMENTATION_CATCH_UP">補登文件</option>
                            <option value="OTHER">其他</option>
                        </select>
                        <input type="text" id="vitalsLateNote" placeholder="備註 (選填)">
                    </div>
                    <div class="computed-time" id="vitalsComputedTime">記錄時間: 現在</div>
                </div>

                <div class="vitals-grid">
                    <div class="vital-input">
                        <div class="vital-label">BP (sys)</div>
                        <input type="number" class="vital-value" id="vBpSys" placeholder="120">
                        <div class="vital-unit">mmHg</div>
                    </div>
                    <div class="vital-input">
                        <div class="vital-label">BP (dia)</div>
                        <input type="number" class="vital-value" id="vBpDia" placeholder="80">
                        <div class="vital-unit">mmHg</div>
                    </div>
                    <div class="vital-input">
                        <div class="vital-label">HR</div>
                        <input type="number" class="vital-value" id="vHr" placeholder="72">
                        <div class="vital-unit">bpm</div>
                    </div>
                    <div class="vital-input">
                        <div class="vital-label">SpO2</div>
                        <input type="number" class="vital-value" id="vSpo2" placeholder="99">
                        <div class="vital-unit">%</div>
                    </div>
                    <div class="vital-input">
                        <div class="vital-label">EtCO2</div>
                        <input type="number" class="vital-value" id="vEtco2" placeholder="35">
                        <div class="vital-unit">mmHg</div>
                    </div>
                    <div class="vital-input">
                        <div class="vital-label">O2 Flow</div>
                        <input type="number" step="0.5" class="vital-value" id="vO2Flow" placeholder="2">
                        <div class="vital-unit">L/min</div>
                    </div>
                </div>
                <div style="margin-top: 20px;">
                    <button type="submit" class="btn btn-primary">記錄</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Medication Modal -->
    <div class="modal" id="medModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">給藥記錄</h2>
                <button class="modal-close" onclick="closeModal('medModal')">&times;</button>
            </div>

            <!-- Drug Selection View -->
            <div id="medSelectView">
                <div class="section-title">常用藥物 <span id="medInventoryStatus" style="font-size: 0.75rem; color: var(--text-muted);"></span></div>
                <div class="med-grid" id="quickDrugsGrid">
                    <div class="med-loading">載入藥品庫存中...</div>
                </div>
                <div style="margin-top: 20px; display: flex; gap: 12px;">
                    <button class="btn" style="background: var(--card-hover);" onclick="showCustomMedForm()">自訂藥物</button>
                    <button class="btn" style="background: var(--card-hover);" onclick="loadQuickDrugsWithInventory()">
                        <svg style="width:16px;height:16px;vertical-align:middle;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                        </svg>
                        重新整理
                    </button>
                </div>
            </div>

            <!-- Dose Adjustment View -->
            <div id="medConfirmView" class="hidden">
                <div class="selected-drug-card">
                    <div class="selected-drug-name" id="selectedDrugName">Propofol</div>
                    <div class="selected-drug-tag" id="selectedDrugTag"></div>
                </div>

                <!-- Time Offset Selector v1.6.1 -->
                <div class="time-offset-selector" id="medTimeSelector">
                    <div class="time-offset-label">
                        <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="10" stroke-width="2"/>
                            <path stroke-width="2" d="M12 6v6l4 2"/>
                        </svg>
                        給藥時間
                    </div>
                    <div class="time-offset-buttons">
                        <button type="button" class="time-offset-btn active" data-offset="0" onclick="selectTimeOffset(this, 'med')">現在</button>
                        <button type="button" class="time-offset-btn" data-offset="-300" onclick="selectTimeOffset(this, 'med')">-5分</button>
                        <button type="button" class="time-offset-btn" data-offset="-600" onclick="selectTimeOffset(this, 'med')">-10分</button>
                        <button type="button" class="time-offset-btn" data-offset="-900" onclick="selectTimeOffset(this, 'med')">-15分</button>
                        <button type="button" class="time-offset-btn" data-offset="custom" onclick="selectTimeOffset(this, 'med')">自訂</button>
                    </div>
                    <div class="time-offset-custom" id="medTimeCustom">
                        <input type="datetime-local" id="medCustomTime" onchange="updateComputedTime('med')">
                    </div>
                    <div class="late-entry-reason" id="medLateEntry">
                        <label>遲補登錄原因 (超過5分鐘需填寫)</label>
                        <select id="medLateReason">
                            <option value="EMERGENCY_HANDLING">緊急處置中</option>
                            <option value="EQUIPMENT_ISSUE">設備問題</option>
                            <option value="SHIFT_HANDOFF">交班中</option>
                            <option value="DOCUMENTATION_CATCH_UP">補登文件</option>
                            <option value="OTHER">其他</option>
                        </select>
                        <input type="text" id="medLateNote" placeholder="備註 (選填)">
                    </div>
                    <div class="computed-time" id="medComputedTime">記錄時間: 現在</div>
                </div>

                <div class="dose-adjust-section">
                    <div class="form-group">
                        <label class="form-label">劑量</label>
                        <div style="display: flex; gap: 12px; align-items: center;">
                            <button class="dose-btn" onclick="adjustDose(-10)">-10</button>
                            <button class="dose-btn" onclick="adjustDose(-1)">-1</button>
                            <input type="number" class="form-input dose-input" id="selectedDose" step="0.1">
                            <button class="dose-btn" onclick="adjustDose(1)">+1</button>
                            <button class="dose-btn" onclick="adjustDose(10)">+10</button>
                        </div>
                        <div class="dose-unit" id="selectedUnit">mg</div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">給藥途徑</label>
                        <select class="form-input" id="selectedRoute">
                            <option value="IV">IV 靜脈注射</option>
                            <option value="IM">IM 肌肉注射</option>
                            <option value="SC">SC 皮下注射</option>
                            <option value="PO">PO 口服</option>
                            <option value="INH">INH 吸入</option>
                        </select>
                    </div>
                </div>
                <div style="display: flex; gap: 12px; margin-top: 20px;">
                    <button class="btn" style="background: var(--card-hover); flex: 1;" onclick="backToMedSelect()">返回</button>
                    <button class="btn btn-primary" style="flex: 2;" onclick="confirmMed()">確認給藥</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Battlefield Preop Modal -->
    <div class="modal" id="preopModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">術前快速評估</h2>
                <button class="modal-close" onclick="closeModal('preopModal')">&times;</button>
            </div>
            <div id="preopContent">
                <div class="section-title">戰場模式 - 快速5項評估</div>
                <div style="display: flex; flex-direction: column; gap: 12px; margin-top: 16px;">
                    <label class="preop-flag">
                        <input type="checkbox" id="flagAllergic">
                        <span class="flag-label">
                            <svg class="flag-icon warning-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width:20px;height:20px;">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                            </svg>
                            已知過敏 (Known Allergy)
                        </span>
                    </label>
                    <label class="preop-flag">
                        <input type="checkbox" id="flagFullStomach">
                        <span class="flag-label">
                            <svg class="flag-icon warning-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width:20px;height:20px;">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                            </svg>
                            未禁食 (Full Stomach)
                        </span>
                    </label>
                    <label class="preop-flag">
                        <input type="checkbox" id="flagDifficultAirway">
                        <span class="flag-label">
                            <svg class="flag-icon danger-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width:20px;height:20px;">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            困難呼吸道 (Difficult Airway)
                        </span>
                    </label>
                    <label class="preop-flag">
                        <input type="checkbox" id="flagUnstable">
                        <span class="flag-label">
                            <svg class="flag-icon danger-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width:20px;height:20px;">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            血行動力不穩 (Hemodynamically Unstable)
                        </span>
                    </label>
                    <label class="preop-flag">
                        <input type="checkbox" id="flagHighRisk">
                        <span class="flag-label">
                            <svg class="flag-icon danger-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width:20px;height:20px;">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            高風險 (High Risk)
                        </span>
                    </label>
                </div>
                <div class="form-group" style="margin-top: 16px;">
                    <label class="form-label">快速備註</label>
                    <textarea class="form-input" id="preopQuickNote" rows="2" placeholder="其他重要資訊..."></textarea>
                </div>
                <div style="margin-top: 20px; display: flex; gap: 12px;">
                    <button class="btn btn-primary" onclick="savePreop()">儲存評估</button>
                    <button class="btn" style="background: var(--card-hover);" onclick="closeModal('preopModal')">取消</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Phase B: Controlled Drugs Modal -->
    <div class="modal" id="drugsModal">
        <div class="modal-content" style="max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h2 class="modal-title">管制藥品</h2>
                <button class="modal-close" onclick="closeModal('drugsModal')">&times;</button>
            </div>

            <!-- Holdings Summary -->
            <div id="drugHoldingsSummary" class="holdings-summary">
                <div class="holdings-header">
                    <span>藥品餘額</span>
                    <span id="holdingsStatus" class="holdings-status reconciled">已結清</span>
                </div>
                <div id="holdingsList" class="holdings-list">
                    <!-- Populated by JS -->
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="drug-actions">
                <button class="drug-action-btn" onclick="showDrugDispenseForm()">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width:20px;height:20px;">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                    </svg>
                    <span>領藥</span>
                </button>
                <button class="drug-action-btn" onclick="showDrugAdminForm()">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width:20px;height:20px;">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path>
                    </svg>
                    <span>給藥</span>
                </button>
                <button class="drug-action-btn" onclick="showDrugWasteForm()">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width:20px;height:20px;">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                    </svg>
                    <span>廢棄</span>
                </button>
                <button class="drug-action-btn" onclick="showDrugReturnForm()">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width:20px;height:20px;">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"></path>
                    </svg>
                    <span>退回</span>
                </button>
            </div>

            <!-- Transaction Form (hidden by default) -->
            <div id="drugTxForm" class="hidden">
                <div class="section-title" id="drugTxTitle">給藥記錄</div>
                <div class="form-group">
                    <label class="form-label">藥品</label>
                    <select class="form-input" id="drugTxDrugSelect">
                        <option value="">選擇藥品...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">劑量</label>
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <input type="number" class="form-input" id="drugTxQuantity" step="0.1" style="flex: 1;">
                        <span id="drugTxUnit" class="dose-unit" style="min-width: 40px;">mg</span>
                    </div>
                    <div id="drugTxAvailable" class="drug-available">可用: --</div>
                </div>
                <div id="drugTxWitnessGroup" class="form-group hidden">
                    <label class="form-label">見證人 ID (必填)</label>
                    <input type="text" class="form-input" id="drugTxWitness" placeholder="輸入見證人 ID">
                    <div class="form-hint">管藥廢棄需要見證人簽核</div>
                </div>
                <div class="form-group">
                    <label class="form-label">備註</label>
                    <input type="text" class="form-input" id="drugTxNotes" placeholder="選填">
                </div>
                <div style="display: flex; gap: 12px; margin-top: 16px;">
                    <button class="btn" style="background: var(--card-hover); flex: 1;" onclick="hideDrugTxForm()">取消</button>
                    <button class="btn controlled" style="flex: 2;" onclick="submitDrugTx()">確認</button>
                </div>
            </div>

            <!-- Transaction History -->
            <div class="section-title" style="margin-top: 20px;">交易記錄</div>
            <div id="drugTxHistory" class="tx-history">
                <div class="empty-state" style="padding: 20px;">
                    <p>尚無交易記錄</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Phase C: O2 Cylinder Modal -->
    <div class="modal" id="o2Modal">
        <div class="modal-content" style="max-height: 80vh; overflow-y: auto;">
            <div class="modal-header">
                <h2 class="modal-title">氧氣管理</h2>
                <button class="modal-close" onclick="closeModal('o2Modal')">&times;</button>
            </div>

            <!-- Current O2 Status -->
            <div class="o2-current-status" id="o2CurrentStatus">
                <div class="holdings-header">
                    <span>目前狀態</span>
                    <span class="holdings-status" id="o2ClaimStatus">未認領</span>
                </div>
                <div id="o2ClaimedInfo" class="hidden" style="padding: 12px; background: var(--card); border-radius: 8px; margin-bottom: 12px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span>氧氣瓶</span>
                        <span id="o2CylinderSerial" style="font-weight: 600;">--</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span>剩餘量</span>
                        <span id="o2LevelPercent" style="font-weight: 600;">--%</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span>預估剩餘</span>
                        <span id="o2EstTime" style="font-weight: 600;">-- min</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span>流速</span>
                        <span id="o2FlowRate" style="font-weight: 600;">-- L/min</span>
                    </div>
                </div>
                <button id="o2ReleaseBtn" class="quick-btn hidden" onclick="releaseO2Cylinder()" style="width: 100%; background: var(--danger); border-color: var(--danger);">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width:20px;height:20px;">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                    <span>釋放氧氣瓶</span>
                </button>
            </div>

            <!-- Available Cylinders List -->
            <div id="o2AvailableSection">
                <div class="holdings-header" style="margin-top: 16px;">
                    <span>可用氧氣瓶</span>
                    <button onclick="loadAvailableCylinders()" style="background: none; border: none; color: var(--primary); cursor: pointer;">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width:20px;height:20px;">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                        </svg>
                    </button>
                </div>
                <div id="o2CylinderList" class="holdings-list">
                    <div class="empty-state" style="padding: 24px; text-align: center;">
                        <p style="color: var(--text-muted);">載入中...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Milestone Modal (Two-step: Select Type → Confirm Time) -->
    <div class="modal" id="milestoneModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">記錄里程碑</h2>
                <button class="modal-close" onclick="closeModal('milestoneModal')">&times;</button>
            </div>

            <!-- Step 1: Select Milestone Type -->
            <div id="milestoneStep1">
                <div class="section-title">選擇里程碑類型</div>
                <div class="med-grid" style="margin-bottom: 16px;">
                    <button class="med-btn" onclick="selectMilestoneType('ANESTHESIA_START')">
                        <div class="med-name">誘導開始</div>
                        <div class="med-dose">Induction</div>
                    </button>
                    <button class="med-btn" onclick="selectMilestoneType('INTUBATION')">
                        <div class="med-name">插管</div>
                        <div class="med-dose">Intubation</div>
                    </button>
                    <button class="med-btn" onclick="selectMilestoneType('SURGERY_START')">
                        <div class="med-name">劃刀</div>
                        <div class="med-dose">Incision</div>
                    </button>
                    <button class="med-btn" onclick="selectMilestoneType('SURGERY_END')">
                        <div class="med-name">關皮</div>
                        <div class="med-dose">Skin Close</div>
                    </button>
                    <button class="med-btn" onclick="selectMilestoneType('EXTUBATION')">
                        <div class="med-name">拔管</div>
                        <div class="med-dose">Extubation</div>
                    </button>
                    <button class="med-btn" onclick="selectMilestoneType('ANESTHESIA_END')">
                        <div class="med-name">送 PACU</div>
                        <div class="med-dose">To Recovery</div>
                    </button>
                </div>
                <button class="btn" style="background: var(--card-hover);" onclick="closeModal('milestoneModal')">取消</button>
            </div>

            <!-- Step 2: Confirm Time -->
            <div id="milestoneStep2" style="display: none;">
                <div class="section-title">
                    <span id="selectedMilestoneLabel">--</span>
                </div>

                <!-- Time Offset Selector (same pattern as vitals/med) -->
                <div class="time-offset-selector" id="milestoneTimeSelector">
                    <div class="time-offset-label">
                        <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="10" stroke-width="2"/>
                            <path stroke-width="2" d="M12 6v6l4 2"/>
                        </svg>
                        事件時間
                    </div>
                    <div class="time-offset-buttons">
                        <button type="button" class="time-offset-btn active" data-offset="0" onclick="selectTimeOffset(this, 'milestone')">現在</button>
                        <button type="button" class="time-offset-btn" data-offset="-60" onclick="selectTimeOffset(this, 'milestone')">-1分</button>
                        <button type="button" class="time-offset-btn" data-offset="-180" onclick="selectTimeOffset(this, 'milestone')">-3分</button>
                        <button type="button" class="time-offset-btn" data-offset="-300" onclick="selectTimeOffset(this, 'milestone')">-5分</button>
                        <button type="button" class="time-offset-btn" data-offset="custom" onclick="selectTimeOffset(this, 'milestone')">自訂</button>
                    </div>
                    <div class="time-offset-custom" id="milestoneTimeCustom">
                        <input type="datetime-local" id="milestoneCustomTime" onchange="updateComputedTime('milestone')">
                    </div>
                    <div class="late-entry-reason" id="milestoneLateEntry">
                        <label>遲補登錄原因 (超過5分鐘需填寫)</label>
                        <select id="milestoneLateReason">
                            <option value="EMERGENCY_HANDLING">緊急處置中</option>
                            <option value="EQUIPMENT_ISSUE">設備問題</option>
                            <option value="SHIFT_HANDOFF">交班中</option>
                            <option value="DOCUMENTATION_CATCH_UP">補登文件</option>
                            <option value="OTHER">其他</option>
                        </select>
                        <input type="text" id="milestoneLateNote" placeholder="備註 (選填)">
                    </div>
                    <div class="computed-time" id="milestoneComputedTime" style="font-size: 1.5rem; font-weight: 600; padding: 16px; text-align: center; background: var(--bg); border-radius: 8px; margin-top: 8px;">記錄時間: 現在</div>
                </div>

                <div style="display: flex; gap: 12px; margin-top: 20px;">
                    <button class="btn" style="background: var(--card-hover); flex: 1;" onclick="backToMilestoneStep1()">返回</button>
                    <button class="btn btn-primary" style="flex: 2;" onclick="submitMilestone()">確認記錄</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Blood Transfusion Modal -->
    <div class="modal" id="bloodModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">輸血記錄</h2>
                <button class="modal-close" onclick="closeModal('bloodModal')">&times;</button>
            </div>

            <!-- Step 1: Select Blood Product Type -->
            <div id="bloodStep1">
                <div class="section-title">選擇血品類型</div>
                <div class="med-grid" style="margin-bottom: 16px;">
                    <button class="med-btn blood-btn" onclick="selectBloodType('PRBC')">
                        <div class="med-name">PRBC</div>
                        <div class="med-dose">紅血球濃厚液</div>
                    </button>
                    <button class="med-btn blood-btn" onclick="selectBloodType('FFP')">
                        <div class="med-name">FFP</div>
                        <div class="med-dose">新鮮冷凍血漿</div>
                    </button>
                    <button class="med-btn blood-btn" onclick="selectBloodType('PLATELET')">
                        <div class="med-name">Platelet</div>
                        <div class="med-dose">血小板</div>
                    </button>
                    <button class="med-btn blood-btn" onclick="selectBloodType('CRYO')">
                        <div class="med-name">Cryo</div>
                        <div class="med-dose">冷凍乾燥凝血因子</div>
                    </button>
                    <button class="med-btn blood-btn" onclick="selectBloodType('WHOLE_BLOOD')">
                        <div class="med-name">Whole Blood</div>
                        <div class="med-dose">全血</div>
                    </button>
                </div>
                <button class="btn" style="background: var(--card-hover);" onclick="closeModal('bloodModal')">取消</button>
            </div>

            <!-- Step 2: Enter Details -->
            <div id="bloodStep2" style="display: none;">
                <div class="section-title" style="display: flex; align-items: center; gap: 8px;">
                    <span class="blood-type-badge" id="selectedBloodType">PRBC</span>
                    <span id="selectedBloodLabel">紅血球濃厚液</span>
                </div>

                <!-- Available Blood Units from Blood Bank -->
                <div class="form-group" style="margin: 16px 0;">
                    <label class="form-label" style="display: flex; justify-content: space-between; align-items: center;">
                        <span>血庫可用庫存</span>
                        <span id="bloodInventoryStatus" style="font-size: 12px; color: var(--text-muted);">載入中...</span>
                    </label>
                    <div id="bloodInventoryList" style="max-height: 150px; overflow-y: auto; background: var(--bg-tertiary); border-radius: 8px; padding: 8px;">
                        <div style="text-align: center; color: var(--text-secondary); padding: 16px;">載入中...</div>
                    </div>
                </div>

                <!-- v1.1: Scan Confirm Section (Select → Scan 兩段式) -->
                <div id="scanConfirmSection" style="display: none; margin: 16px 0; padding: 16px; border-radius: 12px; background: linear-gradient(135deg, rgba(245, 158, 11, 0.15), rgba(245, 158, 11, 0.05)); border: 2px solid #f59e0b;">
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
                        <svg width="24" height="24" fill="none" stroke="#f59e0b" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z"/>
                        </svg>
                        <span style="font-weight: 600; color: #f59e0b;">Step 2: 掃碼確認</span>
                    </div>
                    <div style="margin-bottom: 12px; font-size: 14px;">
                        已選擇: <span id="selectedUnitDisplay" style="font-family: monospace; font-weight: 600; background: rgba(255,255,255,0.1); padding: 2px 8px; border-radius: 4px;">--</span>
                    </div>
                    <div class="form-group" style="margin: 0;">
                        <input type="text" class="form-input" id="scanConfirmInput"
                               placeholder="掃描血袋條碼..."
                               style="font-size: 1.2rem; padding: 14px; text-align: center; font-family: monospace; border: 2px solid #f59e0b;"
                               onchange="verifyScanConfirm()"
                               oninput="verifyScanConfirm()">
                    </div>
                    <div id="scanConfirmStatus" style="margin-top: 12px; padding: 10px; text-align: center; border-radius: 6px; font-size: 14px; font-weight: 600; background: rgba(245, 158, 11, 0.1); color: #f59e0b;">
                        請掃描血袋條碼確認
                    </div>
                </div>

                <!-- Blood Unit ID (manual entry or auto-filled from scan confirm) -->
                <div class="form-group" style="margin: 16px 0;">
                    <label class="form-label">血袋編號 (Unit ID)</label>
                    <input type="text" class="form-input" id="bloodUnitId" placeholder="由上方掃碼確認自動填入，或手動輸入" style="font-size: 1.1rem; padding: 12px;" onchange="verifyBloodUnit()">
                </div>

                <!-- Phase 1: Verification Result Section -->
                <div id="bloodVerificationSection" style="display: none; margin: 16px 0; padding: 12px; border-radius: 8px; background: var(--bg);">
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                        <span style="font-weight: 600;">驗證結果</span>
                        <span id="verificationStatusBadge" style="font-size: 12px; padding: 2px 8px; border-radius: 4px;">檢查中...</span>
                    </div>
                    <div id="verificationDetails" style="font-size: 14px;">
                        <div id="verifyBloodType" style="display: flex; align-items: center; gap: 6px; margin: 4px 0;">
                            <span class="verify-icon">⏳</span> 血型相符
                        </div>
                        <div id="verifyExpiry" style="display: flex; align-items: center; gap: 6px; margin: 4px 0;">
                            <span class="verify-icon">⏳</span> 效期有效
                        </div>
                        <div id="verifyStatus" style="display: flex; align-items: center; gap: 6px; margin: 4px 0;">
                            <span class="verify-icon">⏳</span> 狀態可用
                        </div>
                    </div>
                    <div id="verificationWarnings" style="display: none; margin-top: 8px; padding: 8px; background: rgba(251, 191, 36, 0.1); border-radius: 6px; color: #f59e0b; font-size: 13px;"></div>
                    <div id="verificationErrors" style="display: none; margin-top: 8px; padding: 8px; background: rgba(239, 68, 68, 0.1); border-radius: 6px; color: #ef4444; font-size: 13px;"></div>
                </div>

                <!-- Phase 2: Dual Verification Section (兩人核對) -->
                <div id="dualVerificationSection" style="display: none; margin: 16px 0; padding: 16px; border-radius: 12px; background: linear-gradient(135deg, rgba(220, 38, 38, 0.1), rgba(220, 38, 38, 0.05)); border: 1px solid rgba(220, 38, 38, 0.3);">
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
                        <svg width="20" height="20" fill="none" stroke="#dc2626" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
                        </svg>
                        <span style="font-weight: 600; color: #dc2626;">雙人核對 (Chain of Custody)</span>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                        <div class="form-group" style="margin: 0;">
                            <label class="form-label" style="font-size: 12px;">執行人員 (Actor 1)</label>
                            <input type="text" class="form-input" id="custodyActor1" placeholder="工號/Badge" style="padding: 10px;" onchange="checkDualVerification()">
                            <div id="actor1Status" style="font-size: 11px; margin-top: 4px; color: var(--text-muted);">未驗證</div>
                        </div>
                        <div class="form-group" style="margin: 0;">
                            <label class="form-label" style="font-size: 12px;">覆核人員 (Actor 2)</label>
                            <input type="text" class="form-input" id="custodyActor2" placeholder="工號/Badge" style="padding: 10px;" onchange="checkDualVerification()">
                            <div id="actor2Status" style="font-size: 11px; margin-top: 4px; color: var(--text-muted);">未驗證</div>
                        </div>
                    </div>
                    <div id="dualVerificationStatus" style="margin-top: 12px; padding: 8px; text-align: center; border-radius: 6px; background: rgba(255,255,255,0.1); font-size: 13px;">
                        ⚠️ 需要兩位人員確認才能記錄輸血
                    </div>
                </div>

                <!-- Action Type -->
                <div class="form-group" style="margin: 16px 0;">
                    <label class="form-label">動作</label>
                    <div class="blood-action-buttons">
                        <button type="button" class="blood-action-btn active" data-action="START" onclick="selectBloodAction('START')">
                            <svg width="32" height="32" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"/>
                            </svg>
                            開始輸血
                        </button>
                        <button type="button" class="blood-action-btn" data-action="COMPLETE" onclick="selectBloodAction('COMPLETE')">
                            <svg width="32" height="32" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                            </svg>
                            輸血完成
                        </button>
                        <button type="button" class="blood-action-btn reaction" data-action="REACTION" onclick="selectBloodAction('REACTION')">
                            <svg width="32" height="32" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                            </svg>
                            輸血反應
                        </button>
                    </div>
                </div>

                <!-- Reaction Type (shown only when REACTION selected) -->
                <div id="bloodReactionSection" style="display: none; margin: 16px 0;">
                    <label class="form-label">反應類型</label>
                    <div class="reaction-type-buttons">
                        <button type="button" class="reaction-type-btn" data-type="FEBRILE" onclick="selectReactionType('FEBRILE')">發燒反應</button>
                        <button type="button" class="reaction-type-btn" data-type="ALLERGIC" onclick="selectReactionType('ALLERGIC')">過敏反應</button>
                        <button type="button" class="reaction-type-btn" data-type="HEMOLYTIC" onclick="selectReactionType('HEMOLYTIC')">溶血反應</button>
                    </div>
                    <textarea id="bloodReactionNote" placeholder="反應描述 (選填)" style="width: 100%; margin-top: 8px; padding: 8px; border-radius: 8px; border: 1px solid var(--border); background: var(--bg); color: var(--text); resize: none;" rows="2"></textarea>
                </div>

                <!-- Time Offset Selector -->
                <div class="time-offset-selector" id="bloodTimeSelector">
                    <div class="time-offset-label">
                        <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="10" stroke-width="2"/>
                            <path stroke-width="2" d="M12 6v6l4 2"/>
                        </svg>
                        事件時間
                    </div>
                    <div class="time-offset-buttons">
                        <button type="button" class="time-offset-btn active" data-offset="0" onclick="selectTimeOffset(this, 'blood')">現在</button>
                        <button type="button" class="time-offset-btn" data-offset="-60" onclick="selectTimeOffset(this, 'blood')">-1分</button>
                        <button type="button" class="time-offset-btn" data-offset="-180" onclick="selectTimeOffset(this, 'blood')">-3分</button>
                        <button type="button" class="time-offset-btn" data-offset="-300" onclick="selectTimeOffset(this, 'blood')">-5分</button>
                        <button type="button" class="time-offset-btn" data-offset="custom" onclick="selectTimeOffset(this, 'blood')">自訂</button>
                    </div>
                    <div class="time-offset-custom" id="bloodTimeCustom">
                        <input type="datetime-local" id="bloodCustomTime" onchange="updateComputedTime('blood')">
                    </div>
                    <div class="late-entry-reason" id="bloodLateEntry">
                        <label>遲補登錄原因 (超過5分鐘需填寫)</label>
                        <select id="bloodLateReason">
                            <option value="EMERGENCY_HANDLING">緊急處置中</option>
                            <option value="EQUIPMENT_ISSUE">設備問題</option>
                            <option value="SHIFT_HANDOFF">交班中</option>
                            <option value="DOCUMENTATION_CATCH_UP">補登文件</option>
                            <option value="OTHER">其他</option>
                        </select>
                        <input type="text" id="bloodLateNote" placeholder="備註 (選填)">
                    </div>
                    <div class="computed-time" id="bloodComputedTime" style="font-size: 1.25rem; font-weight: 600; padding: 12px; text-align: center; background: var(--bg); border-radius: 8px; margin-top: 8px;">記錄時間: 現在</div>
                </div>

                <div style="display: flex; gap: 12px; margin-top: 20px;">
                    <button class="btn" style="background: var(--card-hover); flex: 1;" onclick="backToBloodStep1()">返回</button>
                    <button class="btn btn-primary" style="flex: 2; background: #b91c1c;" onclick="submitBloodProduct()">確認記錄</button>
                </div>

                <!-- v1.1: Emergency Mode Button -->
                <div style="margin-top: 16px; padding-top: 16px; border-top: 1px dashed var(--border);">
                    <button class="btn" style="width: 100%; background: #7c2d12; border: 2px dashed #f97316; color: #fed7aa;" onclick="showEmergencyModeModal()">
                        <span style="font-size: 18px;">⚡</span> 緊急模式 (Emergency Mode)
                    </button>
                    <div style="font-size: 11px; color: var(--text-muted); text-align: center; margin-top: 4px;">
                        無法等待雙人核對或清單查詢時使用，事後需補登
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- v1.1: Emergency Mode Modal -->
    <div class="modal" id="emergencyModeModal">
        <div class="modal-content" style="max-width: 450px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #7c2d12, #991b1b);">
                <h2 class="modal-title">
                    <span style="font-size: 24px;">⚡</span> 緊急模式
                </h2>
                <button class="modal-close" onclick="closeModal('emergencyModeModal')">&times;</button>
            </div>
            <div style="padding: 20px;">
                <div style="background: rgba(249, 115, 22, 0.1); border: 1px solid #f97316; border-radius: 8px; padding: 12px; margin-bottom: 16px;">
                    <div style="font-weight: 600; color: #f97316; margin-bottom: 4px;">⚠️ 緊急模式說明</div>
                    <div style="font-size: 13px; color: var(--text-muted);">
                        緊急模式允許在無法完成標準雙人核對時快速輸血。<br>
                        使用後 <strong>24 小時內</strong> 必須完成事後覆核。
                    </div>
                </div>

                <!-- Emergency Reason -->
                <div class="form-group" style="margin-bottom: 16px;">
                    <label class="form-label">緊急原因 *</label>
                    <select id="emergencyReason" class="form-input" style="padding: 12px;">
                        <option value="">-- 選擇原因 --</option>
                        <option value="MTP_ACTIVATED">MTP 大量輸血啟動</option>
                        <option value="EXSANGUINATING_HEMORRHAGE">出血性休克</option>
                        <option value="NO_SECOND_STAFF">無第二人員可協助</option>
                        <option value="SYSTEM_OFFLINE">系統離線</option>
                        <option value="EQUIPMENT_FAILURE">設備故障</option>
                        <option value="OTHER">其他</option>
                    </select>
                </div>

                <!-- Emergency Reason Note (shown when OTHER selected) -->
                <div id="emergencyReasonNoteSection" class="form-group" style="display: none; margin-bottom: 16px;">
                    <label class="form-label">其他原因說明 *</label>
                    <input type="text" id="emergencyReasonNote" class="form-input" placeholder="請說明緊急原因">
                </div>

                <!-- Blood Unit Scan -->
                <div class="form-group" style="margin-bottom: 16px;">
                    <label class="form-label">血袋條碼 (掃描或輸入)</label>
                    <input type="text" id="emergencyUnitId" class="form-input" placeholder="掃描血袋條碼..." style="font-size: 1.1rem; font-family: monospace; padding: 12px;">
                </div>

                <!-- Actor ID -->
                <div class="form-group" style="margin-bottom: 16px;">
                    <label class="form-label">執行人員工號 *</label>
                    <input type="text" id="emergencyActorId" class="form-input" placeholder="您的工號/Badge">
                </div>

                <div style="display: flex; gap: 12px; margin-top: 20px;">
                    <button class="btn" style="background: var(--card-hover); flex: 1;" onclick="closeModal('emergencyModeModal')">取消</button>
                    <button class="btn" style="flex: 2; background: #dc2626; font-weight: 600;" onclick="submitEmergencyTransfusion()">
                        ⚡ 啟動緊急輸血
                    </button>
                </div>

                <div style="font-size: 11px; color: #f97316; text-align: center; margin-top: 12px; padding: 8px; background: rgba(249, 115, 22, 0.1); border-radius: 6px;">
                    📋 緊急輸血將自動補齊缺失的發血、傳送步驟<br>
                    事後覆核提醒將在 24 小時後發送
                </div>
            </div>
        </div>
    </div>

    <!-- Blood Type Mismatch Warning Modal -->
    <div class="modal" id="bloodMismatchModal">
        <div class="modal-content" style="max-width: 400px; text-align: center;">
            <div style="padding: 20px;">
                <div style="font-size: 64px; margin-bottom: 16px;">⛔</div>
                <h2 style="color: #ef4444; margin-bottom: 16px;">血型不符警告！</h2>
                <div id="mismatchDetails" style="background: rgba(239, 68, 68, 0.1); padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                    <div style="font-size: 24px; font-weight: 600; margin-bottom: 8px;">
                        血袋血型: <span id="mismatchUnitType" style="color: #ef4444;">--</span>
                    </div>
                    <div style="font-size: 24px; font-weight: 600;">
                        病人血型: <span id="mismatchPatientType" style="color: #22c55e;">--</span>
                    </div>
                </div>
                <p style="color: #f59e0b; margin-bottom: 20px;">
                    ⚠️ 請立即停止，確認是否拿錯血袋
                </p>
                <button class="btn" style="width: 100%; background: #ef4444; padding: 14px;" onclick="closeModal('bloodMismatchModal')">
                    我了解，關閉
                </button>
            </div>
        </div>
    </div>

    <!-- Custody Chain Timeline Modal (Phase 3) -->
    <div class="modal" id="custodyTimelineModal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2 class="modal-title">血袋追蹤</h2>
                <button class="modal-close" onclick="closeModal('custodyTimelineModal')">&times;</button>
            </div>
            <div id="custodyTimelineContent" style="padding: 16px;">
                <!-- Timeline will be populated dynamically -->
            </div>
        </div>
    </div>

    <style>
        /* Blood Modal Styles */
        .blood-type-badge {
            background: #b91c1c;
            color: white;
            padding: 4px 10px;
            border-radius: 6px;
            font-weight: 600;
            font-size: 0.875rem;
        }

        .med-btn.blood-btn {
            border-left: 3px solid #b91c1c;
        }

        .blood-action-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .blood-action-btn {
            flex: 1;
            min-width: 100px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: 12px;
            background: var(--card);
            color: var(--text);
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .blood-action-btn:hover {
            background: var(--card-hover);
        }

        .blood-action-btn.active {
            border-color: var(--primary);
            background: rgba(37, 99, 235, 0.1);
            color: var(--primary);
        }

        .blood-action-btn.reaction {
            border-color: var(--danger);
        }

        .blood-action-btn.reaction.active {
            border-color: var(--danger);
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
        }

        .reaction-type-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .reaction-type-btn {
            flex: 1;
            padding: 10px;
            border: 2px solid var(--border);
            border-radius: 8px;
            background: var(--card);
            color: var(--text);
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .reaction-type-btn:hover {
            background: var(--card-hover);
        }

        .reaction-type-btn.active {
            border-color: var(--danger);
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
        }
    </style>

    <!-- Vasoactive Bolus Modal -->
    <div class="modal" id="vasoactiveModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>昇壓劑 / 血管活性藥物</h3>
                <button class="close-btn" onclick="closeModal('vasoactiveModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">選擇藥物</label>
                    <div class="med-list" style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                        <button class="med-btn" onclick="selectVasoactive('EPHEDRINE', 5, 'mg')" style="border-left: 3px solid #7c3aed;">
                            <div class="med-name">Ephedrine</div>
                            <div class="med-dose">5 mg IV</div>
                        </button>
                        <button class="med-btn" onclick="selectVasoactive('EPHEDRINE', 10, 'mg')" style="border-left: 3px solid #7c3aed;">
                            <div class="med-name">Ephedrine</div>
                            <div class="med-dose">10 mg IV</div>
                        </button>
                        <button class="med-btn" onclick="selectVasoactive('PHENYLEPHRINE', 50, 'mcg')" style="border-left: 3px solid #7c3aed;">
                            <div class="med-name">Phenylephrine</div>
                            <div class="med-dose">50 mcg IV</div>
                        </button>
                        <button class="med-btn" onclick="selectVasoactive('PHENYLEPHRINE', 100, 'mcg')" style="border-left: 3px solid #7c3aed;">
                            <div class="med-name">Phenylephrine</div>
                            <div class="med-dose">100 mcg IV</div>
                        </button>
                        <button class="med-btn" onclick="selectVasoactive('ATROPINE', 0.5, 'mg')" style="border-left: 3px solid #7c3aed;">
                            <div class="med-name">Atropine</div>
                            <div class="med-dose">0.5 mg IV</div>
                        </button>
                        <button class="med-btn" onclick="selectVasoactive('GLYCOPYRROLATE', 0.2, 'mg')" style="border-left: 3px solid #7c3aed;">
                            <div class="med-name">Glycopyrrolate</div>
                            <div class="med-dose">0.2 mg IV</div>
                        </button>
                        <button class="med-btn" onclick="selectVasoactive('NOREPINEPHRINE', 4, 'mcg')" style="border-left: 3px solid #dc2626;">
                            <div class="med-name">Norepinephrine</div>
                            <div class="med-dose">4 mcg IV</div>
                        </button>
                        <button class="med-btn" onclick="selectVasoactive('EPINEPHRINE', 10, 'mcg')" style="border-left: 3px solid #dc2626;">
                            <div class="med-name">Epinephrine</div>
                            <div class="med-dose">10 mcg IV</div>
                        </button>
                    </div>
                </div>
                <div class="form-group" style="margin-top: 16px;">
                    <label class="form-label">適應症</label>
                    <select class="form-input" id="vasoactiveIndication">
                        <option value="HYPOTENSION">低血壓 (MAP &lt; 65)</option>
                        <option value="BRADYCARDIA">心跳過慢 (HR &lt; 50)</option>
                        <option value="INDUCTION">麻醉誘導</option>
                        <option value="POSITIONING">姿勢改變</option>
                        <option value="BLEEDING">出血</option>
                        <option value="OTHER">其他</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <!-- Vent Settings Modal -->
    <div class="modal" id="ventModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>呼吸器參數調整</h3>
                <button class="close-btn" onclick="closeModal('ventModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">調整項目</label>
                    <select class="form-input" id="ventParameter" onchange="updateVentInputs()">
                        <option value="FIO2">FiO2 (吸入氧濃度)</option>
                        <option value="PEEP">PEEP (吐氣末正壓)</option>
                        <option value="VT">VT (潮氣量)</option>
                        <option value="RR">RR (呼吸速率)</option>
                        <option value="PIP_LIMIT">PIP Limit (尖峰壓力上限)</option>
                    </select>
                </div>
                <div class="form-group" style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    <div>
                        <label class="form-label">原設定</label>
                        <input type="number" class="form-input" id="ventFromValue" placeholder="原值">
                    </div>
                    <div>
                        <label class="form-label">新設定</label>
                        <input type="number" class="form-input" id="ventToValue" placeholder="新值">
                    </div>
                </div>
                <div id="ventUnitHint" style="font-size: 0.75rem; color: var(--text-muted); margin-top: -8px;">單位: %</div>
                <div class="form-group" style="margin-top: 12px;">
                    <label class="form-label">調整原因</label>
                    <select class="form-input" id="ventReason">
                        <option value="">選擇原因 (選填)</option>
                        <option value="HYPOXIA">低血氧</option>
                        <option value="HYPERCARBIA">高二氧化碳</option>
                        <option value="HYPOCARBIA">低二氧化碳</option>
                        <option value="HIGH_AIRWAY_PRESSURE">氣道壓力過高</option>
                        <option value="RECRUITMENT">肺復張</option>
                        <option value="WEANING">脫離準備</option>
                    </select>
                </div>
                <button class="btn btn-primary" style="width: 100%; margin-top: 16px; background: #0891b2;" onclick="submitVentChange()">記錄調整</button>
            </div>
        </div>
    </div>

    <!-- Anesthesia Depth Modal -->
    <div class="modal" id="depthModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>麻醉深度調整</h3>
                <button class="close-btn" onclick="closeModal('depthModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">調整方向</label>
                    <div style="display: flex; gap: 12px;">
                        <button class="btn" id="btnDeepen" onclick="setDepthAction('DEEPEN')" style="flex: 1; background: #7c3aed;">加深</button>
                        <button class="btn" id="btnLighten" onclick="setDepthAction('LIGHTEN')" style="flex: 1; background: var(--card-hover);">減淺</button>
                    </div>
                </div>
                <div class="form-group" style="margin-top: 16px;">
                    <label class="form-label">調整方式</label>
                    <select class="form-input" id="depthMethod" onchange="updateDepthInputs()">
                        <option value="VOLATILE">吸入麻醉劑 (MAC)</option>
                        <option value="IV_BOLUS">靜脈追加 (Bolus)</option>
                        <option value="IV_INFUSION">靜脈輸注調整</option>
                    </select>
                </div>
                <div id="depthVolatileInputs">
                    <div class="form-group" style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                        <div>
                            <label class="form-label">MAC 從</label>
                            <input type="number" step="0.1" class="form-input" id="macFrom" placeholder="例: 1.0">
                        </div>
                        <div>
                            <label class="form-label">MAC 到</label>
                            <input type="number" step="0.1" class="form-input" id="macTo" placeholder="例: 1.2">
                        </div>
                    </div>
                </div>
                <div id="depthBolusInputs" style="display: none;">
                    <div class="form-group">
                        <label class="form-label">Bolus 藥物</label>
                        <input type="text" class="form-input" id="bolusAgent" placeholder="例: Propofol 30mg">
                    </div>
                </div>
                <div class="form-group" style="margin-top: 12px;">
                    <label class="form-label">原因</label>
                    <select class="form-input" id="depthReason">
                        <option value="">選擇原因 (選填)</option>
                        <option value="PATIENT_MOVEMENT">病人體動</option>
                        <option value="BP_HR_SPIKE">血壓/心跳上升</option>
                        <option value="BIS_HIGH">BIS 過高</option>
                        <option value="BIS_LOW">BIS 過低</option>
                        <option value="SURGICAL_STIMULUS">手術刺激</option>
                        <option value="EMERGENCE_PREP">甦醒準備</option>
                    </select>
                </div>
                <button class="btn btn-primary" style="width: 100%; margin-top: 16px;" onclick="submitDepthAdjust()">記錄調整</button>
            </div>
        </div>
    </div>

    <!-- Position Change Modal -->
    <div class="modal" id="positionModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>姿勢調整</h3>
                <button class="close-btn" onclick="closeModal('positionModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">選擇姿勢</label>
                    <div class="med-list" style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                        <button class="med-btn" onclick="submitPosition('SUPINE')">
                            <div class="med-name">仰臥</div>
                            <div class="med-dose">Supine</div>
                        </button>
                        <button class="med-btn" onclick="submitPosition('PRONE')">
                            <div class="med-name">俯臥</div>
                            <div class="med-dose">Prone</div>
                        </button>
                        <button class="med-btn" onclick="submitPosition('LEFT_LATERAL')">
                            <div class="med-name">左側臥</div>
                            <div class="med-dose">Left Lateral</div>
                        </button>
                        <button class="med-btn" onclick="submitPosition('RIGHT_LATERAL')">
                            <div class="med-name">右側臥</div>
                            <div class="med-dose">Right Lateral</div>
                        </button>
                        <button class="med-btn" onclick="submitPosition('LITHOTOMY')">
                            <div class="med-name">截石位</div>
                            <div class="med-dose">Lithotomy</div>
                        </button>
                        <button class="med-btn" onclick="submitPosition('TRENDELENBURG')">
                            <div class="med-name">頭低腳高</div>
                            <div class="med-dose">Trendelenburg</div>
                        </button>
                        <button class="med-btn" onclick="submitPosition('REVERSE_TRENDELENBURG')">
                            <div class="med-name">頭高腳低</div>
                            <div class="med-dose">Reverse Trend.</div>
                        </button>
                        <button class="med-btn" onclick="submitPosition('SITTING')">
                            <div class="med-name">坐姿</div>
                            <div class="med-dose">Sitting</div>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Special Technique Modal (v1.1 Billing Integration) -->
    <div class="modal" id="techniqueModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>特殊技術記錄</h3>
                <button class="close-btn" onclick="closeModal('techniqueModal')">&times;</button>
            </div>
            <div class="modal-body">
                <p style="color: var(--text-secondary); font-size: 13px; margin-bottom: 12px;">選擇已執行的特殊技術 (可複選，用於計費)</p>
                <div class="technique-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                    <label class="technique-toggle" id="techCVP">
                        <input type="checkbox" value="CVP" onchange="toggleTechnique(this)">
                        <div class="technique-card">
                            <div class="technique-name">CVP</div>
                            <div class="technique-desc">中央靜脈導管</div>
                        </div>
                    </label>
                    <label class="technique-toggle" id="techART">
                        <input type="checkbox" value="ART" onchange="toggleTechnique(this)">
                        <div class="technique-card">
                            <div class="technique-name">A-Line</div>
                            <div class="technique-desc">動脈導管</div>
                        </div>
                    </label>
                    <label class="technique-toggle" id="techTEE">
                        <input type="checkbox" value="TEE" onchange="toggleTechnique(this)">
                        <div class="technique-card">
                            <div class="technique-name">TEE</div>
                            <div class="technique-desc">經食道心超</div>
                        </div>
                    </label>
                    <label class="technique-toggle" id="techBIS">
                        <input type="checkbox" value="BIS" onchange="toggleTechnique(this)">
                        <div class="technique-card">
                            <div class="technique-name">BIS</div>
                            <div class="technique-desc">腦電雙頻指數</div>
                        </div>
                    </label>
                    <label class="technique-toggle" id="techULTRASOUND">
                        <input type="checkbox" value="ULTRASOUND" onchange="toggleTechnique(this)">
                        <div class="technique-card">
                            <div class="technique-name">超音波導引</div>
                            <div class="technique-desc">Ultrasound-guided</div>
                        </div>
                    </label>
                    <label class="technique-toggle" id="techFIBER">
                        <input type="checkbox" value="FIBER_INTUB" onchange="toggleTechnique(this)">
                        <div class="technique-card">
                            <div class="technique-name">纖維插管</div>
                            <div class="technique-desc">Fiberoptic Intub.</div>
                        </div>
                    </label>
                    <label class="technique-toggle" id="techDLT">
                        <input type="checkbox" value="DLT" onchange="toggleTechnique(this)">
                        <div class="technique-card">
                            <div class="technique-name">DLT</div>
                            <div class="technique-desc">雙腔氣管內管</div>
                        </div>
                    </label>
                    <label class="technique-toggle" id="techNERVE">
                        <input type="checkbox" value="NERVE_BLOCK" onchange="toggleTechnique(this)">
                        <div class="technique-card">
                            <div class="technique-name">神經阻斷</div>
                            <div class="technique-desc">Nerve Block</div>
                        </div>
                    </label>
                </div>
                <div style="margin-top: 16px; display: flex; gap: 12px;">
                    <button class="btn btn-primary" onclick="saveTechniques()">儲存記錄</button>
                    <button class="btn" style="background: var(--card-hover);" onclick="closeModal('techniqueModal')">取消</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Case Info Modal (v1.1 - ASA/Technique editing) -->
    <div class="modal" id="editCaseInfoModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>編輯麻醉資訊</h3>
                <button class="close-btn" onclick="closeModal('editCaseInfoModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">麻醉方式</label>
                    <select class="form-input" id="editTechnique">
                        <option value="GA">全身麻醉 (GA)</option>
                        <option value="GA_ETT">全身麻醉 - 插管 (ETT)</option>
                        <option value="GA_LMA">全身麻醉 - 喉罩 (LMA)</option>
                        <option value="RA_SPINAL">脊椎麻醉 (Spinal)</option>
                        <option value="RA_EPIDURAL">硬膜外麻醉 (Epidural)</option>
                        <option value="RA_NERVE">神經阻斷 (Nerve Block)</option>
                        <option value="MAC">監測麻醉照護 (MAC)</option>
                        <option value="LA">局部麻醉 (Local)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">ASA 分級</label>
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <select class="form-input" id="editAsaClass" style="flex: 1;">
                            <option value="I">ASA I - 健康</option>
                            <option value="II">ASA II - 輕度全身疾病</option>
                            <option value="III">ASA III - 嚴重全身疾病</option>
                            <option value="IV">ASA IV - 危及生命</option>
                            <option value="V">ASA V - 瀕死</option>
                        </select>
                        <label style="display: flex; align-items: center; gap: 4px; white-space: nowrap; font-size: 14px;">
                            <input type="checkbox" id="editAsaEmergency" style="width: 18px; height: 18px;">
                            <span style="color: var(--warning-color);">+E 急診</span>
                        </label>
                    </div>
                </div>
                <div style="margin-top: 20px; display: flex; gap: 12px;">
                    <button class="btn btn-primary" onclick="saveEditCaseInfo()">儲存</button>
                    <button class="btn" style="background: var(--card-hover);" onclick="closeModal('editCaseInfoModal')">取消</button>
                </div>
            </div>
        </div>
    </div>

    <style>
        /* Special Technique Modal Styles */
        .technique-toggle {
            display: block;
            cursor: pointer;
        }
        .technique-toggle input[type="checkbox"] {
            display: none;
        }
        .technique-card {
            background: var(--card);
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 12px;
            text-align: center;
            transition: all 0.2s;
        }
        .technique-card:hover {
            background: var(--card-hover);
        }
        .technique-toggle input:checked + .technique-card {
            background: rgba(124, 58, 237, 0.15);
            border-color: #7c3aed;
        }
        .technique-toggle input:checked + .technique-card .technique-name {
            color: #7c3aed;
        }
        .technique-name {
            font-weight: 600;
            font-size: 14px;
        }
        .technique-desc {
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: 4px;
        }
    </style>

    <style>
        /* Phase C: O2 Modal Styles */
        .o2-current-status {
            background: var(--bg);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
        }
        .o2-cylinder-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: var(--card);
            border-radius: 8px;
            border-left: 3px solid var(--primary);
            cursor: pointer;
            transition: all 0.2s;
        }
        .o2-cylinder-item:hover {
            background: var(--card-hover);
        }
        .o2-cylinder-item.claimed {
            border-left-color: var(--warning);
            opacity: 0.6;
            cursor: not-allowed;
        }
        .o2-cylinder-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .o2-cylinder-serial {
            font-weight: 600;
        }
        .o2-cylinder-level {
            font-size: 0.875rem;
            color: var(--text-muted);
        }
        .o2-level-bar {
            width: 60px;
            height: 8px;
            background: var(--border);
            border-radius: 4px;
            overflow: hidden;
        }
        .o2-level-fill {
            height: 100%;
            background: var(--primary);
            transition: width 0.3s;
        }
        .o2-level-fill.low {
            background: var(--warning);
        }
        .o2-level-fill.critical {
            background: var(--danger);
        }
        .o2-item:hover {
            background: rgba(255,255,255,0.1);
        }
    </style>

    <style>
        /* Phase B: Drug Modal Styles */
        .holdings-summary {
            background: var(--bg);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
        }
        .holdings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            font-weight: 600;
        }
        .holdings-status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .holdings-status.reconciled {
            background: #71717a;
            color: white;
        }
        .holdings-status.pending {
            background: var(--controlled);
            color: white;
        }
        .holdings-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .holding-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: var(--card);
            border-radius: 8px;
            border-left: 3px solid var(--controlled);
        }
        .holding-drug-name {
            font-weight: 500;
        }
        .holding-balance {
            font-weight: 700;
            color: var(--controlled);
        }
        .holding-balance.zero {
            color: #71717a;
        }
        .drug-actions {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-bottom: 16px;
        }
        .drug-action-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 12px 8px;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-size: 0.75rem;
            cursor: pointer;
        }
        .drug-action-btn:active {
            background: var(--card-hover);
        }
        .drug-available {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 4px;
        }
        .form-hint {
            font-size: 0.75rem;
            color: var(--controlled);
            margin-top: 4px;
        }
        .btn.controlled {
            background: var(--controlled);
        }
        .btn.controlled:active {
            background: var(--controlled-dark);
        }
        .tx-history {
            max-height: 200px;
            overflow-y: auto;
        }
        .tx-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 12px;
            border-bottom: 1px solid var(--border);
        }
        .tx-item:last-child {
            border-bottom: none;
        }
        .tx-type {
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 600;
        }
        .tx-type.DISPENSE { background: #6366f1; color: white; }
        .tx-type.ADMIN { background: var(--controlled); color: white; }
        .tx-type.WASTE { background: #71717a; color: white; }
        .tx-type.RETURN { background: #52525b; color: white; }
        .tx-info {
            flex: 1;
            margin-left: 8px;
        }
        .tx-drug {
            font-weight: 500;
            font-size: 0.875rem;
        }
        .tx-detail {
            font-size: 0.75rem;
            color: var(--text-muted);
        }
        .tx-amount {
            font-weight: 600;
            text-align: right;
        }
    </style>

    <style>
        .preop-flag {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .preop-flag:hover {
            background: var(--card-hover);
        }
        .preop-flag input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin-right: 12px;
        }
        .preop-flag input[type="checkbox"]:checked + .flag-label {
            color: var(--warning);
        }
        .flag-label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1rem;
        }
        .flag-icon {
            flex-shrink: 0;
        }
        .flag-icon.warning-icon { color: #a1a1aa; }
        .flag-icon.danger-icon { color: #71717a; }

        /* Phase A-6: Sync Indicator Styles */
        .sync-indicator {
            display: flex;
            align-items: center;
            margin-left: auto;
            padding: 4px 8px;
            border-radius: 4px;
            background: rgba(255,255,255,0.1);
        }
        .sync-icon {
            font-size: 1rem;
        }
        .sync-indicator.syncing .sync-icon {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .animate-spin {
            animation: spin 1s linear infinite;
        }
        .sync-badge {
            background: #a1a1aa;
            color: #18181b;
            font-size: 0.7rem;
            font-weight: bold;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: 4px;
        }
        .sync-badge.hidden {
            display: none;
        }

        /* Offline mode indicator */
        body.offline::before {
            content: '離線模式 - 操作將在連線後同步';
            display: block;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            padding: 8px 8px 8px 32px;
            background: #52525b;
            color: #f1f5f9;
            text-align: center;
            font-size: 0.875rem;
            font-weight: 500;
            z-index: 1000;
        }
        body.offline .header {
            margin-top: 36px;
        }
    </style>

    <!-- v2.1: IV/IO Modal Styles -->
    <style>
        .ivio-section { margin-bottom: 20px; }
        .ivio-section-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-muted);
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .iv-line-card {
            background: var(--bg);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            border-left: 3px solid #22c55e;
        }
        .iv-line-card.removed {
            border-left-color: var(--border);
            opacity: 0.5;
        }
        .iv-line-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        .iv-line-site { font-weight: 600; }
        .iv-line-gauge { font-size: 0.75rem; color: var(--text-muted); }
        .iv-rate-control {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 8px;
        }
        .iv-rate-input {
            width: 80px;
            padding: 6px;
            border-radius: 4px;
            border: 1px solid var(--border);
            background: var(--card);
            color: var(--text);
            text-align: center;
        }
        .io-balance-card {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
        }
        .io-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid var(--border);
        }
        .io-row:last-child { border-bottom: none; }
        .io-label { color: var(--text-muted); }
        .io-value { font-weight: 600; }
        .io-value.positive { color: #22c55e; }
        .io-value.negative { color: #ef4444; }
        .monitor-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            border-radius: 16px;
            font-size: 0.75rem;
            background: rgba(139, 92, 246, 0.2);
            color: #a78bfa;
            margin-right: 6px;
            margin-bottom: 6px;
        }
        .monitor-badge.foley { background: rgba(251, 191, 36, 0.2); color: #fbbf24; }
        .monitor-badge.air { background: rgba(56, 189, 248, 0.2); color: #38bdf8; }
        .fluid-quick-btn {
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid var(--border);
            background: var(--card);
            color: var(--text);
            font-size: 0.75rem;
            cursor: pointer;
            margin-right: 6px;
            margin-bottom: 6px;
        }
        .fluid-quick-btn:hover { background: var(--card-hover); }
    </style>

    <!-- v2.1: IV/IO Modal -->
    <div class="modal" id="ivioModal">
        <div class="modal-content" style="max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h2 class="modal-title">IV 管路 / I-O Balance</h2>
                <button class="modal-close" onclick="closeModal('ivioModal')">&times;</button>
            </div>

            <!-- I/O Balance Summary -->
            <div class="io-balance-card">
                <div style="font-weight: 600; margin-bottom: 12px;">I/O Balance</div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div>
                        <div style="font-size: 0.75rem; color: var(--text-muted);">輸入 Input</div>
                        <div id="ioInputTotal" style="font-size: 1.5rem; font-weight: 700;">0 ml</div>
                        <div id="ioInputBreakdown" style="font-size: 0.75rem; color: var(--text-muted);"></div>
                    </div>
                    <div>
                        <div style="font-size: 0.75rem; color: var(--text-muted);">輸出 Output</div>
                        <div id="ioOutputTotal" style="font-size: 1.5rem; font-weight: 700;">0 ml</div>
                        <div id="ioOutputBreakdown" style="font-size: 0.75rem; color: var(--text-muted);"></div>
                    </div>
                </div>
                <div style="text-align: center; margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border);">
                    <span style="font-size: 0.875rem; color: var(--text-muted);">淨平衡</span>
                    <div id="ioNetBalance" style="font-size: 1.75rem; font-weight: 700; color: #22c55e;">+0 ml</div>
                </div>
            </div>

            <!-- Active Monitors -->
            <div class="ivio-section">
                <div class="ivio-section-title">
                    <span>監測器</span>
                    <button class="btn-small" onclick="showAddMonitorDialog()">+ 新增</button>
                </div>
                <div id="monitorsList" style="display: flex; flex-wrap: wrap; gap: 8px;"></div>
            </div>

            <!-- Urine Output (if Foley active) -->
            <div class="ivio-section" id="urineSection" style="display: none;">
                <div class="ivio-section-title">
                    <span>尿量記錄</span>
                    <span id="urineTotalDisplay" style="color: #fbbf24;">累計: 0 ml</span>
                </div>
                <div style="display: flex; gap: 12px; align-items: center;">
                    <input type="number" id="urineAmountInput" class="form-input" placeholder="輸入 ml" style="flex: 1; margin: 0;">
                    <button onclick="recordUrineOutput()" class="btn btn-primary" style="width: auto; padding: 16px 24px;">記錄</button>
                </div>
            </div>

            <!-- IV Lines -->
            <div class="ivio-section">
                <div class="ivio-section-title">
                    <span>IV 管路</span>
                    <button class="btn-small" onclick="showAddIVLineDialog()">+ 插入</button>
                </div>
                <div id="ivLinesList"></div>
            </div>

            <!-- Quick Fluid Buttons -->
            <div class="ivio-section">
                <div class="ivio-section-title">快速輸液</div>
                <div id="quickFluidButtons">
                    <button class="fluid-quick-btn" onclick="quickFluid('N/S', 500)">N/S 500ml</button>
                    <button class="fluid-quick-btn" onclick="quickFluid('L/R', 500)">L/R 500ml</button>
                    <button class="fluid-quick-btn" onclick="quickFluid('D5W', 500)">D5W 500ml</button>
                    <button class="fluid-quick-btn" onclick="quickFluid('pRBC', 250)">pRBC 1U</button>
                    <button class="fluid-quick-btn" onclick="quickFluid('FFP', 200)">FFP 1U</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add IV Line Dialog -->
    <div class="modal" id="addIVLineModal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h2 class="modal-title">插入 IV 管路</h2>
                <button class="modal-close" onclick="closeModal('addIVLineModal')">&times;</button>
            </div>
            <form onsubmit="event.preventDefault(); insertIVLine();">
                <div class="form-group">
                    <label class="form-label">部位 *</label>
                    <select id="ivSiteSelect" class="form-input" required>
                        <option value="">選擇...</option>
                        <option value="左手背">左手背</option>
                        <option value="右手背">右手背</option>
                        <option value="左前臂">左前臂</option>
                        <option value="右前臂">右前臂</option>
                        <option value="左肘正中">左肘正中</option>
                        <option value="右肘正中">右肘正中</option>
                        <option value="頸部CVC">頸部 CVC</option>
                        <option value="鎖骨下CVC">鎖骨下 CVC</option>
                        <option value="股靜脈CVC">股靜脈 CVC</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Gauge</label>
                    <select id="ivGaugeSelect" class="form-input">
                        <option value="">選擇...</option>
                        <option value="24G">24G</option>
                        <option value="22G">22G</option>
                        <option value="20G" selected>20G</option>
                        <option value="18G">18G</option>
                        <option value="16G">16G</option>
                        <option value="14G">14G</option>
                        <option value="CVC">CVC</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">初始滴速 (ml/hr)</label>
                    <input type="number" id="ivRateInput" class="form-input" placeholder="100">
                </div>
                <button type="submit" class="btn btn-primary">插入 IV</button>
            </form>
        </div>
    </div>

    <!-- Add Monitor Dialog -->
    <div class="modal" id="addMonitorModal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h2 class="modal-title">啟動監測器</h2>
                <button class="modal-close" onclick="closeModal('addMonitorModal')">&times;</button>
            </div>
            <form onsubmit="event.preventDefault(); startMonitor();">
                <div class="form-group">
                    <label class="form-label">類型 *</label>
                    <select id="monitorTypeSelect" class="form-input" required onchange="onMonitorTypeChange()">
                        <option value="">選擇...</option>
                        <option value="EKG">EKG 心電圖</option>
                        <option value="SPO2">SpO2 血氧</option>
                        <option value="NIBP">NIBP 血壓</option>
                        <option value="IBP">IBP A-line</option>
                        <option value="FOLEY">Foley 導尿管</option>
                        <option value="AIR_BLANKET">保溫毯</option>
                        <option value="BIS">BIS 麻醉深度</option>
                        <option value="ETCO2">EtCO2</option>
                        <option value="NMT">NMT 肌鬆</option>
                    </select>
                </div>
                <div class="form-group" id="foleySettingsDiv" style="display: none;">
                    <label class="form-label">Foley Size</label>
                    <select id="foleySizeSelect" class="form-input">
                        <option value="14Fr">14 Fr</option>
                        <option value="16Fr" selected>16 Fr</option>
                        <option value="18Fr">18 Fr</option>
                    </select>
                </div>
                <div class="form-group" id="airBlanketSettingsDiv" style="display: none;">
                    <label class="form-label">溫度設定</label>
                    <select id="airBlanketTempSelect" class="form-input">
                        <option value="LOW">低溫 (32-34°C)</option>
                        <option value="MEDIUM" selected>中溫 (36-38°C)</option>
                        <option value="HIGH">高溫 (40-43°C)</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary">啟動監測</button>
            </form>
        </div>
    </div>

    <!-- v2.1: PDF Preview Modal (for Vercel Demo) -->
    <div class="modal" id="pdfPreviewModal">
        <div class="modal-content" style="max-width: 95vw; max-height: 95vh; width: 1000px; height: 90vh; display: flex; flex-direction: column;">
            <div class="modal-header" style="flex-shrink: 0;">
                <h2 class="modal-title">麻醉紀錄預覽 (M0073)</h2>
                <button class="modal-close" onclick="closePDFPreviewModal()">&times;</button>
            </div>

            <!-- Vercel Demo Notice -->
            <div style="background: linear-gradient(135deg, #e0f2fe 0%, #bae6fd 100%); border: 1px solid #0ea5e9; border-radius: 8px; padding: 12px 16px; margin: 12px 16px 0 16px; flex-shrink: 0;">
                <div style="display: flex; align-items: flex-start; gap: 10px;">
                    <svg style="width: 20px; height: 20px; color: #0284c7; flex-shrink: 0; margin-top: 2px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                    </svg>
                    <div style="color: #0369a1; font-size: 0.875rem;">
                        <strong style="display: block; margin-bottom: 4px;">麻醉紀錄預覽</strong>
                        <span>麻醉師可在此檢視紀錄內容。如需列印或下載，請使用下方按鈕。</span>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div style="display: flex; gap: 12px; padding: 16px; flex-shrink: 0; border-bottom: 1px solid var(--border);">
                <button onclick="openPDFInNewTab()" class="btn btn-primary" style="flex: 1; display: flex; align-items: center; justify-content: center; gap: 8px;">
                    <svg style="width: 20px; height: 20px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                    </svg>
                    開啟新視窗
                </button>
                <button onclick="printPDFPreview()" class="btn btn-primary" style="flex: 1; display: flex; align-items: center; justify-content: center; gap: 8px; background: #10b981;">
                    <svg style="width: 20px; height: 20px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path>
                    </svg>
                    列印
                </button>
                <button id="pdfDownloadBtn" onclick="downloadPDFDirect(currentCase?.id)" class="btn" style="flex: 1; display: flex; align-items: center; justify-content: center; gap: 8px; background: #6366f1; border-color: #6366f1; color: white;">
                    <svg style="width: 20px; height: 20px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    下載 PDF
                </button>
            </div>

            <!-- Preview iframe -->
            <input type="hidden" id="pdfPreviewUrl" value="">
            <iframe id="pdfPreviewFrame" style="flex: 1; border: none; background: #f5f5f5;" src="about:blank"></iframe>

            <!-- Footer Info -->
            <div style="padding: 8px 16px; background: var(--bg-secondary); border-top: 1px solid var(--border); font-size: 0.75rem; color: var(--text-muted); flex-shrink: 0;">
                <strong>RPi5 部署版本</strong>：支援 WeasyPrint 直接產生 PDF 並自動下載，無需手動列印。
            </div>
        </div>
    </div>

    <!-- xIRS SDK v1.1 (Strangler Pattern Phase 1) -->
    <script src="/shared/sdk/xirs-config.js"></script>
    <script src="/shared/sdk/xirs-api.js"></script>
    <script src="/shared/sdk/xirs-bus.js"></script>
    <script src="/shared/sdk/xirs-offline.js"></script>
    <script src="/shared/sdk/xirs-ui.js"></script>
    <script src="/shared/sdk/index.js"></script>

    <script>
        // State
        let currentCase = null;
        let actorId = 'ANES001'; // TODO: Get from auth
        let isOnline = navigator.onLine;
        let syncQueue = [];
        let deviceId = localStorage.getItem('deviceId') || generateDeviceId();

        const API_BASE = '/api/anesthesia';
        // Detect Vercel demo mode
        const IS_VERCEL_DEMO = window.location.hostname.includes('vercel.app') || window.location.hostname.includes('vercel.dev');

        // Demo patients for Vercel mode
        const DEMO_CIRS_PATIENTS = [
            {
                registration_id: 'REG-DEMO-001',
                patient_id: 'P-DEMO-001',
                name: '王大明',
                triage_category: '3',
                priority: 'ROUTINE',
                chief_complaint: '右股骨頸骨折，需術前麻醉評估',
                anesthesia_notes: '患者有高血壓病史',
                consultation_by: '陳醫師',
                waiting_minutes: 45
            },
            {
                registration_id: 'REG-DEMO-002',
                patient_id: 'P-DEMO-002',
                name: '林小華',
                triage_category: '2',
                priority: 'URGENT',
                chief_complaint: '急性闘尾炎，需緊急手術',
                anesthesia_notes: '禁食6小時以上',
                consultation_by: '張醫師',
                waiting_minutes: 15
            },
            {
                registration_id: 'REG-DEMO-003',
                patient_id: 'P-DEMO-003',
                name: '陳志明',
                triage_category: '2',
                priority: 'URGENT',
                chief_complaint: '左脛骨開放性骨折，需 ORIF',
                anesthesia_notes: '建議全身麻醉',
                consultation_by: '李醫師',
                waiting_minutes: 90
            }
        ];

        // =================================================================
        // v1.6.1: Time Offset Helper Functions
        // =================================================================

        // Track selected time offset per modal (vitals, med, milestone, blood, etc.)
        const timeOffsetState = {
            vitals: { offset: 0, customTime: null },
            med: { offset: 0, customTime: null },
            milestone: { offset: 0, customTime: null },
            blood: { offset: 0, customTime: null }
        };

        function selectTimeOffset(btn, modalType) {
            const container = btn.closest('.time-offset-selector');
            const buttons = container.querySelectorAll('.time-offset-btn');
            const customDiv = document.getElementById(`${modalType}TimeCustom`);
            const lateEntryDiv = document.getElementById(`${modalType}LateEntry`);

            // Update active button
            buttons.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            const offset = btn.dataset.offset;

            if (offset === 'custom') {
                customDiv.classList.add('show');
                timeOffsetState[modalType].offset = null;
                // Set default to now
                const now = new Date();
                now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
                document.getElementById(`${modalType}CustomTime`).value = now.toISOString().slice(0, 16);
                updateComputedTime(modalType);
            } else {
                customDiv.classList.remove('show');
                timeOffsetState[modalType].offset = parseInt(offset);
                timeOffsetState[modalType].customTime = null;

                // Show late entry if > 5 min (300 sec)
                if (Math.abs(parseInt(offset)) > 300) {
                    lateEntryDiv.classList.add('show');
                } else {
                    lateEntryDiv.classList.remove('show');
                }

                updateComputedTime(modalType);
            }
        }

        function updateComputedTime(modalType) {
            const displayEl = document.getElementById(`${modalType}ComputedTime`);
            const lateEntryDiv = document.getElementById(`${modalType}LateEntry`);
            const customInput = document.getElementById(`${modalType}CustomTime`);

            let computedTime;
            let offsetSeconds = 0;

            if (customInput && customInput.value && timeOffsetState[modalType].offset === null) {
                computedTime = new Date(customInput.value);
                timeOffsetState[modalType].customTime = computedTime.toISOString();
                offsetSeconds = Math.floor((computedTime - new Date()) / 1000);
            } else {
                offsetSeconds = timeOffsetState[modalType].offset || 0;
                computedTime = new Date(Date.now() + offsetSeconds * 1000);
            }

            const timeStr = computedTime.toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' });
            displayEl.textContent = `記錄時間: ${timeStr}`;

            // Show late entry if > 5 min ago
            if (Math.abs(offsetSeconds) > 300) {
                lateEntryDiv.classList.add('show');
            } else {
                lateEntryDiv.classList.remove('show');
            }
        }

        function getTimeOffsetData(modalType) {
            const state = timeOffsetState[modalType];
            const lateEntryDiv = document.getElementById(`${modalType}LateEntry`);
            const result = {};

            if (state.customTime) {
                result.clinical_time = state.customTime;
            } else if (state.offset && state.offset !== 0) {
                result.clinical_time_offset_seconds = state.offset;
            }

            // If late entry is shown, include reason
            if (lateEntryDiv && lateEntryDiv.classList.contains('show')) {
                const reasonEl = document.getElementById(`${modalType}LateReason`);
                const noteEl = document.getElementById(`${modalType}LateNote`);
                if (reasonEl) result.late_entry_reason = reasonEl.value;
                if (noteEl && noteEl.value) result.late_entry_note = noteEl.value;
            }

            return result;
        }

        function resetTimeSelector(modalType) {
            const container = document.getElementById(`${modalType}TimeSelector`);
            if (!container) return;

            const buttons = container.querySelectorAll('.time-offset-btn');
            buttons.forEach(b => {
                b.classList.toggle('active', b.dataset.offset === '0');
            });

            const customDiv = document.getElementById(`${modalType}TimeCustom`);
            const lateEntryDiv = document.getElementById(`${modalType}LateEntry`);

            if (customDiv) customDiv.classList.remove('show');
            if (lateEntryDiv) lateEntryDiv.classList.remove('show');

            timeOffsetState[modalType] = { offset: 0, customTime: null };

            const displayEl = document.getElementById(`${modalType}ComputedTime`);
            if (displayEl) displayEl.textContent = '記錄時間: 現在';
        }

        // =================================================================
        // Phase A-6: WAL Offline Queue
        // =================================================================

        function generateDeviceId() {
            const id = 'DEV-' + Date.now().toString(36) + '-' + Math.random().toString(36).substr(2, 6);
            localStorage.setItem('deviceId', id);
            return id;
        }

        function generateIdempotencyKey(caseId, action) {
            return `${caseId}:${deviceId}:${Date.now()}:${action}`;
        }

        // Load queue from localStorage
        function loadSyncQueue() {
            try {
                const stored = localStorage.getItem('anesOfflineQueue');
                syncQueue = stored ? JSON.parse(stored) : [];
                updateSyncBadge();
            } catch (e) {
                syncQueue = [];
            }
        }

        // Save queue to localStorage
        function saveSyncQueue() {
            localStorage.setItem('anesOfflineQueue', JSON.stringify(syncQueue));
            updateSyncBadge();
        }

        // Add to offline queue
        function queueOfflineAction(endpoint, operation, payload) {
            const item = {
                id: 'Q-' + Date.now(),
                device_id: deviceId,
                operation: operation,
                endpoint: endpoint,
                payload: payload,
                idempotency_key: generateIdempotencyKey(currentCase?.id || 'new', endpoint),
                created_at: new Date().toISOString()
            };
            syncQueue.push(item);
            saveSyncQueue();
            console.log('[Offline] Queued:', item.endpoint);
            return item;
        }

        // Update sync badge
        function updateSyncBadge() {
            const badge = document.getElementById('syncBadge');
            if (badge) {
                if (syncQueue.length > 0) {
                    badge.textContent = syncQueue.length;
                    badge.classList.remove('hidden');
                } else {
                    badge.classList.add('hidden');
                }
            }
        }

        // Sync with server
        async function syncWithServer() {
            if (!isOnline || syncQueue.length === 0) return;

            console.log('[Sync] Starting sync of', syncQueue.length, 'items');
            const indicator = document.getElementById('syncIndicator');
            if (indicator) indicator.classList.add('syncing');

            try {
                const res = await apiFetch(`${API_BASE}/sync/batch`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        device_id: deviceId,
                        items: syncQueue
                    })
                });

                if (res.ok) {
                    const data = await res.json();
                    console.log('[Sync] Results:', data);

                    // Remove synced items
                    const syncedIds = data.results
                        .filter(r => r.status === 'synced' || r.status === 'duplicate')
                        .map(r => r.id);
                    syncQueue = syncQueue.filter(item => !syncedIds.includes(item.id));
                    saveSyncQueue();

                    // Reload timeline if we're viewing a case
                    if (currentCase) {
                        loadTimeline(currentCase.id);
                    }
                }
            } catch (e) {
                console.error('[Sync] Failed:', e);
            } finally {
                if (indicator) indicator.classList.remove('syncing');
            }
        }

        // Network status listeners
        window.addEventListener('online', () => {
            isOnline = true;
            console.log('[Network] Online - syncing...');
            document.body.classList.remove('offline');
            syncWithServer();
        });

        window.addEventListener('offline', () => {
            isOnline = false;
            console.log('[Network] Offline');
            document.body.classList.add('offline');
        });

        // Helper function to extract error message from various error types
        function getErrorMessage(err) {
            if (!err) return '未知錯誤';
            // String error
            if (typeof err === 'string') return err;
            // APIError or Error with message
            if (err.message && typeof err.message === 'string') return err.message;
            // Error data with detail (FastAPI style)
            if (err.data?.detail) {
                if (typeof err.data.detail === 'string') return err.data.detail;
                if (err.data.detail.message) return err.data.detail.message;
            }
            // Direct detail property
            if (err.detail) {
                if (typeof err.detail === 'string') return err.detail;
                if (err.detail.message) return err.detail.message;
            }
            // Fallback to JSON string for debugging
            try {
                const str = JSON.stringify(err);
                return str.length > 100 ? str.substring(0, 100) + '...' : str;
            } catch {
                return '未知錯誤';
            }
        }

        // Wrapped fetch for offline support
        // Phase 2: Helper function that uses xIRS.API with fallback to native fetch
        async function apiFetch(url, options = {}) {
            const method = options.method || 'GET';
            const body = options.body ? JSON.parse(options.body) : null;

            // Fallback to native fetch if xIRS SDK not loaded (e.g., Vercel demo)
            if (typeof xIRS === 'undefined' || !xIRS.API) {
                const fetchOptions = {
                    method,
                    headers: { 'Content-Type': 'application/json' }
                };
                if (body && method !== 'GET') {
                    fetchOptions.body = JSON.stringify(body);
                }
                const response = await fetch(url, fetchOptions);
                return response;
            }

            let result;
            if (method === 'GET') {
                result = await xIRS.API.get(url);
            } else if (method === 'POST') {
                result = await xIRS.API.post(url, body);
            } else if (method === 'PUT') {
                result = await xIRS.API.put(url, body);
            } else if (method === 'DELETE') {
                result = await xIRS.API.delete(url);
            } else {
                result = await xIRS.API.request(url, { method, body });
            }

            // Return in fetch-compatible format for backwards compatibility
            return {
                ok: result.ok,
                status: result.status,
                json: () => Promise.resolve(result.data)
            };
        }

        async function offlineFetch(url, options = {}) {
            if (!isOnline) {
                // Queue the request for later
                const endpoint = url.replace(API_BASE, '');
                const operation = options.method || 'GET';

                if (operation !== 'GET') {
                    const payload = options.body ? JSON.parse(options.body) : {};
                    queueOfflineAction(endpoint, operation, payload);
                    return { ok: true, offline: true, json: () => Promise.resolve({ queued: true }) };
                } else {
                    throw new Error('Offline - cannot fetch data');
                }
            }

            // Phase 2: Use xIRS.API instead of fetch
            return apiFetch(url, options);
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadSyncQueue();
            loadCases();

            // Periodic sync attempt
            setInterval(() => {
                if (isOnline && syncQueue.length > 0) {
                    syncWithServer();
                }
            }, 30000); // Every 30 seconds
        });

        // Modal Functions
        function showNewCaseModal() {
            document.getElementById('newCaseModal').classList.add('active');
            // Reset CIRS selection
            document.getElementById('cirsRegistrationRef').value = '';
            document.getElementById('patientSnapshot').value = '';
            document.getElementById('newPatientId').value = '';
            document.getElementById('newPatientName').value = '';
            // Load CIRS waiting list
            loadCirsWaitingList();
        }

        async function loadCirsWaitingList() {
            const statusEl = document.getElementById('cirsStatus');
            const listEl = document.getElementById('cirsPatientList');

            statusEl.textContent = '檢查中...';
            statusEl.style.color = 'var(--text-secondary)';

            // Vercel demo mode: use local demo data
            if (IS_VERCEL_DEMO) {
                statusEl.innerHTML = '<span style="display:inline-block;width:8px;height:8px;background:#f59e0b;border-radius:50%;margin-right:4px;"></span>展示模式 (' + DEMO_CIRS_PATIENTS.length + ' 位)';
                statusEl.style.color = '#f59e0b';
                listEl.innerHTML = DEMO_CIRS_PATIENTS.map(p => `
                    <div class="cirs-patient-item" onclick="selectCirsPatient('${p.registration_id}', '${p.patient_id || ''}', '${p.name || ''}', ${JSON.stringify(p).replace(/"/g, '&quot;')})"
                         style="padding: 10px; margin-bottom: 6px; background: var(--bg-secondary); border-radius: 6px; cursor: pointer; border: 2px solid transparent; transition: all 0.2s;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <span style="font-weight: 500;">${p.name}</span>
                                <span style="color: var(--text-secondary); margin-left: 8px; font-size: 13px;">${p.patient_id}</span>
                            </div>
                            <div style="display: flex; gap: 6px; align-items: center;">
                                <span style="font-size: 11px; color: var(--text-secondary);">等待 ${p.waiting_minutes} 分</span>
                                <span style="font-size: 12px; padding: 2px 8px; background: ${getTriageColor(p.triage_category)}; border-radius: 4px;">${getPriorityLabel(p.priority) || '待麻醉'}</span>
                            </div>
                        </div>
                        <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">
                            <div>${p.chief_complaint}</div>
                            <div style="color: var(--primary);">[備註] ${p.anesthesia_notes}</div>
                            <div>[診] ${p.consultation_by}</div>
                        </div>
                    </div>
                `).join('');
                return;
            }

            try {
                // v1.1: 使用新的 waiting-anesthesia 端點
                // 只顯示醫師看診後勾選「需麻醉」的病患
                const res = await apiFetch(`${API_BASE}/proxy/cirs/waiting-anesthesia`);
                const data = await res.json();

                if (data.online && data.patients.length > 0) {
                    statusEl.innerHTML = `<span style="display:inline-block;width:8px;height:8px;background:#10b981;border-radius:50%;margin-right:4px;"></span>連線 (${data.count} 位待麻醉)`;
                    statusEl.style.color = '#10b981';

                    listEl.innerHTML = data.patients.map(p => `
                        <div class="cirs-patient-item" onclick="selectCirsPatient('${p.registration_id}', '${p.patient_id || ''}', '${p.name || ''}', ${JSON.stringify(p).replace(/"/g, '&quot;')})"
                             style="padding: 10px; margin-bottom: 6px; background: var(--bg-secondary); border-radius: 6px; cursor: pointer; border: 2px solid transparent; transition: all 0.2s;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <span style="font-weight: 500;">${p.name || p.patient_ref || '未知'}</span>
                                    <span style="color: var(--text-secondary); margin-left: 8px; font-size: 13px;">${p.patient_id || ''}</span>
                                </div>
                                <div style="display: flex; gap: 6px; align-items: center;">
                                    ${p.waiting_minutes ? `<span style="font-size: 11px; color: var(--text-secondary);">等待 ${p.waiting_minutes} 分</span>` : ''}
                                    <span style="font-size: 12px; padding: 2px 8px; background: ${getTriageColor(p.triage_category)}; border-radius: 4px;">${getPriorityLabel(p.priority) || p.triage_category || '待麻醉'}</span>
                                </div>
                            </div>
                            <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">
                                ${p.chief_complaint ? `<div>${p.chief_complaint}</div>` : ''}
                                ${p.anesthesia_notes ? `<div style="color: var(--primary);">[備註] ${p.anesthesia_notes}</div>` : ''}
                                ${p.consultation_by ? `<div>[診] ${p.consultation_by}</div>` : ''}
                            </div>
                            ${p.claimed_by ? `<div style="font-size: 11px; color: #f59e0b; margin-top: 4px;">[!] 已被 ${p.claimed_by} 接手</div>` : ''}
                        </div>
                    `).join('');
                } else if (data.online && data.patients.length === 0) {
                    statusEl.innerHTML = '<span style="display:inline-block;width:8px;height:8px;background:#10b981;border-radius:50%;margin-right:4px;"></span>連線 (無待麻醉)';
                    statusEl.style.color = '#10b981';
                    listEl.innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 16px;">目前無待麻醉病患<br><small>醫師完成看診並勾選「需麻醉」後，病患會出現在此</small></div>';
                } else {
                    statusEl.innerHTML = '<span style="display:inline-block;width:8px;height:8px;background:#ef4444;border-radius:50%;margin-right:4px;"></span>離線';
                    statusEl.style.color = '#f59e0b';
                    listEl.innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 16px;">CIRS 未連線，請手動輸入或掃描傷票</div>';
                }
            } catch (err) {
                console.error('Failed to load CIRS waiting list:', err);
                statusEl.innerHTML = '<span style="display:inline-block;width:8px;height:8px;background:#ef4444;border-radius:50%;margin-right:4px;"></span>離線';
                statusEl.style.color = '#ef4444';
                listEl.innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 16px;">CIRS 未連線，請手動輸入或掃描傷票</div>';
            }
        }

        function getPriorityLabel(priority) {
            const labels = {
                'STAT': '急',
                'URGENT': '緊',
                'ROUTINE': '常'
            };
            return labels[priority] || '';
        }

        function getTriageColor(category) {
            const colors = {
                'immediate': '#ef4444',
                'urgent': '#f59e0b',
                'delayed': '#10b981',
                'minor': '#3b82f6',
                'deceased': '#6b7280'
            };
            return colors[category?.toLowerCase()] || 'var(--bg-tertiary)';
        }

        function selectCirsPatient(registrationId, patientId, name, patientData) {
            // Parse patient data if it's a string
            const patient = typeof patientData === 'string' ? JSON.parse(patientData) : patientData;

            // Fill in form fields
            document.getElementById('newPatientId').value = patientId || registrationId;
            document.getElementById('newPatientName').value = name || '';
            document.getElementById('cirsRegistrationRef').value = registrationId;

            // Store patient snapshot
            const snapshot = {
                name: patient.name,
                dob: patient.dob,
                sex: patient.sex,
                allergies: patient.allergies || [],
                weight_kg: patient.weight_kg,
                blood_type: patient.blood_type,
                triage_category: patient.triage_category,
                chief_complaint: patient.chief_complaint
            };
            document.getElementById('patientSnapshot').value = JSON.stringify(snapshot);

            // Visual feedback - highlight selected item
            document.querySelectorAll('.cirs-patient-item').forEach(el => {
                el.style.borderColor = 'transparent';
            });
            event.currentTarget.style.borderColor = 'var(--primary)';
        }

        function showVitalsModal() {
            document.getElementById('vitalsModal').classList.add('active');
        }

        function showMedModal() {
            document.getElementById('medModal').classList.add('active');
            loadQuickDrugsWithInventory();
        }

        function closeModal(id) {
            document.getElementById(id).classList.remove('active');
        }

        // API Functions
        async function loadCases() {
            try {
                const today = new Date().toISOString().split('T')[0];
                const res = await apiFetch(`${API_BASE}/cases?date=${today}&limit=20`);
                const data = await res.json();

                const listEl = document.getElementById('caseList');

                // Separate active and closed cases
                const activeCases = data.cases.filter(c => c.status !== 'CLOSED');
                const closedCases = data.cases.filter(c => c.status === 'CLOSED');

                if (data.cases.length === 0) {
                    listEl.innerHTML = `
                        <div class="empty-state">
                            <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width:64px;height:64px;opacity:0.5;">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
                            </svg>
                            <p>今日尚無案例</p>
                        </div>
                    `;
                    return;
                }

                // Build case list HTML
                let html = '';

                // Active cases section
                if (activeCases.length > 0) {
                    html += activeCases.map(c => `
                        <div class="case-list-item" onclick="selectCase('${c.id}')">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div class="case-id">${c.id}</div>
                                    <div style="font-weight: 600;">${c.patient_name || c.patient_id}</div>
                                    ${c.operation ? `<div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 2px;">${c.operation}</div>` : ''}
                                </div>
                                <span class="case-status ${c.status.toLowerCase()}">${c.status}</span>
                            </div>
                        </div>
                    `).join('');
                }

                // Closed cases section (collapsible)
                if (closedCases.length > 0) {
                    html += `
                        <div class="closed-cases-section" style="margin-top: 16px;">
                            <div class="section-header" onclick="toggleClosedCases()" style="display: flex; align-items: center; gap: 8px; padding: 8px 12px; background: var(--card); border-radius: 8px; cursor: pointer;">
                                <svg id="closedCasesArrow" width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="transition: transform 0.2s;">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                                </svg>
                                <span style="color: var(--text-muted); font-size: 0.875rem;">已結案 (${closedCases.length})</span>
                            </div>
                            <div id="closedCasesList" style="display: none; margin-top: 8px;">
                                ${closedCases.map(c => `
                                    <div class="case-list-item" onclick="selectCase('${c.id}')" style="opacity: 0.7;">
                                        <div style="display: flex; justify-content: space-between; align-items: center;">
                                            <div>
                                                <div class="case-id">${c.id}</div>
                                                <div style="font-weight: 600;">${c.patient_name || c.patient_id}</div>
                                            </div>
                                            <span class="case-status closed">已結案</span>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }

                // If only closed cases exist, show a message
                if (activeCases.length === 0 && closedCases.length > 0) {
                    html = `
                        <div style="text-align: center; padding: 16px; color: var(--text-muted);">
                            <p style="margin-bottom: 12px;">目前無進行中案例</p>
                        </div>
                    ` + html;
                }

                listEl.innerHTML = html;

                // Auto-select if there's an in-progress case
                const inProgress = activeCases.find(c => c.status === 'IN_PROGRESS');
                if (inProgress) {
                    selectCase(inProgress.id);
                }
            } catch (err) {
                console.error('Failed to load cases:', err);
            }
        }

        function toggleClosedCases() {
            const list = document.getElementById('closedCasesList');
            const arrow = document.getElementById('closedCasesArrow');
            if (list.style.display === 'none') {
                list.style.display = 'block';
                arrow.style.transform = 'rotate(90deg)';
            } else {
                list.style.display = 'none';
                arrow.style.transform = 'rotate(0deg)';
            }
        }

        // v1.5.4: 返回案件清單
        function backToList() {
            currentCase = null;
            document.getElementById('noCaseView').classList.remove('hidden');
            document.getElementById('activeCaseView').classList.add('hidden');
            document.getElementById('resourceBar').classList.add('hidden');
            // 清空 context badge
            document.getElementById('contextBadge').classList.add('hidden');
        }

        async function selectCase(caseId) {
            try {
                const res = await apiFetch(`${API_BASE}/cases/${caseId}`);
                currentCase = await res.json();

                // Update UI
                document.getElementById('noCaseView').classList.add('hidden');
                document.getElementById('activeCaseView').classList.remove('hidden');
                document.getElementById('resourceBar').classList.remove('hidden');

                document.getElementById('caseId').textContent = currentCase.id;
                document.getElementById('patientName').textContent = currentCase.patient_name || currentCase.patient_id;
                document.getElementById('caseStatus').textContent = currentCase.status;
                document.getElementById('caseStatus').className = `case-status ${currentCase.status.toLowerCase()}`;

                // v2.1.1: Update diagnosis and operation display
                document.getElementById('diagnosisInfo').textContent = currentCase.diagnosis ? `Dx: ${currentCase.diagnosis}` : '';
                document.getElementById('operationInfo').textContent = currentCase.operation || '';

                // v1.1: Update technique and ASA display
                updateCaseInfoDisplay();

                if (currentCase.context_mode === 'BATTLEFIELD') {
                    document.getElementById('contextBadge').classList.remove('hidden');
                }

                // Load timeline
                loadTimeline(caseId);

                // Load O2 status
                loadO2Status(caseId);

            } catch (err) {
                console.error('Failed to load case:', err);
            }
        }

        async function loadTimeline(caseId) {
            try {
                const res = await apiFetch(`${API_BASE}/cases/${caseId}/timeline`);
                const data = await res.json();

                const timelineEl = document.getElementById('timeline');

                if (data.all.length === 0) {
                    timelineEl.innerHTML = `<div class="empty-state"><p>尚無事件</p></div>`;
                    return;
                }

                // Sort by clinical_time desc
                const events = data.all.sort((a, b) =>
                    new Date(b.clinical_time) - new Date(a.clinical_time)
                );

                timelineEl.innerHTML = events.slice(0, 20).map(e => {
                    const time = new Date(e.clinical_time).toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' });
                    const dotClass = e.event_type === 'VITAL_SIGN' ? 'vital' :
                                    e.event_type === 'MEDICATION_ADMIN' ? 'med' :
                                    e.event_type === 'MILESTONE' ? 'milestone' :
                                    e.event_type === 'BLOOD_PRODUCT' ? 'blood' : '';

                    let desc = '';
                    if (e.event_type === 'VITAL_SIGN') {
                        const p = e.payload;
                        desc = `BP ${p.bp_sys || '--'}/${p.bp_dia || '--'}, HR ${p.hr || '--'}, SpO2 ${p.spo2 || '--'}%`;
                    } else if (e.event_type === 'MEDICATION_ADMIN') {
                        desc = `${e.payload.drug_name} ${e.payload.dose}${e.payload.unit} ${e.payload.route}`;
                    } else if (e.event_type === 'MILESTONE') {
                        desc = e.payload.type;
                    } else if (e.event_type === 'BLOOD_PRODUCT') {
                        const p = e.payload;
                        const actionLabel = p.action === 'START' ? '開始' : p.action === 'COMPLETE' ? '完成' : '反應';
                        desc = `${p.product_type} ${actionLabel} - ${p.unit_id}`;
                        if (p.action === 'REACTION' && p.reaction_type) {
                            desc += ` (${p.reaction_type})`;
                        }
                    } else {
                        desc = JSON.stringify(e.payload).substring(0, 50);
                    }

                    return `
                        <div class="timeline-item">
                            <div class="timeline-time">${time}</div>
                            <div class="timeline-dot ${dotClass}"></div>
                            <div class="timeline-content">
                                <div class="timeline-type">${e.event_type}</div>
                                <div class="timeline-desc">${desc}</div>
                            </div>
                        </div>
                    `;
                }).join('');

                // Update last values in resource bar
                const lastVital = data.vitals[data.vitals.length - 1];
                if (lastVital) {
                    document.getElementById('lastSpo2').textContent = lastVital.payload.spo2 || '--';
                    document.getElementById('lastHr').textContent = lastVital.payload.hr || '--';
                    document.getElementById('lastBp').textContent =
                        `${lastVital.payload.bp_sys || '--'}/${lastVital.payload.bp_dia || '--'}`;
                }

            } catch (err) {
                console.error('Failed to load timeline:', err);
            }
        }

        // =================================================================
        // Phase C: Oxygen Cylinder Management
        // =================================================================
        let currentO2Status = null;

        async function loadO2Status(caseId) {
            try {
                const res = await apiFetch(`${API_BASE}/cases/${caseId}/oxygen-status`);
                const data = await res.json();
                currentO2Status = data;

                const statusEl = document.getElementById('o2Status');
                const unitEl = document.getElementById('o2Unit');

                if (data.source_type === 'CYLINDER' && data.cylinder_serial) {
                    // Cylinder claimed
                    statusEl.textContent = data.est_minutes_remaining || '--';
                    unitEl.textContent = 'min';

                    // Apply warning/danger classes
                    statusEl.classList.remove('warning', 'danger');
                    if (data.est_minutes_remaining && data.est_minutes_remaining < 30) {
                        statusEl.classList.add('danger');
                    } else if (data.est_minutes_remaining && data.est_minutes_remaining < 60) {
                        statusEl.classList.add('warning');
                    }
                } else {
                    // No cylinder claimed
                    statusEl.textContent = '未認領';
                    unitEl.textContent = '';
                    statusEl.classList.remove('warning', 'danger');
                }
            } catch (err) {
                console.error('Failed to load O2 status:', err);
                document.getElementById('o2Status').textContent = '--';
            }
        }

        async function showO2Modal() {
            if (!currentCase) {
                alert('請先選擇案例');
                return;
            }

            document.getElementById('o2Modal').classList.add('active');

            // Load current status
            await loadO2Status(currentCase.id);
            updateO2ModalStatus();

            // Load available cylinders
            await loadAvailableCylinders();
        }

        function updateO2ModalStatus() {
            const claimStatusEl = document.getElementById('o2ClaimStatus');
            const claimedInfoEl = document.getElementById('o2ClaimedInfo');
            const releaseBtn = document.getElementById('o2ReleaseBtn');
            const availableSection = document.getElementById('o2AvailableSection');

            if (currentO2Status && currentO2Status.source_type === 'CYLINDER' && currentO2Status.cylinder_serial) {
                // Cylinder is claimed
                claimStatusEl.textContent = '已認領';
                claimStatusEl.classList.remove('reconciled');
                claimStatusEl.classList.add('pending');
                claimedInfoEl.classList.remove('hidden');
                releaseBtn.classList.remove('hidden');
                availableSection.classList.add('hidden');

                document.getElementById('o2CylinderSerial').textContent = currentO2Status.cylinder_serial;
                document.getElementById('o2LevelPercent').textContent = `${currentO2Status.level_percent || '--'}%`;
                document.getElementById('o2EstTime').textContent = `${currentO2Status.est_minutes_remaining || '--'} min`;
                document.getElementById('o2FlowRate').textContent = `${currentO2Status.avg_flow_lpm || '--'} L/min`;
            } else {
                // No cylinder claimed
                claimStatusEl.textContent = '未認領';
                claimStatusEl.classList.add('reconciled');
                claimStatusEl.classList.remove('pending');
                claimedInfoEl.classList.add('hidden');
                releaseBtn.classList.add('hidden');
                availableSection.classList.remove('hidden');
            }
        }

        async function loadAvailableCylinders() {
            const listEl = document.getElementById('o2CylinderList');
            listEl.innerHTML = '<div class="empty-state" style="padding: 24px; text-align: center;"><p style="color: var(--text-muted);">載入中...</p></div>';

            try {
                // Load E-size cylinders
                // Phase 2: Use apiFetch instead of fetch
                const eRes = await apiFetch('/api/v2/equipment/EMER-EQ-006/units');
                const eData = await eRes.json();

                // Load H-size cylinders
                // Phase 2: Use apiFetch instead of fetch
                const hRes = await apiFetch('/api/v2/equipment/RESP-001/units');
                const hData = await hRes.json();

                const allUnits = [
                    ...(eData.units || []).map(u => ({ ...u, type: 'E型' })),
                    ...(hData.units || []).map(u => ({ ...u, type: 'H型' }))
                ];

                if (allUnits.length === 0) {
                    listEl.innerHTML = '<div class="empty-state" style="padding: 24px; text-align: center;"><p style="color: var(--text-muted);">無可用氧氣瓶</p></div>';
                    return;
                }

                listEl.innerHTML = allUnits.map(unit => {
                    const isClaimed = unit.claimed_by_case_id && unit.claimed_by_case_id !== currentCase?.id;
                    const isMyself = unit.claimed_by_case_id === currentCase?.id;
                    const levelClass = unit.level_percent < 30 ? 'critical' : (unit.level_percent < 60 ? 'low' : '');

                    return `
                        <div class="o2-cylinder-item ${isClaimed ? 'claimed' : ''}"
                             onclick="${isClaimed ? '' : `claimO2Cylinder(${unit.id})`}"
                             style="${isMyself ? 'border-left-color: var(--primary); background: var(--card-hover);' : ''}">
                            <div class="o2-cylinder-info">
                                <span class="o2-cylinder-serial">${unit.unit_label} (${unit.type})</span>
                                <span class="o2-cylinder-level">${unit.level_percent}% ${isClaimed ? '- 使用中' : (isMyself ? '- 目前使用' : '')}</span>
                            </div>
                            <div class="o2-level-bar">
                                <div class="o2-level-fill ${levelClass}" style="width: ${unit.level_percent}%"></div>
                            </div>
                        </div>
                    `;
                }).join('');

            } catch (err) {
                console.error('Failed to load cylinders:', err);
                listEl.innerHTML = '<div class="empty-state" style="padding: 24px; text-align: center;"><p style="color: var(--text-muted);">載入失敗</p></div>';
            }
        }

        async function claimO2Cylinder(unitId) {
            if (!currentCase) return;

            try {
                const res = await apiFetch(`${API_BASE}/cases/${currentCase.id}/claim-oxygen?actor_id=${actorId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ cylinder_unit_id: unitId })
                });

                if (!res.ok) {
                    const err = await res.json();
                    alert(err.detail || '認領失敗');
                    return;
                }

                const data = await res.json();
                alert(`已認領氧氣瓶: ${data.cylinder_serial} (${data.level_percent}%)`);

                // Reload status
                await loadO2Status(currentCase.id);
                updateO2ModalStatus();
                await loadAvailableCylinders();

            } catch (err) {
                console.error('Failed to claim cylinder:', err);
                alert('認領失敗: ' + err.message);
            }
        }

        async function releaseO2Cylinder() {
            if (!currentCase) return;

            if (!confirm('確定要釋放氧氣瓶嗎？')) return;

            try {
                const res = await apiFetch(`${API_BASE}/cases/${currentCase.id}/claim-oxygen?actor_id=${actorId}`, {
                    method: 'DELETE'
                });

                if (!res.ok) {
                    const err = await res.json();
                    alert(err.detail || '釋放失敗');
                    return;
                }

                // Clear status
                currentO2Status = null;
                await loadO2Status(currentCase.id);
                updateO2ModalStatus();
                await loadAvailableCylinders();

            } catch (err) {
                console.error('Failed to release cylinder:', err);
                alert('釋放失敗: ' + err.message);
            }
        }

        async function createCase(event) {
            event.preventDefault();

            // Get CIRS reference and patient snapshot if available
            const cirsRef = document.getElementById('cirsRegistrationRef').value;
            const snapshotJson = document.getElementById('patientSnapshot').value;
            let patientSnapshot = null;
            if (snapshotJson) {
                try {
                    patientSnapshot = JSON.parse(snapshotJson);
                } catch (e) {
                    console.warn('Failed to parse patient snapshot:', e);
                }
            }

            const body = {
                patient_id: document.getElementById('newPatientId').value,
                patient_name: document.getElementById('newPatientName').value || null,
                diagnosis: document.getElementById('newDiagnosis').value || null,
                operation: document.getElementById('newOperation').value || null,
                planned_technique: document.getElementById('newTechnique').value,
                asa_classification: document.getElementById('newAsaClass').value,
                is_emergency: document.getElementById('newAsaEmergency').checked,
                context_mode: document.getElementById('newContextMode').value,
                cirs_registration_ref: cirsRef || null,
                patient_snapshot: patientSnapshot
            };

            try {
                const res = await apiFetch(`${API_BASE}/cases?actor_id=${actorId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });

                if (!res.ok) throw new Error('Failed to create case');

                const newCase = await res.json();
                closeModal('newCaseModal');
                selectCase(newCase.id);
            } catch (err) {
                alert('建立失敗: ' + err.message);
            }
        }

        async function submitVitals(event) {
            event.preventDefault();

            if (!currentCase) return;

            const body = {
                bp_sys: parseInt(document.getElementById('vBpSys').value) || null,
                bp_dia: parseInt(document.getElementById('vBpDia').value) || null,
                hr: parseInt(document.getElementById('vHr').value) || null,
                spo2: parseInt(document.getElementById('vSpo2').value) || null,
                etco2: parseInt(document.getElementById('vEtco2').value) || null,
                o2_flow_lpm: parseFloat(document.getElementById('vO2Flow').value) || null
            };

            // v1.6.1: Add time offset support
            const timeData = getTimeOffsetData('vitals');
            if (timeData.clinical_time) {
                body.clinical_time = timeData.clinical_time;
            }
            if (timeData.clinical_time_offset_seconds) {
                body.clinical_time_offset_seconds = timeData.clinical_time_offset_seconds;
            }
            if (timeData.late_entry_reason) {
                body.late_entry_reason = timeData.late_entry_reason;
                body.late_entry_note = timeData.late_entry_note;
            }

            try {
                const res = await apiFetch(`${API_BASE}/cases/${currentCase.id}/vitals?actor_id=${actorId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });

                if (res.status === 404) {
                    handleCaseNotFound();
                    return;
                }
                if (!res.ok) throw new Error('Failed');

                closeModal('vitalsModal');
                loadTimeline(currentCase.id);

                // Clear form
                ['vBpSys', 'vBpDia', 'vHr', 'vSpo2', 'vEtco2', 'vO2Flow'].forEach(id => {
                    document.getElementById(id).value = '';
                });
                // Reset time selector
                resetTimeSelector('vitals');
            } catch (err) {
                alert('記錄失敗');
            }
        }

        // =================================================================
        // Medication Selection with Dose Adjustment
        // =================================================================
        let selectedMed = null;
        let quickDrugsCache = null;

        // Load quick drugs with inventory from API
        async function loadQuickDrugsWithInventory() {
            const gridEl = document.getElementById('quickDrugsGrid');
            const statusEl = document.getElementById('medInventoryStatus');

            gridEl.innerHTML = '<div class="med-loading">載入藥品庫存中...</div>';
            statusEl.textContent = '';

            try {
                const res = await apiFetch(`${API_BASE}/quick-drugs-with-inventory`);
                if (!res.ok) throw new Error('Failed to load');

                const data = await res.json();
                quickDrugsCache = data.drugs;

                if (!data.drugs || data.drugs.length === 0) {
                    gridEl.innerHTML = '<div class="med-loading">無可用藥品</div>';
                    return;
                }

                // Group by category (controlled vs regular)
                const controlled = data.drugs.filter(d => d.is_controlled);
                const regular = data.drugs.filter(d => !d.is_controlled);

                let html = '';

                // Render regular drugs first, then controlled
                [...regular, ...controlled].forEach(drug => {
                    const stockClass = getStockClass(drug.current_stock);
                    const stockLabel = getStockLabel(drug.current_stock);
                    const isDisabled = drug.current_stock === 0;
                    const controlledClass = drug.is_controlled ? 'controlled-drug' : '';
                    const disabledClass = isDisabled ? 'out-of-stock' : '';

                    html += `
                        <button class="med-btn ${controlledClass} ${disabledClass}"
                                onclick="${isDisabled ? '' : `selectMed('${drug.medicine_code}', '${drug.medicine_name}', ${drug.default_dose}, '${drug.default_unit}', ${drug.is_controlled})`}"
                                ${isDisabled ? 'disabled' : ''}>
                            <div class="med-name">${drug.medicine_name}</div>
                            <div class="med-dose">${drug.default_dose} ${drug.default_unit} IV</div>
                            <div class="med-stock">
                                <span class="stock-badge ${stockClass}">${stockLabel}</span>
                                <span style="color: var(--text-muted);">${drug.current_stock} ${drug.stock_unit || 'amp'}</span>
                            </div>
                        </button>
                    `;
                });

                gridEl.innerHTML = html;

                // Update status
                const lowStockCount = data.drugs.filter(d => d.current_stock > 0 && d.current_stock <= 3).length;
                const outOfStockCount = data.drugs.filter(d => d.current_stock === 0).length;

                if (outOfStockCount > 0) {
                    statusEl.innerHTML = `<span style="color: #ef4444;">${outOfStockCount} 項缺貨</span>`;
                } else if (lowStockCount > 0) {
                    statusEl.innerHTML = `<span style="color: #eab308;">${lowStockCount} 項低庫存</span>`;
                } else {
                    statusEl.textContent = '庫存正常';
                }

            } catch (err) {
                console.error('Failed to load quick drugs:', err);
                gridEl.innerHTML = `
                    <div class="med-loading">
                        載入失敗
                        <button class="btn" style="margin-top: 12px; background: var(--card-hover);" onclick="loadQuickDrugsWithInventory()">重試</button>
                    </div>
                `;
            }
        }

        function getStockClass(stock) {
            if (stock === 0) return 'out-of-stock';
            if (stock <= 3) return 'low-stock';
            return 'in-stock';
        }

        function getStockLabel(stock) {
            if (stock === 0) return '缺貨';
            if (stock <= 3) return '低庫存';
            return '庫存充足';
        }

        function selectMed(code, name, defaultDose, unit, isControlled) {
            if (!currentCase) {
                alert('請先選擇或建立案例');
                return;
            }

            selectedMed = { code, name, defaultDose, unit, isControlled };

            // Update UI
            document.getElementById('selectedDrugName').textContent = name;
            document.getElementById('selectedDose').value = defaultDose;
            document.getElementById('selectedUnit').textContent = unit;
            document.getElementById('selectedRoute').value = 'IV';

            // Show controlled tag if applicable
            const tagEl = document.getElementById('selectedDrugTag');
            if (isControlled) {
                tagEl.textContent = '管制藥品';
                tagEl.className = 'selected-drug-tag controlled';
                document.getElementById('selectedDrugName').style.color = 'var(--controlled)';
            } else {
                tagEl.textContent = '';
                tagEl.className = 'selected-drug-tag';
                document.getElementById('selectedDrugName').style.color = 'var(--text)';
            }

            // Switch views
            document.getElementById('medSelectView').classList.add('hidden');
            document.getElementById('medConfirmView').classList.remove('hidden');
        }

        function adjustDose(delta) {
            const input = document.getElementById('selectedDose');
            let current = parseFloat(input.value) || 0;
            current = Math.max(0, current + delta);
            // Round to 1 decimal
            input.value = Math.round(current * 10) / 10;
        }

        function backToMedSelect() {
            document.getElementById('medSelectView').classList.remove('hidden');
            document.getElementById('medConfirmView').classList.add('hidden');
            selectedMed = null;
        }

        async function confirmMed() {
            if (!currentCase || !selectedMed) return;

            const dose = parseFloat(document.getElementById('selectedDose').value);
            if (!dose || dose <= 0) {
                alert('請輸入有效劑量');
                return;
            }

            const route = document.getElementById('selectedRoute').value;

            const body = {
                drug_code: selectedMed.code,
                drug_name: selectedMed.name,
                dose: dose,
                unit: selectedMed.unit,
                route: route,
                is_controlled: selectedMed.isControlled
            };

            // v1.6.1: Add time offset support
            const timeData = getTimeOffsetData('med');
            if (timeData.clinical_time) {
                body.clinical_time = timeData.clinical_time;
            }
            if (timeData.clinical_time_offset_seconds) {
                body.clinical_time_offset_seconds = timeData.clinical_time_offset_seconds;
            }
            if (timeData.late_entry_reason) {
                body.late_entry_reason = timeData.late_entry_reason;
                body.late_entry_note = timeData.late_entry_note;
            }

            try {
                const res = await apiFetch(`${API_BASE}/cases/${currentCase.id}/medication?actor_id=${actorId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });

                if (!res.ok) throw new Error('Failed');

                closeModal('medModal');
                backToMedSelect(); // Reset view for next time
                resetTimeSelector('med'); // Reset time selector
                loadTimeline(currentCase.id);
            } catch (err) {
                alert('記錄失敗');
            }
        }

        // Legacy function for custom med form
        async function quickMed(code, name, dose, unit) {
            if (!currentCase) return;

            const body = {
                drug_code: code,
                drug_name: name,
                dose: dose,
                unit: unit,
                route: 'IV'
            };

            try {
                const res = await apiFetch(`${API_BASE}/cases/${currentCase.id}/medication?actor_id=${actorId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });

                if (!res.ok) throw new Error('Failed');

                closeModal('medModal');
                loadTimeline(currentCase.id);
            } catch (err) {
                alert('記錄失敗');
            }
        }

        async function addMilestone(type) {
            if (!currentCase) {
                alert('請先選擇或建立一個麻醉案例');
                return;
            }

            // Show loading feedback
            const btn = document.getElementById('btnStart');
            if (btn) {
                btn.disabled = true;
                btn.innerHTML = '<span>記錄中...</span>';
            }

            try {
                const res = await apiFetch(
                    `${API_BASE}/cases/${currentCase.id}/milestone?milestone_type=${type}&actor_id=${actorId}`,
                    { method: 'POST' }
                );

                if (res.status === 404) {
                    handleCaseNotFound();
                    return;
                }
                if (!res.ok) throw new Error('Failed');

                // Show success feedback
                alert(`✓ ${getMilestoneLabel(type)} 已記錄`);

                // Reload case to get updated status
                selectCase(currentCase.id);
            } catch (err) {
                alert('記錄失敗: ' + getErrorMessage(err));
            } finally {
                // Reset button state
                const btn = document.getElementById('btnStart');
                if (btn) {
                    btn.disabled = false;
                    btn.innerHTML = `<svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width:24px;height:24px;">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg><span>開始麻醉</span>`;
                }
            }
        }

        function getMilestoneLabel(type) {
            const labels = {
                'ANESTHESIA_START': '誘導開始',
                'INTUBATION': '插管',
                'SURGERY_START': '劃刀',
                'SURGERY_END': '關皮',
                'EXTUBATION': '拔管',
                'ANESTHESIA_END': '送 PACU'
            };
            return labels[type] || type;
        }

        // Track selected milestone type for two-step flow
        let selectedMilestoneType = null;

        // Quick action for "開始麻醉" button - opens modal with time selector
        function startAnesthesiaWithTimeSelector() {
            if (!currentCase) {
                alert('請先選擇或建立一個麻醉案例');
                return;
            }
            showMilestoneModal();
            selectMilestoneType('ANESTHESIA_START');
        }

        function showMilestoneModal() {
            if (!currentCase) {
                alert('請先選擇或建立一個麻醉案例');
                return;
            }
            // Reset to step 1
            selectedMilestoneType = null;
            document.getElementById('milestoneStep1').style.display = 'block';
            document.getElementById('milestoneStep2').style.display = 'none';
            // Reset time selector
            resetTimeSelector('milestone');
            document.getElementById('milestoneModal').classList.add('active');
        }

        function selectMilestoneType(type) {
            selectedMilestoneType = type;
            // Show selected milestone name
            document.getElementById('selectedMilestoneLabel').textContent = getMilestoneLabel(type);
            // Switch to step 2
            document.getElementById('milestoneStep1').style.display = 'none';
            document.getElementById('milestoneStep2').style.display = 'block';
            // Reset and update time display
            resetTimeSelector('milestone');
            updateComputedTime('milestone');
        }

        function backToMilestoneStep1() {
            document.getElementById('milestoneStep1').style.display = 'block';
            document.getElementById('milestoneStep2').style.display = 'none';
            selectedMilestoneType = null;
        }

        async function submitMilestone() {
            if (!currentCase || !selectedMilestoneType) {
                alert('請先選擇里程碑類型');
                return;
            }

            try {
                // Get time offset data
                const timeData = getTimeOffsetData('milestone');

                // Build URL with query params
                let url = `${API_BASE}/cases/${currentCase.id}/milestone?milestone_type=${selectedMilestoneType}&actor_id=${actorId}`;

                // Add time parameters if specified
                if (timeData.clinical_time) {
                    url += `&clinical_time=${encodeURIComponent(timeData.clinical_time)}`;
                } else if (timeData.clinical_time_offset_seconds) {
                    url += `&clinical_time_offset_seconds=${timeData.clinical_time_offset_seconds}`;
                }

                // Add late entry reason if applicable
                if (timeData.late_entry_reason) {
                    url += `&late_entry_reason=${encodeURIComponent(timeData.late_entry_reason)}`;
                }
                if (timeData.late_entry_note) {
                    url += `&late_entry_note=${encodeURIComponent(timeData.late_entry_note)}`;
                }

                const res = await apiFetch(url, { method: 'POST' });

                if (!res.ok) {
                    const errData = await res.json().catch(() => ({}));
                    throw errData;
                }

                closeModal('milestoneModal');
                alert(`✓ ${getMilestoneLabel(selectedMilestoneType)} 已記錄`);
                loadTimeline(currentCase.id);
            } catch (err) {
                alert('記錄失敗: ' + getErrorMessage(err));
            }
        }

        // Legacy function - now opens modal with pre-selected type
        async function confirmMilestone(type) {
            selectMilestoneType(type);
        }

        // Updated: Clicking chip now opens time selector modal
        function recordMilestoneFromChip(type, chipEl) {
            if (!currentCase) {
                alert('請先選擇或建立一個麻醉案例');
                return;
            }

            // Check if already recorded
            if (!chipEl.classList.contains('pending')) {
                alert('此里程碑已記錄');
                return;
            }

            // Open modal with this milestone type pre-selected
            showMilestoneModal();
            selectMilestoneType(type);
        }

        // Old direct submit function (kept for backward compatibility with "開始麻醉" button)
        async function directMilestoneSubmit(type) {
            if (!currentCase) {
                alert('請先選擇或建立一個麻醉案例');
                return;
            }

            try {
                const res = await apiFetch(
                    `${API_BASE}/cases/${currentCase.id}/milestone?milestone_type=${type}&actor_id=${actorId}`,
                    { method: 'POST' }
                );

                if (!res.ok) throw new Error('Failed');

                // Update chip UI immediately
                chipEl.classList.remove('pending');
                const time = new Date().toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' });
                chipEl.innerHTML = `${label.split(' ')[0]} <small>${time}</small>`;

                loadTimeline(currentCase.id);
            } catch (err) {
                alert('記錄失敗: ' + getErrorMessage(err));
            }
        }

        // Handle case not found (e.g., after database reset)
        function handleCaseNotFound() {
            alert('案例不存在或已被重置，請重新建立案例。');
            currentCase = null;
            document.getElementById('activeCaseView').classList.add('hidden');
            document.getElementById('noCaseView').classList.remove('hidden');
            document.getElementById('resourceBar').classList.add('hidden');
            // Close any open modals
            document.querySelectorAll('.modal.active').forEach(m => m.classList.remove('active'));
            loadCases();
        }

        // =================================================================
        // Blood Transfusion Functions
        // =================================================================
        let selectedBloodProduct = null;
        let selectedBloodAction = 'START';
        let selectedReactionType = null;

        const bloodProductLabels = {
            'PRBC': '紅血球濃厚液',
            'FFP': '新鮮冷凍血漿',
            'PLATELET': '血小板',
            'CRYO': '冷凍乾燥凝血因子',
            'WHOLE_BLOOD': '全血'
        };

        function showBloodModal() {
            if (!currentCase) {
                alert('請先選擇或建立一個麻醉案例');
                return;
            }
            // Reset state
            selectedBloodProduct = null;
            selectedBloodAction = 'START';
            selectedReactionType = null;
            // Reset to step 1
            document.getElementById('bloodStep1').style.display = 'block';
            document.getElementById('bloodStep2').style.display = 'none';
            // Reset time selector
            resetTimeSelector('blood');
            document.getElementById('bloodModal').classList.add('active');
        }

        // Map blood product types to blood API unit types
        const bloodProductToUnitType = {
            'PRBC': 'PRBC',
            'FFP': 'FFP',
            'PLATELET': 'PLT',
            'CRYO': 'CRYO',
            'WHOLE_BLOOD': 'WB'
        };

        async function selectBloodType(type) {
            selectedBloodProduct = type;
            // Update step 2 header
            document.getElementById('selectedBloodType').textContent = type;
            document.getElementById('selectedBloodLabel').textContent = bloodProductLabels[type] || type;
            // Clear unit ID
            document.getElementById('bloodUnitId').value = '';
            // Reset action to START
            selectBloodAction('START');
            // Hide reaction section
            document.getElementById('bloodReactionSection').style.display = 'none';
            selectedReactionType = null;
            // Switch to step 2
            document.getElementById('bloodStep1').style.display = 'none';
            document.getElementById('bloodStep2').style.display = 'block';
            // Reset and update time display
            resetTimeSelector('blood');
            updateComputedTime('blood');
            // Load available blood inventory
            await loadBloodInventory(type);
        }

        // v1.1: 追蹤選擇 → 掃描狀態
        let selectedBloodUnitId = null;  // 從清單選擇的血袋
        let scannedBloodUnitId = null;   // 掃碼確認的血袋
        let scanConfirmPassed = false;   // 掃碼確認是否通過

        async function loadBloodInventory(productType) {
            const statusEl = document.getElementById('bloodInventoryStatus');
            const listEl = document.getElementById('bloodInventoryList');

            statusEl.textContent = '載入中...';
            listEl.innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 16px;">載入中...</div>';

            // v1.1: 重置 Select → Scan 狀態
            selectedBloodUnitId = null;
            scannedBloodUnitId = null;
            scanConfirmPassed = false;
            document.getElementById('scanConfirmSection').style.display = 'none';

            try {
                const unitType = bloodProductToUnitType[productType] || productType;

                // v1.1: 使用限縮範圍 API (僅顯示已發給此病人、已送達此地點的血袋)
                const patientId = currentCase?.patient_id || 'UNKNOWN';
                const location = currentCase?.or_room || currentCase?.id || 'OR-1';

                let res;
                try {
                    // 先嘗試 v1.1 限縮範圍 API
                    res = await apiFetch(`/api/blood/units/for-transfusion?patient_id=${encodeURIComponent(patientId)}&location=${encodeURIComponent(location)}`);
                } catch (e) {
                    // Fallback 到舊 API
                    console.warn('v1.1 API not available, falling back to legacy API');
                    res = await apiFetch(`/api/blood/units?unit_type=${unitType}&status=AVAILABLE`);
                }

                const data = await res.json();
                let units = data.data || data.units || [];

                // 過濾血品類型
                units = units.filter(u => {
                    const uType = (u.unit_type || '').toUpperCase();
                    return uType === unitType || unitType === 'PRBC' && uType === 'RBC';
                });

                // 進一步過濾可用的
                const availableUnits = units.filter(u =>
                    (u.status === 'AVAILABLE' || u.status === 'ISSUED' || u.status === 'IN_CLINICAL_AREA') &&
                    u.display_status !== 'EXPIRED'
                );

                if (availableUnits.length === 0) {
                    statusEl.textContent = '無已發血袋';
                    statusEl.style.color = '#f59e0b';
                    listEl.innerHTML = `
                        <div style="text-align: center; color: var(--text-secondary); padding: 16px;">
                            <div style="margin-bottom: 8px;">目前無已發給此病人的 ${productType} 血品</div>
                            <small>請先向血庫申請發血，或使用下方掃碼輸入</small>
                        </div>
                    `;
                    return;
                }

                statusEl.textContent = `${availableUnits.length} 袋已發`;
                statusEl.style.color = '#10b981';

                // v1.1: 顯示已發血袋清單 (Step 1: Select)
                listEl.innerHTML = `
                    <div style="font-size: 12px; color: #f59e0b; padding: 6px 0; border-bottom: 1px solid var(--border); margin-bottom: 8px;">
                        📋 Step 1: 選擇血袋 → Step 2: 掃碼確認
                    </div>
                ` + availableUnits.map(u => `
                    <div class="blood-inventory-item" onclick="selectBloodUnitForScan('${u.id}', '${u.blood_type}')"
                         data-unit-id="${u.id}"
                         style="padding: 10px; margin-bottom: 6px; background: var(--bg-secondary); border-radius: 6px; cursor: pointer; border: 2px solid transparent; transition: all 0.2s;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <span style="font-weight: 600; font-family: monospace;">${u.id}</span>
                                <span style="margin-left: 8px; padding: 2px 6px; background: #dc2626; color: white; border-radius: 4px; font-size: 12px;">${u.blood_type}</span>
                            </div>
                            <div style="text-align: right;">
                                <span style="font-size: 12px; color: ${u.display_status === 'EXPIRING_SOON' ? '#f59e0b' : 'var(--text-muted)'};">
                                    ${u.display_status === 'EXPIRING_SOON' ? '⚠️ ' : ''}到期: ${u.expiry_date}
                                </span>
                            </div>
                        </div>
                        <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">
                            ${u.volume_ml}ml ${u.hours_until_expiry ? `(${Math.round(u.hours_until_expiry/24)}天後到期)` : ''}
                            ${u.custody_status ? `| 狀態: ${u.custody_status}` : ''}
                        </div>
                    </div>
                `).join('');

            } catch (err) {
                console.error('Failed to load blood inventory:', err);
                statusEl.textContent = '載入失敗';
                statusEl.style.color = '#ef4444';
                listEl.innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 16px;">無法連接血庫<br><small>請手動輸入血袋條碼</small></div>';
            }
        }

        // v1.1: Step 1 - 從清單選擇血袋
        function selectBloodUnitForScan(unitId, bloodType) {
            selectedBloodUnitId = unitId;
            scannedBloodUnitId = null;
            scanConfirmPassed = false;

            // Highlight selected item
            document.querySelectorAll('.blood-inventory-item').forEach(el => {
                el.style.borderColor = 'transparent';
            });
            const selectedEl = document.querySelector(`.blood-inventory-item[data-unit-id="${unitId}"]`);
            if (selectedEl) {
                selectedEl.style.borderColor = '#f59e0b';
            }

            // 顯示掃碼確認區塊
            const scanSection = document.getElementById('scanConfirmSection');
            scanSection.style.display = 'block';
            document.getElementById('selectedUnitDisplay').textContent = unitId;
            document.getElementById('scanConfirmInput').value = '';
            document.getElementById('scanConfirmInput').focus();

            // 隱藏後續區塊直到掃碼確認
            document.getElementById('bloodUnitId').value = '';
            document.getElementById('bloodVerificationSection').style.display = 'none';
            document.getElementById('dualVerificationSection').style.display = 'none';

            updateScanConfirmStatus('waiting');
        }

        // v1.1: Step 2 - 掃碼確認
        async function verifyScanConfirm() {
            const scannedId = document.getElementById('scanConfirmInput').value.trim();
            if (!scannedId) {
                updateScanConfirmStatus('waiting');
                return;
            }

            scannedBloodUnitId = scannedId;

            if (scannedId === selectedBloodUnitId) {
                // 掃碼確認成功！
                scanConfirmPassed = true;
                updateScanConfirmStatus('success');

                // 填入血袋編號並觸發驗證
                document.getElementById('bloodUnitId').value = scannedId;

                // Highlight 確認的項目
                document.querySelectorAll('.blood-inventory-item').forEach(el => {
                    el.style.borderColor = 'transparent';
                });
                const selectedEl = document.querySelector(`.blood-inventory-item[data-unit-id="${scannedId}"]`);
                if (selectedEl) {
                    selectedEl.style.borderColor = '#10b981';
                }

                // 呼叫後端確認 API
                try {
                    const patientId = currentCase?.patient_id || 'UNKNOWN';
                    await apiFetch('/api/blood/scan-confirm', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            selected_unit_id: selectedBloodUnitId,
                            scanned_unit_id: scannedBloodUnitId,
                            patient_id: patientId
                        })
                    });
                } catch (err) {
                    console.warn('Scan confirm API call failed (non-blocking):', err);
                }

                // 觸發血袋驗證
                verifyBloodUnit();
            } else {
                // 掃碼不符！
                scanConfirmPassed = false;
                updateScanConfirmStatus('mismatch');
            }
        }

        function updateScanConfirmStatus(status) {
            const statusEl = document.getElementById('scanConfirmStatus');
            const statusMap = {
                'waiting': { text: '請掃描血袋條碼確認', color: '#f59e0b', bg: 'rgba(245, 158, 11, 0.1)' },
                'success': { text: '✅ 掃碼確認成功！', color: '#10b981', bg: 'rgba(16, 185, 129, 0.1)' },
                'mismatch': { text: '❌ 條碼不符！請確認拿對血袋', color: '#ef4444', bg: 'rgba(239, 68, 68, 0.1)' }
            };
            const s = statusMap[status] || statusMap['waiting'];
            statusEl.textContent = s.text;
            statusEl.style.color = s.color;
            statusEl.style.background = s.bg;
        }

        // 原本的 selectBloodUnit (保留向後相容，直接跳過掃碼確認)
        function selectBloodUnit(unitId, bloodType) {
            // 直接使用 (用於緊急模式或手動輸入)
            selectedBloodUnitId = unitId;
            scannedBloodUnitId = unitId;
            scanConfirmPassed = true;

            document.getElementById('bloodUnitId').value = unitId;
            document.querySelectorAll('.blood-inventory-item').forEach(el => {
                el.style.borderColor = 'transparent';
            });
            const selectedEl = document.querySelector(`.blood-inventory-item[data-unit-id="${unitId}"]`);
            if (selectedEl) {
                selectedEl.style.borderColor = '#dc2626';
            }
            verifyBloodUnit();
        }

        // ================================================================
        // Phase 1-3: Blood Chain of Custody Functions
        // ================================================================

        let bloodVerificationResult = null;
        let dualVerificationPassed = false;

        async function verifyBloodUnit() {
            const unitId = document.getElementById('bloodUnitId').value.trim();
            if (!unitId) {
                document.getElementById('bloodVerificationSection').style.display = 'none';
                document.getElementById('dualVerificationSection').style.display = 'none';
                bloodVerificationResult = null;
                return;
            }

            // Show verification section
            const verifySection = document.getElementById('bloodVerificationSection');
            verifySection.style.display = 'block';

            // Reset to loading state
            const statusBadge = document.getElementById('verificationStatusBadge');
            statusBadge.textContent = '檢查中...';
            statusBadge.style.background = '#6b7280';
            statusBadge.style.color = 'white';

            document.getElementById('verifyBloodType').innerHTML = '<span class="verify-icon">⏳</span> 血型相符';
            document.getElementById('verifyExpiry').innerHTML = '<span class="verify-icon">⏳</span> 效期有效';
            document.getElementById('verifyStatus').innerHTML = '<span class="verify-icon">⏳</span> 狀態可用';
            document.getElementById('verificationWarnings').style.display = 'none';
            document.getElementById('verificationErrors').style.display = 'none';

            try {
                // Get patient blood type from current case if available
                const patientBloodType = currentCase?.patient_blood_type || null;

                const res = await apiFetch('/api/blood/verify', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        blood_unit_id: unitId,
                        patient_id: currentCase?.patient_id || 'UNKNOWN',
                        patient_blood_type: patientBloodType
                    })
                });

                const data = await res.json();
                bloodVerificationResult = data;

                // Update UI based on result
                const details = data.details || {};

                // Blood type
                if (details.blood_type_compatible === true) {
                    document.getElementById('verifyBloodType').innerHTML = `<span class="verify-icon">✅</span> 血型相符 (${details.unit_blood_type || '--'})`;
                } else if (details.blood_type_compatible === false) {
                    document.getElementById('verifyBloodType').innerHTML = `<span class="verify-icon">❌</span> 血型不符！(血袋: ${details.unit_blood_type}, 病人: ${details.patient_blood_type})`;
                    // Show mismatch warning modal
                    showBloodMismatchWarning(details.unit_blood_type, details.patient_blood_type);
                } else {
                    document.getElementById('verifyBloodType').innerHTML = `<span class="verify-icon">⚠️</span> 血型: ${details.unit_blood_type || '--'} (未提供病人血型)`;
                }

                // Expiry
                if (details.not_expired === true) {
                    const hours = details.hours_until_expiry || 0;
                    if (hours < 24) {
                        document.getElementById('verifyExpiry').innerHTML = `<span class="verify-icon">⚠️</span> 即將過期 (剩餘 ${hours} 小時)`;
                    } else {
                        document.getElementById('verifyExpiry').innerHTML = `<span class="verify-icon">✅</span> 效期有效 (${details.expiry_date})`;
                    }
                } else {
                    document.getElementById('verifyExpiry').innerHTML = '<span class="verify-icon">❌</span> 已過期！';
                }

                // Status
                if (details.status_valid === true) {
                    document.getElementById('verifyStatus').innerHTML = `<span class="verify-icon">✅</span> 狀態可用 (${details.current_status || 'AVAILABLE'})`;
                } else {
                    document.getElementById('verifyStatus').innerHTML = `<span class="verify-icon">❌</span> 狀態不可用 (${details.current_status})`;
                }

                // Overall status
                if (data.match) {
                    statusBadge.textContent = '✓ 驗證通過';
                    statusBadge.style.background = '#22c55e';
                    // Show dual verification section for START action
                    document.getElementById('dualVerificationSection').style.display = 'block';
                    // Pre-fill actor1 with current user
                    if (actorId && !document.getElementById('custodyActor1').value) {
                        document.getElementById('custodyActor1').value = actorId;
                        checkDualVerification();
                    }
                } else {
                    statusBadge.textContent = '✗ 驗證失敗';
                    statusBadge.style.background = '#ef4444';
                    document.getElementById('dualVerificationSection').style.display = 'none';
                }

                // Warnings
                if (data.warnings && data.warnings.length > 0) {
                    const warningsDiv = document.getElementById('verificationWarnings');
                    warningsDiv.innerHTML = '⚠️ ' + data.warnings.join('<br>⚠️ ');
                    warningsDiv.style.display = 'block';
                }

                // Errors
                if (data.errors && data.errors.length > 0) {
                    const errorsDiv = document.getElementById('verificationErrors');
                    errorsDiv.innerHTML = '❌ ' + data.errors.join('<br>❌ ');
                    errorsDiv.style.display = 'block';
                }

            } catch (err) {
                console.error('Blood verification failed:', err);
                statusBadge.textContent = '驗證失敗';
                statusBadge.style.background = '#6b7280';
                bloodVerificationResult = null;
            }
        }

        function showBloodMismatchWarning(unitType, patientType) {
            document.getElementById('mismatchUnitType').textContent = unitType || '--';
            document.getElementById('mismatchPatientType').textContent = patientType || '--';
            document.getElementById('bloodMismatchModal').classList.add('active');
        }

        function checkDualVerification() {
            const actor1 = document.getElementById('custodyActor1').value.trim();
            const actor2 = document.getElementById('custodyActor2').value.trim();
            const statusDiv = document.getElementById('dualVerificationStatus');

            // Update individual status
            document.getElementById('actor1Status').innerHTML = actor1 ? '✓ 已輸入' : '未驗證';
            document.getElementById('actor1Status').style.color = actor1 ? '#22c55e' : 'var(--text-muted)';

            document.getElementById('actor2Status').innerHTML = actor2 ? '✓ 已輸入' : '未驗證';
            document.getElementById('actor2Status').style.color = actor2 ? '#22c55e' : 'var(--text-muted)';

            // Check if both are filled
            if (actor1 && actor2) {
                if (actor1 === actor2) {
                    statusDiv.innerHTML = '❌ 兩位人員不可相同';
                    statusDiv.style.background = 'rgba(239, 68, 68, 0.2)';
                    statusDiv.style.color = '#ef4444';
                    dualVerificationPassed = false;
                } else {
                    statusDiv.innerHTML = '✓ 雙人核對完成';
                    statusDiv.style.background = 'rgba(34, 197, 94, 0.2)';
                    statusDiv.style.color = '#22c55e';
                    dualVerificationPassed = true;
                }
            } else {
                statusDiv.innerHTML = '⚠️ 需要兩位人員確認才能記錄輸血';
                statusDiv.style.background = 'rgba(255,255,255,0.1)';
                statusDiv.style.color = 'var(--text)';
                dualVerificationPassed = false;
            }
        }

        async function recordCustodyEvent(unitId, step, patientId) {
            const actor1 = document.getElementById('custodyActor1').value.trim();
            const actor2 = document.getElementById('custodyActor2').value.trim();

            try {
                const res = await apiFetch(`/api/blood/units/${unitId}/custody`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        step: step,
                        patient_id: patientId,
                        actor1_id: actor1 || actorId,
                        actor2_id: actor2 || null,
                        location: 'OR',  // TODO: Get from case or config
                        notes: null
                    })
                });

                const data = await res.json();
                console.log('Custody event recorded:', data);
                return data;
            } catch (err) {
                console.error('Failed to record custody event:', err);
                return null;
            }
        }

        async function showCustodyTimeline(unitId) {
            try {
                const res = await apiFetch(`/api/blood/units/${unitId}/custody`);
                const data = await res.json();

                const content = document.getElementById('custodyTimelineContent');
                const chain = data.chain || [];

                if (chain.length === 0) {
                    content.innerHTML = '<div style="text-align: center; color: var(--text-muted); padding: 20px;">尚無追蹤記錄</div>';
                } else {
                    content.innerHTML = `
                        <div style="margin-bottom: 16px; padding: 12px; background: var(--bg); border-radius: 8px;">
                            <div style="font-weight: 600;">血袋: ${unitId}</div>
                            <div style="font-size: 14px; color: var(--text-muted);">血型: ${data.blood_type} | 病人: ${data.patient_id || '--'}</div>
                        </div>
                        <div class="custody-timeline">
                            ${chain.map((event, idx) => `
                                <div class="custody-event" style="display: flex; gap: 12px; margin-bottom: 16px;">
                                    <div style="width: 40px; text-align: center;">
                                        <div style="width: 12px; height: 12px; background: ${idx === chain.length - 1 ? '#22c55e' : '#6b7280'}; border-radius: 50%; margin: 4px auto;"></div>
                                        ${idx < chain.length - 1 ? '<div style="width: 2px; height: 40px; background: #334155; margin: 0 auto;"></div>' : ''}
                                    </div>
                                    <div style="flex: 1;">
                                        <div style="font-weight: 600;">${getStepLabel(event.step)}</div>
                                        <div style="font-size: 12px; color: var(--text-muted);">${event.timestamp ? new Date(event.timestamp).toLocaleString('zh-TW') : '--'}</div>
                                        <div style="font-size: 12px; margin-top: 4px;">
                                            ${event.actor1 ? `執行: ${event.actor1.name || event.actor1.id}` : ''}
                                            ${event.actor2 ? ` | 覆核: ${event.actor2.name || event.actor2.id}` : ''}
                                        </div>
                                        <div style="font-size: 12px; color: var(--text-muted);">${event.location || ''}</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        <div style="text-align: center; font-size: 13px; color: var(--text-muted); margin-top: 16px;">
                            總時間: ${data.elapsed_minutes || 0} 分鐘
                        </div>
                    `;
                }

                document.getElementById('custodyTimelineModal').classList.add('active');
            } catch (err) {
                console.error('Failed to load custody timeline:', err);
            }
        }

        function getStepLabel(step) {
            const labels = {
                'RELEASED': '📦 血庫發血',
                'TRANSPORT_PICKUP': '🚚 傳送取血',
                'TRANSPORT_DELIVERY': '🚚 傳送送達',
                'NURSING_RECEIVED': '📥 護理收血',
                'TRANSFUSION_STARTED': '💉 開始輸血',
                'TRANSFUSION_COMPLETED': '✅ 輸血完成',
                'TRANSFUSION_STOPPED': '⚠️ 輸血中止',
                'RETURNED': '↩️ 退血',
                // v1.1: Emergency steps
                'EMERGENCY_RELEASED': '⚡ 緊急發血',
                'EMERGENCY_RECEIVED': '⚡ 緊急收血',
                'EMERGENCY_TRANSFUSION_STARTED': '⚡ 緊急輸血',
                'LATE_VERIFICATION': '📝 事後覆核',
                'SUPERVISOR_SIGNOFF': '✍️ 主管簽核'
            };
            return labels[step] || step;
        }

        // ================================================================
        // v1.1: Emergency Mode Functions
        // ================================================================

        function showEmergencyModeModal() {
            // Reset form
            document.getElementById('emergencyReason').value = '';
            document.getElementById('emergencyReasonNote').value = '';
            document.getElementById('emergencyUnitId').value = '';
            document.getElementById('emergencyActorId').value = actorId || '';
            document.getElementById('emergencyReasonNoteSection').style.display = 'none';

            document.getElementById('emergencyModeModal').classList.add('active');

            // Focus on unit ID input
            setTimeout(() => {
                document.getElementById('emergencyUnitId').focus();
            }, 100);
        }

        // Show/hide reason note field based on reason selection
        document.addEventListener('DOMContentLoaded', function() {
            const reasonSelect = document.getElementById('emergencyReason');
            if (reasonSelect) {
                reasonSelect.addEventListener('change', function() {
                    const noteSection = document.getElementById('emergencyReasonNoteSection');
                    if (this.value === 'OTHER') {
                        noteSection.style.display = 'block';
                    } else {
                        noteSection.style.display = 'none';
                    }
                });
            }
        });

        async function submitEmergencyTransfusion() {
            const reason = document.getElementById('emergencyReason').value;
            const reasonNote = document.getElementById('emergencyReasonNote').value.trim();
            const unitId = document.getElementById('emergencyUnitId').value.trim();
            const actorIdValue = document.getElementById('emergencyActorId').value.trim();

            // Validation
            if (!reason) {
                alert('請選擇緊急原因');
                return;
            }

            if (reason === 'OTHER' && !reasonNote) {
                alert('請說明緊急原因');
                return;
            }

            if (!actorIdValue) {
                alert('請輸入執行人員工號');
                return;
            }

            // Confirm action
            const confirmMsg = unitId
                ? `確定要以緊急模式開始輸血？\n\n血袋: ${unitId}\n原因: ${reason}\n執行人員: ${actorIdValue}`
                : `確定要以緊急模式開始輸血？\n\n⚠️ 未指定血袋 (將建立 Ad-hoc 記錄)\n原因: ${reason}\n執行人員: ${actorIdValue}`;

            if (!confirm(confirmMsg)) {
                return;
            }

            try {
                const patientId = currentCase?.patient_id || 'UNKNOWN';
                const location = currentCase?.or_room || currentCase?.id || 'OR-1';

                // Call emergency transfusion API
                const res = await apiFetch('/api/blood/units/' + (unitId || 'adhoc') + '/emergency-transfusion', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        patient_id: patientId,
                        actor_id: actorIdValue,
                        location: location,
                        emergency_reason: reason,
                        emergency_reason_note: reason === 'OTHER' ? reasonNote : null,
                        scanned_unit_id: unitId || null
                    })
                });

                const data = await res.json();

                if (data.success) {
                    closeModal('emergencyModeModal');
                    closeModal('bloodModal');

                    // Show success message
                    alert(`⚡ 緊急輸血已記錄！\n\n事件 ID: ${data.event_id || '--'}\n\n📋 請記得在 24 小時內完成事後覆核`);

                    // Refresh case timeline
                    if (currentCase) {
                        await loadCaseTimeline(currentCase.id);
                    }
                } else {
                    throw new Error(data.detail || data.message || '緊急輸血記錄失敗');
                }
            } catch (err) {
                console.error('Emergency transfusion failed:', err);
                alert('緊急輸血記錄失敗: ' + (err.message || '未知錯誤'));
            }
        }

        function backToBloodStep1() {
            document.getElementById('bloodStep1').style.display = 'block';
            document.getElementById('bloodStep2').style.display = 'none';
            selectedBloodProduct = null;
            // Reset verification states
            bloodVerificationResult = null;
            dualVerificationPassed = false;
            // v1.1: Reset scan confirm states
            selectedBloodUnitId = null;
            scannedBloodUnitId = null;
            scanConfirmPassed = false;
            document.getElementById('scanConfirmSection').style.display = 'none';
            document.getElementById('bloodVerificationSection').style.display = 'none';
            document.getElementById('dualVerificationSection').style.display = 'none';
            document.getElementById('custodyActor1').value = '';
            document.getElementById('custodyActor2').value = '';
        }

        function selectBloodAction(action) {
            selectedBloodAction = action;
            // Update button states
            document.querySelectorAll('.blood-action-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.action === action);
            });
            // Show/hide reaction section
            const reactionSection = document.getElementById('bloodReactionSection');
            if (action === 'REACTION') {
                reactionSection.style.display = 'block';
                // Reset reaction type selection
                document.querySelectorAll('.reaction-type-btn').forEach(btn => btn.classList.remove('active'));
                selectedReactionType = null;
            } else {
                reactionSection.style.display = 'none';
                selectedReactionType = null;
            }
        }

        function selectReactionType(type) {
            selectedReactionType = type;
            // Update button states
            document.querySelectorAll('.reaction-type-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.type === type);
            });
        }

        async function submitBloodProduct() {
            if (!currentCase || !selectedBloodProduct) {
                alert('請先選擇血品類型');
                return;
            }

            const unitId = document.getElementById('bloodUnitId').value.trim();
            if (!unitId) {
                alert('請輸入血袋編號');
                return;
            }

            if (selectedBloodAction === 'REACTION' && !selectedReactionType) {
                alert('請選擇反應類型');
                return;
            }

            // Phase 2: Check dual verification for START action
            if (selectedBloodAction === 'START') {
                const actor1 = document.getElementById('custodyActor1').value.trim();
                const actor2 = document.getElementById('custodyActor2').value.trim();

                if (!actor1 || !actor2) {
                    alert('開始輸血需要雙人核對，請填寫兩位人員工號');
                    return;
                }

                if (actor1 === actor2) {
                    alert('兩位核對人員不可相同');
                    return;
                }
            }

            try {
                // Get time offset data
                const timeData = getTimeOffsetData('blood');

                // Build request body
                const body = {
                    product_type: selectedBloodProduct,
                    unit_id: unitId,
                    action: selectedBloodAction
                };

                // Add reaction data if applicable
                if (selectedBloodAction === 'REACTION') {
                    body.reaction_type = selectedReactionType;
                    const reactionNote = document.getElementById('bloodReactionNote').value.trim();
                    if (reactionNote) {
                        body.reaction_note = reactionNote;
                    }
                }

                // Add time parameters if specified
                if (timeData.clinical_time) {
                    body.clinical_time = timeData.clinical_time;
                } else if (timeData.clinical_time_offset_seconds) {
                    body.clinical_time_offset_seconds = timeData.clinical_time_offset_seconds;
                }

                // Add late entry reason if applicable
                if (timeData.late_entry_reason) {
                    body.late_entry_reason = timeData.late_entry_reason;
                    body.late_entry_note = timeData.late_entry_note;
                }

                const res = await apiFetch(`${API_BASE}/cases/${currentCase.id}/blood-product?actor_id=${actorId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });

                if (!res.ok) throw new Error('Failed');

                // Phase 2-3: Record custody event
                const custodyStepMap = {
                    'START': 'TRANSFUSION_STARTED',
                    'COMPLETE': 'TRANSFUSION_COMPLETED',
                    'REACTION': 'TRANSFUSION_STOPPED'
                };
                const custodyStep = custodyStepMap[selectedBloodAction];
                if (custodyStep) {
                    await recordCustodyEvent(unitId, custodyStep, currentCase.patient_id);
                }

                closeModal('bloodModal');

                // Reset verification states
                bloodVerificationResult = null;
                dualVerificationPassed = false;

                // Show action-specific success message
                const actionLabels = {
                    'START': '開始輸血',
                    'COMPLETE': '輸血完成',
                    'REACTION': '輸血反應'
                };
                alert(`✓ ${selectedBloodProduct} ${actionLabels[selectedBloodAction]} 已記錄`);

                loadTimeline(currentCase.id);
            } catch (err) {
                alert('記錄失敗: ' + getErrorMessage(err));
            }
        }

        // =================================================================
        // Advanced Events: Vasoactive, Vent, Depth, Position
        // =================================================================

        function showVasoactiveModal() {
            if (!currentCase) {
                alert('請先選擇或建立一個麻醉案例');
                return;
            }
            document.getElementById('vasoactiveModal').classList.add('active');
        }

        async function selectVasoactive(drug, dose, unit) {
            const indication = document.getElementById('vasoactiveIndication').value;

            try {
                const res = await apiFetch(`${API_BASE}/cases/${currentCase.id}/events?actor_id=${actorId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        event_type: 'VASOACTIVE_BOLUS',
                        payload: {
                            drug_name: drug,
                            dose: dose,
                            unit: unit,
                            route: 'IV',
                            indication: indication
                        }
                    })
                });
                if (!res.ok) throw new Error('Failed');

                closeModal('vasoactiveModal');
                alert(`✓ ${drug} ${dose}${unit} 已記錄`);
                loadTimeline(currentCase.id);
            } catch (err) {
                alert('記錄失敗: ' + getErrorMessage(err));
            }
        }

        function showVentModal() {
            if (!currentCase) {
                alert('請先選擇或建立一個麻醉案例');
                return;
            }
            document.getElementById('ventFromValue').value = '';
            document.getElementById('ventToValue').value = '';
            updateVentInputs();
            document.getElementById('ventModal').classList.add('active');
        }

        function updateVentInputs() {
            const param = document.getElementById('ventParameter').value;
            const unitHint = document.getElementById('ventUnitHint');
            const units = {
                'FIO2': '%',
                'PEEP': 'cmH2O',
                'VT': 'mL',
                'RR': '/min',
                'PIP_LIMIT': 'cmH2O'
            };
            unitHint.textContent = '單位: ' + (units[param] || '');
        }

        async function submitVentChange() {
            const param = document.getElementById('ventParameter').value;
            const fromVal = document.getElementById('ventFromValue').value;
            const toVal = document.getElementById('ventToValue').value;
            const reason = document.getElementById('ventReason').value;

            if (!toVal) {
                alert('請輸入新設定值');
                return;
            }

            try {
                const res = await apiFetch(`${API_BASE}/cases/${currentCase.id}/events?actor_id=${actorId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        event_type: 'VENT_SETTING_CHANGE',
                        payload: {
                            parameter: param,
                            from_value: fromVal || null,
                            to_value: toVal,
                            reason: reason || null
                        }
                    })
                });
                if (!res.ok) throw new Error('Failed');

                closeModal('ventModal');
                alert(`✓ ${param} 調整已記錄`);
                loadTimeline(currentCase.id);
            } catch (err) {
                alert('記錄失敗: ' + getErrorMessage(err));
            }
        }

        let depthAction = 'DEEPEN';

        function showDepthModal() {
            if (!currentCase) {
                alert('請先選擇或建立一個麻醉案例');
                return;
            }
            setDepthAction('DEEPEN');
            updateDepthInputs();
            document.getElementById('depthModal').classList.add('active');
        }

        function setDepthAction(action) {
            depthAction = action;
            document.getElementById('btnDeepen').style.background = action === 'DEEPEN' ? '#7c3aed' : 'var(--card-hover)';
            document.getElementById('btnLighten').style.background = action === 'LIGHTEN' ? '#7c3aed' : 'var(--card-hover)';
        }

        function updateDepthInputs() {
            const method = document.getElementById('depthMethod').value;
            document.getElementById('depthVolatileInputs').style.display = method === 'VOLATILE' ? 'block' : 'none';
            document.getElementById('depthBolusInputs').style.display = method === 'IV_BOLUS' ? 'block' : 'none';
        }

        async function submitDepthAdjust() {
            const method = document.getElementById('depthMethod').value;
            const reason = document.getElementById('depthReason').value;

            const payload = {
                action: depthAction,
                method: method,
                reason: reason || null
            };

            if (method === 'VOLATILE') {
                payload.mac_from = parseFloat(document.getElementById('macFrom').value) || null;
                payload.mac_to = parseFloat(document.getElementById('macTo').value) || null;
            } else if (method === 'IV_BOLUS') {
                payload.bolus_dose = document.getElementById('bolusAgent').value;
            }

            try {
                const res = await apiFetch(`${API_BASE}/cases/${currentCase.id}/events?actor_id=${actorId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        event_type: 'ANESTHESIA_DEPTH_ADJUST',
                        payload: payload
                    })
                });
                if (!res.ok) throw new Error('Failed');

                closeModal('depthModal');
                alert(`✓ 麻醉深度${depthAction === 'DEEPEN' ? '加深' : '減淺'} 已記錄`);
                loadTimeline(currentCase.id);
            } catch (err) {
                alert('記錄失敗: ' + getErrorMessage(err));
            }
        }

        function showPositionModal() {
            if (!currentCase) {
                alert('請先選擇或建立一個麻醉案例');
                return;
            }
            document.getElementById('positionModal').classList.add('active');
        }

        async function submitPosition(position) {
            try {
                const res = await apiFetch(`${API_BASE}/cases/${currentCase.id}/events?actor_id=${actorId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        event_type: 'POSITION_CHANGE',
                        payload: {
                            position: position
                        }
                    })
                });
                if (!res.ok) throw new Error('Failed');

                closeModal('positionModal');
                alert(`✓ 姿勢調整已記錄: ${position}`);
                loadTimeline(currentCase.id);
            } catch (err) {
                alert('記錄失敗: ' + getErrorMessage(err));
            }
        }

        // =================================================================
        // Special Techniques (v1.1 Billing Integration)
        // =================================================================

        let selectedTechniques = [];

        function showTechniqueModal() {
            if (!currentCase) {
                alert('請先選擇或建立一個麻醉案例');
                return;
            }
            // Reset checkboxes and load existing techniques
            document.querySelectorAll('.technique-toggle input[type="checkbox"]').forEach(cb => {
                cb.checked = selectedTechniques.includes(cb.value);
            });
            document.getElementById('techniqueModal').classList.add('active');
        }

        function toggleTechnique(checkbox) {
            // Visual feedback is handled by CSS
        }

        async function saveTechniques() {
            // Collect checked techniques
            const techniques = [];
            document.querySelectorAll('.technique-toggle input[type="checkbox"]:checked').forEach(cb => {
                techniques.push(cb.value);
            });

            try {
                const res = await apiFetch(`${API_BASE}/cases/${currentCase.id}/events?actor_id=${actorId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        event_type: 'SPECIAL_TECHNIQUE',
                        payload: {
                            techniques: techniques,
                            action: 'UPDATE'
                        }
                    })
                });
                if (!res.ok) throw new Error('Failed');

                selectedTechniques = techniques;
                closeModal('techniqueModal');

                const techLabels = {
                    'CVP': '中央靜脈導管',
                    'ART': '動脈導管',
                    'TEE': '經食道心超',
                    'BIS': '腦電雙頻指數',
                    'ULTRASOUND': '超音波導引',
                    'FIBER_INTUB': '纖維插管',
                    'DLT': '雙腔氣管內管',
                    'NERVE_BLOCK': '神經阻斷'
                };
                const techNames = techniques.map(t => techLabels[t] || t).join(', ');
                alert(`✓ 特殊技術已記錄: ${techNames || '無'}`);
                loadTimeline(currentCase.id);
            } catch (err) {
                alert('記錄失敗: ' + getErrorMessage(err));
            }
        }

        // Load existing techniques when case is loaded
        async function loadCaseTechniques(caseId) {
            try {
                const res = await apiFetch(`${API_BASE}/cases/${caseId}/events`);
                if (res.ok) {
                    const data = await res.json();
                    // Find the latest SPECIAL_TECHNIQUE event
                    const techEvent = data.events?.filter(e => e.event_type === 'SPECIAL_TECHNIQUE')
                        .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))[0];
                    if (techEvent && techEvent.payload?.techniques) {
                        selectedTechniques = techEvent.payload.techniques;
                    } else {
                        selectedTechniques = [];
                    }
                }
            } catch (err) {
                console.error('Failed to load techniques:', err);
            }
        }

        // =================================================================
        // Edit Case Info (v1.1 - ASA/Technique)
        // =================================================================

        function showEditCaseInfoModal() {
            if (!currentCase) return;

            // Populate current values
            document.getElementById('editTechnique').value = currentCase.planned_technique || 'GA';
            document.getElementById('editAsaClass').value = currentCase.asa_classification || 'II';
            document.getElementById('editAsaEmergency').checked = currentCase.is_emergency || false;

            document.getElementById('editCaseInfoModal').classList.add('active');
        }

        async function saveEditCaseInfo() {
            if (!currentCase) return;

            const technique = document.getElementById('editTechnique').value;
            const asaClass = document.getElementById('editAsaClass').value;
            const isEmergency = document.getElementById('editAsaEmergency').checked;

            try {
                const res = await apiFetch(`${API_BASE}/cases/${currentCase.id}?actor_id=${actorId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        planned_technique: technique,
                        asa_classification: asaClass,
                        is_emergency: isEmergency
                    })
                });

                if (!res.ok) throw new Error('Failed to update');

                // Update local state
                currentCase.planned_technique = technique;
                currentCase.asa_classification = asaClass;
                currentCase.is_emergency = isEmergency;

                // Update UI
                updateCaseInfoDisplay();

                closeModal('editCaseInfoModal');
                alert('✓ 麻醉資訊已更新');
            } catch (err) {
                alert('更新失敗: ' + getErrorMessage(err));
            }
        }

        function updateCaseInfoDisplay() {
            if (!currentCase) return;

            // Technique display
            const techniqueLabels = {
                'GA': 'GA', 'GA_ETT': 'GA-ETT', 'GA_LMA': 'GA-LMA',
                'RA_SPINAL': 'Spinal', 'RA_EPIDURAL': 'Epidural', 'RA_NERVE': 'Nerve Block',
                'MAC': 'MAC', 'LA': 'Local',
                // Legacy values
                'SEDATION': 'Sedation'
            };
            const techLabel = techniqueLabels[currentCase.planned_technique] || currentCase.planned_technique || 'N/A';
            document.getElementById('techniqueInfo').textContent = techLabel;

            // ASA display
            const asa = currentCase.asa_classification || 'II';
            const emergency = currentCase.is_emergency ? '+E' : '';
            const asaText = `ASA ${asa}${emergency}`;
            const asaEl = document.getElementById('asaInfo');
            asaEl.textContent = asaText;

            // Emergency styling
            if (currentCase.is_emergency) {
                asaEl.classList.add('emergency');
            } else {
                asaEl.classList.remove('emergency');
            }
        }

        function switchTab(tab) {
            // Update nav items
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            event.target.closest('.nav-item').classList.add('active');

            if (tab === 'case') {
                // Go back to case list
                currentCase = null;
                document.getElementById('activeCaseView').classList.add('hidden');
                document.getElementById('noCaseView').classList.remove('hidden');
                document.getElementById('resourceBar').classList.add('hidden');
                loadCases();
            } else if (tab === 'preop') {
                if (!currentCase) {
                    alert('請先選擇或建立案例');
                    return;
                }
                // Load existing preop data if available
                loadPreopData(currentCase.id);
                document.getElementById('preopModal').classList.add('active');
            } else if (tab === 'drugs') {
                if (!currentCase) {
                    alert('請先選擇或建立案例');
                    return;
                }
                loadDrugHoldings();
                loadDrugTransactions();
                document.getElementById('drugsModal').classList.add('active');
            } else if (tab === 'o2') {
                showO2Modal();
            } else if (tab === 'ivio') {
                if (!currentCase) {
                    alert('請先選擇或建立案例');
                    return;
                }
                loadIVIOData();
                document.getElementById('ivioModal').classList.add('active');
            }
        }

        // =================================================================
        // Phase B: Controlled Drugs Functions
        // =================================================================

        let drugHoldings = [];
        let currentDrugTxType = 'ADMIN';

        // Controlled drug list for quick selection
        const CONTROLLED_DRUGS = [
            { code: 'FENT001', name: 'Fentanyl', unit: 'mcg', schedule_class: 2 },
            { code: 'MIDA001', name: 'Midazolam', unit: 'mg', schedule_class: 4 },
            { code: 'PROP001', name: 'Propofol', unit: 'mg', schedule_class: 4 },
            { code: 'KETA001', name: 'Ketamine', unit: 'mg', schedule_class: 3 },
            { code: 'MORP001', name: 'Morphine', unit: 'mg', schedule_class: 2 },
            { code: 'REMI001', name: 'Remifentanil', unit: 'mcg', schedule_class: 2 },
        ];

        async function loadDrugHoldings() {
            if (!currentCase) return;

            try {
                const res = await apiFetch(`${API_BASE}/cases/${currentCase.id}/drugs/holdings`);
                const data = await res.json();

                drugHoldings = data.holdings || [];
                const totalBalance = data.total_balance || 0;

                // Update status badge
                const statusEl = document.getElementById('holdingsStatus');
                if (totalBalance === 0) {
                    statusEl.textContent = '已結清';
                    statusEl.className = 'holdings-status reconciled';
                } else {
                    statusEl.textContent = `餘額: ${totalBalance}`;
                    statusEl.className = 'holdings-status pending';
                }

                // Update holdings list
                const listEl = document.getElementById('holdingsList');
                if (drugHoldings.length === 0) {
                    listEl.innerHTML = `<div style="color: var(--text-muted); text-align: center; padding: 12px;">尚無領藥記錄</div>`;
                } else {
                    listEl.innerHTML = drugHoldings.map(h => `
                        <div class="holding-item">
                            <div class="holding-drug-name">${h.drug_name}</div>
                            <div class="holding-balance ${h.balance === 0 ? 'zero' : ''}">${h.balance} ${h.unit}</div>
                        </div>
                    `).join('');
                }
            } catch (err) {
                console.error('Failed to load drug holdings:', err);
            }
        }

        async function loadDrugTransactions() {
            if (!currentCase) return;

            try {
                const res = await apiFetch(`${API_BASE}/cases/${currentCase.id}/drugs/transactions`);
                const data = await res.json();

                const historyEl = document.getElementById('drugTxHistory');
                if (!data.transactions || data.transactions.length === 0) {
                    historyEl.innerHTML = `<div class="empty-state" style="padding: 20px;"><p>尚無交易記錄</p></div>`;
                } else {
                    historyEl.innerHTML = data.transactions.map(tx => `
                        <div class="tx-item">
                            <span class="tx-type ${tx.tx_type}">${tx.tx_type}</span>
                            <div class="tx-info">
                                <div class="tx-drug">${tx.drug_name}</div>
                                <div class="tx-detail">${tx.tx_time?.substring(11, 16) || ''} · ${tx.actor_id}${tx.witness_id ? ' (見證: ' + tx.witness_id + ')' : ''}</div>
                            </div>
                            <div class="tx-amount">${tx.tx_type === 'DISPENSE' ? '+' : '-'}${tx.quantity} ${tx.unit}</div>
                        </div>
                    `).join('');
                }
            } catch (err) {
                console.error('Failed to load drug transactions:', err);
            }
        }

        function updateDrugSelect(includeAllDrugs = false) {
            const select = document.getElementById('drugTxDrugSelect');
            let options = '<option value="">選擇藥品...</option>';

            if (includeAllDrugs) {
                // For DISPENSE, show all controlled drugs
                CONTROLLED_DRUGS.forEach(d => {
                    options += `<option value="${d.code}" data-name="${d.name}" data-unit="${d.unit}" data-class="${d.schedule_class}">${d.name}</option>`;
                });
            } else {
                // For ADMIN/WASTE/RETURN, only show drugs with balance > 0
                drugHoldings.filter(h => h.balance > 0).forEach(h => {
                    options += `<option value="${h.drug_code}" data-name="${h.drug_name}" data-unit="${h.unit}" data-balance="${h.balance}">${h.drug_name} (餘 ${h.balance} ${h.unit})</option>`;
                });
            }

            select.innerHTML = options;
        }

        function showDrugDispenseForm() {
            currentDrugTxType = 'DISPENSE';
            document.getElementById('drugTxTitle').textContent = '領藥記錄';
            document.getElementById('drugTxWitnessGroup').classList.add('hidden');
            updateDrugSelect(true);
            document.getElementById('drugTxForm').classList.remove('hidden');
            document.getElementById('drugTxAvailable').textContent = '';
        }

        function showDrugAdminForm() {
            if (drugHoldings.filter(h => h.balance > 0).length === 0) {
                alert('目前無可用藥品，請先領藥');
                return;
            }
            currentDrugTxType = 'ADMIN';
            document.getElementById('drugTxTitle').textContent = '給藥記錄';
            document.getElementById('drugTxWitnessGroup').classList.add('hidden');
            updateDrugSelect(false);
            document.getElementById('drugTxForm').classList.remove('hidden');
        }

        function showDrugWasteForm() {
            if (drugHoldings.filter(h => h.balance > 0).length === 0) {
                alert('目前無可廢棄藥品');
                return;
            }
            currentDrugTxType = 'WASTE';
            document.getElementById('drugTxTitle').textContent = '廢棄記錄 (需見證人)';
            document.getElementById('drugTxWitnessGroup').classList.remove('hidden');
            updateDrugSelect(false);
            document.getElementById('drugTxForm').classList.remove('hidden');
        }

        function showDrugReturnForm() {
            if (drugHoldings.filter(h => h.balance > 0).length === 0) {
                alert('目前無可退回藥品');
                return;
            }
            currentDrugTxType = 'RETURN';
            document.getElementById('drugTxTitle').textContent = '退回藥品';
            document.getElementById('drugTxWitnessGroup').classList.add('hidden');
            updateDrugSelect(false);
            document.getElementById('drugTxForm').classList.remove('hidden');
        }

        function hideDrugTxForm() {
            document.getElementById('drugTxForm').classList.add('hidden');
            document.getElementById('drugTxQuantity').value = '';
            document.getElementById('drugTxWitness').value = '';
            document.getElementById('drugTxNotes').value = '';
        }

        // Update available balance when drug is selected
        document.addEventListener('DOMContentLoaded', () => {
            const drugSelect = document.getElementById('drugTxDrugSelect');
            if (drugSelect) {
                drugSelect.addEventListener('change', function() {
                    const option = this.options[this.selectedIndex];
                    const unit = option.dataset.unit || 'mg';
                    const balance = option.dataset.balance || '';
                    document.getElementById('drugTxUnit').textContent = unit;
                    if (balance && currentDrugTxType !== 'DISPENSE') {
                        document.getElementById('drugTxAvailable').textContent = `可用: ${balance} ${unit}`;
                    } else {
                        document.getElementById('drugTxAvailable').textContent = '';
                    }
                });
            }
        });

        async function submitDrugTx() {
            if (!currentCase) return;

            const drugSelect = document.getElementById('drugTxDrugSelect');
            const option = drugSelect.options[drugSelect.selectedIndex];

            if (!option.value) {
                alert('請選擇藥品');
                return;
            }

            const quantity = parseFloat(document.getElementById('drugTxQuantity').value);
            if (!quantity || quantity <= 0) {
                alert('請輸入有效劑量');
                return;
            }

            // Check witness for WASTE
            let witnessId = null;
            if (currentDrugTxType === 'WASTE') {
                witnessId = document.getElementById('drugTxWitness').value.trim();
                if (!witnessId) {
                    alert('廢棄管藥需要見證人 ID');
                    return;
                }
            }

            const body = {
                drug_code: option.value,
                drug_name: option.dataset.name || option.text.split(' (')[0],
                quantity: quantity,
                unit: option.dataset.unit || 'mg',
                tx_type: currentDrugTxType,
                schedule_class: parseInt(option.dataset.class) || 4,
                witness_id: witnessId,
                notes: document.getElementById('drugTxNotes').value.trim() || null
            };

            try {
                const res = await apiFetch(`${API_BASE}/cases/${currentCase.id}/drugs/transaction?actor_id=${actorId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });

                if (!res.ok) {
                    const err = await res.json();
                    throw new Error(err.detail || 'Transaction failed');
                }

                // Refresh data
                hideDrugTxForm();
                await loadDrugHoldings();
                await loadDrugTransactions();
            } catch (err) {
                alert('記錄失敗: ' + err.message);
            }
        }

        async function loadPreopData(caseId) {
            try {
                // Reset checkboxes first
                document.getElementById('flagAllergic').checked = false;
                document.getElementById('flagFullStomach').checked = false;
                document.getElementById('flagDifficultAirway').checked = false;
                document.getElementById('flagUnstable').checked = false;
                document.getElementById('flagHighRisk').checked = false;
                document.getElementById('preopQuickNote').value = '';

                const res = await apiFetch(`${API_BASE}/cases/${caseId}/battlefield-preop`);
                if (res.ok) {
                    const data = await res.json();
                    if (data.battlefield_preop) {
                        document.getElementById('flagAllergic').checked = data.battlefield_preop.is_allergic;
                        document.getElementById('flagFullStomach').checked = data.battlefield_preop.is_full_stomach;
                        document.getElementById('flagDifficultAirway').checked = data.battlefield_preop.is_difficult_airway;
                        document.getElementById('flagUnstable').checked = data.battlefield_preop.is_hemodynamically_unstable;
                        document.getElementById('flagHighRisk').checked = data.battlefield_preop.is_high_risk;
                        document.getElementById('preopQuickNote').value = data.battlefield_preop.quick_note || '';
                    }
                }
            } catch (err) {
                console.log('No preop data yet');
            }
        }

        async function savePreop() {
            if (!currentCase) return;

            const payload = {
                is_allergic: document.getElementById('flagAllergic').checked,
                is_full_stomach: document.getElementById('flagFullStomach').checked,
                is_difficult_airway: document.getElementById('flagDifficultAirway').checked,
                is_hemodynamically_unstable: document.getElementById('flagUnstable').checked,
                is_high_risk: document.getElementById('flagHighRisk').checked,
                quick_note: document.getElementById('preopQuickNote').value
            };

            try {
                const res = await apiFetch(`${API_BASE}/cases/${currentCase.id}/battlefield-preop?actor_id=${actorId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!res.ok) throw new Error('Failed');

                closeModal('preopModal');
                alert('術前評估已儲存');
            } catch (err) {
                alert('儲存失敗: ' + err.message);
            }
        }

        function showMilestoneMenu() {
            const milestones = [
                { label: '麻醉開始', value: 'ANESTHESIA_START' },
                { label: '插管 Intubation', value: 'INTUBATION', isAirway: true },
                { label: '手術開始', value: 'SURGERY_START' },
                { label: '手術結束', value: 'SURGERY_END' },
                { label: '拔管 Extubation', value: 'EXTUBATION', isAirway: true },
                { label: '麻醉結束', value: 'ANESTHESIA_END' }
            ];

            const choice = prompt(
                '選擇里程碑:\n\n' +
                milestones.map((m, i) => `${i + 1}. ${m.label}`).join('\n') +
                '\n\n請輸入編號:'
            );

            const idx = parseInt(choice) - 1;
            if (idx >= 0 && idx < milestones.length) {
                const m = milestones[idx];
                if (m.isAirway) {
                    addAirwayEvent(m.value);
                } else {
                    addMilestone(m.value);
                }
            }
        }

        function showMoreActions() {
            // Keep for backwards compatibility
            showMilestoneMenu();
        }

        async function addAirwayEvent(action) {
            if (!currentCase) return;

            const body = {
                event_type: 'AIRWAY_EVENT',
                payload: { action: action }
            };

            try {
                const res = await apiFetch(`${API_BASE}/cases/${currentCase.id}/events?actor_id=${actorId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });

                if (!res.ok) throw new Error('Failed');
                loadTimeline(currentCase.id);
            } catch (err) {
                alert('記錄失敗');
            }
        }

        async function closeCase() {
            if (!currentCase) return;
            if (!confirm('確定要關閉此案例?')) return;

            try {
                const res = await apiFetch(`${API_BASE}/cases/${currentCase.id}/close?actor_id=${actorId}`, {
                    method: 'POST'
                });

                if (!res.ok) throw new Error('Failed');

                currentCase = null;
                document.getElementById('activeCaseView').classList.add('hidden');
                document.getElementById('resourceBar').classList.add('hidden');
                document.getElementById('noCaseView').classList.remove('hidden');
                loadCases();
            } catch (err) {
                alert('關閉失敗: ' + err.message);
            }
        }

        // =================================================================
        // PDF Generation (v2.1) - M0073 Anesthesia Record
        // Auto-detect: WeasyPrint (RPi5/Local) or HTML Preview (Vercel)
        // =================================================================

        // Detect if running on Vercel demo environment
        function isVercelDemo() {
            const hostname = window.location.hostname;
            return hostname.includes('vercel.app') ||
                   hostname.includes('.vercel.') ||
                   hostname.includes('mirs') && hostname.includes('.app');
        }

        async function downloadPDF() {
            if (!currentCase) {
                alert('請先選擇案例');
                return;
            }
            // 改為先預覽，讓使用者決定是否列印/下載
            openPDFPreviewModal(currentCase.id);
        }

        // 直接下載 PDF (供預覽視窗中的下載按鈕使用)
        async function downloadPDFDirect(caseId) {
            const btn = event.target.closest('button');
            const originalText = btn.innerHTML;
            btn.innerHTML = '下載中...';
            btn.disabled = true;

            try {
                const res = await fetch(`${API_BASE}/cases/${caseId}/pdf?hospital_name=${encodeURIComponent('烏日林新醫院')}`);

                if (!res.ok) {
                    const error = await res.json().catch(() => ({ detail: 'PDF 生成失敗' }));
                    throw new Error(error.detail || 'PDF 生成失敗');
                }

                // Download the PDF
                const blob = await res.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `M0073_anesthesia_${caseId}.pdf`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);

            } catch (err) {
                console.error('PDF download error:', err);
                alert('PDF 下載失敗: ' + err.message);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        function openPDFPreviewModal(caseId) {
            // Show the PDF preview modal with instructions
            const modal = document.getElementById('pdfPreviewModal');
            const previewUrl = `${API_BASE}/cases/${caseId}/pdf/preview?hospital_name=${encodeURIComponent('烏日林新醫院')}`;
            document.getElementById('pdfPreviewUrl').value = previewUrl;
            document.getElementById('pdfPreviewFrame').src = previewUrl;
            modal.classList.add('active');
        }

        function closePDFPreviewModal() {
            const modal = document.getElementById('pdfPreviewModal');
            modal.classList.remove('active');
            document.getElementById('pdfPreviewFrame').src = 'about:blank';
        }

        function openPDFInNewTab() {
            const url = document.getElementById('pdfPreviewUrl').value;
            const win = window.open(url, '_blank');
            // Show print dialog hint
            setTimeout(() => {
                alert('請在新視窗中按 Ctrl+P (Windows) 或 Cmd+P (Mac) 來列印/儲存 PDF');
            }, 500);
        }

        function printPDFPreview() {
            const frame = document.getElementById('pdfPreviewFrame');
            frame.contentWindow.print();
        }

        async function previewPDF() {
            if (!currentCase) return;

            const caseId = currentCase.id;
            // Open preview in new window
            window.open(`${API_BASE}/cases/${caseId}/pdf/preview?hospital_name=${encodeURIComponent('烏日林新醫院')}`, '_blank');
        }

        function showCustomMedForm() {
            const code = prompt('藥物代碼:');
            const name = prompt('藥物名稱:');
            const dose = parseFloat(prompt('劑量:'));
            const unit = prompt('單位 (mg/mcg/ml):');

            if (code && name && dose && unit) {
                quickMed(code, name, dose, unit);
            }
        }

        // =================================================================
        // Timeline Chart v1.2 - Canvas Rendering with Hour Pagination
        // =================================================================

        const timelineChart = {
            canvas: null,
            ctx: null,
            data: { vitals: [], medications: [], milestones: [], events: [] },
            viewport: {
                startTime: null,
                endTime: null,
                duration: 3600000,
                pixelWidth: 720,
            },
            caseStartTime: null,
            currentHourIndex: 0,
            hours: [],

            init() {
                this.canvas = document.getElementById('vitalsCanvas');
                if (!this.canvas) return;
                this.ctx = this.canvas.getContext('2d');
                this.resize();
                window.addEventListener('resize', () => this.resize());

                // Smooth drag/pan support for touch devices
                let isDragging = false;
                let dragStartX = 0;
                let dragStartTime = 0;

                // Touch events
                this.canvas.addEventListener('touchstart', (e) => {
                    isDragging = true;
                    dragStartX = e.touches[0].clientX;
                    dragStartTime = this.viewport.startTime;
                    e.preventDefault(); // Prevent page scroll
                }, { passive: false });

                this.canvas.addEventListener('touchmove', (e) => {
                    if (!isDragging) return;
                    const deltaX = e.touches[0].clientX - dragStartX;
                    // Convert pixel delta to time delta (negative because drag right = go back in time)
                    const pixelsPerMs = this.viewport.pixelWidth / this.viewport.duration;
                    const timeDelta = -deltaX / pixelsPerMs;
                    this.panToTime(dragStartTime + timeDelta);
                    e.preventDefault();
                }, { passive: false });

                this.canvas.addEventListener('touchend', () => {
                    isDragging = false;
                });

                // Mouse drag support (for desktop testing)
                this.canvas.addEventListener('mousedown', (e) => {
                    isDragging = true;
                    dragStartX = e.clientX;
                    dragStartTime = this.viewport.startTime;
                    this.canvas.style.cursor = 'grabbing';
                });

                document.addEventListener('mousemove', (e) => {
                    if (!isDragging) return;
                    const deltaX = e.clientX - dragStartX;
                    const pixelsPerMs = this.viewport.pixelWidth / this.viewport.duration;
                    const timeDelta = -deltaX / pixelsPerMs;
                    this.panToTime(dragStartTime + timeDelta);
                });

                document.addEventListener('mouseup', () => {
                    if (isDragging) {
                        isDragging = false;
                        this.canvas.style.cursor = 'grab';
                    }
                });

                // Set initial cursor
                this.canvas.style.cursor = 'grab';
            },

            // Pan timeline to specific start time (with bounds checking)
            panToTime(newStartTime) {
                if (!this.caseStartTime) return;
                const now = Date.now();
                const minStart = this.caseStartTime - 300000; // Allow 5 min before case start
                const maxStart = now - 60000; // Don't show future (allow 1 min buffer)

                this.viewport.startTime = Math.max(minStart, Math.min(maxStart, newStartTime));
                this.viewport.endTime = this.viewport.startTime + this.viewport.duration;

                // Update which hour we're in
                const hourIndex = this.hours.findIndex(h =>
                    this.viewport.startTime >= h.time && this.viewport.startTime < h.time + 3600000
                );
                if (hourIndex >= 0) this.currentHourIndex = hourIndex;

                this.updateHourChips();
                this.render();
                this.updateNowIndicator();
            },

            resize() {
                const container = document.getElementById('timelineChartContainer');
                if (!container || !this.canvas) return;
                const rect = container.getBoundingClientRect();
                // Skip if container has no size (hidden)
                if (rect.width === 0 || rect.height === 0) return;

                // Use container's CSS dimensions for proper sizing
                const width = container.offsetWidth || rect.width;
                const height = container.offsetHeight || rect.height || 280;

                console.log('[Timeline] Resize:', width, 'x', height);

                // Set canvas internal resolution
                this.canvas.width = width;
                this.canvas.height = height;
                // Set display size
                this.canvas.style.width = width + 'px';
                this.canvas.style.height = height + 'px';
                // Reset transform
                this.ctx.setTransform(1, 0, 0, 1, 0, 0);
                // Calculate drawable area (minus left margin for Y labels)
                this.viewport.pixelWidth = width - 60;
                this.render();
            },

            setData(timelineData, caseStartTime) {
                this.data = timelineData;
                this.caseStartTime = new Date(caseStartTime).getTime();
                // Always resize first to ensure canvas has proper dimensions
                this.resize();
                this.calculateHours();
                // Default to hour with most recent events, or last hour
                const hourWithEvents = this.hours.findIndex(h => h.hasEvents);
                this.currentHourIndex = hourWithEvents >= 0 ? hourWithEvents : Math.max(0, this.hours.length - 1);
                this.setViewportToHour(this.currentHourIndex);
                this.updateHourChips();
                this.updateMilestones();
                this.render();
                this.updateNowIndicator();
            },

            calculateHours() {
                const now = Date.now();
                const startHour = Math.floor(this.caseStartTime / 3600000) * 3600000;
                const endHour = Math.ceil(now / 3600000) * 3600000;
                this.hours = [];
                for (let h = startHour; h <= endHour; h += 3600000) {
                    const hasEvents = this.data.vitals.some(v =>
                        new Date(v.clinical_time).getTime() >= h &&
                        new Date(v.clinical_time).getTime() < h + 3600000
                    );
                    this.hours.push({ time: h, hasEvents });
                }
            },

            setViewportToHour(index) {
                if (index < 0 || index >= this.hours.length) return;
                this.currentHourIndex = index;
                this.viewport.startTime = this.hours[index].time;
                this.viewport.endTime = this.viewport.startTime + this.viewport.duration;
                this.updateHourChips();
                this.render();
                this.updateNowIndicator();
            },

            prevHour() { if (this.currentHourIndex > 0) this.setViewportToHour(this.currentHourIndex - 1); },
            nextHour() { if (this.currentHourIndex < this.hours.length - 1) this.setViewportToHour(this.currentHourIndex + 1); },

            updateHourChips() {
                const container = document.getElementById('hourChips');
                if (!container) return;
                container.innerHTML = this.hours.map((h, i) => {
                    const hourStr = new Date(h.time).toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' });
                    const activeClass = i === this.currentHourIndex ? 'active' : '';
                    const eventsClass = h.hasEvents ? 'has-events' : '';
                    return `<span class="hour-chip ${activeClass} ${eventsClass}" onclick="timelineChart.setViewportToHour(${i})">${hourStr}</span>`;
                }).join('');

                const prevBtn = document.getElementById('btnPrevHour');
                const nextBtn = document.getElementById('btnNextHour');
                if (prevBtn) prevBtn.disabled = this.currentHourIndex === 0;
                if (nextBtn) nextBtn.disabled = this.currentHourIndex >= this.hours.length - 1;
            },

            updateNowIndicator() {
                const indicator = document.getElementById('nowIndicator');
                if (!indicator) return;
                const now = Date.now();
                if (now >= this.viewport.startTime && now <= this.viewport.endTime) {
                    const x = this.timeToX(now) + 50;
                    indicator.style.display = 'block';
                    indicator.style.left = x + 'px';
                } else {
                    indicator.style.display = 'none';
                }
            },

            updateMilestones() {
                const milestones = this.data.milestones || [];
                const map = {
                    'INDUCTION': 'msInduction', 'ANESTHESIA_START': 'msInduction',
                    'INTUBATION': 'msIntubation', 'INCISION': 'msIncision', 'SURGERY_START': 'msIncision',
                    'SKIN_CLOSE': 'msSkinClose', 'SURGERY_END': 'msSkinClose',
                    'EXTUBATION': 'msExtubation', 'PACU': 'msPacu', 'ANESTHESIA_END': 'msPacu'
                };
                document.querySelectorAll('.milestone-chip').forEach(el => el.classList.add('pending'));
                milestones.forEach(m => {
                    const type = m.payload?.type || m.event_type;
                    const el = document.getElementById(map[type]);
                    if (el) {
                        el.classList.remove('pending');
                        const time = new Date(m.clinical_time).toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' });
                        el.innerHTML = el.textContent.split(' ')[0] + ' <small>' + time + '</small>';
                    }
                });
            },

            timeToX(timestamp) {
                const elapsed = timestamp - this.viewport.startTime;
                return Math.round((elapsed / this.viewport.duration) * this.viewport.pixelWidth);
            },

            render() {
                if (!this.ctx || !this.canvas) return;
                const width = this.canvas.width;
                const height = this.canvas.height;
                // Ensure clean slate - reset transform and clear entire canvas
                this.ctx.setTransform(1, 0, 0, 1, 0, 0);
                this.ctx.clearRect(0, 0, width, height);
                this.drawGrid(width, height);
                this.drawVitals(width, height);
                this.drawEvents(width, height);
            },

            drawGrid(width, height) {
                const ctx = this.ctx;
                const mL = 50, mT = 20, mB = 40;
                const chartH = height - mT - mB;

                ctx.fillStyle = '#1e293b';
                ctx.fillRect(mL, mT, width - mL - 10, chartH);

                ctx.strokeStyle = '#334155';
                ctx.lineWidth = 0.5;
                for (let m = 0; m <= 60; m += 10) {
                    const x = mL + (m / 60) * this.viewport.pixelWidth;
                    ctx.beginPath(); ctx.moveTo(x, mT); ctx.lineTo(x, height - mB); ctx.stroke();
                    ctx.fillStyle = '#94a3b8';
                    ctx.font = '10px sans-serif';
                    ctx.textAlign = 'center';
                    const time = new Date(this.viewport.startTime + m * 60000);
                    ctx.fillText(time.toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' }), x, height - mB + 15);
                }

                [200, 150, 100, 50, 0].forEach(v => {
                    const y = mT + chartH * (1 - v / 200);
                    ctx.beginPath(); ctx.moveTo(mL, y); ctx.lineTo(width - 10, y); ctx.stroke();
                    ctx.fillStyle = '#94a3b8';
                    ctx.textAlign = 'right';
                    ctx.fillText(v.toString(), mL - 5, y + 4);
                });
            },

            drawVitals(width, height) {
                const ctx = this.ctx;
                const mL = 50, mT = 20, mB = 40;
                const chartH = height - mT - mB;

                console.log('[Timeline] Drawing vitals, total:', this.data.vitals?.length || 0);
                console.log('[Timeline] Viewport:', new Date(this.viewport.startTime).toLocaleTimeString(), '-', new Date(this.viewport.endTime).toLocaleTimeString());

                const vitalsInView = this.data.vitals.filter(v => {
                    const t = new Date(v.clinical_time).getTime();
                    return t >= this.viewport.startTime && t <= this.viewport.endTime;
                });
                console.log('[Timeline] Vitals in view:', vitalsInView.length);
                if (vitalsInView.length === 0) return;

                // SBP (V symbol)
                this.drawLine(vitalsInView, 'bp_sys', '#dc2626', 'V', mL, mT, chartH);
                // DBP (^ symbol)
                this.drawLine(vitalsInView, 'bp_dia', '#dc2626', '^', mL, mT, chartH);
                // HR (● symbol)
                this.drawLine(vitalsInView, 'hr', '#2563eb', '●', mL, mT, chartH);
                // SpO2 (○ symbol, scaled)
                this.drawSpo2(vitalsInView, mL, mT, chartH);
            },

            drawLine(vitals, key, color, symbol, mL, mT, chartH) {
                const ctx = this.ctx;
                const filtered = vitals.filter(v => v.payload[key]);
                if (filtered.length === 0) return;

                ctx.strokeStyle = color;
                ctx.fillStyle = color;
                ctx.lineWidth = 1.5;
                ctx.beginPath();
                filtered.forEach((v, i) => {
                    const x = mL + this.timeToX(new Date(v.clinical_time).getTime());
                    const val = Math.min(v.payload[key], 200);
                    const y = mT + chartH * (1 - val / 200);
                    if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
                });
                ctx.stroke();

                filtered.forEach(v => {
                    const x = mL + this.timeToX(new Date(v.clinical_time).getTime());
                    const val = Math.min(v.payload[key], 200);
                    const y = mT + chartH * (1 - val / 200);
                    if (symbol === '●') {
                        ctx.beginPath(); ctx.arc(x, y, 4, 0, Math.PI * 2); ctx.fill();
                    } else {
                        ctx.font = '12px sans-serif';
                        ctx.textAlign = 'center';
                        ctx.fillText(symbol, x, y + 4);
                    }
                });
            },

            drawSpo2(vitals, mL, mT, chartH) {
                const ctx = this.ctx;
                const filtered = vitals.filter(v => v.payload.spo2);
                if (filtered.length === 0) return;

                ctx.strokeStyle = '#10b981';
                ctx.lineWidth = 1.5;
                ctx.beginPath();
                filtered.forEach((v, i) => {
                    const x = mL + this.timeToX(new Date(v.clinical_time).getTime());
                    const spo2 = v.payload.spo2;
                    const mapped = 100 + (spo2 - 80) * 5;
                    const y = mT + chartH * (1 - mapped / 200);
                    if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
                });
                ctx.stroke();

                filtered.forEach(v => {
                    const x = mL + this.timeToX(new Date(v.clinical_time).getTime());
                    const spo2 = v.payload.spo2;
                    const mapped = 100 + (spo2 - 80) * 5;
                    const y = mT + chartH * (1 - mapped / 200);
                    ctx.strokeStyle = '#10b981';
                    ctx.lineWidth = 1.5;
                    ctx.beginPath(); ctx.arc(x, y, 4, 0, Math.PI * 2); ctx.stroke();
                });
            },

            drawEvents(width, height) {
                const ctx = this.ctx;
                const mL = 50;
                const baseEventY = height - 25;

                const medsInView = (this.data.medications || []).filter(m => {
                    const t = new Date(m.clinical_time).getTime();
                    return t >= this.viewport.startTime && t <= this.viewport.endTime;
                });

                // Sort by time and assign stack levels for overlapping medications
                medsInView.sort((a, b) => new Date(a.clinical_time) - new Date(b.clinical_time));

                // Track stack levels to avoid overlap (within 2 minutes = 120000ms)
                const stackLevels = [];
                const STACK_THRESHOLD = 120000; // 2 minutes
                const STACK_OFFSET = 20; // pixels between stacked items

                medsInView.forEach((m, i) => {
                    const t = new Date(m.clinical_time).getTime();
                    const x = mL + this.timeToX(t);

                    // Calculate stack level - check how many previous meds are within threshold
                    let stackLevel = 0;
                    for (let j = i - 1; j >= 0; j--) {
                        const prevT = new Date(medsInView[j].clinical_time).getTime();
                        if (t - prevT < STACK_THRESHOLD) {
                            stackLevel = (stackLevels[j] + 1) % 4; // Max 4 levels, then wrap
                        } else {
                            break;
                        }
                    }
                    stackLevels[i] = stackLevel;

                    const eventY = baseEventY - (stackLevel * STACK_OFFSET);

                    ctx.fillStyle = m.payload?.is_controlled ? '#c026d3' : '#3b82f6';
                    ctx.beginPath(); ctx.arc(x, eventY, 6, 0, Math.PI * 2); ctx.fill();
                    ctx.fillStyle = '#f1f5f9';
                    ctx.font = '9px sans-serif';
                    ctx.textAlign = 'center';
                    ctx.fillText((m.payload?.drug_name || '').substring(0, 6), x, eventY - 10);
                });
            }
        };

        function setTimelineView(viewType) {
            const chartContainer = document.getElementById('chartViewContainer');
            const listContainer = document.getElementById('timeline');
            const btnList = document.getElementById('btnListView');
            const btnChart = document.getElementById('btnChartView');

            if (viewType === 'chart') {
                chartContainer?.classList.remove('hidden');
                listContainer?.classList.add('hidden');
                btnList?.classList.remove('active');
                btnChart?.classList.add('active');
                // Initialize chart if needed, with slight delay for DOM to be ready
                setTimeout(() => {
                    timelineChart.init();
                    timelineChart.resize();
                }, 50);
            } else {
                chartContainer?.classList.add('hidden');
                listContainer?.classList.remove('hidden');
                btnList?.classList.add('active');
                btnChart?.classList.remove('active');
            }
        }

        // Legacy function for backward compatibility
        function toggleTimelineView() {
            const chartContainer = document.getElementById('chartViewContainer');
            if (chartContainer?.classList.contains('hidden')) {
                setTimelineView('chart');
            } else {
                setTimelineView('list');
            }
        }

        function updateStatButton() {
            const btn = document.getElementById('statButton');
            if (btn) {
                btn.classList.toggle('hidden', !(currentCase && currentCase.status === 'IN_PROGRESS'));
            }
        }

        async function showStatModal() {
            const meds = [
                { code: 'EPINEPHRINE', name: 'Epinephrine', dose: 1, unit: 'mg', desc: '心跳停止/過敏性休克' },
                { code: 'ATROPINE', name: 'Atropine', dose: 1, unit: 'mg', desc: '心跳過慢' },
                { code: 'EPHEDRINE', name: 'Ephedrine', dose: 10, unit: 'mg', desc: '血壓過低' },
                { code: 'SUCCINYL', name: 'Succinylcholine', dose: 100, unit: 'mg', desc: '緊急插管' }
            ];
            const choice = prompt('⚡ STAT 緊急用藥\n\n' + meds.map((m, i) => `${i + 1}. ${m.name} ${m.dose}${m.unit} - ${m.desc}`).join('\n') + '\n\n輸入編號:');
            const idx = parseInt(choice) - 1;
            if (idx >= 0 && idx < meds.length) {
                const med = meds[idx];
                try {
                    await apiFetch(`${API_BASE}/cases/${currentCase.id}/events?actor_id=${actorId}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            event_type: 'MEDICATION_ADMIN',
                            payload: { drug_code: med.code, drug_name: med.name, dose: med.dose, unit: med.unit, route: 'IV', is_stat: true }
                        })
                    });
                    alert(`✓ ${med.name} ${med.dose}${med.unit} IV STAT 已記錄`);
                    loadTimeline(currentCase.id);
                } catch (err) { alert('記錄失敗'); }
            }
        }

        // Override loadTimeline to update chart
        const _originalLoadTimeline = typeof loadTimeline !== 'undefined' ? loadTimeline : null;
    </script>

    <script>
        // Enhanced loadTimeline with chart update
        // Helper: translate event type to Chinese
        function getEventTypeLabel(type) {
            const labels = {
                'VITAL_SIGN': '生命徵象',
                'MEDICATION_ADMIN': '給藥',
                'MILESTONE': '里程碑',
                'OXYGEN_CHANGE': '氧氣',
                'NOTE': '備註'
            };
            return labels[type] || type;
        }

        async function loadTimeline(caseId) {
            try {
                const res = await apiFetch(`${API_BASE}/cases/${caseId}/timeline`);
                const data = await res.json();
                const timelineEl = document.getElementById('timeline');

                if (data.all.length === 0) {
                    timelineEl.innerHTML = `<div class="empty-state"><p>尚無事件<br><small style="color:var(--text-muted);">使用上方按鈕記錄 Vitals、給藥、里程碑</small></p></div>`;
                    return;
                }

                const events = data.all.sort((a, b) => new Date(b.clinical_time) - new Date(a.clinical_time));
                timelineEl.innerHTML = events.slice(0, 30).map(e => {
                    const time = new Date(e.clinical_time).toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' });
                    const dotClass = e.event_type === 'VITAL_SIGN' ? 'vital' : e.event_type === 'MEDICATION_ADMIN' ? 'med' : e.event_type === 'MILESTONE' ? 'milestone' : '';
                    const typeLabel = getEventTypeLabel(e.event_type);
                    let desc = '';
                    if (e.event_type === 'VITAL_SIGN') {
                        const p = e.payload;
                        desc = `BP ${p.bp_sys || '--'}/${p.bp_dia || '--'}, HR ${p.hr || '--'}, SpO2 ${p.spo2 || '--'}%`;
                    } else if (e.event_type === 'MEDICATION_ADMIN') {
                        desc = `${e.payload.drug_name} ${e.payload.dose}${e.payload.unit} ${e.payload.route}`;
                    } else if (e.event_type === 'MILESTONE') {
                        desc = getMilestoneLabel(e.payload.type);
                    } else {
                        desc = JSON.stringify(e.payload).substring(0, 50);
                    }
                    return `<div class="timeline-item"><div class="timeline-time">${time}</div><div class="timeline-dot ${dotClass}"></div><div class="timeline-content"><div class="timeline-type">${typeLabel}</div><div class="timeline-desc">${desc}</div></div></div>`;
                }).join('');

                const lastVital = data.vitals[data.vitals.length - 1];
                if (lastVital) {
                    document.getElementById('lastSpo2').textContent = lastVital.payload.spo2 || '--';
                    document.getElementById('lastHr').textContent = lastVital.payload.hr || '--';
                    document.getElementById('lastBp').textContent = `${lastVital.payload.bp_sys || '--'}/${lastVital.payload.bp_dia || '--'}`;
                }

                // Update chart (initialize if not yet done)
                if (currentCase) {
                    if (!timelineChart.canvas) {
                        timelineChart.init();
                    }
                    if (timelineChart.canvas) {
                        const startTime = currentCase.started_at || currentCase.created_at;
                        console.log('[Timeline] Updating chart with', data.vitals?.length || 0, 'vitals, caseStart:', startTime);
                        timelineChart.setData({
                            vitals: data.vitals || [],
                            medications: data.medications || [],
                            milestones: data.milestones || [],
                            events: data.all || []
                        }, startTime);
                    }
                }
            } catch (err) {
                console.error('Failed to load timeline:', err);
            }
        }

        // =================================================================
        // v2.1: IV/IO Management Functions
        // =================================================================

        let ivLines = [];
        let monitors = [];
        let ioBalance = { input: {}, output: {}, balance_ml: 0 };

        async function loadIVIOData() {
            if (!currentCase) return;

            try {
                // Load IV lines
                const ivRes = await apiFetch(`${API_BASE}/cases/${currentCase.id}/iv-lines`);
                const ivData = await ivRes.json();
                ivLines = ivData.iv_lines || [];
                renderIVLines();

                // Load monitors
                const monRes = await apiFetch(`${API_BASE}/cases/${currentCase.id}/monitors`);
                const monData = await monRes.json();
                monitors = monData.monitors || [];
                renderMonitors();

                // Load I/O balance
                const ioRes = await apiFetch(`${API_BASE}/cases/${currentCase.id}/io-balance`);
                ioBalance = await ioRes.json();
                renderIOBalance();

            } catch (err) {
                console.error('Failed to load IV/IO data:', err);
            }
        }

        function renderIVLines() {
            const container = document.getElementById('ivLinesList');
            if (ivLines.length === 0) {
                container.innerHTML = '<div style="color: var(--text-muted); text-align: center; padding: 16px;">尚無 IV 管路</div>';
                return;
            }

            container.innerHTML = ivLines.map(line => `
                <div class="iv-line-card ${line.removed_at ? 'removed' : ''}">
                    <div class="iv-line-header">
                        <div>
                            <span class="iv-line-site">#${line.line_number} ${line.site}</span>
                            <span class="iv-line-gauge">${line.gauge || ''}</span>
                        </div>
                        ${!line.removed_at ? `<button onclick="removeIVLine('${line.line_id}')" style="background: none; border: none; color: #ef4444; cursor: pointer; font-size: 0.75rem;">移除</button>` : '<span style="color: var(--text-muted); font-size: 0.75rem;">已移除</span>'}
                    </div>
                    ${!line.removed_at ? `
                        <div class="iv-rate-control">
                            <span style="font-size: 0.75rem; color: var(--text-muted);">滴速:</span>
                            <input type="number" class="iv-rate-input" value="${line.current_rate_ml_hr || 0}" onchange="updateIVRate('${line.line_id}', this.value)">
                            <span style="font-size: 0.75rem;">ml/hr</span>
                            <span style="margin-left: auto; font-size: 0.75rem; color: var(--text-muted);">累計: ${line.total_volume_ml || 0} ml</span>
                        </div>
                    ` : ''}
                </div>
            `).join('');
        }

        function renderMonitors() {
            const container = document.getElementById('monitorsList');
            const urineSection = document.getElementById('urineSection');

            if (monitors.length === 0) {
                container.innerHTML = '<span style="color: var(--text-muted);">無監測器</span>';
                urineSection.style.display = 'none';
                return;
            }

            const hasFoley = monitors.some(m => m.monitor_type === 'FOLEY' && !m.stopped_at);
            urineSection.style.display = hasFoley ? 'block' : 'none';

            if (hasFoley) {
                const foley = monitors.find(m => m.monitor_type === 'FOLEY' && !m.stopped_at);
                document.getElementById('urineTotalDisplay').textContent = `累計: ${foley.total_urine_ml || 0} ml`;
            }

            container.innerHTML = monitors.filter(m => !m.stopped_at).map(m => {
                let badgeClass = '';
                let label = m.monitor_type;
                if (m.monitor_type === 'FOLEY') { badgeClass = 'foley'; label = 'Foley'; }
                if (m.monitor_type === 'AIR_BLANKET') { badgeClass = 'air'; label = '保溫毯'; }
                return `<span class="monitor-badge ${badgeClass}" onclick="stopMonitor('${m.monitor_id}')">${label} ×</span>`;
            }).join('');
        }

        function renderIOBalance() {
            const input = ioBalance.input || {};
            const output = ioBalance.output || {};

            document.getElementById('ioInputTotal').textContent = `${input.total_ml || 0} ml`;
            document.getElementById('ioInputBreakdown').textContent = `晶體 ${input.crystalloid_ml || 0} / 膠體 ${input.colloid_ml || 0} / 血品 ${input.blood_ml || 0}`;

            document.getElementById('ioOutputTotal').textContent = `${output.total_ml || 0} ml`;
            document.getElementById('ioOutputBreakdown').textContent = `尿量 ${output.urine_ml || 0} / 失血 ${output.blood_loss_ml || 0}`;

            const net = ioBalance.balance_ml || 0;
            const netEl = document.getElementById('ioNetBalance');
            netEl.textContent = `${net >= 0 ? '+' : ''}${net} ml`;
            netEl.style.color = net >= 0 ? '#22c55e' : '#ef4444';
        }

        function showAddIVLineDialog() {
            document.getElementById('ivSiteSelect').value = '';
            document.getElementById('ivGaugeSelect').value = '';
            document.getElementById('ivRateInput').value = '';
            document.getElementById('addIVLineModal').classList.add('active');
        }

        async function insertIVLine() {
            const site = document.getElementById('ivSiteSelect').value;
            if (!site) { alert('請選擇部位'); return; }

            const gauge = document.getElementById('ivGaugeSelect').value;
            const rate = parseInt(document.getElementById('ivRateInput').value) || 0;
            const catheterType = site.includes('CVC') ? 'CVC' : 'PERIPHERAL';

            try {
                const res = await apiFetch(`${API_BASE}/cases/${currentCase.id}/iv-lines?actor_id=${actorId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ site, gauge, catheter_type: catheterType, rate_ml_hr: rate })
                });

                if (!res.ok) throw new Error('Failed');

                closeModal('addIVLineModal');
                loadIVIOData();
            } catch (err) {
                alert('插入失敗: ' + getErrorMessage(err));
            }
        }

        async function updateIVRate(lineId, rate) {
            try {
                await apiFetch(`${API_BASE}/cases/${currentCase.id}/iv-lines/${lineId}?actor_id=${actorId}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ rate_ml_hr: parseInt(rate) || 0 })
                });
            } catch (err) {
                alert('更新失敗: ' + getErrorMessage(err));
            }
        }

        async function removeIVLine(lineId) {
            if (!confirm('確定移除此 IV 管路？')) return;

            try {
                await apiFetch(`${API_BASE}/cases/${currentCase.id}/iv-lines/${lineId}?actor_id=${actorId}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ removed: true })
                });
                loadIVIOData();
            } catch (err) {
                alert('移除失敗: ' + getErrorMessage(err));
            }
        }

        async function quickFluid(fluidType, amount) {
            // Find first active IV line
            const activeLine = ivLines.find(l => !l.removed_at);
            if (!activeLine) {
                alert('請先插入 IV 管路');
                return;
            }

            try {
                await apiFetch(`${API_BASE}/cases/${currentCase.id}/iv-lines/${activeLine.line_id}/fluids?actor_id=${actorId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ fluid_type: fluidType, amount_ml: amount })
                });
                loadIVIOData();
            } catch (err) {
                alert('給予輸液失敗: ' + getErrorMessage(err));
            }
        }

        function showAddMonitorDialog() {
            document.getElementById('monitorTypeSelect').value = '';
            document.getElementById('foleySettingsDiv').style.display = 'none';
            document.getElementById('airBlanketSettingsDiv').style.display = 'none';
            document.getElementById('addMonitorModal').classList.add('active');
        }

        function onMonitorTypeChange() {
            const type = document.getElementById('monitorTypeSelect').value;
            document.getElementById('foleySettingsDiv').style.display = type === 'FOLEY' ? 'block' : 'none';
            document.getElementById('airBlanketSettingsDiv').style.display = type === 'AIR_BLANKET' ? 'block' : 'none';
        }

        async function startMonitor() {
            const monitorType = document.getElementById('monitorTypeSelect').value;
            if (!monitorType) { alert('請選擇類型'); return; }

            let settings = {};
            if (monitorType === 'FOLEY') {
                settings.foley_size = document.getElementById('foleySizeSelect').value;
            } else if (monitorType === 'AIR_BLANKET') {
                settings.temperature_setting = document.getElementById('airBlanketTempSelect').value;
            }

            try {
                await apiFetch(`${API_BASE}/cases/${currentCase.id}/monitors?actor_id=${actorId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ monitor_type: monitorType, settings })
                });

                closeModal('addMonitorModal');
                loadIVIOData();
            } catch (err) {
                alert('啟動失敗: ' + getErrorMessage(err));
            }
        }

        async function stopMonitor(monitorId) {
            if (!confirm('確定停止此監測器？')) return;

            try {
                await apiFetch(`${API_BASE}/cases/${currentCase.id}/monitors/${monitorId}?actor_id=${actorId}`, {
                    method: 'DELETE'
                });
                loadIVIOData();
            } catch (err) {
                alert('停止失敗: ' + getErrorMessage(err));
            }
        }

        async function recordUrineOutput() {
            const amount = parseInt(document.getElementById('urineAmountInput').value);
            if (!amount || amount <= 0) { alert('請輸入有效尿量'); return; }

            try {
                await apiFetch(`${API_BASE}/cases/${currentCase.id}/urine-output?actor_id=${actorId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ amount_ml: amount })
                });

                document.getElementById('urineAmountInput').value = '';
                loadIVIOData();
            } catch (err) {
                alert('記錄失敗: ' + getErrorMessage(err));
            }
        }

        // Init on load
        document.addEventListener('DOMContentLoaded', () => {
            loadSyncQueue();
            loadCases();
            timelineChart.init();
            setInterval(() => timelineChart.updateNowIndicator(), 60000);
            setInterval(() => { if (isOnline && syncQueue.length > 0) syncWithServer(); }, 30000);
        });
    </script>
</body>
</html>
