<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#DC2626">

    <title>MIRS Blood Bank</title>

    <link rel="manifest" href="/blood/manifest.json">
    <link rel="apple-touch-icon" href="/blood/icons/icon-192x192.png">

    <!-- 本地 CSS (離線支援) -->
    <link rel="stylesheet" href="/static/css/tailwind.min.css">
    <link rel="stylesheet" href="/static/css/mirs-colors.css">

    <style>
        /* Blood Bank 專用色系 */
        :root {
            --blood-50: #fef2f2;
            --blood-100: #fee2e2;
            --blood-200: #fecaca;
            --blood-300: #fca5a5;
            --blood-400: #f87171;
            --blood-500: #ef4444;
            --blood-600: #dc2626;
            --blood-700: #b91c1c;
            --blood-800: #991b1b;
            --blood-900: #7f1d1d;
        }

        .bg-blood-600 { background-color: var(--blood-600); }
        .bg-blood-700 { background-color: var(--blood-700); }
        .text-blood-600 { color: var(--blood-600); }
        .border-blood-600 { border-color: var(--blood-600); }

        /* 血品類型顏色 (v2.6) */
        .unit-type-wb { background-color: #7f1d1d; color: white; }      /* 深紅 - Whole Blood */
        .unit-type-prbc { background-color: #dc2626; color: white; }    /* 紅 - PRBC */
        .unit-type-ffp { background-color: #d97706; color: white; }     /* 琥珀 - FFP */
        .unit-type-plt { background-color: #eab308; color: #1f2937; }   /* 黃 - PLT */
        .unit-type-cryo { background-color: #0891b2; color: white; }    /* 青 - CRYO */

        /* 狀態顏色 */
        .status-available { background-color: #10b981; color: white; }
        .status-reserved { background-color: #3b82f6; color: white; }
        .status-expiring { background-color: #f59e0b; color: white; }
        .status-expired { background-color: #ef4444; color: white; }

        /* 全螢幕阻擋 Modal */
        .blocker-modal {
            position: fixed;
            inset: 0;
            background: #b91c1c;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
        }

        /* 安全區域 */
        .safe-area-top { padding-top: env(safe-area-inset-top); }
        .safe-area-bottom { padding-bottom: env(safe-area-inset-bottom); }
    </style>
</head>
<body class="bg-gray-100 min-h-screen safe-area-top safe-area-bottom" x-data="bloodApp()" x-init="init()">

    <!-- Header -->
    <header class="bg-blood-600 text-white px-4 py-3 sticky top-0 z-50 shadow-lg">
        <div class="flex items-center justify-between">
            <div class="flex items-center gap-2">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z" />
                </svg>
                <h1 class="text-lg font-bold">Blood Bank</h1>
                <span class="text-xs bg-red-800 px-2 py-0.5 rounded">v2.9</span>
            </div>
            <div class="flex items-center gap-2">
                <span x-show="isOffline" class="bg-yellow-500 text-xs px-2 py-1 rounded">離線</span>
                <button @click="refresh()" class="p-2 hover:bg-blood-700 rounded">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                    </svg>
                </button>
            </div>
        </div>
    </header>

    <!-- Tab Navigation (v2.8: 重構 - 庫存總覽含清單、入庫+標籤獨立) -->
    <nav class="bg-white border-b flex">
        <button @click="activeTab = 'overview'"
                :class="activeTab === 'overview' ? 'border-blood-600 text-blood-600' : 'border-transparent text-gray-500'"
                class="flex-1 py-3 text-sm font-medium border-b-2 transition">
            庫存總覽
        </button>
        <button @click="activeTab = 'receive'"
                :class="activeTab === 'receive' ? 'border-blood-600 text-blood-600' : 'border-transparent text-gray-500'"
                class="flex-1 py-3 text-sm font-medium border-b-2 transition">
            入庫+標籤
        </button>
        <button @click="activeTab = 'issue'"
                :class="activeTab === 'issue' ? 'border-blood-600 text-blood-600' : 'border-transparent text-gray-500'"
                class="flex-1 py-3 text-sm font-medium border-b-2 transition">
            發血
        </button>
        <button @click="activeTab = 'pending'; loadPendingOrders()"
                :class="activeTab === 'pending' ? 'border-blood-600 text-blood-600' : 'border-transparent text-gray-500'"
                class="flex-1 py-3 text-sm font-medium border-b-2 transition relative">
            待補單
            <span x-show="pendingOrdersSummary.overdue_count > 0"
                  class="absolute -top-1 -right-1 bg-red-500 text-white text-xs w-5 h-5 rounded-full flex items-center justify-center">
                <span x-text="pendingOrdersSummary.overdue_count"></span>
            </span>
        </button>
    </nav>

    <!-- Main Content -->
    <main class="p-4 pb-24">

        <!-- Overview Tab -->
        <div x-show="activeTab === 'overview'" x-cloak>
            <h2 class="text-lg font-bold mb-4">庫存總覽</h2>

            <!-- v2.5 P4: Pending Orders Alert -->
            <div x-show="pendingOrdersSummary.overdue_count > 0"
                 @click="activeTab = 'pending'; loadPendingOrders()"
                 class="bg-red-50 border-l-4 border-red-500 p-3 mb-4 cursor-pointer hover:bg-red-100 transition">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-2">
                        <svg class="w-5 h-5 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        <span class="font-bold text-red-700">
                            <span x-text="pendingOrdersSummary.overdue_count"></span> 筆待補單已逾期
                        </span>
                    </div>
                    <svg class="w-5 h-5 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                    </svg>
                </div>
                <p class="text-sm text-red-600 mt-1">
                    緊急發血需在 24 小時內補開正式醫囑
                </p>
            </div>

            <!-- FIFO Warning Banner -->
            <div x-show="expiringSoonCount > 0" class="bg-amber-50 border-l-4 border-amber-500 p-3 mb-4">
                <div class="flex items-center gap-2">
                    <svg class="w-5 h-5 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    <span class="font-bold text-amber-700">FIFO 優先發放</span>
                </div>
                <p class="text-sm text-amber-600 mt-1">
                    有 <span class="font-bold" x-text="expiringSoonCount"></span> 袋血品即將過期，請優先發放標有 FIFO 的血袋
                </p>
            </div>

            <!-- Expired Warning Banner -->
            <div x-show="expiredCount > 0" class="bg-red-50 border-l-4 border-red-500 p-3 mb-4">
                <div class="flex items-center gap-2">
                    <svg class="w-5 h-5 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                    </svg>
                    <span class="font-bold text-red-700">已過期血品</span>
                </div>
                <p class="text-sm text-red-600 mt-1">
                    有 <span class="font-bold" x-text="expiredCount"></span> 袋血品已過期，請盡快報廢
                </p>
            </div>

            <!-- Loading -->
            <div x-show="loading" class="text-center py-8 text-gray-500">
                載入中...
            </div>

            <!-- v2.7: MIRS Legacy Style - Big Colored Cards Grid (The Soul of MIRS) -->
            <div x-show="!loading" class="mb-6 max-w-3xl mx-auto">
                <!-- 2x4 Grid of Blood Type Cards -->
                <div class="grid grid-cols-4 sm:grid-cols-8 gap-3">
                    <template x-for="blood in groupedByBloodType" :key="blood.blood_type">
                        <!-- v2.9: 加入 ring 顯示選中狀態 -->
                        <div @click="filterByBloodType(blood.blood_type)"
                             class="cursor-pointer rounded-xl p-4 shadow-lg transform hover:scale-105 transition-all duration-200"
                             :class="{
                                 'bg-red-900 hover:bg-red-800': blood.total > 0 && bloodTypeFilter !== blood.blood_type,
                                 'bg-red-800 ring-4 ring-yellow-400 scale-105': bloodTypeFilter === blood.blood_type,
                                 'bg-gray-700 hover:bg-gray-600': blood.total === 0 && bloodTypeFilter !== blood.blood_type
                             }">
                            <div class="text-center">
                                <!-- Blood Type - HUGE -->
                                <div class="text-3xl sm:text-4xl font-black text-white mb-1" x-text="blood.blood_type"></div>
                                <!-- Count - Yellow for visibility -->
                                <div class="text-xl sm:text-2xl font-bold"
                                     :class="blood.total > 0 ? 'text-yellow-300' : 'text-gray-500'">
                                    <span x-text="blood.total"></span>
                                    <span class="text-sm">袋</span>
                                </div>
                                <!-- Expiring indicator -->
                                <div x-show="blood.expiring > 0"
                                     class="mt-1 text-xs text-orange-400 font-bold animate-pulse">
                                    ⚠ <span x-text="blood.expiring"></span> 即期
                                </div>
                            </div>
                        </div>
                    </template>
                </div>

                <!-- Quick Stats Bar -->
                <div class="mt-4 bg-white rounded-lg shadow p-3 flex items-center justify-between flex-wrap gap-2">
                    <div class="flex items-center gap-4 text-sm">
                        <span class="text-gray-600">總庫存: <span class="font-bold text-gray-900" x-text="totalUnits"></span> 袋</span>
                        <span x-show="totalExpiring > 0" class="text-orange-600 font-bold">
                            即期: <span x-text="totalExpiring"></span>
                        </span>
                    </div>
                    <div class="flex items-center gap-1 sm:gap-2 flex-wrap">
                        <!-- Unit Type Legend -->
                        <span class="text-xs px-1.5 sm:px-2 py-1 rounded unit-type-wb">全血</span>
                        <span class="text-xs px-1.5 sm:px-2 py-1 rounded unit-type-prbc">紅血球</span>
                        <span class="text-xs px-1.5 sm:px-2 py-1 rounded unit-type-ffp">血漿</span>
                        <span class="text-xs px-1.5 sm:px-2 py-1 rounded unit-type-plt">血小板</span>
                    </div>
                </div>

                <!-- v2.9: Active Filter Indicator (統一使用 bloodTypeFilter) -->
                <div x-show="bloodTypeFilter" class="mt-3 flex items-center justify-between bg-blue-50 border border-blue-200 rounded-lg p-2">
                    <span class="text-blue-700 text-sm">
                        篩選中: <span class="font-bold" x-text="bloodTypeFilter"></span>
                    </span>
                    <button @click="bloodTypeFilter = ''" class="text-blue-600 text-sm underline">清除篩選</button>
                </div>
            </div>

            <!-- v2.8: 完整血袋清單 (含 FIFO、預約、發血按鈕) -->
            <!-- v2.9: 移除重複的血型按鈕列，改用上方統計卡片進行篩選 -->
            <div x-show="!loading" class="max-w-3xl mx-auto">
                <!-- Unit List with Full Features -->
                <div class="space-y-2">
                    <template x-for="unit in filteredUnits" :key="unit.id">
                        <div class="bg-white rounded-lg shadow-sm p-3 border-l-8"
                             :class="getUnitTypeBorderColorClass(unit.unit_type)">
                            <!-- Main Row: Blood Type, Component, Status -->
                            <div class="flex items-center justify-between mb-2">
                                <div class="flex items-center gap-3">
                                    <!-- Blood Type - Large -->
                                    <div class="text-2xl font-black text-gray-900 w-14" x-text="unit.blood_type"></div>
                                    <!-- Component Type Badge -->
                                    <span class="text-xs font-bold px-2 py-1 rounded"
                                          :class="getUnitTypeClass(unit.unit_type)"
                                          x-text="getUnitTypeLabel(unit.unit_type)"></span>
                                    <!-- Status Badge -->
                                    <span class="text-xs px-2 py-1 rounded"
                                          :class="{
                                              'bg-green-100 text-green-700': unit.display_status === 'AVAILABLE',
                                              'bg-blue-100 text-blue-700': unit.display_status === 'RESERVED',
                                              'bg-orange-100 text-orange-700': unit.display_status === 'EXPIRING_SOON',
                                              'bg-red-100 text-red-700': unit.display_status === 'EXPIRED'
                                          }"
                                          x-text="statusLabel(unit.display_status)"></span>
                                </div>
                                <!-- FIFO Priority -->
                                <span x-show="unit.fifo_priority === 1"
                                      class="text-xs bg-yellow-400 text-yellow-900 px-2 py-1 rounded font-bold">
                                    FIFO 優先
                                </span>
                            </div>

                            <!-- Second Row: Unit ID (Prominent) & Expiry (Prominent) -->
                            <div class="flex items-center justify-between bg-gray-50 rounded px-2 py-1 mb-2">
                                <div class="font-mono text-sm font-bold text-gray-700" x-text="unit.id"></div>
                                <div class="text-sm font-bold"
                                     :class="{
                                         'text-green-600': unit.hours_until_expiry > 72,
                                         'text-orange-600': unit.hours_until_expiry <= 72 && unit.hours_until_expiry > 24,
                                         'text-red-600 animate-pulse': unit.hours_until_expiry <= 24
                                     }">
                                    <span x-show="unit.hours_until_expiry > 0">
                                        效期: <span x-text="unit.hours_until_expiry"></span>h
                                    </span>
                                    <span x-show="unit.hours_until_expiry <= 0">⚠️ 已過期</span>
                                </div>
                            </div>

                            <!-- Action Buttons -->
                            <div class="flex gap-2" x-show="unit.display_status === 'AVAILABLE' || unit.display_status === 'EXPIRING_SOON'">
                                <button @click="issueUnit(unit)"
                                        class="flex-1 bg-blood-600 text-white py-2 rounded text-sm font-bold hover:bg-blood-700 transition-colors">
                                    發血
                                </button>
                                <button @click="reserveUnit(unit)"
                                        class="flex-1 bg-white text-gray-700 py-2 rounded text-sm font-medium border-2 border-gray-300 hover:border-gray-400">
                                    預約
                                </button>
                            </div>
                            <div x-show="unit.display_status === 'RESERVED'">
                                <button @click="unreserveUnit(unit)"
                                        class="w-full bg-blue-50 text-blue-700 py-2 rounded text-sm font-medium border border-blue-200">
                                    取消預約
                                </button>
                            </div>
                            <div class="text-center text-red-600 text-sm font-bold py-2 bg-red-50 rounded" x-show="unit.display_status === 'EXPIRED'">
                                ⚠️ 此血袋已過期，請報廢處理
                            </div>
                        </div>
                    </template>
                </div>

                <div x-show="filteredUnits.length === 0" class="text-center py-8 text-gray-500">
                    沒有符合條件的血袋
                </div>
            </div>

            <!-- Empty State -->
            <div x-show="!loading && availability.length === 0 && units.length === 0" class="text-center py-8 text-gray-500">
                目前沒有血品庫存
            </div>
        </div>

        <!-- v2.8: 入庫+標籤 Tab (Receive + Label) -->
        <div x-show="activeTab === 'receive'" x-cloak class="max-w-3xl mx-auto">
            <h2 class="text-lg font-bold mb-4">入庫+標籤</h2>

            <!-- 入庫來源選擇卡片 -->
            <div class="grid grid-cols-2 gap-4 mb-6">
                <!-- 捐血中心入庫 -->
                <div @click="receiveForm.source = 'blood_center'; showReceiveModal = true"
                     class="bg-white rounded-xl p-4 shadow-lg border-2 cursor-pointer hover:shadow-xl transition-all"
                     :class="receiveForm.source === 'blood_center' ? 'border-blood-600' : 'border-gray-200 hover:border-blood-400'">
                    <div class="text-center">
                        <div class="bg-red-100 text-red-600 w-12 h-12 rounded-full flex items-center justify-center mx-auto mb-3">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                            </svg>
                        </div>
                        <div class="font-bold text-gray-800">捐血中心</div>
                        <div class="text-xs text-gray-500 mt-1">血液基金會配送</div>
                    </div>
                </div>

                <!-- 緊急捐血 (Walking Blood Bank) - v2.8.1 單色 -->
                <div @click="receiveForm.source = 'walking_donor'; showEmergencyDonationModal = true"
                     class="bg-orange-600 hover:bg-orange-700 rounded-xl p-4 shadow-lg cursor-pointer transition-all text-white">
                    <div class="text-center">
                        <div class="bg-white bg-opacity-20 w-12 h-12 rounded-full flex items-center justify-center mx-auto mb-3">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"/>
                            </svg>
                        </div>
                        <div class="font-bold">緊急捐血</div>
                        <div class="text-xs opacity-80 mt-1">Walking Blood Bank</div>
                    </div>
                </div>
            </div>

            <!-- 標籤管理區塊 -->
            <div class="bg-white rounded-xl shadow-lg p-4 mb-6">
                <h3 class="font-bold text-gray-800 mb-3 flex items-center gap-2">
                    <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"/>
                    </svg>
                    補印標籤
                </h3>
                <p class="text-sm text-gray-500 mb-4">選擇血袋補印標籤</p>

                <!-- 血袋清單 (可選擇補印) -->
                <div class="space-y-2 max-h-64 overflow-y-auto">
                    <template x-for="unit in units.slice(0, 10)" :key="unit.id">
                        <div class="flex items-center justify-between p-2 bg-gray-50 rounded-lg border-l-4"
                             :class="getUnitTypeBorderColorClass(unit.unit_type)">
                            <div class="flex items-center gap-2">
                                <span class="font-bold text-gray-800" x-text="unit.blood_type"></span>
                                <span class="text-xs px-1.5 py-0.5 rounded"
                                      :class="getUnitTypeClass(unit.unit_type)"
                                      x-text="getUnitTypeLabel(unit.unit_type)"></span>
                                <span class="font-mono text-xs text-gray-500" x-text="unit.id"></span>
                            </div>
                            <button @click="printUnitLabel(unit.id)"
                                    class="text-blood-600 text-sm font-medium hover:text-blood-800 flex items-center gap-1">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"/>
                                </svg>
                                列印
                            </button>
                        </div>
                    </template>
                </div>

                <div x-show="units.length === 0" class="text-center py-4 text-gray-400">
                    目前沒有血袋可補印標籤
                </div>
            </div>

            <!-- 最近入庫記錄 -->
            <div class="bg-white rounded-xl shadow-lg p-4">
                <h3 class="font-bold text-gray-800 mb-3 flex items-center gap-2">
                    <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    最近入庫
                </h3>
                <div class="space-y-2">
                    <template x-for="unit in units.filter(u => u.status === 'AVAILABLE').slice(0, 5)" :key="'recent-' + unit.id">
                        <div class="flex items-center justify-between text-sm py-1 border-b border-gray-100">
                            <div class="flex items-center gap-2">
                                <span class="font-bold" x-text="unit.blood_type"></span>
                                <span class="text-xs px-1 rounded bg-gray-100" x-text="unit.unit_type"></span>
                            </div>
                            <span class="text-gray-500 font-mono text-xs" x-text="unit.id.slice(-8)"></span>
                        </div>
                    </template>
                </div>
            </div>
        </div>

        <!-- Issue Tab (v2.8.1 簡化 UI - 移除多餘顏色，加入 icon) -->
        <div x-show="activeTab === 'issue'" x-cloak class="max-w-3xl mx-auto">
            <h2 class="text-lg font-bold mb-4 flex items-center gap-2">
                <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
                </svg>
                發血作業
            </h2>

            <!-- Three-Tier Flow Selector - 簡化配色 -->
            <div class="bg-white rounded-lg shadow p-4 mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2 flex items-center gap-2">
                    <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                    </svg>
                    發血流程
                </label>
                <div class="grid grid-cols-3 gap-2">
                    <button @click="issueFlow.tier = 1"
                            :class="issueFlow.tier === 1 ? 'bg-red-700 text-white' : 'bg-gray-100 text-gray-700'"
                            class="py-2 rounded text-sm font-medium transition">
                        標準
                    </button>
                    <button @click="issueFlow.tier = 2"
                            :class="issueFlow.tier === 2 ? 'bg-red-700 text-white' : 'bg-gray-100 text-gray-700'"
                            class="py-2 rounded text-sm font-medium transition">
                        快速
                    </button>
                    <button @click="issueFlow.tier = 3"
                            :class="issueFlow.tier === 3 ? 'bg-red-600 text-white' : 'bg-gray-100 text-gray-700'"
                            class="py-2 rounded text-sm font-medium transition">
                        緊急
                    </button>
                </div>
                <p class="text-xs text-gray-500 mt-2" x-show="issueFlow.tier === 1">
                    標準流程：有位置 + 有醫囑 + 已配血
                </p>
                <p class="text-xs text-gray-500 mt-2" x-show="issueFlow.tier === 2">
                    快速流程：有位置 + 口頭醫囑 (事後補單)
                </p>
                <p class="text-xs text-red-600 mt-2" x-show="issueFlow.tier === 3">
                    緊急流程：無位置/極端混亂，僅限 O 型血
                </p>
            </div>

            <!-- Patient ID Input -->
            <div class="bg-white rounded-lg shadow p-4 mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2 flex items-center gap-2">
                    <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                    </svg>
                    病患 ID
                </label>
                <div class="flex gap-2">
                    <input type="text" x-model="issueFlow.patientId"
                           placeholder="輸入或掃描 P-XXXX"
                           class="flex-1 border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-red-500 focus:border-red-500">
                    <button @click="scanPatientQR()"
                            class="bg-gray-100 hover:bg-gray-200 px-4 py-2 rounded-lg transition">
                        <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                  d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h2M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z"/>
                        </svg>
                    </button>
                </div>
                <button @click="lookupPatientLocation()"
                        :disabled="!issueFlow.patientId"
                        class="w-full mt-2 bg-red-700 hover:bg-red-800 text-white py-2 rounded-lg disabled:bg-gray-300 transition flex items-center justify-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                    </svg>
                    查詢病患位置
                </button>

                <!-- Patient Location Display -->
                <div x-show="issueFlow.patientLocation" class="mt-3 p-3 bg-red-50 border-2 border-red-600 rounded-lg">
                    <div class="text-center">
                        <span class="text-xs text-red-600 font-medium">送血目的地</span>
                        <div class="text-2xl font-bold text-red-900" x-text="issueFlow.patientLocation"></div>
                        <div class="text-sm text-red-600" x-text="issueFlow.patientLocationName"></div>
                    </div>
                </div>
                <div x-show="issueFlow.patientWarning" class="mt-3 p-3 bg-red-50 border border-red-200 rounded-lg">
                    <div class="text-center">
                        <span class="text-red-700 font-medium" x-text="issueFlow.patientWarning"></span>
                    </div>
                </div>
            </div>

            <!-- 位置欄位 (直接輸入) -->
            <div class="bg-white rounded-lg shadow p-4 mb-4" x-show="issueFlow.tier !== 3 && !issueFlow.patientLocation">
                <label class="block text-sm font-medium text-gray-700 mb-2 flex items-center gap-2">
                    <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                    </svg>
                    送血位置 (手動輸入)
                </label>
                <input type="text" x-model="issueFlow.manualLocation"
                       placeholder="例: ER-05, ICU-01, OR-2, WARD-305"
                       class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-red-500 focus:border-red-500">
                <p class="text-xs text-gray-500 mt-1">若無法查詢病患位置，可直接輸入送血目的地</p>
            </div>

            <!-- Blood Unit Selection -->
            <div class="bg-white rounded-lg shadow p-4 mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2 flex items-center gap-2">
                    <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"/>
                    </svg>
                    血袋選擇
                </label>
                <div class="grid grid-cols-3 gap-2 mb-3">
                    <select x-model="issueFlow.bloodType" class="border border-gray-300 rounded-lg px-3 py-2">
                        <option value="">血型</option>
                        <template x-for="type in ['O+', 'O-', 'A+', 'A-', 'B+', 'B-', 'AB+', 'AB-']">
                            <option :value="type" x-text="type"></option>
                        </template>
                    </select>
                    <select x-model="issueFlow.unitType" class="border border-gray-300 rounded-lg px-3 py-2">
                        <option value="">血品類型</option>
                        <option value="WB">全血 WB</option>
                        <option value="PRBC">紅血球 PRBC</option>
                        <option value="FFP">血漿 FFP</option>
                        <option value="PLT">血小板 PLT</option>
                        <option value="CRYO">冷沉澱 CRYO</option>
                    </select>
                    <input type="number" x-model="issueFlow.quantity" min="1" max="10"
                           placeholder="數量" class="border border-gray-300 rounded-lg px-3 py-2">
                </div>

                <!-- Scan Blood Unit Barcode -->
                <button @click="scanBloodUnit()"
                        class="w-full bg-red-700 hover:bg-red-800 text-white py-3 rounded-lg font-medium flex items-center justify-center gap-2 transition">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h2M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z"/>
                    </svg>
                    掃描血袋條碼
                </button>

                <!-- Selected Units -->
                <div x-show="issueFlow.selectedUnits.length > 0" class="mt-3 space-y-2">
                    <template x-for="(unit, idx) in issueFlow.selectedUnits" :key="unit.id">
                        <div class="flex items-center justify-between p-2 bg-gray-50 rounded-lg border border-gray-200">
                            <div>
                                <span class="font-medium" x-text="unit.blood_type"></span>
                                <span class="text-xs text-gray-500 ml-2" x-text="unit.id"></span>
                            </div>
                            <button @click="issueFlow.selectedUnits.splice(idx, 1)"
                                    class="text-gray-500 hover:text-red-600 text-sm transition">移除</button>
                        </div>
                    </template>
                </div>
            </div>

            <!-- Order ID (Tier 1 only) -->
            <div x-show="issueFlow.tier === 1" class="bg-white rounded-lg shadow p-4 mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2 flex items-center gap-2">
                    <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                    醫囑單號
                </label>
                <input type="text" x-model="issueFlow.orderId"
                       placeholder="ORD-XXXX"
                       class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-red-500 focus:border-red-500">
            </div>

            <!-- Verbal Order Reason (Tier 2 only) -->
            <div x-show="issueFlow.tier === 2" class="bg-white rounded-lg shadow p-4 mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2 flex items-center gap-2">
                    <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                    </svg>
                    口頭醫囑備註
                </label>
                <textarea x-model="issueFlow.verbalOrderNote"
                          placeholder="醫師姓名、時間、指示內容..."
                          rows="2"
                          class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-red-500 focus:border-red-500"></textarea>
                <p class="text-xs text-gray-500 mt-1">
                    請於 24h 內補開正式醫囑
                </p>
            </div>

            <!-- Issue Button - 簡化配色 -->
            <button @click="processIssue()"
                    :disabled="!canProcessIssue"
                    class="w-full py-4 rounded-lg font-bold text-lg disabled:bg-gray-300 transition"
                    :class="issueFlow.tier === 3 ? 'bg-red-600 hover:bg-red-700 text-white' : 'bg-red-700 hover:bg-red-800 text-white'">
                <span class="flex items-center justify-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                    </svg>
                    <span x-show="issueFlow.tier === 1">確認發血 (標準)</span>
                    <span x-show="issueFlow.tier === 2">確認發血 (快速)</span>
                    <span x-show="issueFlow.tier === 3">確認緊急發血</span>
                </span>
            </button>
        </div>

        <!-- Pending Orders Tab (v2.5 P4) -->
        <div x-show="activeTab === 'pending'" x-cloak class="max-w-3xl mx-auto">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-lg font-bold">待補單追蹤</h2>
                <button @click="loadPendingOrders()"
                        class="text-blood-600 text-sm flex items-center gap-1">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                    </svg>
                    重新整理
                </button>
            </div>

            <!-- Summary Banner -->
            <div x-show="pendingOrdersSummary.pending_count > 0"
                 class="mb-4 p-4 rounded-lg"
                 :class="pendingOrdersSummary.overdue_count > 0 ? 'bg-red-50 border-l-4 border-red-500' : 'bg-amber-50 border-l-4 border-amber-500'">
                <div class="flex items-center gap-2 mb-2">
                    <svg class="w-5 h-5" :class="pendingOrdersSummary.overdue_count > 0 ? 'text-red-600' : 'text-amber-600'" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    <span class="font-bold" :class="pendingOrdersSummary.overdue_count > 0 ? 'text-red-700' : 'text-amber-700'">
                        <span x-text="pendingOrdersSummary.pending_count"></span> 筆待補單
                    </span>
                </div>
                <p class="text-sm" :class="pendingOrdersSummary.overdue_count > 0 ? 'text-red-600' : 'text-amber-600'">
                    <span x-show="pendingOrdersSummary.overdue_count > 0">
                        <span class="font-bold" x-text="pendingOrdersSummary.overdue_count"></span> 筆已超過 24 小時期限
                        <span x-show="pendingOrdersSummary.oldest_overdue_hours > 0">
                            (最久 <span x-text="pendingOrdersSummary.oldest_overdue_hours"></span> 小時)
                        </span>
                    </span>
                    <span x-show="pendingOrdersSummary.overdue_count === 0">
                        請在 24 小時內補開正式醫囑
                    </span>
                </p>
            </div>

            <!-- Empty State -->
            <div x-show="!pendingOrdersLoading && pendingOrders.length === 0" class="text-center py-12 text-gray-500">
                <svg class="w-16 h-16 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                <p class="font-medium">沒有待補單</p>
                <p class="text-sm mt-1">所有緊急發血都已補開醫囑</p>
            </div>

            <!-- Loading -->
            <div x-show="pendingOrdersLoading" class="text-center py-8 text-gray-500">
                載入中...
            </div>

            <!-- Pending Orders List -->
            <div x-show="!pendingOrdersLoading" class="space-y-3">
                <template x-for="order in pendingOrders" :key="order.id">
                    <div class="bg-white rounded-lg shadow p-4"
                         :class="order.is_overdue ? 'border-l-4 border-red-500' : ''">
                        <!-- Header -->
                        <div class="flex items-start justify-between mb-3">
                            <div>
                                <div class="flex items-center gap-2">
                                    <span class="font-mono text-sm font-medium" x-text="order.id"></span>
                                    <span x-show="order.is_overdue"
                                          class="text-xs bg-red-100 text-red-700 px-2 py-0.5 rounded">
                                        已逾期
                                    </span>
                                </div>
                                <div class="text-xs text-gray-500 mt-1">
                                    建立時間: <span x-text="formatDateTime(order.created_at)"></span>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-sm font-medium"
                                     :class="order.hours_remaining > 0 ? 'text-amber-600' : 'text-red-600'">
                                    <span x-show="order.hours_remaining > 0">
                                        剩餘 <span x-text="order.hours_remaining"></span> 小時
                                    </span>
                                    <span x-show="order.hours_remaining <= 0">
                                        逾期 <span x-text="Math.abs(order.hours_remaining)"></span> 小時
                                    </span>
                                </div>
                            </div>
                        </div>

                        <!-- Details -->
                        <div class="bg-gray-50 rounded p-3 mb-3 space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-gray-600">類型</span>
                                <span class="font-medium" x-text="orderTypeLabel(order.type)"></span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">發血袋數</span>
                                <span class="font-medium" x-text="order.unit_ids ? order.unit_ids.length : 0"></span>
                            </div>
                            <div x-show="order.reason">
                                <span class="text-gray-600">原因:</span>
                                <span class="text-gray-800 ml-1" x-text="order.reason"></span>
                            </div>
                            <div x-show="order.unit_ids && order.unit_ids.length > 0">
                                <span class="text-gray-600">血袋 ID:</span>
                                <div class="text-xs font-mono text-gray-700 mt-1" x-text="order.unit_ids.join(', ')"></div>
                            </div>
                        </div>

                        <!-- Action Button -->
                        <button @click="openResolveModal(order)"
                                class="w-full bg-red-700 hover:bg-red-800 text-white py-2 rounded font-medium flex items-center justify-center gap-2 transition">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            補開醫囑完成
                        </button>
                    </div>
                </template>
            </div>
        </div>

        <!-- Emergency Tab -->
        <div x-show="activeTab === 'emergency'" x-cloak>
            <div class="bg-red-50 border-l-4 border-red-500 p-4 mb-4">
                <h3 class="font-bold text-red-700">緊急發血 (Break-Glass)</h3>
                <p class="text-sm text-red-600 mt-1">
                    僅限緊急情況使用。將跳過配血流程，直接發放 O 型血。
                    此操作將被最高級別稽核。
                </p>
            </div>

            <div class="bg-white rounded-lg shadow p-4">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">血型</label>
                        <select x-model="emergencyForm.blood_type"
                                class="w-full border rounded px-3 py-2">
                            <option value="O+">O+ (通用陽性)</option>
                            <option value="O-">O- (通用陰性)</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">數量</label>
                        <input type="number" x-model="emergencyForm.quantity"
                               min="1" max="10"
                               class="w-full border rounded px-3 py-2">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">緊急原因 (必填)</label>
                        <textarea x-model="emergencyForm.reason"
                                  rows="3"
                                  placeholder="請說明緊急發血原因..."
                                  class="w-full border rounded px-3 py-2"></textarea>
                    </div>
                    <button @click="emergencyRelease()"
                            :disabled="!emergencyForm.reason"
                            class="w-full bg-red-600 text-white py-3 rounded font-bold disabled:bg-gray-400">
                        確認緊急發血
                    </button>
                </div>
            </div>
        </div>
    </main>

    <!-- Receive Modal -->
    <!-- v2.8: 一般入庫 Modal (捐血中心) -->
    <div x-show="showReceiveModal" x-cloak
         class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-end">
        <div class="bg-white w-full rounded-t-2xl p-4 max-h-[80vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-bold flex items-center gap-2">
                    <span class="bg-red-100 text-red-600 p-1.5 rounded">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                        </svg>
                    </span>
                    捐血中心入庫
                </h3>
                <button @click="showReceiveModal = false" class="text-gray-500">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div class="space-y-4">
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">血型 *</label>
                        <select x-model="receiveForm.blood_type" class="w-full border rounded px-3 py-2">
                            <template x-for="type in ['O+', 'O-', 'A+', 'A-', 'B+', 'B-', 'AB+', 'AB-']">
                                <option :value="type" x-text="type"></option>
                            </template>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">血品類型</label>
                        <select x-model="receiveForm.unit_type" class="w-full border rounded px-3 py-2">
                            <option value="WB">WB (全血)</option>
                            <option value="PRBC">PRBC (紅血球)</option>
                            <option value="FFP">FFP (血漿)</option>
                            <option value="PLT">PLT (血小板)</option>
                            <option value="CRYO">CRYO (冷沉澱)</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">效期 *</label>
                    <input type="date" x-model="receiveForm.expiry_date"
                           class="w-full border rounded px-3 py-2">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">捐血編號 (選填)</label>
                    <input type="text" x-model="receiveForm.donation_id"
                           placeholder="D-XXXXXXXX"
                           class="w-full border rounded px-3 py-2">
                </div>
                <div class="grid grid-cols-2 gap-2">
                    <button @click="receiveUnit()"
                            class="bg-blood-600 text-white py-3 rounded font-bold flex items-center justify-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                        </svg>
                        確認入庫
                    </button>
                    <button @click="printBloodLabel()"
                            class="bg-white text-blood-600 py-3 rounded font-bold border-2 border-blood-600 flex items-center justify-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"/>
                        </svg>
                        列印標籤
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- v2.8.1: 緊急捐血 Modal (Walking Blood Bank) - 優化 UI -->
    <div x-show="showEmergencyDonationModal" x-cloak
         class="fixed inset-0 z-50 flex items-center justify-center p-4 sm:p-6"
         @click.self="showEmergencyDonationModal = false">
        <!-- Backdrop -->
        <div class="absolute inset-0 bg-black bg-opacity-60"></div>

        <!-- Modal Content -->
        <div class="relative bg-white w-full max-w-md rounded-xl shadow-2xl max-h-[90vh] overflow-y-auto">
            <!-- Header -->
            <div class="sticky top-0 bg-orange-600 text-white p-4 rounded-t-xl flex items-center justify-between">
                <h3 class="text-lg font-bold flex items-center gap-2">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"/>
                    </svg>
                    緊急捐血
                </h3>
                <button @click="showEmergencyDonationModal = false"
                        class="p-1 hover:bg-orange-700 rounded-full transition">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>

            <div class="p-4 space-y-4">
                <!-- 警告提示 -->
                <div class="bg-orange-50 border-l-4 border-orange-500 p-3 rounded-r">
                    <p class="text-sm text-orange-800">
                        <strong>Walking Blood Bank</strong>：現場捐血者直接輸血。需記錄捐血者資訊，事後補做完整血液檢驗。
                    </p>
                </div>

                <!-- 捐血者資訊 -->
                <div class="space-y-3">
                    <h4 class="font-bold text-gray-700 flex items-center gap-2">
                        <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                        </svg>
                        捐血者資訊
                    </h4>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-600 mb-1">姓名 *</label>
                            <input type="text" x-model="receiveForm.donor_name"
                                   placeholder="捐血者姓名"
                                   class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-600 mb-1">電話</label>
                            <input type="tel" x-model="receiveForm.donor_phone"
                                   placeholder="0912-345-678"
                                   class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                        </div>
                    </div>
                </div>

                <!-- 血品資訊 -->
                <div class="space-y-3">
                    <h4 class="font-bold text-gray-700 flex items-center gap-2">
                        <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"/>
                        </svg>
                        血品資訊
                    </h4>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-600 mb-1">血型 *</label>
                            <select x-model="receiveForm.blood_type"
                                    class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                                <template x-for="type in ['O+', 'O-', 'A+', 'A-', 'B+', 'B-', 'AB+', 'AB-']">
                                    <option :value="type" x-text="type"></option>
                                </template>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-600 mb-1">血品類型</label>
                            <select x-model="receiveForm.unit_type"
                                    class="w-full border border-gray-300 rounded-lg px-3 py-2 bg-gray-100" disabled>
                                <option value="WB" selected>WB 全血</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="text-sm text-gray-500 bg-gray-50 p-3 rounded-lg flex items-center gap-2">
                    <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    效期自動設為 7 天 (新鮮全血凝血因子有效期)
                </div>

                <!-- Action Buttons -->
                <div class="flex gap-3 pt-2">
                    <button @click="showEmergencyDonationModal = false"
                            class="flex-1 py-3 rounded-lg font-medium border border-gray-300 text-gray-700 hover:bg-gray-50 transition">
                        取消
                    </button>
                    <button @click="receiveForm.source = 'walking_donor'; receiveForm.unit_type = 'WB'; receiveForm.expiry_date = new Date(Date.now() + 7*24*60*60*1000).toISOString().split('T')[0]; receiveUnit(); showEmergencyDonationModal = false;"
                            class="flex-1 bg-orange-600 text-white py-3 rounded-lg font-bold hover:bg-orange-700 transition flex items-center justify-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                        </svg>
                        確認入庫
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Issue Success Modal (v2.3 Location-First Display) -->
    <div x-show="showIssueSuccess" x-cloak
         class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-md rounded-2xl overflow-hidden shadow-2xl">
            <!-- Success Header -->
            <div class="bg-green-600 text-white p-4 text-center">
                <svg class="w-12 h-12 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <h2 class="text-xl font-bold">發血成功</h2>
            </div>

            <!-- Location-First Display (The Key UX) -->
            <div class="p-6">
                <!-- Location Box - THE MOST IMPORTANT -->
                <div x-show="issueResult.location"
                     class="bg-green-800 text-white p-6 rounded-xl text-center mb-4">
                    <span class="text-xs opacity-75">送至</span>
                    <div class="text-3xl font-bold mt-1" x-text="issueResult.location"></div>
                    <div class="text-sm opacity-90 mt-1" x-text="issueResult.locationName"></div>
                </div>

                <!-- No Location Warning -->
                <div x-show="!issueResult.location"
                     class="bg-amber-500 text-white p-6 rounded-xl text-center mb-4">
                    <svg class="w-8 h-8 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                    </svg>
                    <div class="font-bold">尚未分配位置</div>
                    <div class="text-sm mt-1">請確認病患所在地後送達</div>
                </div>

                <!-- Blood Info (Secondary) -->
                <div class="space-y-2 text-center">
                    <div class="text-xl font-bold text-blood-600" x-text="issueResult.bloodInfo"></div>
                    <div class="text-sm text-gray-600">
                        病患：<span x-text="issueResult.patientId || '未指定'"></span>
                    </div>
                    <div x-show="issueResult.triageLevel" class="text-sm">
                        <span class="px-2 py-1 rounded text-white"
                              :class="{
                                  'bg-red-600': issueResult.triageLevel === 1,
                                  'bg-amber-500': issueResult.triageLevel === 2,
                                  'bg-green-500': issueResult.triageLevel >= 3
                              }">
                            檢傷 <span x-text="issueResult.triageLevel"></span> 級
                        </span>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="mt-6 space-y-2">
                    <button @click="printDeliverySlip()"
                            class="w-full bg-gray-200 text-gray-700 py-3 rounded-lg font-medium">
                        列印派送單
                    </button>
                    <button @click="closeIssueSuccess()"
                            class="w-full bg-green-600 text-white py-3 rounded-lg font-bold">
                        完成
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Barcode Scanner Modal -->
    <div x-show="showScanner" x-cloak
         class="fixed inset-0 bg-black z-50 flex flex-col">
        <div class="bg-blood-700 text-white px-4 py-3 flex items-center justify-between">
            <span class="font-medium" x-text="scannerMode === 'patient' ? '掃描病患 QR Code' : '掃描血袋條碼'"></span>
            <button @click="closeScanner()" class="p-2">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>
        <div class="flex-1 relative">
            <video id="scanner-video" class="w-full h-full object-cover"></video>
            <div class="absolute inset-0 flex items-center justify-center">
                <div class="w-64 h-64 border-4 border-white rounded-lg opacity-50"></div>
            </div>
        </div>
        <div class="bg-black text-white text-center py-4">
            <p class="text-sm">將條碼對準框內</p>
            <!-- Manual input fallback -->
            <button @click="manualInput()"
                    class="mt-2 text-xs underline opacity-75">
                改用手動輸入
            </button>
        </div>
    </div>

    <!-- Resolve Pending Order Modal (v2.5 P4) -->
    <div x-show="showResolveModal" x-cloak
         class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-end">
        <div class="bg-white w-full rounded-t-2xl p-4 max-h-[80vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-bold">補開醫囑</h3>
                <button @click="showResolveModal = false" class="text-gray-500">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>

            <!-- Order Info -->
            <div x-show="resolvingOrder" class="bg-gray-50 rounded-lg p-4 mb-4">
                <div class="flex justify-between text-sm mb-2">
                    <span class="text-gray-600">待補單 ID</span>
                    <span class="font-mono font-medium" x-text="resolvingOrder?.id"></span>
                </div>
                <div class="flex justify-between text-sm mb-2">
                    <span class="text-gray-600">緊急原因</span>
                    <span x-text="resolvingOrder?.reason || '-'"></span>
                </div>
                <div class="flex justify-between text-sm">
                    <span class="text-gray-600">血袋數</span>
                    <span x-text="resolvingOrder?.unit_ids?.length || 0"></span>
                </div>
            </div>

            <!-- Form -->
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">正式醫囑單號 *</label>
                    <input type="text" x-model="resolveForm.order_id"
                           placeholder="ORD-XXXXXX"
                           class="w-full border rounded px-3 py-2">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">填寫人員</label>
                    <input type="text" x-model="resolveForm.resolver_id"
                           placeholder="醫師/護理師 ID"
                           class="w-full border rounded px-3 py-2">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">備註</label>
                    <textarea x-model="resolveForm.notes"
                              rows="2"
                              placeholder="選填..."
                              class="w-full border rounded px-3 py-2"></textarea>
                </div>
                <button @click="resolvePendingOrder()"
                        :disabled="!resolveForm.order_id"
                        class="w-full bg-green-600 text-white py-3 rounded font-bold disabled:bg-gray-400">
                    確認補單完成
                </button>
            </div>
        </div>
    </div>

    <!-- Expiry Blocker Modal -->
    <div x-show="showExpiryBlocker" class="blocker-modal">
        <svg class="w-24 h-24 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
        </svg>
        <h2 class="text-3xl font-bold mb-2">血品已過期</h2>
        <p class="text-xl mb-4" x-text="blockerMessage"></p>
        <p class="text-lg opacity-75">禁止發放</p>
        <button @click="showExpiryBlocker = false"
                class="mt-8 bg-white text-red-700 px-8 py-3 rounded-lg font-bold text-lg">
            我了解了
        </button>
    </div>

    <!-- Toast -->
    <div x-show="toast.show" x-transition
         :class="toast.type === 'success' ? 'bg-green-600' : toast.type === 'error' ? 'bg-red-600' : 'bg-blue-600'"
         class="fixed bottom-20 left-4 right-4 text-white px-4 py-3 rounded-lg shadow-lg z-40">
        <span x-text="toast.message"></span>
    </div>

    <!-- Alpine.js -->
    <script src="/static/js/alpine.min.js" defer></script>

    <script>
        function bloodApp() {
            return {
                activeTab: 'overview',
                loading: false,
                isOffline: !navigator.onLine,

                availability: [],
                units: [],
                bloodTypeFilter: '',  // v2.9: 統一血型篩選 (原 unitFilter + dashboardFilter)

                showReceiveModal: false,
                showEmergencyDonationModal: false,  // v2.8: 緊急捐血 Modal
                showExpiryBlocker: false,
                blockerMessage: '',

                // v2.3: Issue Flow State
                showIssueSuccess: false,
                showScanner: false,
                scannerMode: 'blood', // 'patient' | 'blood'
                scannerStream: null,

                issueFlow: {
                    tier: 1,  // 1=Standard, 2=Rapid, 3=Emergency
                    patientId: '',
                    patientLocation: '',
                    patientLocationName: '',
                    patientLocationType: '',
                    patientWarning: '',
                    patientTriageLevel: null,
                    manualLocation: '',  // v2.6: 手動輸入位置
                    bloodType: '',
                    unitType: '',  // v2.6: 血品類型
                    quantity: 1,
                    selectedUnits: [],
                    orderId: '',
                    verbalOrderNote: ''
                },

                issueResult: {
                    location: '',
                    locationName: '',
                    bloodInfo: '',
                    patientId: '',
                    triageLevel: null,
                    unitIds: []
                },

                // CIRS Hub URL (for patient location lookup)
                cirsHubUrl: localStorage.getItem('cirs_hub_url') || 'http://localhost:8090',

                receiveForm: {
                    blood_type: 'O+',
                    unit_type: 'WB',
                    expiry_date: '',
                    donation_id: '',
                    source: 'blood_center',  // v2.8: blood_center | walking_donor
                    donor_name: '',          // v2.8: 緊急捐血者姓名
                    donor_phone: ''          // v2.8: 緊急捐血者電話
                },

                emergencyForm: {
                    blood_type: 'O+',
                    quantity: 1,
                    reason: ''
                },

                toast: {
                    show: false,
                    message: '',
                    type: 'info'
                },

                // v2.5 P4: Pending Orders State
                pendingOrders: [],
                pendingOrdersLoading: false,
                pendingOrdersSummary: {
                    pending_count: 0,
                    overdue_count: 0,
                    oldest_overdue_hours: 0
                },
                showResolveModal: false,
                resolvingOrder: null,
                resolveForm: {
                    order_id: '',
                    resolver_id: '',
                    notes: ''
                },

                async init() {
                    // 監聽網路狀態
                    window.addEventListener('online', () => this.isOffline = false);
                    window.addEventListener('offline', () => this.isOffline = true);

                    // 註冊 Service Worker
                    if ('serviceWorker' in navigator) {
                        navigator.serviceWorker.register('/blood/service-worker.js')
                            .then(reg => console.log('[Blood] SW registered'))
                            .catch(err => console.error('[Blood] SW registration failed:', err));
                    }

                    // 載入資料
                    await this.refresh();

                    // v2.5 P4: 載入待補單摘要
                    await this.loadPendingOrdersSummary();
                },

                async refresh() {
                    this.loading = true;
                    try {
                        await Promise.all([
                            this.loadAvailability(),
                            this.loadUnits()
                        ]);
                    } catch (e) {
                        console.error('Failed to load data:', e);
                    }
                    this.loading = false;
                },

                async loadAvailability() {
                    const res = await fetch('/api/blood/availability');
                    const data = await res.json();
                    if (data.success) {
                        this.availability = data.data;
                    }
                },

                async loadUnits() {
                    const res = await fetch('/api/blood/units');
                    const data = await res.json();
                    if (data.success) {
                        this.units = data.data;
                    }
                },

                // v2.9: 使用統一的 bloodTypeFilter
                get filteredUnits() {
                    if (!this.bloodTypeFilter) return this.units;
                    return this.units.filter(u => u.blood_type === this.bloodTypeFilter);
                },

                get expiringSoonCount() {
                    return this.availability.reduce((sum, item) => sum + (item.expiring_soon_count || 0), 0);
                },

                get expiredCount() {
                    return this.availability.reduce((sum, item) => sum + (item.expired_pending_count || 0), 0);
                },

                statusLabel(status) {
                    const labels = {
                        'AVAILABLE': '可用',
                        'RESERVED': '已預約',
                        'EXPIRING_SOON': '即將過期',
                        'EXPIRED': '已過期'
                    };
                    return labels[status] || status;
                },

                // v2.6: 血品類型輔助函數
                getUnitTypeClass(unitType) {
                    const classes = {
                        'WB': 'unit-type-wb',
                        'PRBC': 'unit-type-prbc',
                        'FFP': 'unit-type-ffp',
                        'PLT': 'unit-type-plt',
                        'CRYO': 'unit-type-cryo'
                    };
                    return classes[unitType] || 'bg-gray-500 text-white';
                },

                getUnitTypeBorderClass(unitType) {
                    const classes = {
                        'WB': 'border-red-900',
                        'PRBC': 'border-red-500',
                        'FFP': 'border-amber-500',
                        'PLT': 'border-yellow-400',
                        'CRYO': 'border-cyan-500'
                    };
                    return classes[unitType] || 'border-gray-300';
                },

                getUnitTypeLabel(unitType) {
                    const labels = {
                        'WB': '全血',
                        'PRBC': '紅血球',
                        'FFP': '血漿',
                        'PLT': '血小板',
                        'CRYO': '冷沉澱'
                    };
                    return labels[unitType] || unitType;
                },

                // v2.7: 按血型分組的庫存統計 (含即期數)
                get groupedByBloodType() {
                    const bloodTypes = ['O+', 'O-', 'A+', 'A-', 'B+', 'B-', 'AB+', 'AB-'];
                    return bloodTypes.map(bt => {
                        const items = this.availability.filter(a => a.blood_type === bt);
                        const total = items.reduce((sum, item) => sum + (item.available_count || 0), 0);
                        const expiring = items.reduce((sum, item) => sum + (item.expiring_soon_count || 0), 0);
                        return { blood_type: bt, total, expiring };
                    });
                },

                // v2.7: 總庫存
                get totalUnits() {
                    return this.groupedByBloodType.reduce((sum, b) => sum + b.total, 0);
                },

                // v2.7: 總即期
                get totalExpiring() {
                    return this.groupedByBloodType.reduce((sum, b) => sum + b.expiring, 0);
                },

                // v2.9: 統一的過濾後 availability (使用 bloodTypeFilter)
                get filteredByDashboard() {
                    if (!this.bloodTypeFilter) return this.availability;
                    return this.availability.filter(a => a.blood_type === this.bloodTypeFilter);
                },

                // v2.9: 點擊血型卡片過濾 (同時篩選 Dashboard 和血袋清單)
                filterByBloodType(bloodType) {
                    if (this.bloodTypeFilter === bloodType) {
                        this.bloodTypeFilter = '';  // 再次點擊清除過濾
                    } else {
                        this.bloodTypeFilter = bloodType;
                    }
                },

                // v2.7: 血品類型左側邊框顏色 (8px)
                getUnitTypeBorderColorClass(unitType) {
                    const classes = {
                        'WB': 'border-red-900',
                        'PRBC': 'border-red-600',
                        'FFP': 'border-yellow-400',
                        'PLT': 'border-yellow-200',
                        'CRYO': 'border-cyan-400'
                    };
                    return classes[unitType] || 'border-gray-300';
                },

                // v2.8: 補印標籤功能 (Client-side Label Generation)
                printUnitLabel(unitId) {
                    const unit = this.units.find(u => u.id === unitId);
                    if (!unit) {
                        this.showToast('找不到血袋資料', 'error');
                        return;
                    }

                    const labelHtml = `
                        <!DOCTYPE html>
                        <html>
                        <head>
                            <title>血袋標籤 - ${unit.id}</title>
                            <style>
                                @page { size: 60mm 40mm; margin: 2mm; }
                                body { font-family: Arial, sans-serif; margin: 0; padding: 4mm; }
                                .label { border: 2px solid #000; padding: 3mm; }
                                .blood-type { font-size: 24pt; font-weight: bold; text-align: center; }
                                .unit-type { font-size: 10pt; text-align: center; margin-bottom: 2mm; }
                                .unit-id { font-family: monospace; font-size: 8pt; }
                                .expiry { font-size: 10pt; font-weight: bold; margin-top: 2mm; }
                                .expiry-date { color: #c00; }
                            </style>
                        </head>
                        <body onload="window.print()">
                            <div class="label">
                                <div class="blood-type">${unit.blood_type}</div>
                                <div class="unit-type">${this.getUnitTypeLabel(unit.unit_type)}</div>
                                <div class="unit-id">${unit.id}</div>
                                <div class="expiry">效期: <span class="expiry-date">${unit.expiry_date}</span></div>
                            </div>
                        </body>
                        </html>
                    `;

                    const printWindow = window.open('', '_blank', 'width=400,height=300');
                    printWindow.document.write(labelHtml);
                    printWindow.document.close();
                    this.showToast('正在開啟標籤列印...', 'info');
                },

                async receiveUnit() {
                    if (!this.receiveForm.blood_type || !this.receiveForm.expiry_date) {
                        this.showToast('請填寫必要欄位', 'error');
                        return;
                    }

                    try {
                        const res = await fetch('/api/blood/units', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(this.receiveForm)
                        });
                        const data = await res.json();

                        if (data.success) {
                            this.showToast('入庫成功', 'success');
                            this.showReceiveModal = false;
                            this.receiveForm = { blood_type: 'O+', unit_type: 'WB', expiry_date: '', donation_id: '', source: 'blood_center', donor_name: '', donor_phone: '' };
                            await this.refresh();
                        } else {
                            this.showToast(data.detail || '入庫失敗', 'error');
                        }
                    } catch (e) {
                        this.showToast('網路錯誤', 'error');
                    }
                },

                async issueUnit(unit) {
                    // 效期阻擋 (Layer 2: UI)
                    if (unit.display_status === 'EXPIRED') {
                        this.blockerMessage = `血袋 ${unit.id} 已過期`;
                        this.showExpiryBlocker = true;
                        return;
                    }

                    if (!confirm(`確定發放血袋 ${unit.id}？`)) return;

                    try {
                        const res = await fetch(`/api/blood/units/${unit.id}/issue`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                order_id: 'MANUAL-' + Date.now(),
                                issuer_id: 'blood-pwa'
                            })
                        });

                        if (res.status === 403) {
                            const data = await res.json();
                            this.blockerMessage = data.detail;
                            this.showExpiryBlocker = true;
                            return;
                        }

                        const data = await res.json();
                        if (data.success) {
                            this.showToast('發血成功', 'success');
                            await this.refresh();
                        } else {
                            this.showToast(data.detail || '發血失敗', 'error');
                        }
                    } catch (e) {
                        this.showToast('網路錯誤', 'error');
                    }
                },

                async reserveUnit(unit) {
                    const orderId = prompt('請輸入訂單編號 (Order ID):');
                    if (!orderId) return;

                    try {
                        const res = await fetch(`/api/blood/units/${unit.id}/reserve`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                order_id: orderId,
                                reserver_id: 'blood-pwa'
                            })
                        });
                        const data = await res.json();

                        if (res.status === 409) {
                            this.showToast('血袋已被預約', 'error');
                            return;
                        }

                        if (data.success) {
                            this.showToast('預約成功', 'success');
                            await this.refresh();
                        } else {
                            this.showToast(data.detail || '預約失敗', 'error');
                        }
                    } catch (e) {
                        this.showToast('網路錯誤', 'error');
                    }
                },

                async unreserveUnit(unit) {
                    if (!confirm(`確定取消血袋 ${unit.id} 的預約？`)) return;

                    try {
                        const res = await fetch(`/api/blood/units/${unit.id}/unreserve?actor=blood-pwa`, {
                            method: 'POST'
                        });
                        const data = await res.json();

                        if (data.success) {
                            this.showToast('已取消預約', 'success');
                            await this.refresh();
                        } else {
                            this.showToast(data.detail || '取消失敗', 'error');
                        }
                    } catch (e) {
                        this.showToast('網路錯誤', 'error');
                    }
                },

                async emergencyRelease() {
                    if (!this.emergencyForm.reason) {
                        this.showToast('請填寫緊急原因', 'error');
                        return;
                    }

                    if (!confirm('確定執行緊急發血？此操作將被最高級別稽核。')) return;

                    try {
                        const res = await fetch('/api/blood/emergency-release', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                ...this.emergencyForm,
                                requester_id: 'blood-pwa',
                                patient_id: this.issueFlow.patientId || null,
                                patient_location: this.issueFlow.patientLocation || null
                            })
                        });
                        const data = await res.json();

                        if (data.success) {
                            // v2.3: Show Location-First Success Modal
                            this.issueResult = {
                                location: this.issueFlow.patientLocation || null,
                                locationName: this.issueFlow.patientLocationName || '',
                                bloodInfo: `${this.emergencyForm.blood_type} x ${this.emergencyForm.quantity} 單位 (緊急發血)`,
                                patientId: this.issueFlow.patientId || null,
                                triageLevel: this.issueFlow.patientTriageLevel,
                                unitIds: data.unit_ids || []
                            };
                            this.showIssueSuccess = true;

                            this.emergencyForm = { blood_type: 'O+', quantity: 1, reason: '' };
                            this.resetIssueFlow();
                            await this.refresh();
                        } else {
                            this.showToast(data.detail || '發血失敗', 'error');
                        }
                    } catch (e) {
                        this.showToast('網路錯誤', 'error');
                    }
                },

                showToast(message, type = 'info') {
                    this.toast = { show: true, message, type };
                    setTimeout(() => this.toast.show = false, 3000);
                },

                // v2.6: 列印血袋標籤
                printBloodLabel() {
                    const { blood_type, unit_type, expiry_date, donation_id } = this.receiveForm;
                    if (!blood_type) {
                        this.showToast('請選擇血型', 'error');
                        return;
                    }

                    const unitTypeLabels = {
                        'WB': '全血 Whole Blood',
                        'PRBC': '濃縮紅血球 PRBC',
                        'FFP': '新鮮冷凍血漿 FFP',
                        'PLT': '血小板 PLT',
                        'CRYO': '冷凍沉澱品 CRYO'
                    };

                    const unitTypeColors = {
                        'WB': '#7f1d1d',
                        'PRBC': '#dc2626',
                        'FFP': '#d97706',
                        'PLT': '#eab308',
                        'CRYO': '#0891b2'
                    };

                    const printContent = `
                        <html>
                        <head>
                            <title>血袋標籤</title>
                            <style>
                                @page { size: 60mm 40mm; margin: 2mm; }
                                body { font-family: sans-serif; margin: 0; padding: 5mm; }
                                .label { border: 2px solid ${unitTypeColors[unit_type] || '#333'}; padding: 3mm; }
                                .header { background: ${unitTypeColors[unit_type] || '#333'}; color: white; padding: 2mm; text-align: center; font-weight: bold; margin: -3mm -3mm 3mm -3mm; }
                                .blood-type { font-size: 24pt; font-weight: bold; text-align: center; margin: 2mm 0; }
                                .info { font-size: 10pt; margin: 1mm 0; }
                                .barcode { text-align: center; font-family: monospace; font-size: 12pt; margin-top: 2mm; }
                            </style>
                        </head>
                        <body>
                            <div class="label">
                                <div class="header">${unitTypeLabels[unit_type] || unit_type}</div>
                                <div class="blood-type">${blood_type}</div>
                                <div class="info"><b>效期:</b> ${expiry_date || '未設定'}</div>
                                <div class="info"><b>捐血編號:</b> ${donation_id || '-'}</div>
                                <div class="info"><b>列印時間:</b> ${new Date().toLocaleString('zh-TW')}</div>
                                <div class="barcode">${donation_id || 'BU-' + Date.now()}</div>
                            </div>
                        </body>
                        </html>
                    `;
                    const printWindow = window.open('', '_blank', 'width=400,height=300');
                    printWindow.document.write(printContent);
                    printWindow.document.close();
                    printWindow.print();
                },

                // ======================================================
                // v2.5 P4: Pending Orders Methods
                // ======================================================

                async loadPendingOrdersSummary() {
                    try {
                        const res = await fetch('/api/blood/pending-orders/summary');
                        const data = await res.json();
                        if (data.success) {
                            this.pendingOrdersSummary = {
                                pending_count: data.pending_count || 0,
                                overdue_count: data.overdue_count || 0,
                                oldest_overdue_hours: data.oldest_overdue_hours || 0
                            };
                        }
                    } catch (e) {
                        console.error('Failed to load pending orders summary:', e);
                    }
                },

                async loadPendingOrders() {
                    this.pendingOrdersLoading = true;
                    try {
                        const res = await fetch('/api/blood/pending-orders');
                        const data = await res.json();
                        if (data.success) {
                            this.pendingOrders = data.data || [];
                            // 同時更新摘要
                            this.pendingOrdersSummary = {
                                pending_count: this.pendingOrders.length,
                                overdue_count: data.overdue_count || 0,
                                oldest_overdue_hours: 0
                            };
                        }
                    } catch (e) {
                        console.error('Failed to load pending orders:', e);
                        this.showToast('載入待補單失敗', 'error');
                    }
                    this.pendingOrdersLoading = false;
                },

                openResolveModal(order) {
                    this.resolvingOrder = order;
                    this.resolveForm = {
                        order_id: '',
                        resolver_id: '',
                        notes: ''
                    };
                    this.showResolveModal = true;
                },

                async resolvePendingOrder() {
                    if (!this.resolveForm.order_id || !this.resolvingOrder) return;

                    try {
                        const res = await fetch(`/api/blood/pending-orders/${this.resolvingOrder.id}/resolve`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(this.resolveForm)
                        });
                        const data = await res.json();

                        if (data.success) {
                            this.showToast('補單完成', 'success');
                            this.showResolveModal = false;
                            this.resolvingOrder = null;
                            await this.loadPendingOrders();
                        } else {
                            this.showToast(data.detail || '操作失敗', 'error');
                        }
                    } catch (e) {
                        this.showToast('網路錯誤', 'error');
                    }
                },

                formatDateTime(isoString) {
                    if (!isoString) return '-';
                    const d = new Date(isoString);
                    return d.toLocaleString('zh-TW', {
                        month: 'numeric',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                },

                orderTypeLabel(type) {
                    const labels = {
                        'EMERGENCY_RELEASE': '緊急發血',
                        'VERBAL_ORDER': '口頭醫囑',
                        'RAPID_ISSUE': '快速發血'
                    };
                    return labels[type] || type;
                },

                // ======================================================
                // v2.3: Issue Flow Methods
                // ======================================================

                get canProcessIssue() {
                    const { tier, patientId, patientLocation, manualLocation, selectedUnits, bloodType, quantity, orderId, verbalOrderNote } = this.issueFlow;

                    // v2.6: 合併位置來源
                    const hasLocation = patientLocation || manualLocation;

                    // Tier 3: Only needs blood type (O+/O-) and reason
                    if (tier === 3) {
                        return bloodType && ['O+', 'O-'].includes(bloodType);
                    }

                    // Tier 1 & 2: Need either selected units or blood type + quantity
                    const hasBlood = selectedUnits.length > 0 || (bloodType && quantity > 0);
                    if (!hasBlood) return false;

                    // Tier 1: Need order ID and patient ID
                    if (tier === 1) {
                        return orderId && patientId;
                    }

                    // Tier 2: Need verbal order note and location (either from patient or manual)
                    if (tier === 2) {
                        return verbalOrderNote && (patientId || hasLocation);
                    }

                    return false;
                },

                // Query CIRS for patient location (v2.3 core feature)
                async lookupPatientLocation() {
                    if (!this.issueFlow.patientId) return;

                    this.issueFlow.patientWarning = '';
                    this.issueFlow.patientLocation = '';
                    this.issueFlow.patientLocationName = '';

                    try {
                        const res = await fetch(`${this.cirsHubUrl}/api/patients/${this.issueFlow.patientId}`);

                        if (!res.ok) {
                            // Demo fallback - simulate patient location
                            this.simulatePatientLocation();
                            return;
                        }

                        const patient = await res.json();

                        if (patient.current_bed) {
                            this.issueFlow.patientLocation = patient.current_bed.id;
                            this.issueFlow.patientLocationName = patient.current_bed.name || '';
                            this.issueFlow.patientLocationType = patient.current_bed.type || 'UNKNOWN';
                            this.issueFlow.patientTriageLevel = patient.triage_level;
                            this.showToast(`病患位置: ${patient.current_bed.id}`, 'success');
                        } else {
                            this.issueFlow.patientWarning = '病患尚未分配位置';
                            // Suggest switching to Tier 3 if no location
                            if (this.issueFlow.tier !== 3) {
                                this.showToast('無位置資訊，建議使用緊急流程', 'info');
                            }
                        }
                    } catch (e) {
                        console.warn('[Blood] CIRS lookup failed, using simulation:', e);
                        this.simulatePatientLocation();
                    }
                },

                // Demo mode: Simulate patient location
                simulatePatientLocation() {
                    const locations = [
                        { id: 'RESUS-01', name: '急救區 1床', type: 'RESUS', triage: 1 },
                        { id: 'RESUS-02', name: '急救區 2床', type: 'RESUS', triage: 1 },
                        { id: 'ER-03', name: '急診觀察 3床', type: 'ER', triage: 2 },
                        { id: 'ER-05', name: '急診觀察 5床', type: 'ER', triage: 2 },
                        { id: 'ICU-01', name: '加護病房 1床', type: 'ICU', triage: 1 },
                        { id: 'OR-2', name: '手術室 2', type: 'OR', triage: 1 },
                        { id: 'WARD-305', name: '普通病房 305', type: 'INPATIENT', triage: 3 },
                        { id: null, name: null, type: null, triage: 2 } // No location case
                    ];

                    const loc = locations[Math.floor(Math.random() * locations.length)];

                    if (loc.id) {
                        this.issueFlow.patientLocation = loc.id;
                        this.issueFlow.patientLocationName = loc.name;
                        this.issueFlow.patientLocationType = loc.type;
                        this.issueFlow.patientTriageLevel = loc.triage;
                        this.showToast(`(Demo) 病患位置: ${loc.id}`, 'success');
                    } else {
                        this.issueFlow.patientWarning = '病患尚未分配位置';
                        this.issueFlow.patientTriageLevel = loc.triage;
                    }
                },

                // Process issue based on tier
                async processIssue() {
                    const { tier, patientId, patientLocation, patientLocationName, patientTriageLevel,
                            selectedUnits, bloodType, unitType, quantity, orderId, verbalOrderNote, manualLocation } = this.issueFlow;

                    // v2.6: 優先使用病患位置，否則使用手動輸入位置
                    const finalLocation = patientLocation || manualLocation;

                    // Tier 3 goes to Emergency Release
                    if (tier === 3) {
                        this.emergencyForm.blood_type = bloodType;
                        this.emergencyForm.quantity = quantity || 1;
                        this.emergencyForm.reason = verbalOrderNote || '緊急需求';
                        await this.emergencyRelease();
                        return;
                    }

                    // Tier 1 & 2: Issue blood with location
                    let issuedUnits = [];
                    const issueOrderId = tier === 1 ? orderId : `VERBAL-${Date.now()}`;

                    try {
                        if (selectedUnits.length > 0) {
                            // Issue selected units
                            for (const unit of selectedUnits) {
                                const res = await fetch(`/api/blood/units/${unit.id}/issue`, {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({
                                        order_id: issueOrderId,
                                        issuer_id: 'blood-pwa',
                                        patient_id: patientId,
                                        patient_location: finalLocation,  // v2.6: 使用合併的位置
                                        is_verbal_order: tier === 2,
                                        verbal_order_note: tier === 2 ? verbalOrderNote : null
                                    })
                                });

                                if (res.ok) {
                                    issuedUnits.push(unit);
                                }
                            }
                        } else if (bloodType && quantity > 0) {
                            // v2.6: Auto-select units by blood type AND unit type (FIFO)
                            let apiUrl = `/api/blood/units?blood_type=${bloodType}&status=AVAILABLE`;
                            if (unitType) {
                                apiUrl += `&unit_type=${unitType}`;
                            }
                            const unitsRes = await fetch(apiUrl);
                            const unitsData = await unitsRes.json();

                            if (unitsData.success && unitsData.data) {
                                const availableUnits = unitsData.data
                                    .filter(u => u.display_status !== 'EXPIRED')
                                    .slice(0, quantity);

                                for (const unit of availableUnits) {
                                    const res = await fetch(`/api/blood/units/${unit.id}/issue`, {
                                        method: 'POST',
                                        headers: { 'Content-Type': 'application/json' },
                                        body: JSON.stringify({
                                            order_id: issueOrderId,
                                            issuer_id: 'blood-pwa',
                                            patient_id: patientId,
                                            patient_location: finalLocation,  // v2.6: 使用合併的位置
                                            is_verbal_order: tier === 2,
                                            verbal_order_note: tier === 2 ? verbalOrderNote : null
                                        })
                                    });

                                    if (res.ok) {
                                        issuedUnits.push(unit);
                                    }
                                }
                            }
                        }

                        if (issuedUnits.length > 0) {
                            // Show success modal with Location-First Display
                            const unitTypeLabel = unitType ? this.getUnitTypeLabel(unitType) : '';
                            this.issueResult = {
                                location: finalLocation,  // v2.6: 使用合併的位置
                                locationName: patientLocationName || (manualLocation ? '手動輸入' : ''),
                                bloodInfo: `${bloodType || issuedUnits[0].blood_type} ${unitTypeLabel} x ${issuedUnits.length} 單位`,
                                patientId: patientId,
                                triageLevel: patientTriageLevel,
                                unitIds: issuedUnits.map(u => u.id)
                            };
                            this.showIssueSuccess = true;
                            await this.refresh();

                            // Reset form
                            this.resetIssueFlow();
                        } else {
                            this.showToast('發血失敗，請檢查庫存', 'error');
                        }
                    } catch (e) {
                        console.error('Issue failed:', e);
                        this.showToast('發血失敗', 'error');
                    }
                },

                resetIssueFlow() {
                    this.issueFlow = {
                        tier: 1,
                        patientId: '',
                        patientLocation: '',
                        patientLocationName: '',
                        patientLocationType: '',
                        patientWarning: '',
                        patientTriageLevel: null,
                        manualLocation: '',  // v2.6
                        bloodType: '',
                        unitType: '',  // v2.6
                        quantity: 1,
                        selectedUnits: [],
                        orderId: '',
                        verbalOrderNote: ''
                    };
                },

                closeIssueSuccess() {
                    this.showIssueSuccess = false;
                    this.issueResult = {
                        location: '',
                        locationName: '',
                        bloodInfo: '',
                        patientId: '',
                        triageLevel: null,
                        unitIds: []
                    };
                },

                printDeliverySlip() {
                    const { location, locationName, bloodInfo, patientId, unitIds } = this.issueResult;
                    const printContent = `
                        <html>
                        <head>
                            <title>Blood Delivery Slip</title>
                            <style>
                                body { font-family: sans-serif; padding: 20px; }
                                .header { text-align: center; font-size: 24px; font-weight: bold; margin-bottom: 20px; }
                                .location { background: #166534; color: white; padding: 30px; text-align: center; font-size: 36px; font-weight: bold; margin: 20px 0; }
                                .info { font-size: 18px; margin: 10px 0; }
                                .units { font-size: 12px; color: #666; margin-top: 20px; }
                            </style>
                        </head>
                        <body>
                            <div class="header">MIRS Blood Bank - 派送單</div>
                            <div class="location">${location || '無位置'}<br><small>${locationName || ''}</small></div>
                            <div class="info"><b>血品:</b> ${bloodInfo}</div>
                            <div class="info"><b>病患:</b> ${patientId || '未指定'}</div>
                            <div class="info"><b>時間:</b> ${new Date().toLocaleString('zh-TW')}</div>
                            <div class="units"><b>血袋 ID:</b> ${unitIds.join(', ')}</div>
                        </body>
                        </html>
                    `;
                    const printWindow = window.open('', '_blank');
                    printWindow.document.write(printContent);
                    printWindow.document.close();
                    printWindow.print();
                },

                // ======================================================
                // Barcode Scanner Methods
                // ======================================================

                async scanPatientQR() {
                    this.scannerMode = 'patient';
                    await this.openScanner();
                },

                async scanBloodUnit() {
                    this.scannerMode = 'blood';
                    await this.openScanner();
                },

                async openScanner() {
                    this.showScanner = true;
                    try {
                        const video = document.getElementById('scanner-video');
                        this.scannerStream = await navigator.mediaDevices.getUserMedia({
                            video: { facingMode: 'environment' }
                        });
                        video.srcObject = this.scannerStream;
                        await video.play();

                        // TODO: Integrate barcode scanning library (e.g., ZXing, QuaggaJS)
                        // For now, show manual input option
                        this.showToast('掃描功能開發中，請使用手動輸入', 'info');
                    } catch (e) {
                        console.error('Camera access failed:', e);
                        this.showToast('無法存取相機', 'error');
                        this.closeScanner();
                    }
                },

                closeScanner() {
                    this.showScanner = false;
                    if (this.scannerStream) {
                        this.scannerStream.getTracks().forEach(track => track.stop());
                        this.scannerStream = null;
                    }
                },

                manualInput() {
                    this.closeScanner();
                    if (this.scannerMode === 'patient') {
                        const id = prompt('請輸入病患 ID (P-XXXX):');
                        if (id) {
                            this.issueFlow.patientId = id;
                            this.lookupPatientLocation();
                        }
                    } else {
                        const id = prompt('請輸入血袋 ID (BU-XXXX):');
                        if (id) {
                            // Find unit in loaded units
                            const unit = this.units.find(u => u.id === id);
                            if (unit) {
                                if (unit.display_status === 'EXPIRED') {
                                    this.blockerMessage = `血袋 ${id} 已過期`;
                                    this.showExpiryBlocker = true;
                                } else if (!this.issueFlow.selectedUnits.find(u => u.id === id)) {
                                    this.issueFlow.selectedUnits.push(unit);
                                    this.showToast(`已添加 ${id}`, 'success');
                                }
                            } else {
                                this.showToast('找不到此血袋', 'error');
                            }
                        }
                    }
                }
            };
        }
    </script>

    <!-- v2.8.1: Emergency Release FAB (Floating Action Button) - 移除 emoji 改用 heroicon -->
    <div x-data="{ showEmergencyConfirm: false }" class="fixed bottom-20 right-4 z-40">
        <!-- FAB Button -->
        <button @click="showEmergencyConfirm = true"
                class="bg-red-600 hover:bg-red-700 text-white rounded-full p-4 shadow-2xl
                       flex items-center gap-2 animate-pulse-slow
                       border-4 border-red-300">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
            </svg>
            <span class="font-bold text-sm hidden sm:inline">緊急領血</span>
        </button>

        <!-- Emergency Confirm Modal -->
        <div x-show="showEmergencyConfirm" x-cloak
             class="fixed inset-0 bg-black bg-opacity-75 z-50 flex items-center justify-center p-4"
             @click.self="showEmergencyConfirm = false">
            <div class="bg-white rounded-xl max-w-sm w-full overflow-hidden shadow-2xl">
                <!-- Header -->
                <div class="bg-red-600 text-white p-4 text-center">
                    <svg class="w-10 h-10 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                    </svg>
                    <h3 class="text-xl font-bold">緊急領血</h3>
                    <p class="text-sm text-red-200 mt-1">僅限 O 型血 (萬能供血)</p>
                </div>

                <!-- Quick Actions -->
                <div class="p-4 space-y-3">
                    <p class="text-gray-600 text-sm text-center mb-4">
                        緊急發血將跳過正常流程，事後需補開醫囑
                    </p>

                    <!-- O+ Button -->
                    <button @click="$dispatch('emergency-release', { bloodType: 'O+' }); showEmergencyConfirm = false"
                            class="w-full bg-red-900 hover:bg-red-800 text-white py-4 rounded-lg font-bold text-xl flex items-center justify-center gap-3">
                        <span class="text-3xl">O+</span>
                        <span>緊急發血</span>
                    </button>

                    <!-- O- Button (More Universal) -->
                    <button @click="$dispatch('emergency-release', { bloodType: 'O-' }); showEmergencyConfirm = false"
                            class="w-full bg-red-700 hover:bg-red-600 text-white py-4 rounded-lg font-bold text-xl flex items-center justify-center gap-3 border-2 border-yellow-400">
                        <span class="text-3xl">O-</span>
                        <span>萬能血型</span>
                        <span class="text-xs bg-yellow-400 text-red-900 px-2 py-0.5 rounded">推薦</span>
                    </button>

                    <!-- Cancel -->
                    <button @click="showEmergencyConfirm = false"
                            class="w-full bg-gray-200 text-gray-700 py-3 rounded-lg font-medium">
                        取消
                    </button>
                </div>
            </div>
        </div>
    </div>

    <style>
        /* v2.7: Slow pulse animation for Emergency FAB */
        @keyframes pulse-slow {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.9; transform: scale(1.05); }
        }
        .animate-pulse-slow {
            animation: pulse-slow 2s ease-in-out infinite;
        }
    </style>
</body>
</html>
