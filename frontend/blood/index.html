<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#DC2626">

    <title>MIRS Blood Bank</title>

    <link rel="manifest" href="/blood/manifest.json">
    <link rel="apple-touch-icon" href="/blood/icons/icon-192x192.png">

    <!-- æœ¬åœ° CSS (é›¢ç·šæ”¯æ´) -->
    <link rel="stylesheet" href="/static/css/tailwind.min.css">
    <link rel="stylesheet" href="/static/css/mirs-colors.css">

    <style>
        /* Blood Bank å°ˆç”¨è‰²ç³» */
        :root {
            --blood-50: #fef2f2;
            --blood-100: #fee2e2;
            --blood-200: #fecaca;
            --blood-300: #fca5a5;
            --blood-400: #f87171;
            --blood-500: #ef4444;
            --blood-600: #dc2626;
            --blood-700: #b91c1c;
            --blood-800: #991b1b;
            --blood-900: #7f1d1d;
        }

        .bg-blood-600 { background-color: var(--blood-600); }
        .bg-blood-700 { background-color: var(--blood-700); }
        .text-blood-600 { color: var(--blood-600); }
        .border-blood-600 { border-color: var(--blood-600); }

        /* è¡€å“é¡å‹é¡è‰² (v2.6) */
        .unit-type-wb { background-color: #7f1d1d; color: white; }      /* æ·±ç´… - Whole Blood */
        .unit-type-prbc { background-color: #dc2626; color: white; }    /* ç´… - PRBC */
        .unit-type-ffp { background-color: #d97706; color: white; }     /* ç¥ç€ - FFP */
        .unit-type-plt { background-color: #eab308; color: #1f2937; }   /* é»ƒ - PLT */
        .unit-type-cryo { background-color: #0891b2; color: white; }    /* é’ - CRYO */

        /* ç‹€æ…‹é¡è‰² */
        .status-available { background-color: #10b981; color: white; }
        .status-reserved { background-color: #3b82f6; color: white; }
        .status-expiring { background-color: #f59e0b; color: white; }
        .status-expired { background-color: #ef4444; color: white; }

        /* å…¨è¢å¹•é˜»æ“‹ Modal */
        .blocker-modal {
            position: fixed;
            inset: 0;
            background: #b91c1c;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
        }

        /* å®‰å…¨å€åŸŸ */
        .safe-area-top { padding-top: env(safe-area-inset-top); }
        .safe-area-bottom { padding-bottom: env(safe-area-inset-bottom); }
    </style>
</head>
<body class="bg-gray-100 min-h-screen safe-area-top safe-area-bottom" x-data="bloodApp()" x-init="init()">

    <!-- Header -->
    <header class="bg-blood-600 text-white px-4 py-3 sticky top-0 z-50 shadow-lg">
        <div class="flex items-center justify-between">
            <div class="flex items-center gap-2">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z" />
                </svg>
                <h1 class="text-lg font-bold">Blood Bank</h1>
                <span class="text-xs bg-red-800 px-2 py-0.5 rounded">v2.8</span>
            </div>
            <div class="flex items-center gap-2">
                <span x-show="isOffline" class="bg-yellow-500 text-xs px-2 py-1 rounded">é›¢ç·š</span>
                <button @click="refresh()" class="p-2 hover:bg-blood-700 rounded">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                    </svg>
                </button>
            </div>
        </div>
    </header>

    <!-- Tab Navigation (v2.8: é‡æ§‹ - åº«å­˜ç¸½è¦½å«æ¸…å–®ã€å…¥åº«+æ¨™ç±¤ç¨ç«‹) -->
    <nav class="bg-white border-b flex">
        <button @click="activeTab = 'overview'"
                :class="activeTab === 'overview' ? 'border-blood-600 text-blood-600' : 'border-transparent text-gray-500'"
                class="flex-1 py-3 text-sm font-medium border-b-2 transition">
            åº«å­˜ç¸½è¦½
        </button>
        <button @click="activeTab = 'receive'"
                :class="activeTab === 'receive' ? 'border-blood-600 text-blood-600' : 'border-transparent text-gray-500'"
                class="flex-1 py-3 text-sm font-medium border-b-2 transition">
            å…¥åº«+æ¨™ç±¤
        </button>
        <button @click="activeTab = 'issue'"
                :class="activeTab === 'issue' ? 'border-blood-600 text-blood-600' : 'border-transparent text-gray-500'"
                class="flex-1 py-3 text-sm font-medium border-b-2 transition">
            ç™¼è¡€
        </button>
        <button @click="activeTab = 'pending'; loadPendingOrders()"
                :class="activeTab === 'pending' ? 'border-blood-600 text-blood-600' : 'border-transparent text-gray-500'"
                class="flex-1 py-3 text-sm font-medium border-b-2 transition relative">
            å¾…è£œå–®
            <span x-show="pendingOrdersSummary.overdue_count > 0"
                  class="absolute -top-1 -right-1 bg-red-500 text-white text-xs w-5 h-5 rounded-full flex items-center justify-center">
                <span x-text="pendingOrdersSummary.overdue_count"></span>
            </span>
        </button>
    </nav>

    <!-- Main Content -->
    <main class="p-4 pb-24">

        <!-- Overview Tab -->
        <div x-show="activeTab === 'overview'" x-cloak>
            <h2 class="text-lg font-bold mb-4">åº«å­˜ç¸½è¦½</h2>

            <!-- v2.5 P4: Pending Orders Alert -->
            <div x-show="pendingOrdersSummary.overdue_count > 0"
                 @click="activeTab = 'pending'; loadPendingOrders()"
                 class="bg-red-50 border-l-4 border-red-500 p-3 mb-4 cursor-pointer hover:bg-red-100 transition">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-2">
                        <svg class="w-5 h-5 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        <span class="font-bold text-red-700">
                            <span x-text="pendingOrdersSummary.overdue_count"></span> ç­†å¾…è£œå–®å·²é€¾æœŸ
                        </span>
                    </div>
                    <svg class="w-5 h-5 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                    </svg>
                </div>
                <p class="text-sm text-red-600 mt-1">
                    ç·Šæ€¥ç™¼è¡€éœ€åœ¨ 24 å°æ™‚å…§è£œé–‹æ­£å¼é†«å›‘
                </p>
            </div>

            <!-- FIFO Warning Banner -->
            <div x-show="expiringSoonCount > 0" class="bg-amber-50 border-l-4 border-amber-500 p-3 mb-4">
                <div class="flex items-center gap-2">
                    <svg class="w-5 h-5 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    <span class="font-bold text-amber-700">FIFO å„ªå…ˆç™¼æ”¾</span>
                </div>
                <p class="text-sm text-amber-600 mt-1">
                    æœ‰ <span class="font-bold" x-text="expiringSoonCount"></span> è¢‹è¡€å“å³å°‡éæœŸï¼Œè«‹å„ªå…ˆç™¼æ”¾æ¨™æœ‰ FIFO çš„è¡€è¢‹
                </p>
            </div>

            <!-- Expired Warning Banner -->
            <div x-show="expiredCount > 0" class="bg-red-50 border-l-4 border-red-500 p-3 mb-4">
                <div class="flex items-center gap-2">
                    <svg class="w-5 h-5 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                    </svg>
                    <span class="font-bold text-red-700">å·²éæœŸè¡€å“</span>
                </div>
                <p class="text-sm text-red-600 mt-1">
                    æœ‰ <span class="font-bold" x-text="expiredCount"></span> è¢‹è¡€å“å·²éæœŸï¼Œè«‹ç›¡å¿«å ±å»¢
                </p>
            </div>

            <!-- Loading -->
            <div x-show="loading" class="text-center py-8 text-gray-500">
                è¼‰å…¥ä¸­...
            </div>

            <!-- v2.7: MIRS Legacy Style - Big Colored Cards Grid (The Soul of MIRS) -->
            <div x-show="!loading" class="mb-6 max-w-3xl mx-auto">
                <!-- 2x4 Grid of Blood Type Cards -->
                <div class="grid grid-cols-4 sm:grid-cols-8 gap-3">
                    <template x-for="blood in groupedByBloodType" :key="blood.blood_type">
                        <div @click="filterByBloodType(blood.blood_type)"
                             class="cursor-pointer rounded-xl p-4 shadow-lg transform hover:scale-105 transition-all duration-200"
                             :class="blood.total > 0 ? 'bg-red-900 hover:bg-red-800' : 'bg-gray-700 hover:bg-gray-600'">
                            <div class="text-center">
                                <!-- Blood Type - HUGE -->
                                <div class="text-3xl sm:text-4xl font-black text-white mb-1" x-text="blood.blood_type"></div>
                                <!-- Count - Yellow for visibility -->
                                <div class="text-xl sm:text-2xl font-bold"
                                     :class="blood.total > 0 ? 'text-yellow-300' : 'text-gray-500'">
                                    <span x-text="blood.total"></span>
                                    <span class="text-sm">è¢‹</span>
                                </div>
                                <!-- Expiring indicator -->
                                <div x-show="blood.expiring > 0"
                                     class="mt-1 text-xs text-orange-400 font-bold animate-pulse">
                                    âš  <span x-text="blood.expiring"></span> å³æœŸ
                                </div>
                            </div>
                        </div>
                    </template>
                </div>

                <!-- Quick Stats Bar -->
                <div class="mt-4 bg-white rounded-lg shadow p-3 flex items-center justify-between flex-wrap gap-2">
                    <div class="flex items-center gap-4 text-sm">
                        <span class="text-gray-600">ç¸½åº«å­˜: <span class="font-bold text-gray-900" x-text="totalUnits"></span> è¢‹</span>
                        <span x-show="totalExpiring > 0" class="text-orange-600 font-bold">
                            å³æœŸ: <span x-text="totalExpiring"></span>
                        </span>
                    </div>
                    <div class="flex items-center gap-1 sm:gap-2 flex-wrap">
                        <!-- Unit Type Legend -->
                        <span class="text-xs px-1.5 sm:px-2 py-1 rounded unit-type-wb">å…¨è¡€</span>
                        <span class="text-xs px-1.5 sm:px-2 py-1 rounded unit-type-prbc">ç´…è¡€çƒ</span>
                        <span class="text-xs px-1.5 sm:px-2 py-1 rounded unit-type-ffp">è¡€æ¼¿</span>
                        <span class="text-xs px-1.5 sm:px-2 py-1 rounded unit-type-plt">è¡€å°æ¿</span>
                    </div>
                </div>

                <!-- Active Filter Indicator -->
                <div x-show="dashboardFilter" class="mt-3 flex items-center justify-between bg-blue-50 border border-blue-200 rounded-lg p-2">
                    <span class="text-blue-700 text-sm">
                        ç¯©é¸ä¸­: <span class="font-bold" x-text="dashboardFilter"></span>
                    </span>
                    <button @click="dashboardFilter = ''" class="text-blue-600 text-sm underline">æ¸…é™¤ç¯©é¸</button>
                </div>
            </div>

            <!-- v2.8: å®Œæ•´è¡€è¢‹æ¸…å–® (å« FIFOã€é ç´„ã€ç™¼è¡€æŒ‰éˆ•) -->
            <div x-show="!loading" class="max-w-3xl mx-auto">
                <!-- Blood Type Filter -->
                <div class="flex gap-2 mb-4 overflow-x-auto pb-2">
                    <button @click="unitFilter = ''"
                            :class="unitFilter === '' ? 'bg-blood-600 text-white' : 'bg-white text-gray-700'"
                            class="px-3 py-1 rounded text-sm whitespace-nowrap shadow-sm">
                        å…¨éƒ¨
                    </button>
                    <template x-for="type in ['O+', 'O-', 'A+', 'A-', 'B+', 'B-', 'AB+', 'AB-']">
                        <button @click="unitFilter = type"
                                :class="unitFilter === type ? 'bg-blood-600 text-white' : 'bg-white text-gray-700'"
                                class="px-3 py-1 rounded text-sm whitespace-nowrap shadow-sm"
                                x-text="type">
                        </button>
                    </template>
                </div>

                <!-- Unit List with Full Features -->
                <div class="space-y-2">
                    <template x-for="unit in filteredUnits" :key="unit.id">
                        <div class="bg-white rounded-lg shadow-sm p-3 border-l-8"
                             :class="getUnitTypeBorderColorClass(unit.unit_type)">
                            <!-- Main Row: Blood Type, Component, Status -->
                            <div class="flex items-center justify-between mb-2">
                                <div class="flex items-center gap-3">
                                    <!-- Blood Type - Large -->
                                    <div class="text-2xl font-black text-gray-900 w-14" x-text="unit.blood_type"></div>
                                    <!-- Component Type Badge -->
                                    <span class="text-xs font-bold px-2 py-1 rounded"
                                          :class="getUnitTypeClass(unit.unit_type)"
                                          x-text="getUnitTypeLabel(unit.unit_type)"></span>
                                    <!-- Status Badge -->
                                    <span class="text-xs px-2 py-1 rounded"
                                          :class="{
                                              'bg-green-100 text-green-700': unit.display_status === 'AVAILABLE',
                                              'bg-blue-100 text-blue-700': unit.display_status === 'RESERVED',
                                              'bg-orange-100 text-orange-700': unit.display_status === 'EXPIRING_SOON',
                                              'bg-red-100 text-red-700': unit.display_status === 'EXPIRED'
                                          }"
                                          x-text="statusLabel(unit.display_status)"></span>
                                </div>
                                <!-- FIFO Priority -->
                                <span x-show="unit.fifo_priority === 1"
                                      class="text-xs bg-yellow-400 text-yellow-900 px-2 py-1 rounded font-bold">
                                    FIFO å„ªå…ˆ
                                </span>
                            </div>

                            <!-- Second Row: Unit ID (Prominent) & Expiry (Prominent) -->
                            <div class="flex items-center justify-between bg-gray-50 rounded px-2 py-1 mb-2">
                                <div class="font-mono text-sm font-bold text-gray-700" x-text="unit.id"></div>
                                <div class="text-sm font-bold"
                                     :class="{
                                         'text-green-600': unit.hours_until_expiry > 72,
                                         'text-orange-600': unit.hours_until_expiry <= 72 && unit.hours_until_expiry > 24,
                                         'text-red-600 animate-pulse': unit.hours_until_expiry <= 24
                                     }">
                                    <span x-show="unit.hours_until_expiry > 0">
                                        æ•ˆæœŸ: <span x-text="unit.hours_until_expiry"></span>h
                                    </span>
                                    <span x-show="unit.hours_until_expiry <= 0">âš ï¸ å·²éæœŸ</span>
                                </div>
                            </div>

                            <!-- Action Buttons -->
                            <div class="flex gap-2" x-show="unit.display_status === 'AVAILABLE' || unit.display_status === 'EXPIRING_SOON'">
                                <button @click="issueUnit(unit)"
                                        class="flex-1 bg-blood-600 text-white py-2 rounded text-sm font-bold hover:bg-blood-700 transition-colors">
                                    ç™¼è¡€
                                </button>
                                <button @click="reserveUnit(unit)"
                                        class="flex-1 bg-white text-gray-700 py-2 rounded text-sm font-medium border-2 border-gray-300 hover:border-gray-400">
                                    é ç´„
                                </button>
                            </div>
                            <div x-show="unit.display_status === 'RESERVED'">
                                <button @click="unreserveUnit(unit)"
                                        class="w-full bg-blue-50 text-blue-700 py-2 rounded text-sm font-medium border border-blue-200">
                                    å–æ¶ˆé ç´„
                                </button>
                            </div>
                            <div class="text-center text-red-600 text-sm font-bold py-2 bg-red-50 rounded" x-show="unit.display_status === 'EXPIRED'">
                                âš ï¸ æ­¤è¡€è¢‹å·²éæœŸï¼Œè«‹å ±å»¢è™•ç†
                            </div>
                        </div>
                    </template>
                </div>

                <div x-show="filteredUnits.length === 0" class="text-center py-8 text-gray-500">
                    æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„è¡€è¢‹
                </div>
            </div>

            <!-- Empty State -->
            <div x-show="!loading && availability.length === 0 && units.length === 0" class="text-center py-8 text-gray-500">
                ç›®å‰æ²’æœ‰è¡€å“åº«å­˜
            </div>
        </div>

        <!-- v2.8: å…¥åº«+æ¨™ç±¤ Tab (Receive + Label) -->
        <div x-show="activeTab === 'receive'" x-cloak class="max-w-3xl mx-auto">
            <h2 class="text-lg font-bold mb-4">å…¥åº«+æ¨™ç±¤</h2>

            <!-- å…¥åº«ä¾†æºé¸æ“‡å¡ç‰‡ -->
            <div class="grid grid-cols-2 gap-4 mb-6">
                <!-- æè¡€ä¸­å¿ƒå…¥åº« -->
                <div @click="receiveForm.source = 'blood_center'; showReceiveModal = true"
                     class="bg-white rounded-xl p-4 shadow-lg border-2 cursor-pointer hover:shadow-xl transition-all"
                     :class="receiveForm.source === 'blood_center' ? 'border-blood-600' : 'border-gray-200 hover:border-blood-400'">
                    <div class="text-center">
                        <div class="bg-red-100 text-red-600 w-12 h-12 rounded-full flex items-center justify-center mx-auto mb-3">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                            </svg>
                        </div>
                        <div class="font-bold text-gray-800">æè¡€ä¸­å¿ƒ</div>
                        <div class="text-xs text-gray-500 mt-1">è¡€æ¶²åŸºé‡‘æœƒé…é€</div>
                    </div>
                </div>

                <!-- ç·Šæ€¥æè¡€ (Walking Blood Bank) -->
                <div @click="receiveForm.source = 'walking_donor'; showEmergencyDonationModal = true"
                     class="bg-gradient-to-br from-orange-500 to-red-600 rounded-xl p-4 shadow-lg cursor-pointer hover:shadow-xl transition-all text-white">
                    <div class="text-center">
                        <div class="bg-white bg-opacity-20 w-12 h-12 rounded-full flex items-center justify-center mx-auto mb-3">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"/>
                            </svg>
                        </div>
                        <div class="font-bold">ç·Šæ€¥æè¡€</div>
                        <div class="text-xs opacity-80 mt-1">Walking Blood Bank</div>
                    </div>
                </div>
            </div>

            <!-- æ¨™ç±¤ç®¡ç†å€å¡Š -->
            <div class="bg-white rounded-xl shadow-lg p-4 mb-6">
                <h3 class="font-bold text-gray-800 mb-3 flex items-center gap-2">
                    <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"/>
                    </svg>
                    è£œå°æ¨™ç±¤
                </h3>
                <p class="text-sm text-gray-500 mb-4">é¸æ“‡è¡€è¢‹è£œå°æ¨™ç±¤</p>

                <!-- è¡€è¢‹æ¸…å–® (å¯é¸æ“‡è£œå°) -->
                <div class="space-y-2 max-h-64 overflow-y-auto">
                    <template x-for="unit in units.slice(0, 10)" :key="unit.id">
                        <div class="flex items-center justify-between p-2 bg-gray-50 rounded-lg border-l-4"
                             :class="getUnitTypeBorderColorClass(unit.unit_type)">
                            <div class="flex items-center gap-2">
                                <span class="font-bold text-gray-800" x-text="unit.blood_type"></span>
                                <span class="text-xs px-1.5 py-0.5 rounded"
                                      :class="getUnitTypeClass(unit.unit_type)"
                                      x-text="getUnitTypeLabel(unit.unit_type)"></span>
                                <span class="font-mono text-xs text-gray-500" x-text="unit.id"></span>
                            </div>
                            <button @click="printUnitLabel(unit.id)"
                                    class="text-blood-600 text-sm font-medium hover:text-blood-800 flex items-center gap-1">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"/>
                                </svg>
                                åˆ—å°
                            </button>
                        </div>
                    </template>
                </div>

                <div x-show="units.length === 0" class="text-center py-4 text-gray-400">
                    ç›®å‰æ²’æœ‰è¡€è¢‹å¯è£œå°æ¨™ç±¤
                </div>
            </div>

            <!-- æœ€è¿‘å…¥åº«è¨˜éŒ„ -->
            <div class="bg-white rounded-xl shadow-lg p-4">
                <h3 class="font-bold text-gray-800 mb-3 flex items-center gap-2">
                    <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    æœ€è¿‘å…¥åº«
                </h3>
                <div class="space-y-2">
                    <template x-for="unit in units.filter(u => u.status === 'AVAILABLE').slice(0, 5)" :key="'recent-' + unit.id">
                        <div class="flex items-center justify-between text-sm py-1 border-b border-gray-100">
                            <div class="flex items-center gap-2">
                                <span class="font-bold" x-text="unit.blood_type"></span>
                                <span class="text-xs px-1 rounded bg-gray-100" x-text="unit.unit_type"></span>
                            </div>
                            <span class="text-gray-500 font-mono text-xs" x-text="unit.id.slice(-8)"></span>
                        </div>
                    </template>
                </div>
            </div>
        </div>

        <!-- Issue Tab (v2.3 Location-First Display) -->
        <div x-show="activeTab === 'issue'" x-cloak class="max-w-3xl mx-auto">
            <h2 class="text-lg font-bold mb-4">ç™¼è¡€ä½œæ¥­</h2>

            <!-- Three-Tier Flow Selector -->
            <div class="bg-white rounded-lg shadow p-4 mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">ç™¼è¡€æµç¨‹</label>
                <div class="grid grid-cols-3 gap-2">
                    <button @click="issueFlow.tier = 1"
                            :class="issueFlow.tier === 1 ? 'bg-green-600 text-white' : 'bg-gray-100 text-gray-700'"
                            class="py-2 rounded text-sm font-medium">
                        æ¨™æº–
                    </button>
                    <button @click="issueFlow.tier = 2"
                            :class="issueFlow.tier === 2 ? 'bg-amber-500 text-white' : 'bg-gray-100 text-gray-700'"
                            class="py-2 rounded text-sm font-medium">
                        å¿«é€Ÿ
                    </button>
                    <button @click="issueFlow.tier = 3"
                            :class="issueFlow.tier === 3 ? 'bg-red-600 text-white' : 'bg-gray-100 text-gray-700'"
                            class="py-2 rounded text-sm font-medium">
                        ç·Šæ€¥
                    </button>
                </div>
                <p class="text-xs text-gray-500 mt-2" x-show="issueFlow.tier === 1">
                    æ¨™æº–æµç¨‹ï¼šæœ‰ä½ç½® + æœ‰é†«å›‘ + å·²é…è¡€
                </p>
                <p class="text-xs text-amber-600 mt-2" x-show="issueFlow.tier === 2">
                    å¿«é€Ÿæµç¨‹ï¼šæœ‰ä½ç½® + å£é ­é†«å›‘ (äº‹å¾Œè£œå–®)
                </p>
                <p class="text-xs text-red-600 mt-2" x-show="issueFlow.tier === 3">
                    ç·Šæ€¥æµç¨‹ï¼šç„¡ä½ç½®/æ¥µç«¯æ··äº‚ï¼Œåƒ…é™ O å‹è¡€
                </p>
            </div>

            <!-- Patient ID Input -->
            <div class="bg-white rounded-lg shadow p-4 mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">ç—…æ‚£ ID</label>
                <div class="flex gap-2">
                    <input type="text" x-model="issueFlow.patientId"
                           placeholder="è¼¸å…¥æˆ–æƒæ P-XXXX"
                           class="flex-1 border rounded px-3 py-2">
                    <button @click="scanPatientQR()"
                            class="bg-gray-200 px-4 py-2 rounded">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                  d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h2M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z"/>
                        </svg>
                    </button>
                </div>
                <button @click="lookupPatientLocation()"
                        :disabled="!issueFlow.patientId"
                        class="w-full mt-2 bg-blue-600 text-white py-2 rounded disabled:bg-gray-300">
                    æŸ¥è©¢ç—…æ‚£ä½ç½®
                </button>

                <!-- Patient Location Display (v2.3 Location-First) -->
                <div x-show="issueFlow.patientLocation" class="mt-3 p-3 rounded-lg"
                     :class="issueFlow.patientLocation ? 'bg-green-50 border-2 border-green-500' : ''">
                    <div class="text-center">
                        <span class="text-xs text-green-600 font-medium">é€è¡€ç›®çš„åœ°</span>
                        <div class="text-2xl font-bold text-green-800" x-text="issueFlow.patientLocation"></div>
                        <div class="text-sm text-green-600" x-text="issueFlow.patientLocationName"></div>
                    </div>
                </div>
                <div x-show="issueFlow.patientWarning" class="mt-3 p-3 bg-amber-50 border-2 border-amber-400 rounded-lg">
                    <div class="text-center">
                        <span class="text-amber-700 font-medium" x-text="issueFlow.patientWarning"></span>
                    </div>
                </div>
            </div>

            <!-- v2.6: ä½ç½®æ¬„ä½ (ç›´æ¥è¼¸å…¥) -->
            <div class="bg-white rounded-lg shadow p-4 mb-4" x-show="issueFlow.tier !== 3 && !issueFlow.patientLocation">
                <label class="block text-sm font-medium text-gray-700 mb-2">é€è¡€ä½ç½® (æ‰‹å‹•è¼¸å…¥)</label>
                <input type="text" x-model="issueFlow.manualLocation"
                       placeholder="ä¾‹: ER-05, ICU-01, OR-2, WARD-305"
                       class="w-full border rounded px-3 py-2">
                <p class="text-xs text-gray-500 mt-1">è‹¥ç„¡æ³•æŸ¥è©¢ç—…æ‚£ä½ç½®ï¼Œå¯ç›´æ¥è¼¸å…¥é€è¡€ç›®çš„åœ°</p>
            </div>

            <!-- Blood Unit Selection -->
            <div class="bg-white rounded-lg shadow p-4 mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">è¡€è¢‹é¸æ“‡</label>
                <div class="grid grid-cols-3 gap-2 mb-2">
                    <select x-model="issueFlow.bloodType" class="border rounded px-3 py-2">
                        <option value="">è¡€å‹</option>
                        <template x-for="type in ['O+', 'O-', 'A+', 'A-', 'B+', 'B-', 'AB+', 'AB-']">
                            <option :value="type" x-text="type"></option>
                        </template>
                    </select>
                    <select x-model="issueFlow.unitType" class="border rounded px-3 py-2">
                        <option value="">è¡€å“é¡å‹</option>
                        <option value="WB">å…¨è¡€ WB</option>
                        <option value="PRBC">ç´…è¡€çƒ PRBC</option>
                        <option value="FFP">è¡€æ¼¿ FFP</option>
                        <option value="PLT">è¡€å°æ¿ PLT</option>
                        <option value="CRYO">å†·æ²‰æ¾± CRYO</option>
                    </select>
                    <input type="number" x-model="issueFlow.quantity" min="1" max="10"
                           placeholder="æ•¸é‡" class="border rounded px-3 py-2">
                </div>

                <!-- Scan Blood Unit Barcode -->
                <button @click="scanBloodUnit()"
                        class="w-full bg-blood-600 text-white py-3 rounded font-medium flex items-center justify-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h2M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z"/>
                    </svg>
                    æƒæè¡€è¢‹æ¢ç¢¼
                </button>

                <!-- Selected Units -->
                <div x-show="issueFlow.selectedUnits.length > 0" class="mt-3 space-y-2">
                    <template x-for="(unit, idx) in issueFlow.selectedUnits" :key="unit.id">
                        <div class="flex items-center justify-between p-2 bg-gray-50 rounded">
                            <div>
                                <span class="font-medium" x-text="unit.blood_type"></span>
                                <span class="text-xs text-gray-500 ml-2" x-text="unit.id"></span>
                            </div>
                            <button @click="issueFlow.selectedUnits.splice(idx, 1)"
                                    class="text-red-500 text-sm">ç§»é™¤</button>
                        </div>
                    </template>
                </div>
            </div>

            <!-- Order ID (Tier 1 only) -->
            <div x-show="issueFlow.tier === 1" class="bg-white rounded-lg shadow p-4 mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">é†«å›‘å–®è™Ÿ</label>
                <input type="text" x-model="issueFlow.orderId"
                       placeholder="ORD-XXXX"
                       class="w-full border rounded px-3 py-2">
            </div>

            <!-- Verbal Order Reason (Tier 2 only) -->
            <div x-show="issueFlow.tier === 2" class="bg-white rounded-lg shadow p-4 mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">å£é ­é†«å›‘å‚™è¨»</label>
                <textarea x-model="issueFlow.verbalOrderNote"
                          placeholder="é†«å¸«å§“åã€æ™‚é–“ã€æŒ‡ç¤ºå…§å®¹..."
                          rows="2"
                          class="w-full border rounded px-3 py-2"></textarea>
                <p class="text-xs text-amber-600 mt-1">
                    è«‹æ–¼ 24h å…§è£œé–‹æ­£å¼é†«å›‘
                </p>
            </div>

            <!-- Issue Button -->
            <button @click="processIssue()"
                    :disabled="!canProcessIssue"
                    class="w-full py-4 rounded-lg font-bold text-lg disabled:bg-gray-300"
                    :class="{
                        'bg-green-600 text-white': issueFlow.tier === 1,
                        'bg-amber-500 text-white': issueFlow.tier === 2,
                        'bg-red-600 text-white': issueFlow.tier === 3
                    }">
                <span x-show="issueFlow.tier === 1">ç¢ºèªç™¼è¡€ (æ¨™æº–)</span>
                <span x-show="issueFlow.tier === 2">ç¢ºèªç™¼è¡€ (å¿«é€Ÿ)</span>
                <span x-show="issueFlow.tier === 3">ç¢ºèªç·Šæ€¥ç™¼è¡€</span>
            </button>
        </div>

        <!-- Pending Orders Tab (v2.5 P4) -->
        <div x-show="activeTab === 'pending'" x-cloak class="max-w-3xl mx-auto">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-lg font-bold">å¾…è£œå–®è¿½è¹¤</h2>
                <button @click="loadPendingOrders()"
                        class="text-blood-600 text-sm flex items-center gap-1">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                    </svg>
                    é‡æ–°æ•´ç†
                </button>
            </div>

            <!-- Summary Banner -->
            <div x-show="pendingOrdersSummary.pending_count > 0"
                 class="mb-4 p-4 rounded-lg"
                 :class="pendingOrdersSummary.overdue_count > 0 ? 'bg-red-50 border-l-4 border-red-500' : 'bg-amber-50 border-l-4 border-amber-500'">
                <div class="flex items-center gap-2 mb-2">
                    <svg class="w-5 h-5" :class="pendingOrdersSummary.overdue_count > 0 ? 'text-red-600' : 'text-amber-600'" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    <span class="font-bold" :class="pendingOrdersSummary.overdue_count > 0 ? 'text-red-700' : 'text-amber-700'">
                        <span x-text="pendingOrdersSummary.pending_count"></span> ç­†å¾…è£œå–®
                    </span>
                </div>
                <p class="text-sm" :class="pendingOrdersSummary.overdue_count > 0 ? 'text-red-600' : 'text-amber-600'">
                    <span x-show="pendingOrdersSummary.overdue_count > 0">
                        <span class="font-bold" x-text="pendingOrdersSummary.overdue_count"></span> ç­†å·²è¶…é 24 å°æ™‚æœŸé™
                        <span x-show="pendingOrdersSummary.oldest_overdue_hours > 0">
                            (æœ€ä¹… <span x-text="pendingOrdersSummary.oldest_overdue_hours"></span> å°æ™‚)
                        </span>
                    </span>
                    <span x-show="pendingOrdersSummary.overdue_count === 0">
                        è«‹åœ¨ 24 å°æ™‚å…§è£œé–‹æ­£å¼é†«å›‘
                    </span>
                </p>
            </div>

            <!-- Empty State -->
            <div x-show="!pendingOrdersLoading && pendingOrders.length === 0" class="text-center py-12 text-gray-500">
                <svg class="w-16 h-16 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                <p class="font-medium">æ²’æœ‰å¾…è£œå–®</p>
                <p class="text-sm mt-1">æ‰€æœ‰ç·Šæ€¥ç™¼è¡€éƒ½å·²è£œé–‹é†«å›‘</p>
            </div>

            <!-- Loading -->
            <div x-show="pendingOrdersLoading" class="text-center py-8 text-gray-500">
                è¼‰å…¥ä¸­...
            </div>

            <!-- Pending Orders List -->
            <div x-show="!pendingOrdersLoading" class="space-y-3">
                <template x-for="order in pendingOrders" :key="order.id">
                    <div class="bg-white rounded-lg shadow p-4"
                         :class="order.is_overdue ? 'border-l-4 border-red-500' : ''">
                        <!-- Header -->
                        <div class="flex items-start justify-between mb-3">
                            <div>
                                <div class="flex items-center gap-2">
                                    <span class="font-mono text-sm font-medium" x-text="order.id"></span>
                                    <span x-show="order.is_overdue"
                                          class="text-xs bg-red-100 text-red-700 px-2 py-0.5 rounded">
                                        å·²é€¾æœŸ
                                    </span>
                                </div>
                                <div class="text-xs text-gray-500 mt-1">
                                    å»ºç«‹æ™‚é–“: <span x-text="formatDateTime(order.created_at)"></span>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-sm font-medium"
                                     :class="order.hours_remaining > 0 ? 'text-amber-600' : 'text-red-600'">
                                    <span x-show="order.hours_remaining > 0">
                                        å‰©é¤˜ <span x-text="order.hours_remaining"></span> å°æ™‚
                                    </span>
                                    <span x-show="order.hours_remaining <= 0">
                                        é€¾æœŸ <span x-text="Math.abs(order.hours_remaining)"></span> å°æ™‚
                                    </span>
                                </div>
                            </div>
                        </div>

                        <!-- Details -->
                        <div class="bg-gray-50 rounded p-3 mb-3 space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-gray-600">é¡å‹</span>
                                <span class="font-medium" x-text="orderTypeLabel(order.type)"></span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">ç™¼è¡€è¢‹æ•¸</span>
                                <span class="font-medium" x-text="order.unit_ids ? order.unit_ids.length : 0"></span>
                            </div>
                            <div x-show="order.reason">
                                <span class="text-gray-600">åŸå› :</span>
                                <span class="text-gray-800 ml-1" x-text="order.reason"></span>
                            </div>
                            <div x-show="order.unit_ids && order.unit_ids.length > 0">
                                <span class="text-gray-600">è¡€è¢‹ ID:</span>
                                <div class="text-xs font-mono text-gray-700 mt-1" x-text="order.unit_ids.join(', ')"></div>
                            </div>
                        </div>

                        <!-- Action Button -->
                        <button @click="openResolveModal(order)"
                                class="w-full bg-green-600 text-white py-2 rounded font-medium flex items-center justify-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            è£œé–‹é†«å›‘å®Œæˆ
                        </button>
                    </div>
                </template>
            </div>
        </div>

        <!-- Emergency Tab -->
        <div x-show="activeTab === 'emergency'" x-cloak>
            <div class="bg-red-50 border-l-4 border-red-500 p-4 mb-4">
                <h3 class="font-bold text-red-700">ç·Šæ€¥ç™¼è¡€ (Break-Glass)</h3>
                <p class="text-sm text-red-600 mt-1">
                    åƒ…é™ç·Šæ€¥æƒ…æ³ä½¿ç”¨ã€‚å°‡è·³éé…è¡€æµç¨‹ï¼Œç›´æ¥ç™¼æ”¾ O å‹è¡€ã€‚
                    æ­¤æ“ä½œå°‡è¢«æœ€é«˜ç´šåˆ¥ç¨½æ ¸ã€‚
                </p>
            </div>

            <div class="bg-white rounded-lg shadow p-4">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">è¡€å‹</label>
                        <select x-model="emergencyForm.blood_type"
                                class="w-full border rounded px-3 py-2">
                            <option value="O+">O+ (é€šç”¨é™½æ€§)</option>
                            <option value="O-">O- (é€šç”¨é™°æ€§)</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">æ•¸é‡</label>
                        <input type="number" x-model="emergencyForm.quantity"
                               min="1" max="10"
                               class="w-full border rounded px-3 py-2">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ç·Šæ€¥åŸå›  (å¿…å¡«)</label>
                        <textarea x-model="emergencyForm.reason"
                                  rows="3"
                                  placeholder="è«‹èªªæ˜ç·Šæ€¥ç™¼è¡€åŸå› ..."
                                  class="w-full border rounded px-3 py-2"></textarea>
                    </div>
                    <button @click="emergencyRelease()"
                            :disabled="!emergencyForm.reason"
                            class="w-full bg-red-600 text-white py-3 rounded font-bold disabled:bg-gray-400">
                        ç¢ºèªç·Šæ€¥ç™¼è¡€
                    </button>
                </div>
            </div>
        </div>
    </main>

    <!-- Receive Modal -->
    <!-- v2.8: ä¸€èˆ¬å…¥åº« Modal (æè¡€ä¸­å¿ƒ) -->
    <div x-show="showReceiveModal" x-cloak
         class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-end">
        <div class="bg-white w-full rounded-t-2xl p-4 max-h-[80vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-bold flex items-center gap-2">
                    <span class="bg-red-100 text-red-600 p-1 rounded">ğŸ¥</span>
                    æè¡€ä¸­å¿ƒå…¥åº«
                </h3>
                <button @click="showReceiveModal = false" class="text-gray-500">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div class="space-y-4">
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">è¡€å‹ *</label>
                        <select x-model="receiveForm.blood_type" class="w-full border rounded px-3 py-2">
                            <template x-for="type in ['O+', 'O-', 'A+', 'A-', 'B+', 'B-', 'AB+', 'AB-']">
                                <option :value="type" x-text="type"></option>
                            </template>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">è¡€å“é¡å‹</label>
                        <select x-model="receiveForm.unit_type" class="w-full border rounded px-3 py-2">
                            <option value="WB">WB (å…¨è¡€)</option>
                            <option value="PRBC">PRBC (ç´…è¡€çƒ)</option>
                            <option value="FFP">FFP (è¡€æ¼¿)</option>
                            <option value="PLT">PLT (è¡€å°æ¿)</option>
                            <option value="CRYO">CRYO (å†·æ²‰æ¾±)</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">æ•ˆæœŸ *</label>
                    <input type="date" x-model="receiveForm.expiry_date"
                           class="w-full border rounded px-3 py-2">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">æè¡€ç·¨è™Ÿ (é¸å¡«)</label>
                    <input type="text" x-model="receiveForm.donation_id"
                           placeholder="D-XXXXXXXX"
                           class="w-full border rounded px-3 py-2">
                </div>
                <div class="grid grid-cols-2 gap-2">
                    <button @click="receiveUnit()"
                            class="bg-blood-600 text-white py-3 rounded font-bold flex items-center justify-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                        </svg>
                        ç¢ºèªå…¥åº«
                    </button>
                    <button @click="printBloodLabel()"
                            class="bg-white text-blood-600 py-3 rounded font-bold border-2 border-blood-600 flex items-center justify-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"/>
                        </svg>
                        åˆ—å°æ¨™ç±¤
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- v2.8: ç·Šæ€¥æè¡€ Modal (Walking Blood Bank) -->
    <div x-show="showEmergencyDonationModal" x-cloak
         class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-end">
        <div class="bg-gradient-to-b from-orange-50 to-white w-full rounded-t-2xl p-4 max-h-[80vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-bold flex items-center gap-2 text-orange-700">
                    <span class="bg-orange-500 text-white p-1 rounded">ğŸš¨</span>
                    ç·Šæ€¥æè¡€ (Walking Blood Bank)
                </h3>
                <button @click="showEmergencyDonationModal = false" class="text-gray-500">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>

            <!-- è­¦å‘Šæç¤º -->
            <div class="bg-orange-100 border-l-4 border-orange-500 p-3 mb-4 rounded-r">
                <p class="text-sm text-orange-800">
                    <strong>ç·Šæ€¥æè¡€</strong>ï¼šé©ç”¨æ–¼ç¾å ´æè¡€è€…ç›´æ¥è¼¸è¡€çš„ç·Šæ€¥ç‹€æ³ã€‚<br>
                    éœ€è¨˜éŒ„æè¡€è€…è³‡è¨Šï¼Œäº‹å¾Œè£œåšå®Œæ•´è¡€æ¶²æª¢é©—ã€‚
                </p>
            </div>

            <div class="space-y-4">
                <!-- æè¡€è€…è³‡è¨Š -->
                <div class="bg-white rounded-lg p-3 border border-orange-200">
                    <h4 class="font-bold text-gray-700 mb-2">æè¡€è€…è³‡è¨Š</h4>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">å§“å *</label>
                            <input type="text" x-model="receiveForm.donor_name"
                                   placeholder="æè¡€è€…å§“å"
                                   class="w-full border rounded px-3 py-2">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">é›»è©±</label>
                            <input type="tel" x-model="receiveForm.donor_phone"
                                   placeholder="0912-345-678"
                                   class="w-full border rounded px-3 py-2">
                        </div>
                    </div>
                </div>

                <!-- è¡€å“è³‡è¨Š -->
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">è¡€å‹ *</label>
                        <select x-model="receiveForm.blood_type" class="w-full border rounded px-3 py-2">
                            <template x-for="type in ['O+', 'O-', 'A+', 'A-', 'B+', 'B-', 'AB+', 'AB-']">
                                <option :value="type" x-text="type"></option>
                            </template>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">è¡€å“é¡å‹</label>
                        <select x-model="receiveForm.unit_type" class="w-full border rounded px-3 py-2">
                            <option value="WB" selected>WB (å…¨è¡€) - ç·Šæ€¥é¦–é¸</option>
                        </select>
                    </div>
                </div>

                <div class="text-sm text-gray-500 bg-gray-50 p-2 rounded">
                    æ•ˆæœŸå°‡è‡ªå‹•è¨­ç‚º 21 å¤© (Walking Blood Bank æ¨™æº–)
                </div>

                <button @click="receiveForm.source = 'walking_donor'; receiveForm.unit_type = 'WB'; receiveForm.expiry_date = new Date(Date.now() + 21*24*60*60*1000).toISOString().split('T')[0]; receiveUnit(); showEmergencyDonationModal = false;"
                        class="w-full bg-gradient-to-r from-orange-500 to-red-600 text-white py-3 rounded-lg font-bold flex items-center justify-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                    </svg>
                    ç¢ºèªç·Šæ€¥å…¥åº«
                </button>
            </div>
        </div>
    </div>

    <!-- Issue Success Modal (v2.3 Location-First Display) -->
    <div x-show="showIssueSuccess" x-cloak
         class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-md rounded-2xl overflow-hidden shadow-2xl">
            <!-- Success Header -->
            <div class="bg-green-600 text-white p-4 text-center">
                <svg class="w-12 h-12 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <h2 class="text-xl font-bold">ç™¼è¡€æˆåŠŸ</h2>
            </div>

            <!-- Location-First Display (The Key UX) -->
            <div class="p-6">
                <!-- Location Box - THE MOST IMPORTANT -->
                <div x-show="issueResult.location"
                     class="bg-green-800 text-white p-6 rounded-xl text-center mb-4">
                    <span class="text-xs opacity-75">é€è‡³</span>
                    <div class="text-3xl font-bold mt-1" x-text="issueResult.location"></div>
                    <div class="text-sm opacity-90 mt-1" x-text="issueResult.locationName"></div>
                </div>

                <!-- No Location Warning -->
                <div x-show="!issueResult.location"
                     class="bg-amber-500 text-white p-6 rounded-xl text-center mb-4">
                    <svg class="w-8 h-8 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                    </svg>
                    <div class="font-bold">å°šæœªåˆ†é…ä½ç½®</div>
                    <div class="text-sm mt-1">è«‹ç¢ºèªç—…æ‚£æ‰€åœ¨åœ°å¾Œé€é”</div>
                </div>

                <!-- Blood Info (Secondary) -->
                <div class="space-y-2 text-center">
                    <div class="text-xl font-bold text-blood-600" x-text="issueResult.bloodInfo"></div>
                    <div class="text-sm text-gray-600">
                        ç—…æ‚£ï¼š<span x-text="issueResult.patientId || 'æœªæŒ‡å®š'"></span>
                    </div>
                    <div x-show="issueResult.triageLevel" class="text-sm">
                        <span class="px-2 py-1 rounded text-white"
                              :class="{
                                  'bg-red-600': issueResult.triageLevel === 1,
                                  'bg-amber-500': issueResult.triageLevel === 2,
                                  'bg-green-500': issueResult.triageLevel >= 3
                              }">
                            æª¢å‚· <span x-text="issueResult.triageLevel"></span> ç´š
                        </span>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="mt-6 space-y-2">
                    <button @click="printDeliverySlip()"
                            class="w-full bg-gray-200 text-gray-700 py-3 rounded-lg font-medium">
                        åˆ—å°æ´¾é€å–®
                    </button>
                    <button @click="closeIssueSuccess()"
                            class="w-full bg-green-600 text-white py-3 rounded-lg font-bold">
                        å®Œæˆ
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Barcode Scanner Modal -->
    <div x-show="showScanner" x-cloak
         class="fixed inset-0 bg-black z-50 flex flex-col">
        <div class="bg-blood-700 text-white px-4 py-3 flex items-center justify-between">
            <span class="font-medium" x-text="scannerMode === 'patient' ? 'æƒæç—…æ‚£ QR Code' : 'æƒæè¡€è¢‹æ¢ç¢¼'"></span>
            <button @click="closeScanner()" class="p-2">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>
        <div class="flex-1 relative">
            <video id="scanner-video" class="w-full h-full object-cover"></video>
            <div class="absolute inset-0 flex items-center justify-center">
                <div class="w-64 h-64 border-4 border-white rounded-lg opacity-50"></div>
            </div>
        </div>
        <div class="bg-black text-white text-center py-4">
            <p class="text-sm">å°‡æ¢ç¢¼å°æº–æ¡†å…§</p>
            <!-- Manual input fallback -->
            <button @click="manualInput()"
                    class="mt-2 text-xs underline opacity-75">
                æ”¹ç”¨æ‰‹å‹•è¼¸å…¥
            </button>
        </div>
    </div>

    <!-- Resolve Pending Order Modal (v2.5 P4) -->
    <div x-show="showResolveModal" x-cloak
         class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-end">
        <div class="bg-white w-full rounded-t-2xl p-4 max-h-[80vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-bold">è£œé–‹é†«å›‘</h3>
                <button @click="showResolveModal = false" class="text-gray-500">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>

            <!-- Order Info -->
            <div x-show="resolvingOrder" class="bg-gray-50 rounded-lg p-4 mb-4">
                <div class="flex justify-between text-sm mb-2">
                    <span class="text-gray-600">å¾…è£œå–® ID</span>
                    <span class="font-mono font-medium" x-text="resolvingOrder?.id"></span>
                </div>
                <div class="flex justify-between text-sm mb-2">
                    <span class="text-gray-600">ç·Šæ€¥åŸå› </span>
                    <span x-text="resolvingOrder?.reason || '-'"></span>
                </div>
                <div class="flex justify-between text-sm">
                    <span class="text-gray-600">è¡€è¢‹æ•¸</span>
                    <span x-text="resolvingOrder?.unit_ids?.length || 0"></span>
                </div>
            </div>

            <!-- Form -->
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">æ­£å¼é†«å›‘å–®è™Ÿ *</label>
                    <input type="text" x-model="resolveForm.order_id"
                           placeholder="ORD-XXXXXX"
                           class="w-full border rounded px-3 py-2">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">å¡«å¯«äººå“¡</label>
                    <input type="text" x-model="resolveForm.resolver_id"
                           placeholder="é†«å¸«/è­·ç†å¸« ID"
                           class="w-full border rounded px-3 py-2">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">å‚™è¨»</label>
                    <textarea x-model="resolveForm.notes"
                              rows="2"
                              placeholder="é¸å¡«..."
                              class="w-full border rounded px-3 py-2"></textarea>
                </div>
                <button @click="resolvePendingOrder()"
                        :disabled="!resolveForm.order_id"
                        class="w-full bg-green-600 text-white py-3 rounded font-bold disabled:bg-gray-400">
                    ç¢ºèªè£œå–®å®Œæˆ
                </button>
            </div>
        </div>
    </div>

    <!-- Expiry Blocker Modal -->
    <div x-show="showExpiryBlocker" class="blocker-modal">
        <svg class="w-24 h-24 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
        </svg>
        <h2 class="text-3xl font-bold mb-2">è¡€å“å·²éæœŸ</h2>
        <p class="text-xl mb-4" x-text="blockerMessage"></p>
        <p class="text-lg opacity-75">ç¦æ­¢ç™¼æ”¾</p>
        <button @click="showExpiryBlocker = false"
                class="mt-8 bg-white text-red-700 px-8 py-3 rounded-lg font-bold text-lg">
            æˆ‘äº†è§£äº†
        </button>
    </div>

    <!-- Toast -->
    <div x-show="toast.show" x-transition
         :class="toast.type === 'success' ? 'bg-green-600' : toast.type === 'error' ? 'bg-red-600' : 'bg-blue-600'"
         class="fixed bottom-20 left-4 right-4 text-white px-4 py-3 rounded-lg shadow-lg z-40">
        <span x-text="toast.message"></span>
    </div>

    <!-- Alpine.js -->
    <script src="/static/js/alpine.min.js" defer></script>

    <script>
        function bloodApp() {
            return {
                activeTab: 'overview',
                loading: false,
                isOffline: !navigator.onLine,

                availability: [],
                units: [],
                unitFilter: '',
                dashboardFilter: '',  // v2.7: Dashboard blood type filter

                showReceiveModal: false,
                showEmergencyDonationModal: false,  // v2.8: ç·Šæ€¥æè¡€ Modal
                showExpiryBlocker: false,
                blockerMessage: '',

                // v2.3: Issue Flow State
                showIssueSuccess: false,
                showScanner: false,
                scannerMode: 'blood', // 'patient' | 'blood'
                scannerStream: null,

                issueFlow: {
                    tier: 1,  // 1=Standard, 2=Rapid, 3=Emergency
                    patientId: '',
                    patientLocation: '',
                    patientLocationName: '',
                    patientLocationType: '',
                    patientWarning: '',
                    patientTriageLevel: null,
                    manualLocation: '',  // v2.6: æ‰‹å‹•è¼¸å…¥ä½ç½®
                    bloodType: '',
                    unitType: '',  // v2.6: è¡€å“é¡å‹
                    quantity: 1,
                    selectedUnits: [],
                    orderId: '',
                    verbalOrderNote: ''
                },

                issueResult: {
                    location: '',
                    locationName: '',
                    bloodInfo: '',
                    patientId: '',
                    triageLevel: null,
                    unitIds: []
                },

                // CIRS Hub URL (for patient location lookup)
                cirsHubUrl: localStorage.getItem('cirs_hub_url') || 'http://localhost:8090',

                receiveForm: {
                    blood_type: 'O+',
                    unit_type: 'WB',
                    expiry_date: '',
                    donation_id: '',
                    source: 'blood_center',  // v2.8: blood_center | walking_donor
                    donor_name: '',          // v2.8: ç·Šæ€¥æè¡€è€…å§“å
                    donor_phone: ''          // v2.8: ç·Šæ€¥æè¡€è€…é›»è©±
                },

                emergencyForm: {
                    blood_type: 'O+',
                    quantity: 1,
                    reason: ''
                },

                toast: {
                    show: false,
                    message: '',
                    type: 'info'
                },

                // v2.5 P4: Pending Orders State
                pendingOrders: [],
                pendingOrdersLoading: false,
                pendingOrdersSummary: {
                    pending_count: 0,
                    overdue_count: 0,
                    oldest_overdue_hours: 0
                },
                showResolveModal: false,
                resolvingOrder: null,
                resolveForm: {
                    order_id: '',
                    resolver_id: '',
                    notes: ''
                },

                async init() {
                    // ç›£è½ç¶²è·¯ç‹€æ…‹
                    window.addEventListener('online', () => this.isOffline = false);
                    window.addEventListener('offline', () => this.isOffline = true);

                    // è¨»å†Š Service Worker
                    if ('serviceWorker' in navigator) {
                        navigator.serviceWorker.register('/blood/service-worker.js')
                            .then(reg => console.log('[Blood] SW registered'))
                            .catch(err => console.error('[Blood] SW registration failed:', err));
                    }

                    // è¼‰å…¥è³‡æ–™
                    await this.refresh();

                    // v2.5 P4: è¼‰å…¥å¾…è£œå–®æ‘˜è¦
                    await this.loadPendingOrdersSummary();
                },

                async refresh() {
                    this.loading = true;
                    try {
                        await Promise.all([
                            this.loadAvailability(),
                            this.loadUnits()
                        ]);
                    } catch (e) {
                        console.error('Failed to load data:', e);
                    }
                    this.loading = false;
                },

                async loadAvailability() {
                    const res = await fetch('/api/blood/availability');
                    const data = await res.json();
                    if (data.success) {
                        this.availability = data.data;
                    }
                },

                async loadUnits() {
                    const res = await fetch('/api/blood/units');
                    const data = await res.json();
                    if (data.success) {
                        this.units = data.data;
                    }
                },

                get filteredUnits() {
                    if (!this.unitFilter) return this.units;
                    return this.units.filter(u => u.blood_type === this.unitFilter);
                },

                get expiringSoonCount() {
                    return this.availability.reduce((sum, item) => sum + (item.expiring_soon_count || 0), 0);
                },

                get expiredCount() {
                    return this.availability.reduce((sum, item) => sum + (item.expired_pending_count || 0), 0);
                },

                statusLabel(status) {
                    const labels = {
                        'AVAILABLE': 'å¯ç”¨',
                        'RESERVED': 'å·²é ç´„',
                        'EXPIRING_SOON': 'å³å°‡éæœŸ',
                        'EXPIRED': 'å·²éæœŸ'
                    };
                    return labels[status] || status;
                },

                // v2.6: è¡€å“é¡å‹è¼”åŠ©å‡½æ•¸
                getUnitTypeClass(unitType) {
                    const classes = {
                        'WB': 'unit-type-wb',
                        'PRBC': 'unit-type-prbc',
                        'FFP': 'unit-type-ffp',
                        'PLT': 'unit-type-plt',
                        'CRYO': 'unit-type-cryo'
                    };
                    return classes[unitType] || 'bg-gray-500 text-white';
                },

                getUnitTypeBorderClass(unitType) {
                    const classes = {
                        'WB': 'border-red-900',
                        'PRBC': 'border-red-500',
                        'FFP': 'border-amber-500',
                        'PLT': 'border-yellow-400',
                        'CRYO': 'border-cyan-500'
                    };
                    return classes[unitType] || 'border-gray-300';
                },

                getUnitTypeLabel(unitType) {
                    const labels = {
                        'WB': 'å…¨è¡€',
                        'PRBC': 'ç´…è¡€çƒ',
                        'FFP': 'è¡€æ¼¿',
                        'PLT': 'è¡€å°æ¿',
                        'CRYO': 'å†·æ²‰æ¾±'
                    };
                    return labels[unitType] || unitType;
                },

                // v2.7: æŒ‰è¡€å‹åˆ†çµ„çš„åº«å­˜çµ±è¨ˆ (å«å³æœŸæ•¸)
                get groupedByBloodType() {
                    const bloodTypes = ['O+', 'O-', 'A+', 'A-', 'B+', 'B-', 'AB+', 'AB-'];
                    return bloodTypes.map(bt => {
                        const items = this.availability.filter(a => a.blood_type === bt);
                        const total = items.reduce((sum, item) => sum + (item.available_count || 0), 0);
                        const expiring = items.reduce((sum, item) => sum + (item.expiring_soon_count || 0), 0);
                        return { blood_type: bt, total, expiring };
                    });
                },

                // v2.7: ç¸½åº«å­˜
                get totalUnits() {
                    return this.groupedByBloodType.reduce((sum, b) => sum + b.total, 0);
                },

                // v2.7: ç¸½å³æœŸ
                get totalExpiring() {
                    return this.groupedByBloodType.reduce((sum, b) => sum + b.expiring, 0);
                },

                // v2.7: Dashboard éæ¿¾å¾Œçš„ availability
                get filteredByDashboard() {
                    if (!this.dashboardFilter) return this.availability;
                    return this.availability.filter(a => a.blood_type === this.dashboardFilter);
                },

                // v2.7: é»æ“Šè¡€å‹å¡ç‰‡éæ¿¾
                filterByBloodType(bloodType) {
                    if (this.dashboardFilter === bloodType) {
                        this.dashboardFilter = '';  // å†æ¬¡é»æ“Šæ¸…é™¤éæ¿¾
                    } else {
                        this.dashboardFilter = bloodType;
                    }
                },

                // v2.7: è¡€å“é¡å‹å·¦å´é‚Šæ¡†é¡è‰² (8px)
                getUnitTypeBorderColorClass(unitType) {
                    const classes = {
                        'WB': 'border-red-900',
                        'PRBC': 'border-red-600',
                        'FFP': 'border-yellow-400',
                        'PLT': 'border-yellow-200',
                        'CRYO': 'border-cyan-400'
                    };
                    return classes[unitType] || 'border-gray-300';
                },

                // v2.8: è£œå°æ¨™ç±¤åŠŸèƒ½
                printUnitLabel(unitId) {
                    // é–‹å•Ÿæ¨™ç±¤åˆ—å°é é¢
                    window.open(`/api/blood/units/${unitId}/label`, '_blank');
                    this.showToast('æ­£åœ¨é–‹å•Ÿæ¨™ç±¤åˆ—å°...', 'info');
                },

                async receiveUnit() {
                    if (!this.receiveForm.blood_type || !this.receiveForm.expiry_date) {
                        this.showToast('è«‹å¡«å¯«å¿…è¦æ¬„ä½', 'error');
                        return;
                    }

                    try {
                        const res = await fetch('/api/blood/units', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(this.receiveForm)
                        });
                        const data = await res.json();

                        if (data.success) {
                            this.showToast('å…¥åº«æˆåŠŸ', 'success');
                            this.showReceiveModal = false;
                            this.receiveForm = { blood_type: 'O+', unit_type: 'WB', expiry_date: '', donation_id: '', source: 'blood_center', donor_name: '', donor_phone: '' };
                            await this.refresh();
                        } else {
                            this.showToast(data.detail || 'å…¥åº«å¤±æ•—', 'error');
                        }
                    } catch (e) {
                        this.showToast('ç¶²è·¯éŒ¯èª¤', 'error');
                    }
                },

                async issueUnit(unit) {
                    // æ•ˆæœŸé˜»æ“‹ (Layer 2: UI)
                    if (unit.display_status === 'EXPIRED') {
                        this.blockerMessage = `è¡€è¢‹ ${unit.id} å·²éæœŸ`;
                        this.showExpiryBlocker = true;
                        return;
                    }

                    if (!confirm(`ç¢ºå®šç™¼æ”¾è¡€è¢‹ ${unit.id}ï¼Ÿ`)) return;

                    try {
                        const res = await fetch(`/api/blood/units/${unit.id}/issue`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                order_id: 'MANUAL-' + Date.now(),
                                issuer_id: 'blood-pwa'
                            })
                        });

                        if (res.status === 403) {
                            const data = await res.json();
                            this.blockerMessage = data.detail;
                            this.showExpiryBlocker = true;
                            return;
                        }

                        const data = await res.json();
                        if (data.success) {
                            this.showToast('ç™¼è¡€æˆåŠŸ', 'success');
                            await this.refresh();
                        } else {
                            this.showToast(data.detail || 'ç™¼è¡€å¤±æ•—', 'error');
                        }
                    } catch (e) {
                        this.showToast('ç¶²è·¯éŒ¯èª¤', 'error');
                    }
                },

                async reserveUnit(unit) {
                    const orderId = prompt('è«‹è¼¸å…¥è¨‚å–®ç·¨è™Ÿ (Order ID):');
                    if (!orderId) return;

                    try {
                        const res = await fetch(`/api/blood/units/${unit.id}/reserve`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                order_id: orderId,
                                reserver_id: 'blood-pwa'
                            })
                        });
                        const data = await res.json();

                        if (res.status === 409) {
                            this.showToast('è¡€è¢‹å·²è¢«é ç´„', 'error');
                            return;
                        }

                        if (data.success) {
                            this.showToast('é ç´„æˆåŠŸ', 'success');
                            await this.refresh();
                        } else {
                            this.showToast(data.detail || 'é ç´„å¤±æ•—', 'error');
                        }
                    } catch (e) {
                        this.showToast('ç¶²è·¯éŒ¯èª¤', 'error');
                    }
                },

                async unreserveUnit(unit) {
                    if (!confirm(`ç¢ºå®šå–æ¶ˆè¡€è¢‹ ${unit.id} çš„é ç´„ï¼Ÿ`)) return;

                    try {
                        const res = await fetch(`/api/blood/units/${unit.id}/unreserve?actor=blood-pwa`, {
                            method: 'POST'
                        });
                        const data = await res.json();

                        if (data.success) {
                            this.showToast('å·²å–æ¶ˆé ç´„', 'success');
                            await this.refresh();
                        } else {
                            this.showToast(data.detail || 'å–æ¶ˆå¤±æ•—', 'error');
                        }
                    } catch (e) {
                        this.showToast('ç¶²è·¯éŒ¯èª¤', 'error');
                    }
                },

                async emergencyRelease() {
                    if (!this.emergencyForm.reason) {
                        this.showToast('è«‹å¡«å¯«ç·Šæ€¥åŸå› ', 'error');
                        return;
                    }

                    if (!confirm('ç¢ºå®šåŸ·è¡Œç·Šæ€¥ç™¼è¡€ï¼Ÿæ­¤æ“ä½œå°‡è¢«æœ€é«˜ç´šåˆ¥ç¨½æ ¸ã€‚')) return;

                    try {
                        const res = await fetch('/api/blood/emergency-release', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                ...this.emergencyForm,
                                requester_id: 'blood-pwa',
                                patient_id: this.issueFlow.patientId || null,
                                patient_location: this.issueFlow.patientLocation || null
                            })
                        });
                        const data = await res.json();

                        if (data.success) {
                            // v2.3: Show Location-First Success Modal
                            this.issueResult = {
                                location: this.issueFlow.patientLocation || null,
                                locationName: this.issueFlow.patientLocationName || '',
                                bloodInfo: `${this.emergencyForm.blood_type} x ${this.emergencyForm.quantity} å–®ä½ (ç·Šæ€¥ç™¼è¡€)`,
                                patientId: this.issueFlow.patientId || null,
                                triageLevel: this.issueFlow.patientTriageLevel,
                                unitIds: data.unit_ids || []
                            };
                            this.showIssueSuccess = true;

                            this.emergencyForm = { blood_type: 'O+', quantity: 1, reason: '' };
                            this.resetIssueFlow();
                            await this.refresh();
                        } else {
                            this.showToast(data.detail || 'ç™¼è¡€å¤±æ•—', 'error');
                        }
                    } catch (e) {
                        this.showToast('ç¶²è·¯éŒ¯èª¤', 'error');
                    }
                },

                showToast(message, type = 'info') {
                    this.toast = { show: true, message, type };
                    setTimeout(() => this.toast.show = false, 3000);
                },

                // v2.6: åˆ—å°è¡€è¢‹æ¨™ç±¤
                printBloodLabel() {
                    const { blood_type, unit_type, expiry_date, donation_id } = this.receiveForm;
                    if (!blood_type) {
                        this.showToast('è«‹é¸æ“‡è¡€å‹', 'error');
                        return;
                    }

                    const unitTypeLabels = {
                        'WB': 'å…¨è¡€ Whole Blood',
                        'PRBC': 'æ¿ƒç¸®ç´…è¡€çƒ PRBC',
                        'FFP': 'æ–°é®®å†·å‡è¡€æ¼¿ FFP',
                        'PLT': 'è¡€å°æ¿ PLT',
                        'CRYO': 'å†·å‡æ²‰æ¾±å“ CRYO'
                    };

                    const unitTypeColors = {
                        'WB': '#7f1d1d',
                        'PRBC': '#dc2626',
                        'FFP': '#d97706',
                        'PLT': '#eab308',
                        'CRYO': '#0891b2'
                    };

                    const printContent = `
                        <html>
                        <head>
                            <title>è¡€è¢‹æ¨™ç±¤</title>
                            <style>
                                @page { size: 60mm 40mm; margin: 2mm; }
                                body { font-family: sans-serif; margin: 0; padding: 5mm; }
                                .label { border: 2px solid ${unitTypeColors[unit_type] || '#333'}; padding: 3mm; }
                                .header { background: ${unitTypeColors[unit_type] || '#333'}; color: white; padding: 2mm; text-align: center; font-weight: bold; margin: -3mm -3mm 3mm -3mm; }
                                .blood-type { font-size: 24pt; font-weight: bold; text-align: center; margin: 2mm 0; }
                                .info { font-size: 10pt; margin: 1mm 0; }
                                .barcode { text-align: center; font-family: monospace; font-size: 12pt; margin-top: 2mm; }
                            </style>
                        </head>
                        <body>
                            <div class="label">
                                <div class="header">${unitTypeLabels[unit_type] || unit_type}</div>
                                <div class="blood-type">${blood_type}</div>
                                <div class="info"><b>æ•ˆæœŸ:</b> ${expiry_date || 'æœªè¨­å®š'}</div>
                                <div class="info"><b>æè¡€ç·¨è™Ÿ:</b> ${donation_id || '-'}</div>
                                <div class="info"><b>åˆ—å°æ™‚é–“:</b> ${new Date().toLocaleString('zh-TW')}</div>
                                <div class="barcode">${donation_id || 'BU-' + Date.now()}</div>
                            </div>
                        </body>
                        </html>
                    `;
                    const printWindow = window.open('', '_blank', 'width=400,height=300');
                    printWindow.document.write(printContent);
                    printWindow.document.close();
                    printWindow.print();
                },

                // ======================================================
                // v2.5 P4: Pending Orders Methods
                // ======================================================

                async loadPendingOrdersSummary() {
                    try {
                        const res = await fetch('/api/blood/pending-orders/summary');
                        const data = await res.json();
                        if (data.success) {
                            this.pendingOrdersSummary = {
                                pending_count: data.pending_count || 0,
                                overdue_count: data.overdue_count || 0,
                                oldest_overdue_hours: data.oldest_overdue_hours || 0
                            };
                        }
                    } catch (e) {
                        console.error('Failed to load pending orders summary:', e);
                    }
                },

                async loadPendingOrders() {
                    this.pendingOrdersLoading = true;
                    try {
                        const res = await fetch('/api/blood/pending-orders');
                        const data = await res.json();
                        if (data.success) {
                            this.pendingOrders = data.data || [];
                            // åŒæ™‚æ›´æ–°æ‘˜è¦
                            this.pendingOrdersSummary = {
                                pending_count: this.pendingOrders.length,
                                overdue_count: data.overdue_count || 0,
                                oldest_overdue_hours: 0
                            };
                        }
                    } catch (e) {
                        console.error('Failed to load pending orders:', e);
                        this.showToast('è¼‰å…¥å¾…è£œå–®å¤±æ•—', 'error');
                    }
                    this.pendingOrdersLoading = false;
                },

                openResolveModal(order) {
                    this.resolvingOrder = order;
                    this.resolveForm = {
                        order_id: '',
                        resolver_id: '',
                        notes: ''
                    };
                    this.showResolveModal = true;
                },

                async resolvePendingOrder() {
                    if (!this.resolveForm.order_id || !this.resolvingOrder) return;

                    try {
                        const res = await fetch(`/api/blood/pending-orders/${this.resolvingOrder.id}/resolve`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(this.resolveForm)
                        });
                        const data = await res.json();

                        if (data.success) {
                            this.showToast('è£œå–®å®Œæˆ', 'success');
                            this.showResolveModal = false;
                            this.resolvingOrder = null;
                            await this.loadPendingOrders();
                        } else {
                            this.showToast(data.detail || 'æ“ä½œå¤±æ•—', 'error');
                        }
                    } catch (e) {
                        this.showToast('ç¶²è·¯éŒ¯èª¤', 'error');
                    }
                },

                formatDateTime(isoString) {
                    if (!isoString) return '-';
                    const d = new Date(isoString);
                    return d.toLocaleString('zh-TW', {
                        month: 'numeric',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                },

                orderTypeLabel(type) {
                    const labels = {
                        'EMERGENCY_RELEASE': 'ç·Šæ€¥ç™¼è¡€',
                        'VERBAL_ORDER': 'å£é ­é†«å›‘',
                        'RAPID_ISSUE': 'å¿«é€Ÿç™¼è¡€'
                    };
                    return labels[type] || type;
                },

                // ======================================================
                // v2.3: Issue Flow Methods
                // ======================================================

                get canProcessIssue() {
                    const { tier, patientId, patientLocation, manualLocation, selectedUnits, bloodType, quantity, orderId, verbalOrderNote } = this.issueFlow;

                    // v2.6: åˆä½µä½ç½®ä¾†æº
                    const hasLocation = patientLocation || manualLocation;

                    // Tier 3: Only needs blood type (O+/O-) and reason
                    if (tier === 3) {
                        return bloodType && ['O+', 'O-'].includes(bloodType);
                    }

                    // Tier 1 & 2: Need either selected units or blood type + quantity
                    const hasBlood = selectedUnits.length > 0 || (bloodType && quantity > 0);
                    if (!hasBlood) return false;

                    // Tier 1: Need order ID and patient ID
                    if (tier === 1) {
                        return orderId && patientId;
                    }

                    // Tier 2: Need verbal order note and location (either from patient or manual)
                    if (tier === 2) {
                        return verbalOrderNote && (patientId || hasLocation);
                    }

                    return false;
                },

                // Query CIRS for patient location (v2.3 core feature)
                async lookupPatientLocation() {
                    if (!this.issueFlow.patientId) return;

                    this.issueFlow.patientWarning = '';
                    this.issueFlow.patientLocation = '';
                    this.issueFlow.patientLocationName = '';

                    try {
                        const res = await fetch(`${this.cirsHubUrl}/api/patients/${this.issueFlow.patientId}`);

                        if (!res.ok) {
                            // Demo fallback - simulate patient location
                            this.simulatePatientLocation();
                            return;
                        }

                        const patient = await res.json();

                        if (patient.current_bed) {
                            this.issueFlow.patientLocation = patient.current_bed.id;
                            this.issueFlow.patientLocationName = patient.current_bed.name || '';
                            this.issueFlow.patientLocationType = patient.current_bed.type || 'UNKNOWN';
                            this.issueFlow.patientTriageLevel = patient.triage_level;
                            this.showToast(`ç—…æ‚£ä½ç½®: ${patient.current_bed.id}`, 'success');
                        } else {
                            this.issueFlow.patientWarning = 'ç—…æ‚£å°šæœªåˆ†é…ä½ç½®';
                            // Suggest switching to Tier 3 if no location
                            if (this.issueFlow.tier !== 3) {
                                this.showToast('ç„¡ä½ç½®è³‡è¨Šï¼Œå»ºè­°ä½¿ç”¨ç·Šæ€¥æµç¨‹', 'info');
                            }
                        }
                    } catch (e) {
                        console.warn('[Blood] CIRS lookup failed, using simulation:', e);
                        this.simulatePatientLocation();
                    }
                },

                // Demo mode: Simulate patient location
                simulatePatientLocation() {
                    const locations = [
                        { id: 'RESUS-01', name: 'æ€¥æ•‘å€ 1åºŠ', type: 'RESUS', triage: 1 },
                        { id: 'RESUS-02', name: 'æ€¥æ•‘å€ 2åºŠ', type: 'RESUS', triage: 1 },
                        { id: 'ER-03', name: 'æ€¥è¨ºè§€å¯Ÿ 3åºŠ', type: 'ER', triage: 2 },
                        { id: 'ER-05', name: 'æ€¥è¨ºè§€å¯Ÿ 5åºŠ', type: 'ER', triage: 2 },
                        { id: 'ICU-01', name: 'åŠ è­·ç—…æˆ¿ 1åºŠ', type: 'ICU', triage: 1 },
                        { id: 'OR-2', name: 'æ‰‹è¡“å®¤ 2', type: 'OR', triage: 1 },
                        { id: 'WARD-305', name: 'æ™®é€šç—…æˆ¿ 305', type: 'INPATIENT', triage: 3 },
                        { id: null, name: null, type: null, triage: 2 } // No location case
                    ];

                    const loc = locations[Math.floor(Math.random() * locations.length)];

                    if (loc.id) {
                        this.issueFlow.patientLocation = loc.id;
                        this.issueFlow.patientLocationName = loc.name;
                        this.issueFlow.patientLocationType = loc.type;
                        this.issueFlow.patientTriageLevel = loc.triage;
                        this.showToast(`(Demo) ç—…æ‚£ä½ç½®: ${loc.id}`, 'success');
                    } else {
                        this.issueFlow.patientWarning = 'ç—…æ‚£å°šæœªåˆ†é…ä½ç½®';
                        this.issueFlow.patientTriageLevel = loc.triage;
                    }
                },

                // Process issue based on tier
                async processIssue() {
                    const { tier, patientId, patientLocation, patientLocationName, patientTriageLevel,
                            selectedUnits, bloodType, unitType, quantity, orderId, verbalOrderNote, manualLocation } = this.issueFlow;

                    // v2.6: å„ªå…ˆä½¿ç”¨ç—…æ‚£ä½ç½®ï¼Œå¦å‰‡ä½¿ç”¨æ‰‹å‹•è¼¸å…¥ä½ç½®
                    const finalLocation = patientLocation || manualLocation;

                    // Tier 3 goes to Emergency Release
                    if (tier === 3) {
                        this.emergencyForm.blood_type = bloodType;
                        this.emergencyForm.quantity = quantity || 1;
                        this.emergencyForm.reason = verbalOrderNote || 'ç·Šæ€¥éœ€æ±‚';
                        await this.emergencyRelease();
                        return;
                    }

                    // Tier 1 & 2: Issue blood with location
                    let issuedUnits = [];
                    const issueOrderId = tier === 1 ? orderId : `VERBAL-${Date.now()}`;

                    try {
                        if (selectedUnits.length > 0) {
                            // Issue selected units
                            for (const unit of selectedUnits) {
                                const res = await fetch(`/api/blood/units/${unit.id}/issue`, {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({
                                        order_id: issueOrderId,
                                        issuer_id: 'blood-pwa',
                                        patient_id: patientId,
                                        patient_location: finalLocation,  // v2.6: ä½¿ç”¨åˆä½µçš„ä½ç½®
                                        is_verbal_order: tier === 2,
                                        verbal_order_note: tier === 2 ? verbalOrderNote : null
                                    })
                                });

                                if (res.ok) {
                                    issuedUnits.push(unit);
                                }
                            }
                        } else if (bloodType && quantity > 0) {
                            // v2.6: Auto-select units by blood type AND unit type (FIFO)
                            let apiUrl = `/api/blood/units?blood_type=${bloodType}&status=AVAILABLE`;
                            if (unitType) {
                                apiUrl += `&unit_type=${unitType}`;
                            }
                            const unitsRes = await fetch(apiUrl);
                            const unitsData = await unitsRes.json();

                            if (unitsData.success && unitsData.data) {
                                const availableUnits = unitsData.data
                                    .filter(u => u.display_status !== 'EXPIRED')
                                    .slice(0, quantity);

                                for (const unit of availableUnits) {
                                    const res = await fetch(`/api/blood/units/${unit.id}/issue`, {
                                        method: 'POST',
                                        headers: { 'Content-Type': 'application/json' },
                                        body: JSON.stringify({
                                            order_id: issueOrderId,
                                            issuer_id: 'blood-pwa',
                                            patient_id: patientId,
                                            patient_location: finalLocation,  // v2.6: ä½¿ç”¨åˆä½µçš„ä½ç½®
                                            is_verbal_order: tier === 2,
                                            verbal_order_note: tier === 2 ? verbalOrderNote : null
                                        })
                                    });

                                    if (res.ok) {
                                        issuedUnits.push(unit);
                                    }
                                }
                            }
                        }

                        if (issuedUnits.length > 0) {
                            // Show success modal with Location-First Display
                            const unitTypeLabel = unitType ? this.getUnitTypeLabel(unitType) : '';
                            this.issueResult = {
                                location: finalLocation,  // v2.6: ä½¿ç”¨åˆä½µçš„ä½ç½®
                                locationName: patientLocationName || (manualLocation ? 'æ‰‹å‹•è¼¸å…¥' : ''),
                                bloodInfo: `${bloodType || issuedUnits[0].blood_type} ${unitTypeLabel} x ${issuedUnits.length} å–®ä½`,
                                patientId: patientId,
                                triageLevel: patientTriageLevel,
                                unitIds: issuedUnits.map(u => u.id)
                            };
                            this.showIssueSuccess = true;
                            await this.refresh();

                            // Reset form
                            this.resetIssueFlow();
                        } else {
                            this.showToast('ç™¼è¡€å¤±æ•—ï¼Œè«‹æª¢æŸ¥åº«å­˜', 'error');
                        }
                    } catch (e) {
                        console.error('Issue failed:', e);
                        this.showToast('ç™¼è¡€å¤±æ•—', 'error');
                    }
                },

                resetIssueFlow() {
                    this.issueFlow = {
                        tier: 1,
                        patientId: '',
                        patientLocation: '',
                        patientLocationName: '',
                        patientLocationType: '',
                        patientWarning: '',
                        patientTriageLevel: null,
                        manualLocation: '',  // v2.6
                        bloodType: '',
                        unitType: '',  // v2.6
                        quantity: 1,
                        selectedUnits: [],
                        orderId: '',
                        verbalOrderNote: ''
                    };
                },

                closeIssueSuccess() {
                    this.showIssueSuccess = false;
                    this.issueResult = {
                        location: '',
                        locationName: '',
                        bloodInfo: '',
                        patientId: '',
                        triageLevel: null,
                        unitIds: []
                    };
                },

                printDeliverySlip() {
                    const { location, locationName, bloodInfo, patientId, unitIds } = this.issueResult;
                    const printContent = `
                        <html>
                        <head>
                            <title>Blood Delivery Slip</title>
                            <style>
                                body { font-family: sans-serif; padding: 20px; }
                                .header { text-align: center; font-size: 24px; font-weight: bold; margin-bottom: 20px; }
                                .location { background: #166534; color: white; padding: 30px; text-align: center; font-size: 36px; font-weight: bold; margin: 20px 0; }
                                .info { font-size: 18px; margin: 10px 0; }
                                .units { font-size: 12px; color: #666; margin-top: 20px; }
                            </style>
                        </head>
                        <body>
                            <div class="header">MIRS Blood Bank - æ´¾é€å–®</div>
                            <div class="location">${location || 'ç„¡ä½ç½®'}<br><small>${locationName || ''}</small></div>
                            <div class="info"><b>è¡€å“:</b> ${bloodInfo}</div>
                            <div class="info"><b>ç—…æ‚£:</b> ${patientId || 'æœªæŒ‡å®š'}</div>
                            <div class="info"><b>æ™‚é–“:</b> ${new Date().toLocaleString('zh-TW')}</div>
                            <div class="units"><b>è¡€è¢‹ ID:</b> ${unitIds.join(', ')}</div>
                        </body>
                        </html>
                    `;
                    const printWindow = window.open('', '_blank');
                    printWindow.document.write(printContent);
                    printWindow.document.close();
                    printWindow.print();
                },

                // ======================================================
                // Barcode Scanner Methods
                // ======================================================

                async scanPatientQR() {
                    this.scannerMode = 'patient';
                    await this.openScanner();
                },

                async scanBloodUnit() {
                    this.scannerMode = 'blood';
                    await this.openScanner();
                },

                async openScanner() {
                    this.showScanner = true;
                    try {
                        const video = document.getElementById('scanner-video');
                        this.scannerStream = await navigator.mediaDevices.getUserMedia({
                            video: { facingMode: 'environment' }
                        });
                        video.srcObject = this.scannerStream;
                        await video.play();

                        // TODO: Integrate barcode scanning library (e.g., ZXing, QuaggaJS)
                        // For now, show manual input option
                        this.showToast('æƒæåŠŸèƒ½é–‹ç™¼ä¸­ï¼Œè«‹ä½¿ç”¨æ‰‹å‹•è¼¸å…¥', 'info');
                    } catch (e) {
                        console.error('Camera access failed:', e);
                        this.showToast('ç„¡æ³•å­˜å–ç›¸æ©Ÿ', 'error');
                        this.closeScanner();
                    }
                },

                closeScanner() {
                    this.showScanner = false;
                    if (this.scannerStream) {
                        this.scannerStream.getTracks().forEach(track => track.stop());
                        this.scannerStream = null;
                    }
                },

                manualInput() {
                    this.closeScanner();
                    if (this.scannerMode === 'patient') {
                        const id = prompt('è«‹è¼¸å…¥ç—…æ‚£ ID (P-XXXX):');
                        if (id) {
                            this.issueFlow.patientId = id;
                            this.lookupPatientLocation();
                        }
                    } else {
                        const id = prompt('è«‹è¼¸å…¥è¡€è¢‹ ID (BU-XXXX):');
                        if (id) {
                            // Find unit in loaded units
                            const unit = this.units.find(u => u.id === id);
                            if (unit) {
                                if (unit.display_status === 'EXPIRED') {
                                    this.blockerMessage = `è¡€è¢‹ ${id} å·²éæœŸ`;
                                    this.showExpiryBlocker = true;
                                } else if (!this.issueFlow.selectedUnits.find(u => u.id === id)) {
                                    this.issueFlow.selectedUnits.push(unit);
                                    this.showToast(`å·²æ·»åŠ  ${id}`, 'success');
                                }
                            } else {
                                this.showToast('æ‰¾ä¸åˆ°æ­¤è¡€è¢‹', 'error');
                            }
                        }
                    }
                }
            };
        }
    </script>

    <!-- v2.7: Emergency Release FAB (Floating Action Button) - The Panic Button -->
    <div x-data="{ showEmergencyConfirm: false }" class="fixed bottom-20 right-4 z-40">
        <!-- FAB Button -->
        <button @click="showEmergencyConfirm = true"
                class="bg-red-600 hover:bg-red-700 text-white rounded-full p-4 shadow-2xl
                       flex items-center gap-2 animate-pulse-slow
                       border-4 border-red-300">
            <span class="text-2xl">ğŸš¨</span>
            <span class="font-bold text-sm hidden sm:inline">ç·Šæ€¥é ˜è¡€</span>
        </button>

        <!-- Emergency Confirm Modal -->
        <div x-show="showEmergencyConfirm" x-cloak
             class="fixed inset-0 bg-black bg-opacity-75 z-50 flex items-center justify-center p-4"
             @click.self="showEmergencyConfirm = false">
            <div class="bg-white rounded-xl max-w-sm w-full overflow-hidden shadow-2xl">
                <!-- Header - Blinking Red -->
                <div class="bg-red-600 text-white p-4 text-center animate-pulse">
                    <div class="text-3xl mb-2">ğŸš¨</div>
                    <h3 class="text-xl font-bold">ç·Šæ€¥é ˜è¡€ Emergency Release</h3>
                    <p class="text-sm text-red-200 mt-1">åƒ…é™ O å‹è¡€ (è¬èƒ½ä¾›è¡€)</p>
                </div>

                <!-- Quick Actions -->
                <div class="p-4 space-y-3">
                    <p class="text-gray-600 text-sm text-center mb-4">
                        ç·Šæ€¥ç™¼è¡€å°‡è·³éæ­£å¸¸æµç¨‹ï¼Œäº‹å¾Œéœ€è£œé–‹é†«å›‘
                    </p>

                    <!-- O+ Button -->
                    <button @click="$dispatch('emergency-release', { bloodType: 'O+' }); showEmergencyConfirm = false"
                            class="w-full bg-red-900 hover:bg-red-800 text-white py-4 rounded-lg font-bold text-xl flex items-center justify-center gap-3">
                        <span class="text-3xl">O+</span>
                        <span>ç·Šæ€¥ç™¼è¡€</span>
                    </button>

                    <!-- O- Button (More Universal) -->
                    <button @click="$dispatch('emergency-release', { bloodType: 'O-' }); showEmergencyConfirm = false"
                            class="w-full bg-red-700 hover:bg-red-600 text-white py-4 rounded-lg font-bold text-xl flex items-center justify-center gap-3 border-2 border-yellow-400">
                        <span class="text-3xl">O-</span>
                        <span>è¬èƒ½è¡€å‹</span>
                        <span class="text-xs bg-yellow-400 text-red-900 px-2 py-0.5 rounded">æ¨è–¦</span>
                    </button>

                    <!-- Cancel -->
                    <button @click="showEmergencyConfirm = false"
                            class="w-full bg-gray-200 text-gray-700 py-3 rounded-lg font-medium">
                        å–æ¶ˆ
                    </button>
                </div>
            </div>
        </div>
    </div>

    <style>
        /* v2.7: Slow pulse animation for Emergency FAB */
        @keyframes pulse-slow {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.9; transform: scale(1.05); }
        }
        .animate-pulse-slow {
            animation: pulse-slow 2s ease-in-out infinite;
        }
    </style>
</body>
</html>
