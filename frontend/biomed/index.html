<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>BioMed - 設備維護</title>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icons/icon-192.png">
    <link rel="stylesheet" href="/static/css/tailwind.min.css">
    <link rel="stylesheet" href="/static/css/mirs-colors.css">
    <script defer src="/static/js/alpine.min.js"></script>
    <style>
        [x-cloak] { display: none !important; }
        body {
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
            background: linear-gradient(135deg, #f5f6f4 0%, #e8eae5 50%, #f5f5f5 100%);
            background-attachment: fixed;
        }
        @keyframes pulse-warning {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .pulse-warning { animation: pulse-warning 1.5s infinite; }
    </style>
</head>
<body class="min-h-screen" x-data="biomedApp()" x-init="init()">

    <!-- Header -->
    <header class="bg-equipment-500 text-white sticky top-0 z-50 shadow-lg px-4 py-3">
        <div class="flex items-center justify-between max-w-4xl mx-auto">
            <div class="flex items-center gap-3">
                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                </svg>
                <div>
                    <h1 class="text-lg font-bold">BioMed 設備維護</h1>
                    <p class="text-xs opacity-80">v1.1.4</p>
                </div>
            </div>
            <div class="flex items-center gap-2">
                <div class="w-2 h-2 rounded-full" :class="isOnline ? 'bg-green-400' : 'bg-red-400'"></div>
                <span class="text-xs" x-text="isOnline ? '線上' : '離線'"></span>
            </div>
        </div>
    </header>

    <!-- Offline Banner -->
    <div x-show="!isOnline" class="bg-amber-500 text-white text-center py-2 text-sm font-medium">
        離線模式 - 部分功能可能受限
    </div>

    <!-- Main Content -->
    <main class="max-w-4xl mx-auto px-4 py-4">

        <!-- Tab Navigation (MIRS Style) -->
        <div class="bg-white rounded-xl shadow mb-4">
            <div class="flex gap-2 p-2">
                <button @click="currentTab = 'equipment'"
                        :class="currentTab === 'equipment' ? 'bg-equipment-500 text-white font-semibold shadow-md' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'"
                        class="flex-1 py-3 px-4 rounded-lg transition-all duration-200 flex items-center justify-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                    </svg>
                    <span class="text-sm sm:text-base">設備管理</span>
                </button>
                <button @click="currentTab = 'resilience'"
                        :class="currentTab === 'resilience' ? 'bg-amber-500 text-white font-semibold shadow-md' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'"
                        class="flex-1 py-3 px-4 rounded-lg transition-all duration-200 flex items-center justify-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
                    </svg>
                    <span class="text-sm sm:text-base">韌性估算</span>
                </button>
            </div>
        </div>

        <!-- Equipment Tab -->
        <div x-show="currentTab === 'equipment'" x-cloak>
            <!-- Header with Actions -->
            <div class="bg-white rounded-xl shadow-lg p-4 mb-4">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                    <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                        <svg class="w-6 h-6 text-equipment-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                        </svg>
                        設備管理
                    </h2>
                    <div class="flex flex-wrap gap-2">
                        <button @click="showAddModal = true" class="bg-equipment-500 text-white px-4 py-2 rounded-lg hover:bg-equipment-600 transition-colors flex items-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                            </svg>
                            <span>新增設備</span>
                        </button>
                        <button @click="loadEquipment()" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors flex items-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                            </svg>
                            <span class="hidden sm:inline">重新載入</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Stats Bar -->
            <div class="grid grid-cols-3 gap-3 mb-4">
                <div class="bg-white rounded-lg p-3 shadow text-center">
                    <p class="text-2xl font-bold text-equipment-500" x-text="equipment.length"></p>
                    <p class="text-xs text-gray-500">總設備數</p>
                </div>
                <div class="bg-white rounded-lg p-3 shadow text-center">
                    <p class="text-2xl font-bold text-green-500" x-text="equipment.filter(e => e.status === 'NORMAL').length"></p>
                    <p class="text-xs text-gray-500">已確認</p>
                </div>
                <div class="bg-white rounded-lg p-3 shadow text-center">
                    <p class="text-2xl font-bold" :class="getPendingCount() > 0 ? 'text-amber-500 pulse-warning' : 'text-gray-400'" x-text="getPendingCount()"></p>
                    <p class="text-xs text-gray-500">待檢查</p>
                </div>
            </div>

            <!-- Auto Reset Info -->
            <div class="bg-equipment-50 border border-equipment-200 rounded-lg p-3 mb-4 flex items-center gap-2 text-sm">
                <svg class="w-5 h-5 text-equipment-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                <span class="text-gray-700">設備狀態將於每日 <strong class="text-equipment-600">07:00</strong> 自動重置為待檢查</span>
            </div>

            <!-- Power Supply Equipment -->
            <div class="bg-white rounded-xl shadow-lg mb-4 overflow-hidden">
                <div class="bg-equipment-900 text-white px-4 py-3 flex items-center justify-between">
                    <h3 class="font-semibold flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                        </svg>
                        供電設備
                        <span class="text-sm font-normal opacity-80" x-text="'(' + getPowerSupplyEquipment().length + ')'"></span>
                    </h3>
                    <span class="text-xs bg-amber-500 px-2 py-0.5 rounded">韌性關鍵</span>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead class="bg-gray-50 text-gray-600">
                            <tr>
                                <th class="px-3 py-2 text-left font-medium">編號</th>
                                <th class="px-3 py-2 text-left font-medium">名稱</th>
                                <th class="px-3 py-2 text-center font-medium">數量</th>
                                <th class="px-3 py-2 text-center font-medium">存量</th>
                                <th class="px-3 py-2 text-center font-medium">狀態</th>
                                <th class="px-3 py-2 text-center font-medium">操作</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-100">
                            <template x-for="eq in getPowerSupplyEquipment()" :key="eq.id">
                                <tr class="hover:bg-gray-50" :class="{ 'bg-green-50': eq.status === 'NORMAL', 'bg-yellow-50': eq.status === 'WARNING', 'bg-red-50': eq.status === 'ERROR' }">
                                    <td class="px-3 py-2 font-mono text-xs text-gray-500" x-text="eq.id"></td>
                                    <td class="px-3 py-2 font-medium text-gray-900" x-text="eq.name"></td>
                                    <td class="px-3 py-2 text-center font-semibold" x-text="eq.quantity || eq.unit_count || 1"></td>
                                    <td class="px-3 py-2 text-center">
                                        <template x-if="eq.power_level !== null && eq.power_level !== undefined">
                                            <span class="font-medium" :class="{ 'text-green-600': eq.power_level >= 60, 'text-yellow-600': eq.power_level >= 30 && eq.power_level < 60, 'text-red-600': eq.power_level < 30 }" x-text="eq.power_level + '%'"></span>
                                        </template>
                                        <span x-show="eq.power_level === null || eq.power_level === undefined" class="text-gray-400">-</span>
                                    </td>
                                    <td class="px-3 py-2 text-center">
                                        <span :class="{ 'bg-green-100 text-green-800': eq.status === 'NORMAL', 'bg-yellow-100 text-yellow-800': eq.status === 'WARNING', 'bg-red-100 text-red-800': eq.status === 'ERROR', 'bg-gray-100 text-gray-800': eq.status === 'UNCHECKED' || eq.status === 'PENDING' }" class="px-2 py-0.5 text-xs font-medium rounded-full" x-text="getStatusText(eq.status)"></span>
                                    </td>
                                    <td class="px-3 py-2 text-center">
                                        <div class="flex gap-1 justify-center">
                                            <button @click="openUnitManageModal(eq)" class="text-equipment-600 hover:text-equipment-800 text-xs font-medium px-2 py-1 bg-equipment-100 rounded" title="確認/管理">✓</button>
                                            <button @click="editEquipment(eq)" class="text-gray-600 hover:text-gray-800 text-xs font-medium px-2 py-1 bg-gray-100 rounded" title="編輯">✎</button>
                                            <button @click="deleteEquipment(eq)" class="text-red-600 hover:text-red-800 text-xs font-medium px-2 py-1 bg-red-50 rounded" title="刪除">✕</button>
                                        </div>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                    <div x-show="getPowerSupplyEquipment().length === 0" class="text-center text-gray-400 py-8">目前沒有供電設備</div>
                </div>
            </div>

            <!-- Power Consuming Equipment -->
            <div class="bg-white rounded-xl shadow-lg mb-4 overflow-hidden">
                <div class="bg-equipment-700 text-white px-4 py-3">
                    <h3 class="font-semibold flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z"/>
                        </svg>
                        耗電設備
                        <span class="text-sm font-normal opacity-80" x-text="'(' + getPowerConsumingEquipment().length + ')'"></span>
                    </h3>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead class="bg-gray-50 text-gray-600">
                            <tr>
                                <th class="px-3 py-2 text-left font-medium">編號</th>
                                <th class="px-3 py-2 text-left font-medium">名稱</th>
                                <th class="px-3 py-2 text-left font-medium hidden sm:table-cell">類別</th>
                                <th class="px-3 py-2 text-center font-medium">數量</th>
                                <th class="px-3 py-2 text-center font-medium">狀態</th>
                                <th class="px-3 py-2 text-center font-medium">操作</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-100">
                            <template x-for="eq in getPowerConsumingEquipment()" :key="eq.id">
                                <tr class="hover:bg-gray-50" :class="{ 'bg-green-50': eq.status === 'NORMAL', 'bg-yellow-50': eq.status === 'WARNING', 'bg-red-50': eq.status === 'ERROR' }">
                                    <td class="px-3 py-2 font-mono text-xs text-gray-500" x-text="eq.id"></td>
                                    <td class="px-3 py-2 font-medium text-gray-900" x-text="eq.name"></td>
                                    <td class="px-3 py-2 text-gray-600 hidden sm:table-cell" x-text="eq.category || '-'"></td>
                                    <td class="px-3 py-2 text-center font-semibold" x-text="eq.quantity || eq.unit_count || 1"></td>
                                    <td class="px-3 py-2 text-center">
                                        <span :class="{ 'bg-green-100 text-green-800': eq.status === 'NORMAL', 'bg-yellow-100 text-yellow-800': eq.status === 'WARNING', 'bg-red-100 text-red-800': eq.status === 'ERROR', 'bg-gray-100 text-gray-800': eq.status === 'UNCHECKED' || eq.status === 'PENDING' }" class="px-2 py-0.5 text-xs font-medium rounded-full" x-text="getStatusText(eq.status)"></span>
                                    </td>
                                    <td class="px-3 py-2 text-center">
                                        <div class="flex gap-1 justify-center">
                                            <button @click="openUnitManageModal(eq)" class="text-equipment-600 hover:text-equipment-800 text-xs font-medium px-2 py-1 bg-equipment-100 rounded" title="確認/管理">✓</button>
                                            <button @click="editEquipment(eq)" class="text-gray-600 hover:text-gray-800 text-xs font-medium px-2 py-1 bg-gray-100 rounded" title="編輯">✎</button>
                                            <button @click="deleteEquipment(eq)" class="text-red-600 hover:text-red-800 text-xs font-medium px-2 py-1 bg-red-50 rounded" title="刪除">✕</button>
                                        </div>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                    <div x-show="getPowerConsumingEquipment().length === 0" class="text-center text-gray-400 py-8">目前沒有耗電設備</div>
                </div>
            </div>

            <!-- Other Equipment -->
            <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                <div class="bg-equipment-600 text-white px-4 py-3">
                    <h3 class="font-semibold flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
                        </svg>
                        其他設備
                        <span class="text-sm font-normal opacity-80" x-text="'(' + getNonElectricEquipment().length + ')'"></span>
                    </h3>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead class="bg-gray-50 text-gray-600">
                            <tr>
                                <th class="px-3 py-2 text-left font-medium">編號</th>
                                <th class="px-3 py-2 text-left font-medium">名稱</th>
                                <th class="px-3 py-2 text-center font-medium">數量</th>
                                <th class="px-3 py-2 text-center font-medium">狀態</th>
                                <th class="px-3 py-2 text-center font-medium">操作</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-100">
                            <template x-for="eq in getNonElectricEquipment()" :key="eq.id">
                                <tr class="hover:bg-gray-50" :class="{ 'bg-green-50': eq.status === 'NORMAL', 'bg-yellow-50': eq.status === 'WARNING', 'bg-red-50': eq.status === 'ERROR' }">
                                    <td class="px-3 py-2 font-mono text-xs text-gray-500" x-text="eq.id"></td>
                                    <td class="px-3 py-2 font-medium text-gray-900" x-text="eq.name"></td>
                                    <td class="px-3 py-2 text-center font-semibold" x-text="eq.quantity || eq.unit_count || 1"></td>
                                    <td class="px-3 py-2 text-center">
                                        <span :class="{ 'bg-green-100 text-green-800': eq.status === 'NORMAL', 'bg-yellow-100 text-yellow-800': eq.status === 'WARNING', 'bg-red-100 text-red-800': eq.status === 'ERROR', 'bg-gray-100 text-gray-800': eq.status === 'UNCHECKED' || eq.status === 'PENDING' }" class="px-2 py-0.5 text-xs font-medium rounded-full" x-text="getStatusText(eq.status)"></span>
                                    </td>
                                    <td class="px-3 py-2 text-center">
                                        <div class="flex gap-1 justify-center">
                                            <button @click="openUnitManageModal(eq)" class="text-equipment-600 hover:text-equipment-800 text-xs font-medium px-2 py-1 bg-equipment-100 rounded" title="確認/管理">✓</button>
                                            <button @click="editEquipment(eq)" class="text-gray-600 hover:text-gray-800 text-xs font-medium px-2 py-1 bg-gray-100 rounded" title="編輯">✎</button>
                                            <button @click="deleteEquipment(eq)" class="text-red-600 hover:text-red-800 text-xs font-medium px-2 py-1 bg-red-50 rounded" title="刪除">✕</button>
                                        </div>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                    <div x-show="getNonElectricEquipment().length === 0" class="text-center text-gray-400 py-8">目前沒有其他設備</div>
                </div>
            </div>
        </div>

        <!-- Resilience Tab -->
        <div x-show="currentTab === 'resilience'" x-cloak>
            <div class="bg-white rounded-xl shadow-lg p-4 mb-4">
                <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2 mb-4">
                    <svg class="w-6 h-6 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
                    </svg>
                    韌性估算
                </h2>

                <!-- Overall Status -->
                <div class="bg-gradient-to-br from-amber-50 to-amber-100 rounded-xl p-6 mb-4 text-center">
                    <h3 class="text-lg font-semibold text-gray-700 mb-2">可獨立運作</h3>
                    <div class="text-5xl font-bold mb-2"
                         :class="{
                             'text-red-500': resilienceStatus.summary?.overall_status === 'CRITICAL',
                             'text-amber-500': resilienceStatus.summary?.overall_status === 'WARNING',
                             'text-green-500': resilienceStatus.summary?.overall_status === 'SAFE',
                             'text-gray-400': !resilienceStatus.summary
                         }">
                        <span x-text="resilienceStatus.summary?.weakest_link?.hours?.toFixed(1) || '—'"></span>
                        <span class="text-2xl">小時</span>
                    </div>
                    <p class="text-sm text-gray-500" x-show="resilienceStatus.summary?.weakest_link">
                        瓶頸: <span class="font-medium" x-text="resilienceStatus.summary?.weakest_link?.resource"></span>
                    </p>
                    <button @click="loadResilienceStatus()"
                            class="mt-4 bg-amber-500 text-white px-6 py-2 rounded-lg hover:bg-amber-600 transition-colors inline-flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                        </svg>
                        重新計算
                    </button>
                </div>

                <!-- Resource Breakdown -->
                <div class="grid gap-4 sm:grid-cols-2">
                    <!-- Oxygen -->
                    <div class="bg-white border border-gray-200 rounded-xl p-4">
                        <div class="flex items-center justify-between mb-3">
                            <span class="font-medium text-gray-700 flex items-center gap-2">
                                <svg class="w-5 h-5 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/>
                                </svg>
                                氧氣供應
                            </span>
                            <span class="text-xl font-bold"
                                  :class="{
                                      'text-green-500': resilienceStatus.oxygen?.hours >= 24,
                                      'text-amber-500': resilienceStatus.oxygen?.hours >= 12 && resilienceStatus.oxygen?.hours < 24,
                                      'text-red-500': resilienceStatus.oxygen?.hours < 12
                                  }"
                                  x-text="(resilienceStatus.oxygen?.hours?.toFixed(1) || '—') + 'h'"></span>
                        </div>
                        <div class="h-3 bg-gray-200 rounded-full overflow-hidden mb-3">
                            <div class="h-full transition-all duration-500"
                                 :class="{
                                     'bg-green-500': resilienceStatus.oxygen?.hours >= 24,
                                     'bg-amber-500': resilienceStatus.oxygen?.hours >= 12 && resilienceStatus.oxygen?.hours < 24,
                                     'bg-red-500': resilienceStatus.oxygen?.hours < 12
                                 }"
                                 :style="'width: ' + Math.min((resilienceStatus.oxygen?.hours || 0) / 72 * 100, 100) + '%'"></div>
                        </div>
                        <!-- Oxygen Resources List -->
                        <div class="text-xs text-gray-500 space-y-1 border-t border-gray-100 pt-2" x-show="resilienceStatus.oxygenResources && resilienceStatus.oxygenResources.length > 0">
                            <template x-for="res in (resilienceStatus.oxygenResources || [])" :key="res.name">
                                <div class="flex justify-between">
                                    <span x-text="res.name + (res.quantity ? ' x' + res.quantity : '')"></span>
                                    <span class="text-gray-600" x-text="res.fill_pct ? res.fill_pct + '%' : (res.capacity_L ? res.capacity_L + 'L' : '')"></span>
                                </div>
                            </template>
                        </div>
                        <div class="text-xs text-gray-400 pt-2 border-t border-gray-100" x-show="!resilienceStatus.oxygenResources || resilienceStatus.oxygenResources.length === 0">
                            尚無氧氣設備資料
                        </div>
                    </div>

                    <!-- Power -->
                    <div class="bg-white border border-gray-200 rounded-xl p-4">
                        <div class="flex items-center justify-between mb-3">
                            <span class="font-medium text-gray-700 flex items-center gap-2">
                                <svg class="w-5 h-5 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                                </svg>
                                電力供應
                            </span>
                            <span class="text-xl font-bold"
                                  :class="{
                                      'text-green-500': resilienceStatus.power?.hours >= 24,
                                      'text-amber-500': resilienceStatus.power?.hours >= 12 && resilienceStatus.power?.hours < 24,
                                      'text-red-500': resilienceStatus.power?.hours < 12
                                  }"
                                  x-text="(resilienceStatus.power?.hours?.toFixed(1) || '—') + 'h'"></span>
                        </div>
                        <div class="h-3 bg-gray-200 rounded-full overflow-hidden mb-3">
                            <div class="h-full transition-all duration-500"
                                 :class="{
                                     'bg-green-500': resilienceStatus.power?.hours >= 24,
                                     'bg-amber-500': resilienceStatus.power?.hours >= 12 && resilienceStatus.power?.hours < 24,
                                     'bg-red-500': resilienceStatus.power?.hours < 12
                                 }"
                                 :style="'width: ' + Math.min((resilienceStatus.power?.hours || 0) / 72 * 100, 100) + '%'"></div>
                        </div>
                        <!-- Power Resources List -->
                        <div class="text-xs text-gray-500 space-y-1 border-t border-gray-100 pt-2" x-show="resilienceStatus.powerResources && resilienceStatus.powerResources.length > 0">
                            <template x-for="res in (resilienceStatus.powerResources || [])" :key="res.name">
                                <div class="flex justify-between">
                                    <span x-text="res.name + (res.quantity ? ' x' + res.quantity : '')"></span>
                                    <span class="text-gray-600" x-text="res.fuel_pct ? res.fuel_pct + '%' : (res.charge_pct ? res.charge_pct + '%' : '')"></span>
                                </div>
                            </template>
                        </div>
                        <div class="text-xs text-gray-400 pt-2 border-t border-gray-100" x-show="!resilienceStatus.powerResources || resilienceStatus.powerResources.length === 0">
                            尚無電力設備資料
                        </div>
                    </div>
                </div>
            </div>

            <!-- Formula Hint -->
            <div class="bg-gray-50 rounded-xl p-4 text-sm text-gray-600">
                <p class="font-medium mb-2">計算公式</p>
                <ul class="space-y-1 text-xs">
                    <li>氧氣時數 = 總容量 x 充填% / (10 L/min x 等效人數 x 60)</li>
                    <li>電力時數 = 油箱容量 x 剩餘% / 3.0 L/hr</li>
                    <li>可獨立運作 = MIN(氧氣, 電力)</li>
                </ul>
            </div>
        </div>
    </main>

    <!-- Add/Edit Equipment Modal -->
    <div x-show="showAddModal || showEditModal" x-cloak
         class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4"
         @click.self="showAddModal = false; showEditModal = false">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-md max-h-[90vh] overflow-y-auto">
            <div class="bg-equipment-500 text-white px-4 py-3 rounded-t-2xl flex items-center justify-between">
                <h3 class="font-semibold" x-text="showEditModal ? '編輯設備' : '新增設備'"></h3>
                <button @click="showAddModal = false; showEditModal = false" class="text-white hover:text-gray-200">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <div class="p-4 space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">設備編號</label>
                    <input type="text" x-model="equipmentForm.id" :disabled="showEditModal"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-equipment-500 disabled:bg-gray-100"
                           placeholder="例: RESP-001">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">設備名稱</label>
                    <input type="text" x-model="equipmentForm.name"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-equipment-500"
                           placeholder="例: H型氧氣鋼瓶">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">類別</label>
                    <select x-model="equipmentForm.category"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-equipment-500">
                        <option value="">選擇類別</option>
                        <option value="呼吸設備">呼吸設備</option>
                        <option value="電力設備">電力設備</option>
                        <option value="診斷設備">診斷設備</option>
                        <option value="急救設備">急救設備</option>
                        <option value="手術器械">手術器械</option>
                        <option value="一般設備">一般設備</option>
                    </select>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">數量</label>
                        <input type="number" x-model.number="equipmentForm.quantity" min="1"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-equipment-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">存量 %</label>
                        <input type="number" x-model.number="equipmentForm.power_level" min="0" max="100"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-equipment-500"
                               placeholder="僅供電設備">
                    </div>
                </div>
                <div class="flex gap-3 pt-4">
                    <button @click="showAddModal = false; showEditModal = false"
                            class="flex-1 bg-gray-200 text-gray-700 py-2 rounded-lg hover:bg-gray-300 transition-colors">
                        取消
                    </button>
                    <button @click="saveEquipment()"
                            class="flex-1 bg-equipment-500 text-white py-2 rounded-lg hover:bg-equipment-600 transition-colors">
                        儲存
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Unit Manage Modal -->
    <div x-show="showUnitManageModal" x-cloak
         class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-start justify-center overflow-y-auto py-4"
         @click.self="showUnitManageModal = false">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-lg mx-4 my-4 max-h-[90vh] overflow-y-auto">
            <div class="bg-equipment-500 text-white px-4 py-3 rounded-t-2xl flex items-center justify-between">
                <h3 class="font-semibold flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
                    </svg>
                    <span>單位管理 - </span>
                    <span x-text="unitManageForm.equipment_name"></span>
                </h3>
                <button @click="showUnitManageModal = false" class="text-white hover:text-gray-200">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>

            <!-- Loading -->
            <div x-show="unitManageForm.loading" class="text-center py-8">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-equipment-500 mx-auto"></div>
                <p class="text-gray-500 mt-2">載入中...</p>
            </div>

            <div x-show="!unitManageForm.loading" class="p-4 space-y-4">
                <!-- Quick Quantity Adjust -->
                <div class="bg-equipment-50 border border-equipment-200 rounded-lg p-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">快速數量調整</label>
                    <div class="flex items-center gap-3">
                        <button type="button" @click="unitManageForm.targetQuantity = Math.max(0, unitManageForm.targetQuantity - 1)"
                                class="w-10 h-10 rounded-full bg-gray-200 hover:bg-gray-300 flex items-center justify-center text-xl font-bold">
                            −
                        </button>
                        <input type="number" x-model="unitManageForm.targetQuantity" min="0"
                               class="w-20 text-center text-xl font-bold border-2 border-equipment-300 rounded-lg py-2">
                        <button type="button" @click="unitManageForm.targetQuantity++"
                                class="w-10 h-10 rounded-full bg-gray-200 hover:bg-gray-300 flex items-center justify-center text-xl font-bold">
                            +
                        </button>
                        <button type="button" @click="batchAdjustQuantity()"
                                :disabled="unitManageForm.targetQuantity === (unitManageForm.units || []).length"
                                :class="unitManageForm.targetQuantity === (unitManageForm.units || []).length ? 'bg-gray-300 cursor-not-allowed' : 'bg-equipment-500 hover:bg-equipment-600'"
                                class="px-4 py-2 text-white rounded-lg transition-colors">
                            套用
                        </button>
                    </div>
                    <p class="text-xs text-gray-500 mt-2">
                        目前: <span x-text="(unitManageForm.units || []).length"></span> 個單位
                        <span x-show="unitManageForm.targetQuantity !== (unitManageForm.units || []).length" class="text-equipment-600 font-medium">
                            → <span x-text="unitManageForm.targetQuantity"></span>
                        </span>
                    </p>
                </div>

                <!-- Current Units -->
                <div>
                    <h4 class="font-medium text-gray-700 mb-2">現有單位 (<span x-text="(unitManageForm.units || []).length"></span>)</h4>
                    <div class="space-y-2 max-h-48 overflow-y-auto">
                        <template x-for="(unit, idx) in (unitManageForm.units || [])" :key="unit.id">
                            <div class="bg-gray-50 rounded-lg p-3 border">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center gap-2">
                                        <!-- 確認狀態 -->
                                        <span class="w-6 h-6 rounded-full flex items-center justify-center text-xs"
                                              :class="unit.last_check ? 'bg-green-100 text-green-600' : 'bg-gray-200 text-gray-400'">
                                            <template x-if="unit.last_check">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                                </svg>
                                            </template>
                                            <template x-if="!unit.last_check">
                                                <span>?</span>
                                            </template>
                                        </span>
                                        <span class="font-medium" x-text="unit.unit_label || unit.unit_serial"></span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <!-- 電量/氧氣% 可編輯 -->
                                        <template x-if="!unit.editing">
                                            <button @click="unit.editing = true; unit.editLevel = unit.level_percent"
                                                    class="flex items-center gap-1 px-2 py-1 rounded bg-white border hover:bg-equipment-50">
                                                <span class="font-medium" :class="unit.level_percent >= 60 ? 'text-green-600' : unit.level_percent >= 30 ? 'text-yellow-600' : 'text-red-600'"
                                                      x-text="(unit.level_percent || 0) + '%'"></span>
                                                <svg class="w-3 h-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/>
                                                </svg>
                                            </button>
                                        </template>
                                        <template x-if="unit.editing">
                                            <div class="flex items-center gap-1">
                                                <input type="number" x-model="unit.editLevel" min="0" max="100"
                                                       class="w-16 px-2 py-1 text-center border border-equipment-400 rounded text-sm">
                                                <button @click="updateUnitLevel(unit)" class="text-green-600 hover:text-green-800 p-1">
                                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                                    </svg>
                                                </button>
                                                <button @click="unit.editing = false" class="text-gray-400 hover:text-gray-600 p-1">
                                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                                    </svg>
                                                </button>
                                            </div>
                                        </template>
                                        <!-- 狀態 -->
                                        <span class="text-xs px-2 py-1 rounded-full" :class="getUnitStatusClass(unit.status)" x-text="unit.status"></span>
                                        <!-- 確認按鈕 -->
                                        <button type="button" @click="checkUnit(unit)"
                                                :class="unit.last_check ? 'text-gray-400 bg-gray-100' : 'text-equipment-600 bg-equipment-100 hover:bg-equipment-200'"
                                                class="p-1.5 rounded" :title="unit.last_check ? '已確認' : '點擊確認'">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                            </svg>
                                        </button>
                                        <!-- 移除 -->
                                        <button type="button" @click="removeUnit(unit)"
                                                class="text-red-500 hover:text-red-700 p-1" title="移除">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                            </svg>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </template>
                        <div x-show="!unitManageForm.units || unitManageForm.units.length === 0" class="text-center text-gray-400 py-4">
                            目前沒有可用單位
                        </div>
                    </div>
                </div>

                <!-- Remove Reason -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">移除原因（可選）</label>
                    <input type="text" x-model="unitManageForm.removeReason" placeholder="例如：設備故障、送修"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                </div>

                <!-- Add Unit -->
                <div class="border-t pt-4">
                    <h4 class="font-medium text-gray-700 mb-2">新增單位</h4>
                    <div class="grid grid-cols-3 gap-3">
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">電量 %</label>
                            <input type="number" x-model="unitManageForm.addForm.level_percent" min="0" max="100"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">狀態</label>
                            <select x-model="unitManageForm.addForm.status"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                <option value="AVAILABLE">可用</option>
                                <option value="IN_USE">使用中</option>
                                <option value="CHARGING">充電中</option>
                                <option value="MAINTENANCE">維護中</option>
                            </select>
                        </div>
                        <div class="flex items-end">
                            <button type="button" @click="addUnit()"
                                    class="w-full bg-equipment-500 text-white px-4 py-2 rounded-lg hover:bg-equipment-600 transition-colors text-sm">
                                + 新增
                            </button>
                        </div>
                    </div>
                    <div class="mt-2">
                        <label class="block text-xs text-gray-500 mb-1">新增原因（可選）</label>
                        <input type="text" x-model="unitManageForm.addForm.reason" placeholder="例如：演習增援"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                    </div>
                </div>

                <!-- Removed Units -->
                <div class="border-t pt-4">
                    <button type="button" @click="unitManageForm.showInactive = !unitManageForm.showInactive"
                            class="flex items-center gap-2 text-gray-600 hover:text-gray-800">
                        <svg class="w-4 h-4 transition-transform" :class="unitManageForm.showInactive ? 'rotate-90' : ''" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                        </svg>
                        <span class="text-sm font-medium">已移除單位 (<span x-text="(unitManageForm.inactive_units || []).length"></span>)</span>
                    </button>
                    <div x-show="unitManageForm.showInactive" class="mt-2 space-y-2 max-h-32 overflow-y-auto">
                        <template x-for="unit in (unitManageForm.inactive_units || [])" :key="unit.id">
                            <div class="flex items-center justify-between bg-red-50 rounded-lg p-3 border border-red-200">
                                <div>
                                    <span class="font-medium text-gray-600 line-through" x-text="unit.unit_label || unit.unit_serial"></span>
                                    <span class="text-xs text-red-500 ml-2" x-text="unit.removal_reason || '已移除'"></span>
                                </div>
                                <button type="button" @click="restoreUnit(unit)"
                                        class="text-green-600 hover:text-green-800 px-3 py-1 text-sm bg-green-100 rounded-lg">
                                    恢復
                                </button>
                            </div>
                        </template>
                        <div x-show="!unitManageForm.inactive_units || unitManageForm.inactive_units.length === 0" class="text-center text-gray-400 py-2 text-sm">
                            沒有已移除的單位
                        </div>
                    </div>
                </div>

                <!-- Close Button -->
                <div class="flex justify-end pt-4 border-t">
                    <button type="button" @click="showUnitManageModal = false"
                            class="bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-600 transition-colors">
                        關閉
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div x-show="toast.show" x-transition
         class="fixed bottom-4 left-4 right-4 max-w-md mx-auto bg-gray-800 text-white px-4 py-3 rounded-lg shadow-lg z-50"
         :class="{
             'bg-green-600': toast.type === 'success',
             'bg-red-600': toast.type === 'error',
             'bg-amber-600': toast.type === 'warning'
         }">
        <p x-text="toast.message"></p>
    </div>

    <script>
        function biomedApp() {
            return {
                // State
                currentTab: 'equipment',
                isOnline: navigator.onLine,
                equipment: [],
                resilienceStatus: {},
                toast: { show: false, message: '', type: 'success' },
                showAddModal: false,
                showEditModal: false,
                showUnitManageModal: false,
                equipmentForm: {
                    id: '',
                    name: '',
                    category: '',
                    quantity: 1,
                    power_level: null
                },
                // v1.1.2: 設備單位管理表單
                unitManageForm: {
                    equipment_id: '',
                    equipment_name: '',
                    type_code: '',
                    unit_prefix: '',
                    units: [],
                    inactive_units: [],
                    loading: false,
                    showInactive: false,
                    addForm: {
                        level_percent: 100,
                        status: 'AVAILABLE',
                        reason: ''
                    },
                    removeReason: '',
                    targetQuantity: null
                },

                // Lifecycle
                async init() {
                    if ('serviceWorker' in navigator) {
                        try {
                            await navigator.serviceWorker.register('/biomed/service-worker.js');
                            console.log('[BioMed] Service Worker registered');
                        } catch (err) {
                            console.error('[BioMed] SW registration failed:', err);
                        }
                    }

                    window.addEventListener('online', () => {
                        this.isOnline = true;
                        this.loadEquipment();
                    });
                    window.addEventListener('offline', () => {
                        this.isOnline = false;
                    });

                    await this.loadEquipment();
                    await this.loadResilienceStatus();
                },

                // API Methods
                async loadEquipment() {
                    try {
                        const res = await fetch('/api/equipment');
                        if (res.ok) {
                            this.equipment = await res.json();
                        }
                    } catch (err) {
                        console.error('[BioMed] Failed to load equipment:', err);
                        this.showToast('無法載入設備資料', 'error');
                    }
                },

                async loadResilienceStatus() {
                    try {
                        const res = await fetch('/api/resilience/status');
                        if (res.ok) {
                            const data = await res.json();
                            console.log('[BioMed] Resilience API response:', data);

                            // v1.1.5: 正確解析 API 回傳結構
                            // API 回傳 lifelines 陣列，每個 lifeline 有 inventory.items
                            const oxygenLifelines = (data.lifelines || []).filter(l => l.type === 'OXYGEN');
                            const powerLifelines = (data.lifelines || []).filter(l => l.type === 'POWER');

                            // 計算總時數 (取最大值，因為有多種來源)
                            const oxygenHours = oxygenLifelines.reduce((max, l) => {
                                const h = l.endurance?.effective_hours;
                                return (typeof h === 'number' && h > max) ? h : max;
                            }, 0);
                            const powerHours = powerLifelines.reduce((max, l) => {
                                const h = l.endurance?.effective_hours;
                                return (typeof h === 'number' && h > max) ? h : max;
                            }, 0);

                            // 展平所有 lifelines 的 inventory.items 並映射欄位
                            const oxygenResources = oxygenLifelines.flatMap(l =>
                                (l.inventory?.items || []).map(item => ({
                                    name: item.name,
                                    quantity: item.qty,
                                    fill_pct: item.avg_level,
                                    capacity_L: item.capacity_each
                                }))
                            );

                            const powerResources = powerLifelines.flatMap(l =>
                                (l.inventory?.items || []).map(item => ({
                                    name: item.name,
                                    quantity: item.qty,
                                    // 電源站用 charge_pct，發電機用 fuel_pct
                                    charge_pct: item.device_type === 'POWER_STATION' ? item.avg_level : null,
                                    fuel_pct: item.device_type === 'GENERATOR' ? item.avg_level : null
                                }))
                            );

                            const weakestLifeline = (data.lifelines || []).reduce((min, ll) => {
                                const h = ll.endurance?.effective_hours;
                                if (typeof h !== 'number') return min;
                                if (!min || h < (min.endurance?.effective_hours || Infinity)) return ll;
                                return min;
                            }, null);

                            // v1.1.4: 使用 $nextTick 確保 Alpine 響應式更新
                            this.resilienceStatus = {};
                            await this.$nextTick();

                            this.resilienceStatus = {
                                summary: {
                                    overall_status: data.summary?.overall_status || 'UNKNOWN',
                                    weakest_link: weakestLifeline ? {
                                        hours: weakestLifeline.endurance?.effective_hours || 0,
                                        resource: weakestLifeline.name
                                    } : null
                                },
                                oxygen: { hours: oxygenHours },
                                power: { hours: powerHours },
                                oxygenResources: oxygenResources,
                                powerResources: powerResources
                            };

                            console.log('[BioMed] Parsed resilience:', {
                                oxygenResources: this.resilienceStatus.oxygenResources,
                                powerResources: this.resilienceStatus.powerResources
                            });
                        }
                    } catch (err) {
                        console.error('[BioMed] Failed to load resilience:', err);
                    }
                },

                async checkEquipment(eq) {
                    try {
                        const res = await fetch(`/api/equipment/check/${eq.id}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                stationId: 'HC-000000',
                                status: 'NORMAL',
                                powerLevel: eq.power_level || null,
                                remarks: null
                            })
                        });
                        if (res.ok) {
                            // 更新本地狀態
                            const idx = this.equipment.findIndex(e => e.id === eq.id);
                            if (idx !== -1) {
                                this.equipment[idx].status = 'NORMAL';
                                this.equipment[idx].last_checked = new Date().toISOString();
                            }
                            this.showToast(`${eq.name} 已確認`, 'success');
                            await this.loadResilienceStatus();
                        } else {
                            const err = await res.json();
                            this.showToast(err.detail || '確認失敗', 'error');
                        }
                    } catch (err) {
                        console.error('[BioMed] Failed to check equipment:', err);
                        this.showToast('確認失敗', 'error');
                    }
                },

                editEquipment(eq) {
                    this.equipmentForm = {
                        id: eq.id,
                        name: eq.name,
                        category: eq.category || '',
                        quantity: eq.quantity || eq.unit_count || 1,
                        power_level: eq.power_level
                    };
                    this.showEditModal = true;
                },

                async saveEquipment() {
                    if (!this.equipmentForm.id || !this.equipmentForm.name) {
                        this.showToast('請填寫必要欄位', 'warning');
                        return;
                    }

                    try {
                        const method = this.showEditModal ? 'PUT' : 'POST';
                        const url = this.showEditModal
                            ? `/api/equipment/${this.equipmentForm.id}`
                            : '/api/equipment';

                        const res = await fetch(url, {
                            method,
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(this.equipmentForm)
                        });

                        if (res.ok) {
                            this.showToast(this.showEditModal ? '設備已更新' : '設備已新增', 'success');
                            this.showAddModal = false;
                            this.showEditModal = false;
                            this.resetForm();
                            await this.loadEquipment();
                        } else {
                            const err = await res.json();
                            this.showToast(err.detail || '儲存失敗', 'error');
                        }
                    } catch (err) {
                        console.error('[BioMed] Failed to save equipment:', err);
                        this.showToast('儲存失敗', 'error');
                    }
                },

                async deleteEquipment(eq) {
                    if (!confirm(`確定要刪除 "${eq.name}" 嗎？`)) return;

                    try {
                        const res = await fetch(`/api/equipment/${eq.id}`, {
                            method: 'DELETE'
                        });

                        if (res.ok) {
                            this.showToast(`${eq.name} 已刪除`, 'success');
                            await this.loadEquipment();
                        } else {
                            this.showToast('刪除失敗', 'error');
                        }
                    } catch (err) {
                        console.error('[BioMed] Failed to delete equipment:', err);
                        this.showToast('刪除失敗', 'error');
                    }
                },

                resetForm() {
                    this.equipmentForm = {
                        id: '',
                        name: '',
                        category: '',
                        quantity: 1,
                        power_level: null
                    };
                },

                // Helpers
                getPowerSupplyEquipment() {
                    return this.equipment.filter(e =>
                        e.resilience_category === 'POWER' ||
                        e.category === 'power_supply' ||
                        e.category === '電力設備' ||
                        e.id?.startsWith('UTIL-') ||
                        e.name?.includes('發電機') ||
                        e.name?.includes('電池') ||
                        e.name?.includes('電源') ||
                        e.name?.includes('UPS')
                    );
                },

                getPowerConsumingEquipment() {
                    return this.equipment.filter(e =>
                        e.power_consumption > 0 ||
                        e.resilience_category === 'OXYGEN' ||
                        e.category === 'monitoring' ||
                        e.category === 'diagnostic' ||
                        e.category === '診斷設備' ||
                        e.category === '呼吸設備' ||
                        e.name?.includes('監視器') ||
                        e.name?.includes('呼吸器') ||
                        e.name?.includes('氧氣')
                    );
                },

                getNonElectricEquipment() {
                    const powerSupply = this.getPowerSupplyEquipment();
                    const powerConsuming = this.getPowerConsumingEquipment();
                    const excludeIds = new Set([
                        ...powerSupply.map(e => e.id),
                        ...powerConsuming.map(e => e.id)
                    ]);
                    return this.equipment.filter(e => !excludeIds.has(e.id));
                },

                getPendingCount() {
                    return this.equipment.filter(e =>
                        e.status === 'UNCHECKED' || e.status === 'PENDING' || e.check_status === 'NO_UNITS'
                    ).length;
                },

                getStatusText(status) {
                    const map = {
                        'NORMAL': '正常',
                        'WARNING': '注意',
                        'ERROR': '異常',
                        'UNCHECKED': '未檢',
                        'PENDING': '待確認',
                        'NO_UNITS': '無單位'
                    };
                    return map[status] || status || '未知';
                },

                showToast(message, type = 'success') {
                    this.toast = { show: true, message, type };
                    setTimeout(() => {
                        this.toast.show = false;
                    }, 3000);
                },

                // v1.1.2: 單位管理功能
                async openUnitManageModal(eq) {
                    this.unitManageForm.equipment_id = eq.id;
                    this.unitManageForm.equipment_name = eq.name;
                    this.unitManageForm.type_code = eq.type_code || '';
                    this.unitManageForm.loading = true;
                    this.unitManageForm.showInactive = false;
                    this.unitManageForm.units = [];
                    this.unitManageForm.inactive_units = [];
                    this.showUnitManageModal = true;

                    try {
                        const response = await fetch(`/api/v2/equipment/${eq.id}/units?include_inactive=true`);
                        if (response.ok) {
                            const data = await response.json();
                            this.unitManageForm.units = data.units || [];
                            this.unitManageForm.inactive_units = data.inactive_units || [];
                            this.unitManageForm.unit_prefix = data.unit_prefix;
                            this.unitManageForm.targetQuantity = data.active_count || 0;
                        } else {
                            this.showToast('載入單位列表失敗', 'error');
                        }
                    } catch (error) {
                        console.error('[BioMed] 載入設備單位失敗:', error);
                        this.showToast('載入設備單位失敗', 'error');
                    } finally {
                        this.unitManageForm.loading = false;
                    }
                },

                async addUnit() {
                    const equipmentId = this.unitManageForm.equipment_id;
                    const form = this.unitManageForm.addForm;

                    try {
                        const response = await fetch(`/api/v2/equipment/${equipmentId}/units`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                level_percent: parseInt(form.level_percent) || 100,
                                status: form.status || 'AVAILABLE',
                                reason: form.reason || null
                            })
                        });

                        const data = await response.json();

                        if (response.ok) {
                            this.showToast(data.message || '已新增單位', 'success');
                            this.unitManageForm.units.push(data.unit);
                            this.unitManageForm.targetQuantity = data.equipment_summary?.active_unit_count;
                            this.unitManageForm.addForm = { level_percent: 100, status: 'AVAILABLE', reason: '' };
                            await this.loadEquipment();
                            await this.loadResilienceStatus();
                        } else {
                            this.showToast(data.detail || '新增失敗', 'error');
                        }
                    } catch (error) {
                        console.error('[BioMed] 新增單位失敗:', error);
                        this.showToast('新增單位失敗', 'error');
                    }
                },

                async removeUnit(unit) {
                    const reason = this.unitManageForm.removeReason || '演習調整';

                    if (!confirm(`確定要移除「${unit.unit_label || unit.unit_serial}」？\n原因: ${reason}`)) {
                        return;
                    }

                    try {
                        const response = await fetch(`/api/v2/equipment/units/${unit.id}`, {
                            method: 'DELETE',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ reason: reason })
                        });

                        const data = await response.json();

                        if (response.ok) {
                            this.showToast(data.message || '已移除單位', 'success');
                            this.unitManageForm.units = this.unitManageForm.units.filter(u => u.id !== unit.id);
                            this.unitManageForm.inactive_units.unshift({
                                ...unit,
                                is_active: false,
                                removed_at: new Date().toISOString(),
                                removal_reason: reason
                            });
                            this.unitManageForm.targetQuantity = data.equipment_summary?.active_unit_count;
                            await this.loadEquipment();
                            await this.loadResilienceStatus();
                        } else {
                            this.showToast(data.detail || '移除失敗', 'error');
                        }
                    } catch (error) {
                        console.error('[BioMed] 移除單位失敗:', error);
                        this.showToast('移除單位失敗', 'error');
                    }
                },

                async restoreUnit(unit) {
                    if (!confirm(`確定要恢復「${unit.unit_label || unit.unit_serial}」？`)) {
                        return;
                    }

                    try {
                        const response = await fetch(`/api/v2/equipment/units/${unit.id}/restore`, {
                            method: 'POST'
                        });

                        const data = await response.json();

                        if (response.ok) {
                            this.showToast(data.message || '已恢復單位', 'success');
                            this.unitManageForm.inactive_units = this.unitManageForm.inactive_units.filter(u => u.id !== unit.id);
                            this.unitManageForm.units.push({
                                ...unit,
                                is_active: true,
                                removed_at: null,
                                removal_reason: null
                            });
                            this.unitManageForm.targetQuantity = data.equipment_summary?.active_unit_count;
                            await this.loadEquipment();
                            await this.loadResilienceStatus();
                        } else {
                            this.showToast(data.detail || '恢復失敗', 'error');
                        }
                    } catch (error) {
                        console.error('[BioMed] 恢復單位失敗:', error);
                        this.showToast('恢復單位失敗', 'error');
                    }
                },

                async batchAdjustQuantity() {
                    const equipmentId = this.unitManageForm.equipment_id;
                    const target = parseInt(this.unitManageForm.targetQuantity);
                    const current = (this.unitManageForm.units || []).length;

                    if (target === current) {
                        this.showToast('數量未變更', 'warning');
                        return;
                    }

                    const action = target > current ? '新增' : '移除';
                    const diff = Math.abs(target - current);

                    if (!confirm(`確定要${action} ${diff} 個單位？\n(${current} → ${target})`)) {
                        return;
                    }

                    try {
                        const response = await fetch(`/api/v2/equipment/${equipmentId}/quantity`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                target_quantity: target,
                                reason: '批次數量調整'
                            })
                        });

                        const data = await response.json();

                        if (response.ok) {
                            this.showToast(data.message || '調整完成', 'success');
                            await this.openUnitManageModal({
                                id: equipmentId,
                                name: this.unitManageForm.equipment_name,
                                type_code: this.unitManageForm.type_code
                            });
                            await this.loadEquipment();
                            await this.loadResilienceStatus();
                        } else {
                            this.showToast(data.detail || '調整失敗', 'error');
                        }
                    } catch (error) {
                        console.error('[BioMed] 批次調整失敗:', error);
                        this.showToast('批次調整失敗', 'error');
                    }
                },

                getUnitStatusClass(status) {
                    const classes = {
                        'AVAILABLE': 'bg-green-100 text-green-800',
                        'IN_USE': 'bg-blue-100 text-blue-800',
                        'CHARGING': 'bg-yellow-100 text-yellow-800',
                        'MAINTENANCE': 'bg-gray-100 text-gray-800',
                        'EMPTY': 'bg-red-100 text-red-800'
                    };
                    return classes[status] || 'bg-gray-100 text-gray-800';
                },

                // v1.1.4: 更新單位電量/氧氣%
                async updateUnitLevel(unit) {
                    const newLevel = parseInt(unit.editLevel) || 0;
                    try {
                        const response = await fetch(`/api/v2/equipment/units/${unit.id}/check`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                level_percent: newLevel,
                                status: unit.status || 'AVAILABLE'
                            })
                        });

                        if (response.ok) {
                            unit.level_percent = newLevel;
                            unit.last_check = new Date().toISOString();
                            unit.editing = false;
                            this.showToast(`已更新電量至 ${newLevel}%`, 'success');
                            await this.loadEquipment();
                            await this.loadResilienceStatus();
                        } else {
                            const err = await response.json();
                            this.showToast(err.detail || '更新失敗', 'error');
                        }
                    } catch (error) {
                        console.error('[BioMed] 更新單位電量失敗:', error);
                        this.showToast('更新失敗', 'error');
                    }
                },

                // v1.1.4: 確認單一單位
                async checkUnit(unit) {
                    try {
                        const response = await fetch(`/api/v2/equipment/units/${unit.id}/check`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                level_percent: unit.level_percent || 100,
                                status: unit.status || 'AVAILABLE'
                            })
                        });

                        if (response.ok) {
                            unit.last_check = new Date().toISOString();
                            this.showToast(`${unit.unit_label || unit.unit_serial} 已確認`, 'success');
                            await this.loadEquipment();
                            await this.loadResilienceStatus();
                        } else {
                            const err = await response.json();
                            this.showToast(err.detail || '確認失敗', 'error');
                        }
                    } catch (error) {
                        console.error('[BioMed] 確認單位失敗:', error);
                        this.showToast('確認失敗', 'error');
                    }
                }
            };
        }
    </script>
</body>
</html>
