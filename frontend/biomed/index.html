<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>BioMed - 設備維護</title>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icons/icon-192.png">
    <link rel="stylesheet" href="/static/css/tailwind.min.css">
    <link rel="stylesheet" href="/static/css/mirs-colors.css">
    <script defer src="/static/js/alpine.min.js"></script>
    <style>
        [x-cloak] { display: none !important; }
        body {
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
            background: linear-gradient(135deg, #f5f6f4 0%, #e8eae5 50%, #f5f5f5 100%);
            background-attachment: fixed;
        }
        @keyframes pulse-warning {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .pulse-warning { animation: pulse-warning 1.5s infinite; }
    </style>
</head>
<body class="min-h-screen" x-data="biomedApp()" x-init="init()">

    <!-- Header -->
    <header class="bg-equipment-500 text-white sticky top-0 z-50 shadow-lg px-4 py-3">
        <div class="flex items-center justify-between max-w-4xl mx-auto">
            <div class="flex items-center gap-3">
                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                </svg>
                <div>
                    <h1 class="text-lg font-bold">BioMed 設備維護</h1>
                    <p class="text-xs opacity-80">v1.2.7</p>
                </div>
            </div>
            <div class="flex items-center gap-2">
                <div class="w-2 h-2 rounded-full" :class="isOnline ? 'bg-green-400' : 'bg-red-400'"></div>
                <span class="text-xs" x-text="isOnline ? '線上' : '離線'"></span>
            </div>
        </div>
    </header>

    <!-- Offline Banner -->
    <div x-show="!isOnline" class="bg-amber-500 text-white text-center py-2 text-sm font-medium">
        離線模式 - 部分功能可能受限
    </div>

    <!-- Main Content -->
    <main class="max-w-4xl mx-auto px-4 py-4">

        <!-- Tab Navigation (MIRS Style) -->
        <div class="bg-white rounded-xl shadow mb-4">
            <div class="flex gap-2 p-2">
                <button @click="currentTab = 'equipment'"
                        :class="currentTab === 'equipment' ? 'bg-equipment-500 text-white font-semibold shadow-md' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'"
                        class="flex-1 py-3 px-4 rounded-lg transition-all duration-200 flex items-center justify-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                    </svg>
                    <span class="text-sm sm:text-base">設備管理</span>
                </button>
                <button @click="currentTab = 'resilience'"
                        :class="currentTab === 'resilience' ? 'bg-amber-500 text-white font-semibold shadow-md' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'"
                        class="flex-1 py-3 px-4 rounded-lg transition-all duration-200 flex items-center justify-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
                    </svg>
                    <span class="text-sm sm:text-base">韌性估算</span>
                </button>
            </div>
        </div>

        <!-- Equipment Tab -->
        <div x-show="currentTab === 'equipment'" x-cloak>
            <!-- Header with Actions -->
            <div class="bg-white rounded-xl shadow-lg p-4 mb-4">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                    <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                        <svg class="w-6 h-6 text-equipment-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                        </svg>
                        設備管理
                    </h2>
                    <div class="flex flex-wrap gap-2">
                        <button @click="showAddModal = true" class="bg-equipment-500 text-white px-4 py-2 rounded-lg hover:bg-equipment-600 transition-colors flex items-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                            </svg>
                            <span>新增設備</span>
                        </button>
                        <button @click="loadEquipment()" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors flex items-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                            </svg>
                            <span class="hidden sm:inline">重新載入</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Stats Bar -->
            <div class="grid grid-cols-3 gap-3 mb-4">
                <div class="bg-white rounded-lg p-3 shadow text-center">
                    <p class="text-2xl font-bold text-equipment-500" x-text="equipment.length"></p>
                    <p class="text-xs text-gray-500">總設備數</p>
                </div>
                <div class="bg-white rounded-lg p-3 shadow text-center">
                    <p class="text-2xl font-bold text-green-500" x-text="equipment.filter(e => e.status === 'NORMAL').length"></p>
                    <p class="text-xs text-gray-500">已確認</p>
                </div>
                <div class="bg-white rounded-lg p-3 shadow text-center">
                    <p class="text-2xl font-bold" :class="getPendingCount() > 0 ? 'text-amber-500 pulse-warning' : 'text-gray-400'" x-text="getPendingCount()"></p>
                    <p class="text-xs text-gray-500">待檢查</p>
                </div>
            </div>

            <!-- Auto Reset Info -->
            <div class="bg-equipment-50 border border-equipment-200 rounded-lg p-3 mb-4 flex items-center gap-2 text-sm">
                <svg class="w-5 h-5 text-equipment-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                <span class="text-gray-700">設備狀態將於每日 <strong class="text-equipment-600">07:00</strong> 自動重置為待檢查</span>
            </div>

            <!-- Power Supply Equipment -->
            <div class="bg-white rounded-xl shadow-lg mb-4 overflow-hidden">
                <div class="bg-equipment-900 text-white px-4 py-3 flex items-center justify-between">
                    <h3 class="font-semibold flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                        </svg>
                        供電設備
                        <span class="text-sm font-normal opacity-80" x-text="'(' + getPowerSupplyEquipment().length + ')'"></span>
                    </h3>
                    <span class="text-xs bg-amber-500 px-2 py-0.5 rounded">韌性關鍵</span>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead class="bg-gray-50 text-gray-600">
                            <tr>
                                <th class="px-3 py-2 text-left font-medium">編號</th>
                                <th class="px-3 py-2 text-left font-medium">名稱</th>
                                <th class="px-3 py-2 text-center font-medium">數量</th>
                                <th class="px-3 py-2 text-center font-medium">存量</th>
                                <th class="px-3 py-2 text-center font-medium">狀態</th>
                                <th class="px-3 py-2 text-center font-medium">操作</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-100">
                            <template x-for="eq in getPowerSupplyEquipment()" :key="eq.id + '-' + equipmentRefreshKey">
                                <tr class="hover:bg-gray-50 transition-all" :class="{
                                    'bg-amber-50': eq.status === 'NORMAL',
                                    'bg-yellow-50': eq.status === 'WARNING',
                                    'bg-red-50': eq.status === 'ERROR',
                                    'opacity-50 grayscale': (eq.check_status === 'UNCHECKED' || eq.check_status === 'NO_UNITS') && eq.status !== 'NORMAL'
                                }">
                                    <td class="px-3 py-2 font-mono text-xs text-gray-500" x-text="eq.id"></td>
                                    <td class="px-3 py-2 font-medium text-gray-900" x-text="eq.name"></td>
                                    <td class="px-3 py-2 text-center font-semibold" x-text="eq.quantity || eq.unit_count || 1"></td>
                                    <td class="px-3 py-2 text-center">
                                        <template x-if="eq.power_level !== null && eq.power_level !== undefined">
                                            <span class="font-medium" :class="{ 'text-green-600': eq.power_level >= 60, 'text-yellow-600': eq.power_level >= 30 && eq.power_level < 60, 'text-red-600': eq.power_level < 30 }" x-text="eq.power_level + '%'"></span>
                                        </template>
                                        <span x-show="eq.power_level === null || eq.power_level === undefined" class="text-gray-400">-</span>
                                    </td>
                                    <td class="px-3 py-2 text-center">
                                        <span :class="{ 'bg-green-100 text-green-800': eq.status === 'NORMAL', 'bg-yellow-100 text-yellow-800': eq.status === 'WARNING', 'bg-red-100 text-red-800': eq.status === 'ERROR', 'bg-gray-100 text-gray-800': eq.status === 'UNCHECKED' || eq.status === 'PENDING' }" class="px-2 py-0.5 text-xs font-medium rounded-full" x-text="getStatusText(eq.status)"></span>
                                    </td>
                                    <td class="px-3 py-2 text-center">
                                        <div class="flex gap-1 justify-center">
                                            <button @click="openUnitManageModal(eq)" class="text-equipment-600 hover:text-equipment-800 text-xs font-medium px-2 py-1 bg-equipment-100 rounded" title="確認/管理">✓</button>
                                            <button @click="editEquipment(eq)" class="text-gray-600 hover:text-gray-800 text-xs font-medium px-2 py-1 bg-gray-100 rounded" title="編輯">✎</button>
                                            <button @click="deleteEquipment(eq)" class="text-red-600 hover:text-red-800 text-xs font-medium px-2 py-1 bg-red-50 rounded" title="刪除">✕</button>
                                        </div>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                    <div x-show="getPowerSupplyEquipment().length === 0" class="text-center text-gray-400 py-8">目前沒有供電設備</div>
                </div>
            </div>

            <!-- Power Consuming Equipment -->
            <div class="bg-white rounded-xl shadow-lg mb-4 overflow-hidden">
                <div class="bg-equipment-700 text-white px-4 py-3">
                    <h3 class="font-semibold flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z"/>
                        </svg>
                        耗電設備
                        <span class="text-sm font-normal opacity-80" x-text="'(' + getPowerConsumingEquipment().length + ')'"></span>
                    </h3>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead class="bg-gray-50 text-gray-600">
                            <tr>
                                <th class="px-3 py-2 text-left font-medium">編號</th>
                                <th class="px-3 py-2 text-left font-medium">名稱</th>
                                <th class="px-3 py-2 text-left font-medium hidden sm:table-cell">類別</th>
                                <th class="px-3 py-2 text-center font-medium">數量</th>
                                <th class="px-3 py-2 text-center font-medium">狀態</th>
                                <th class="px-3 py-2 text-center font-medium">操作</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-100">
                            <template x-for="eq in getPowerConsumingEquipment()" :key="eq.id + '-' + equipmentRefreshKey">
                                <tr class="hover:bg-gray-50 transition-all" :class="{
                                    'bg-amber-50': eq.status === 'NORMAL',
                                    'bg-yellow-50': eq.status === 'WARNING',
                                    'bg-red-50': eq.status === 'ERROR',
                                    'opacity-50 grayscale': (eq.check_status === 'UNCHECKED' || eq.check_status === 'NO_UNITS') && eq.status !== 'NORMAL'
                                }">
                                    <td class="px-3 py-2 font-mono text-xs text-gray-500" x-text="eq.id"></td>
                                    <td class="px-3 py-2 font-medium text-gray-900" x-text="eq.name"></td>
                                    <td class="px-3 py-2 text-gray-600 hidden sm:table-cell" x-text="eq.category || '-'"></td>
                                    <td class="px-3 py-2 text-center font-semibold" x-text="eq.quantity || eq.unit_count || 1"></td>
                                    <td class="px-3 py-2 text-center">
                                        <span :class="{ 'bg-green-100 text-green-800': eq.status === 'NORMAL', 'bg-yellow-100 text-yellow-800': eq.status === 'WARNING', 'bg-red-100 text-red-800': eq.status === 'ERROR', 'bg-gray-100 text-gray-800': eq.status === 'UNCHECKED' || eq.status === 'PENDING' }" class="px-2 py-0.5 text-xs font-medium rounded-full" x-text="getStatusText(eq.status)"></span>
                                    </td>
                                    <td class="px-3 py-2 text-center">
                                        <div class="flex gap-1 justify-center">
                                            <button @click="openUnitManageModal(eq)" class="text-equipment-600 hover:text-equipment-800 text-xs font-medium px-2 py-1 bg-equipment-100 rounded" title="確認/管理">✓</button>
                                            <button @click="editEquipment(eq)" class="text-gray-600 hover:text-gray-800 text-xs font-medium px-2 py-1 bg-gray-100 rounded" title="編輯">✎</button>
                                            <button @click="deleteEquipment(eq)" class="text-red-600 hover:text-red-800 text-xs font-medium px-2 py-1 bg-red-50 rounded" title="刪除">✕</button>
                                        </div>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                    <div x-show="getPowerConsumingEquipment().length === 0" class="text-center text-gray-400 py-8">目前沒有耗電設備</div>
                </div>
            </div>

            <!-- Other Equipment -->
            <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                <div class="bg-equipment-600 text-white px-4 py-3">
                    <h3 class="font-semibold flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
                        </svg>
                        其他設備
                        <span class="text-sm font-normal opacity-80" x-text="'(' + getNonElectricEquipment().length + ')'"></span>
                    </h3>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead class="bg-gray-50 text-gray-600">
                            <tr>
                                <th class="px-3 py-2 text-left font-medium">編號</th>
                                <th class="px-3 py-2 text-left font-medium">名稱</th>
                                <th class="px-3 py-2 text-center font-medium">數量</th>
                                <th class="px-3 py-2 text-center font-medium">狀態</th>
                                <th class="px-3 py-2 text-center font-medium">操作</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-100">
                            <template x-for="eq in getNonElectricEquipment()" :key="eq.id + '-' + equipmentRefreshKey">
                                <tr class="hover:bg-gray-50 transition-all" :class="{
                                    'bg-amber-50': eq.status === 'NORMAL',
                                    'bg-yellow-50': eq.status === 'WARNING',
                                    'bg-red-50': eq.status === 'ERROR',
                                    'opacity-50 grayscale': (eq.check_status === 'UNCHECKED' || eq.check_status === 'NO_UNITS') && eq.status !== 'NORMAL'
                                }">
                                    <td class="px-3 py-2 font-mono text-xs text-gray-500" x-text="eq.id"></td>
                                    <td class="px-3 py-2 font-medium text-gray-900" x-text="eq.name"></td>
                                    <td class="px-3 py-2 text-center font-semibold" x-text="eq.quantity || eq.unit_count || 1"></td>
                                    <td class="px-3 py-2 text-center">
                                        <span :class="{ 'bg-green-100 text-green-800': eq.status === 'NORMAL', 'bg-yellow-100 text-yellow-800': eq.status === 'WARNING', 'bg-red-100 text-red-800': eq.status === 'ERROR', 'bg-gray-100 text-gray-800': eq.status === 'UNCHECKED' || eq.status === 'PENDING' }" class="px-2 py-0.5 text-xs font-medium rounded-full" x-text="getStatusText(eq.status)"></span>
                                    </td>
                                    <td class="px-3 py-2 text-center">
                                        <div class="flex gap-1 justify-center">
                                            <button @click="openUnitManageModal(eq)" class="text-equipment-600 hover:text-equipment-800 text-xs font-medium px-2 py-1 bg-equipment-100 rounded" title="確認/管理">✓</button>
                                            <button @click="editEquipment(eq)" class="text-gray-600 hover:text-gray-800 text-xs font-medium px-2 py-1 bg-gray-100 rounded" title="編輯">✎</button>
                                            <button @click="deleteEquipment(eq)" class="text-red-600 hover:text-red-800 text-xs font-medium px-2 py-1 bg-red-50 rounded" title="刪除">✕</button>
                                        </div>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                    <div x-show="getNonElectricEquipment().length === 0" class="text-center text-gray-400 py-8">目前沒有其他設備</div>
                </div>
            </div>
        </div>

        <!-- Resilience Tab -->
        <div x-show="currentTab === 'resilience'" x-cloak>
            <!-- v1.2.2: Vercel Serverless Demo Warning -->
            <div x-show="isVercelDemo" class="bg-amber-100 border border-amber-400 rounded-lg p-3 mb-4 flex items-start gap-3">
                <svg class="w-5 h-5 text-amber-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                </svg>
                <div class="text-sm">
                    <p class="font-medium text-amber-800">Vercel Serverless Demo 限制</p>
                    <p class="text-amber-700">設備確認後狀態可能無法正確反映。Serverless 架構每次請求為獨立實例，In-Memory 資料不共享。實機部署 (RPi) 無此限制。</p>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-lg p-4 mb-4">
                <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2 mb-4">
                    <svg class="w-6 h-6 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
                    </svg>
                    韌性估算 - 生存計算器
                </h2>

                <!-- v1.2.2: Simplified Scenario Input Panel -->
                <div class="bg-amber-50 rounded-xl p-4 mb-4 border border-amber-200">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="text-sm font-semibold text-amber-800">情境設定</h3>
                        <div class="flex items-center gap-2 bg-white rounded-lg px-3 py-1 border border-amber-300">
                            <span class="text-xs text-gray-500">目標</span>
                            <button @click="isolationDays = Math.max(1, isolationDays - 1)"
                                    class="w-6 h-6 rounded bg-amber-200 hover:bg-amber-300 flex items-center justify-center font-bold text-sm">−</button>
                            <span class="text-lg font-bold text-amber-700 w-6 text-center" x-text="isolationDays"></span>
                            <button @click="isolationDays = Math.min(14, isolationDays + 1)"
                                    class="w-6 h-6 rounded bg-amber-200 hover:bg-amber-300 flex items-center justify-center font-bold text-sm">+</button>
                            <span class="text-xs text-gray-500">天</span>
                        </div>
                    </div>

                    <!-- 2-row compact layout -->
                    <div class="grid grid-cols-2 gap-3">
                        <!-- Left: 氧氣設定 -->
                        <div class="bg-white rounded-lg p-3 border border-orange-200">
                            <p class="text-xs font-medium text-orange-700 mb-2">氧氣需求 (等效人數)</p>
                            <div class="space-y-2">
                                <div class="flex items-center justify-between">
                                    <span class="text-xs text-gray-600">鼻導管 <span class="text-orange-500">(0.3)</span></span>
                                    <div class="flex items-center gap-1">
                                        <button @click="cannulaCount = Math.max(0, cannulaCount - 1)" class="w-5 h-5 rounded bg-orange-100 hover:bg-orange-200 text-xs font-bold">−</button>
                                        <span class="w-6 text-center font-bold text-sm" x-text="cannulaCount"></span>
                                        <button @click="cannulaCount++" class="w-5 h-5 rounded bg-orange-100 hover:bg-orange-200 text-xs font-bold">+</button>
                                    </div>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-xs text-gray-600">面罩 <span class="text-orange-500">(0.6)</span></span>
                                    <div class="flex items-center gap-1">
                                        <button @click="maskCount = Math.max(0, maskCount - 1)" class="w-5 h-5 rounded bg-orange-100 hover:bg-orange-200 text-xs font-bold">−</button>
                                        <span class="w-6 text-center font-bold text-sm" x-text="maskCount"></span>
                                        <button @click="maskCount++" class="w-5 h-5 rounded bg-orange-100 hover:bg-orange-200 text-xs font-bold">+</button>
                                    </div>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-xs text-gray-600">插管 <span class="text-orange-500">(1.0)</span></span>
                                    <div class="flex items-center gap-1">
                                        <button @click="ventilatorO2Count = Math.max(0, ventilatorO2Count - 1)" class="w-5 h-5 rounded bg-orange-100 hover:bg-orange-200 text-xs font-bold">−</button>
                                        <span class="w-6 text-center font-bold text-sm" x-text="ventilatorO2Count"></span>
                                        <button @click="ventilatorO2Count++" class="w-5 h-5 rounded bg-orange-100 hover:bg-orange-200 text-xs font-bold">+</button>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-2 pt-2 border-t border-orange-100 text-center">
                                <span class="text-sm font-bold text-orange-600" x-text="getO2EquivalentPersons().toFixed(1) + ' 人'"></span>
                                <span class="text-xs text-gray-500">= <span x-text="getOxygenConsumptionLPM().toFixed(1)"></span> L/min</span>
                            </div>
                        </div>

                        <!-- Right: 電力設定 -->
                        <div class="bg-white rounded-lg p-3 border border-yellow-200">
                            <p class="text-xs font-medium text-yellow-700 mb-2">電力負載</p>
                            <div class="space-y-2">
                                <div class="flex items-center justify-between">
                                    <span class="text-xs text-gray-600">呼吸器 <span class="text-yellow-600">(+50W)</span></span>
                                    <div class="flex items-center gap-1">
                                        <button @click="ventilatorCount = Math.max(0, ventilatorCount - 1)" class="w-5 h-5 rounded bg-yellow-100 hover:bg-yellow-200 text-xs font-bold">−</button>
                                        <span class="w-6 text-center font-bold text-sm" x-text="ventilatorCount"></span>
                                        <button @click="ventilatorCount++" class="w-5 h-5 rounded bg-yellow-100 hover:bg-yellow-200 text-xs font-bold">+</button>
                                    </div>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-xs text-gray-600">氧氣濃縮機 <span class="text-amber-600">(-5L/min)</span></span>
                                    <div class="flex items-center gap-1">
                                        <button @click="concentratorCount = Math.max(0, concentratorCount - 1)" class="w-5 h-5 rounded bg-amber-100 hover:bg-amber-200 text-xs font-bold">−</button>
                                        <span class="w-6 text-center font-bold text-sm" x-text="concentratorCount"></span>
                                        <button @click="concentratorCount++" class="w-5 h-5 rounded bg-amber-100 hover:bg-amber-200 text-xs font-bold">+</button>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-2 pt-2 border-t border-yellow-100 text-center">
                                <span class="text-sm font-bold text-yellow-600" x-text="getPowerLoadWatts() + ' W'"></span>
                                <span class="text-xs text-gray-500">基礎負載</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Overall Status - Now shows survival vs target (v1.2.2: amber/orange/red only) -->
                <div class="rounded-xl p-6 mb-4 text-center transition-all duration-300"
                     :class="{
                         'bg-gradient-to-br from-red-50 to-red-100': getCalculatedSurvivalHours() < 24,
                         'bg-gradient-to-br from-orange-50 to-orange-100': getCalculatedSurvivalHours() >= 24 && getCalculatedSurvivalHours() < (isolationDays * 24),
                         'bg-gradient-to-br from-amber-50 to-amber-100': getCalculatedSurvivalHours() >= (isolationDays * 24)
                     }">
                    <h3 class="text-lg font-semibold text-gray-700 mb-2">可獨立運作</h3>
                    <div class="text-5xl font-bold mb-2"
                         :class="{
                             'text-red-500': getCalculatedSurvivalHours() < 24,
                             'text-orange-500': getCalculatedSurvivalHours() >= 24 && getCalculatedSurvivalHours() < (isolationDays * 24),
                             'text-amber-600': getCalculatedSurvivalHours() >= (isolationDays * 24)
                         }">
                        <span x-text="getCalculatedSurvivalHours().toFixed(1)"></span>
                        <span class="text-2xl">小時</span>
                    </div>
                    <p class="text-sm mb-2" :class="{
                        'text-red-600': getCalculatedSurvivalHours() < (isolationDays * 24),
                        'text-amber-700': getCalculatedSurvivalHours() >= (isolationDays * 24)
                    }">
                        <template x-if="getCalculatedSurvivalHours() >= (isolationDays * 24)">
                            <span>達成 <span x-text="isolationDays"></span> 天目標!</span>
                        </template>
                        <template x-if="getCalculatedSurvivalHours() < (isolationDays * 24)">
                            <span>距離 <span x-text="isolationDays"></span> 天目標差 <span x-text="((isolationDays * 24) - getCalculatedSurvivalHours()).toFixed(1)"></span> 小時</span>
                        </template>
                    </p>
                    <p class="text-sm text-gray-500">
                        瓶頸: <span class="font-medium" x-text="getBottleneckResource()"></span>
                    </p>
                    <div class="flex justify-center gap-2 mt-4">
                        <button @click="loadResilienceStatus()"
                                class="bg-amber-500 text-white px-4 py-2 rounded-lg hover:bg-amber-600 transition-colors inline-flex items-center gap-2 text-sm">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                            </svg>
                            從伺服器更新
                        </button>
                        <button @click="useLocalCalculation = !useLocalCalculation"
                                :class="useLocalCalculation ? 'bg-amber-600 hover:bg-amber-700' : 'bg-gray-400 hover:bg-gray-500'"
                                class="text-white px-4 py-2 rounded-lg transition-colors inline-flex items-center gap-2 text-sm">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"/>
                            </svg>
                            <span x-text="useLocalCalculation ? '本地計算中' : '本地計算'"></span>
                        </button>
                    </div>
                </div>

                <!-- Resource Breakdown -->
                <div class="grid gap-4 sm:grid-cols-2">
                    <!-- Oxygen (Orange color scheme v1.2.1) -->
                    <div class="bg-white border border-gray-200 rounded-xl p-4">
                        <div class="flex items-center justify-between mb-2">
                            <span class="font-medium text-gray-700 flex items-center gap-2">
                                <svg class="w-5 h-5 text-orange-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/>
                                </svg>
                                氧氣供應
                            </span>
                            <span class="text-xl font-bold"
                                  :class="{
                                      'text-amber-600': getOxygenHours() >= (isolationDays * 24),
                                      'text-orange-500': getOxygenHours() >= 24 && getOxygenHours() < (isolationDays * 24),
                                      'text-red-500': getOxygenHours() < 24
                                  }"
                                  x-text="getOxygenHours().toFixed(1) + 'h'"></span>
                        </div>
                        <!-- Progress bar: % of target goal (v1.2.2: amber/orange/red only) -->
                        <div class="relative h-4 bg-gray-200 rounded-full overflow-hidden mb-2">
                            <div class="h-full transition-all duration-500"
                                 :class="{
                                     'bg-amber-500': getOxygenHours() >= (isolationDays * 24),
                                     'bg-orange-400': getOxygenHours() >= 24 && getOxygenHours() < (isolationDays * 24),
                                     'bg-red-500': getOxygenHours() < 24
                                 }"
                                 :style="'width: ' + Math.min(getOxygenHours() / (isolationDays * 24) * 100, 100) + '%'"></div>
                            <!-- Target marker -->
                            <div class="absolute top-0 h-full w-0.5 bg-gray-800" style="left: 100%"></div>
                        </div>
                        <div class="flex justify-between text-xs text-gray-500 mb-2">
                            <span>0h</span>
                            <span x-text="Math.round(getOxygenHours() / (isolationDays * 24) * 100) + '% 達標'"></span>
                            <span x-text="(isolationDays * 24) + 'h 目標'"></span>
                        </div>
                        <!-- Consumption info (v1.2.1: Medical-grade formula) -->
                        <div class="text-xs text-orange-600 bg-orange-50 rounded p-2 mb-2" x-show="useLocalCalculation">
                            <span>消耗: </span>
                            <span x-text="getOxygenConsumptionLPM().toFixed(1)"></span>
                            <span> L/min</span>
                            <span class="text-gray-400 ml-1">(等效<span x-text="getO2EquivalentPersons().toFixed(1)"></span>人 - 濃縮機<span x-text="concentratorCount"></span>x5)</span>
                        </div>
                        <!-- v1.2.3: 氧氣濃縮機 (不用 PSI，顯示運轉狀態) -->
                        <div class="space-y-2 border-t border-gray-100 pt-2" x-show="getConcentrators().length > 0">
                            <p class="text-xs text-amber-700 font-medium">氧氣濃縮機</p>
                            <template x-for="(eq, idx) in getConcentrators()" :key="eq.id + '-concentrator-' + resilienceRefreshKey">
                                <div class="rounded-lg p-2 border transition-all" :class="eq.status === 'NORMAL' ? 'bg-amber-50 border-amber-200' : 'bg-gray-100 border-gray-200 opacity-60'">
                                    <div class="flex items-center justify-between">
                                        <span class="text-xs font-medium" :class="eq.status === 'NORMAL' ? 'text-amber-800' : 'text-gray-500'" x-text="eq.name"></span>
                                        <div class="flex items-center gap-2">
                                            <span class="text-xs" :class="eq.status === 'NORMAL' ? 'text-amber-600 font-bold' : 'text-gray-400'" x-text="eq.status === 'NORMAL' ? '運轉中' : '待確認'"></span>
                                            <button @click="checkEquipment(eq)"
                                                    class="text-xs bg-amber-500 hover:bg-amber-600 text-white px-2 py-0.5 rounded transition-colors">
                                                確認
                                            </button>
                                        </div>
                                    </div>
                                    <p class="text-xs text-gray-400 mt-1">輸出: 5 L/min | 耗電: ~300W</p>
                                </div>
                            </template>
                        </div>

                        <!-- v1.2.4: 氧氣鋼瓶 (每瓶獨立顯示 PSI, 未確認用灰色 bar) -->
                        <div class="space-y-2 border-t border-gray-100 pt-2" x-show="resilienceStatus.oxygenUnits && resilienceStatus.oxygenUnits.length > 0">
                            <div class="flex items-center justify-between">
                                <p class="text-xs text-orange-700 font-medium">氧氣鋼瓶</p>
                                <span class="text-xs text-orange-600" x-text="resilienceStatus.oxygenUnits.filter(u => u.last_check).length + '/' + resilienceStatus.oxygenUnits.length + ' 已檢查'"></span>
                            </div>
                            <template x-for="(unit, idx) in (resilienceStatus.oxygenUnits || [])" :key="unit.id + '-' + resilienceRefreshKey">
                                <div class="rounded-lg p-2 border transition-all" :class="unit.last_check ? 'bg-orange-50 border-orange-200' : 'bg-gray-50 border-gray-200'">
                                    <div class="flex items-center gap-2 mb-1">
                                        <!-- Check icon: ✓ for checked, clock for unchecked -->
                                        <template x-if="unit.last_check">
                                            <svg class="w-4 h-4 text-green-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                            </svg>
                                        </template>
                                        <template x-if="!unit.last_check">
                                            <svg class="w-4 h-4 text-gray-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                            </svg>
                                        </template>
                                        <span class="text-xs font-medium flex-1" :class="unit.last_check ? 'text-gray-800' : 'text-gray-500'" x-text="unit.unit_label || (unit.equipment_name?.includes('E') ? 'E型' : 'H型') + (idx + 1) + '號'"></span>
                                        <span class="text-xs font-bold" :class="unit.last_check ? (unit.psi >= 1320 ? 'text-amber-600' : unit.psi >= 660 ? 'text-orange-600' : 'text-red-600') : 'text-gray-400'" x-text="(unit.level_percent || Math.round((unit.psi || 0) / 2200 * 100)) + '%'"></span>
                                        <span class="text-xs text-gray-400" x-text="unit.capacity_L ? unit.capacity_L + 'L' : (unit.equipment_name?.includes('H型') ? '6,900L' : '680L')"></span>
                                    </div>
                                    <!-- Progress Bar: gray if unchecked, amber/orange/red if checked -->
                                    <div class="relative h-2 bg-gray-200 rounded-full overflow-hidden mb-1">
                                        <div class="h-full transition-all duration-300"
                                             :class="unit.last_check ? ((unit.level_percent || unit.psi / 2200 * 100) >= 60 ? 'bg-amber-500' : (unit.level_percent || unit.psi / 2200 * 100) >= 30 ? 'bg-orange-400' : 'bg-red-500') : 'bg-gray-400'"
                                             :style="'width: ' + Math.min(unit.level_percent || (unit.psi || 0) / 2200 * 100, 100) + '%'"></div>
                                    </div>
                                    <div class="flex items-center justify-between">
                                        <span class="text-xs" :class="unit.last_check ? 'text-orange-600' : 'text-gray-400'" x-text="unit.status === 'IN_USE' ? '使用中' : '備用'"></span>
                                        <button @click="openUnitEditModal(unit, 'OXYGEN')"
                                                class="text-xs px-2 py-0.5 rounded transition-colors"
                                                :class="unit.last_check ? 'bg-gray-200 text-gray-600 hover:bg-gray-300' : 'bg-orange-500 hover:bg-orange-600 text-white'">
                                            <span x-text="unit.last_check ? '編輯' : '確認'"></span>
                                        </button>
                                    </div>
                                </div>
                            </template>
                        </div>

                        <!-- Fallback: Show aggregated if no units data -->
                        <div class="space-y-2 border-t border-gray-100 pt-2" x-show="(!resilienceStatus.oxygenUnits || resilienceStatus.oxygenUnits.length === 0) && getConcentrators().length === 0 && resilienceStatus.oxygenResources && resilienceStatus.oxygenResources.length > 0">
                            <template x-for="(res, idx) in (resilienceStatus.oxygenResources || [])" :key="res.name + idx + '-' + resilienceRefreshKey">
                                <div class="bg-orange-50 rounded-lg p-2 border border-orange-100">
                                    <div class="flex items-center justify-between mb-1">
                                        <span class="text-xs font-medium text-orange-800" x-text="res.name + (res.quantity > 1 ? ' x' + res.quantity : '')"></span>
                                        <span class="text-xs font-bold" :class="res.fill_pct >= 60 ? 'text-amber-600' : res.fill_pct >= 30 ? 'text-orange-600' : 'text-red-600'" x-text="res.fill_pct ? res.fill_pct + '%' : '-'"></span>
                                    </div>
                                    <div class="relative h-2 bg-gray-200 rounded-full overflow-hidden mb-1">
                                        <div class="h-full transition-all duration-300"
                                             :class="res.fill_pct >= 60 ? 'bg-amber-500' : res.fill_pct >= 30 ? 'bg-orange-400' : 'bg-red-500'"
                                             :style="'width: ' + (res.fill_pct || 0) + '%'"></div>
                                    </div>
                                    <div class="flex items-center justify-between">
                                        <span class="text-xs text-gray-400" x-text="res.capacity_L ? res.capacity_L + 'L' : ''"></span>
                                        <button @click="confirmResourceFromResilience(res, 'OXYGEN')"
                                                class="text-xs bg-orange-500 hover:bg-orange-600 text-white px-2 py-0.5 rounded transition-colors">
                                            確認
                                        </button>
                                    </div>
                                </div>
                            </template>
                        </div>
                        <div class="text-xs text-gray-400 pt-2 border-t border-gray-100" x-show="!resilienceStatus.oxygenResources || resilienceStatus.oxygenResources.length === 0">
                            尚無氧氣設備資料
                        </div>
                    </div>

                    <!-- Power -->
                    <div class="bg-white border border-gray-200 rounded-xl p-4">
                        <div class="flex items-center justify-between mb-2">
                            <span class="font-medium text-gray-700 flex items-center gap-2">
                                <svg class="w-5 h-5 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                                </svg>
                                電力供應
                            </span>
                            <span class="text-xl font-bold"
                                  :class="{
                                      'text-amber-600': getPowerHours() >= (isolationDays * 24),
                                      'text-orange-500': getPowerHours() >= 24 && getPowerHours() < (isolationDays * 24),
                                      'text-red-500': getPowerHours() < 24
                                  }"
                                  x-text="getPowerHours().toFixed(1) + 'h'"></span>
                        </div>
                        <!-- Progress bar: % of target goal (v1.2.2: amber/orange/red only) -->
                        <div class="relative h-4 bg-gray-200 rounded-full overflow-hidden mb-2">
                            <div class="h-full transition-all duration-500"
                                 :class="{
                                     'bg-amber-500': getPowerHours() >= (isolationDays * 24),
                                     'bg-orange-400': getPowerHours() >= 24 && getPowerHours() < (isolationDays * 24),
                                     'bg-red-500': getPowerHours() < 24
                                 }"
                                 :style="'width: ' + Math.min(getPowerHours() / (isolationDays * 24) * 100, 100) + '%'"></div>
                            <!-- Target marker -->
                            <div class="absolute top-0 h-full w-0.5 bg-gray-800" style="left: 100%"></div>
                        </div>
                        <div class="flex justify-between text-xs text-gray-500 mb-2">
                            <span>0h</span>
                            <span x-text="Math.round(getPowerHours() / (isolationDays * 24) * 100) + '% 達標'"></span>
                            <span x-text="(isolationDays * 24) + 'h 目標'"></span>
                        </div>
                        <!-- Load info -->
                        <div class="text-xs text-yellow-600 bg-yellow-50 rounded p-2 mb-2" x-show="useLocalCalculation">
                            <span>負載: </span>
                            <span x-text="getPowerLoadWatts()"></span>
                            <span> W</span>
                            <span class="text-gray-400 ml-1">(基礎100 + 呼吸器<span x-text="ventilatorCount"></span>x50)</span>
                        </div>
                        <!-- v1.2.5: 電力設備 (每台獨立顯示, 未確認用灰色 bar) -->
                        <div class="space-y-2 border-t border-gray-100 pt-2" x-show="resilienceStatus.powerUnits && resilienceStatus.powerUnits.length > 0">
                            <div class="flex items-center justify-between">
                                <p class="text-xs text-yellow-700 font-medium">電力設備</p>
                                <span class="text-xs text-yellow-600" x-text="resilienceStatus.powerUnits.filter(u => u.last_check).length + '/' + resilienceStatus.powerUnits.length + ' 已檢查'"></span>
                            </div>
                            <template x-for="(unit, idx) in (resilienceStatus.powerUnits || [])" :key="unit.id + '-power-' + resilienceRefreshKey">
                                <div class="rounded-lg p-2 border transition-all" :class="unit.last_check ? 'bg-yellow-50 border-yellow-200' : 'bg-gray-50 border-gray-200'">
                                    <div class="flex items-center gap-2 mb-1">
                                        <!-- Check icon -->
                                        <template x-if="unit.last_check">
                                            <svg class="w-4 h-4 text-green-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                            </svg>
                                        </template>
                                        <template x-if="!unit.last_check">
                                            <svg class="w-4 h-4 text-gray-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                            </svg>
                                        </template>
                                        <span class="text-xs font-medium flex-1" :class="unit.last_check ? 'text-gray-800' : 'text-gray-500'" x-text="unit.unit_label || (unit.equipment_name + ' #' + (idx + 1))"></span>
                                        <span class="text-xs font-bold" :class="unit.last_check ? (unit.level_percent >= 60 ? 'text-amber-600' : unit.level_percent >= 30 ? 'text-orange-600' : 'text-red-600') : 'text-gray-400'" x-text="unit.level_percent + '%'"></span>
                                    </div>
                                    <!-- Progress Bar: gray if unchecked, amber/orange/red if checked -->
                                    <div class="relative h-2 bg-gray-200 rounded-full overflow-hidden mb-1">
                                        <div class="h-full transition-all duration-300"
                                             :class="unit.last_check ? (unit.level_percent >= 60 ? 'bg-amber-500' : unit.level_percent >= 30 ? 'bg-orange-400' : 'bg-red-500') : 'bg-gray-400'"
                                             :style="'width: ' + (unit.level_percent || 0) + '%'"></div>
                                    </div>
                                    <div class="flex items-center justify-between">
                                        <span class="text-xs" :class="unit.last_check ? 'text-yellow-600' : 'text-gray-400'" x-text="unit.status === 'CHARGING' ? '充電中' : (unit.status === 'IN_USE' ? '使用中' : '備用')"></span>
                                        <div class="flex gap-1">
                                            <button @click="openUnitEditModal(unit, 'POWER')"
                                                    class="text-xs px-2 py-0.5 rounded transition-colors"
                                                    :class="unit.last_check ? 'bg-gray-200 text-gray-600 hover:bg-gray-300' : 'bg-yellow-500 hover:bg-yellow-600 text-white'">
                                                <span x-text="unit.last_check ? '編輯' : '確認'"></span>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </template>
                        </div>
                        <!-- Fallback: 舊版聚合顯示 -->
                        <div class="space-y-2 border-t border-gray-100 pt-2" x-show="(!resilienceStatus.powerUnits || resilienceStatus.powerUnits.length === 0) && resilienceStatus.powerResources && resilienceStatus.powerResources.length > 0">
                            <template x-for="(res, idx) in (resilienceStatus.powerResources || [])" :key="res.name + idx + '-' + resilienceRefreshKey">
                                <div class="bg-yellow-50 rounded-lg p-2 border border-yellow-100">
                                    <div class="flex items-center justify-between mb-1">
                                        <span class="text-xs font-medium text-yellow-800" x-text="res.name + (res.quantity > 1 ? ' x' + res.quantity : '')"></span>
                                        <span class="text-xs font-bold" :class="(res.charge_pct || res.fuel_pct) >= 60 ? 'text-amber-600' : (res.charge_pct || res.fuel_pct) >= 30 ? 'text-orange-600' : 'text-red-600'" x-text="res.charge_pct ? res.charge_pct + '%' : (res.fuel_pct ? res.fuel_pct + '%' : '-')"></span>
                                    </div>
                                    <div class="relative h-2 bg-gray-200 rounded-full overflow-hidden mb-1">
                                        <div class="h-full transition-all duration-300"
                                             :class="(res.charge_pct || res.fuel_pct) >= 60 ? 'bg-amber-500' : (res.charge_pct || res.fuel_pct) >= 30 ? 'bg-orange-400' : 'bg-red-500'"
                                             :style="'width: ' + (res.charge_pct || res.fuel_pct || 0) + '%'"></div>
                                    </div>
                                </div>
                            </template>
                        </div>
                        <div class="text-xs text-gray-400 pt-2 border-t border-gray-100" x-show="!resilienceStatus.powerResources || resilienceStatus.powerResources.length === 0">
                            尚無電力設備資料
                        </div>
                    </div>
                </div>
            </div>

            <!-- v1.2.2: MIRS-style Formula Explanation -->
            <div class="mb-4" x-data="{ showFormula: false }">
                <button @click="showFormula = !showFormula"
                        class="text-sm text-amber-600 hover:text-amber-700 flex items-center gap-1">
                    <svg class="w-4 h-4 transition-transform" :class="showFormula ? 'rotate-90' : ''" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                    </svg>
                    計算公式說明
                </button>
                <div x-show="showFormula" x-transition:enter="transition ease-out duration-200" x-transition:enter-start="opacity-0 transform -translate-y-2" x-transition:enter-end="opacity-100 transform translate-y-0" class="mt-2 p-3 bg-amber-50 border border-amber-200 rounded-lg text-sm">
                    <div class="space-y-2 text-gray-700">
                        <p class="font-medium text-amber-700 mb-1">▎鋼瓶氧氣供應</p>
                        <p><strong>氧氣時數</strong> = Σ(每瓶容量 × 充填%) ÷ (10 L/min × 等效人數 × 60)</p>
                        <p class="text-xs text-gray-500 ml-4">• H型鋼瓶 = 6,900 L | E型氧氣瓶 = 680 L</p>
                        <hr class="border-amber-200 my-2">
                        <p class="font-medium text-amber-700 mb-1">▎氧氣濃縮機 (依賴電力)</p>
                        <p><strong>濃縮機輸出</strong> = 5 L/min (固定流量)</p>
                        <p><strong>可供應人數</strong> = 5 ÷ 10 = 0.5 等效人 (耗電約 300W)</p>
                        <p class="text-xs text-gray-500 ml-4">濃縮機運作時間 ≤ 電力可用時數</p>
                        <hr class="border-amber-200 my-2">
                        <p class="font-medium text-amber-700 mb-1">▎電力供應</p>
                        <p><strong>電力時數</strong> = 總電量(Wh) ÷ 負載(W)</p>
                        <p class="text-xs text-gray-500 ml-4">• 基礎負載 = 100W | 呼吸器 = +50W/台</p>
                        <hr class="border-amber-200 my-2">
                        <p class="font-medium text-amber-700 mb-1">▎綜合韌性</p>
                        <p><strong>可獨立運作</strong> = MIN(氧氣時數, 電力時數)</p>
                        <p class="text-xs text-gray-500 ml-4">• 若氧氣濃縮機為主要供氧，則受電力限制</p>
                        <hr class="border-amber-200 my-2">
                        <p class="text-xs text-gray-600 mb-1"><strong>等效人數換算：</strong></p>
                        <p class="text-xs text-gray-600">• 插管 = 1.0 | 面罩 ≈ 0.6 | 鼻導管 ≈ 0.3 | 設為 0 = 無需求</p>
                        <hr class="border-amber-200 my-2">
                        <p class="text-xs text-amber-600">
                            <strong>v1.2.2:</strong> 簡化 UI + amber/orange/red 配色 + MIRS 公式風格
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Add/Edit Equipment Modal -->
    <div x-show="showAddModal || showEditModal" x-cloak
         class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4"
         @click.self="showAddModal = false; showEditModal = false">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-md max-h-[90vh] overflow-y-auto">
            <div class="bg-equipment-500 text-white px-4 py-3 rounded-t-2xl flex items-center justify-between">
                <h3 class="font-semibold" x-text="showEditModal ? '編輯設備' : '新增設備'"></h3>
                <button @click="showAddModal = false; showEditModal = false" class="text-white hover:text-gray-200">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <div class="p-4 space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">設備編號</label>
                    <input type="text" x-model="equipmentForm.id" :disabled="showEditModal"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-equipment-500 disabled:bg-gray-100"
                           placeholder="例: RESP-001">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">設備名稱</label>
                    <input type="text" x-model="equipmentForm.name"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-equipment-500"
                           placeholder="例: H型氧氣鋼瓶">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">類別</label>
                    <select x-model="equipmentForm.category"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-equipment-500">
                        <option value="">選擇類別</option>
                        <option value="呼吸設備">呼吸設備</option>
                        <option value="電力設備">電力設備</option>
                        <option value="診斷設備">診斷設備</option>
                        <option value="急救設備">急救設備</option>
                        <option value="手術器械">手術器械</option>
                        <option value="一般設備">一般設備</option>
                    </select>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">數量</label>
                        <input type="number" x-model.number="equipmentForm.quantity" min="1"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-equipment-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">存量 %</label>
                        <input type="number" x-model.number="equipmentForm.power_level" min="0" max="100"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-equipment-500"
                               placeholder="僅供電設備">
                    </div>
                </div>
                <div class="flex gap-3 pt-4">
                    <button @click="showAddModal = false; showEditModal = false"
                            class="flex-1 bg-gray-200 text-gray-700 py-2 rounded-lg hover:bg-gray-300 transition-colors">
                        取消
                    </button>
                    <button @click="saveEquipment()"
                            class="flex-1 bg-equipment-500 text-white py-2 rounded-lg hover:bg-equipment-600 transition-colors">
                        儲存
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Unit Manage Modal -->
    <div x-show="showUnitManageModal" x-cloak
         class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-start justify-center overflow-y-auto py-4"
         @click.self="showUnitManageModal = false">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-lg mx-4 my-4 max-h-[90vh] overflow-y-auto">
            <div class="bg-equipment-500 text-white px-4 py-3 rounded-t-2xl flex items-center justify-between">
                <h3 class="font-semibold flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
                    </svg>
                    <span>單位管理 - </span>
                    <span x-text="unitManageForm.equipment_name"></span>
                </h3>
                <button @click="showUnitManageModal = false" class="text-white hover:text-gray-200">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>

            <!-- Loading -->
            <div x-show="unitManageForm.loading" class="text-center py-8">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-equipment-500 mx-auto"></div>
                <p class="text-gray-500 mt-2">載入中...</p>
            </div>

            <div x-show="!unitManageForm.loading" class="p-4 space-y-4">
                <!-- Quick Quantity Adjust -->
                <div class="bg-equipment-50 border border-equipment-200 rounded-lg p-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">快速數量調整</label>
                    <div class="flex items-center gap-3">
                        <button type="button" @click="unitManageForm.targetQuantity = Math.max(0, unitManageForm.targetQuantity - 1)"
                                class="w-10 h-10 rounded-full bg-gray-200 hover:bg-gray-300 flex items-center justify-center text-xl font-bold">
                            −
                        </button>
                        <input type="number" x-model="unitManageForm.targetQuantity" min="0"
                               class="w-20 text-center text-xl font-bold border-2 border-equipment-300 rounded-lg py-2">
                        <button type="button" @click="unitManageForm.targetQuantity++"
                                class="w-10 h-10 rounded-full bg-gray-200 hover:bg-gray-300 flex items-center justify-center text-xl font-bold">
                            +
                        </button>
                        <button type="button" @click="batchAdjustQuantity()"
                                :disabled="unitManageForm.targetQuantity === (unitManageForm.units || []).length"
                                :class="unitManageForm.targetQuantity === (unitManageForm.units || []).length ? 'bg-gray-300 cursor-not-allowed' : 'bg-equipment-500 hover:bg-equipment-600'"
                                class="px-4 py-2 text-white rounded-lg transition-colors">
                            套用
                        </button>
                    </div>
                    <p class="text-xs text-gray-500 mt-2">
                        目前: <span x-text="(unitManageForm.units || []).length"></span> 個單位
                        <span x-show="unitManageForm.targetQuantity !== (unitManageForm.units || []).length" class="text-equipment-600 font-medium">
                            → <span x-text="unitManageForm.targetQuantity"></span>
                        </span>
                    </p>
                </div>

                <!-- Current Units -->
                <div>
                    <h4 class="font-medium text-gray-700 mb-2">現有單位 (<span x-text="(unitManageForm.units || []).length"></span>)</h4>
                    <div class="space-y-2 max-h-48 overflow-y-auto">
                        <template x-for="(unit, idx) in (unitManageForm.units || [])" :key="unit.id">
                            <div class="bg-gray-50 rounded-lg p-3 border">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center gap-2">
                                        <!-- 確認狀態 -->
                                        <span class="w-6 h-6 rounded-full flex items-center justify-center text-xs"
                                              :class="unit.last_check ? 'bg-green-100 text-green-600' : 'bg-gray-200 text-gray-400'">
                                            <template x-if="unit.last_check">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                                </svg>
                                            </template>
                                            <template x-if="!unit.last_check">
                                                <span>?</span>
                                            </template>
                                        </span>
                                        <span class="font-medium" x-text="unit.unit_label || unit.unit_serial"></span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <!-- 電量/氧氣% 可編輯 -->
                                        <template x-if="!unit.editing">
                                            <button @click="unit.editing = true; unit.editLevel = unit.level_percent"
                                                    class="flex items-center gap-1 px-2 py-1 rounded bg-white border hover:bg-equipment-50">
                                                <span class="font-medium" :class="unit.level_percent >= 60 ? 'text-green-600' : unit.level_percent >= 30 ? 'text-yellow-600' : 'text-red-600'"
                                                      x-text="(unit.level_percent || 0) + '%'"></span>
                                                <svg class="w-3 h-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/>
                                                </svg>
                                            </button>
                                        </template>
                                        <template x-if="unit.editing">
                                            <div class="flex items-center gap-1">
                                                <input type="number" x-model="unit.editLevel" min="0" max="100"
                                                       class="w-16 px-2 py-1 text-center border border-equipment-400 rounded text-sm">
                                                <button @click="updateUnitLevel(unit)" class="text-green-600 hover:text-green-800 p-1">
                                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                                    </svg>
                                                </button>
                                                <button @click="unit.editing = false" class="text-gray-400 hover:text-gray-600 p-1">
                                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                                    </svg>
                                                </button>
                                            </div>
                                        </template>
                                        <!-- 狀態 (v1.1.5: 可編輯下拉選單) -->
                                        <select x-model="unit.status" @change="updateUnitStatus(unit)"
                                                class="text-xs px-2 py-1 rounded-full border-0 cursor-pointer"
                                                :class="getUnitStatusClass(unit.status)">
                                            <option value="AVAILABLE">備用</option>
                                            <option value="IN_USE">使用中</option>
                                            <option value="CHARGING">充電中</option>
                                            <option value="MAINTENANCE">維修中</option>
                                            <option value="EMPTY">已用完</option>
                                        </select>
                                        <!-- 確認按鈕 -->
                                        <button type="button" @click="checkUnit(unit)"
                                                :class="unit.last_check ? 'text-gray-400 bg-gray-100' : 'text-equipment-600 bg-equipment-100 hover:bg-equipment-200'"
                                                class="p-1.5 rounded" :title="unit.last_check ? '已確認' : '點擊確認'">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                            </svg>
                                        </button>
                                        <!-- 移除 -->
                                        <button type="button" @click="removeUnit(unit)"
                                                class="text-red-500 hover:text-red-700 p-1" title="移除">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                            </svg>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </template>
                        <div x-show="!unitManageForm.units || unitManageForm.units.length === 0" class="text-center text-gray-400 py-4">
                            目前沒有可用單位
                        </div>
                    </div>
                </div>

                <!-- Remove Reason -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">移除原因（可選）</label>
                    <input type="text" x-model="unitManageForm.removeReason" placeholder="例如：設備故障、送修"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                </div>

                <!-- Add Unit -->
                <div class="border-t pt-4">
                    <h4 class="font-medium text-gray-700 mb-2">新增單位</h4>
                    <div class="grid grid-cols-3 gap-3">
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">電量 %</label>
                            <input type="number" x-model="unitManageForm.addForm.level_percent" min="0" max="100"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">狀態</label>
                            <select x-model="unitManageForm.addForm.status"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                <option value="AVAILABLE">可用</option>
                                <option value="IN_USE">使用中</option>
                                <option value="CHARGING">充電中</option>
                                <option value="MAINTENANCE">維護中</option>
                            </select>
                        </div>
                        <div class="flex items-end">
                            <button type="button" @click="addUnit()"
                                    class="w-full bg-equipment-500 text-white px-4 py-2 rounded-lg hover:bg-equipment-600 transition-colors text-sm">
                                + 新增
                            </button>
                        </div>
                    </div>
                    <div class="mt-2">
                        <label class="block text-xs text-gray-500 mb-1">新增原因（可選）</label>
                        <input type="text" x-model="unitManageForm.addForm.reason" placeholder="例如：演習增援"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                    </div>
                </div>

                <!-- Removed Units -->
                <div class="border-t pt-4">
                    <button type="button" @click="unitManageForm.showInactive = !unitManageForm.showInactive"
                            class="flex items-center gap-2 text-gray-600 hover:text-gray-800">
                        <svg class="w-4 h-4 transition-transform" :class="unitManageForm.showInactive ? 'rotate-90' : ''" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                        </svg>
                        <span class="text-sm font-medium">已移除單位 (<span x-text="(unitManageForm.inactive_units || []).length"></span>)</span>
                    </button>
                    <div x-show="unitManageForm.showInactive" class="mt-2 space-y-2 max-h-32 overflow-y-auto">
                        <template x-for="unit in (unitManageForm.inactive_units || [])" :key="unit.id">
                            <div class="flex items-center justify-between bg-red-50 rounded-lg p-3 border border-red-200">
                                <div>
                                    <span class="font-medium text-gray-600 line-through" x-text="unit.unit_label || unit.unit_serial"></span>
                                    <span class="text-xs text-red-500 ml-2" x-text="unit.removal_reason || '已移除'"></span>
                                </div>
                                <button type="button" @click="restoreUnit(unit)"
                                        class="text-green-600 hover:text-green-800 px-3 py-1 text-sm bg-green-100 rounded-lg">
                                    恢復
                                </button>
                            </div>
                        </template>
                        <div x-show="!unitManageForm.inactive_units || unitManageForm.inactive_units.length === 0" class="text-center text-gray-400 py-2 text-sm">
                            沒有已移除的單位
                        </div>
                    </div>
                </div>

                <!-- Close Button -->
                <div class="flex justify-end pt-4 border-t">
                    <button type="button" @click="showUnitManageModal = false"
                            class="bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-600 transition-colors">
                        關閉
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- v1.2.5: Unit Edit Modal (氧氣瓶/電站 編輯百分比) -->
    <div x-show="showUnitEditModal" x-cloak
         class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4"
         @click.self="showUnitEditModal = false">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-sm">
            <div class="px-4 py-3 rounded-t-2xl flex items-center justify-between"
                 :class="unitEditForm.type === 'OXYGEN' ? 'bg-orange-500 text-white' : 'bg-yellow-500 text-white'">
                <h3 class="font-semibold" x-text="unitEditForm.unit_label || unitEditForm.equipment_name"></h3>
                <button @click="showUnitEditModal = false" class="text-white hover:text-gray-200">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <div class="p-4 space-y-4">
                <!-- Level Percent -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">剩餘量 (%)</label>
                    <div class="flex items-center gap-2">
                        <input type="range" x-model.number="unitEditForm.level_percent" min="0" max="100" step="5"
                               class="flex-1 h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                        <input type="number" x-model.number="unitEditForm.level_percent" min="0" max="100"
                               class="w-20 px-2 py-1 border border-gray-300 rounded-lg text-center">
                        <span class="text-gray-500">%</span>
                    </div>
                    <!-- PSI 顯示 (僅氧氣瓶) -->
                    <p class="text-xs text-gray-500 mt-1" x-show="unitEditForm.type === 'OXYGEN'"
                       x-text="'≈ ' + Math.round(unitEditForm.level_percent / 100 * 2200) + ' PSI'"></p>
                </div>
                <!-- Status -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">狀態</label>
                    <select x-model="unitEditForm.status"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500">
                        <option value="AVAILABLE">備用</option>
                        <option value="IN_USE">使用中</option>
                        <option value="CHARGING" x-show="unitEditForm.type === 'POWER'">充電中</option>
                        <option value="MAINTENANCE">維護中</option>
                        <option value="EMPTY">已用完</option>
                    </select>
                </div>
                <!-- Actions -->
                <div class="flex gap-3 pt-2">
                    <button @click="showUnitEditModal = false"
                            class="flex-1 bg-gray-200 text-gray-700 py-2 rounded-lg hover:bg-gray-300 transition-colors">
                        取消
                    </button>
                    <button @click="saveUnitEdit()"
                            class="flex-1 py-2 rounded-lg text-white transition-colors"
                            :class="unitEditForm.type === 'OXYGEN' ? 'bg-orange-500 hover:bg-orange-600' : 'bg-yellow-500 hover:bg-yellow-600'">
                        確認
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div x-show="toast.show" x-transition
         class="fixed bottom-4 left-4 right-4 max-w-md mx-auto bg-gray-800 text-white px-4 py-3 rounded-lg shadow-lg z-50"
         :class="{
             'bg-green-600': toast.type === 'success',
             'bg-red-600': toast.type === 'error',
             'bg-amber-600': toast.type === 'warning'
         }">
        <p x-text="toast.message"></p>
    </div>

    <script>
        function biomedApp() {
            return {
                // State
                currentTab: 'equipment',
                isOnline: navigator.onLine,
                isVercelDemo: window.location.hostname.includes('vercel.app'),  // v1.2.2: Detect Vercel demo
                equipment: [],
                resilienceStatus: {},
                resilienceRefreshKey: 0,  // v1.2.1: refreshKey for forcing DOM update
                equipmentRefreshKey: 0,   // v1.2.1: refreshKey for equipment tab
                toast: { show: false, message: '', type: 'success' },
                showAddModal: false,
                showEditModal: false,
                showUnitManageModal: false,
                showUnitEditModal: false,  // v1.2.5: 單位編輯 Modal
                showFormulaHint: false,
                equipmentForm: {
                    id: '',
                    name: '',
                    category: '',
                    quantity: 1,
                    power_level: null
                },
                // v1.2.5: 單位編輯表單
                unitEditForm: {
                    id: null,
                    equipment_id: '',
                    equipment_name: '',
                    unit_label: '',
                    level_percent: 100,
                    status: 'AVAILABLE',
                    type: 'OXYGEN'  // OXYGEN or POWER
                },

                // v1.2.1: Scenario inputs for survival calculator (Medical-grade O2 formulas)
                isolationDays: 3,          // 預計孤立天數 (目標)
                // v1.2.1: 醫療級氧氣等效人數公式 (O2 Equivalent Person)
                cannulaCount: 0,           // 鼻導管人數 (0.3人 = 3 L/min)
                maskCount: 0,              // 面罩人數 (0.6人 = 6 L/min)
                ventilatorO2Count: 0,      // 插管/呼吸器人數 (1.0人 = 10 L/min)
                concentratorCount: 0,      // 氧氣濃縮機運轉數 (減少瓶裝氧消耗)
                ventilatorCount: 0,        // 呼吸器運轉數 (影響電力負載)
                useLocalCalculation: false, // 是否使用本地計算模式
                powerLoadBase: 100,        // 基礎電力負載 (W)
                // v1.1.2: 設備單位管理表單
                unitManageForm: {
                    equipment_id: '',
                    equipment_name: '',
                    type_code: '',
                    unit_prefix: '',
                    units: [],
                    inactive_units: [],
                    loading: false,
                    showInactive: false,
                    addForm: {
                        level_percent: 100,
                        status: 'AVAILABLE',
                        reason: ''
                    },
                    removeReason: '',
                    targetQuantity: null
                },

                // Lifecycle
                async init() {
                    if ('serviceWorker' in navigator) {
                        try {
                            await navigator.serviceWorker.register('/biomed/service-worker.js');
                            console.log('[BioMed] Service Worker registered');
                        } catch (err) {
                            console.error('[BioMed] SW registration failed:', err);
                        }
                    }

                    window.addEventListener('online', () => {
                        this.isOnline = true;
                        this.loadEquipment();
                    });
                    window.addEventListener('offline', () => {
                        this.isOnline = false;
                    });

                    await this.loadEquipment();
                    await this.loadResilienceStatus();
                },

                // API Methods
                async loadEquipment() {
                    try {
                        const res = await fetch('/api/equipment');
                        if (res.ok) {
                            this.equipment = await res.json();
                        }
                    } catch (err) {
                        console.error('[BioMed] Failed to load equipment:', err);
                        this.showToast('無法載入設備資料', 'error');
                    }
                },

                async loadResilienceStatus() {
                    try {
                        const res = await fetch('/api/resilience/status');
                        if (res.ok) {
                            const data = await res.json();
                            console.log('[BioMed] Resilience API response:', data);

                            // v1.1.5: 正確解析 API 回傳結構
                            // API 回傳 lifelines 陣列，每個 lifeline 有 inventory.items
                            const oxygenLifelines = (data.lifelines || []).filter(l => l.type === 'OXYGEN');
                            const powerLifelines = (data.lifelines || []).filter(l => l.type === 'POWER');

                            // 計算總時數 (取最大值，因為有多種來源)
                            const oxygenHours = oxygenLifelines.reduce((max, l) => {
                                const h = l.endurance?.effective_hours;
                                return (typeof h === 'number' && h > max) ? h : max;
                            }, 0);
                            const powerHours = powerLifelines.reduce((max, l) => {
                                const h = l.endurance?.effective_hours;
                                return (typeof h === 'number' && h > max) ? h : max;
                            }, 0);

                            // 展平所有 lifelines 的 inventory.items 並映射欄位
                            const oxygenResources = oxygenLifelines.flatMap(l =>
                                (l.inventory?.items || []).map(item => ({
                                    name: item.name,
                                    quantity: item.qty,
                                    fill_pct: item.avg_level,
                                    capacity_L: item.capacity_each
                                }))
                            );

                            // v1.2.3: 獲取個別氧氣瓶單位 (每瓶獨立顯示)
                            const oxygenUnits = await this.loadOxygenUnits();

                            // v1.2.5: 獲取個別電力設備單位 (每台獨立顯示)
                            const powerUnits = await this.loadPowerUnits();

                            const powerResources = powerLifelines.flatMap(l =>
                                (l.inventory?.items || []).map(item => ({
                                    name: item.name,
                                    quantity: item.qty,
                                    // 電源站用 charge_pct，發電機用 fuel_pct
                                    charge_pct: item.device_type === 'POWER_STATION' ? item.avg_level : null,
                                    fuel_pct: item.device_type === 'GENERATOR' ? item.avg_level : null
                                }))
                            );

                            const weakestLifeline = (data.lifelines || []).reduce((min, ll) => {
                                const h = ll.endurance?.effective_hours;
                                if (typeof h !== 'number') return min;
                                if (!min || h < (min.endurance?.effective_hours || Infinity)) return ll;
                                return min;
                            }, null);

                            // v1.1.4: 使用 $nextTick 確保 Alpine 響應式更新
                            this.resilienceStatus = {};
                            await this.$nextTick();

                            this.resilienceStatus = {
                                summary: {
                                    overall_status: data.summary?.overall_status || 'UNKNOWN',
                                    weakest_link: weakestLifeline ? {
                                        hours: weakestLifeline.endurance?.effective_hours || 0,
                                        resource: weakestLifeline.name
                                    } : null
                                },
                                oxygen: { hours: oxygenHours },
                                power: { hours: powerHours },
                                oxygenResources: oxygenResources,
                                oxygenUnits: oxygenUnits,  // v1.2.3: 個別氧氣瓶單位
                                powerResources: powerResources,
                                powerUnits: powerUnits      // v1.2.5: 個別電力設備單位
                            };

                            console.log('[BioMed] Parsed resilience:', {
                                oxygenResources: this.resilienceStatus.oxygenResources,
                                powerResources: this.resilienceStatus.powerResources
                            });
                        }
                    } catch (err) {
                        console.error('[BioMed] Failed to load resilience:', err);
                    }
                },

                // v1.2.6: 載入所有氧氣鋼瓶的個別單位 (每瓶獨立，不含濃縮機和呼吸器)
                async loadOxygenUnits() {
                    try {
                        // 找出氧氣鋼瓶設備 (必須包含「氧氣」或「鋼瓶」，排除濃縮機和呼吸器)
                        const oxygenEquipment = this.equipment.filter(eq => {
                            const name = eq.name || '';
                            const category = eq.category || '';
                            // 必須是氧氣相關設備
                            const isOxygen = name.includes('氧氣') || name.includes('O2') ||
                                            name.includes('鋼瓶') || name.includes('氧瓶');
                            // 排除濃縮機
                            const isConcentrator = name.includes('濃縮機') || name.includes('concentrator');
                            // 排除呼吸器 (ventilator)
                            const isVentilator = name.includes('呼吸器') || name.includes('ventilator');
                            return isOxygen && !isConcentrator && !isVentilator;
                        });

                        const allUnits = [];
                        for (const eq of oxygenEquipment) {
                            try {
                                const res = await fetch(`/api/v2/equipment/${eq.id}/units`);
                                if (res.ok) {
                                    const data = await res.json();
                                    const units = (data.units || []).map(u => ({
                                        ...u,
                                        equipment_id: eq.id,
                                        equipment_name: eq.name,
                                        capacity_L: eq.capacity_L || (eq.name?.includes('H型') ? 6900 : 680),
                                        // v1.2.3: 將 level_percent 轉換為 PSI (H型滿瓶 = 2200 PSI)
                                        psi: Math.round((u.level_percent || 0) / 100 * 2200)
                                    }));
                                    allUnits.push(...units);
                                }
                            } catch (e) {
                                console.warn(`[BioMed] Failed to load units for ${eq.id}:`, e);
                            }
                        }
                        console.log('[BioMed] Loaded oxygen units:', allUnits);
                        return allUnits;
                    } catch (err) {
                        console.error('[BioMed] Failed to load oxygen units:', err);
                        return [];
                    }
                },

                // v1.2.5: 載入所有電力設備的個別單位 (每台獨立顯示)
                async loadPowerUnits() {
                    try {
                        // 找出電力設備
                        const powerEquipment = this.equipment.filter(eq =>
                            eq.category?.includes('電力') ||
                            eq.name?.includes('電源') ||
                            eq.name?.includes('發電') ||
                            eq.name?.includes('UPS')
                        );

                        const allUnits = [];
                        for (const eq of powerEquipment) {
                            try {
                                const res = await fetch(`/api/v2/equipment/${eq.id}/units`);
                                if (res.ok) {
                                    const data = await res.json();
                                    const units = (data.units || []).map(u => ({
                                        ...u,
                                        equipment_id: eq.id,
                                        equipment_name: eq.name
                                    }));
                                    allUnits.push(...units);
                                }
                            } catch (e) {
                                console.warn(`[BioMed] Failed to load power units for ${eq.id}:`, e);
                            }
                        }
                        console.log('[BioMed] Loaded power units:', allUnits);
                        return allUnits;
                    } catch (err) {
                        console.error('[BioMed] Failed to load power units:', err);
                        return [];
                    }
                },

                // v1.2.5: 開啟單位編輯 Modal
                openUnitEditModal(unit, type) {
                    this.unitEditForm = {
                        id: unit.id,
                        equipment_id: unit.equipment_id,
                        equipment_name: unit.equipment_name,
                        unit_label: unit.unit_label || unit.unit_serial || '',
                        level_percent: unit.level_percent || Math.round((unit.psi || 0) / 2200 * 100),
                        status: unit.status || 'AVAILABLE',
                        type: type
                    };
                    this.showUnitEditModal = true;
                },

                // v1.2.5: 儲存單位編輯
                async saveUnitEdit() {
                    try {
                        const res = await fetch(`/api/v2/equipment/units/${this.unitEditForm.id}/check`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                level_percent: this.unitEditForm.level_percent,
                                status: this.unitEditForm.status,
                                remarks: `編輯更新: ${this.unitEditForm.level_percent}%`
                            })
                        });
                        if (res.ok) {
                            this.showToast(`${this.unitEditForm.equipment_name} ${this.unitEditForm.unit_label} 已更新`, 'success');
                            this.showUnitEditModal = false;
                            await this.loadResilienceStatus();
                            this.resilienceRefreshKey++;
                        } else {
                            try {
                                const err = await res.json();
                                const msg = typeof err === 'string' ? err : (err.detail || err.message || JSON.stringify(err));
                                this.showToast(msg, 'error');
                            } catch {
                                this.showToast(`更新失敗 (HTTP ${res.status})`, 'error');
                            }
                        }
                    } catch (err) {
                        console.error('[BioMed] Failed to save unit edit:', err);
                        this.showToast('更新失敗: 網路錯誤', 'error');
                    }
                },

                // v1.2.4: 確認單一氧氣瓶單位 (修復 422 錯誤)
                async confirmOxygenUnit(unit) {
                    try {
                        // API 需要 level_percent (必填), status, remarks
                        const levelPercent = unit.level_percent || Math.round((unit.psi || 0) / 2200 * 100);
                        const res = await fetch(`/api/v2/equipment/units/${unit.id}/check`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                level_percent: levelPercent,
                                status: 'AVAILABLE',
                                remarks: `確認 PSI: ${unit.psi || '-'}`
                            })
                        });
                        if (res.ok) {
                            this.showToast(`${unit.equipment_name} #${unit.unit_label || unit.unit_serial || ''} 已確認`, 'success');
                            await this.loadResilienceStatus();
                            this.resilienceRefreshKey++;
                        } else {
                            // 修復 [object Object] 錯誤訊息
                            try {
                                const err = await res.json();
                                const msg = typeof err === 'string' ? err : (err.detail || err.message || JSON.stringify(err));
                                this.showToast(msg, 'error');
                            } catch {
                                this.showToast(`確認失敗 (HTTP ${res.status})`, 'error');
                            }
                        }
                    } catch (err) {
                        console.error('[BioMed] Failed to confirm oxygen unit:', err);
                        this.showToast('確認失敗: 網路錯誤', 'error');
                    }
                },

                async checkEquipment(eq) {
                    try {
                        const res = await fetch(`/api/equipment/check/${eq.id}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                stationId: 'HC-000000',
                                status: 'NORMAL',
                                powerLevel: eq.power_level || null,
                                remarks: null
                            })
                        });
                        if (res.ok) {
                            // v1.2.1: 使用 refreshKey 強制 DOM 更新
                            const idx = this.equipment.findIndex(e => e.id === eq.id);
                            if (idx !== -1) {
                                this.equipment[idx].status = 'NORMAL';
                                this.equipment[idx].last_checked = new Date().toISOString();
                            }
                            this.showToast(`${eq.name} 已確認`, 'success');
                            // 重新載入並遞增 refreshKey
                            await this.loadEquipment();
                            await this.loadResilienceStatus();
                            this.equipmentRefreshKey++;
                            this.resilienceRefreshKey++;
                        } else {
                            const err = await res.json();
                            this.showToast(err.detail || '確認失敗', 'error');
                        }
                    } catch (err) {
                        console.error('[BioMed] Failed to check equipment:', err);
                        this.showToast('確認失敗', 'error');
                    }
                },

                editEquipment(eq) {
                    this.equipmentForm = {
                        id: eq.id,
                        name: eq.name,
                        category: eq.category || '',
                        quantity: eq.quantity || eq.unit_count || 1,
                        power_level: eq.power_level
                    };
                    this.showEditModal = true;
                },

                async saveEquipment() {
                    if (!this.equipmentForm.id || !this.equipmentForm.name) {
                        this.showToast('請填寫必要欄位', 'warning');
                        return;
                    }

                    try {
                        const method = this.showEditModal ? 'PUT' : 'POST';
                        const url = this.showEditModal
                            ? `/api/equipment/${this.equipmentForm.id}`
                            : '/api/equipment';

                        const res = await fetch(url, {
                            method,
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(this.equipmentForm)
                        });

                        if (res.ok) {
                            this.showToast(this.showEditModal ? '設備已更新' : '設備已新增', 'success');
                            this.showAddModal = false;
                            this.showEditModal = false;
                            this.resetForm();
                            await this.loadEquipment();
                        } else {
                            const err = await res.json();
                            this.showToast(err.detail || '儲存失敗', 'error');
                        }
                    } catch (err) {
                        console.error('[BioMed] Failed to save equipment:', err);
                        this.showToast('儲存失敗', 'error');
                    }
                },

                async deleteEquipment(eq) {
                    if (!confirm(`確定要刪除 "${eq.name}" 嗎？`)) return;

                    try {
                        const res = await fetch(`/api/equipment/${eq.id}`, {
                            method: 'DELETE'
                        });

                        if (res.ok) {
                            this.showToast(`${eq.name} 已刪除`, 'success');
                            await this.loadEquipment();
                        } else {
                            this.showToast('刪除失敗', 'error');
                        }
                    } catch (err) {
                        console.error('[BioMed] Failed to delete equipment:', err);
                        this.showToast('刪除失敗', 'error');
                    }
                },

                resetForm() {
                    this.equipmentForm = {
                        id: '',
                        name: '',
                        category: '',
                        quantity: 1,
                        power_level: null
                    };
                },

                // Helpers
                getPowerSupplyEquipment() {
                    return this.equipment.filter(e =>
                        e.resilience_category === 'POWER' ||
                        e.category === 'power_supply' ||
                        e.category === '電力設備' ||
                        e.id?.startsWith('UTIL-') ||
                        e.name?.includes('發電機') ||
                        e.name?.includes('電池') ||
                        e.name?.includes('電源') ||
                        e.name?.includes('UPS')
                    );
                },

                getPowerConsumingEquipment() {
                    return this.equipment.filter(e =>
                        e.power_consumption > 0 ||
                        e.resilience_category === 'OXYGEN' ||
                        e.category === 'monitoring' ||
                        e.category === 'diagnostic' ||
                        e.category === '診斷設備' ||
                        e.category === '呼吸設備' ||
                        e.name?.includes('監視器') ||
                        e.name?.includes('呼吸器') ||
                        e.name?.includes('氧氣')
                    );
                },

                getNonElectricEquipment() {
                    const powerSupply = this.getPowerSupplyEquipment();
                    const powerConsuming = this.getPowerConsumingEquipment();
                    const excludeIds = new Set([
                        ...powerSupply.map(e => e.id),
                        ...powerConsuming.map(e => e.id)
                    ]);
                    return this.equipment.filter(e => !excludeIds.has(e.id));
                },

                // v1.2.3: 取得氧氣濃縮機設備
                getConcentrators() {
                    return this.equipment.filter(e =>
                        e.name?.includes('濃縮機') ||
                        e.name?.includes('concentrator') ||
                        e.id?.includes('CONC')
                    );
                },

                getPendingCount() {
                    // v1.2.7: 同時考慮 check_status 和 status (設備確認後 status=NORMAL)
                    return this.equipment.filter(e =>
                        (e.check_status === 'UNCHECKED' || e.check_status === 'NO_UNITS') && e.status !== 'NORMAL'
                    ).length;
                },

                getStatusText(status) {
                    const map = {
                        'NORMAL': '正常',
                        'WARNING': '注意',
                        'ERROR': '異常',
                        'UNCHECKED': '未檢',
                        'PENDING': '待確認',
                        'NO_UNITS': '無單位',
                        'CHECKED': '已確認',
                        'PARTIAL': '部分確認'
                    };
                    return map[status] || status || '未知';
                },

                showToast(message, type = 'success') {
                    this.toast = { show: true, message, type };
                    setTimeout(() => {
                        this.toast.show = false;
                    }, 3000);
                },

                // v1.1.2: 單位管理功能
                async openUnitManageModal(eq) {
                    this.unitManageForm.equipment_id = eq.id;
                    this.unitManageForm.equipment_name = eq.name;
                    this.unitManageForm.type_code = eq.type_code || '';
                    this.unitManageForm.loading = true;
                    this.unitManageForm.showInactive = false;
                    this.unitManageForm.units = [];
                    this.unitManageForm.inactive_units = [];
                    this.showUnitManageModal = true;

                    try {
                        const response = await fetch(`/api/v2/equipment/${eq.id}/units?include_inactive=true`);
                        if (response.ok) {
                            const data = await response.json();
                            this.unitManageForm.units = data.units || [];
                            this.unitManageForm.inactive_units = data.inactive_units || [];
                            this.unitManageForm.unit_prefix = data.unit_prefix;
                            this.unitManageForm.targetQuantity = data.active_count || 0;
                        } else {
                            this.showToast('載入單位列表失敗', 'error');
                        }
                    } catch (error) {
                        console.error('[BioMed] 載入設備單位失敗:', error);
                        this.showToast('載入設備單位失敗', 'error');
                    } finally {
                        this.unitManageForm.loading = false;
                    }
                },

                async addUnit() {
                    const equipmentId = this.unitManageForm.equipment_id;
                    const form = this.unitManageForm.addForm;

                    try {
                        const response = await fetch(`/api/v2/equipment/${equipmentId}/units`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                level_percent: parseInt(form.level_percent) || 100,
                                status: form.status || 'AVAILABLE',
                                reason: form.reason || null
                            })
                        });

                        const data = await response.json();

                        if (response.ok) {
                            this.showToast(data.message || '已新增單位', 'success');
                            this.unitManageForm.units.push(data.unit);
                            this.unitManageForm.targetQuantity = data.equipment_summary?.active_unit_count;
                            this.unitManageForm.addForm = { level_percent: 100, status: 'AVAILABLE', reason: '' };
                            await this.loadEquipment();
                            await this.loadResilienceStatus();
                        } else {
                            this.showToast(data.detail || '新增失敗', 'error');
                        }
                    } catch (error) {
                        console.error('[BioMed] 新增單位失敗:', error);
                        this.showToast('新增單位失敗', 'error');
                    }
                },

                async removeUnit(unit) {
                    const reason = this.unitManageForm.removeReason || '演習調整';

                    if (!confirm(`確定要移除「${unit.unit_label || unit.unit_serial}」？\n原因: ${reason}`)) {
                        return;
                    }

                    try {
                        const response = await fetch(`/api/v2/equipment/units/${unit.id}`, {
                            method: 'DELETE',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ reason: reason })
                        });

                        const data = await response.json();

                        if (response.ok) {
                            this.showToast(data.message || '已移除單位', 'success');
                            this.unitManageForm.units = this.unitManageForm.units.filter(u => u.id !== unit.id);
                            this.unitManageForm.inactive_units.unshift({
                                ...unit,
                                is_active: false,
                                removed_at: new Date().toISOString(),
                                removal_reason: reason
                            });
                            this.unitManageForm.targetQuantity = data.equipment_summary?.active_unit_count;
                            await this.loadEquipment();
                            await this.loadResilienceStatus();
                        } else {
                            this.showToast(data.detail || '移除失敗', 'error');
                        }
                    } catch (error) {
                        console.error('[BioMed] 移除單位失敗:', error);
                        this.showToast('移除單位失敗', 'error');
                    }
                },

                async restoreUnit(unit) {
                    if (!confirm(`確定要恢復「${unit.unit_label || unit.unit_serial}」？`)) {
                        return;
                    }

                    try {
                        const response = await fetch(`/api/v2/equipment/units/${unit.id}/restore`, {
                            method: 'POST'
                        });

                        const data = await response.json();

                        if (response.ok) {
                            this.showToast(data.message || '已恢復單位', 'success');
                            this.unitManageForm.inactive_units = this.unitManageForm.inactive_units.filter(u => u.id !== unit.id);
                            this.unitManageForm.units.push({
                                ...unit,
                                is_active: true,
                                removed_at: null,
                                removal_reason: null
                            });
                            this.unitManageForm.targetQuantity = data.equipment_summary?.active_unit_count;
                            await this.loadEquipment();
                            await this.loadResilienceStatus();
                        } else {
                            this.showToast(data.detail || '恢復失敗', 'error');
                        }
                    } catch (error) {
                        console.error('[BioMed] 恢復單位失敗:', error);
                        this.showToast('恢復單位失敗', 'error');
                    }
                },

                async batchAdjustQuantity() {
                    const equipmentId = this.unitManageForm.equipment_id;
                    const target = parseInt(this.unitManageForm.targetQuantity);
                    const current = (this.unitManageForm.units || []).length;

                    if (target === current) {
                        this.showToast('數量未變更', 'warning');
                        return;
                    }

                    const action = target > current ? '新增' : '移除';
                    const diff = Math.abs(target - current);

                    if (!confirm(`確定要${action} ${diff} 個單位？\n(${current} → ${target})`)) {
                        return;
                    }

                    try {
                        const response = await fetch(`/api/v2/equipment/${equipmentId}/quantity`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                target_quantity: target,
                                reason: '批次數量調整'
                            })
                        });

                        const data = await response.json();

                        if (response.ok) {
                            this.showToast(data.message || '調整完成', 'success');
                            await this.openUnitManageModal({
                                id: equipmentId,
                                name: this.unitManageForm.equipment_name,
                                type_code: this.unitManageForm.type_code
                            });
                            await this.loadEquipment();
                            await this.loadResilienceStatus();
                        } else {
                            this.showToast(data.detail || '調整失敗', 'error');
                        }
                    } catch (error) {
                        console.error('[BioMed] 批次調整失敗:', error);
                        this.showToast('批次調整失敗', 'error');
                    }
                },

                getUnitStatusClass(status) {
                    const classes = {
                        'AVAILABLE': 'bg-green-100 text-green-800',
                        'IN_USE': 'bg-blue-100 text-blue-800',
                        'CHARGING': 'bg-yellow-100 text-yellow-800',
                        'MAINTENANCE': 'bg-gray-100 text-gray-800',
                        'EMPTY': 'bg-red-100 text-red-800'
                    };
                    return classes[status] || 'bg-gray-100 text-gray-800';
                },

                // v1.2.1: Survival Calculator Methods (Medical-grade O2 formulas)
                getO2EquivalentPersons() {
                    // 醫療級氧氣等效人數公式
                    // Cannula (鼻導管): 0.3人 = 3 L/min
                    // Mask (面罩): 0.6人 = 6 L/min
                    // Ventilator (插管): 1.0人 = 10 L/min
                    return (this.cannulaCount * 0.3) + (this.maskCount * 0.6) + (this.ventilatorO2Count * 1.0);
                },

                getOxygenConsumptionLPM() {
                    // 等效人數 x 10 L/min/人 - 濃縮機節省量
                    // 濃縮機每台可產出 5 L/min，減少瓶裝氧消耗
                    const equivalentPersons = this.getO2EquivalentPersons();
                    const baseConsumption = equivalentPersons * 10; // 10 L/min per person
                    const concentratorSaving = this.concentratorCount * 5; // 5 L/min per concentrator
                    return Math.max(0, baseConsumption - concentratorSaving);
                },

                getPowerLoadWatts() {
                    // 基礎負載 100W + 每台呼吸器 50W
                    return this.powerLoadBase + (this.ventilatorCount * 50);
                },

                getOxygenHours() {
                    if (this.useLocalCalculation) {
                        // 本地計算: 從設備資源列表計算
                        const oxygenResources = this.resilienceStatus.oxygenResources || [];
                        let totalLiters = 0;

                        for (const res of oxygenResources) {
                            // 計算每種資源的有效容量
                            const qty = res.quantity || 1;
                            const capacity = res.capacity_L || 6800; // 預設 H 型鋼瓶容量
                            const fillPct = (res.fill_pct || 100) / 100;
                            totalLiters += qty * capacity * fillPct;
                        }

                        // 無資源時使用預設值
                        if (totalLiters === 0) totalLiters = 6800 * 5 * 0.8; // 5瓶 80%

                        const consumptionLPM = this.getOxygenConsumptionLPM();
                        return totalLiters / consumptionLPM / 60;
                    } else {
                        // 使用伺服器計算結果
                        return this.resilienceStatus.oxygen?.hours || 0;
                    }
                },

                getPowerHours() {
                    if (this.useLocalCalculation) {
                        // 本地計算: 從設備資源列表計算
                        const powerResources = this.resilienceStatus.powerResources || [];
                        let totalWh = 0;

                        for (const res of powerResources) {
                            const qty = res.quantity || 1;
                            // 電池類設備假設平均 1800Wh (Bluetti AC180 級別)
                            // 發電機假設 50L 油箱, 3L/hr, ~17h
                            const chargePct = (res.charge_pct || res.fuel_pct || 100) / 100;
                            const capacityWh = res.capacity_Wh || 1800;
                            totalWh += qty * capacityWh * chargePct;
                        }

                        // 無資源時使用預設值
                        if (totalWh === 0) totalWh = 1800 * 2 * 0.85; // 2台 85%

                        const loadWatts = this.getPowerLoadWatts();
                        return totalWh / loadWatts;
                    } else {
                        // 使用伺服器計算結果
                        return this.resilienceStatus.power?.hours || 0;
                    }
                },

                getCalculatedSurvivalHours() {
                    const oxygenHours = this.getOxygenHours();
                    const powerHours = this.getPowerHours();
                    return Math.min(oxygenHours, powerHours);
                },

                getBottleneckResource() {
                    const oxygenHours = this.getOxygenHours();
                    const powerHours = this.getPowerHours();
                    if (oxygenHours <= powerHours) {
                        return '氧氣供應';
                    } else {
                        return '電力供應';
                    }
                },

                // v1.2.1: 從韌性估算 Tab 直接確認資源
                async confirmResourceFromResilience(res, type) {
                    // 在 equipment 陣列中找到對應的設備
                    const eq = this.equipment.find(e =>
                        e.name === res.name ||
                        e.name.includes(res.name) ||
                        res.name.includes(e.name)
                    );

                    if (eq) {
                        await this.checkEquipment(eq);
                        // 使用 refreshKey 模式強制 DOM 更新
                        this.resilienceRefreshKey++;
                    } else {
                        // 如果找不到對應設備，仍然刷新資料
                        this.showToast(`${res.name} 已確認`, 'success');
                        await this.loadResilienceStatus();
                        this.resilienceRefreshKey++;
                    }
                },

                // v1.1.4: 更新單位電量/氧氣%
                async updateUnitLevel(unit) {
                    const newLevel = parseInt(unit.editLevel) || 0;
                    try {
                        const response = await fetch(`/api/v2/equipment/units/${unit.id}/check`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                level_percent: newLevel,
                                status: unit.status || 'AVAILABLE'
                            })
                        });

                        if (response.ok) {
                            unit.level_percent = newLevel;
                            unit.last_check = new Date().toISOString();
                            unit.editing = false;
                            this.showToast(`已更新電量至 ${newLevel}%`, 'success');
                            await this.loadEquipment();
                            await this.loadResilienceStatus();
                        } else {
                            const err = await response.json();
                            this.showToast(err.detail || '更新失敗', 'error');
                        }
                    } catch (error) {
                        console.error('[BioMed] 更新單位電量失敗:', error);
                        this.showToast('更新失敗', 'error');
                    }
                },

                // v1.1.4: 確認單一單位
                async checkUnit(unit) {
                    try {
                        const response = await fetch(`/api/v2/equipment/units/${unit.id}/check`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                level_percent: unit.level_percent || 100,
                                status: unit.status || 'AVAILABLE'
                            })
                        });

                        if (response.ok) {
                            unit.last_check = new Date().toISOString();
                            this.showToast(`${unit.unit_label || unit.unit_serial} 已確認`, 'success');
                            await this.loadEquipment();
                            await this.loadResilienceStatus();
                        } else {
                            const err = await response.json();
                            this.showToast(err.detail || '確認失敗', 'error');
                        }
                    } catch (error) {
                        console.error('[BioMed] 確認單位失敗:', error);
                        this.showToast('確認失敗', 'error');
                    }
                },

                // v1.1.5: 更新單位狀態
                async updateUnitStatus(unit) {
                    try {
                        const response = await fetch(`/api/v2/equipment/units/${unit.id}/check`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                level_percent: unit.level_percent || 100,
                                status: unit.status
                            })
                        });

                        if (response.ok) {
                            unit.last_check = new Date().toISOString();
                            this.showToast(`狀態已更新為 ${unit.status}`, 'success');
                            await this.loadEquipment();
                            await this.loadResilienceStatus();
                        } else {
                            const err = await response.json();
                            this.showToast(err.detail || '更新失敗', 'error');
                        }
                    } catch (error) {
                        console.error('[BioMed] 更新單位狀態失敗:', error);
                        this.showToast('更新失敗', 'error');
                    }
                }
            };
        }
    </script>
</body>
</html>
