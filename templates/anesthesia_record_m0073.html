<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>麻醉紀錄單 M0073</title>
    <style>
        @page {
            size: A4 landscape;
            margin: 6mm;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: "Noto Sans TC", "Microsoft JhengHei", "PingFang TC", sans-serif;
            font-size: 8pt;
            line-height: 1.2;
            color: #000;
        }

        .page {
            width: 100%;
            page-break-after: always;
            position: relative;
        }

        .page:last-child {
            page-break-after: auto;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            border-bottom: 2px solid #000;
            padding-bottom: 3px;
            margin-bottom: 3px;
        }

        .hospital-info {
            text-align: left;
        }

        .hospital-name {
            font-size: 12pt;
            font-weight: bold;
        }

        .form-title {
            font-size: 14pt;
            font-weight: bold;
            text-align: center;
            flex: 1;
        }

        .form-code {
            text-align: right;
            font-size: 7pt;
        }

        .page-indicator {
            font-size: 9pt;
            font-weight: bold;
        }

        /* Top Info Bar - 2 rows */
        .info-bar {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 3px;
            margin-bottom: 3px;
        }

        .info-left, .info-right {
            border: 1px solid #000;
            padding: 2px 4px;
            font-size: 7pt;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 2px;
        }

        .info-item {
            display: flex;
        }

        .info-label {
            font-weight: bold;
            margin-right: 3px;
            white-space: nowrap;
        }

        /* Main Content - 3 columns */
        .main-content {
            display: grid;
            grid-template-columns: 85px 1fr 130px;
            gap: 2px;
            min-height: 320px;
        }

        /* Left Column: Drugs + Agents */
        .left-column {
            display: flex;
            flex-direction: column;
            gap: 2px;
            font-size: 5pt;
        }

        .section-box {
            border: 1px solid #000;
        }

        .section-title {
            background: #d0d0d0;
            padding: 1px 3px;
            font-weight: bold;
            text-align: center;
            border-bottom: 1px solid #000;
            font-size: 6pt;
        }

        .drug-list {
            padding: 1px;
            max-height: 120px;
            overflow: hidden;
        }

        .drug-row {
            display: flex;
            border-bottom: 1px solid #eee;
            padding: 1px 0;
        }

        .drug-time {
            width: 22px;
            text-align: center;
            color: #666;
        }

        .drug-name {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .drug-dose {
            width: 30px;
            text-align: right;
        }

        /* Agent Settings */
        .agent-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 5pt;
        }

        .agent-table th, .agent-table td {
            border: 1px solid #ccc;
            padding: 1px;
            text-align: center;
        }

        .agent-table th {
            background: #e8e8e8;
        }

        /* Center Column: Chart + Vitals Table */
        .center-column {
            display: flex;
            flex-direction: column;
            gap: 2px;
            min-width: 0; /* Allow shrinking in grid */
            width: 100%;
        }

        /* Chart Section */
        .chart-section {
            border: 1px solid #000;
            border-bottom: none;
            background: #fff;
            padding: 0;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            font-size: 6pt;
            padding: 1px 2px;
            background: #f8f8f8;
        }

        .chart-section svg {
            width: 100%;
            display: block;
        }

        .chart-section img {
            width: 100%;
            height: auto;
            max-height: 120px;
            object-fit: contain;
        }

        /* Vent Settings inline */
        .vent-inline {
            font-size: 5pt;
            color: #666;
            padding: 2px;
            border-top: 1px solid #eee;
        }

        /* Vitals Table */
        .vitals-section {
            border: 1px solid #000;
            width: 100%;
        }

        .vitals-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 5pt;
            table-layout: fixed;
        }

        .vitals-table th, .vitals-table td {
            border: 1px solid #ccc;
            padding: 0 1px;
            text-align: center;
            height: 12px;
            overflow: hidden;
        }

        .vitals-table th {
            background: #f0f0f0;
            font-weight: bold;
        }

        .vitals-table .row-header {
            background: #e0e0e0;
            text-align: left;
            font-weight: bold;
            width: 4%;
            white-space: nowrap;
            font-size: 5pt;
        }

        .vitals-table .hour-row th {
            background: #b0b0b0;
            font-size: 6pt;
        }

        .vitals-table .min-row td {
            background: #d8d8d8;
            font-size: 5pt;
        }

        .bp-sys { color: #c00; }
        .bp-dia { color: #00c; }
        .hr-val { color: #060; }

        /* Right Column: Info Panels */
        .right-column {
            display: flex;
            flex-direction: column;
            gap: 2px;
            font-size: 6pt;
        }

        .info-panel {
            border: 1px solid #000;
            padding: 2px;
        }

        .panel-title {
            background: #d0d0d0;
            margin: -2px -2px 2px -2px;
            padding: 1px 3px;
            font-weight: bold;
            text-align: center;
            border-bottom: 1px solid #000;
            font-size: 6pt;
        }

        /* Monitors Grid */
        .monitors-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1px;
            font-size: 5pt;
        }

        .monitor-item {
            display: flex;
            align-items: center;
            gap: 2px;
        }

        .checkbox {
            width: 8px;
            height: 8px;
            border: 1px solid #000;
            display: inline-block;
            font-size: 6pt;
            line-height: 6px;
            text-align: center;
        }

        .checkbox.checked {
            background: #000;
            color: #fff;
        }

        /* I/O Table */
        .io-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 5pt;
        }

        .io-table th, .io-table td {
            border: 1px solid #999;
            padding: 1px 2px;
        }

        .io-table th {
            background: #f0f0f0;
            text-align: left;
            width: 40px;
        }

        .io-table td {
            text-align: right;
        }

        .io-table .total-row {
            background: #e8e8e8;
            font-weight: bold;
        }

        .io-table .balance-row {
            background: #fffbeb;
            font-weight: bold;
        }

        /* IV Table */
        .iv-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 5pt;
        }

        .iv-table th, .iv-table td {
            border: 1px solid #999;
            padding: 1px 2px;
        }

        .iv-table th {
            background: #f0f0f0;
            text-align: center;
        }

        /* Lab Data Table */
        .lab-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 5pt;
        }

        .lab-table th, .lab-table td {
            border: 1px solid #999;
            padding: 1px;
            text-align: center;
        }

        .lab-table th {
            background: #e8e8e8;
        }

        .lab-table .time-header {
            background: #d0d0d0;
            font-weight: bold;
        }

        /* Footer */
        .footer {
            margin-top: 3px;
            border-top: 1px solid #000;
            padding-top: 3px;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            font-size: 7pt;
        }

        .signature-box {
            border: 1px solid #000;
            padding: 3px;
            min-height: 30px;
        }

        .signature-label {
            font-weight: bold;
            border-bottom: 1px dashed #999;
            margin-bottom: 3px;
            font-size: 6pt;
        }

        /* Print */
        @media print {
            body {
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
        }
    </style>
</head>
<body>
{% for page in pages %}
<div class="page">
    <!-- Header -->
    <div class="header">
        <div class="hospital-info">
            <div class="hospital-name">{{ hospital_name }}</div>
            {% if hospital_address and 'annotation=' not in (hospital_address|string) %}<div style="font-size:7pt;">{{ hospital_address }}</div>{% endif %}
        </div>
        <div class="form-title">
            麻醉紀錄 ANESTHETIC RECORD
            <div class="page-indicator">p{{ page.page_number }}/{{ total_pages }}</div>
        </div>
        <div class="form-code">
            <div>M0073</div>
            <div>{{ patient.chart_no }}</div>
            <div>{{ case_id }}</div>
        </div>
    </div>

    <!-- Info Bar (only on first page) -->
    {% if page.page_number == 1 %}
    <div class="info-bar">
        <div class="info-left">
            <div class="info-grid">
                <div class="info-item"><span class="info-label">姓名:</span>{{ patient.name }}</div>
                <div class="info-item"><span class="info-label">性別:</span>{{ patient.gender }}</div>
                <div class="info-item"><span class="info-label">年齡:</span>{{ patient.age }}</div>
                <div class="info-item"><span class="info-label">ASA:</span>{{ patient.asa_class }}</div>
                <div class="info-item"><span class="info-label">體重:</span>{{ patient.weight }}kg</div>
                <div class="info-item"><span class="info-label">身高:</span>{{ patient.height }}cm</div>
                <div class="info-item"><span class="info-label">血型:</span>{{ patient.blood_type }}</div>
                <div class="info-item"><span class="info-label">OR:</span>{{ surgery.or_room }}</div>
            </div>
            <div style="margin-top:2px;">
                <strong>麻醉:</strong>
                {% if technique == 'GA_ETT' %}☑GA(ETT){% else %}☐GA(ETT){% endif %}
                {% if technique == 'GA_LMA' %}☑GA(LMA){% else %}☐GA(LMA){% endif %}
                {% if technique == 'RA_SPINAL' %}☑Spinal{% else %}☐Spinal{% endif %}
                {% if technique == 'RA_EPIDURAL' %}☑Epidural{% else %}☐Epidural{% endif %}
                {% if technique == 'RA_BLOCK' %}☑Block{% else %}☐Block{% endif %}
            </div>
        </div>
        <div class="info-right">
            <div class="info-grid">
                <div class="info-item" style="grid-column: span 2;"><span class="info-label">Dx:</span>{{ diagnosis }}</div>
                <div class="info-item"><span class="info-label">Hb:</span>{{ preop_hb or '-' }}</div>
                <div class="info-item"><span class="info-label">K:</span>{{ preop_k or '-' }}</div>
                <div class="info-item" style="grid-column: span 2;"><span class="info-label">Op:</span>{{ operation }}</div>
                <div class="info-item"><span class="info-label">Ht:</span>{{ preop_ht or '-' }}%</div>
                <div class="info-item"><span class="info-label">Na:</span>{{ preop_na or '-' }}</div>
            </div>
            <div style="margin-top:2px;">
                <span class="info-label">預估失血:</span>{{ estimated_blood_loss or '-' }}mL
                <span class="info-label" style="margin-left:10px;">備血:</span>{{ blood_prepared or '-' }} {{ blood_prepared_units or '' }}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Main Content -->
    <div class="main-content">
        <!-- Left: Drugs + Agents -->
        <div class="left-column">
            <!-- Drugs -->
            <div class="section-box" style="flex:1;">
                <div class="section-title">藥物 Drugs</div>
                <div class="drug-list">
                    {% for drug in page.drugs %}
                    <div class="drug-row">
                        <span class="drug-time">{{ drug.time }}</span>
                        <span class="drug-name">{{ drug.name }}</span>
                        <span class="drug-dose">{{ drug.dose }}</span>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Agent Settings -->
            {% if agent_settings and agent_settings|length > 0 %}
            <div class="section-box">
                <div class="section-title">Agents</div>
                <table class="agent-table">
                    <tr>
                        <th>Time</th>
                        <th>O2</th>
                        <th>Sevo%</th>
                    </tr>
                    {% for a in agent_settings[:6] %}
                    <tr>
                        <td>{% if a.time %}{{ a.time[11:16] }}{% endif %}</td>
                        <td>{{ a.o2_flow or '-' }}</td>
                        <td>{{ a.sevo_percent or '-' }}</td>
                    </tr>
                    {% endfor %}
                </table>
            </div>
            {% endif %}
        </div>

        <!-- Center: Chart + Vitals Table -->
        <div class="center-column">
            <!-- Chart -->
            <div class="chart-section">
                <div class="chart-header">
                    <span><strong>Vital Signs</strong> (p{{ page.page_number }})</span>
                    <span>SBP:<span style="color:#c00;">●</span> DBP:<span style="color:#00c;">●</span> HR:<span style="color:#060;">■</span></span>
                </div>

                {% if page.chart_image %}
                <img src="data:image/png;base64,{{ page.chart_image }}" alt="Vital Signs Chart">
                {% elif page.vitals and page.vitals|length > 0 %}
                {# Calculate column positions to match table layout #}
                {# Table: row-header=28px fixed, data columns=equal width #}
                {# SVG: Y-axis=4% of width, data area=96% of width #}
                {% set vc = page.vitals|length %}
                {% set yaxis_pct = 4 %}
                {% set data_pct = 96 %}
                {% set col_pct = data_pct / vc %}
                <svg viewBox="0 0 100 100" preserveAspectRatio="none" style="width:100%; height:120px; display:block;">
                    <rect x="0" y="0" width="100" height="100" fill="#fafafa"/>

                    <!-- Y-axis labels (outside main chart area) -->
                    <text x="{{ yaxis_pct - 0.5 }}" y="5" text-anchor="end" font-size="2.5" fill="#666">200</text>
                    <text x="{{ yaxis_pct - 0.5 }}" y="27" text-anchor="end" font-size="2.5" fill="#666">150</text>
                    <text x="{{ yaxis_pct - 0.5 }}" y="50" text-anchor="end" font-size="2.5" fill="#666">100</text>
                    <text x="{{ yaxis_pct - 0.5 }}" y="73" text-anchor="end" font-size="2.5" fill="#666">50</text>

                    <!-- Y-axis line -->
                    <line x1="{{ yaxis_pct }}" y1="0" x2="{{ yaxis_pct }}" y2="95" stroke="#999" stroke-width="0.2"/>

                    <!-- Horizontal grid lines -->
                    <line x1="{{ yaxis_pct }}" y1="27" x2="100" y2="27" stroke="#ddd" stroke-width="0.1"/>
                    <line x1="{{ yaxis_pct }}" y1="50" x2="100" y2="50" stroke="#ccc" stroke-width="0.15" stroke-dasharray="1,1"/>
                    <line x1="{{ yaxis_pct }}" y1="73" x2="100" y2="73" stroke="#ddd" stroke-width="0.1"/>
                    <line x1="{{ yaxis_pct }}" y1="95" x2="100" y2="95" stroke="#999" stroke-width="0.2"/>

                    <!-- Vertical grid lines for each column -->
                    {% for v in page.vitals %}
                    {% set col_x = yaxis_pct + loop.index0 * col_pct %}
                    <line x1="{{ col_x }}" y1="0" x2="{{ col_x }}" y2="95" stroke="#eee" stroke-width="0.1"/>
                    {% endfor %}

                    <!-- SBP line (red) -->
                    <polyline fill="none" stroke="#dc2626" stroke-width="0.4"
                        points="{% for v in page.vitals %}{% if v.sbp %}{{ yaxis_pct + loop.index0 * col_pct + col_pct/2 }},{{ 95 - (v.sbp / 200 * 90) }}{% if not loop.last %} {% endif %}{% endif %}{% endfor %}"/>

                    <!-- DBP line (blue) -->
                    <polyline fill="none" stroke="#2563eb" stroke-width="0.4"
                        points="{% for v in page.vitals %}{% if v.dbp %}{{ yaxis_pct + loop.index0 * col_pct + col_pct/2 }},{{ 95 - (v.dbp / 200 * 90) }}{% if not loop.last %} {% endif %}{% endif %}{% endfor %}"/>

                    <!-- HR line (green, dashed) -->
                    <polyline fill="none" stroke="#16a34a" stroke-width="0.3" stroke-dasharray="1,0.5"
                        points="{% for v in page.vitals %}{% if v.hr %}{{ yaxis_pct + loop.index0 * col_pct + col_pct/2 }},{{ 95 - (v.hr / 200 * 90) }}{% if not loop.last %} {% endif %}{% endif %}{% endfor %}"/>

                    <!-- Data points at column centers -->
                    {% for v in page.vitals %}
                        {% set xp = yaxis_pct + loop.index0 * col_pct + col_pct/2 %}
                        {% if v.sbp %}<circle cx="{{ xp }}" cy="{{ 95 - (v.sbp / 200 * 90) }}" r="0.6" fill="#dc2626"/>{% endif %}
                        {% if v.dbp %}<circle cx="{{ xp }}" cy="{{ 95 - (v.dbp / 200 * 90) }}" r="0.6" fill="#2563eb"/>{% endif %}
                        {% if v.hr %}<rect x="{{ xp - 0.4 }}" y="{{ 95 - (v.hr / 200 * 90) - 0.4 }}" width="0.8" height="0.8" fill="#16a34a"/>{% endif %}
                    {% endfor %}
                </svg>
                {% endif %}

            </div>

            <!-- Vitals Table -->
            <div class="vitals-section">
                <table class="vitals-table">
                    <tr class="hour-row">
                        <th class="row-header">Hr</th>
                        {% for v in page.vitals %}
                        <th>{% if v.show_hour %}{{ v.hour }}{% endif %}</th>
                        {% endfor %}
                    </tr>
                    <tr class="min-row">
                        <td class="row-header">:mm</td>
                        {% for v in page.vitals %}<td>{{ v.minute }}</td>{% endfor %}
                    </tr>
                    <tr>
                        <td class="row-header">SBP</td>
                        {% for v in page.vitals %}<td class="bp-sys">{{ v.sbp or '-' }}</td>{% endfor %}
                    </tr>
                    <tr>
                        <td class="row-header">DBP</td>
                        {% for v in page.vitals %}<td class="bp-dia">{{ v.dbp or '-' }}</td>{% endfor %}
                    </tr>
                    <tr>
                        <td class="row-header">HR</td>
                        {% for v in page.vitals %}<td class="hr-val">{{ v.hr or '-' }}</td>{% endfor %}
                    </tr>
                    <tr>
                        <td class="row-header">SpO2</td>
                        {% for v in page.vitals %}<td>{{ v.spo2 or '-' }}</td>{% endfor %}
                    </tr>
                    <tr>
                        <td class="row-header">CO2</td>
                        {% for v in page.vitals %}<td>{{ v.etco2 or '-' }}</td>{% endfor %}
                    </tr>
                    <tr>
                        <td class="row-header">T°</td>
                        {% for v in page.vitals %}<td>{{ v.temp or '-' }}</td>{% endfor %}
                    </tr>
                </table>
            </div>
        </div>

        <!-- Right: Info Panels -->
        <div class="right-column">
            <!-- Monitors -->
            <div class="info-panel">
                <div class="panel-title">Monitors</div>
                <div class="monitors-grid">
                    {% set monitor_types = ['EKG', 'NIBP', 'SpO2', 'ETCO2', 'ART', 'CVP', 'FOLEY', 'TEMP', 'AIR_BLANKET'] %}
                    {% set active_monitors = monitors|map(attribute='type')|list %}
                    {% for m in monitor_types %}
                    <div class="monitor-item">
                        <span class="checkbox {% if m in active_monitors %}checked{% endif %}">{% if m in active_monitors %}✓{% endif %}</span>
                        <span>{{ m }}</span>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- IV Lines -->
            <div class="info-panel">
                <div class="panel-title">IV Lines</div>
                <table class="iv-table">
                    {% for iv in iv_lines %}
                    <tr>
                        <td>{{ iv.line_number }}</td>
                        <td>{{ iv.site }}</td>
                        <td>{{ iv.gauge }}</td>
                    </tr>
                    {% endfor %}
                </table>
            </div>

            <!-- I/O Balance -->
            <div class="info-panel">
                <div class="panel-title">I/O Balance</div>
                <table class="io-table">
                    <tr><th>晶體</th><td>{{ io_balance.input.crystalloid_ml }}</td></tr>
                    <tr><th>膠體</th><td>{{ io_balance.input.colloid_ml }}</td></tr>
                    <tr><th>血品</th><td>{{ io_balance.input.blood_ml }}</td></tr>
                    <tr class="total-row"><th>In</th><td>{{ io_balance.input.total_ml }}</td></tr>
                    <tr><th>尿量</th><td>{{ io_balance.output.urine_ml }}</td></tr>
                    <tr><th>失血</th><td>{{ io_balance.output.blood_loss_ml }}</td></tr>
                    <tr class="total-row"><th>Out</th><td>{{ io_balance.output.total_ml }}</td></tr>
                    <tr class="balance-row"><th>Net</th><td>{{ io_balance.balance_ml }}</td></tr>
                </table>
            </div>

            <!-- Lab Data (if available) -->
            {% if lab_data and lab_data|length > 0 %}
            <div class="info-panel">
                <div class="panel-title">Lab Data</div>
                <table class="lab-table">
                    <tr class="time-header">
                        <th></th>
                        {% for l in lab_data[:4] %}
                        <th>{% if l.time %}{{ l.time[11:16] }}{% endif %}</th>
                        {% endfor %}
                    </tr>
                    <tr><th>Hb</th>{% for l in lab_data[:4] %}<td>{{ l.hb or '-' }}</td>{% endfor %}</tr>
                    <tr><th>pH</th>{% for l in lab_data[:4] %}<td>{{ l.ph or '-' }}</td>{% endfor %}</tr>
                    <tr><th>K</th>{% for l in lab_data[:4] %}<td>{{ l.k or '-' }}</td>{% endfor %}</tr>
                    <tr><th>Glu</th>{% for l in lab_data[:4] %}<td>{{ l.glucose or '-' }}</td>{% endfor %}</tr>
                </table>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Footer (only on last page) -->
    {% if page.page_number == total_pages %}
    <div class="footer">
        <div class="signature-box">
            <div class="signature-label">麻醉: {{ times.anesthesia_start or '__:__' }} - {{ times.anesthesia_end or '__:__' }}</div>
        </div>
        <div class="signature-box">
            <div class="signature-label">手術: {{ times.surgery_start or '__:__' }} - {{ times.surgery_end or '__:__' }}</div>
        </div>
        <div class="signature-box">
            <div class="signature-label">麻醉醫師: {{ anesthesiologist or '' }}</div>
        </div>
        <div class="signature-box">
            <div class="signature-label">護理師: {{ nurse or '' }}</div>
        </div>
    </div>
    <div style="text-align: center; font-size: 6pt; color: #666; margin-top: 2px;">
        Generated by MIRS Anesthesia Module v2.2 | {{ generated_at }}
    </div>
    {% endif %}
</div>
{% endfor %}
</body>
</html>
