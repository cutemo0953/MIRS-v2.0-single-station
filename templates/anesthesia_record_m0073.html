<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>麻醉紀錄單 M0073</title>
    <style>
        @page {
            size: A4 landscape;
            margin: 8mm;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: "Noto Sans TC", "Microsoft JhengHei", "PingFang TC", sans-serif;
            font-size: 9pt;
            line-height: 1.3;
            color: #000;
        }

        .page {
            width: 100%;
            page-break-after: always;
            position: relative;
        }

        .page:last-child {
            page-break-after: auto;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            border-bottom: 2px solid #000;
            padding-bottom: 4px;
            margin-bottom: 4px;
        }

        .hospital-info {
            text-align: left;
        }

        .hospital-name {
            font-size: 14pt;
            font-weight: bold;
        }

        .form-title {
            font-size: 16pt;
            font-weight: bold;
            text-align: center;
            flex: 1;
        }

        .form-code {
            text-align: right;
            font-size: 8pt;
        }

        .page-indicator {
            font-size: 10pt;
            font-weight: bold;
        }

        /* Patient Info */
        .patient-info {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 2px;
            border: 1px solid #000;
            padding: 4px;
            margin-bottom: 4px;
            font-size: 8pt;
        }

        .patient-info .item {
            display: flex;
        }

        .patient-info .label {
            font-weight: bold;
            margin-right: 4px;
        }

        /* Technique Section */
        .technique-section {
            border: 1px solid #000;
            padding: 3px;
            font-size: 7pt;
            margin-bottom: 4px;
        }

        .technique-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 2px;
        }

        .technique-item {
            display: flex;
            align-items: center;
            gap: 2px;
        }

        .checkbox {
            width: 10px;
            height: 10px;
            border: 1px solid #000;
            display: inline-block;
        }

        .checkbox.checked {
            background: #000;
        }

        .checkbox.checked::after {
            content: "✓";
            color: #fff;
            font-size: 8pt;
            position: relative;
            left: 1px;
            top: -2px;
        }

        /* ========== NEW LAYOUT: Chart First ========== */

        /* Large Chart Section (Main) */
        .chart-main {
            border: 2px solid #000;
            background: #fff;
            padding: 8px;
            margin-bottom: 4px;
            min-height: 200px;
        }

        .chart-main svg {
            width: 100%;
            height: 200px;
        }

        .chart-main img {
            width: 100%;
            height: auto;
            max-height: 200px;
            object-fit: contain;
        }

        .chart-title {
            font-weight: bold;
            font-size: 10pt;
            text-align: center;
            margin-bottom: 4px;
            border-bottom: 1px solid #ccc;
            padding-bottom: 2px;
        }

        .chart-legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            font-size: 8pt;
            margin-top: 4px;
            padding-top: 4px;
            border-top: 1px solid #eee;
        }

        .chart-legend-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .legend-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        .legend-square {
            width: 10px;
            height: 10px;
        }

        /* Bottom Section: 3 columns */
        .bottom-content {
            display: grid;
            grid-template-columns: 150px 1fr 180px;
            gap: 4px;
        }

        /* Left Column: Drugs */
        .drugs-column {
            border: 1px solid #000;
            font-size: 7pt;
        }

        .section-title {
            background: #e0e0e0;
            padding: 2px 4px;
            font-weight: bold;
            text-align: center;
            border-bottom: 1px solid #000;
            font-size: 8pt;
        }

        .drug-table {
            width: 100%;
            border-collapse: collapse;
        }

        .drug-table th, .drug-table td {
            border: 1px solid #999;
            padding: 1px 2px;
            text-align: center;
        }

        .drug-table th {
            background: #f0f0f0;
        }

        /* Middle Column: Compact Vitals Table */
        .vitals-column {
            border: 1px solid #000;
            overflow-x: auto;
        }

        .vitals-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 6pt;
        }

        .vitals-table th, .vitals-table td {
            border: 1px solid #ccc;
            padding: 1px 2px;
            text-align: center;
            min-width: 18px;
        }

        .vitals-table th {
            background: #f5f5f5;
            font-weight: bold;
        }

        .vitals-table .row-header {
            background: #e8e8e8;
            text-align: left;
            font-weight: bold;
            width: 40px;
            white-space: nowrap;
            font-size: 6pt;
        }

        .vitals-table .time-row {
            background: #d0d0d0;
            font-weight: bold;
        }

        .bp-systolic { color: #c00; }
        .bp-diastolic { color: #00c; }
        .hr-value { color: #060; }

        /* Right Column: IV + I/O */
        .io-column {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .iv-section, .io-section {
            border: 1px solid #000;
            font-size: 7pt;
        }

        .iv-table, .io-table {
            width: 100%;
            border-collapse: collapse;
        }

        .iv-table th, .iv-table td,
        .io-table th, .io-table td {
            border: 1px solid #999;
            padding: 1px 3px;
        }

        .io-table th {
            background: #f0f0f0;
            text-align: left;
        }

        .io-table td {
            text-align: right;
        }

        /* Footer */
        .footer {
            margin-top: 4px;
            border-top: 1px solid #000;
            padding-top: 4px;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            font-size: 8pt;
        }

        .signature-box {
            border: 1px solid #000;
            padding: 4px;
            min-height: 40px;
        }

        .signature-label {
            font-weight: bold;
            border-bottom: 1px dashed #999;
            margin-bottom: 4px;
        }

        /* Print Adjustments */
        @media print {
            body {
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
        }
    </style>
</head>
<body>
{% for page in pages %}
<div class="page">
    <!-- Header -->
    <div class="header">
        <div class="hospital-info">
            <div class="hospital-name">{{ hospital_name }}</div>
            <div>{{ hospital_address }}</div>
        </div>
        <div class="form-title">
            麻醉紀錄單
            <div class="page-indicator">第 {{ page.page_number }} 頁 / 共 {{ total_pages }} 頁</div>
        </div>
        <div class="form-code">
            <div>M0073</div>
            <div>病歷號: {{ patient.chart_no }}</div>
            <div>Case: {{ case_id }}</div>
        </div>
    </div>

    <!-- Patient Info (only on first page) -->
    {% if page.page_number == 1 %}
    <div class="patient-info">
        <div class="item"><span class="label">姓名:</span>{{ patient.name }}</div>
        <div class="item"><span class="label">性別:</span>{{ patient.gender }}</div>
        <div class="item"><span class="label">年齡:</span>{{ patient.age }}</div>
        <div class="item"><span class="label">體重:</span>{{ patient.weight }} kg</div>
        <div class="item"><span class="label">身高:</span>{{ patient.height }} cm</div>
        <div class="item"><span class="label">血型:</span>{{ patient.blood_type }}</div>
        <div class="item"><span class="label">ASA:</span>{{ patient.asa_class }}</div>
        <div class="item"><span class="label">手術:</span>{{ surgery.name }}</div>
        <div class="item"><span class="label">術式:</span>{{ surgery.procedure }}</div>
        <div class="item"><span class="label">日期:</span>{{ surgery.date }}</div>
        <div class="item"><span class="label">OR:</span>{{ surgery.or_room }}</div>
        <div class="item"><span class="label">主刀:</span>{{ surgery.surgeon }}</div>
    </div>

    <!-- Technique Section (only on first page) -->
    <div class="technique-section">
        <strong>麻醉方式:</strong>
        <div class="technique-grid">
            <div class="technique-item">
                <span class="checkbox {% if technique == 'GA_ETT' %}checked{% endif %}"></span> 全身麻醉(ETT)
            </div>
            <div class="technique-item">
                <span class="checkbox {% if technique == 'GA_LMA' %}checked{% endif %}"></span> 全身麻醉(LMA)
            </div>
            <div class="technique-item">
                <span class="checkbox {% if technique == 'GA_MASK' %}checked{% endif %}"></span> 全身麻醉(Mask)
            </div>
            <div class="technique-item">
                <span class="checkbox {% if technique == 'RA_SPINAL' %}checked{% endif %}"></span> 脊髓麻醉
            </div>
            <div class="technique-item">
                <span class="checkbox {% if technique == 'RA_EPIDURAL' %}checked{% endif %}"></span> 硬膜外麻醉
            </div>
            <div class="technique-item">
                <span class="checkbox {% if technique == 'RA_CSE' %}checked{% endif %}"></span> CSE
            </div>
            <div class="technique-item">
                <span class="checkbox {% if technique == 'RA_BLOCK' %}checked{% endif %}"></span> 神經阻斷
            </div>
            <div class="technique-item">
                <span class="checkbox {% if technique == 'SEDATION' %}checked{% endif %}"></span> 鎮靜麻醉
            </div>
            <div class="technique-item">
                <span class="checkbox {% if technique == 'LOCAL' %}checked{% endif %}"></span> 局部麻醉
            </div>
        </div>
    </div>
    {% endif %}

    <!-- ========== MAIN: Large Vital Signs Chart ========== -->
    <div class="chart-main">
        <div class="chart-title">Vital Signs Monitor</div>

        {% if page.chart_image %}
        <!-- Matplotlib chart (RPi5/Local) -->
        <img src="data:image/png;base64,{{ page.chart_image }}" alt="Vital Signs Chart">
        {% elif page.vitals and page.vitals|length > 0 %}
        <!-- SVG chart (Vercel/Demo) -->
        <svg viewBox="0 0 800 180" preserveAspectRatio="xMidYMid meet">
            <!-- Background -->
            <rect x="0" y="0" width="800" height="180" fill="#fafafa"/>

            <!-- Grid lines -->
            <defs>
                <pattern id="grid" width="40" height="30" patternUnits="userSpaceOnUse">
                    <path d="M 40 0 L 0 0 0 30" fill="none" stroke="#e5e5e5" stroke-width="0.5"/>
                </pattern>
            </defs>
            <rect x="50" y="10" width="740" height="150" fill="url(#grid)"/>

            <!-- Y-axis (0-200) -->
            <line x1="50" y1="10" x2="50" y2="160" stroke="#333" stroke-width="1"/>
            <text x="45" y="15" text-anchor="end" font-size="9" fill="#666">200</text>
            <text x="45" y="47" text-anchor="end" font-size="9" fill="#666">150</text>
            <text x="45" y="85" text-anchor="end" font-size="9" fill="#666">100</text>
            <text x="45" y="122" text-anchor="end" font-size="9" fill="#666">50</text>
            <text x="45" y="160" text-anchor="end" font-size="9" fill="#666">0</text>

            <!-- Horizontal reference lines -->
            <line x1="50" y1="47" x2="790" y2="47" stroke="#ddd" stroke-width="0.5"/>
            <line x1="50" y1="85" x2="790" y2="85" stroke="#ccc" stroke-width="0.5" stroke-dasharray="5,5"/>
            <line x1="50" y1="122" x2="790" y2="122" stroke="#ddd" stroke-width="0.5"/>

            <!-- X-axis -->
            <line x1="50" y1="160" x2="790" y2="160" stroke="#333" stroke-width="1"/>

            {% set vitals_count = page.vitals|length %}
            {% set x_step = 740 / (vitals_count if vitals_count > 1 else 1) %}

            <!-- SBP Line (Red) -->
            <polyline fill="none" stroke="#dc2626" stroke-width="2.5"
                points="{% for v in page.vitals %}{% if v.sbp %}{{ 50 + loop.index0 * x_step }},{{ 160 - (v.sbp / 200 * 150) }}{% if not loop.last %} {% endif %}{% endif %}{% endfor %}"/>

            <!-- DBP Line (Blue) -->
            <polyline fill="none" stroke="#2563eb" stroke-width="2.5"
                points="{% for v in page.vitals %}{% if v.dbp %}{{ 50 + loop.index0 * x_step }},{{ 160 - (v.dbp / 200 * 150) }}{% if not loop.last %} {% endif %}{% endif %}{% endfor %}"/>

            <!-- HR Line (Green, dashed) -->
            <polyline fill="none" stroke="#16a34a" stroke-width="2" stroke-dasharray="8,4"
                points="{% for v in page.vitals %}{% if v.hr %}{{ 50 + loop.index0 * x_step }},{{ 160 - (v.hr / 200 * 150) }}{% if not loop.last %} {% endif %}{% endif %}{% endfor %}"/>

            <!-- Data Points -->
            {% for v in page.vitals %}
                {% set x_pos = 50 + loop.index0 * x_step %}

                <!-- SBP point -->
                {% if v.sbp %}
                <circle cx="{{ x_pos }}" cy="{{ 160 - (v.sbp / 200 * 150) }}" r="5" fill="#dc2626"/>
                <text x="{{ x_pos }}" y="{{ 160 - (v.sbp / 200 * 150) - 8 }}" text-anchor="middle" font-size="7" fill="#dc2626">{{ v.sbp }}</text>
                {% endif %}

                <!-- DBP point -->
                {% if v.dbp %}
                <circle cx="{{ x_pos }}" cy="{{ 160 - (v.dbp / 200 * 150) }}" r="5" fill="#2563eb"/>
                <text x="{{ x_pos }}" y="{{ 160 - (v.dbp / 200 * 150) + 12 }}" text-anchor="middle" font-size="7" fill="#2563eb">{{ v.dbp }}</text>
                {% endif %}

                <!-- HR point -->
                {% if v.hr %}
                <rect x="{{ x_pos - 4 }}" y="{{ 160 - (v.hr / 200 * 150) - 4 }}" width="8" height="8" fill="#16a34a"/>
                {% endif %}

                <!-- Time label -->
                <text x="{{ x_pos }}" y="175" text-anchor="middle" font-size="8" fill="#333">{{ v.time_display }}</text>
            {% endfor %}
        </svg>
        {% endif %}

        <!-- Legend -->
        <div class="chart-legend">
            <div class="chart-legend-item">
                <span class="legend-dot" style="background: #dc2626;"></span>
                <span>SBP (收縮壓)</span>
            </div>
            <div class="chart-legend-item">
                <span class="legend-dot" style="background: #2563eb;"></span>
                <span>DBP (舒張壓)</span>
            </div>
            <div class="chart-legend-item">
                <span class="legend-square" style="background: #16a34a;"></span>
                <span>HR (心率)</span>
            </div>
        </div>
    </div>

    <!-- ========== BOTTOM: Three Columns ========== -->
    <div class="bottom-content">
        <!-- Left: Drugs -->
        <div class="drugs-column">
            <div class="section-title">藥物給予</div>
            <table class="drug-table">
                <tr>
                    <th>時間</th>
                    <th>藥物</th>
                    <th>劑量</th>
                </tr>
                {% for drug in page.drugs %}
                <tr>
                    <td>{{ drug.time }}</td>
                    <td>{{ drug.name }}</td>
                    <td>{{ drug.dose }}</td>
                </tr>
                {% endfor %}
            </table>
        </div>

        <!-- Middle: Compact Vitals Table -->
        <div class="vitals-column">
            <div class="section-title">Vital Signs Data</div>
            <table class="vitals-table">
                <tr class="time-row">
                    <th class="row-header">Time</th>
                    {% for v in page.vitals %}
                    <th>{{ v.time_display }}</th>
                    {% endfor %}
                </tr>
                <tr>
                    <td class="row-header">SBP</td>
                    {% for v in page.vitals %}
                    <td class="bp-systolic">{{ v.sbp or '-' }}</td>
                    {% endfor %}
                </tr>
                <tr>
                    <td class="row-header">DBP</td>
                    {% for v in page.vitals %}
                    <td class="bp-diastolic">{{ v.dbp or '-' }}</td>
                    {% endfor %}
                </tr>
                <tr>
                    <td class="row-header">HR</td>
                    {% for v in page.vitals %}
                    <td class="hr-value">{{ v.hr or '-' }}</td>
                    {% endfor %}
                </tr>
                <tr>
                    <td class="row-header">SpO2</td>
                    {% for v in page.vitals %}
                    <td>{{ v.spo2 or '-' }}</td>
                    {% endfor %}
                </tr>
                <tr>
                    <td class="row-header">EtCO2</td>
                    {% for v in page.vitals %}
                    <td>{{ v.etco2 or '-' }}</td>
                    {% endfor %}
                </tr>
                <tr>
                    <td class="row-header">Temp</td>
                    {% for v in page.vitals %}
                    <td>{{ v.temp or '-' }}</td>
                    {% endfor %}
                </tr>
            </table>
        </div>

        <!-- Right: IV + I/O -->
        <div class="io-column">
            {% if page.page_number == 1 %}
            <!-- IV Lines -->
            <div class="iv-section">
                <div class="section-title">IV 管路</div>
                <table class="iv-table">
                    <tr>
                        <th>#</th>
                        <th>部位</th>
                        <th>Gauge</th>
                    </tr>
                    {% for iv in iv_lines %}
                    <tr>
                        <td>{{ iv.line_number }}</td>
                        <td>{{ iv.site }}</td>
                        <td>{{ iv.gauge }}</td>
                    </tr>
                    {% endfor %}
                </table>
            </div>
            {% endif %}

            <!-- I/O Balance -->
            {% if page.page_number == total_pages %}
            <div class="io-section">
                <div class="section-title">I/O Balance</div>
                <table class="io-table">
                    <tr><th>輸入</th><td></td></tr>
                    <tr><th>晶體液</th><td>{{ io_balance.input.crystalloid_ml }} mL</td></tr>
                    <tr><th>膠體液</th><td>{{ io_balance.input.colloid_ml }} mL</td></tr>
                    <tr><th>血品</th><td>{{ io_balance.input.blood_ml }} mL</td></tr>
                    <tr><th><strong>Total In</strong></th><td><strong>{{ io_balance.input.total_ml }} mL</strong></td></tr>
                    <tr><th>輸出</th><td></td></tr>
                    <tr><th>尿量</th><td>{{ io_balance.output.urine_ml }} mL</td></tr>
                    <tr><th>失血</th><td>{{ io_balance.output.blood_loss_ml }} mL</td></tr>
                    <tr><th><strong>Total Out</strong></th><td><strong>{{ io_balance.output.total_ml }} mL</strong></td></tr>
                    <tr style="background: #fffbeb;"><th><strong>Net Balance</strong></th><td><strong>{{ io_balance.balance_ml }} mL</strong></td></tr>
                </table>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Footer (only on last page) -->
    {% if page.page_number == total_pages %}
    <div class="footer">
        <div class="signature-box">
            <div class="signature-label">麻醉: {{ times.anesthesia_start or '__:__' }} - {{ times.anesthesia_end or '__:__' }}</div>
        </div>
        <div class="signature-box">
            <div class="signature-label">手術: {{ times.surgery_start or '__:__' }} - {{ times.surgery_end or '__:__' }}</div>
        </div>
        <div class="signature-box">
            <div class="signature-label">麻醉醫師: {{ anesthesiologist or '' }}</div>
        </div>
        <div class="signature-box">
            <div class="signature-label">護理師: {{ nurse or '' }}</div>
        </div>
    </div>
    {% endif %}
</div>
{% endfor %}

<div style="text-align: center; font-size: 7pt; color: #666; margin-top: 4px;">
    Generated by MIRS Anesthesia Module v2.1 | {{ generated_at }}
</div>
</body>
</html>
