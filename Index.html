<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>é†«ç™‚ç«™åº«å­˜ç®¡ç†ç³»çµ± v2.8.0</title>
    <!-- v2.0.0: æœ¬åœ°åŒ–ä¾è³´ï¼Œæ”¯æ´é›¢ç·šé‹ä½œ + Active Role Badge -->
    <!-- v2.8.0: xirs-ui å…ƒä»¶åº«æ•´åˆ (DEV SPEC v2.1) -->
    <link rel="stylesheet" href="/static/css/tailwind.min.css">
    <link rel="stylesheet" href="/static/css/mirs-colors.css">
    <!-- xIRS UI: çµ±ä¸€è‰²å½©ç³»çµ± -->
    <link rel="stylesheet" href="/static/xirs-ui/core/xirs-colors.css">
    <script defer src="/static/js/alpine.min.js"></script>
    <script src="/static/js/qrcode.min.js"></script>
    <!-- Note: xirs-fallback-guard.js å·²ç§»é™¤ - MIRS ä¸éœ€è¦ CIRS ç«™é»é…å°æª¢æŸ¥ -->
    <script src="/static/js/mirs-role-badge.js"></script>
    <!-- xIRS UI: Toast é€šçŸ¥ -->
    <script src="/static/xirs-ui/components/xirs-toast.js"></script>
    <!-- xIRS UI: é›¢ç·šç‹€æ…‹æŒ‡ç¤ºå™¨ -->
    <script src="/static/xirs-ui/components/xirs-offline-banner.js"></script>
    <!-- xIRS UI: 403 éŒ¯èª¤è™•ç† -->
    <script src="/static/xirs-ui/utils/xirs-403-handler.js"></script>
    <!-- xIRS UI: è¡¨å–®è‰ç¨¿æ¢å¾© -->
    <script src="/static/xirs-ui/utils/xirs-draft-recovery.js"></script>
    <script>
        // é©—è­‰ QRCode è¼‰å…¥
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof QRCode !== 'undefined') {
                console.log('[QRCode] qrcodejs library loaded successfully');
            } else {
                console.error('[QRCode] qrcodejs library NOT loaded');
            }
        });
    </script>
    <style>
        [x-cloak] { display: none !important; }
        
        /* æ·º teal èƒŒæ™¯æ¼¸è®Š */
        body {
            background: linear-gradient(135deg, #f0f9f8 0%, #e6f7f5 25%, #f5f8ff 50%, #faf5ff 75%, #fff 100%);
            background-attachment: fixed;
        }

        /* è‡ªå®šç¾©æ»¾å‹•æ¢ */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* è¡¨æ ¼æ–‘é¦¬ç´‹å„ªåŒ– */
        .table-hover tbody tr:hover {
            background-color: #f0f9ff;
            transition: background-color 0.2s;
        }

        /* éŸ¿æ‡‰å¼çµ±è¨ˆå¡ç‰‡å„ªåŒ– */
        @media (max-width: 640px) {
            .stat-card {
                height: 6rem;
                padding: 0.75rem;
            }
            .stat-card .text-2xl {
                font-size: 1.5rem;
            }
        }
    </style>
</head>
<body class="min-h-screen" x-data="{...medicalInventory(), ...mirsRoleBadge({enableQuickLock: true})}" x-init="init(); initRoleBadge(); console.log('[x-init] localStorage role:', localStorage.getItem('mirs_active_role'), '| _roleBadge.activeRole:', _roleBadge.activeRole); if (!localStorage.getItem('mirs_active_role')) { console.log('[x-init] No role in localStorage, setting LOGISTICS'); _roleBadge.setRole('LOGISTICS', 'åº«å­˜ç®¡ç†å“¡', 'mirs-admin'); } initXirsUI();">
    <!-- Active Role Badge & Quick Lock -->
    <div x-html="roleBadgeHTML"></div>

    <!-- xIRS Offline Banner (æ’å…¥é») -->
    <div id="xirs-offline-slot"></div>

    <div x-cloak class="w-full max-w-7xl mx-auto px-3 sm:px-4 md:px-6 py-4 sm:py-6">

        <!-- Demo Mode Banner -->
        <div x-show="demoMode" class="bg-amber-50 border border-amber-200 rounded-xl p-4 mb-4 shadow-sm">
            <div class="flex items-center justify-between flex-wrap gap-3">
                <div class="flex items-center gap-3">
                    <div class="p-2 bg-amber-100 rounded-lg">
                        <svg class="w-5 h-5 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <div>
                        <p class="font-semibold text-amber-800">å±•ç¤ºæ¨¡å¼ Demo Mode (å”¯è®€)</p>
                        <p class="text-sm text-amber-600">
                            âš ï¸ <strong>å·²çŸ¥é™åˆ¶</strong>ï¼šå›  Serverless æ¶æ§‹ï¼Œè³‡æ–™ä¿®æ”¹ç„¡æ³•å³æ™‚åæ˜ ã€‚
                            è‹¥éœ€å®Œæ•´æ¸¬è©¦åŠŸèƒ½ï¼Œè«‹ä½¿ç”¨æœ¬æ©Ÿç‰ˆæœ¬ (localhost:8000) æˆ–æ¨¹è“æ´¾å¯¦æ©Ÿéƒ¨ç½²ã€‚
                        </p>
                        <details class="mt-1">
                            <summary class="text-xs text-amber-500 cursor-pointer hover:text-amber-700">è©³ç´°èªªæ˜...</summary>
                            <ul class="text-xs text-amber-600 mt-1 ml-4 list-disc space-y-0.5">
                                <li>ä¿®æ”¹è¨­å‚™æ•¸é‡ã€æ’ç®¡äººæ•¸ç­‰ â†’ è¨ˆç®—çµæœå¯èƒ½ä¸æœƒç«‹å³æ›´æ–°</li>
                                <li>æ¯æ¬¡é é¢é‡æ•´å¯èƒ½é€£æ¥åˆ°ä¸åŒä¼ºæœå™¨å¯¦ä¾‹ï¼ˆå†·å•Ÿå‹•ï¼‰</li>
                                <li>é»æ“Šã€Œé‡ç½®è³‡æ–™ã€å¯å¼·åˆ¶é‡æ–°è¼‰å…¥åˆå§‹å±•ç¤ºè³‡æ–™</li>
                            </ul>
                        </details>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <a href="https://github.com/chihkang/MIRS" target="_blank"
                       class="inline-flex items-center gap-1 px-3 py-1.5 bg-gray-800 text-white text-sm rounded-lg hover:bg-gray-700 transition-colors">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                            <path fill-rule="evenodd" d="M12 2C6.477 2 2 6.484 2 12.017c0 4.425 2.865 8.18 6.839 9.504.5.092.682-.217.682-.483 0-.237-.008-.868-.013-1.703-2.782.605-3.369-1.343-3.369-1.343-.454-1.158-1.11-1.466-1.11-1.466-.908-.62.069-.608.069-.608 1.003.07 1.531 1.032 1.531 1.032.892 1.53 2.341 1.088 2.91.832.092-.647.35-1.088.636-1.338-2.22-.253-4.555-1.113-4.555-4.951 0-1.093.39-1.988 1.029-2.688-.103-.253-.446-1.272.098-2.65 0 0 .84-.27 2.75 1.026A9.564 9.564 0 0112 6.844c.85.004 1.705.115 2.504.337 1.909-1.296 2.747-1.027 2.747-1.027.546 1.379.202 2.398.1 2.651.64.7 1.028 1.595 1.028 2.688 0 3.848-2.339 4.695-4.566 4.943.359.309.678.92.678 1.855 0 1.338-.012 2.419-.012 2.747 0 .268.18.58.688.482A10.019 10.019 0 0022 12.017C22 6.484 17.522 2 12 2z" clip-rule="evenodd"></path>
                        </svg>
                        GitHub
                    </a>
                    <button @click="resetDemo()"
                            class="inline-flex items-center gap-1 px-3 py-1.5 bg-amber-500 text-white text-sm rounded-lg hover:bg-amber-600 transition-colors">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                        </svg>
                        é‡ç½®è³‡æ–™
                    </button>
                </div>
            </div>
        </div>

        <!-- Header -->
        <div class="bg-white rounded-xl sm:rounded-2xl shadow-lg p-3 sm:p-4 md:p-6 mb-4 sm:mb-6">
            <div class="flex items-center justify-between flex-wrap gap-3 sm:gap-4">
                <div class="flex items-center gap-2 sm:gap-3 md:gap-4">
                    <!-- å¤é™µLogo -->
                    <a href="https://denovortho-site.vercel.app/zh-TW/resilience" target="_blank" class="flex-shrink-0 hover:opacity-80 transition-opacity">
                        <img src="/static/guling_logo.png" alt="De Novo Orthopedics Logo" class="h-10 sm:h-12 md:h-16 w-auto object-contain">
                    </a>

                    <div class="border-l border-gray-300 pl-2 sm:pl-3 md:pl-4">
                        <h1 class="text-lg sm:text-xl md:text-2xl font-bold text-gray-800 flex items-center gap-1 sm:gap-2">
                            <svg class="w-5 h-5 sm:w-6 sm:h-6 md:w-7 md:h-7 text-teal-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                            </svg>
                            BORPå‚™æ´æ‰‹è¡“ç«™ï¼ˆå–®ç«™ç‰ˆï¼‰
                        </h1>
                        <p class="text-xs sm:text-sm text-gray-500">
                            BORP-DNO-01 - v2.9.2
                        </p>
                        <div class="hidden sm:flex items-center gap-2 mt-1 text-xs text-gray-400">
                            <span class="font-medium">Designed in Taiwan</span>
                            <span>â€¢</span>
                            <span>De Novo Orthopedics Inc</span>
                        </div>
                    </div>
                </div>
                <div class="flex items-center gap-2 sm:gap-4">
                    <!-- éº»é†‰ç«™ PWA æŒ‰éˆ• -->
                    <a href="/anesthesia" target="_blank"
                       class="flex items-center gap-1.5 px-3 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg text-sm font-medium transition-colors">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
                        </svg>
                        <span class="hidden sm:inline">éº»é†‰ç«™</span>
                    </a>
                    <!-- EMT Transfer PWA æŒ‰éˆ• -->
                    <a href="/emt" target="_blank"
                       class="flex items-center gap-1.5 px-3 py-2 bg-orange-600 hover:bg-orange-700 text-white rounded-lg text-sm font-medium transition-colors">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                        </svg>
                        <span class="hidden sm:inline">è½‰é€</span>
                    </a>
                    <!-- Mobile é…å°æŒ‰éˆ• -->
                    <button @click="showMobilePairing = true; pairingInfo = null; pairingError = null"
                            class="flex items-center gap-1.5 px-3 py-2 bg-teal-600 hover:bg-teal-700 text-white rounded-lg text-sm font-medium transition-colors">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                        </svg>
                        <span class="hidden sm:inline">è¡Œå‹•é…å°</span>
                    </button>
                    <!-- é…å°è¨˜éŒ„æŒ‰éˆ• -->
                    <button @click="showPairedDevices = true; loadPairedDevices()"
                            class="flex items-center gap-1.5 px-2 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg text-sm font-medium transition-colors"
                            title="é…å°è¨˜éŒ„">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                        </svg>
                        <span class="hidden sm:inline">é…å°è¨˜éŒ„</span>
                    </button>
                    <!-- v2.9: Hub é€£ç·šç‹€æ…‹æŒ‡ç¤ºå™¨ -->
                    <button @click="showHubSettingsModal = true; checkHubConnection(); checkSnapshotStatus()"
                            class="flex items-center gap-1.5 px-2 py-2 rounded-lg text-sm font-medium transition-colors"
                            :class="hubStatus.connected ? 'bg-green-100 text-green-800 hover:bg-green-200' : 'bg-red-100 text-red-800 hover:bg-red-200'"
                            title="Hub é€£ç·šç‹€æ…‹">
                        <span class="w-2 h-2 rounded-full" :class="getHubStatusColor()"></span>
                        <span class="hidden sm:inline" x-text="getHubStatusText()"></span>
                    </button>
                    <div class="text-right">
                        <p class="text-xs text-gray-400">
                            <span x-text="currentTime"></span>
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Mobile é…å° Modal (GitHub Device Flow é¢¨æ ¼) -->
        <div x-show="showMobilePairing" x-cloak
             class="fixed inset-0 z-50 flex items-center justify-center bg-black/50"
             @click.self="showMobilePairing = false">
            <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg mx-4 overflow-hidden max-h-[90vh] overflow-y-auto">
                <div class="sticky top-0 bg-teal-600 text-white px-6 py-4 z-10">
                    <h3 class="text-lg font-semibold flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                        </svg>
                        MIRS Mobile é…å°
                    </h3>
                    <p class="text-teal-100 text-sm mt-1">è®“äººå“¡ä½¿ç”¨æ‰‹æ©Ÿé€²è¡Œå·¡æˆ¿æª¢æŸ¥</p>
                </div>

                <!-- é…ç½®æ­¥é©Ÿï¼šé¸æ“‡è§’è‰²èˆ‡æ¬Šé™ -->
                <div x-show="!pairingInfo && !pairingLoading && !pairingError" class="p-6">
                    <div class="space-y-4">
                        <!-- è§’è‰²é¸æ“‡ -->
                        <div>
                            <label class="text-sm font-medium text-gray-700 block mb-2">é…å°è§’è‰²</label>
                            <select x-model="pairingConfig.role"
                                    class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-teal-500 focus:border-transparent">
                                <option value="nurse">è­·ç†å¸«</option>
                                <option value="warehouse">åº«æˆ¿äººå“¡</option>
                                <option value="maintenance">å·¥å‹™ / è¨­å‚™ç¶­è­·</option>
                                <option value="admin">ç®¡ç†å“¡</option>
                            </select>
                        </div>

                        <!-- åŠŸèƒ½æ¬Šé™é–‹é—œ -->
                        <div>
                            <label class="text-sm font-medium text-gray-700 block mb-2">å•Ÿç”¨åŠŸèƒ½</label>
                            <div class="space-y-3 bg-gray-50 rounded-xl p-4">
                                <!-- è¨­å‚™æª¢æŸ¥ -->
                                <label class="flex items-center justify-between cursor-pointer">
                                    <div class="flex items-center gap-3">
                                        <div class="w-8 h-8 bg-teal-100 rounded-lg flex items-center justify-center">
                                            <svg class="w-4 h-4 text-teal-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                            </svg>
                                        </div>
                                        <span class="text-gray-700">è¨­å‚™æª¢æŸ¥</span>
                                    </div>
                                    <div class="relative">
                                        <input type="checkbox" x-model="pairingConfig.scopes.equipment" class="sr-only">
                                        <div class="toggle-switch toggle-teal" :class="pairingConfig.scopes.equipment ? 'active' : ''"></div>
                                    </div>
                                </label>
                                <!-- åº«å­˜ç›¤é» -->
                                <label class="flex items-center justify-between cursor-pointer">
                                    <div class="flex items-center gap-3">
                                        <div class="w-8 h-8 bg-cyan-100 rounded-lg flex items-center justify-center">
                                            <svg class="w-4 h-4 text-cyan-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                                            </svg>
                                        </div>
                                        <span class="text-gray-700">åº«å­˜ç›¤é»</span>
                                    </div>
                                    <div class="relative">
                                        <input type="checkbox" x-model="pairingConfig.scopes.inventory" class="sr-only">
                                        <div class="toggle-switch toggle-cyan" :class="pairingConfig.scopes.inventory ? 'active' : ''"></div>
                                    </div>
                                </label>
                                <!-- è¡€è¢‹å…¥åº« -->
                                <label class="flex items-center justify-between cursor-pointer">
                                    <div class="flex items-center gap-3">
                                        <div class="w-8 h-8 bg-red-100 rounded-lg flex items-center justify-center">
                                            <svg class="w-4 h-4 text-[#D96754]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"/>
                                            </svg>
                                        </div>
                                        <span class="text-gray-700">è¡€è¢‹å…¥åº«</span>
                                    </div>
                                    <div class="relative">
                                        <input type="checkbox" x-model="pairingConfig.scopes.bloodReceive" class="sr-only">
                                        <div class="toggle-switch toggle-blood" :class="pairingConfig.scopes.bloodReceive ? 'active' : ''"></div>
                                    </div>
                                </label>
                                <!-- è€—æå…¥åº« -->
                                <label class="flex items-center justify-between cursor-pointer">
                                    <div class="flex items-center gap-3">
                                        <div class="w-8 h-8 bg-sky-100 rounded-lg flex items-center justify-center">
                                            <svg class="w-4 h-4 text-sky-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"/>
                                            </svg>
                                        </div>
                                        <span class="text-gray-700">è€—æå…¥åº«</span>
                                    </div>
                                    <div class="relative">
                                        <input type="checkbox" x-model="pairingConfig.scopes.supplyReceive" class="sr-only">
                                        <div class="toggle-switch toggle-sky" :class="pairingConfig.scopes.supplyReceive ? 'active' : ''"></div>
                                    </div>
                                </label>
                            </div>
                        </div>

                        <!-- ç”¢ç”Ÿé…å°ç¢¼æŒ‰éˆ• -->
                        <button @click="generatePairingCode()"
                                class="w-full bg-teal-600 text-white rounded-xl py-3 font-semibold hover:bg-teal-700 transition-colors flex items-center justify-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z"/>
                            </svg>
                            ç”¢ç”Ÿé…å°ç¢¼
                        </button>
                    </div>
                </div>

                <!-- Loading ç‹€æ…‹ -->
                <div x-show="pairingLoading" class="p-8 text-center">
                    <div class="animate-spin w-10 h-10 border-4 border-teal-600 border-t-transparent rounded-full mx-auto mb-4"></div>
                    <p class="text-gray-500">ç”¢ç”Ÿé…å°ç¢¼ä¸­...</p>
                </div>

                <!-- éŒ¯èª¤ç‹€æ…‹ -->
                <div x-show="pairingError && !pairingLoading" class="p-6 text-center">
                    <div class="text-red-500 text-4xl mb-4">âš ï¸</div>
                    <p class="text-red-600 mb-4" x-text="pairingError"></p>
                    <button @click="pairingError = null"
                            class="px-4 py-2 bg-teal-600 text-white rounded-lg hover:bg-teal-700">
                        é‡è©¦
                    </button>
                </div>

                <!-- æˆåŠŸç‹€æ…‹ï¼šQR Code + é…å°ç¢¼ -->
                <div x-show="pairingInfo && !pairingLoading && !pairingError" class="p-6">
                    <!-- æ­¥é©Ÿèªªæ˜ -->
                    <div class="flex items-start gap-4 mb-6 p-4 bg-teal-50 rounded-xl">
                        <div class="flex-shrink-0 w-8 h-8 bg-teal-600 text-white rounded-full flex items-center justify-center font-bold">1</div>
                        <div>
                            <p class="font-medium text-gray-800">ç”¨æ‰‹æ©Ÿæƒæ QR Code</p>
                            <p class="text-sm text-gray-500">é–‹å•Ÿ MIRS Mobile ç¶²é </p>
                        </div>
                    </div>

                    <!-- å…©æ¬„ï¼šQR Code + é…å°ç¢¼ -->
                    <div class="grid grid-cols-2 gap-6 mb-6">
                        <!-- QR Code -->
                        <div class="text-center">
                            <div class="bg-white border-2 border-gray-200 rounded-xl p-2 inline-block">
                                <img :src="pairingQRUrl" alt="Mobile PWA QR Code" class="w-32 h-32">
                            </div>
                            <p class="text-xs text-gray-400 mt-2">æƒæé–‹å•Ÿç¶²é </p>
                        </div>

                        <!-- é…å°ç¢¼ -->
                        <div class="text-center flex flex-col justify-center">
                            <div class="flex items-start gap-4 mb-2 p-3 bg-gray-50 rounded-xl">
                                <div class="flex-shrink-0 w-6 h-6 bg-teal-600 text-white rounded-full flex items-center justify-center font-bold text-sm">2</div>
                                <p class="text-sm text-gray-600 text-left">è¼¸å…¥é…å°ç¢¼</p>
                            </div>
                            <div class="bg-gray-100 rounded-xl py-4 px-2">
                                <div class="text-3xl font-mono font-bold tracking-[0.3em] text-teal-600" x-text="pairingInfo?.pairing_code || '------'"></div>
                            </div>
                            <p class="text-sm text-gray-500 mt-2">
                                æœ‰æ•ˆæ™‚é–“ï¼š<span class="font-medium text-orange-600" x-text="pairingExpiry"></span>
                            </p>
                        </div>
                    </div>

                    <!-- Hub IP è³‡è¨Š -->
                    <div class="bg-gray-50 rounded-xl p-4 mb-4">
                        <div class="flex items-center justify-between text-sm">
                            <span class="text-gray-500">Hub IP:</span>
                            <span class="font-mono font-medium text-gray-800" x-text="pairingInfo?.hub_ip || 'N/A'"></span>
                        </div>
                        <div class="flex items-center justify-between text-sm mt-2">
                            <span class="text-gray-500">Mobile URL:</span>
                            <code class="text-xs bg-white px-2 py-1 rounded text-gray-700" x-text="pairingInfo?.mobile_url || ''"></code>
                        </div>
                    </div>

                    <!-- WiFi æé†’ -->
                    <div class="bg-yellow-50 border border-yellow-200 rounded-xl p-3 text-sm">
                        <p class="text-yellow-800">
                            <span class="font-medium">âš ï¸ ç¢ºèªæ‰‹æ©Ÿèˆ‡æ­¤é›»è…¦åœ¨åŒä¸€å€‹ WiFi ç¶²è·¯</span>
                        </p>
                    </div>

                    <!-- é‡æ–°ç”¢ç”ŸæŒ‰éˆ• -->
                    <div class="text-center mt-4">
                        <button @click="generatePairingCode()"
                                class="text-teal-600 hover:text-teal-700 text-sm font-medium">
                            ğŸ”„ é‡æ–°ç”¢ç”Ÿé…å°ç¢¼
                        </button>
                    </div>
                </div>

                <div class="bg-gray-50 px-6 py-3 flex justify-end border-t">
                    <button @click="showMobilePairing = false; pairingInfo = null; pairingQRUrl = ''"
                            class="px-4 py-2 text-gray-600 hover:text-gray-800 font-medium">
                        é—œé–‰
                    </button>
                </div>
            </div>
        </div>

        <!-- é…å°è¨˜éŒ„ Modal -->
        <div x-show="showPairedDevices" x-cloak
             class="fixed inset-0 z-50 flex items-center justify-center bg-black/50"
             @click.self="showPairedDevices = false">
            <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl mx-4 overflow-hidden max-h-[90vh] overflow-y-auto">
                <div class="sticky top-0 bg-gray-700 text-white px-6 py-4 z-10">
                    <h3 class="text-lg font-semibold flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                        </svg>
                        å·²é…å°è£ç½®è¨˜éŒ„
                    </h3>
                    <p class="text-gray-300 text-sm mt-1">æŸ¥çœ‹å’Œç®¡ç†å·²é…å°çš„è¡Œå‹•è£ç½®</p>
                </div>

                <div class="p-6">
                    <!-- è¼‰å…¥ä¸­ -->
                    <div x-show="pairedDevicesLoading" class="text-center py-8">
                        <div class="animate-spin w-8 h-8 border-4 border-gray-300 border-t-teal-600 rounded-full mx-auto mb-3"></div>
                        <p class="text-gray-500">è¼‰å…¥ä¸­...</p>
                    </div>

                    <!-- ç„¡è¨˜éŒ„ -->
                    <div x-show="!pairedDevicesLoading && pairedDevices.length === 0" class="text-center py-8">
                        <svg class="w-12 h-12 text-gray-300 mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                        </svg>
                        <p class="text-gray-500">å°šç„¡é…å°è¨˜éŒ„</p>
                    </div>

                    <!-- è£ç½®åˆ—è¡¨ -->
                    <div x-show="!pairedDevicesLoading && pairedDevices.length > 0" class="space-y-3">
                        <template x-for="device in pairedDevices" :key="device.device_id">
                            <div class="bg-gray-50 rounded-xl p-4 border" :class="device.revoked ? 'border-red-200 opacity-60' : 'border-gray-200'">
                                <div class="flex items-start justify-between gap-3">
                                    <div class="flex items-start gap-3">
                                        <div class="w-10 h-10 rounded-full flex items-center justify-center text-white font-bold"
                                             :class="device.revoked ? 'bg-gray-400' : 'bg-teal-600'">
                                            <span x-text="(device.staff_name || 'U')[0]"></span>
                                        </div>
                                        <div class="min-w-0">
                                            <div class="font-semibold text-gray-800 flex items-center gap-2">
                                                <span x-text="device.staff_name || 'æœªçŸ¥'"></span>
                                                <span x-show="device.revoked" class="text-xs bg-red-100 text-red-600 px-2 py-0.5 rounded-full">å·²æ’¤éŠ·</span>
                                            </div>
                                            <div class="text-sm text-gray-500" x-text="device.role === 'admin' ? 'ç®¡ç†å“¡' : device.role === 'nurse' ? 'è­·ç†å¸«' : device.role"></div>
                                            <div class="text-xs text-gray-400 mt-1">
                                                <span>è£ç½® ID: </span>
                                                <span x-text="device.device_id.substring(0, 8) + '...'"></span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="text-right text-xs text-gray-400">
                                        <div>é…å°: <span x-text="new Date(device.paired_at).toLocaleString('zh-TW')"></span></div>
                                        <div x-show="device.last_seen">
                                            æœ€å¾Œæ´»å‹•: <span x-text="device.last_seen ? new Date(device.last_seen).toLocaleString('zh-TW') : '-'"></span>
                                        </div>
                                    </div>
                                </div>
                                <!-- æ’¤éŠ·æŒ‰éˆ• -->
                                <div x-show="!device.revoked" class="mt-3 pt-3 border-t border-gray-200 flex justify-end">
                                    <button @click="revokeDevice(device.device_id)"
                                            class="text-sm text-red-600 hover:text-red-800 font-medium">
                                        æ’¤éŠ·é…å°
                                    </button>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>

                <div class="bg-gray-50 px-6 py-3 flex justify-between items-center border-t">
                    <button @click="loadPairedDevices()"
                            class="text-sm text-teal-600 hover:text-teal-800 font-medium flex items-center gap-1">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                        </svg>
                        é‡æ–°æ•´ç†
                    </button>
                    <button @click="showPairedDevices = false"
                            class="px-4 py-2 text-gray-600 hover:text-gray-800 font-medium">
                        é—œé–‰
                    </button>
                </div>
            </div>
        </div>

        <!-- v2.9: Hub è¨­å®š Modal (Phase 9 - Policy Snapshot) -->
        <div x-show="showHubSettingsModal" x-cloak
             class="fixed inset-0 z-50 flex items-center justify-center bg-black/50"
             @click.self="showHubSettingsModal = false">
            <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md mx-4 overflow-hidden">
                <!-- Header -->
                <div class="bg-gradient-to-r from-teal-600 to-teal-700 text-white px-6 py-4">
                    <h3 class="text-lg font-semibold flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2m-2-4h.01M17 16h.01"></path>
                        </svg>
                        CIRS Hub é€£ç·šè¨­å®š
                    </h3>
                    <p class="text-teal-100 text-sm mt-1">ç®¡ç† Hub é€£ç·šèˆ‡æ¬Šé™å¿«ç…§</p>
                </div>

                <div class="p-6 space-y-5">
                    <!-- Hub é€£ç·šç‹€æ…‹ -->
                    <div class="bg-gray-50 rounded-xl p-4">
                        <div class="flex items-center justify-between mb-3">
                            <span class="text-sm font-medium text-gray-600">Hub é€£ç·šç‹€æ…‹</span>
                            <button @click="checkHubConnection()"
                                    class="text-teal-600 hover:text-teal-700 text-sm flex items-center gap-1"
                                    :disabled="hubStatus.checking">
                                <svg class="w-4 h-4" :class="hubStatus.checking ? 'animate-spin' : ''" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                </svg>
                                é‡æ–°æª¢æŸ¥
                            </button>
                        </div>
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full flex items-center justify-center"
                                 :class="hubStatus.connected ? 'bg-green-100' : 'bg-red-100'">
                                <svg x-show="hubStatus.connected" class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                </svg>
                                <svg x-show="!hubStatus.connected" class="w-5 h-5 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </div>
                            <div>
                                <p class="font-medium" :class="hubStatus.connected ? 'text-green-800' : 'text-red-800'" x-text="getHubStatusText()"></p>
                                <p class="text-xs text-gray-500" x-show="hubStatus.hubUrl" x-text="hubStatus.hubUrl"></p>
                                <p class="text-xs text-red-500" x-show="hubStatus.error" x-text="hubStatus.error"></p>
                            </div>
                        </div>
                    </div>

                    <!-- Policy Snapshot ç‹€æ…‹ -->
                    <div class="bg-gray-50 rounded-xl p-4">
                        <div class="flex items-center justify-between mb-3">
                            <span class="text-sm font-medium text-gray-600">é›¢ç·šæ¬Šé™å¿«ç…§</span>
                            <span class="text-xs px-2 py-1 rounded-full"
                                  :class="snapshotStatus.hasSnapshot && !snapshotStatus.isExpired ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700'"
                                  x-text="snapshotStatus.hasSnapshot ? (snapshotStatus.isExpired ? 'å·²éæœŸ' : 'æœ‰æ•ˆ') : 'ç„¡å¿«ç…§'"></span>
                        </div>

                        <template x-if="snapshotStatus.hasSnapshot">
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between">
                                    <span class="text-gray-500">ç‰ˆæœ¬</span>
                                    <span class="font-mono text-gray-800" x-text="'v' + snapshotStatus.version"></span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-500">ä½¿ç”¨è€…æ•¸</span>
                                    <span class="text-gray-800" x-text="snapshotStatus.userCount + ' äºº'"></span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-500">éæœŸæ™‚é–“</span>
                                    <span class="text-gray-800" :class="snapshotStatus.isExpired ? 'text-red-600' : ''"
                                          x-text="snapshotStatus.expiresAt ? new Date(snapshotStatus.expiresAt).toLocaleString('zh-TW') : '-'"></span>
                                </div>
                            </div>
                        </template>

                        <template x-if="!snapshotStatus.hasSnapshot">
                            <div class="text-center py-3">
                                <p class="text-gray-500 text-sm">å°šç„¡å¿«ç…§ï¼Œè«‹åŒæ­¥ä»¥å•Ÿç”¨é›¢ç·šé©—è­‰</p>
                            </div>
                        </template>
                    </div>

                    <!-- åŒæ­¥æŒ‰éˆ• -->
                    <button @click="syncPolicySnapshot()"
                            class="w-full py-3 rounded-xl font-semibold flex items-center justify-center gap-2 transition-colors"
                            :class="hubStatus.connected ? 'bg-teal-600 text-white hover:bg-teal-700' : 'bg-gray-200 text-gray-400 cursor-not-allowed'"
                            :disabled="!hubStatus.connected || snapshotStatus.syncing">
                        <svg x-show="snapshotStatus.syncing" class="w-5 h-5 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                        </svg>
                        <svg x-show="!snapshotStatus.syncing" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"></path>
                        </svg>
                        <span x-text="snapshotStatus.syncing ? 'åŒæ­¥ä¸­...' : 'å¾ Hub åŒæ­¥å¿«ç…§'"></span>
                    </button>

                    <p class="text-xs text-gray-400 text-center" x-show="!hubStatus.connected">
                        Hub é›¢ç·šæ™‚ç„¡æ³•åŒæ­¥ï¼Œä½†å¯ä½¿ç”¨ç¾æœ‰å¿«ç…§é€²è¡Œé›¢ç·šé©—è­‰
                    </p>
                </div>

                <!-- Footer -->
                <div class="bg-gray-50 px-6 py-3 flex justify-end border-t">
                    <button @click="showHubSettingsModal = false"
                            class="px-4 py-2 text-gray-600 hover:text-gray-800 font-medium">
                        é—œé–‰
                    </button>
                </div>
            </div>
        </div>

        <!-- çµ±è¨ˆå¡ç‰‡ -->
        <!-- ç²¾ç°¡çµ±è¨ˆå¡ç‰‡ - ç°éšé…è‰² -->
        <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-5 gap-2 mb-4">
            <!-- ç¸½ç‰©å“æ•¸ -->
            <div class="bg-white rounded-lg shadow-sm p-2.5">
                <div class="flex items-center gap-2">
                    <div class="p-1.5 bg-gray-100 rounded">
                        <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                        </svg>
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="text-xs text-gray-500 truncate">ç¸½ç‰©å“æ•¸</p>
                        <p class="text-lg font-bold text-gray-700" x-text="stats.totalItems"></p>
                    </div>
                </div>
            </div>

            <!-- åº«å­˜è­¦æˆ’ -->
            <div class="bg-white rounded-lg shadow-sm p-2.5">
                <div class="flex items-center gap-2">
                    <div class="p-1.5 bg-gray-100 rounded">
                        <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                        </svg>
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center gap-1">
                            <p class="text-xs text-gray-500 truncate">åº«å­˜è­¦æˆ’</p>
                            <div class="group relative cursor-help">
                                <svg class="w-3 h-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                <div class="invisible group-hover:visible absolute bottom-full left-0 mb-1 px-2 py-1 bg-gray-800 text-white text-xs rounded whitespace-nowrap z-50">
                                    åƒ…çµ±è¨ˆæœ‰é€²è²¨è¨˜éŒ„çš„å“é …
                                </div>
                            </div>
                        </div>
                        <p class="text-lg font-bold text-gray-700" x-text="stats.lowStockItems"></p>
                    </div>
                </div>
            </div>

            <!-- è¡€è¢‹åº«å­˜ -->
            <div class="bg-white rounded-lg shadow-sm p-2.5">
                <div class="flex items-center gap-2">
                    <div class="p-1.5 bg-gray-100 rounded">
                        <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
                        </svg>
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="text-xs text-gray-500 truncate">è¡€è¢‹åº«å­˜</p>
                        <p class="text-lg font-bold text-gray-700"><span x-text="stats.totalBlood"></span> U</p>
                    </div>
                </div>
            </div>

            <!-- å¾…ç¢ºèªè¨­å‚™ -->
            <div class="bg-white rounded-lg shadow-sm p-2.5">
                <div class="flex items-center gap-2">
                    <div class="p-1.5 bg-gray-100 rounded">
                        <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z"></path>
                        </svg>
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="text-xs text-gray-500 truncate">å¾…ç¢ºèªè¨­å‚™</p>
                        <p class="text-lg font-bold text-gray-700" x-text="stats.equipmentAlerts"></p>
                    </div>
                </div>
            </div>

            <!-- å¯ç¨ç«‹é‹ä½œ -->
            <div class="bg-white rounded-lg shadow-sm p-2.5">
                <div class="flex items-center gap-2">
                    <div class="p-1.5 bg-gray-100 rounded">
                        <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
                        </svg>
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="text-xs text-gray-500 truncate">å¯ç¨ç«‹é‹ä½œ</p>
                        <p class="text-lg font-bold"
                           :class="{
                               'text-red-600': resilienceStatus.summary?.overall_status === 'CRITICAL',
                               'text-yellow-600': resilienceStatus.summary?.overall_status === 'WARNING',
                               'text-green-600': resilienceStatus.summary?.overall_status === 'SAFE',
                               'text-gray-400': !resilienceStatus.summary?.weakest_link
                           }">
                            <span x-text="resilienceStatus.summary?.weakest_link?.hours?.toFixed(1) || 'â€”'"></span>
                            <span class="text-xs font-normal" x-show="resilienceStatus.summary?.weakest_link">h</span>
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- åˆ†é é¸å–® - æ·±è‰²åº•ç™½å­— -->
        <div class="bg-white rounded-xl shadow mb-4 sm:mb-6">
            <div class="grid grid-cols-2 sm:flex sm:flex-nowrap gap-1.5 sm:gap-2 p-1.5 sm:p-2">
                <!-- ç‰©å“æŸ¥è©¢ - Tealè‰²ç³» -->
                <button @click="switchTab('items')"
                        :class="currentTab === 'items' ? 'bg-teal-custom-500 text-white font-semibold shadow-md' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'"
                        class="flex-1 py-2.5 sm:py-3 px-2 sm:px-3 md:px-4 rounded-lg transition-all duration-200 flex items-center justify-center gap-1.5 sm:gap-2 min-w-0">
                    <svg class="w-4 h-4 sm:w-5 sm:h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/>
                    </svg>
                    <span class="text-sm sm:text-base font-medium truncate">åº«å­˜æŸ¥è©¢</span>
                </button>

                <!-- é€²è²¨ç™»è¨˜ - è—è‰²ç³» -->
                <button @click="switchTab('receive')"
                        :class="currentTab === 'receive' ? 'bg-blue-600 text-white font-semibold shadow-md' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'"
                        class="flex-1 py-2.5 sm:py-3 px-2 sm:px-3 md:px-4 rounded-lg transition-all duration-200 flex items-center justify-center gap-1.5 sm:gap-2 min-w-0">
                    <svg class="w-4 h-4 sm:w-5 sm:h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"/>
                    </svg>
                    <span class="text-sm sm:text-base font-medium truncate">é€²è²¨</span>
                </button>

                <!-- è™•ç½® - è™•ç½®è‰²ç³» #4E5488 -->
                <button @click="switchTab('treatment')"
                        :class="currentTab === 'treatment' ? 'bg-treatment-500 text-white font-semibold shadow-md' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'"
                        class="flex-1 py-2.5 sm:py-3 px-2 sm:px-3 md:px-4 rounded-lg transition-all duration-200 flex items-center justify-center gap-1.5 sm:gap-2 min-w-0">
                    <svg class="w-4 h-4 sm:w-5 sm:h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                    <span class="text-sm sm:text-base font-medium truncate">è™•ç½®</span>
                </button>

                <!-- è¡€è¢‹ç®¡ç† - è¡€åº«è‰²ç³» #D96754 (claude-red) -->
                <button @click="switchTab('blood')"
                        :class="currentTab === 'blood' ? 'bg-claude-red-500 text-white font-semibold shadow-md' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'"
                        class="flex-1 py-2.5 sm:py-3 px-2 sm:px-3 md:px-4 rounded-lg transition-all duration-200 flex items-center justify-center gap-1.5 sm:gap-2 min-w-0">
                    <svg class="w-4 h-4 sm:w-5 sm:h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"/>
                    </svg>
                    <span class="text-sm sm:text-base font-medium truncate">è¡€è¢‹ç®¡ç†</span>
                </button>

                <!-- è¨­å‚™ç®¡ç† - è¨­å‚™è‰²ç³» #6C7362 -->
                <button @click="switchTab('equipment')"
                        :class="currentTab === 'equipment' ? 'bg-equipment-500 text-white font-semibold shadow-md' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'"
                        class="flex-1 py-2.5 sm:py-3 px-2 sm:px-3 md:px-4 rounded-lg transition-all duration-200 flex items-center justify-center gap-1.5 sm:gap-2 min-w-0">
                    <svg class="w-4 h-4 sm:w-5 sm:h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                    </svg>
                    <span class="text-sm sm:text-base font-medium truncate">è¨­å‚™ç®¡ç†</span>
                </button>

                <!-- éŸŒæ€§ä¼°ç®— - æ©™è‰²ç³» #F59E0B -->
                <button @click="switchTab('resilience')"
                        :class="currentTab === 'resilience' ? 'bg-amber-500 text-white font-semibold shadow-md' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'"
                        class="flex-1 py-2.5 sm:py-3 px-2 sm:px-3 md:px-4 rounded-lg transition-all duration-200 flex items-center justify-center gap-1.5 sm:gap-2 min-w-0">
                    <svg class="w-4 h-4 sm:w-5 sm:h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
                    </svg>
                    <span class="text-sm sm:text-base font-medium truncate">éŸŒæ€§ä¼°ç®—</span>
                </button>

            </div>
        </div>

        <!-- ç‰©å“æŸ¥è©¢åˆ†é  -->
        <div x-show="currentTab === 'items'" class="bg-white rounded-xl shadow-lg p-3 sm:p-4 md:p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                    <svg class="w-6 h-6 text-teal-custom-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/>
                    </svg>
                    åº«å­˜æŸ¥è©¢
                </h2>
                <div class="flex gap-2">
                    <button @click="showInventoryCheckHistoryModal = true; loadInventoryCheckHistory()" class="bg-cyan-600 text-white px-4 py-2 rounded-lg hover:bg-cyan-700 transition-colors flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/>
                        </svg>
                        <span>æ ¸å°è¨˜éŒ„</span>
                    </button>
                    <button @click="showAddItemModal = true" class="bg-teal-custom-500 text-white px-4 py-2 rounded-lg hover:bg-teal-custom-600 transition-colors flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                        </svg>
                        <span>æ–°å¢ç‰©å“</span>
                    </button>
                    <button @click="loadItems()" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                        </svg>
                        <span>é‡æ–°è¼‰å…¥</span>
                    </button>
                </div>
            </div>

            <!-- åˆ†é¡ç¯©é¸æ¨™ç±¤ (v1.4.2-plus: è—¥å“/è€—æåˆ†é¡) -->
            <div class="flex flex-wrap gap-2 mb-4">
                <button @click="itemCategoryFilter = ''; filterItems()"
                        :class="itemCategoryFilter === '' ? 'bg-teal-custom-500 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'"
                        class="px-4 py-2 rounded-lg text-sm font-medium transition-colors">å…¨éƒ¨</button>
                <button @click="itemCategoryFilter = 'medicine'; filterItems()"
                        :class="itemCategoryFilter === 'medicine' ? 'bg-pharma-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'"
                        class="px-4 py-2 rounded-lg text-sm font-medium transition-colors flex items-center gap-1">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"/>
                    </svg>
                    è—¥å“
                </button>
                <button @click="itemCategoryFilter = 'consumable'; filterItems()"
                        :class="itemCategoryFilter === 'consumable' ? 'bg-pharma-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'"
                        class="px-4 py-2 rounded-lg text-sm font-medium transition-colors flex items-center gap-1">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/>
                    </svg>
                    è€—æ
                </button>
                <button @click="itemCategoryFilter = 'reagent'; filterItems()"
                        :class="itemCategoryFilter === 'reagent' ? 'bg-pharma-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'"
                        class="px-4 py-2 rounded-lg text-sm font-medium transition-colors flex items-center gap-1">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z"/>
                    </svg>
                    è©¦åŠ‘
                </button>
            </div>

            <!-- æœå°‹æ¡†å’ŒåŒ¯å‡ºæŒ‰éˆ• -->
            <div class="mb-4 flex gap-4 items-end flex-wrap sm:flex-nowrap">
                <div class="flex-1 w-full sm:w-auto">
                    <label class="block text-sm font-medium text-gray-700 mb-2 flex items-center gap-2">
                        <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                        </svg>
                        æœå°‹ç‰©å“
                    </label>
                    <input type="text" x-model="itemSearchText" @input="filterItems()" placeholder="è¼¸å…¥ä»£ç¢¼æˆ–åç¨±æœå°‹..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-custom-500">
                </div>
                <div class="flex gap-2">
                    <button @click.prevent.stop="exportInventoryCSV()" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                        <span>CSV</span>
                    </button>
                    <button @click.prevent.stop="exportInventoryJSON()" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                        <span>JSON</span>
                    </button>
                </div>
            </div>

            <!-- æ‰‹æ©Ÿç‰ˆ: å¡ç‰‡å¼åˆ—è¡¨ -->
            <div class="block sm:hidden space-y-3">
                <template x-for="item in filteredItems" :key="item.code">
                    <div class="border rounded-lg p-3" :class="item.current_stock < item.min_stock ? 'border-red-300 bg-red-50' : 'border-gray-200'">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <span class="font-mono text-xs text-gray-500" x-text="item.code"></span>
                                <h3 class="font-medium text-gray-900" x-text="item.name"></h3>
                            </div>
                            <span class="px-2 py-1 text-xs font-medium rounded-full bg-teal-variant-100 text-teal-variant-700" x-text="item.category"></span>
                        </div>
                        <div class="flex justify-between items-center">
                            <div class="flex gap-4 text-sm">
                                <span>
                                    <span class="text-gray-500">åº«å­˜:</span>
                                    <span :class="item.current_stock < item.min_stock ? 'text-red-600 font-bold' : 'text-green-600 font-semibold'" x-text="item.current_stock"></span>
                                    <span class="text-gray-400" x-text="item.unit"></span>
                                </span>
                                <span class="text-gray-400">å®‰å…¨é‡: <span x-text="item.min_stock"></span></span>
                            </div>
                            <div class="flex gap-2">
                                <button @click="editItem(item)" class="text-teal-custom-500 hover:text-teal-custom-600 text-sm">ç·¨è¼¯</button>
                                <button @click="deleteItem(item.code, item.name)" class="text-red-600 hover:text-red-800 text-sm">åˆªé™¤</button>
                            </div>
                        </div>
                    </div>
                </template>
            </div>

            <!-- æ¡Œé¢ç‰ˆ: è¡¨æ ¼ -->
            <div class="hidden sm:block overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200 table-hover">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ä»£ç¢¼</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">åç¨±</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">åˆ†é¡</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">åº«å­˜</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">å®‰å…¨é‡</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">å–®ä½</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        <template x-for="item in filteredItems" :key="item.code">
                            <tr :class="item.current_stock < item.min_stock ? 'bg-red-50' : ''">
                                <td class="px-4 py-3 whitespace-nowrap text-sm font-mono text-gray-900" x-text="item.code"></td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900" x-text="item.name"></td>
                                <td class="px-4 py-3 whitespace-nowrap">
                                    <span class="px-2 py-1 text-xs font-medium rounded-full bg-teal-variant-100 text-teal-variant-700" x-text="item.category"></span>
                                </td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm">
                                    <span :class="item.current_stock < item.min_stock ? 'text-red-600 font-bold' : 'text-green-600 font-semibold'"
                                          x-text="item.current_stock"></span>
                                </td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500" x-text="item.min_stock"></td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500" x-text="item.unit"></td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm space-x-2">
                                    <button @click="editItem(item)" class="text-teal-custom-500 hover:text-teal-custom-600">ç·¨è¼¯</button>
                                    <button @click="deleteItem(item.code, item.name)" class="text-red-600 hover:text-red-800">åˆªé™¤</button>
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- é€²è²¨åˆ†é  -->
        <div x-show="currentTab === 'receive'" class="bg-white rounded-xl shadow-lg p-3 sm:p-4 md:p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                    <svg class="w-6 h-6 text-sky-custom-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"/>
                    </svg>
                    é€²è²¨ç™»è¨˜
                </h2>
                <button @click.prevent.stop="showReceiveHistoryModal = true; loadReceiveHistory()" class="bg-sky-custom-600 text-white px-4 py-2 rounded-lg hover:bg-sky-custom-500 transition-colors flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                    <span>æŸ¥çœ‹é€²è²¨è¨˜éŒ„</span>
                </button>
            </div>

            <form @submit.prevent="submitReceive()" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="relative">
                        <label class="block text-sm font-medium text-gray-700 mb-2">ç‰©å“ä»£ç¢¼ * (å¯æœå°‹)</label>
                        <input
                            type="text"
                            x-model="receiveItemSearch"
                            @input="filterReceiveItems()"
                            @focus="showReceiveDropdown = true; if (filteredReceiveItems.length === 0) filterReceiveItems();"
                            @blur="setTimeout(() => showReceiveDropdown = false, 200)"
                            placeholder="è¼¸å…¥ä»£ç¢¼æˆ–åç¨±æœå°‹..."
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-sky-custom-600 focus:border-transparent"
                        >
                        <div x-show="showReceiveDropdown && filteredReceiveItems.length > 0" class="absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-y-auto">
                            <template x-for="item in filteredReceiveItems.slice(0, 10)" :key="item.code">
                                <div @click.stop="selectReceiveItem(item)" class="px-4 py-2 hover:bg-sky-100 cursor-pointer">
                                    <span class="font-mono text-sm" x-text="item.code"></span> -
                                    <span x-text="item.name"></span>
                                    <span class="text-xs text-gray-500" x-text="`(åº«å­˜: ${item.current_stock})`"></span>
                                </div>
                            </template>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">æ•¸é‡ *</label>
                        <input type="number" x-model="receiveForm.quantity" required min="1" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-sky-custom-600 focus:border-transparent">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">æ‰¹è™Ÿ</label>
                        <input type="text" x-model="receiveForm.batchNumber" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-sky-custom-600 focus:border-transparent">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">æ•ˆæœŸ</label>
                        <input type="date" x-model="receiveForm.expiryDate" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-sky-custom-600 focus:border-transparent">
                    </div>

                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">å‚™è¨»</label>
                        <textarea x-model="receiveForm.remarks" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-sky-custom-600 focus:border-transparent"></textarea>
                    </div>
                </div>

                <div class="flex gap-4">
                    <button type="submit" class="bg-sky-custom-600 text-white px-6 py-2 rounded-lg hover:bg-sky-custom-500 transition-colors flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                        </svg>
                        <span>ç¢ºèªé€²è²¨</span>
                    </button>
                    <button type="button" @click="resetReceiveForm()" class="bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-600 transition-colors flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                        </svg>
                        <span>é‡ç½®</span>
                    </button>
                </div>
            </form>
        </div>

        <!-- è™•ç½®åˆ†é  (æ•´åˆæ‰‹è¡“è¨˜éŒ„ + ä¸€èˆ¬æ¶ˆè€—) -->
        <div x-show="currentTab === 'treatment'" class="bg-white rounded-xl shadow-lg p-3 sm:p-4 md:p-6">
            <!-- æ¨™é¡Œèˆ‡æ¨¡å¼åˆ‡æ› -->
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-4">
                <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                    <svg class="w-6 h-6 text-treatment-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                    è™•ç½®ç®¡ç†
                </h2>

                <!-- å·¦å´åˆ‡æ›æŒ‰éˆ• -->
                <div class="flex gap-2 flex-wrap">
                    <button @click="treatmentMode = 'surgery'"
                            :class="treatmentMode === 'surgery' ? 'bg-treatment-500 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'"
                            class="px-4 py-2 rounded-lg transition-colors flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                        </svg>
                        <span>è™•ç½®è€—æè¨˜éŒ„</span>
                    </button>
                    <button @click="treatmentMode = 'consume'"
                            :class="treatmentMode === 'consume' ? 'bg-treatment-500 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'"
                            class="px-4 py-2 rounded-lg transition-colors flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                        </svg>
                        <span>ä¸€èˆ¬æ¶ˆè€—</span>
                    </button>
                    <button @click="treatmentMode = 'dispense'; loadPendingDispenses()"
                            :class="treatmentMode === 'dispense' ? 'bg-dispense-purple-700 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'"
                            class="px-4 py-2 rounded-lg transition-colors flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/>
                        </svg>
                        <span>è—¥å“é ˜ç”¨</span>
                    </button>
                </div>
            </div>

            <!-- è™•ç½®è€—æè¨˜éŒ„æ¨¡å¼ (æ‰‹è¡“è¨˜éŒ„) -->
            <div x-show="treatmentMode === 'surgery'" x-init="loadCirsProcedureWaiting()">

                <!-- v1.1: CIRS å¾…è™•ç½®æ¸…å–® -->
                <div class="mb-6 bg-gray-50 rounded-lg p-4 border border-gray-200">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="font-semibold text-gray-700 flex items-center gap-2">
                            <svg class="w-5 h-5 text-treatment-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                            </svg>
                            CIRS å¾…è™•ç½®æ¸…å–®
                        </h3>
                        <div class="flex items-center gap-2">
                            <span x-show="cirsProcedureStatus.online" class="text-sm text-green-600 flex items-center gap-1">
                                <span class="w-2 h-2 bg-green-500 rounded-full"></span>
                                é€£ç·š (<span x-text="cirsProcedurePatients.length"></span> ä½)
                            </span>
                            <span x-show="!cirsProcedureStatus.online" class="text-sm text-gray-500 flex items-center gap-1">
                                <span class="w-2 h-2 bg-gray-400 rounded-full"></span>
                                é›¢ç·š
                            </span>
                            <!-- v1.2: é¡¯ç¤ºæœ€å¾ŒåŒæ­¥æ™‚é–“ -->
                            <span x-show="cirsProcedureStatus.lastSynced" class="text-xs text-gray-400"
                                  x-text="'åŒæ­¥: ' + (cirsProcedureStatus.lastSynced ? new Date(cirsProcedureStatus.lastSynced).toLocaleTimeString('zh-TW', {hour: '2-digit', minute: '2-digit'}) : '')"></span>
                            <button @click="loadCirsProcedureWaiting()" class="text-gray-500 hover:text-treatment-500 p-1">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                                </svg>
                            </button>
                        </div>
                    </div>

                    <!-- å¾…è™•ç½®ç—…æ‚£åˆ—è¡¨ -->
                    <div x-show="cirsProcedurePatients.length > 0" class="space-y-2 max-h-48 overflow-y-auto">
                        <template x-for="patient in cirsProcedurePatients" :key="patient.registration_id">
                            <div @click="selectProcedurePatient(patient)"
                                 class="p-3 bg-white rounded-lg border border-gray-200 hover:border-treatment-500 hover:bg-treatment-50 cursor-pointer transition-all">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <span class="font-medium" x-text="patient.name || patient.patient_ref || 'æœªçŸ¥'"></span>
                                        <span class="text-sm text-gray-500 ml-2" x-text="patient.patient_id || ''"></span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <span x-show="patient.waiting_minutes" class="text-xs text-gray-400" x-text="'ç­‰å¾… ' + patient.waiting_minutes + ' åˆ†'"></span>
                                        <span class="text-xs px-2 py-0.5 rounded"
                                              :class="{
                                                  'bg-red-100 text-red-700': patient.priority === 'STAT',
                                                  'bg-orange-100 text-orange-700': patient.priority === 'URGENT',
                                                  'bg-green-100 text-green-700': patient.priority === 'ROUTINE' || !patient.priority
                                              }"
                                              x-text="patient.priority === 'STAT' ? 'æ€¥' : patient.priority === 'URGENT' ? 'ç·Š' : 'å¸¸'"></span>
                                    </div>
                                </div>
                                <div class="text-sm text-gray-600 mt-1">
                                    <span x-show="patient.chief_complaint" x-text="patient.chief_complaint"></span>
                                    <span x-show="patient.procedure_notes" class="text-treatment-600 ml-2" x-text="'[' + patient.procedure_notes + ']'"></span>
                                </div>
                                <div x-show="patient.consultation_by" class="text-xs text-gray-400 mt-1" x-text="'é†«å¸«: ' + patient.consultation_by"></div>
                            </div>
                        </template>
                    </div>

                    <div x-show="cirsProcedurePatients.length === 0 && cirsProcedureStatus.online" class="text-center text-gray-500 py-4">
                        ç›®å‰ç„¡å¾…è™•ç½®ç—…æ‚£
                        <div class="text-xs text-gray-400 mt-1">é†«å¸«å®Œæˆçœ‹è¨ºä¸¦å‹¾é¸ã€Œéœ€è™•ç½®ã€å¾Œï¼Œç—…æ‚£æœƒå‡ºç¾åœ¨æ­¤</div>
                    </div>

                    <div x-show="!cirsProcedureStatus.online" class="text-center text-gray-500 py-4">
                        CIRS æœªé€£ç·š
                        <div class="text-xs text-gray-400 mt-1">è«‹ä½¿ç”¨ä¸‹æ–¹ã€Œæ–°å¢è™•ç½®è€—æè¨˜éŒ„ã€æ‰‹å‹•è¼¸å…¥</div>
                    </div>
                </div>

                <!-- åˆ†éš”ç·š -->
                <div class="relative mb-4">
                    <div class="absolute inset-0 flex items-center"><div class="w-full border-t border-gray-200"></div></div>
                    <div class="relative flex justify-center text-sm"><span class="px-2 bg-white text-gray-500">æˆ–</span></div>
                </div>

                <div class="flex flex-wrap gap-2 mb-4">
                    <button @click.prevent.stop="ensureItemsLoaded(); showAddSurgeryModal = true" class="bg-treatment-500 text-white px-4 py-2 rounded-lg hover:bg-[#3d4270] transition-colors flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                        </svg>
                        <span>æ‰‹å‹•æ–°å¢è™•ç½®è€—æè¨˜éŒ„</span>
                    </button>
                    <button @click.prevent.stop="exportSurgeryCSV()" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                        <span>åŒ¯å‡º CSV</span>
                    </button>
                    <button @click.prevent.stop="loadSurgeryRecords()" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                        </svg>
                        <span>é‡æ–°è¼‰å…¥</span>
                    </button>
                </div>

                <!-- æœå°‹ç¯©é¸ -->
                <div class="mb-4 grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">é–‹å§‹æ—¥æœŸ</label>
                        <input type="date" x-model="surgerySearchForm.startDate" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-treatment-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">çµæŸæ—¥æœŸ</label>
                        <input type="date" x-model="surgerySearchForm.endDate" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-treatment-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ç—…æ‚£å§“å</label>
                        <input type="text" x-model="surgerySearchForm.patientName" placeholder="æœå°‹ç—…æ‚£..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-treatment-500">
                    </div>
                </div>

                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200 table-hover">
                        <thead class="bg-treatment-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">è¨˜éŒ„ç·¨è™Ÿ</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æ—¥æœŸ</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ç—…æ‚£å§“å</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">è™•ç½®é¡å‹</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ä¸»åˆ€é†«å¸«</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æ™‚é•·(åˆ†)</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            <template x-for="record in surgeryRecords" :key="record.id">
                                <tr>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-mono text-gray-900" x-text="record.record_number"></td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" x-text="record.record_date"></td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" x-text="record.patient_name"></td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" x-text="record.surgery_type"></td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" x-text="record.surgeon_name"></td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" x-text="record.duration_minutes || '-'"></td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                                        <button @click="viewSurgeryDetail(record)" class="text-treatment-500 hover:text-[#3d4270] font-medium">è©³æƒ…</button>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>

                <!-- è¡“å¼ä¸»æª”å¿«æŸ¥ (treatment è‰²ç³») -->
                <div class="mt-6 border-2 border-treatment-300 rounded-lg p-4 bg-treatment-50" x-init="$nextTick(() => { if(!dataLoaded.surgeryMaster) { loadSurgeryCategories(); loadSelfPayCategories(); } })">
                    <h4 class="text-lg font-semibold text-treatment-700 flex items-center gap-2 mb-4">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"/>
                        </svg>
                        è¡“å¼ä¸»æª”å¿«æŸ¥
                    </h4>

                    <!-- å­ Tab åˆ‡æ› -->
                    <div class="flex gap-2 mb-4">
                        <button @click="surgeryMasterSubTab = 'codes'; if(surgeryCodes.length === 0) searchSurgeryCodes()"
                                :class="surgeryMasterSubTab === 'codes' ? 'bg-treatment-500 text-white' : 'bg-white text-treatment-700 border border-treatment-300'"
                                class="px-3 py-1.5 rounded text-sm font-medium transition-colors">
                            è¡“å¼ä»£ç¢¼
                        </button>
                        <button @click="surgeryMasterSubTab = 'selfpay'; if(selfPayItems.length === 0) searchSelfPayItems()"
                                :class="surgeryMasterSubTab === 'selfpay' ? 'bg-treatment-500 text-white' : 'bg-white text-treatment-700 border border-treatment-300'"
                                class="px-3 py-1.5 rounded text-sm font-medium transition-colors">
                            è‡ªè²»é …ç›®
                        </button>
                        <button @click="surgeryMasterSubTab = 'calculator'"
                                :class="surgeryMasterSubTab === 'calculator' ? 'bg-treatment-500 text-white' : 'bg-white text-treatment-700 border border-treatment-300'"
                                class="px-3 py-1.5 rounded text-sm font-medium transition-colors">
                            é»æ•¸è¨ˆç®—
                        </button>
                    </div>

                    <!-- è¡“å¼ä»£ç¢¼ -->
                    <div x-show="surgeryMasterSubTab === 'codes'">
                        <div class="flex gap-2 mb-3">
                            <select x-model="surgeryCodeCategoryFilter" @change="searchSurgeryCodes()"
                                    class="px-2 py-1 border border-treatment-300 rounded text-sm focus:ring-treatment-500">
                                <option value="">å…¨éƒ¨åˆ†é¡</option>
                                <template x-for="cat in surgeryCategories" :key="cat.category_code">
                                    <option :value="cat.category_code" x-text="cat.category_name"></option>
                                </template>
                            </select>
                            <input type="text" x-model="surgeryCodeSearchText" @input.debounce.300ms="searchSurgeryCodes()"
                                   placeholder="æœå°‹..." class="flex-1 px-3 py-1 border border-treatment-300 rounded text-sm focus:ring-treatment-500">
                        </div>
                        <div class="max-h-64 overflow-y-auto space-y-2">
                            <template x-for="code in surgeryCodes.slice(0, 20)" :key="code.code">
                                <div class="flex justify-between items-center px-3 py-2 bg-white rounded border border-treatment-200">
                                    <div>
                                        <span class="font-mono text-xs text-gray-500" x-text="code.code"></span>
                                        <span class="ml-2 text-sm" x-text="code.name_zh"></span>
                                    </div>
                                    <span class="text-sm font-medium text-treatment-600" x-text="code.points?.toLocaleString() + ' é»'"></span>
                                </div>
                            </template>
                        </div>
                        <p class="text-xs text-treatment-500 mt-2" x-text="'å…± ' + surgeryCodes.length + ' ç­†' + (surgeryCodes.length > 20 ? 'ï¼Œé¡¯ç¤ºå‰ 20 ç­†' : '')"></p>
                    </div>

                    <!-- è‡ªè²»é …ç›® (v2.7.3: åŠ å…¥ Queue åŠŸèƒ½) -->
                    <div x-show="surgeryMasterSubTab === 'selfpay'">
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                            <!-- å·¦å´ï¼šè‡ªè²»é …ç›®åˆ—è¡¨ -->
                            <div>
                                <div class="flex gap-2 mb-3">
                                    <select x-model="selfPayCategoryFilter" @change="searchSelfPayItems()"
                                            class="px-2 py-1 border border-treatment-300 rounded text-sm focus:ring-treatment-500">
                                        <option value="">å…¨éƒ¨åˆ†é¡</option>
                                        <template x-for="cat in selfPayCategories" :key="cat.category">
                                            <option :value="cat.category" x-text="cat.category"></option>
                                        </template>
                                    </select>
                                    <input type="text" x-model="selfPaySearchText" @input.debounce.300ms="searchSelfPayItems()"
                                           placeholder="æœå°‹..." class="flex-1 px-3 py-1 border border-treatment-300 rounded text-sm focus:ring-treatment-500">
                                </div>
                                <div class="max-h-48 overflow-y-auto space-y-1">
                                    <template x-for="item in selfPayItems.slice(0, 15)" :key="item.item_id">
                                        <button @click="addToSelfPayQueue(item)"
                                                class="w-full text-left flex justify-between items-center px-3 py-2 bg-white rounded border border-treatment-200 hover:bg-treatment-100 hover:border-treatment-400 transition-colors">
                                            <div class="truncate flex-1 mr-2">
                                                <span class="text-sm" x-text="item.name"></span>
                                            </div>
                                            <span class="text-sm font-medium text-green-600 whitespace-nowrap" x-text="'$' + item.unit_price?.toLocaleString()"></span>
                                        </button>
                                    </template>
                                </div>
                                <p class="text-xs text-treatment-500 mt-1" x-text="'å…± ' + selfPayItems.length + ' ç­†' + (selfPayItems.length > 15 ? 'ï¼Œé¡¯ç¤ºå‰ 15 ç­†' : '') + ' (é»æ“ŠåŠ å…¥)'"></p>
                            </div>

                            <!-- å³å´ï¼šè‡ªè²» Queue -->
                            <div class="bg-treatment-50 rounded-lg p-3">
                                <div class="flex justify-between items-center mb-2">
                                    <h5 class="font-medium text-treatment-700">è²»ç”¨æ¸…å–®</h5>
                                    <button x-show="selfPayQueue.length > 0" @click="clearSelfPayQueue()"
                                            class="text-xs text-red-500 hover:text-red-700">æ¸…ç©º</button>
                                </div>
                                <div class="max-h-40 overflow-y-auto space-y-1 mb-2">
                                    <template x-for="(item, idx) in selfPayQueue" :key="item.item_id">
                                        <div class="flex justify-between items-center px-2 py-1 bg-white rounded border border-treatment-200">
                                            <span class="text-sm truncate flex-1 mr-2" x-text="item.name"></span>
                                            <div class="flex items-center gap-1">
                                                <button @click="updateSelfPayQueueQty(idx, -1)" class="w-5 h-5 text-xs bg-gray-200 rounded hover:bg-gray-300">âˆ’</button>
                                                <span class="text-sm w-6 text-center" x-text="item.quantity"></span>
                                                <button @click="updateSelfPayQueueQty(idx, 1)" class="w-5 h-5 text-xs bg-gray-200 rounded hover:bg-gray-300">+</button>
                                                <span class="text-sm font-medium text-green-600 w-16 text-right" x-text="'$' + (item.unit_price * item.quantity).toLocaleString()"></span>
                                                <button @click="removeFromSelfPayQueue(idx)" class="text-red-500 text-xs ml-1">âœ•</button>
                                            </div>
                                        </div>
                                    </template>
                                </div>
                                <div x-show="selfPayQueue.length === 0" class="text-center text-gray-400 py-4 text-sm">
                                    é»æ“Šå·¦å´å“é …åŠ å…¥æ¸…å–®
                                </div>
                                <div x-show="selfPayQueue.length > 0" class="border-t border-treatment-200 pt-2">
                                    <div class="flex justify-between items-center text-treatment-700 font-bold">
                                        <span>ç¸½è¨ˆï¼š</span>
                                        <span class="text-lg" x-text="'$' + getSelfPayQueueTotal().toLocaleString()"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- é»æ•¸è¨ˆç®—å™¨ -->
                    <div x-show="surgeryMasterSubTab === 'calculator'">
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                            <div>
                                <input type="text" x-model="calculatorSearchText" @input.debounce.300ms="searchForCalculator()"
                                       placeholder="æœå°‹è¡“å¼..." class="w-full px-3 py-2 border border-treatment-300 rounded text-sm mb-2">
                                <div class="max-h-40 overflow-y-auto space-y-1">
                                    <template x-for="code in calculatorSearchResults.slice(0, 10)" :key="code.code">
                                        <button @click="addToCalculator(code)"
                                                class="w-full text-left px-2 py-1 text-sm bg-white rounded border border-treatment-200 hover:bg-treatment-100">
                                            <span class="font-mono text-xs" x-text="code.code"></span>
                                            <span x-text="code.name_zh"></span>
                                            <span class="float-right text-treatment-600" x-text="code.points + 'é»'"></span>
                                        </button>
                                    </template>
                                </div>
                            </div>
                            <div>
                                <div class="space-y-1 mb-2">
                                    <template x-for="(item, idx) in calculatorSurgeries" :key="item.code">
                                        <div class="flex justify-between items-center px-2 py-1 rounded text-sm"
                                             :class="item.reduction_rate === 1 ? 'bg-green-100' : (item.reduction_rate === 0.5 ? 'bg-yellow-100' : 'bg-red-100')">
                                            <div class="flex-1">
                                                <span x-text="item.name_zh"></span>
                                                <span class="text-xs text-gray-500 ml-1" x-text="'(' + Math.round(item.reduction_rate * 100) + '%)'"></span>
                                            </div>
                                            <div class="flex items-center gap-2">
                                                <span x-text="(item.final_points || 0).toLocaleString() + 'é»'"></span>
                                                <button @click="removeFromCalculator(idx)" class="text-red-500 text-xs">âœ•</button>
                                            </div>
                                        </div>
                                    </template>
                                </div>
                                <div x-show="calculatorSurgeries.length > 0" class="text-right font-bold text-treatment-700">
                                    ç¸½è¨ˆ: <span x-text="getCalculatorTotal().toLocaleString()"></span> é»
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ä¸€èˆ¬æ¶ˆè€—æ¨¡å¼ (v3.0: å·²é·ç§»è‡³ Nursing PWA) -->
            <div x-show="treatmentMode === 'consume'">
                <!-- é·ç§»é€šçŸ¥ -->
                <div class="mb-6 p-6 bg-blue-50 border-2 border-blue-200 rounded-xl">
                    <div class="flex items-start gap-4">
                        <div class="flex-shrink-0">
                            <svg class="w-10 h-10 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                        </div>
                        <div class="flex-1">
                            <h3 class="text-lg font-bold text-blue-800 mb-2">åŠŸèƒ½å·²é·ç§»</h3>
                            <p class="text-blue-700 mb-4">ä¸€èˆ¬æ¶ˆè€—åŠŸèƒ½å·²æ•´åˆè‡³ <strong>Nursing PWA</strong>ï¼Œæä¾›æ›´å®Œæ•´çš„çµ¦è—¥ç¢ºèªã€æƒç¢¼æ ¸å°ã€é›¢ç·šæ”¯æ´ç­‰åŠŸèƒ½ã€‚</p>
                            <a href="/nurse/" target="_blank"
                               class="inline-flex items-center gap-2 bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors font-semibold">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
                                </svg>
                                é–‹å•Ÿ Nursing PWA
                            </a>
                        </div>
                    </div>
                </div>

                <!-- æ¶ˆè€—è¨˜éŒ„ (å”¯è®€) -->
                <div class="bg-gray-50 rounded-lg p-4">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold text-gray-700 flex items-center gap-2">
                            <svg class="w-5 h-5 text-treatment-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                            </svg>
                            æ¶ˆè€—è¨˜éŒ„ (å”¯è®€)
                        </h3>
                        <button @click.prevent.stop="showConsumeHistoryModal = true; loadConsumeHistory()" class="text-sm text-blue-600 hover:underline">
                            æŸ¥çœ‹å®Œæ•´è¨˜éŒ„
                        </button>
                    </div>

                    <!-- è³‡æºå°å¸³ç‹€æ…‹ (v3.0) -->
                    <div x-data="{ resourceIntents: [], loading: true }" x-init="
                        fetch('/api/resource-intents?limit=10')
                          .then(r => r.ok ? r.json() : { intents: [] })
                          .then(d => { resourceIntents = d.intents || []; loading = false; })
                          .catch(() => { loading = false; })
                    ">
                        <div x-show="loading" class="text-center py-4 text-gray-400">
                            è¼‰å…¥ä¸­...
                        </div>
                        <div x-show="!loading && resourceIntents.length === 0" class="text-center py-8 text-gray-400">
                            <svg class="w-12 h-12 mx-auto mb-2 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            <p>ç›®å‰ç„¡å¾…åŒæ­¥è¨˜éŒ„</p>
                        </div>
                        <div x-show="!loading && resourceIntents.length > 0" class="space-y-2">
                            <template x-for="intent in resourceIntents" :key="intent.id">
                                <div class="flex items-center justify-between bg-white rounded-lg p-3 border"
                                     :class="intent.status === 'CONFIRMED' ? 'border-green-200' : intent.status === 'FAILED' ? 'border-red-200' : 'border-yellow-200'">
                                    <div class="flex-1">
                                        <span class="font-mono text-sm" x-text="intent.item_code"></span>
                                        <span class="text-gray-500 text-sm ml-2" x-text="'x' + intent.quantity"></span>
                                    </div>
                                    <span class="px-2 py-1 rounded text-xs font-semibold"
                                          :class="intent.status === 'CONFIRMED' ? 'bg-green-100 text-green-700' : intent.status === 'FAILED' ? 'bg-red-100 text-red-700' : 'bg-yellow-100 text-yellow-700'"
                                          x-text="intent.status === 'CONFIRMED' ? 'å·²åŒæ­¥' : intent.status === 'FAILED' ? 'åŒæ­¥å¤±æ•—' : 'å¾…åŒæ­¥'"></span>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>
            </div>

            <!-- è—¥å“é ˜ç”¨æ¨¡å¼ (MIRS v2.3 - Emergency Dispense) -->
            <div x-show="treatmentMode === 'dispense'">
                <div class="flex justify-between mb-4">
                    <!-- æ’¥ç™¼çµ¦è—¥å±€æŒ‰éˆ• (MIRS v2.4) -->
                    <button @click.prevent.stop="openDispatchModal()" class="bg-treatment-500 text-white px-4 py-2 rounded-lg hover:bg-[#3d4270] transition-colors flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"/>
                        </svg>
                        <span>æ’¥ç™¼çµ¦è—¥å±€</span>
                    </button>
                    <button @click.prevent.stop="loadPendingDispenses()" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                        </svg>
                        <span>é‡æ–°è¼‰å…¥</span>
                    </button>
                </div>

                <!-- ç·Šæ€¥é ˜ç”¨è­¦ç¤º (å¦‚æœæœ‰å¾…ç¢ºèªçš„ç·Šæ€¥é ˜ç”¨) -->
                <div x-show="pendingDispenses.filter(d => d.status === 'EMERGENCY').length > 0" class="mb-4 p-4 bg-dispense-purple-50 border-l-4 border-dispense-purple-700 rounded">
                <div class="flex items-start gap-3">
                    <svg class="w-6 h-6 text-dispense-purple-700 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                    </svg>
                    <div class="flex-1">
                        <p class="font-semibold text-dispense-purple-900">ç·Šæ€¥é ˜ç”¨å¾…ç¢ºèª</p>
                        <p class="text-sm text-gray-600 mt-1">
                            æœ‰ <span class="font-bold text-dispense-purple-700" x-text="pendingDispenses.filter(d => d.status === 'EMERGENCY').length"></span> ç­†ç·Šæ€¥é ˜ç”¨éœ€è¦è—¥å¸«ç¢ºèª
                        </p>
                    </div>
                </div>
                </div>

                <!-- è—¥å“é ˜ç”¨è¡¨å–® (v3.0: å·²é·ç§»è‡³ Nursing PWAï¼Œåƒ…ä¿ç•™ç·Šæ€¥é ˜ç”¨å¯©æ ¸) -->
                <div class="bg-purple-50 border-2 border-purple-200 rounded-xl p-6 mb-6">
                    <div class="flex items-start gap-4">
                        <div class="flex-shrink-0">
                            <svg class="w-10 h-10 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                        </div>
                        <div class="flex-1">
                            <h3 class="text-lg font-bold text-purple-800 mb-2">é ˜ç”¨ç™»è¨˜å·²é·ç§»</h3>
                            <p class="text-purple-700 mb-4">è—¥å“é ˜ç”¨åŠŸèƒ½å·²æ•´åˆè‡³ <strong>Nursing PWA</strong>ï¼Œæä¾›ç—…æ‚£æ‰‹åœˆæƒç¢¼ã€è—¥å“æ¢ç¢¼æ ¸å°ã€é›¢ç·šçµ¦è—¥ç­‰åŠŸèƒ½ã€‚æœ¬é åƒ…ä¿ç•™<strong>è—¥å¸«å¯©æ ¸</strong>åŠŸèƒ½ã€‚</p>
                            <a href="/nurse/" target="_blank"
                               class="inline-flex items-center gap-2 bg-purple-600 text-white px-6 py-3 rounded-lg hover:bg-purple-700 transition-colors font-semibold">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
                                </svg>
                                é–‹å•Ÿ Nursing PWA
                            </a>
                        </div>
                    </div>
                </div>

                <!-- èˆŠç‰ˆç·Šæ€¥é ˜ç”¨å…¥å£ (ä¿ç•™çµ¦å°šæœªé·ç§»çš„æƒ…å¢ƒ) -->
                <details class="bg-gray-50 rounded-lg p-4 mb-6">
                    <summary class="cursor-pointer text-gray-600 font-medium flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                        </svg>
                        ç·Šæ€¥é ˜ç”¨ (èˆŠç‰ˆå…¥å£ï¼Œå³å°‡ç§»é™¤)
                    </summary>
                    <div class="mt-4 p-4 border border-gray-200 rounded-lg bg-white">
                        <p class="text-sm text-gray-500 mb-4">æ­¤åŠŸèƒ½å°‡æ–¼ä¸‹ä¸€ç‰ˆæœ¬ç§»é™¤ï¼Œè«‹ä½¿ç”¨ Nursing PWA é€²è¡Œè—¥å“é ˜ç”¨ã€‚</p>
                        <button type="button" @click="showEmergencyReasonModal = true"
                                class="bg-dispense-purple-700 text-white px-4 py-2 rounded-lg hover:bg-dispense-purple-900 transition-colors flex items-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                            </svg>
                            ç·Šæ€¥é ˜ç”¨ (Break-the-Glass)
                        </button>
                    </div>
                </details>

            <!-- å¾…è™•ç†é ˜ç”¨æ¸…å–® (è—¥å¸«å¯©æ ¸å€) -->
            <div class="bg-gray-50 rounded-lg p-4">
                <h3 class="text-lg font-semibold text-gray-700 mb-4 flex items-center gap-2">
                    <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                    </svg>
                    å¾…è™•ç†é ˜ç”¨ (è—¥å¸«å¯©æ ¸)
                </h3>

                <div x-show="pendingDispenses.length === 0" class="text-center py-8 text-gray-400">
                    <svg class="w-12 h-12 mx-auto mb-2 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    <p>ç›®å‰æ²’æœ‰å¾…è™•ç†çš„é ˜ç”¨è¨˜éŒ„</p>
                </div>

                <div x-show="pendingDispenses.length > 0" class="space-y-3">
                    <template x-for="dispense in pendingDispenses" :key="dispense.id">
                        <div class="bg-white rounded-lg p-4 shadow-sm border" :class="dispense.status === 'EMERGENCY' ? 'border-dispense-purple-700 bg-dispense-purple-50' : 'border-gray-200'">
                            <div class="flex flex-col sm:flex-row justify-between gap-4">
                                <div class="flex-1">
                                    <div class="flex items-center gap-2 mb-2">
                                        <span class="px-2 py-1 rounded text-xs font-semibold"
                                              :class="dispense.status === 'EMERGENCY' ? 'bg-dispense-purple-700 text-white' : 'bg-yellow-500 text-white'"
                                              x-text="dispense.status === 'EMERGENCY' ? 'ç·Šæ€¥é ˜ç”¨' : 'å¾…å¯©æ ¸'"></span>
                                        <span class="text-xs text-gray-500" x-text="`${dispense.hours_pending || 0} å°æ™‚å‰`"></span>
                                    </div>
                                    <p class="font-semibold text-gray-800" x-text="`${dispense.medicine_code} - ${dispense.medicine_name}`"></p>
                                    <p class="text-sm text-gray-600">æ•¸é‡: <span class="font-semibold" x-text="dispense.quantity"></span> <span x-text="dispense.unit"></span></p>
                                    <p class="text-sm text-gray-600">é ˜è—¥äºº: <span class="font-semibold" x-text="dispense.dispensed_by"></span></p>
                                    <p x-show="dispense.patient_name" class="text-sm text-gray-600">ç—…æ‚£: <span x-text="dispense.patient_name"></span></p>
                                    <p x-show="dispense.emergency_reason" class="text-sm text-dispense-purple-900 mt-2 font-medium">
                                        ç·Šæ€¥åŸå› : <span x-text="dispense.emergency_reason"></span>
                                    </p>
                                </div>
                                <div class="flex items-center">
                                    <button @click="openPharmacistApproval(dispense)" class="bg-dispense-purple-700 text-white px-4 py-2 rounded-lg hover:bg-dispense-purple-900 transition-colors flex items-center gap-2">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                        </svg>
                                        <span>è—¥å¸«ç¢ºèª</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>
            </div>
            </div>
        </div>

        <!-- è¡€è¢‹åˆ†é  -->
        <!-- CHANGED: x-show to style binding to force reactivity -->
        <div :style="currentTab === 'blood' ? '' : 'display: none !important'" class="bg-white rounded-xl shadow-lg p-3 sm:p-4 md:p-6">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-4">
                <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                    <svg class="w-6 h-6 text-blood-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/>
                    </svg>
                    è¡€åº«ç®¡ç†
                </h2>
                <button @click.prevent.stop="showBloodHistoryModal = true; loadBloodHistory()" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                    <span>æ­·å²è¨˜éŒ„</span>
                </button>
            </div>

            <!-- è¡€å‹åº«å­˜çµ±è¨ˆå€ - æ·±ç´…è‰²èƒŒæ™¯ -->
            <div class="bg-gradient-to-br from-red-900 to-red-950 rounded-xl p-6 mb-8 shadow-xl">
                <h3 class="text-white text-lg font-bold mb-4 flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                    </svg>
                    è¡€å‹åº«å­˜çµ±è¨ˆ
                </h3>
                <div class="grid grid-cols-2 sm:grid-cols-4 md:grid-cols-8 gap-3">
                    <template x-for="blood in bloodInventory" :key="blood.blood_type">
                        <div class="bg-red-800 bg-opacity-50 backdrop-blur rounded-lg p-4 border border-red-700 hover:border-red-500 transition-all duration-200 hover:shadow-lg">
                            <div class="text-center">
                                <!-- è¡€å‹æ¨™ç±¤ -->
                                <div class="text-sm font-bold text-red-100 mb-2" x-text="blood.blood_type"></div>
                                <!-- æ•¸é‡å¤§å­—é¡¯ç¤º - é0ç™½è‰²ï¼Œ0æ·ºç°è‰² -->
                                <div class="text-4xl font-extrabold mb-1"
                                     :class="blood.quantity > 0 ? 'text-white' : 'text-gray-400'"
                                     x-text="blood.quantity"></div>
                                <div class="text-xs text-red-200">è¢‹</div>
                            </div>
                        </div>
                    </template>
                </div>
            </div>

            <!-- åŠŸèƒ½å€ - æ·ºè‰²é¢¨æ ¼ï¼Œçµ±ä¸€ red è‰²ç³» -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- è¡€è¢‹å…¥åº« -->
                <div class="bg-white border-2 border-red-200 rounded-xl p-5 shadow-sm hover:shadow-md transition-shadow">
                    <h3 class="text-lg font-semibold text-red-700 mb-4 flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                        </svg>
                        è¡€è¢‹å…¥åº«
                    </h3>
                    <form @submit.prevent="submitBloodReceive()" class="space-y-3">
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">è¡€å‹ *</label>
                                <select x-model="bloodReceiveForm.bloodType" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent">
                                    <option value="">é¸æ“‡è¡€å‹</option>
                                    <option value="A+">A+</option>
                                    <option value="A-">A-</option>
                                    <option value="B+">B+</option>
                                    <option value="B-">B-</option>
                                    <option value="O+">O+</option>
                                    <option value="O-">O-</option>
                                    <option value="AB+">AB+</option>
                                    <option value="AB-">AB-</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">æ•¸é‡ (U) *</label>
                                <input type="number" x-model="bloodReceiveForm.quantity" required min="1" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent">
                            </div>
                        </div>

                        <!-- ä¾†æºé¸æ“‡ -->
                        <div class="col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-1">è¡€æ¶²ä¾†æº</label>
                            <select x-model="bloodReceiveForm.source" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent">
                                <option value="blood_center">æè¡€ä¸­å¿ƒ</option>
                                <option value="walking_donor">Walking Blood Bank (ç·Šæ€¥æè¡€è€…)</option>
                            </select>
                        </div>

                        <!-- Walking Blood Bank è³‡è¨Š (æ¢ä»¶é¡¯ç¤º) -->
                        <div x-show="bloodReceiveForm.source === 'walking_donor'" class="col-span-2 border-t border-red-200 pt-3 space-y-2">
                            <div class="text-sm font-medium text-red-700 flex items-center gap-1 mb-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                                </svg>
                                ç·Šæ€¥æè¡€è€…è³‡è¨Š
                            </div>
                            <div class="grid grid-cols-2 gap-2">
                                <div>
                                    <label class="block text-xs font-medium text-gray-600 mb-1">æè¡€è€…å§“å</label>
                                    <input type="text" x-model="bloodReceiveForm.donorName"
                                           class="w-full px-2 py-1.5 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-red-500 focus:border-transparent"
                                           placeholder="é¸å¡«">
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-600 mb-1">è¯çµ¡é›»è©±</label>
                                    <input type="tel" x-model="bloodReceiveForm.donorPhone"
                                           class="w-full px-2 py-1.5 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-red-500 focus:border-transparent"
                                           placeholder="é¸å¡«">
                                </div>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">å‚™è¨»</label>
                            <input type="text" x-model="bloodReceiveForm.remarks" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent" placeholder="æ‰¹è™Ÿã€ä¾†æºç­‰">
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <button type="submit" class="bg-claude-red-500 text-white px-4 py-2 rounded-lg hover:bg-claude-red-600 transition-colors flex items-center justify-center gap-2 font-medium shadow-md">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                </svg>
                                <span>ç¢ºèªå…¥åº«</span>
                            </button>
                            <button type="button" @click="printBloodLabel()" class="bg-white text-claude-red-500 px-4 py-2 rounded-lg hover:bg-red-50 transition-colors flex items-center justify-center gap-2 border-2 border-claude-red-500">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"/>
                                </svg>
                                <span>åˆ—å°æ¨™ç±¤</span>
                            </button>
                        </div>
                    </form>
                </div>

                <!-- è¡€è¢‹å‡ºåº« (å«ç—…æ‚£è³‡è¨Š) -->
                <div class="border-2 border-red-200 rounded-lg p-4 bg-white">
                    <h3 class="text-lg font-semibold text-red-700 mb-4 flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"/>
                        </svg>
                        è¡€è¢‹å‡ºåº«
                    </h3>
                    <form @submit.prevent="submitBloodConsume()" class="space-y-3">
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">è¡€å‹ *</label>
                                <select x-model="bloodConsumeForm.bloodType" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent">
                                    <option value="">é¸æ“‡è¡€å‹</option>
                                    <option value="A+">A+</option>
                                    <option value="A-">A-</option>
                                    <option value="B+">B+</option>
                                    <option value="B-">B-</option>
                                    <option value="O+">O+</option>
                                    <option value="O-">O-</option>
                                    <option value="AB+">AB+</option>
                                    <option value="AB-">AB-</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">æ•¸é‡ (U) *</label>
                                <input type="number" x-model="bloodConsumeForm.quantity" required min="1" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent">
                            </div>
                        </div>
                        <!-- ç—…æ‚£è³‡è¨Š -->
                        <div class="border-t border-red-200 pt-3 space-y-3">
                            <div class="text-sm font-medium text-gray-700 flex items-center gap-2">
                                <svg class="w-4 h-4 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                                </svg>
                                ç—…æ‚£è³‡è¨Š
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-600 mb-1">ç—…æ‚£å§“å *</label>
                                <input type="text" x-model="bloodConsumeForm.patientName" required class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent" placeholder="è«‹è¼¸å…¥ç—…æ‚£å§“å">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-600 mb-1">ç—…æ­·è™Ÿ</label>
                                <input type="text" x-model="bloodConsumeForm.patientId" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent" placeholder="é¸å¡«">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-600 mb-1">ç”¨é€”èªªæ˜</label>
                                <textarea x-model="bloodConsumeForm.purpose" rows="2" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent" placeholder="æ‰‹è¡“ã€ç·Šæ€¥è¼¸è¡€ç­‰"></textarea>
                            </div>
                        </div>
                        <button type="submit" class="w-full bg-claude-red-500 text-white px-4 py-2 rounded-lg hover:bg-claude-red-600 transition-colors flex items-center justify-center gap-2 font-medium shadow-md">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                            </svg>
                            <span>ç¢ºèªå‡ºåº«</span>
                        </button>
                    </form>
                </div>
            </div>

            <!-- v1.4.2-plus: å€‹åˆ¥è¡€è¢‹è¿½è¹¤ç³»çµ± -->
            <div class="mt-8 border-t border-red-200 pt-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold text-red-700 flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"/>
                        </svg>
                        å€‹åˆ¥è¡€è¢‹è¿½è¹¤
                    </h3>
                    <div class="flex gap-2">
                        <button @click="loadBloodBags()" class="bg-gray-500 text-white px-3 py-1.5 rounded-lg hover:bg-gray-600 text-sm flex items-center gap-1">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                            </svg>
                            é‡æ–°æ•´ç†
                        </button>
                        <button @click="checkExpiringBags()" class="bg-amber-500 text-white px-3 py-1.5 rounded-lg hover:bg-amber-600 text-sm flex items-center gap-1">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            å³æœŸè¡€è¢‹
                        </button>
                    </div>
                </div>

                <!-- æ–°å¢è¡€è¢‹è¡¨å–® -->
                <div class="bg-red-50 rounded-xl p-4 mb-4">
                    <h4 class="text-md font-semibold text-red-700 mb-3">å»ºç«‹å€‹åˆ¥è¡€è¢‹</h4>
                    <form @submit.prevent="createBloodBag()" class="grid grid-cols-2 md:grid-cols-4 gap-3">
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">è¡€å‹ *</label>
                            <select x-model="bloodBagForm.blood_type" required class="w-full px-2 py-1.5 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500">
                                <option value="">é¸æ“‡</option>
                                <option value="A+">A+</option>
                                <option value="A-">A-</option>
                                <option value="B+">B+</option>
                                <option value="B-">B-</option>
                                <option value="O+">O+</option>
                                <option value="O-">O-</option>
                                <option value="AB+">AB+</option>
                                <option value="AB-">AB-</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">å®¹é‡ (ml)</label>
                            <input type="number" x-model="bloodBagForm.volume_ml" min="100" max="500"
                                   class="w-full px-2 py-1.5 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500"
                                   placeholder="250">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">æ¡é›†æ—¥æœŸ</label>
                            <input type="date" x-model="bloodBagForm.collection_date"
                                   class="w-full px-2 py-1.5 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">æ•ˆæœŸ</label>
                            <input type="date" x-model="bloodBagForm.expiry_date"
                                   class="w-full px-2 py-1.5 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500">
                        </div>
                        <div class="col-span-2 md:col-span-3">
                            <label class="block text-xs font-medium text-gray-700 mb-1">æè´ˆè€…/ä¾†æº</label>
                            <input type="text" x-model="bloodBagForm.donor_info" placeholder="é¸å¡«"
                                   class="w-full px-2 py-1.5 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500">
                        </div>
                        <div class="flex items-end">
                            <button type="submit" class="w-full bg-claude-red-500 text-white px-3 py-1.5 rounded-lg hover:bg-claude-red-600 text-sm flex items-center justify-center gap-1">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                                </svg>
                                å»ºç«‹è¡€è¢‹
                            </button>
                        </div>
                    </form>
                </div>

                <!-- è¡€è¢‹åˆ—è¡¨ -->
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200 text-sm">
                        <thead class="bg-red-100">
                            <tr>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-600 uppercase">
                                    <input type="checkbox" @change="toggleAllBags($event.target.checked)" class="rounded">
                                </th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-600 uppercase">è¡€è¢‹ç·¨è™Ÿ</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-600 uppercase">è¡€å‹</th>
                                <th class="px-3 py-2 text-center text-xs font-medium text-gray-600 uppercase">å®¹é‡</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-600 uppercase">æ•ˆæœŸ</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-600 uppercase">ç‹€æ…‹</th>
                                <th class="px-3 py-2 text-center text-xs font-medium text-gray-600 uppercase">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            <template x-for="bag in bloodBags" :key="bag.bag_code">
                                <tr :class="{
                                    'bg-red-200 animate-pulse': isExpired(bag.expiry_date) && bag.status === 'AVAILABLE',
                                    'bg-amber-100': isExpiringSoon(bag.expiry_date) && !isExpired(bag.expiry_date) && bag.status === 'AVAILABLE',
                                    'bg-gray-50': bag.status === 'USED' || bag.status === 'DISCARDED'
                                }">
                                    <td class="px-3 py-2">
                                        <input type="checkbox" :value="bag.bag_code" x-model="selectedBagCodes" class="rounded">
                                    </td>
                                    <td class="px-3 py-2 font-mono text-xs" x-text="bag.bag_code"></td>
                                    <td class="px-3 py-2">
                                        <span class="px-2 py-0.5 text-xs font-bold rounded bg-red-600 text-white" x-text="bag.blood_type"></span>
                                    </td>
                                    <td class="px-3 py-2 text-center" x-text="bag.volume_ml + ' ml'"></td>
                                    <td class="px-3 py-2 text-xs">
                                        <span :class="{
                                            'text-red-700 font-bold': isExpired(bag.expiry_date),
                                            'text-amber-600 font-semibold': isExpiringSoon(bag.expiry_date) && !isExpired(bag.expiry_date),
                                            'text-gray-600': !isExpiringSoon(bag.expiry_date) && !isExpired(bag.expiry_date)
                                        }">
                                            <template x-if="isExpired(bag.expiry_date) && bag.status === 'AVAILABLE'">
                                                <span class="inline-flex items-center gap-1">
                                                    <svg class="w-4 h-4 text-red-600" fill="currentColor" viewBox="0 0 20 20">
                                                        <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                                                    </svg>
                                                    <span>å·²éæœŸ!</span>
                                                </span>
                                            </template>
                                            <template x-if="isExpiringSoon(bag.expiry_date) && !isExpired(bag.expiry_date) && bag.status === 'AVAILABLE'">
                                                <span class="inline-flex items-center gap-1">
                                                    <svg class="w-4 h-4 text-amber-500" fill="currentColor" viewBox="0 0 20 20">
                                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"/>
                                                    </svg>
                                                    <span x-text="bag.expiry_date"></span>
                                                </span>
                                            </template>
                                            <template x-if="!isExpiringSoon(bag.expiry_date) && !isExpired(bag.expiry_date)">
                                                <span x-text="bag.expiry_date || '-'"></span>
                                            </template>
                                            <template x-if="(isExpiringSoon(bag.expiry_date) || isExpired(bag.expiry_date)) && bag.status !== 'AVAILABLE'">
                                                <span x-text="bag.expiry_date || '-'"></span>
                                            </template>
                                        </span>
                                    </td>
                                    <td class="px-3 py-2">
                                        <span class="px-2 py-0.5 text-xs font-medium rounded-full"
                                              :class="{
                                                  'bg-green-100 text-green-700': bag.status === 'AVAILABLE',
                                                  'bg-gray-100 text-gray-700': bag.status === 'USED',
                                                  'bg-red-100 text-red-700': bag.status === 'EXPIRED' || bag.status === 'DISCARDED',
                                                  'bg-yellow-100 text-yellow-700': bag.status === 'RESERVED'
                                              }"
                                              x-text="bag.status === 'AVAILABLE' ? 'å¯ç”¨' : bag.status === 'USED' ? 'å·²ä½¿ç”¨' : bag.status === 'EXPIRED' ? 'å·²éæœŸ' : bag.status === 'DISCARDED' ? 'å·²ä¸Ÿæ£„' : 'å·²é ç•™'"></span>
                                    </td>
                                    <td class="px-3 py-2 text-center space-x-1">
                                        <button @click="printSingleBagLabel(bag.bag_code)" class="text-gray-600 hover:text-gray-800 text-xs" title="åˆ—å°æ¨™ç±¤">
                                            <svg class="w-4 h-4 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"/>
                                            </svg>
                                        </button>
                                        <button x-show="bag.status === 'AVAILABLE'" @click="useBloodBag(bag.bag_code)" class="text-blue-600 hover:text-blue-800 text-xs" title="ä½¿ç”¨è¡€è¢‹">
                                            ä½¿ç”¨
                                        </button>
                                        <button x-show="bag.status === 'AVAILABLE'" @click="discardBloodBag(bag.bag_code)" class="text-red-600 hover:text-red-800 text-xs" title="ä¸Ÿæ£„è¡€è¢‹(éæœŸ/æå£)">
                                            ä¸Ÿæ£„
                                        </button>
                                    </td>
                                </tr>
                            </template>
                            <tr x-show="bloodBags.length === 0">
                                <td colspan="7" class="px-3 py-4 text-center text-gray-500 text-sm">å°šç„¡å€‹åˆ¥è¡€è¢‹è³‡æ–™</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- æ‰¹æ¬¡æ“ä½œ -->
                <div x-show="selectedBagCodes.length > 0" class="mt-4 bg-red-100 rounded-lg p-3 flex items-center justify-between">
                    <span class="text-sm text-red-700">å·²é¸æ“‡ <span x-text="selectedBagCodes.length" class="font-bold"></span> è¢‹è¡€è¢‹</span>
                    <button @click="printSelectedBagLabels()" class="bg-claude-red-500 text-white px-4 py-2 rounded-lg hover:bg-claude-red-600 text-sm flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"/>
                        </svg>
                        æ‰¹æ¬¡åˆ—å°æ¨™ç±¤
                    </button>
                </div>
            </div>
        </div>
        <!-- CHANGED: x-show to style binding for equipment tab -->
        <div :style="currentTab === 'equipment' ? '' : 'display: none !important'" class="bg-white rounded-xl shadow-lg p-3 sm:p-4 md:p-6">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-4">
                <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                    <svg class="w-6 h-6 text-equipment-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                    </svg>
                    è¨­å‚™ç®¡ç†
                </h2>
                <div class="flex flex-wrap gap-2">
                    <button @click="showAddEquipmentModal = true" class="bg-equipment-500 text-white px-4 py-2 rounded-lg hover:bg-[#5a6155] transition-colors flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                        </svg>
                        <span>æ–°å¢è¨­å‚™</span>
                    </button>
                    <button @click="loadEquipment()" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                        </svg>
                        <span>é‡æ–°è¼‰å…¥</span>
                    </button>
                </div>
            </div>

            <!-- è‡ªå‹•åˆ·æ–°æç¤º -->
            <div class="mb-4 p-3 bg-equipment-500 bg-opacity-10 rounded-lg flex items-center gap-2 text-sm text-gray-700">
                <svg class="w-5 h-5 text-equipment-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                <span>è¨­å‚™ç‹€æ…‹å°‡æ–¼æ¯æ—¥ <strong class="text-equipment-500">07:00am</strong> è‡ªå‹•é‡ç½®ç‚ºå¾…æª¢æŸ¥</span>
            </div>

            <!-- ä¾›é›»è¨­å‚™å€åŸŸ -->
            <div class="bg-gradient-to-br from-equipment-100 to-equipment-200 border-2 border-equipment-200 rounded-xl p-5 mb-6 shadow-sm">
                <div class="bg-equipment-900 text-white px-6 py-3.5 -mx-5 -mt-5 mb-5 rounded-t-xl">
                    <h3 class="text-lg font-semibold flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                        </svg>
                        ä¾›é›»è¨­å‚™
                        <span class="ml-2 text-sm font-normal opacity-80" x-text="'(' + getPowerSupplyEquipment().length + ' é …)'"></span>
                        <span class="ml-auto text-xs font-normal bg-amber-500 px-2 py-0.5 rounded">éŸŒæ€§é—œéµ</span>
                    </h3>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead class="bg-gray-50 text-gray-600">
                            <tr>
                                <th class="px-3 py-2 text-left font-medium">ç·¨è™Ÿ</th>
                                <th class="px-3 py-2 text-left font-medium">åç¨±</th>
                                <th class="px-3 py-2 text-center font-medium">æ•¸é‡</th>
                                <th class="px-3 py-2 text-center font-medium">å­˜é‡ <span class="text-amber-500 text-xs">âš¡éŸŒæ€§</span></th>
                                <th class="px-3 py-2 text-center font-medium">ç‹€æ…‹</th>
                                <th class="px-3 py-2 text-left font-medium hidden lg:table-cell">æœ€å¾Œæª¢æŸ¥</th>
                                <th class="px-3 py-2 text-center font-medium">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-100">
                            <template x-for="eq in getPowerSupplyEquipment()" :key="eq.id + '-' + equipmentRefreshKey">
                                <tr class="hover:bg-gray-50" :class="{ 'bg-green-50': eq.status === 'NORMAL', 'bg-yellow-50': eq.status === 'WARNING', 'bg-red-50': eq.status === 'ERROR' }">
                                    <td class="px-3 py-2 font-mono text-xs text-gray-500" x-text="eq.id"></td>
                                    <td class="px-3 py-2 font-medium text-gray-900" x-text="eq.name"></td>
                                    <td class="px-3 py-2 text-center font-semibold" x-text="eq.quantity"></td>
                                    <td class="px-3 py-2 text-center">
                                        <template x-if="eq.power_level !== null">
                                            <div>
                                                <span class="font-medium" :class="{ 'text-green-600': eq.power_level >= 60, 'text-yellow-600': eq.power_level >= 30 && eq.power_level < 60, 'text-red-600': eq.power_level < 30 }" x-text="eq.power_level + '%'"></span>
                                                <div class="text-xs text-amber-600">â‰ˆ<span x-text="getResilienceHours(eq) || 'â€”'"></span>h</div>
                                            </div>
                                        </template>
                                        <span x-show="eq.power_level === null" class="text-gray-400">-</span>
                                    </td>
                                    <td class="px-3 py-2 text-center">
                                        <span :class="{ 'bg-green-100 text-green-800': eq.status === 'NORMAL', 'bg-yellow-100 text-yellow-800': eq.status === 'WARNING', 'bg-red-100 text-red-800': eq.status === 'ERROR', 'bg-gray-100 text-gray-800': eq.status === 'UNCHECKED' || eq.status === 'PENDING' }" class="px-2 py-0.5 text-xs font-medium rounded-full" x-text="eq.status"></span>
                                    </td>
                                    <td class="px-3 py-2 text-xs text-gray-500 hidden lg:table-cell" x-text="eq.last_check ? new Date(eq.last_check).toLocaleString('zh-TW') : '-'"></td>
                                    <td class="px-3 py-2 text-center">
                                        <div class="flex gap-1 justify-center">
                                            <button @click="checkEquipment(eq)" class="text-equipment-500 hover:text-[#5a6155] text-xs font-medium px-1.5 sm:px-2 py-1 bg-equipment-100 rounded" title="æª¢æŸ¥">âœ“</button>
                                            <button @click="openUnitManageModal(eq)" class="text-equipment-500 hover:text-[#5a6155] text-xs font-medium px-1.5 sm:px-2 py-1 bg-equipment-100 rounded" title="ç®¡ç†å–®ä½">âŠ</button>
                                            <button @click="editEquipment(eq)" class="hidden sm:inline-block text-gray-600 hover:text-gray-800 text-xs font-medium px-2 py-1 bg-gray-100 rounded" title="ç·¨è¼¯">âœ</button>
                                            <button @click="deleteEquipment(eq.id, eq.name)" class="hidden sm:inline-block text-red-600 hover:text-red-800 text-xs font-medium px-2 py-1 bg-red-50 rounded" title="åˆªé™¤">âœ•</button>
                                            <!-- æ‰‹æ©Ÿç‰ˆæ›´å¤šé¸å–® -->
                                            <div class="relative sm:hidden" x-data="{ open: false }">
                                                <button @click="open = !open" class="text-gray-500 hover:text-gray-700 text-xs font-medium px-1.5 py-1 bg-gray-100 rounded" title="æ›´å¤š">â‹¯</button>
                                                <div x-show="open" @click.away="open = false" class="absolute right-0 mt-1 bg-white border rounded-lg shadow-lg z-10 py-1 min-w-[80px]">
                                                    <button @click="editEquipment(eq); open = false" class="block w-full text-left px-3 py-1.5 text-xs hover:bg-gray-100">âœ ç·¨è¼¯</button>
                                                    <button @click="deleteEquipment(eq.id, eq.name); open = false" class="block w-full text-left px-3 py-1.5 text-xs text-red-600 hover:bg-red-50">âœ• åˆªé™¤</button>
                                                </div>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                    <div x-show="getPowerSupplyEquipment().length === 0" class="text-center text-gray-400 py-8">ç›®å‰æ²’æœ‰ä¾›é›»è¨­å‚™</div>
                </div>
            </div>

            <!-- è€—é›»è¨­å‚™å€åŸŸ -->
            <div class="bg-gradient-to-br from-equipment-100 to-equipment-200 border-2 border-equipment-200 rounded-xl p-5 mb-6 shadow-sm">
                <div class="bg-equipment-900 text-white px-6 py-3.5 -mx-5 -mt-5 mb-5 rounded-t-xl">
                    <h3 class="text-lg font-semibold flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z"/>
                        </svg>
                        è€—é›»è¨­å‚™
                        <span class="ml-2 text-sm font-normal opacity-80" x-text="'(' + getPowerConsumingEquipment().length + ' é …)'"></span>
                    </h3>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead class="bg-gray-50 text-gray-600">
                            <tr>
                                <th class="px-3 py-2 text-left font-medium">ç·¨è™Ÿ</th>
                                <th class="px-3 py-2 text-left font-medium">åç¨±</th>
                                <th class="px-3 py-2 text-left font-medium hidden sm:table-cell">é¡åˆ¥</th>
                                <th class="px-3 py-2 text-center font-medium">æ•¸é‡</th>
                                <th class="px-3 py-2 text-center font-medium">ç‹€æ…‹</th>
                                <th class="px-3 py-2 text-left font-medium hidden lg:table-cell">æœ€å¾Œæª¢æŸ¥</th>
                                <th class="px-3 py-2 text-center font-medium">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-100">
                            <template x-for="eq in getPowerConsumingEquipment()" :key="eq.id + '-' + equipmentRefreshKey">
                                <tr class="hover:bg-gray-50" :class="{ 'bg-green-50': eq.status === 'NORMAL', 'bg-yellow-50': eq.status === 'WARNING', 'bg-red-50': eq.status === 'ERROR' }">
                                    <td class="px-3 py-2 font-mono text-xs text-gray-500" x-text="eq.id"></td>
                                    <td class="px-3 py-2 font-medium text-gray-900" x-text="eq.name"></td>
                                    <td class="px-3 py-2 text-gray-600 hidden sm:table-cell" x-text="eq.category"></td>
                                    <td class="px-3 py-2 text-center font-semibold" x-text="eq.quantity"></td>
                                    <td class="px-3 py-2 text-center">
                                        <span :class="{ 'bg-green-100 text-green-800': eq.status === 'NORMAL', 'bg-yellow-100 text-yellow-800': eq.status === 'WARNING', 'bg-red-100 text-red-800': eq.status === 'ERROR', 'bg-gray-100 text-gray-800': eq.status === 'UNCHECKED' || eq.status === 'PENDING' }" class="px-2 py-0.5 text-xs font-medium rounded-full" x-text="eq.status"></span>
                                    </td>
                                    <td class="px-3 py-2 text-xs text-gray-500 hidden lg:table-cell" x-text="eq.last_check ? new Date(eq.last_check).toLocaleString('zh-TW') : '-'"></td>
                                    <td class="px-3 py-2 text-center">
                                        <div class="flex gap-1 justify-center">
                                            <button @click="checkEquipment(eq)" class="text-equipment-500 hover:text-[#5a6155] text-xs font-medium px-1.5 sm:px-2 py-1 bg-equipment-100 rounded" title="æª¢æŸ¥">âœ“</button>
                                            <button @click="openUnitManageModal(eq)" class="text-equipment-500 hover:text-[#5a6155] text-xs font-medium px-1.5 sm:px-2 py-1 bg-equipment-100 rounded" title="ç®¡ç†å–®ä½">âŠ</button>
                                            <button @click="editEquipment(eq)" class="hidden sm:inline-block text-gray-600 hover:text-gray-800 text-xs font-medium px-2 py-1 bg-gray-100 rounded" title="ç·¨è¼¯">âœ</button>
                                            <button @click="deleteEquipment(eq.id, eq.name)" class="hidden sm:inline-block text-red-600 hover:text-red-800 text-xs font-medium px-2 py-1 bg-red-50 rounded" title="åˆªé™¤">âœ•</button>
                                            <!-- æ‰‹æ©Ÿç‰ˆæ›´å¤šé¸å–® -->
                                            <div class="relative sm:hidden" x-data="{ open: false }">
                                                <button @click="open = !open" class="text-gray-500 hover:text-gray-700 text-xs font-medium px-1.5 py-1 bg-gray-100 rounded" title="æ›´å¤š">â‹¯</button>
                                                <div x-show="open" @click.away="open = false" class="absolute right-0 mt-1 bg-white border rounded-lg shadow-lg z-10 py-1 min-w-[80px]">
                                                    <button @click="editEquipment(eq); open = false" class="block w-full text-left px-3 py-1.5 text-xs hover:bg-gray-100">âœ ç·¨è¼¯</button>
                                                    <button @click="deleteEquipment(eq.id, eq.name); open = false" class="block w-full text-left px-3 py-1.5 text-xs text-red-600 hover:bg-red-50">âœ• åˆªé™¤</button>
                                                </div>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                    <div x-show="getPowerConsumingEquipment().length === 0" class="text-center text-gray-400 py-8">ç›®å‰æ²’æœ‰è€—é›»è¨­å‚™</div>
                </div>
            </div>

            <!-- éè€—é›»è¨­å‚™å€åŸŸ -->
            <div class="bg-gradient-to-br from-equipment-100 to-equipment-200 border-2 border-equipment-200 rounded-xl p-5 mb-6 shadow-sm">
                <div class="bg-equipment-900 text-white px-6 py-3.5 -mx-5 -mt-5 mb-5 rounded-t-xl">
                    <h3 class="text-lg font-semibold flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                        </svg>
                        éè€—é›»è¨­å‚™
                        <span class="ml-2 text-sm font-normal opacity-80" x-text="'(' + getNonElectricEquipment().length + ' é …)'"></span>
                    </h3>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead class="bg-gray-50 text-gray-600">
                            <tr>
                                <th class="px-3 py-2 text-left font-medium">ç·¨è™Ÿ</th>
                                <th class="px-3 py-2 text-left font-medium">åç¨±</th>
                                <th class="px-3 py-2 text-left font-medium hidden sm:table-cell">é¡åˆ¥</th>
                                <th class="px-3 py-2 text-center font-medium">æ•¸é‡</th>
                                <th class="px-3 py-2 text-center font-medium">ç‹€æ…‹</th>
                                <th class="px-3 py-2 text-left font-medium hidden lg:table-cell">æœ€å¾Œæª¢æŸ¥</th>
                                <th class="px-3 py-2 text-center font-medium">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-100">
                            <template x-for="eq in getNonElectricEquipment()" :key="eq.id + '-' + equipmentRefreshKey">
                                <tr class="hover:bg-gray-50" :class="{ 'bg-green-50': eq.status === 'NORMAL', 'bg-yellow-50': eq.status === 'WARNING', 'bg-red-50': eq.status === 'ERROR' }">
                                    <td class="px-3 py-2 font-mono text-xs text-gray-500" x-text="eq.id"></td>
                                    <td class="px-3 py-2 font-medium text-gray-900" x-text="eq.name"></td>
                                    <td class="px-3 py-2 text-gray-600 hidden sm:table-cell" x-text="eq.category"></td>
                                    <td class="px-3 py-2 text-center font-semibold" x-text="eq.quantity"></td>
                                    <td class="px-3 py-2 text-center">
                                        <span :class="{ 'bg-green-100 text-green-800': eq.status === 'NORMAL', 'bg-yellow-100 text-yellow-800': eq.status === 'WARNING', 'bg-red-100 text-red-800': eq.status === 'ERROR', 'bg-gray-100 text-gray-800': eq.status === 'UNCHECKED' || eq.status === 'PENDING' }" class="px-2 py-0.5 text-xs font-medium rounded-full" x-text="eq.status"></span>
                                    </td>
                                    <td class="px-3 py-2 text-xs text-gray-500 hidden lg:table-cell" x-text="eq.last_check ? new Date(eq.last_check).toLocaleString('zh-TW') : '-'"></td>
                                    <td class="px-3 py-2 text-center">
                                        <div class="flex gap-1 justify-center">
                                            <button @click="checkEquipment(eq)" class="text-equipment-500 hover:text-[#5a6155] text-xs font-medium px-1.5 sm:px-2 py-1 bg-equipment-100 rounded" title="æª¢æŸ¥">âœ“</button>
                                            <button @click="openUnitManageModal(eq)" class="text-equipment-500 hover:text-[#5a6155] text-xs font-medium px-1.5 sm:px-2 py-1 bg-equipment-100 rounded" title="ç®¡ç†å–®ä½">âŠ</button>
                                            <button @click="editEquipment(eq)" class="hidden sm:inline-block text-gray-600 hover:text-gray-800 text-xs font-medium px-2 py-1 bg-gray-100 rounded" title="ç·¨è¼¯">âœ</button>
                                            <button @click="deleteEquipment(eq.id, eq.name)" class="hidden sm:inline-block text-red-600 hover:text-red-800 text-xs font-medium px-2 py-1 bg-red-50 rounded" title="åˆªé™¤">âœ•</button>
                                            <!-- æ‰‹æ©Ÿç‰ˆæ›´å¤šé¸å–® -->
                                            <div class="relative sm:hidden" x-data="{ open: false }">
                                                <button @click="open = !open" class="text-gray-500 hover:text-gray-700 text-xs font-medium px-1.5 py-1 bg-gray-100 rounded" title="æ›´å¤š">â‹¯</button>
                                                <div x-show="open" @click.away="open = false" class="absolute right-0 mt-1 bg-white border rounded-lg shadow-lg z-10 py-1 min-w-[80px]">
                                                    <button @click="editEquipment(eq); open = false" class="block w-full text-left px-3 py-1.5 text-xs hover:bg-gray-100">âœ ç·¨è¼¯</button>
                                                    <button @click="deleteEquipment(eq.id, eq.name); open = false" class="block w-full text-left px-3 py-1.5 text-xs text-red-600 hover:bg-red-50">âœ• åˆªé™¤</button>
                                                </div>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                    <div x-show="getNonElectricEquipment().length === 0" class="text-center text-gray-400 py-8">ç›®å‰æ²’æœ‰éè€—é›»è¨­å‚™</div>
                </div>
            </div>

            <!-- æ‰‹è¡“åŒ…å€åŸŸ -->
            <div class="bg-gradient-to-br from-equipment-100 to-equipment-200 border-2 border-equipment-200 rounded-xl p-5 shadow-sm">
                <div class="bg-equipment-900 text-white px-6 py-3.5 -mx-5 -mt-5 mb-5 rounded-t-xl">
                    <h3 class="text-lg font-semibold flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
                        </svg>
                        æ‰‹è¡“åŒ…
                        <span class="ml-2 text-sm font-normal opacity-80" x-text="'(' + equipment.filter(e => e.id.includes('-SURG-') || e.id.startsWith('SURG-')).length + ' é …)'"></span>
                    </h3>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead class="bg-gray-50 text-gray-600">
                            <tr>
                                <th class="px-3 py-2 text-left font-medium">ç·¨è™Ÿ</th>
                                <th class="px-3 py-2 text-left font-medium">åç¨±</th>
                                <th class="px-3 py-2 text-center font-medium">æ•¸é‡</th>
                                <th class="px-3 py-2 text-center font-medium">ç‹€æ…‹</th>
                                <th class="px-3 py-2 text-left font-medium hidden md:table-cell">æœ€å¾Œæª¢æŸ¥</th>
                                <th class="px-3 py-2 text-center font-medium">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-100">
                            <template x-for="eq in equipment.filter(e => e.id.includes('-SURG-') || e.id.startsWith('SURG-'))" :key="eq.id + '-' + equipmentRefreshKey">
                                <tr class="hover:bg-gray-50" :class="{
                                    'bg-green-50': eq.status === 'NORMAL',
                                    'bg-yellow-50': eq.status === 'WARNING',
                                    'bg-red-50': eq.status === 'ERROR'
                                }">
                                    <td class="px-3 py-2 font-mono text-xs text-gray-500" x-text="eq.id"></td>
                                    <td class="px-3 py-2 font-medium text-gray-900" x-text="eq.name"></td>
                                    <td class="px-3 py-2 text-center font-semibold" x-text="eq.quantity"></td>
                                    <td class="px-3 py-2 text-center">
                                        <span :class="{
                                            'bg-green-100 text-green-800': eq.status === 'NORMAL',
                                            'bg-yellow-100 text-yellow-800': eq.status === 'WARNING',
                                            'bg-red-100 text-red-800': eq.status === 'ERROR',
                                            'bg-gray-100 text-gray-800': eq.status === 'UNCHECKED' || eq.status === 'PENDING'
                                        }" class="px-2 py-0.5 text-xs font-medium rounded-full" x-text="eq.status"></span>
                                    </td>
                                    <td class="px-3 py-2 text-xs text-gray-500 hidden md:table-cell" x-text="eq.last_check ? new Date(eq.last_check).toLocaleString('zh-TW') : '-'"></td>
                                    <td class="px-3 py-2 text-center">
                                        <div class="flex gap-1 justify-center">
                                            <button @click="checkEquipment(eq)" class="text-equipment-500 hover:text-[#5a6155] text-xs font-medium px-1.5 sm:px-2 py-1 bg-equipment-100 rounded" title="æª¢æŸ¥">âœ“</button>
                                            <button @click="openUnitManageModal(eq)" class="text-equipment-500 hover:text-[#5a6155] text-xs font-medium px-1.5 sm:px-2 py-1 bg-equipment-100 rounded" title="ç®¡ç†å–®ä½">âŠ</button>
                                            <button @click="editEquipment(eq)" class="hidden sm:inline-block text-gray-600 hover:text-gray-800 text-xs font-medium px-2 py-1 bg-gray-100 rounded" title="ç·¨è¼¯">âœ</button>
                                            <button @click="deleteEquipment(eq.id, eq.name)" class="hidden sm:inline-block text-red-600 hover:text-red-800 text-xs font-medium px-2 py-1 bg-red-50 rounded" title="åˆªé™¤">âœ•</button>
                                            <!-- æ‰‹æ©Ÿç‰ˆæ›´å¤šé¸å–® -->
                                            <div class="relative sm:hidden" x-data="{ open: false }">
                                                <button @click="open = !open" class="text-gray-500 hover:text-gray-700 text-xs font-medium px-1.5 py-1 bg-gray-100 rounded" title="æ›´å¤š">â‹¯</button>
                                                <div x-show="open" @click.away="open = false" class="absolute right-0 mt-1 bg-white border rounded-lg shadow-lg z-10 py-1 min-w-[80px]">
                                                    <button @click="editEquipment(eq); open = false" class="block w-full text-left px-3 py-1.5 text-xs hover:bg-gray-100">âœ ç·¨è¼¯</button>
                                                    <button @click="deleteEquipment(eq.id, eq.name); open = false" class="block w-full text-left px-3 py-1.5 text-xs text-red-600 hover:bg-red-50">âœ• åˆªé™¤</button>
                                                </div>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                    <div x-show="equipment.filter(e => e.id.includes('-SURG-') || e.id.startsWith('SURG-')).length === 0" class="text-center text-gray-400 py-8">
                        ç›®å‰æ²’æœ‰æ‰‹è¡“åŒ…
                    </div>
                </div>
            </div>
        </div>

        <!-- éŸŒæ€§ä¼°ç®—åˆ†é  -->
        <div :style="currentTab === 'resilience' ? '' : 'display: none !important'" class="bg-white rounded-xl shadow-lg p-3 sm:p-4 md:p-6">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-4">
                <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                    <svg class="w-6 h-6 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
                    </svg>
                    éŸŒæ€§ä¼°ç®—
                </h2>
                <div class="flex gap-2">
                    <button @click="loadResilienceStatus()" class="px-4 py-2 bg-amber-500 text-white rounded-lg hover:bg-amber-600 transition-colors flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                        </svg>
                        é‡æ–°è¨ˆç®—
                    </button>
                    <!-- v1.2.8: æª¢æŸ¥å ±è¡¨æŒ‰éˆ• -->
                    <button @click="showCheckReportModal = true; loadCheckReport()" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                        æª¢æŸ¥å ±è¡¨
                    </button>
                </div>
            </div>

            <!-- è¨­å®šå€ -->
            <div class="bg-amber-50 rounded-lg p-4 mb-6">
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">é ä¼°å­¤ç«‹å¤©æ•¸</label>
                        <div class="flex items-center gap-2">
                            <input type="number" x-model.number="resilienceConfig.isolation_target_days" min="1" max="30"
                                   @input.debounce.500ms="updateResilienceConfig()"
                                   class="w-20 px-3 py-2 border border-amber-300 rounded-lg focus:ring-2 focus:ring-amber-500">
                            <span class="text-gray-600">å¤©</span>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            <span x-text="resilienceConfig.population_label || 'æ°§æ°£éœ€æ±‚'"></span>
                            <span class="text-xs text-gray-400 ml-1">(ç­‰æ•ˆæ’ç®¡äººæ•¸)</span>
                        </label>
                        <div class="flex items-center gap-2">
                            <input type="number" x-model.number="resilienceConfig.population_count" min="0" max="100" step="0.1"
                                   @input.debounce.500ms="updateResilienceConfig()"
                                   class="w-24 px-3 py-2 border border-amber-300 rounded-lg focus:ring-2 focus:ring-amber-500"
                                   title="æ’ç®¡=1.0, é¢ç½©â‰ˆ0.6, é¼»å°ç®¡â‰ˆ0.3">
                            <span class="text-gray-500 text-sm">ç­‰æ•ˆäºº</span>
                        </div>
                        <p class="text-xs text-gray-400 mt-1">æ’ç®¡=1.0 | é¢ç½©â‰ˆ0.6 | é¼»å°ç®¡â‰ˆ0.3</p>
                    </div>
                    <div class="flex items-end gap-3">
                        <button @click="updateResilienceConfig()"
                                class="px-3 py-1.5 bg-amber-100 text-amber-700 rounded-lg hover:bg-amber-200 text-sm font-medium">
                            å¥—ç”¨
                        </button>
                        <div class="text-sm text-amber-700">
                            <span class="font-medium">ç›®æ¨™ï¼š</span>
                            æ’é <span class="font-bold" x-text="resilienceConfig.isolation_target_days"></span> å¤©å­¤ç«‹æœŸ
                        </div>
                    </div>
                </div>
            </div>

            <!-- è¨ˆç®—å…¬å¼èªªæ˜ -->
            <div class="mb-4" x-data="{ showFormula: false }">
                <button @click="showFormula = !showFormula"
                        class="text-sm text-amber-600 hover:text-amber-700 flex items-center gap-1">
                    <svg class="w-4 h-4" :class="showFormula ? 'rotate-90' : ''" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                    </svg>
                    è¨ˆç®—å…¬å¼èªªæ˜
                </button>
                <div x-show="showFormula" x-collapse class="mt-2 p-3 bg-amber-50 border border-amber-200 rounded-lg text-sm">
                    <div class="space-y-2 text-gray-700">
                        <p class="font-medium text-amber-700 mb-1">â–é‹¼ç“¶æ°§æ°£ä¾›æ‡‰</p>
                        <p><strong>æ°§æ°£æ™‚æ•¸</strong> = Î£(æ¯ç“¶å®¹é‡ Ã— å……å¡«%) Ã· (10 L/min Ã— ç­‰æ•ˆäººæ•¸ Ã— 60)</p>
                        <p class="text-xs text-gray-500 ml-4">â€¢ Hå‹é‹¼ç“¶ = 6,900 L | Eå‹æ°§æ°£ç“¶ = 680 L</p>
                        <hr class="border-amber-200 my-2">
                        <p class="font-medium text-amber-700 mb-1">â–æ°§æ°£æ¿ƒç¸®æ©Ÿ (ä¾è³´é›»åŠ›)</p>
                        <p><strong>æ¿ƒç¸®æ©Ÿè¼¸å‡º</strong> = 5 L/min (å›ºå®šæµé‡)</p>
                        <p><strong>å¯ä¾›æ‡‰äººæ•¸</strong> = 5 Ã· 10 = 0.5 ç­‰æ•ˆäºº (è€—é›»ç´„ 300W)</p>
                        <p class="text-xs text-gray-500 ml-4">âš¡ æ¿ƒç¸®æ©Ÿé‹ä½œæ™‚é–“ â‰¤ é›»åŠ›å¯ç”¨æ™‚æ•¸</p>
                        <hr class="border-amber-200 my-2">
                        <p class="font-medium text-amber-700 mb-1">â–é›»åŠ›ä¾›æ‡‰</p>
                        <p><strong>é›»åŠ›æ™‚æ•¸</strong> = (æ²¹ç®±å®¹é‡ Ã— æª¢æŸ¥%) Ã· 3.0 L/hr</p>
                        <p class="text-xs text-gray-500 ml-4">â€¢ UTIL-002 ç™¼é›»æ©Ÿæ²¹ç®± = 50 L (ç´„ 16.7 å°æ™‚)</p>
                        <hr class="border-amber-200 my-2">
                        <p class="font-medium text-amber-700 mb-1">â–ç¶œåˆéŸŒæ€§</p>
                        <p><strong>å¯ç¨ç«‹é‹ä½œ</strong> = MIN(æ°§æ°£æ™‚æ•¸, é›»åŠ›æ™‚æ•¸)</p>
                        <p class="text-xs text-gray-500 ml-4">â€¢ è‹¥æ°§æ°£æ¿ƒç¸®æ©Ÿç‚ºä¸»è¦ä¾›æ°§ï¼Œå‰‡å—é›»åŠ›é™åˆ¶</p>
                        <hr class="border-amber-200 my-2">
                        <p class="text-xs text-gray-600 mb-1"><strong>ç­‰æ•ˆäººæ•¸æ›ç®—ï¼š</strong></p>
                        <p class="text-xs text-gray-600">â€¢ æ’ç®¡ = 1.0 | é¢ç½© â‰ˆ 0.6 | é¼»å°ç®¡ â‰ˆ 0.3 | è¨­ç‚º 0 = ç„¡éœ€æ±‚</p>
                        <hr class="border-amber-200 my-2">
                        <p class="text-xs text-amber-600">
                            <strong>v1.2.8:</strong> åˆ†é …ç·¨è¼¯è‡ªå‹•åŒæ­¥ + æœªæª¢æŸ¥ç°é¡¯ + æª¢æŸ¥æ­·å²è¨˜éŒ„
                        </p>
                    </div>
                </div>
            </div>

            <!-- æ•´é«”ç‹€æ…‹ - ç°¡æ½”å¤§æ•¸å­— -->
            <div class="mb-6" x-show="resilienceStatus.summary">
                <div class="p-4 rounded-lg border-2"
                     :class="{
                         'bg-red-50 border-red-300': resilienceStatus.summary?.overall_status === 'CRITICAL',
                         'bg-yellow-50 border-yellow-300': resilienceStatus.summary?.overall_status === 'WARNING',
                         'bg-green-50 border-green-300': resilienceStatus.summary?.overall_status === 'SAFE',
                         'bg-gray-50 border-gray-300': !resilienceStatus.summary?.overall_status
                     }">
                    <div class="flex flex-col sm:flex-row items-center gap-4">
                        <!-- å¤§æ•¸å­— -->
                        <div class="text-center sm:text-left">
                            <div class="text-xs text-gray-500 uppercase tracking-wide">å¯ç¨ç«‹é‹ä½œ</div>
                            <div class="text-4xl sm:text-5xl font-bold"
                                 :class="{
                                     'text-red-600': resilienceStatus.summary?.overall_status === 'CRITICAL',
                                     'text-yellow-600': resilienceStatus.summary?.overall_status === 'WARNING',
                                     'text-green-600': resilienceStatus.summary?.overall_status === 'SAFE'
                                 }">
                                <span x-text="resilienceStatus.summary?.weakest_link?.hours?.toFixed(1) || 'â€”'"></span>
                                <span class="text-xl font-normal text-gray-500">å°æ™‚</span>
                            </div>
                        </div>
                        <!-- ç‹€æ…‹ -->
                        <div class="text-center sm:text-right">
                            <span class="w-3 h-3 rounded-full inline-block mr-1"
                                  :class="{
                                      'bg-red-500': resilienceStatus.summary?.overall_status === 'CRITICAL',
                                      'bg-yellow-500': resilienceStatus.summary?.overall_status === 'WARNING',
                                      'bg-green-500': resilienceStatus.summary?.overall_status === 'SAFE'
                                  }"></span>
                            <span class="text-sm font-medium"
                                  :class="{
                                      'text-red-700': resilienceStatus.summary?.overall_status === 'CRITICAL',
                                      'text-yellow-700': resilienceStatus.summary?.overall_status === 'WARNING',
                                      'text-green-700': resilienceStatus.summary?.overall_status === 'SAFE'
                                  }">
                                <span x-show="resilienceStatus.summary?.overall_status === 'CRITICAL'">ç„¡æ³•æ’éç›®æ¨™</span>
                                <span x-show="resilienceStatus.summary?.overall_status === 'WARNING'">å‹‰å¼·é”æ¨™</span>
                                <span x-show="resilienceStatus.summary?.overall_status === 'SAFE'">å……è¶³</span>
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ç¶­ç”Ÿè³‡æº - ç°¡æ½”ç‰ˆ -->
            <!-- v1.2.7: ç”Ÿå‘½ç·š (amber/gray çµ±ä¸€è‰²ç³») -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <!-- é›»åŠ›å€ -->
                <div class="border border-gray-200 rounded-xl p-4 bg-white">
                    <div class="flex items-center gap-3 mb-3">
                        <div class="p-2 rounded-lg bg-amber-100">
                            <svg class="w-6 h-6 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                            </svg>
                        </div>
                        <div class="flex-1">
                            <div class="text-sm font-medium text-gray-500">é›»åŠ›ä¾›æ‡‰</div>
                            <div class="text-2xl font-bold text-gray-800">
                                <span x-text="getPowerHours()"></span>
                                <span class="text-sm font-normal text-gray-400">h</span>
                                <span class="text-xs font-normal text-gray-400" x-text="'(' + (getPowerHours() / 24).toFixed(1) + 'å¤©)'"></span>
                            </div>
                        </div>
                        <!-- ç‹€æ…‹åœ–ç¤º -->
                        <div class="flex-shrink-0">
                            <template x-if="getPowerStatus() === 'CRITICAL'">
                                <svg class="w-6 h-6 text-amber-600" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                                </svg>
                            </template>
                            <template x-if="getPowerStatus() === 'WARNING'">
                                <svg class="w-6 h-6 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                                </svg>
                            </template>
                            <template x-if="getPowerStatus() === 'SAFE'">
                                <svg class="w-6 h-6 text-gray-300" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                                </svg>
                            </template>
                        </div>
                    </div>
                    <!-- é›»åŠ›å­é …ç›® -->
                    <div class="text-xs text-gray-400 space-y-1 border-t border-gray-100 pt-2">
                        <template x-for="lifeline in (resilienceStatus.lifelines || []).filter(l => l.type === 'POWER')" :key="lifeline.item_code">
                            <div class="flex justify-between">
                                <span x-text="lifeline.name"></span>
                                <span class="text-gray-600" x-text="(lifeline.endurance ? lifeline.endurance.effective_hours : 0) + 'h'"></span>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- æ°§æ°£å€ -->
                <div class="border border-gray-200 rounded-xl p-4 bg-white">
                    <div class="flex items-center gap-3 mb-3">
                        <div class="p-2 rounded-lg bg-amber-100">
                            <svg class="w-6 h-6 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"/>
                            </svg>
                        </div>
                        <div class="flex-1">
                            <div class="text-sm font-medium text-gray-500">æ°§æ°£ä¾›æ‡‰</div>
                            <div class="text-2xl font-bold text-gray-800">
                                <span x-text="getOxygenHours()"></span>
                                <span class="text-sm font-normal text-gray-400">h</span>
                                <span class="text-xs font-normal text-gray-400" x-text="'(' + (getOxygenHours() / 24).toFixed(1) + 'å¤©)'"></span>
                            </div>
                        </div>
                        <!-- ç‹€æ…‹åœ–ç¤º -->
                        <div class="flex-shrink-0">
                            <template x-if="getOxygenStatus() === 'CRITICAL'">
                                <svg class="w-6 h-6 text-amber-600" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                                </svg>
                            </template>
                            <template x-if="getOxygenStatus() === 'WARNING'">
                                <svg class="w-6 h-6 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                                </svg>
                            </template>
                            <template x-if="getOxygenStatus() === 'SAFE'">
                                <svg class="w-6 h-6 text-gray-300" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                                </svg>
                            </template>
                        </div>
                    </div>
                    <!-- æ°§æ°£å­é …ç›® -->
                    <div class="text-xs text-gray-400 space-y-1 border-t border-gray-100 pt-2">
                        <template x-for="lifeline in (resilienceStatus.lifelines || []).filter(l => l.type === 'OXYGEN')" :key="lifeline.item_code">
                            <div class="flex justify-between">
                                <span x-text="lifeline.name"></span>
                                <span class="text-gray-600" x-text="(lifeline.endurance && lifeline.endurance.effective_hours === 'âˆ') ? 'âˆh' : ((lifeline.endurance && lifeline.endurance.effective_hours) || 0) + 'h'"></span>
                            </div>
                        </template>
                    </div>
                </div>
            </div>

            <!-- å¯ç¨ç«‹é‹ä½œ = MIN(é›»åŠ›, æ°§æ°£) -->
            <div class="mb-6 p-4 rounded-xl border border-amber-200 bg-amber-50">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <svg class="w-8 h-8 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
                        </svg>
                        <div>
                            <div class="text-sm font-medium text-gray-500">å¯ç¨ç«‹é‹ä½œ = MIN(é›»åŠ›, æ°§æ°£)</div>
                            <div class="text-3xl font-bold text-amber-600">
                                <span x-text="resilienceStatus.summary?.weakest_link?.hours?.toFixed(1) || 'â€”'"></span>
                                <span class="text-lg font-normal text-gray-400">h</span>
                                <span class="text-sm font-normal text-gray-400" x-text="'(' + ((resilienceStatus.summary?.weakest_link?.hours || 0) / 24).toFixed(1) + 'å¤©)'"></span>
                            </div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-xs text-gray-400 mb-1">ç“¶é ¸ä¾†æº</div>
                        <span class="px-3 py-1 rounded-full text-sm font-medium bg-gray-100 text-gray-600"
                              x-text="resilienceStatus.summary?.weakest_link?.type === 'POWER' ? 'é›»åŠ›' : 'æ°§æ°£'"></span>
                    </div>
                </div>
            </div>

            <!-- v1.2.7: éŸŒæ€§è¨­å‚™æ˜ç´° (amber/gray çµ±ä¸€è‰²ç³») -->
            <div class="border border-gray-200 rounded-xl bg-white overflow-hidden">
                <div class="bg-gray-50 border-b border-gray-200 px-5 py-3">
                    <h3 class="text-base font-semibold text-gray-700 flex items-center gap-2">
                        <svg class="w-5 h-5 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"/>
                        </svg>
                        éŸŒæ€§è¨­å‚™æ˜ç´°
                    </h3>
                </div>

                <div class="p-4 space-y-3">
                    <!-- æ°§æ°£ä¾›æ‡‰æ˜ç´° -->
                    <template x-for="lifeline in (resilienceStatus.lifelines || []).filter(l => l.type === 'OXYGEN' && l.inventory?.items)" :key="lifeline.item_code + '-' + lifelinesRefreshKey">
                        <div class="border border-gray-100 rounded-lg">
                            <!-- ä¸»é …ç›®åˆ— -->
                            <div class="flex items-center gap-2 p-3 cursor-pointer hover:bg-gray-50"
                                 @click="expandedLifeline = expandedLifeline === lifeline.item_code ? null : lifeline.item_code">
                                <!-- å±•é–‹ç®­é ­ -->
                                <svg class="w-4 h-4 transition-transform text-gray-400"
                                     :class="{ 'rotate-90': expandedLifeline === lifeline.item_code }"
                                     fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                                </svg>
                                <!-- æ°§æ°£åœ–ç¤º -->
                                <svg class="w-5 h-5 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"/>
                                </svg>
                                <span class="font-medium text-gray-700" x-text="lifeline.name"></span>
                                <span class="text-sm text-gray-400" x-text="'(' + (lifeline.inventory?.items?.reduce((sum, i) => sum + i.qty, 0) || 0) + 'æ”¯)'"></span>
                                <span class="ml-auto font-bold text-amber-600" x-text="(lifeline.endurance ? lifeline.endurance.effective_hours : 0) + 'h'"></span>
                            </div>

                            <!-- å±•é–‹çš„å­é …ç›® (å€‹åˆ¥é‹¼ç“¶) -->
                            <div x-show="expandedLifeline === lifeline.item_code"
                                 x-transition
                                 class="border-t border-gray-100 bg-gray-50 p-3">
                                <template x-for="item in lifeline.inventory?.items || []" :key="item.name">
                                    <div class="mb-3 last:mb-0">
                                        <!-- è¨­å‚™é¡å‹æ¨™é¡Œ -->
                                        <div class="flex items-center gap-2 text-sm text-gray-600 font-medium mb-2">
                                            <span x-text="item.name"></span>
                                            <span class="text-gray-400 text-xs" x-text="'[' + item.qty + 'æ”¯, å¹³å‡ ' + (item.avg_level || 100) + '%]'"></span>
                                        </div>
                                        <!-- å€‹åˆ¥å–®ä½ (PER_UNIT æ¨¡å¼) -->
                                        <template x-if="item.tracking_mode === 'PER_UNIT' && item.units">
                                            <div class="space-y-1.5">
                                                <!-- æª¢æŸ¥é€²åº¦ -->
                                                <div class="flex items-center justify-between text-xs text-gray-500 mb-1">
                                                    <span>æª¢æŸ¥é€²åº¦</span>
                                                    <span :class="item.units.filter(u => u.checked).length === item.units.length ? 'text-amber-600 font-medium' : 'text-amber-500'">
                                                        <span x-text="item.units.filter(u => u.checked).length"></span>/<span x-text="item.units.length"></span> å·²æª¢æŸ¥
                                                    </span>
                                                </div>
                                                <template x-for="(unit, idx) in item.units" :key="unit.label">
                                                    <div class="flex items-center gap-2 text-xs rounded px-3 py-2 transition-all"
                                                         :class="unit.checked ? 'bg-white border border-gray-100' : 'bg-gray-100 border border-dashed border-gray-300'">
                                                        <!-- æª¢æŸ¥ç‹€æ…‹åœ–ç¤º -->
                                                        <span class="w-4">
                                                            <template x-if="unit.checked">
                                                                <svg class="w-4 h-4 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                                                </svg>
                                                            </template>
                                                            <template x-if="!unit.checked">
                                                                <svg class="w-4 h-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                                                </svg>
                                                            </template>
                                                        </span>
                                                        <!-- æ¨™ç±¤ -->
                                                        <span class="font-medium w-14" :class="unit.checked ? 'text-gray-600' : 'text-gray-400'" x-text="unit.label"></span>
                                                        <!-- å……å¡«é€²åº¦æ¢ -->
                                                        <div class="flex-1 h-2.5 bg-gray-200 rounded-full overflow-hidden">
                                                            <div class="h-full rounded-full transition-all"
                                                                 :class="unit.checked ? (unit.level >= 30 ? 'bg-amber-400' : 'bg-amber-600') : 'bg-gray-300'"
                                                                 :style="'width: ' + unit.level + '%'"></div>
                                                        </div>
                                                        <!-- ç™¾åˆ†æ¯” -->
                                                        <span class="w-10 text-right font-medium" :class="unit.checked ? 'text-gray-700' : 'text-gray-400'" x-text="unit.level + '%'"></span>
                                                        <!-- å®¹é‡ -->
                                                        <span class="w-14 text-right text-gray-400" x-text="(unit.capacity ? unit.capacity.toLocaleString() : '0') + 'L'"></span>
                                                        <!-- ç‹€æ…‹æ¨™ç±¤ -->
                                                        <span class="px-2 py-0.5 text-xs rounded"
                                                              :class="unit.checked ? 'bg-gray-100 text-gray-600' : 'bg-gray-200 text-gray-400'"
                                                              x-text="unit.status === 'AVAILABLE' ? 'å‚™ç”¨' : unit.status === 'IN_USE' ? 'ä½¿ç”¨ä¸­' : unit.status === 'EMPTY' ? 'ç©ºç“¶' : 'ç¶­è­·'"></span>
                                                        <!-- ç·¨è¼¯/æª¢æŸ¥æŒ‰éˆ• -->
                                                        <button @click.stop="openUnitEditModal(item, unit, idx)"
                                                                class="p-1 rounded"
                                                                :class="unit.checked ? 'text-gray-400 hover:text-amber-600 hover:bg-amber-50' : 'text-amber-500 hover:text-amber-700 bg-amber-50'"
                                                                :title="unit.checked ? 'ç·¨è¼¯' : 'é»æ“Šæª¢æŸ¥'">
                                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/>
                                                            </svg>
                                                        </button>
                                                    </div>
                                                </template>
                                            </div>
                                        </template>
                                        <!-- AGGREGATE æ¨¡å¼ (ç„¡å€‹åˆ¥è¿½è¹¤) -->
                                        <template x-if="item.tracking_mode !== 'PER_UNIT'">
                                            <div class="text-xs text-gray-400">
                                                ç¸½å®¹é‡: <span x-text="((item.capacity_each || 0) * (item.qty || 0)).toLocaleString()"></span> L
                                            </div>
                                        </template>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </template>

                    <!-- é›»åŠ›ä¾›æ‡‰æ˜ç´° -->
                    <template x-for="lifeline in (resilienceStatus.lifelines || []).filter(l => l.type === 'POWER')" :key="lifeline.item_code">
                        <div class="border border-gray-100 rounded-lg">
                            <div class="flex items-center gap-2 p-3 cursor-pointer hover:bg-gray-50"
                                 @click="expandedLifeline = expandedLifeline === lifeline.item_code ? null : lifeline.item_code">
                                <svg class="w-4 h-4 transition-transform text-gray-400"
                                     :class="{ 'rotate-90': expandedLifeline === lifeline.item_code }"
                                     fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                                </svg>
                                <svg class="w-5 h-5 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                                </svg>
                                <span class="font-medium text-gray-700" x-text="lifeline.name"></span>
                                <span class="text-sm text-gray-400" x-text="'(' + (lifeline.consumption ? lifeline.consumption.load_display : '-') + ')'"></span>
                                <span class="ml-auto font-bold text-amber-600" x-text="(lifeline.endurance ? lifeline.endurance.effective_hours : 0) + 'h'"></span>
                            </div>
                            <!-- é›»åŠ›æ˜ç´° (v1.4.7: æ”¯æ´ PER_UNIT) -->
                            <div x-show="expandedLifeline === lifeline.item_code"
                                 x-transition
                                 class="border-t border-gray-100 bg-gray-50 p-3 space-y-3">

                                <!-- å……é›»æé†’ -->
                                <template x-if="lifeline.charging_warnings?.length > 0">
                                    <div class="bg-orange-50 border border-orange-200 rounded-lg p-2 text-xs text-orange-700">
                                        <div class="flex items-center gap-1 font-medium mb-1">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                            </svg>
                                            å……é›»æé†’
                                        </div>
                                        <template x-for="warn in lifeline.charging_warnings" :key="warn">
                                            <p x-text="warn"></p>
                                        </template>
                                    </div>
                                </template>

                                <!-- v1.4.7: PER_UNIT å€‹åˆ¥å–®ä½é¡¯ç¤º -->
                                <template x-if="lifeline.inventory?.items?.some(i => i.tracking_mode === 'PER_UNIT')">
                                    <div class="space-y-3">
                                        <template x-for="item in lifeline.inventory?.items || []" :key="item.item_code">
                                            <div class="bg-white rounded-lg border border-gray-100 p-3">
                                                <!-- è¨­å‚™é¡å‹æ¨™é¡Œ -->
                                                <div class="flex items-center gap-2 text-sm text-gray-600 font-medium mb-2">
                                                    <template x-if="item.device_type === 'POWER_STATION'">
                                                        <svg class="w-4 h-4 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z"/>
                                                        </svg>
                                                    </template>
                                                    <template x-if="item.device_type === 'GENERATOR'">
                                                        <svg class="w-4 h-4 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                                                        </svg>
                                                    </template>
                                                    <span x-text="item.name"></span>
                                                    <span class="text-gray-400 text-xs" x-text="'[' + item.qty + 'å°, å¹³å‡ ' + (item.avg_level || 100) + '%]'"></span>
                                                    <span class="ml-auto text-xs text-gray-400" x-text="item.effective_total + ' ' + item.unit"></span>
                                                </div>
                                                <!-- PER_UNIT å€‹åˆ¥å–®ä½ -->
                                                <template x-if="item.tracking_mode === 'PER_UNIT' && item.units">
                                                    <div class="space-y-1.5">
                                                        <!-- æª¢æŸ¥é€²åº¦ (èˆ‡æ°§æ°£é‹¼ç“¶ä¸€è‡´) -->
                                                        <div class="flex items-center justify-between text-xs text-gray-500 mb-1">
                                                            <span>æª¢æŸ¥é€²åº¦</span>
                                                            <span :class="item.units.filter(u => u.last_check).length === item.units.length ? 'text-amber-600 font-medium' : 'text-amber-500'">
                                                                <span x-text="item.units.filter(u => u.last_check).length"></span>/<span x-text="item.units.length"></span> å·²æª¢æŸ¥
                                                            </span>
                                                        </div>
                                                        <template x-for="(unit, idx) in item.units" :key="unit.label">
                                                            <div class="flex items-center gap-2 text-xs rounded px-3 py-2 transition-all"
                                                                 :class="unit.last_check ? 'bg-white border border-gray-100' : 'bg-gray-100 border border-dashed border-gray-300'">
                                                                <!-- æª¢æŸ¥ç‹€æ…‹åœ–ç¤º (èˆ‡æ°§æ°£é‹¼ç“¶ä¸€è‡´) -->
                                                                <span class="w-4">
                                                                    <template x-if="unit.last_check">
                                                                        <svg class="w-4 h-4 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                                                        </svg>
                                                                    </template>
                                                                    <template x-if="!unit.last_check">
                                                                        <svg class="w-4 h-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                                                        </svg>
                                                                    </template>
                                                                </span>
                                                                <!-- æ¨™ç±¤ -->
                                                                <span class="font-medium w-16" :class="unit.last_check ? 'text-gray-600' : 'text-gray-400'" x-text="unit.label"></span>
                                                                <!-- é›»é‡/æ²¹é‡é€²åº¦æ¢ (amber/gray è‰²ç³») -->
                                                                <div class="flex-1 h-2.5 bg-gray-200 rounded-full overflow-hidden">
                                                                    <div class="h-full rounded-full transition-all"
                                                                         :class="unit.last_check ? (unit.level >= 60 ? 'bg-amber-500' : unit.level >= 30 ? 'bg-amber-300' : 'bg-gray-400') : 'bg-gray-300'"
                                                                         :style="'width: ' + unit.level + '%'"></div>
                                                                </div>
                                                                <!-- ç™¾åˆ†æ¯” -->
                                                                <span class="w-10 text-right font-medium" :class="unit.last_check ? 'text-gray-700' : 'text-gray-400'" x-text="unit.level + '%'"></span>
                                                                <!-- å®¹é‡ -->
                                                                <span class="w-16 text-right text-gray-400" x-text="unit.capacity + ' ' + item.unit"></span>
                                                                <!-- ç‹€æ…‹æ¨™ç±¤ (amber è‰²ç³») -->
                                                                <span class="px-2 py-0.5 text-xs rounded"
                                                                      :class="{
                                                                          'bg-amber-100 text-amber-700': unit.status === 'IN_USE',
                                                                          'bg-orange-100 text-orange-700': unit.status === 'CHARGING',
                                                                          'bg-gray-100 text-gray-600': unit.status === 'AVAILABLE' || unit.status === 'MAINTENANCE' || unit.status === 'OFFLINE'
                                                                      }"
                                                                      x-text="unit.status === 'AVAILABLE' ? 'å¾…å‘½' : unit.status === 'IN_USE' ? 'ä¾›é›»ä¸­' : unit.status === 'CHARGING' ? 'å……é›»ä¸­' : unit.status === 'MAINTENANCE' ? 'ç¶­è­·' : 'é›¢ç·š'"></span>
                                                                <!-- ç·¨è¼¯æŒ‰éˆ• -->
                                                                <button @click.stop="openPowerUnitEditModal(item, unit, idx)"
                                                                        class="p-1 rounded"
                                                                        :class="unit.last_check ? 'text-gray-400 hover:text-amber-600 hover:bg-amber-50' : 'text-amber-500 hover:text-amber-700 bg-amber-50'"
                                                                        :title="unit.last_check ? 'ç·¨è¼¯' : 'é»æ“Šæª¢æŸ¥'">
                                                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/>
                                                                    </svg>
                                                                </button>
                                                            </div>
                                                        </template>
                                                    </div>
                                                </template>
                                                <!-- AGGREGATE æ¨¡å¼ -->
                                                <template x-if="item.tracking_mode !== 'PER_UNIT'">
                                                    <div class="flex items-center gap-2 text-xs text-gray-500">
                                                        <div class="flex-1 h-2 bg-gray-200 rounded-full overflow-hidden">
                                                            <div class="h-full bg-amber-400 rounded-full" :style="'width: ' + (item.avg_level || 100) + '%'"></div>
                                                        </div>
                                                        <span x-text="(item.avg_level || 100) + '%'"></span>
                                                        <span class="text-gray-400">|</span>
                                                        <span x-text="item.effective_total + ' ' + item.unit"></span>
                                                    </div>
                                                </template>
                                            </div>
                                        </template>
                                    </div>
                                </template>

                                <!-- åŸæœ‰ç°¡æ˜“é¡¯ç¤º (ç„¡ items æ™‚çš„å‚™æ´) -->
                                <template x-if="!lifeline.inventory?.items?.length">
                                    <div class="space-y-1.5">
                                        <template x-for="source in lifeline.inventory?.sources || []" :key="source.name">
                                            <div class="flex items-center gap-2 text-xs bg-white border border-gray-100 rounded px-3 py-2">
                                                <span class="flex-1 text-gray-600" x-text="source.name"></span>
                                                <span class="text-gray-400" x-text="source.capacity"></span>
                                                <span class="font-medium text-amber-600" x-text="source.hours + 'h'"></span>
                                            </div>
                                        </template>
                                    </div>
                                </template>

                                <!-- ç¸½è¨ˆ -->
                                <div class="flex items-center gap-3 text-xs text-gray-500 pt-2 border-t border-gray-200">
                                    <span>é›»æ± : <span class="font-medium text-gray-700" x-text="(lifeline.endurance ? lifeline.endurance.battery_hours : 0) + 'h'"></span></span>
                                    <span>+ ç™¼é›»æ©Ÿ: <span class="font-medium text-gray-700" x-text="(lifeline.endurance ? lifeline.endurance.generator_hours : 0) + 'h'"></span></span>
                                    <span class="ml-auto">= ç¸½è¨ˆ: <span class="font-bold text-amber-600" x-text="(lifeline.endurance ? lifeline.endurance.effective_hours : 0) + 'h'"></span></span>
                                </div>
                            </div>
                        </div>
                    </template>

                    <div x-show="!resilienceStatus.lifelines?.length" class="text-center text-gray-400 py-8">
                        <p>å°šç„¡éŸŒæ€§è¨­å‚™è³‡æ–™</p>
                        <p class="text-xs mt-1">è«‹åœ¨è¨­å‚™ç®¡ç†ä¸­æ–°å¢æ°§æ°£ç“¶ã€ç™¼é›»æ©Ÿç­‰éŸŒæ€§è¨­å‚™</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- è¡“å¼ä¸»æª”å·²æ•´åˆè‡³ã€Œè™•ç½®è€—æè¨˜éŒ„ã€åº•éƒ¨ï¼Œæ­¤ç¨ç«‹ Tab å·²ç§»é™¤ (v2.7.1) -->

        <!-- v1.2.7: å–®ä½ç·¨è¼¯ Modal -->
        <div x-show="showUnitEditModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" style="display: none;">
            <div @click.away="showUnitEditModal = false" class="bg-white rounded-xl shadow-2xl p-6 max-w-sm w-full mx-4">
                <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                    <svg class="w-5 h-5 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/>
                    </svg>
                    ç·¨è¼¯å–®ä½ç‹€æ…‹
                </h3>
                <form @submit.prevent="submitUnitEdit()">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-600 mb-1">å–®ä½</label>
                        <div class="text-lg font-semibold text-gray-800" x-text="unitEditForm.label"></div>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-600 mb-2">å……å¡«ç™¾åˆ†æ¯”</label>
                        <div class="flex items-center gap-3">
                            <input type="range" x-model="unitEditForm.level" min="0" max="100" step="5"
                                   class="flex-1 h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                            <div class="w-16 text-center">
                                <input type="number" x-model.number="unitEditForm.level" min="0" max="100"
                                       class="w-full px-2 py-1 text-center border border-gray-300 rounded text-sm">
                            </div>
                        </div>
                        <!-- å¿«æ·æŒ‰éˆ• -->
                        <div class="flex gap-2 mt-2">
                            <button type="button" @click="unitEditForm.level = 100" class="flex-1 px-2 py-1 text-xs bg-gray-100 hover:bg-gray-200 rounded">100%</button>
                            <button type="button" @click="unitEditForm.level = 75" class="flex-1 px-2 py-1 text-xs bg-gray-100 hover:bg-gray-200 rounded">75%</button>
                            <button type="button" @click="unitEditForm.level = 50" class="flex-1 px-2 py-1 text-xs bg-gray-100 hover:bg-gray-200 rounded">50%</button>
                            <button type="button" @click="unitEditForm.level = 25" class="flex-1 px-2 py-1 text-xs bg-gray-100 hover:bg-gray-200 rounded">25%</button>
                            <button type="button" @click="unitEditForm.level = 0" class="flex-1 px-2 py-1 text-xs bg-gray-100 hover:bg-gray-200 rounded">0%</button>
                        </div>
                    </div>
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-600 mb-2">ç‹€æ…‹</label>
                        <div class="grid grid-cols-2 gap-2">
                            <button type="button" @click="unitEditForm.status = 'AVAILABLE'"
                                    :class="unitEditForm.status === 'AVAILABLE' ? 'bg-amber-100 border-amber-400 text-amber-700' : 'bg-gray-50 border-gray-200 text-gray-600'"
                                    class="px-3 py-2 text-sm border rounded-lg">å‚™ç”¨</button>
                            <button type="button" @click="unitEditForm.status = 'IN_USE'"
                                    :class="unitEditForm.status === 'IN_USE' ? 'bg-amber-100 border-amber-400 text-amber-700' : 'bg-gray-50 border-gray-200 text-gray-600'"
                                    class="px-3 py-2 text-sm border rounded-lg">ä½¿ç”¨ä¸­</button>
                            <button type="button" @click="unitEditForm.status = 'EMPTY'"
                                    :class="unitEditForm.status === 'EMPTY' ? 'bg-amber-100 border-amber-400 text-amber-700' : 'bg-gray-50 border-gray-200 text-gray-600'"
                                    class="px-3 py-2 text-sm border rounded-lg">ç©ºç“¶</button>
                            <button type="button" @click="unitEditForm.status = 'MAINTENANCE'"
                                    :class="unitEditForm.status === 'MAINTENANCE' ? 'bg-amber-100 border-amber-400 text-amber-700' : 'bg-gray-50 border-gray-200 text-gray-600'"
                                    class="px-3 py-2 text-sm border rounded-lg">ç¶­è­·ä¸­</button>
                        </div>
                    </div>
                    <div class="flex gap-3">
                        <button type="button" @click="showUnitEditModal = false"
                                class="flex-1 px-4 py-2 border border-gray-300 text-gray-600 rounded-lg hover:bg-gray-50">
                            å–æ¶ˆ
                        </button>
                        <button type="submit"
                                class="flex-1 px-4 py-2 bg-amber-500 text-white rounded-lg hover:bg-amber-600">
                            å„²å­˜å·²æª¢æŸ¥
                        </button>
                    </div>
                    <!-- v1.2.8: é‡ç½®æª¢æŸ¥ç‹€æ…‹æŒ‰éˆ• (åƒ…å·²æª¢æŸ¥é …ç›®é¡¯ç¤º) -->
                    <div x-show="unitEditForm.checked" class="mt-4 pt-4 border-t border-gray-200">
                        <button type="button" @click="resetUnitCheck()"
                                class="w-full px-4 py-2 text-sm text-gray-500 border border-dashed border-gray-300 rounded-lg hover:bg-gray-50 hover:text-gray-700 flex items-center justify-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                            </svg>
                            é‡ç½®ç‚ºæœªæª¢æŸ¥
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- v1.4.7: é›»åŠ›è¨­å‚™å–®ä½ç·¨è¼¯ Modal -->
        <div x-show="showPowerUnitEditModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" style="display: none;">
            <div @click.away="showPowerUnitEditModal = false" class="bg-white rounded-xl shadow-2xl p-6 max-w-sm w-full mx-4">
                <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                    <svg class="w-5 h-5 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                    </svg>
                    ç·¨è¼¯é›»åŠ›è¨­å‚™ç‹€æ…‹
                </h3>
                <form @submit.prevent="submitPowerUnitEdit()">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-600 mb-1">è¨­å‚™</label>
                        <div class="text-lg font-semibold text-gray-800" x-text="powerUnitEditForm.label"></div>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-600 mb-2" x-text="powerUnitEditForm.device_type === 'GENERATOR' ? 'æ²¹é‡ç™¾åˆ†æ¯”' : 'é›»é‡ç™¾åˆ†æ¯”'"></label>
                        <div class="flex items-center gap-3">
                            <input type="range" x-model="powerUnitEditForm.level" min="0" max="100" step="5"
                                   class="flex-1 h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                            <div class="w-16 text-center">
                                <input type="number" x-model.number="powerUnitEditForm.level" min="0" max="100"
                                       class="w-full px-2 py-1 text-center border border-gray-300 rounded text-sm">
                            </div>
                        </div>
                        <!-- å¿«æ·æŒ‰éˆ• -->
                        <div class="flex gap-2 mt-2">
                            <button type="button" @click="powerUnitEditForm.level = 100" class="flex-1 px-2 py-1 text-xs bg-gray-100 hover:bg-gray-200 rounded">100%</button>
                            <button type="button" @click="powerUnitEditForm.level = 75" class="flex-1 px-2 py-1 text-xs bg-gray-100 hover:bg-gray-200 rounded">75%</button>
                            <button type="button" @click="powerUnitEditForm.level = 50" class="flex-1 px-2 py-1 text-xs bg-gray-100 hover:bg-gray-200 rounded">50%</button>
                            <button type="button" @click="powerUnitEditForm.level = 25" class="flex-1 px-2 py-1 text-xs bg-gray-100 hover:bg-gray-200 rounded">25%</button>
                        </div>
                    </div>
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-600 mb-2">ç‹€æ…‹</label>
                        <div class="grid grid-cols-2 gap-2">
                            <button type="button" @click="powerUnitEditForm.status = 'AVAILABLE'"
                                    :class="powerUnitEditForm.status === 'AVAILABLE' ? 'bg-gray-100 border-gray-400 text-gray-700' : 'bg-gray-50 border-gray-200 text-gray-600'"
                                    class="px-3 py-2 text-sm border rounded-lg">å¾…å‘½</button>
                            <button type="button" @click="powerUnitEditForm.status = 'IN_USE'"
                                    :class="powerUnitEditForm.status === 'IN_USE' ? 'bg-amber-100 border-amber-400 text-amber-700' : 'bg-gray-50 border-gray-200 text-gray-600'"
                                    class="px-3 py-2 text-sm border rounded-lg">ä¾›é›»ä¸­</button>
                            <button type="button" @click="powerUnitEditForm.status = 'CHARGING'"
                                    :class="powerUnitEditForm.status === 'CHARGING' ? 'bg-orange-100 border-orange-400 text-orange-700' : 'bg-gray-50 border-gray-200 text-gray-600'"
                                    class="px-3 py-2 text-sm border rounded-lg">å……é›»ä¸­</button>
                            <button type="button" @click="powerUnitEditForm.status = 'MAINTENANCE'"
                                    :class="powerUnitEditForm.status === 'MAINTENANCE' ? 'bg-gray-100 border-gray-400 text-gray-700' : 'bg-gray-50 border-gray-200 text-gray-600'"
                                    class="px-3 py-2 text-sm border rounded-lg">ç¶­è­·ä¸­</button>
                        </div>
                        <!-- å……é›»ä¸­æé†’ -->
                        <div x-show="powerUnitEditForm.status === 'CHARGING'" class="mt-3 p-2 bg-orange-50 border border-orange-200 rounded text-xs text-orange-700">
                            <strong>æé†’</strong>ï¼šå……é›»ä¸­çš„è¨­å‚™æœƒè¨ˆå…¥ç•¶å‰é›»é‡ã€‚è«‹æ–¼å……é›»å®Œæˆå¾Œè¨˜å¾—æ›´æ–°ç‹€æ…‹ã€‚
                        </div>
                    </div>
                    <div class="flex gap-3">
                        <button type="button" @click="showPowerUnitEditModal = false"
                                class="flex-1 px-4 py-2 border border-gray-300 text-gray-600 rounded-lg hover:bg-gray-50">
                            å–æ¶ˆ
                        </button>
                        <button type="submit"
                                class="flex-1 px-4 py-2 bg-amber-500 text-white rounded-lg hover:bg-amber-600">
                            å„²å­˜
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- v1.2.8: æª¢æŸ¥å ±è¡¨ Modal -->
        <div x-show="showCheckReportModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-start justify-center z-50 overflow-y-auto py-4" style="display: none;">
            <div @click.away="showCheckReportModal = false" class="bg-white rounded-xl shadow-2xl p-6 max-w-2xl w-full mx-4 my-4 max-h-[95vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                        <svg class="w-6 h-6 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                        æ¯æ—¥æª¢æŸ¥å ±è¡¨
                    </h3>
                    <button @click="exportCheckReportCSV()" class="px-3 py-1 bg-amber-500 text-white rounded-lg hover:bg-amber-600 text-sm flex items-center gap-1">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                        åŒ¯å‡ºCSV
                    </button>
                </div>

                <!-- æ—¥æœŸé¸æ“‡ -->
                <div class="mb-4 flex gap-4">
                    <div class="flex-1">
                        <label class="block text-sm font-medium text-gray-700 mb-1">é¸æ“‡æ—¥æœŸ</label>
                        <input type="date" x-model="checkReportDate" @change="loadCheckReport()"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500">
                    </div>
                    <div class="flex items-end">
                        <button @click="checkReportDate = new Date().toISOString().split('T')[0]; loadCheckReport()"
                                class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200">
                            ä»Šæ—¥
                        </button>
                    </div>
                </div>

                <!-- å ±è¡¨æ‘˜è¦ -->
                <div class="mb-4 p-4 bg-amber-50 rounded-lg border border-amber-200" x-show="checkReportData?.summary">
                    <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 text-center">
                        <div>
                            <div class="text-2xl font-bold text-amber-600" x-text="checkReportData?.summary?.equipment_count || 0"></div>
                            <div class="text-xs text-gray-500">è¨­å‚™æ•¸</div>
                        </div>
                        <div>
                            <div class="text-2xl font-bold text-amber-600" x-text="checkReportData?.summary?.unit_count || 0"></div>
                            <div class="text-xs text-gray-500">å–®ä½æ•¸</div>
                        </div>
                        <div>
                            <div class="text-2xl font-bold text-amber-600" x-text="checkReportData?.summary?.check_count || 0"></div>
                            <div class="text-xs text-gray-500">æª¢æŸ¥æ¬¡æ•¸</div>
                        </div>
                        <div>
                            <div class="text-sm font-medium text-gray-600" x-text="checkReportData?.summary?.first_check?.split(' ')[1]?.substring(0,5) || '-'"></div>
                            <div class="text-xs text-gray-500">é¦–æ¬¡æª¢æŸ¥</div>
                        </div>
                    </div>
                </div>

                <!-- æª¢æŸ¥è¨˜éŒ„è¡¨ -->
                <div class="overflow-x-auto max-h-72 border border-gray-200 rounded-lg">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50 sticky top-0">
                            <tr>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">æ™‚é–“</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">è¨­å‚™/å–®ä½</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">è®Šæ›´å‰</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">è®Šæ›´å¾Œ</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">ç‹€æ…‹</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            <template x-for="record in checkReportData?.records || []" :key="record.id">
                                <tr class="hover:bg-gray-50">
                                    <td class="px-3 py-2 text-xs text-gray-500" x-text="record.check_time?.split(' ')[1]?.substring(0,5) || '-'"></td>
                                    <td class="px-3 py-2 text-sm">
                                        <span class="font-medium" x-text="record.equipment_name || record.equipment_id"></span>
                                        <span class="text-xs text-gray-400 ml-1" x-text="record.unit_label ? '(' + record.unit_label + ')' : ''"></span>
                                    </td>
                                    <td class="px-3 py-2 text-sm text-gray-500" x-text="record.level_before + '%'"></td>
                                    <td class="px-3 py-2 text-sm font-medium"
                                        :class="record.level_after > record.level_before ? 'text-green-600' : record.level_after < record.level_before ? 'text-amber-600' : 'text-gray-600'"
                                        x-text="record.level_after + '%'"></td>
                                    <td class="px-3 py-2 text-xs">
                                        <span class="px-2 py-0.5 rounded-full bg-gray-100 text-gray-600"
                                              x-text="record.status_after === 'AVAILABLE' ? 'å‚™ç”¨' : record.status_after === 'IN_USE' ? 'ä½¿ç”¨ä¸­' : record.status_after === 'EMPTY' ? 'ç©ºç“¶' : 'ç¶­è­·'"></span>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                    <div x-show="!checkReportData?.records?.length" class="text-center py-8 text-gray-400">
                        <svg class="w-12 h-12 mx-auto mb-2 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                        <p>æ­¤æ—¥æœŸç„¡æª¢æŸ¥è¨˜éŒ„</p>
                    </div>
                </div>

                <div class="mt-4 pt-4 border-t border-gray-200">
                    <button @click="showCheckReportModal = false" class="w-full px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">
                        é—œé–‰
                    </button>
                </div>
            </div>
        </div>

        <!-- æ–°å¢ç‰©å“ Modal -->
        <div x-show="showAddItemModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-start justify-center z-50 overflow-y-auto py-4" style="display: none;">
            <div @click.away="showAddItemModal = false" class="bg-white rounded-xl shadow-2xl p-6 max-w-md w-full mx-4 my-4 max-h-[90vh] overflow-y-auto">
                <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                    <svg class="w-6 h-6 text-teal-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                    </svg>
                    æ–°å¢ç‰©å“
                </h3>
                <form @submit.prevent="submitAddItem()" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ç‰©å“ä»£ç¢¼ (ç•™ç©ºè‡ªå‹•ç”Ÿæˆ)</label>
                        <input type="text" x-model="addItemForm.code" placeholder="ç•™ç©ºå°‡è‡ªå‹•ç”Ÿæˆ" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ç‰©å“åç¨± *</label>
                        <input type="text" x-model="addItemForm.name" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">åˆ†é¡ *</label>
                        <select x-model="addItemForm.category" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500">
                            <option value="æ‰‹è¡“è€—æ">æ‰‹è¡“è€—æ</option>
                            <option value="æ€¥æ•‘ç‰©è³‡">æ€¥æ•‘ç‰©è³‡</option>
                            <option value="è—¥å“">è—¥å“</option>
                            <option value="é˜²è­·ç”¨å“">é˜²è­·ç”¨å“</option>
                            <option value="é†«ç™‚è¨­å‚™">é†«ç™‚è¨­å‚™</option>
                            <option value="å…¶ä»–">å…¶ä»–</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">å–®ä½</label>
                        <input type="text" x-model="addItemForm.unit" placeholder="EA" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">æœ€å°åº«å­˜</label>
                        <input type="number" x-model="addItemForm.minStock" min="0" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500">
                    </div>
                    <div class="flex gap-4">
                        <button type="submit" class="flex-1 bg-teal-600 text-white px-4 py-2 rounded-lg hover:bg-teal-700 transition-colors flex items-center justify-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                            </svg>
                            <span>ç¢ºèªæ–°å¢</span>
                        </button>
                        <button type="button" @click="showAddItemModal = false" class="flex-1 bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors flex items-center justify-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                            <span>å–æ¶ˆ</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- ç·¨è¼¯ç‰©å“ Modal -->
        <div x-show="showEditItemModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-start justify-center z-50 overflow-y-auto py-4" style="display: none;">
            <div @click.away="showEditItemModal = false" class="bg-white rounded-xl shadow-2xl p-6 max-w-md w-full mx-4 my-4 max-h-[90vh] overflow-y-auto">
                <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                    <svg class="w-6 h-6 text-teal-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                    </svg>
                    ç·¨è¼¯ç‰©å“
                </h3>
                <form @submit.prevent="submitEditItem()" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ç‰©å“ä»£ç¢¼</label>
                        <input type="text" x-model="editItemForm.code" disabled class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-100">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ç‰©å“åç¨± *</label>
                        <input type="text" x-model="editItemForm.name" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">åˆ†é¡ *</label>
                        <select x-model="editItemForm.category" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500">
                            <option value="æ‰‹è¡“è€—æ">æ‰‹è¡“è€—æ</option>
                            <option value="æ€¥æ•‘ç‰©è³‡">æ€¥æ•‘ç‰©è³‡</option>
                            <option value="è—¥å“">è—¥å“</option>
                            <option value="é˜²è­·ç”¨å“">é˜²è­·ç”¨å“</option>
                            <option value="é†«ç™‚è¨­å‚™">é†«ç™‚è¨­å‚™</option>
                            <option value="å…¶ä»–">å…¶ä»–</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">å–®ä½</label>
                        <input type="text" x-model="editItemForm.unit" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">æœ€å°åº«å­˜</label>
                        <input type="number" x-model="editItemForm.minStock" min="0" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500">
                    </div>
                    <div class="flex gap-4">
                        <button type="submit" class="flex-1 bg-teal-600 text-white px-4 py-2 rounded-lg hover:bg-teal-700 transition-colors flex items-center justify-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                            </svg>
                            <span>ç¢ºèªæ›´æ–°</span>
                        </button>
                        <button type="button" @click="showEditItemModal = false" class="flex-1 bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors flex items-center justify-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                            <span>å–æ¶ˆ</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- æ–°å¢è¨­å‚™ Modal -->
        <div x-show="showAddEquipmentModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 overflow-y-auto py-4" style="display: none;">
            <div @click.away="showAddEquipmentModal = false" class="bg-white rounded-xl shadow-2xl p-6 max-w-md w-full mx-4 max-h-[90vh] overflow-y-auto">
                <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                    <svg class="w-6 h-6 text-equipment-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                    </svg>
                    æ–°å¢è¨­å‚™
                </h3>
                <form @submit.prevent="submitAddEquipment()" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">è¨­å‚™åç¨± *</label>
                        <input type="text" x-model="addEquipmentForm.name" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-equipment-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">åˆ†é¡ *</label>
                        <select x-model="addEquipmentForm.category" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-equipment-500">
                            <option value="æ‰‹è¡“åŒ…">æ‰‹è¡“åŒ…</option>
                            <option value="é›»åŠ›è¨­å‚™">é›»åŠ›è¨­å‚™</option>
                            <option value="ç©ºæ°£æ·¨åŒ–">ç©ºæ°£æ·¨åŒ–</option>
                            <option value="æ°´è™•ç†">æ°´è™•ç†</option>
                            <option value="å†·è—è¨­å‚™">å†·è—è¨­å‚™</option>
                            <option value="é€šè¨Šè¨­å‚™">é€šè¨Šè¨­å‚™</option>
                            <option value="ç…§æ˜è¨­å‚™">ç…§æ˜è¨­å‚™</option>
                            <option value="å…¶ä»–">å…¶ä»–</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">æ•¸é‡</label>
                        <input type="number" x-model="addEquipmentForm.quantity" min="1" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-equipment-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">å‚™è¨»</label>
                        <textarea x-model="addEquipmentForm.remarks" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-equipment-500"></textarea>
                    </div>
                    <div class="flex gap-4">
                        <button type="submit" class="flex-1 bg-equipment-500 text-white px-4 py-2 rounded-lg hover:bg-[#5a6155] transition-colors flex items-center justify-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                            </svg>
                            <span>ç¢ºèªæ–°å¢</span>
                        </button>
                        <button type="button" @click="showAddEquipmentModal = false" class="flex-1 bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors flex items-center justify-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                            <span>å–æ¶ˆ</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- ç·¨è¼¯è¨­å‚™ Modal -->
        <div x-show="showEditEquipmentModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 overflow-y-auto py-4" style="display: none;">
            <div @click.away="showEditEquipmentModal = false" class="bg-white rounded-xl shadow-2xl p-6 max-w-md w-full mx-4 max-h-[90vh] overflow-y-auto">
                <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                    <svg class="w-6 h-6 text-equipment-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                    </svg>
                    ç·¨è¼¯è¨­å‚™
                </h3>
                <form @submit.prevent="submitEditEquipment()" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">è¨­å‚™ID</label>
                        <input type="text" x-model="editEquipmentForm.id" disabled class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-100">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">è¨­å‚™åç¨± *</label>
                        <input type="text" x-model="editEquipmentForm.name" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-equipment-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">åˆ†é¡ *</label>
                        <select x-model="editEquipmentForm.category" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-equipment-500">
                            <option value="æ‰‹è¡“åŒ…">æ‰‹è¡“åŒ…</option>
                            <option value="é›»åŠ›è¨­å‚™">é›»åŠ›è¨­å‚™</option>
                            <option value="ç©ºæ°£æ·¨åŒ–">ç©ºæ°£æ·¨åŒ–</option>
                            <option value="æ°´è™•ç†">æ°´è™•ç†</option>
                            <option value="å†·è—è¨­å‚™">å†·è—è¨­å‚™</option>
                            <option value="é€šè¨Šè¨­å‚™">é€šè¨Šè¨­å‚™</option>
                            <option value="ç…§æ˜è¨­å‚™">ç…§æ˜è¨­å‚™</option>
                            <option value="å…¶ä»–">å…¶ä»–</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">æ•¸é‡</label>
                        <input type="number" x-model="editEquipmentForm.quantity" min="0" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-equipment-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">å‚™è¨»</label>
                        <textarea x-model="editEquipmentForm.remarks" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-equipment-500"></textarea>
                    </div>
                    <div class="flex gap-4">
                        <button type="submit" class="flex-1 bg-equipment-500 text-white px-4 py-2 rounded-lg hover:bg-[#5a6155] transition-colors flex items-center justify-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                            </svg>
                            <span>ç¢ºèªæ›´æ–°</span>
                        </button>
                        <button type="button" @click="showEditEquipmentModal = false" class="flex-1 bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors flex items-center justify-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                            <span>å–æ¶ˆ</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- è¨­å‚™æª¢æŸ¥ Modal (v2: Unit-Centric) -->
        <div x-show="showCheckEquipmentModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 overflow-y-auto py-4" style="display: none;">
            <div @click.away="showCheckEquipmentModal = false" class="bg-white rounded-xl shadow-2xl p-6 max-w-md w-full mx-4 max-h-[90vh] overflow-y-auto">
                <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                    <svg class="w-6 h-6 text-equipment-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/>
                    </svg>
                    è¨­å‚™æª¢æŸ¥
                </h3>
                <form @submit.prevent="submitCheckEquipment()" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">è¨­å‚™åç¨±</label>
                        <input type="text" x-model="checkEquipmentForm.name" disabled class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-100">
                    </div>

                    <!-- v2: å–®ä½é¸æ“‡å™¨ (å¤šå–®ä½è¨­å‚™) -->
                    <div x-show="checkEquipmentForm.units.length > 1">
                        <label class="block text-sm font-medium text-gray-700 mb-2">é¸æ“‡å–®ä½ *</label>
                        <div class="grid grid-cols-2 gap-2 max-h-32 overflow-y-auto">
                            <template x-for="unit in checkEquipmentForm.units" :key="unit.id">
                                <button type="button"
                                        @click="selectUnit(unit)"
                                        :class="checkEquipmentForm.selectedUnitId === unit.id
                                            ? 'border-equipment-500 bg-equipment-50 ring-2 ring-equipment-500'
                                            : 'border-gray-300 hover:border-gray-400'"
                                        class="p-2 border rounded-lg text-left transition-all">
                                    <div class="font-medium text-sm" x-text="unit.unit_label || unit.unit_serial"></div>
                                    <div class="text-xs text-gray-500 flex justify-between">
                                        <span x-text="unit.level_percent + '%'"></span>
                                        <span :class="{
                                            'text-green-600': unit.status === 'AVAILABLE',
                                            'text-blue-600': unit.status === 'IN_USE',
                                            'text-yellow-600': unit.status === 'CHARGING',
                                            'text-gray-600': unit.status === 'MAINTENANCE'
                                        }" x-text="unit.status"></span>
                                    </div>
                                </button>
                            </template>
                        </div>
                    </div>

                    <!-- å–®ä½è³‡è¨Š (å–®ä¸€å–®ä½è¨­å‚™) -->
                    <div x-show="checkEquipmentForm.units.length === 1" class="text-sm text-gray-600 bg-gray-50 p-2 rounded">
                        <span x-text="checkEquipmentForm.units[0]?.unit_label || 'å–®ä¸€è¨­å‚™'"></span>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ç‹€æ…‹ *</label>
                        <select x-model="checkEquipmentForm.status" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-equipment-500">
                            <!-- v2: å‹•æ…‹ç‹€æ…‹é¸é … -->
                            <template x-for="opt in checkEquipmentForm.statusOptions" :key="opt">
                                <option :value="opt" x-text="opt"></option>
                            </template>
                            <!-- fallback -->
                            <template x-if="!checkEquipmentForm.statusOptions.length">
                                <option value="AVAILABLE">å¯ç”¨ (AVAILABLE)</option>
                            </template>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2"
                               x-text="getEquipmentMetricLabel(checkEquipmentForm.id)"></label>
                        <input type="number" x-model="checkEquipmentForm.powerLevel" min="0" max="100" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-equipment-500">
                        <!-- éŸŒæ€§å½±éŸ¿æç¤º -->
                        <p class="text-xs text-amber-600 mt-1" x-show="checkEquipmentForm.powerLevel && isResilienceEquipment(checkEquipmentForm.id)">
                            <span x-text="'â‰ˆ ' + calculateEquipmentHours(checkEquipmentForm.id, checkEquipmentForm.powerLevel) + ' å°æ™‚éŸŒæ€§è²¢ç»'"></span>
                        </p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">å‚™è¨»</label>
                        <textarea x-model="checkEquipmentForm.remarks" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-equipment-500"></textarea>
                    </div>
                    <div class="flex gap-4">
                        <button type="submit" class="flex-1 bg-equipment-500 text-white px-4 py-2 rounded-lg hover:bg-[#5a6155] transition-colors flex items-center justify-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                            </svg>
                            <span>ç¢ºèªæª¢æŸ¥</span>
                        </button>
                        <button type="button" @click="showCheckEquipmentModal = false" class="flex-1 bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors flex items-center justify-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                            <span>å–æ¶ˆ</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- v2.1: è¨­å‚™å–®ä½ç®¡ç† Modal -->
        <div x-show="showUnitManageModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-start justify-center z-50 overflow-y-auto py-4" style="display: none;">
            <div @click.away="showUnitManageModal = false" class="bg-white rounded-xl shadow-2xl p-4 sm:p-5 md:p-6 max-w-2xl w-full mx-4 my-4 max-h-[95vh] overflow-y-auto">
                <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                    <svg class="w-6 h-6 text-equipment-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
                    </svg>
                    <span>å–®ä½ç®¡ç† - </span>
                    <span x-text="unitManageForm.equipment_name"></span>
                </h3>

                <!-- è¼‰å…¥ä¸­ -->
                <div x-show="unitManageForm.loading" class="text-center py-8">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-equipment-500 mx-auto"></div>
                    <p class="text-gray-500 mt-2">è¼‰å…¥ä¸­...</p>
                </div>

                <div x-show="!unitManageForm.loading" class="space-y-4">
                    <!-- å¿«é€Ÿæ•¸é‡èª¿æ•´ -->
                    <div class="bg-equipment-50 border border-equipment-200 rounded-lg p-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">å¿«é€Ÿæ•¸é‡èª¿æ•´</label>
                        <div class="flex items-center gap-3">
                            <button type="button" @click="unitManageForm.targetQuantity = Math.max(0, unitManageForm.targetQuantity - 1)"
                                    class="w-10 h-10 rounded-full bg-gray-200 hover:bg-gray-300 flex items-center justify-center text-xl font-bold">
                                âˆ’
                            </button>
                            <input type="number" x-model="unitManageForm.targetQuantity" min="0"
                                   class="w-20 text-center text-xl font-bold border-2 border-equipment-300 rounded-lg py-2">
                            <button type="button" @click="unitManageForm.targetQuantity++"
                                    class="w-10 h-10 rounded-full bg-gray-200 hover:bg-gray-300 flex items-center justify-center text-xl font-bold">
                                +
                            </button>
                            <button type="button" @click="batchAdjustQuantity()"
                                    :disabled="unitManageForm.targetQuantity === unitManageForm.units.length"
                                    :class="unitManageForm.targetQuantity === unitManageForm.units.length ? 'bg-gray-300 cursor-not-allowed' : 'bg-equipment-500 hover:bg-equipment-600'"
                                    class="px-4 py-2 text-white rounded-lg transition-colors">
                                å¥—ç”¨
                            </button>
                        </div>
                        <p class="text-xs text-gray-500 mt-2">
                            ç›®å‰: <span x-text="unitManageForm.units.length"></span> å€‹å–®ä½
                            <span x-show="unitManageForm.targetQuantity !== unitManageForm.units.length" class="text-equipment-600 font-medium">
                                â†’ <span x-text="unitManageForm.targetQuantity"></span>
                            </span>
                        </p>
                    </div>

                    <!-- ç¾æœ‰å–®ä½åˆ—è¡¨ -->
                    <div>
                        <h4 class="font-medium text-gray-700 mb-2">ç¾æœ‰å–®ä½ (<span x-text="unitManageForm.units.length"></span>)</h4>
                        <div class="space-y-2 max-h-48 overflow-y-auto">
                            <template x-for="unit in unitManageForm.units" :key="unit.id">
                                <div class="flex items-center justify-between bg-gray-50 rounded-lg p-3 border">
                                    <div class="flex items-center gap-3">
                                        <span class="font-medium" x-text="unit.unit_label || unit.unit_serial"></span>
                                        <span class="text-sm text-gray-500" x-text="unit.level_percent + '%'"></span>
                                        <span class="text-xs px-2 py-1 rounded-full" :class="getStatusBadgeClass(unit.status)" x-text="unit.status"></span>
                                    </div>
                                    <button type="button" @click="removeUnit(unit)"
                                            class="text-red-500 hover:text-red-700 p-1" title="ç§»é™¤">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                        </svg>
                                    </button>
                                </div>
                            </template>
                            <div x-show="unitManageForm.units.length === 0" class="text-center text-gray-400 py-4">
                                ç›®å‰æ²’æœ‰å¯ç”¨å–®ä½
                            </div>
                        </div>
                    </div>

                    <!-- ç§»é™¤åŸå›  -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ç§»é™¤åŸå› ï¼ˆå¯é¸ï¼‰</label>
                        <input type="text" x-model="unitManageForm.removeReason" placeholder="ä¾‹å¦‚ï¼šè¨­å‚™æ•…éšœã€é€ä¿®"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                    </div>

                    <!-- æ–°å¢å–®ä½ -->
                    <div class="border-t pt-4">
                        <h4 class="font-medium text-gray-700 mb-2">æ–°å¢å–®ä½</h4>
                        <div class="grid grid-cols-3 gap-3">
                            <div>
                                <label class="block text-xs text-gray-500 mb-1">é›»é‡ %</label>
                                <input type="number" x-model="unitManageForm.addForm.level_percent" min="0" max="100"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                            </div>
                            <div>
                                <label class="block text-xs text-gray-500 mb-1">ç‹€æ…‹</label>
                                <select x-model="unitManageForm.addForm.status"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                    <option value="AVAILABLE">å¯ç”¨</option>
                                    <option value="IN_USE">ä½¿ç”¨ä¸­</option>
                                    <option value="CHARGING">å……é›»ä¸­</option>
                                    <option value="MAINTENANCE">ç¶­è­·ä¸­</option>
                                </select>
                            </div>
                            <div class="flex items-end">
                                <button type="button" @click="addUnit()"
                                        class="w-full bg-equipment-500 text-white px-4 py-2 rounded-lg hover:bg-[#5a6155] transition-colors text-sm">
                                    + æ–°å¢
                                </button>
                            </div>
                        </div>
                        <div class="mt-2">
                            <label class="block text-xs text-gray-500 mb-1">æ–°å¢åŸå› ï¼ˆå¯é¸ï¼‰</label>
                            <input type="text" x-model="unitManageForm.addForm.reason" placeholder="ä¾‹å¦‚ï¼šæ¼”ç¿’å¢æ´"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                        </div>
                    </div>

                    <!-- å·²ç§»é™¤å–®ä½ -->
                    <div class="border-t pt-4">
                        <button type="button" @click="unitManageForm.showInactive = !unitManageForm.showInactive"
                                class="flex items-center gap-2 text-gray-600 hover:text-gray-800">
                            <svg class="w-4 h-4 transition-transform" :class="unitManageForm.showInactive ? 'rotate-90' : ''" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                            </svg>
                            <span class="text-sm font-medium">å·²ç§»é™¤å–®ä½ (<span x-text="unitManageForm.inactive_units.length"></span>)</span>
                        </button>
                        <div x-show="unitManageForm.showInactive" x-collapse class="mt-2 space-y-2 max-h-32 overflow-y-auto">
                            <template x-for="unit in unitManageForm.inactive_units" :key="unit.id">
                                <div class="flex items-center justify-between bg-red-50 rounded-lg p-3 border border-red-200">
                                    <div>
                                        <span class="font-medium text-gray-600 line-through" x-text="unit.unit_label || unit.unit_serial"></span>
                                        <span class="text-xs text-red-500 ml-2" x-text="unit.removal_reason || 'å·²ç§»é™¤'"></span>
                                    </div>
                                    <button type="button" @click="restoreUnit(unit)"
                                            class="text-green-600 hover:text-green-800 px-3 py-1 text-sm bg-green-100 rounded-lg">
                                        æ¢å¾©
                                    </button>
                                </div>
                            </template>
                            <div x-show="unitManageForm.inactive_units.length === 0" class="text-center text-gray-400 py-2 text-sm">
                                æ²’æœ‰å·²ç§»é™¤çš„å–®ä½
                            </div>
                        </div>
                    </div>

                    <!-- é—œé–‰æŒ‰éˆ• -->
                    <div class="flex justify-end pt-4 border-t">
                        <button type="button" @click="showUnitManageModal = false"
                                class="bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-600 transition-colors">
                            é—œé–‰
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- è—¥å±€æ’¥ç™¼ Modal (MIRS v2.4) -->
        <div x-show="showDispatchModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-start justify-center z-50 overflow-y-auto py-4" style="display: none;">
            <div @click.away="showDispatchModal = false" class="bg-white rounded-xl shadow-2xl p-4 sm:p-5 md:p-6 max-w-3xl w-full mx-4 my-4 max-h-[95vh] overflow-y-auto">
                <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                    <svg class="w-6 h-6 text-treatment-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"/>
                    </svg>
                    æ’¥ç™¼è—¥å“çµ¦è—¥å±€
                </h3>

                <form @submit.prevent="createDispatch()" class="space-y-4">
                    <!-- ç›®æ¨™è—¥å±€è³‡è¨Š -->
                    <div class="bg-treatment-50 rounded-lg p-4 border border-treatment-500/30">
                        <h4 class="font-semibold text-gray-800 mb-3">ç›®æ¨™è—¥å±€</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">è—¥å±€ç·¨è™Ÿ (é¸å¡«)</label>
                                <input type="text" x-model="dispatchForm.target_station_id" placeholder="PHR-001"
                                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-treatment-500">
                                <p class="text-xs text-gray-500 mt-1">ç®¡åˆ¶è—¥å“å¿…é ˆæŒ‡å®š</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">è—¥å±€åç¨± (é¸å¡«)</label>
                                <input type="text" x-model="dispatchForm.target_station_name" placeholder="è¡›ç”Ÿç«™è—¥å±€"
                                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-treatment-500">
                            </div>
                        </div>
                    </div>

                    <!-- è—¥å“æ¸…å–® -->
                    <div class="border-2 border-treatment-500/30 rounded-lg p-4">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="font-semibold text-gray-700 flex items-center gap-2">
                                <svg class="w-5 h-5 text-treatment-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"/>
                                </svg>
                                æ’¥ç™¼è—¥å“æ¸…å–®
                            </h4>
                            <button type="button" @click="addDispatchItem()"
                                    class="bg-treatment-500 text-white px-3 py-1 rounded-lg hover:bg-[#3d4270] text-sm flex items-center gap-1">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                                </svg>
                                æ–°å¢è—¥å“
                            </button>
                        </div>

                        <div class="space-y-3">
                            <template x-for="(item, index) in dispatchForm.items" :key="index">
                                <div class="flex gap-2 items-start border border-gray-200 rounded-lg p-3 bg-white">
                                    <div class="flex-1 grid grid-cols-3 gap-2">
                                        <!-- è—¥å“æœå°‹ -->
                                        <div class="relative col-span-2">
                                            <input type="text" x-model="item.searchText"
                                                   @input="filterDispatchItems(index)"
                                                   @focus="item.showDropdown = true"
                                                   @blur="setTimeout(() => item.showDropdown = false, 200)"
                                                   placeholder="æœå°‹è—¥å“..."
                                                   required
                                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-treatment-500">
                                            <div x-show="item.showDropdown && item.filteredItems && item.filteredItems.length > 0"
                                                 class="absolute z-10 w-full mt-1 bg-white border border-treatment-500/50 rounded-lg shadow-lg max-h-48 overflow-y-auto">
                                                <template x-for="med in item.filteredItems.slice(0, 8)" :key="med.code">
                                                    <div @click.stop="selectDispatchItem(index, med)"
                                                         class="px-3 py-2 hover:bg-treatment-50 cursor-pointer text-sm">
                                                        <span class="font-mono" x-text="med.code"></span> -
                                                        <span x-text="med.name"></span>
                                                        <span class="text-xs text-gray-500" x-text="`(å¯ç”¨: ${med.current_stock - (med.reserved_qty || 0)})`"></span>
                                                    </div>
                                                </template>
                                            </div>
                                        </div>
                                        <!-- æ•¸é‡ -->
                                        <input type="number" x-model="item.quantity" required min="1" placeholder="æ•¸é‡"
                                               class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-treatment-500">
                                    </div>
                                    <!-- åˆªé™¤ -->
                                    <button type="button" @click="removeDispatchItem(index)"
                                            x-show="dispatchForm.items.length > 1"
                                            class="text-red-600 hover:text-red-800 p-2">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                        </svg>
                                    </button>
                                </div>
                            </template>
                        </div>
                    </div>

                    <!-- æ“ä½œæŒ‰éˆ• -->
                    <div class="flex flex-col sm:flex-row gap-3 pt-4 border-t">
                        <button type="submit" class="flex-1 bg-treatment-500 text-white px-4 py-2 rounded-lg hover:bg-[#3d4270] transition-colors flex items-center justify-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z"/>
                            </svg>
                            å»ºç«‹æ’¥ç™¼å–® + ç”¢ç”Ÿ QR
                        </button>
                        <button type="button" @click="showDispatchModal = false; resetDispatchForm()"
                                class="flex-1 bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors flex items-center justify-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                            å–æ¶ˆ
                        </button>
                    </div>
                </form>

                <!-- å·²å»ºç«‹çš„æ’¥ç™¼å–®åˆ—è¡¨ -->
                <div x-show="dispatchList.length > 0" class="mt-6 border-t pt-4">
                    <h4 class="font-semibold text-gray-700 mb-3">æœ€è¿‘æ’¥ç™¼å–®</h4>
                    <div class="space-y-2 max-h-48 overflow-y-auto">
                        <template x-for="dispatch in dispatchList" :key="dispatch.dispatch_id">
                            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg border">
                                <div>
                                    <span class="font-mono text-sm" x-text="dispatch.dispatch_id"></span>
                                    <span class="ml-2 px-2 py-0.5 text-xs rounded-full"
                                          :class="{
                                              'bg-gray-200 text-gray-700': dispatch.status === 'DRAFT',
                                              'bg-yellow-100 text-yellow-800': dispatch.status === 'RESERVED',
                                              'bg-blue-100 text-blue-800': dispatch.status === 'DISPATCHED',
                                              'bg-green-100 text-green-800': dispatch.status === 'RECEIVED',
                                              'bg-red-100 text-red-800': dispatch.status === 'CANCELLED'
                                          }"
                                          x-text="dispatch.status"></span>
                                    <span class="text-xs text-gray-500 ml-2" x-text="dispatch.target_station_name || 'æœªæŒ‡å®š'"></span>
                                </div>
                                <div class="flex gap-2">
                                    <button @click="showDispatchQR(dispatch)"
                                            x-show="dispatch.status === 'RESERVED' || dispatch.status === 'DISPATCHED'"
                                            class="text-treatment-500 hover:text-[#3d4270] text-sm">
                                        QR
                                    </button>
                                    <button @click="confirmDispatch(dispatch.dispatch_id)"
                                            x-show="dispatch.status === 'RESERVED'"
                                            class="text-green-600 hover:text-green-800 text-sm">
                                        ç¢ºèª
                                    </button>
                                    <button @click="cancelDispatch(dispatch.dispatch_id)"
                                            x-show="dispatch.status === 'DRAFT' || dispatch.status === 'RESERVED'"
                                            class="text-red-600 hover:text-red-800 text-sm">
                                        å–æ¶ˆ
                                    </button>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ’¥ç™¼ QR Code é¡¯ç¤º Modal -->
        <div x-show="showDispatchQRModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" style="display: none;">
            <div @click.away="showDispatchQRModal = false" class="bg-white rounded-xl shadow-2xl p-6 max-w-md w-full mx-4">
                <h3 class="text-lg font-bold text-gray-800 mb-4 text-center">æƒææ­¤ QR Code</h3>

                <div class="flex justify-center mb-4">
                    <div class="p-4 bg-white border-4 border-treatment-500 rounded-lg">
                        <!-- é¡¯ç¤º QR Code æˆ–è¼‰å…¥ä¸­ -->
                        <template x-if="dispatchQRData.qr_codes[dispatchQRData.current_index]?.data_url">
                            <img :src="dispatchQRData.qr_codes[dispatchQRData.current_index]?.data_url"
                                 alt="Dispatch QR Code" class="w-48 h-48">
                        </template>
                        <template x-if="!dispatchQRData.qr_codes[dispatchQRData.current_index]?.data_url">
                            <div class="w-48 h-48 flex items-center justify-center text-gray-400 bg-gray-100 rounded">
                                <span x-show="dispatchQRData.qr_codes.length === 0">è¼‰å…¥ä¸­...</span>
                                <span x-show="dispatchQRData.qr_codes.length > 0">QR ç”Ÿæˆå¤±æ•—</span>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- å¤šç‰‡è¼ªæ’­æ§åˆ¶ -->
                <div x-show="dispatchQRData.qr_codes.length > 1" class="flex justify-center items-center gap-4 mb-4">
                    <button @click="dispatchQRData.current_index = Math.max(0, dispatchQRData.current_index - 1)"
                            :disabled="dispatchQRData.current_index === 0"
                            class="px-3 py-1 bg-gray-200 rounded-lg disabled:opacity-50">
                        â—€ ä¸Šä¸€ç‰‡
                    </button>
                    <span class="text-sm text-gray-600"
                          x-text="`${dispatchQRData.current_index + 1} / ${dispatchQRData.qr_codes.length}`"></span>
                    <button @click="dispatchQRData.current_index = Math.min(dispatchQRData.qr_codes.length - 1, dispatchQRData.current_index + 1)"
                            :disabled="dispatchQRData.current_index >= dispatchQRData.qr_codes.length - 1"
                            class="px-3 py-1 bg-gray-200 rounded-lg disabled:opacity-50">
                        ä¸‹ä¸€ç‰‡ â–¶
                    </button>
                </div>

                <div class="text-center text-sm text-gray-600 mb-4 space-y-1">
                    <p>æ’¥ç™¼å–®: <span class="font-mono" x-text="dispatchQRData.dispatch_id"></span></p>
                    <p class="text-xs text-gray-400">
                        ä¼ºæœå™¨: <span class="font-mono" x-text="getDisplayServerUrl()"></span>
                    </p>
                    <p x-show="isLocalhostAccess()" class="text-xs text-amber-600 mt-1">
                        âš ï¸ æ‰‹æ©Ÿè«‹æ”¹ç”¨é›»è…¦ IP å­˜å– MIRS
                    </p>
                </div>

                <div class="flex gap-3">
                    <button @click="confirmDispatch(dispatchQRData.dispatch_id)"
                            class="flex-1 bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">
                        ç¢ºèªé€å‡º
                    </button>
                    <button @click="showDispatchQRModal = false"
                            class="flex-1 bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600">
                        é—œé–‰
                    </button>
                </div>
            </div>
        </div>

        <!-- æ–°å¢è™•ç½®è€—æè¨˜éŒ„ Modal -->
        <div x-show="showAddSurgeryModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-start justify-center z-50 overflow-y-auto py-4" style="display: none;">
            <div @click.away="showAddSurgeryModal = false" class="bg-white rounded-xl shadow-2xl p-4 sm:p-5 md:p-6 max-w-2xl w-full mx-4 my-4 max-h-[95vh] overflow-y-auto">
                <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                    <svg class="w-6 h-6 text-treatment-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                    </svg>
                    æ–°å¢è™•ç½®è€—æè¨˜éŒ„
                </h3>
                <form @submit.prevent="submitAddSurgery()" class="space-y-4">
                    <!-- åŸºæœ¬è³‡è¨Š -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ç—…æ‚£å§“å *</label>
                            <input type="text" x-model="addSurgeryForm.patientName" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-treatment-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">æª¢å‚·ç·¨è™Ÿ (Triage Tag ID)</label>
                            <input type="text" x-model="addSurgeryForm.triageTagId" placeholder="ä¾‹å¦‚: RED-001" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-treatment-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ä¸»åˆ€é†«å¸« *</label>
                            <input type="text" x-model="addSurgeryForm.surgeonName" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-treatment-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">éº»é†‰æ–¹å¼</label>
                            <input type="text" x-model="addSurgeryForm.anesthesiaType" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-treatment-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">è™•ç½®æ™‚é•· (åˆ†é˜)</label>
                            <input type="number" x-model="addSurgeryForm.durationMinutes" min="0" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-treatment-500">
                        </div>
                    </div>

                    <!-- è¡“å¼ä»£ç¢¼ Queue (v2.7.4) -->
                    <div class="border-2 border-treatment-300 rounded-lg p-4 bg-treatment-50">
                        <h4 class="text-lg font-semibold text-treatment-700 flex items-center gap-2 mb-3">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                            </svg>
                            è¡“å¼ä»£ç¢¼
                            <span class="text-xs text-gray-500 font-normal">(å¯å¤šé¸ï¼Œè‡ªå‹•è¨ˆç®—éæ¸›é»æ•¸)</span>
                        </h4>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-3">
                            <div>
                                <input type="text" x-model="addSurgeryForm.surgerySearchText" @input.debounce.300ms="searchFormSurgery()"
                                       placeholder="æœå°‹è¡“å¼..." class="w-full px-3 py-2 border border-treatment-300 rounded text-sm mb-2">
                                <div class="max-h-32 overflow-y-auto space-y-1">
                                    <template x-for="code in formSurgerySearchResults" :key="code.code">
                                        <button type="button" @click="addToFormSurgeryQueue(code)"
                                                class="w-full text-left px-2 py-1 text-sm bg-white rounded border border-treatment-200 hover:bg-treatment-100">
                                            <span class="font-mono text-xs" x-text="code.code"></span>
                                            <span x-text="code.name_zh"></span>
                                            <span class="float-right text-treatment-600" x-text="code.points?.toLocaleString() + 'é»'"></span>
                                        </button>
                                    </template>
                                </div>
                            </div>
                            <div class="bg-white rounded p-2 min-h-[80px]">
                                <div class="space-y-1 mb-2">
                                    <template x-for="(item, idx) in addSurgeryForm.surgeryQueue" :key="item.code">
                                        <div class="flex justify-between items-center px-2 py-1 rounded text-sm"
                                             :class="item.reduction_rate === 1 ? 'bg-green-100' : (item.reduction_rate === 0.5 ? 'bg-yellow-100' : 'bg-red-100')">
                                            <div class="flex-1 truncate">
                                                <span class="text-xs" x-text="item.name_zh"></span>
                                                <span class="text-xs text-gray-500" x-text="'(' + Math.round(item.reduction_rate * 100) + '%)'"></span>
                                            </div>
                                            <div class="flex items-center gap-1">
                                                <span class="text-xs" x-text="(item.final_points || 0).toLocaleString() + 'é»'"></span>
                                                <button type="button" @click="removeFromFormSurgeryQueue(idx)" class="text-red-500 text-xs">âœ•</button>
                                            </div>
                                        </div>
                                    </template>
                                </div>
                                <div x-show="addSurgeryForm.surgeryQueue.length === 0" class="text-center text-gray-400 text-sm py-2">
                                    æœå°‹ä¸¦é»æ“ŠåŠ å…¥è¡“å¼
                                </div>
                                <div x-show="addSurgeryForm.surgeryQueue.length > 0" class="text-right text-sm font-bold text-treatment-700 border-t pt-1">
                                    ç¸½è¨ˆ: <span x-text="getFormSurgeryTotal().toLocaleString()"></span> é»
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- è‡ªè²»é …ç›® Queue (v2.7.4) -->
                    <div class="border-2 border-green-300 rounded-lg p-4 bg-green-50">
                        <h4 class="text-lg font-semibold text-green-700 flex items-center gap-2 mb-3">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            è‡ªè²»é …ç›®
                            <span class="text-xs text-gray-500 font-normal">(å¯å¤šé¸ï¼Œé»æ“ŠåŠ å…¥)</span>
                        </h4>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-3">
                            <div>
                                <input type="text" x-model="addSurgeryForm.selfPayFormSearchText" @input.debounce.300ms="searchFormSelfPay()"
                                       placeholder="æœå°‹è‡ªè²»é …ç›®..." class="w-full px-3 py-2 border border-green-300 rounded text-sm mb-2">
                                <div class="max-h-32 overflow-y-auto space-y-1">
                                    <template x-for="item in formSelfPaySearchResults" :key="item.item_id">
                                        <button type="button" @click="addToFormSelfPayQueue(item)"
                                                class="w-full text-left px-2 py-1 text-sm bg-white rounded border border-green-200 hover:bg-green-100">
                                            <span x-text="item.name"></span>
                                            <span class="float-right text-green-600" x-text="'$' + item.unit_price?.toLocaleString()"></span>
                                        </button>
                                    </template>
                                </div>
                            </div>
                            <div class="bg-white rounded p-2 min-h-[80px]">
                                <div class="space-y-1 mb-2">
                                    <template x-for="(item, idx) in addSurgeryForm.selfPayQueue" :key="item.item_id">
                                        <div class="flex justify-between items-center px-2 py-1 bg-green-50 rounded text-sm">
                                            <span class="truncate flex-1 mr-2" x-text="item.name"></span>
                                            <div class="flex items-center gap-1">
                                                <button type="button" @click="updateFormSelfPayQty(idx, -1)" class="w-5 h-5 text-xs bg-gray-200 rounded">âˆ’</button>
                                                <span class="w-6 text-center" x-text="item.quantity"></span>
                                                <button type="button" @click="updateFormSelfPayQty(idx, 1)" class="w-5 h-5 text-xs bg-gray-200 rounded">+</button>
                                                <span class="text-green-600 w-16 text-right text-xs" x-text="'$' + (item.unit_price * item.quantity).toLocaleString()"></span>
                                                <button type="button" @click="removeFromFormSelfPayQueue(idx)" class="text-red-500 text-xs ml-1">âœ•</button>
                                            </div>
                                        </div>
                                    </template>
                                </div>
                                <div x-show="addSurgeryForm.selfPayQueue.length === 0" class="text-center text-gray-400 text-sm py-2">
                                    æœå°‹ä¸¦é»æ“ŠåŠ å…¥è‡ªè²»é …ç›®
                                </div>
                                <div x-show="addSurgeryForm.selfPayQueue.length > 0" class="text-right text-sm font-bold text-green-700 border-t pt-1">
                                    ç¸½è¨ˆ: $<span x-text="getFormSelfPayTotal().toLocaleString()"></span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- å‚™è¨» -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            è™•ç½®å‚™è¨»
                            <span class="text-xs text-gray-500 font-normal">(å¯è¨˜éŒ„æª¢å‚·ç·¨è™Ÿã€å‚·å‹¢ç‹€æ³ç­‰è³‡è¨Š)</span>
                        </label>
                        <textarea x-model="addSurgeryForm.remarks" rows="3" placeholder="ä¾‹å¦‚: æª¢å‚·ç·¨è™Ÿ RED-001, å³è…¿é–‹æ”¾æ€§éª¨æŠ˜..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-treatment-500"></textarea>
                    </div>

                    <!-- è€—ææ¸…å–® -->
                    <div class="border-2 border-gray-200 rounded-lg p-4">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="text-lg font-semibold text-gray-700 flex items-center gap-2">
                                <svg class="w-5 h-5 text-treatment-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"/>
                                </svg>
                                ä½¿ç”¨è€—æ
                            </h4>
                            <button type="button" @click="addConsumptionItem()" class="bg-treatment-500 text-white px-3 py-1 rounded-lg hover:bg-[#3d4270] text-sm flex items-center gap-1">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                                </svg>
                                æ–°å¢è€—æ
                            </button>
                        </div>

                        <div class="space-y-3">
                            <template x-for="(item, index) in addSurgeryForm.consumptions" :key="index">
                                <div class="flex gap-2 items-start border border-gray-200 rounded-lg p-3">
                                    <div class="flex-1 grid grid-cols-3 gap-2">
                                        <div class="relative">
                                            <input
                                                type="text"
                                                x-model="item.searchText"
                                                @input="filterConsumptionItems(index)"
                                                @focus="filterConsumptionItems(index); item.showDropdown = true"
                                                @blur="setTimeout(() => item.showDropdown = false, 200)"
                                                placeholder="æœå°‹è€—æ..."
                                                required
                                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-treatment-500"
                                            >
                                            <div x-show="item.showDropdown && item.filteredItems && item.filteredItems.length > 0"
                                                 class="absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-48 overflow-y-auto">
                                                <template x-for="availableItem in item.filteredItems.slice(0, 8)" :key="availableItem.code">
                                                    <div @click.stop="selectConsumptionItem(index, availableItem)"
                                                         class="px-3 py-2 hover:bg-treatment-50 cursor-pointer text-sm">
                                                        <span class="font-mono" x-text="availableItem.code"></span> -
                                                        <span x-text="availableItem.name"></span>
                                                        <span class="text-xs text-gray-500" x-text="`(åº«å­˜: ${availableItem.current_stock})`"></span>
                                                    </div>
                                                </template>
                                            </div>
                                        </div>
                                        <input type="number" x-model="item.quantity" required min="1" placeholder="æ•¸é‡" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-treatment-500">
                                        <input type="text" x-model="item.unit" readonly placeholder="å–®ä½" class="px-3 py-2 border border-gray-300 rounded-lg bg-gray-50">
                                    </div>
                                    <button type="button" @click="removeConsumptionItem(index)" class="text-red-600 hover:text-red-800 p-2">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                        </svg>
                                    </button>
                                </div>
                            </template>
                        </div>

                        <div x-show="addSurgeryForm.consumptions.length === 0" class="text-center text-gray-400 py-4">
                            å°šæœªæ–°å¢è€—æ
                        </div>
                    </div>

                    <!-- è¡“ä¸­ç”¨è—¥ -->
                    <div class="border-2 border-dispense-purple-500 rounded-lg p-4 bg-dispense-purple-50">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="text-lg font-semibold text-gray-700 flex items-center gap-2">
                                <svg class="w-5 h-5 text-dispense-purple-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"/>
                                </svg>
                                è¡“ä¸­ç”¨è—¥
                                <span class="text-xs text-gray-500 font-normal">(å±€éƒ¨æ³¨å°„è—¥ç‰©)</span>
                            </h4>
                            <button type="button" @click="addIntraopMed()" class="bg-dispense-purple-700 text-white px-3 py-1 rounded-lg hover:bg-dispense-purple-900 text-sm flex items-center gap-1">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                                </svg>
                                æ–°å¢è—¥ç‰©
                            </button>
                        </div>

                        <!-- å¸¸ç”¨è¡“ä¸­ç”¨è—¥å¿«é¸ -->
                        <div class="flex flex-wrap gap-2 mb-3">
                            <button type="button" @click="addQuickIntraopMed('Morphine', '10', 'mg')" class="px-2 py-1 text-xs bg-dispense-purple-50 text-dispense-purple-700 rounded border border-dispense-purple-500 hover:bg-dispense-purple-500 hover:text-white">Morphine</button>
                            <button type="button" @click="addQuickIntraopMed('Ketorolac', '30', 'mg')" class="px-2 py-1 text-xs bg-dispense-purple-50 text-dispense-purple-700 rounded border border-dispense-purple-500 hover:bg-dispense-purple-500 hover:text-white">Ketorolac</button>
                            <button type="button" @click="addQuickIntraopMed('Triamcinolone', '40', 'mg')" class="px-2 py-1 text-xs bg-dispense-purple-50 text-dispense-purple-700 rounded border border-dispense-purple-500 hover:bg-dispense-purple-500 hover:text-white">Triamcinolone</button>
                            <button type="button" @click="addQuickIntraopMed('Xylocaine 2%', '10', 'ml')" class="px-2 py-1 text-xs bg-dispense-purple-50 text-dispense-purple-700 rounded border border-dispense-purple-500 hover:bg-dispense-purple-500 hover:text-white">Xylocaine</button>
                            <button type="button" @click="addQuickIntraopMed('Marcaine 0.5%', '10', 'ml')" class="px-2 py-1 text-xs bg-dispense-purple-50 text-dispense-purple-700 rounded border border-dispense-purple-500 hover:bg-dispense-purple-500 hover:text-white">Marcaine</button>
                        </div>

                        <div class="space-y-3">
                            <template x-for="(med, index) in addSurgeryForm.intraopMeds" :key="index">
                                <div class="flex gap-2 items-center border border-dispense-purple-500 rounded-lg p-3 bg-white">
                                    <div class="flex-1 grid grid-cols-3 gap-2">
                                        <input type="text" x-model="med.name" required placeholder="è—¥ç‰©åç¨±"
                                               class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-dispense-purple-700">
                                        <input type="text" x-model="med.dose" required placeholder="åŠ‘é‡"
                                               class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-dispense-purple-700">
                                        <input type="text" x-model="med.unit" required placeholder="å–®ä½"
                                               class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-dispense-purple-700">
                                    </div>
                                    <button type="button" @click="removeIntraopMed(index)" class="text-red-600 hover:text-red-800 p-2">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                        </svg>
                                    </button>
                                </div>
                            </template>
                        </div>

                        <div x-show="addSurgeryForm.intraopMeds.length === 0" class="text-center text-gray-400 py-4">
                            å°šæœªæ–°å¢è¡“ä¸­ç”¨è—¥
                        </div>
                    </div>

                    <div class="flex gap-4 pt-4">
                        <button type="submit" class="flex-1 bg-treatment-500 text-white px-4 py-2 rounded-lg hover:bg-[#3d4270] transition-colors flex items-center justify-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                            </svg>
                            ç¢ºèªå»ºç«‹
                        </button>
                        <button type="button" @click="showAddSurgeryModal = false; resetAddSurgeryForm()" class="flex-1 bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors flex items-center justify-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                            å–æ¶ˆ
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- è™•ç½®è©³æƒ… Modal -->
        <div x-show="showSurgeryDetailModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-start justify-center z-50 overflow-y-auto py-4" style="display: none;">
            <div @click.away="showSurgeryDetailModal = false" class="bg-white rounded-xl shadow-2xl p-6 max-w-2xl w-full mx-4 my-4 max-h-[95vh] overflow-y-auto">
                <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                    <svg class="w-6 h-6 text-treatment-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                    </svg>
                    è™•ç½®è€—æè¨˜éŒ„è©³æƒ…
                </h3>

                <template x-if="selectedSurgery">
                    <div class="space-y-4">
                        <!-- åŸºæœ¬è³‡è¨Š -->
                        <div class="grid grid-cols-2 gap-4 bg-gray-50 p-4 rounded-lg">
                            <div>
                                <p class="text-sm text-gray-600">è¨˜éŒ„ç·¨è™Ÿ</p>
                                <p class="font-semibold" x-text="selectedSurgery.record_number"></p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">æ—¥æœŸ</p>
                                <p class="font-semibold" x-text="selectedSurgery.record_date"></p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">ç—…æ‚£å§“å</p>
                                <p class="font-semibold" x-text="selectedSurgery.patient_name"></p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">ç•¶æ—¥ç¬¬ N å°</p>
                                <p class="font-semibold" x-text="selectedSurgery.surgery_sequence"></p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">è™•ç½®é¡å‹</p>
                                <p class="font-semibold" x-text="selectedSurgery.surgery_type"></p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">ä¸»åˆ€é†«å¸«</p>
                                <p class="font-semibold" x-text="selectedSurgery.surgeon_name"></p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">éº»é†‰æ–¹å¼</p>
                                <p class="font-semibold" x-text="selectedSurgery.anesthesia_type || '-'"></p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">è™•ç½®æ™‚é•·</p>
                                <p class="font-semibold" x-text="selectedSurgery.duration_minutes ? selectedSurgery.duration_minutes + ' åˆ†é˜' : '-'"></p>
                            </div>
                        </div>

                        <!-- å‚™è¨» -->
                        <div x-show="selectedSurgery.remarks" class="bg-yellow-50 p-4 rounded-lg">
                            <p class="text-sm text-gray-600 mb-1">å‚™è¨»</p>
                            <p class="text-gray-800" x-text="selectedSurgery.remarks"></p>
                        </div>

                        <!-- è€—ææ¸…å–® -->
                        <div class="border-2 border-gray-200 rounded-lg p-4">
                            <h4 class="text-lg font-semibold text-gray-700 mb-3 flex items-center gap-2">
                                <svg class="w-5 h-5 text-treatment-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"/>
                                </svg>
                                ä½¿ç”¨è€—æ
                            </h4>
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">ä»£ç¢¼</th>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">åç¨±</th>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">æ•¸é‡</th>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">å–®ä½</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white divide-y divide-gray-200">
                                        <template x-for="consumption in selectedSurgery.consumptions" :key="consumption.item_code">
                                            <tr>
                                                <td class="px-4 py-2 text-sm font-mono" x-text="consumption.item_code"></td>
                                                <td class="px-4 py-2 text-sm" x-text="consumption.item_name"></td>
                                                <td class="px-4 py-2 text-sm font-semibold" x-text="consumption.quantity"></td>
                                                <td class="px-4 py-2 text-sm" x-text="consumption.unit"></td>
                                            </tr>
                                        </template>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <div class="pt-4">
                            <button type="button" @click="showSurgeryDetailModal = false" class="w-full bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors">
                                é—œé–‰
                            </button>
                        </div>
                    </div>
                </template>
            </div>
        </div>

        <!-- é€²è²¨è¨˜éŒ„ Modal -->
        <div x-show="showReceiveHistoryModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-start justify-center z-50 overflow-y-auto py-4" style="display: none;">
            <div @click.away="showReceiveHistoryModal = false" class="bg-white rounded-xl shadow-2xl p-3 sm:p-4 md:p-6 max-w-6xl w-full mx-4 my-4 max-h-[95vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                        <svg class="w-6 h-6 text-teal-custom-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"/>
                        </svg>
                        é€²è²¨è¨˜éŒ„
                    </h3>
                    <button @click="exportReceiveHistoryCSV()" class="bg-teal-custom-500 text-white px-4 py-2 rounded-lg hover:bg-teal-custom-600 transition-colors text-sm flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                        åŒ¯å‡ºCSV
                    </button>
                </div>

                <!-- ç¯©é¸æ¢ä»¶ -->
                <div class="mb-4 grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">é–‹å§‹æ—¥æœŸ</label>
                        <input type="date" x-model="receiveHistorySearch.startDate" @change="loadReceiveHistory()" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-custom-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">çµæŸæ—¥æœŸ</label>
                        <input type="date" x-model="receiveHistorySearch.endDate" @change="loadReceiveHistory()" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-custom-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ç‰©å“ä»£ç¢¼</label>
                        <input type="text" x-model="receiveHistorySearch.itemCode" @input="loadReceiveHistory()" placeholder="æœå°‹ç‰©å“..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-custom-500">
                    </div>
                </div>

                <div class="overflow-x-auto max-h-96">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50 sticky top-0">
                            <tr>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">æ™‚é–“</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">ç‰©å“ä»£ç¢¼</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">ç‰©å“åç¨±</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">æ•¸é‡</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">æ‰¹è™Ÿ</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">æ•ˆæœŸ</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">å‚™è¨»</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            <template x-for="event in receiveHistory" :key="event.id">
                                <tr class="hover:bg-gray-50">
                                    <td class="px-4 py-2 text-sm" x-text="new Date(event.timestamp).toLocaleString('zh-TW')"></td>
                                    <td class="px-4 py-2 text-sm font-mono" x-text="event.item_code"></td>
                                    <td class="px-4 py-2 text-sm" x-text="event.item_name"></td>
                                    <td class="px-4 py-2 text-sm font-semibold text-green-600" x-text="'+' + event.quantity + ' ' + event.unit"></td>
                                    <td class="px-4 py-2 text-sm" x-text="event.batch_number || '-'"></td>
                                    <td class="px-4 py-2 text-sm" x-text="event.expiry_date || '-'"></td>
                                    <td class="px-4 py-2 text-sm text-gray-600" x-text="event.remarks || '-'"></td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>

                <div class="pt-4">
                    <button type="button" @click="showReceiveHistoryModal = false" class="w-full bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors">
                        é—œé–‰
                    </button>
                </div>
            </div>
        </div>

        <!-- æ¶ˆè€—è¨˜éŒ„ Modal -->
        <div x-show="showConsumeHistoryModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-start justify-center z-50 overflow-y-auto py-4" style="display: none;">
            <div @click.away="showConsumeHistoryModal = false" class="bg-white rounded-xl shadow-2xl p-3 sm:p-4 md:p-6 max-w-6xl w-full mx-4 my-4 max-h-[95vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                        <svg class="w-6 h-6 text-treatment-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                        </svg>
                        æ¶ˆè€—è¨˜éŒ„
                    </h3>
                    <button @click="exportConsumeHistoryCSV()" class="bg-teal-custom-500 text-white px-4 py-2 rounded-lg hover:bg-teal-custom-600 transition-colors text-sm flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                        åŒ¯å‡ºCSV
                    </button>
                </div>

                <!-- ç¯©é¸æ¢ä»¶ -->
                <div class="mb-4 grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">é–‹å§‹æ—¥æœŸ</label>
                        <input type="date" x-model="consumeHistorySearch.startDate" @change="loadConsumeHistory()" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-treatment-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">çµæŸæ—¥æœŸ</label>
                        <input type="date" x-model="consumeHistorySearch.endDate" @change="loadConsumeHistory()" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-treatment-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ç‰©å“ä»£ç¢¼</label>
                        <input type="text" x-model="consumeHistorySearch.itemCode" @input="loadConsumeHistory()" placeholder="æœå°‹ç‰©å“..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-treatment-500">
                    </div>
                </div>

                <div class="overflow-x-auto max-h-96">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50 sticky top-0">
                            <tr>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">æ™‚é–“</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">ç‰©å“ä»£ç¢¼</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">ç‰©å“åç¨±</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">æ•¸é‡</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">ç”¨é€”</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            <template x-for="event in consumeHistory" :key="event.id">
                                <tr class="hover:bg-gray-50">
                                    <td class="px-4 py-2 text-sm" x-text="new Date(event.timestamp).toLocaleString('zh-TW')"></td>
                                    <td class="px-4 py-2 text-sm font-mono" x-text="event.item_code"></td>
                                    <td class="px-4 py-2 text-sm" x-text="event.item_name"></td>
                                    <td class="px-4 py-2 text-sm font-semibold text-red-600" x-text="'-' + event.quantity + ' ' + event.unit"></td>
                                    <td class="px-4 py-2 text-sm text-gray-600" x-text="event.remarks || '-'"></td>
                                    <td class="px-4 py-2 text-sm">
                                        <button @click="viewConsumeDetail(event)" class="text-blue-600 hover:text-blue-800">è©³æƒ…</button>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>

                <div class="pt-4">
                    <button type="button" @click="showConsumeHistoryModal = false" class="w-full bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors">
                        é—œé–‰
                    </button>
                </div>
            </div>
        </div>

        <!-- æ¶ˆè€—è©³æƒ… Modal -->
        <div x-show="showConsumeDetailModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-start justify-center z-50 overflow-y-auto py-4" style="display: none;">
            <div @click.away="showConsumeDetailModal = false" class="bg-white rounded-xl shadow-2xl p-6 max-w-md w-full mx-4 my-4 max-h-[90vh] overflow-y-auto">
                <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                    <svg class="w-6 h-6 text-treatment-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                    æ¶ˆè€—è©³æƒ…
                </h3>

                <template x-if="selectedConsumeEvent">
                    <div class="space-y-3">
                        <div class="grid grid-cols-2 gap-4 bg-gray-50 p-4 rounded-lg">
                            <div>
                                <p class="text-sm text-gray-600">æ™‚é–“</p>
                                <p class="font-semibold" x-text="new Date(selectedConsumeEvent.timestamp).toLocaleString('zh-TW')"></p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">ç‰©å“ä»£ç¢¼</p>
                                <p class="font-semibold font-mono" x-text="selectedConsumeEvent.item_code"></p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">ç‰©å“åç¨±</p>
                                <p class="font-semibold" x-text="selectedConsumeEvent.item_name"></p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">æ¶ˆè€—æ•¸é‡</p>
                                <p class="font-semibold text-red-600" x-text="selectedConsumeEvent.quantity + ' ' + selectedConsumeEvent.unit"></p>
                            </div>
                            <div class="col-span-2">
                                <p class="text-sm text-gray-600">ç”¨é€”èªªæ˜</p>
                                <p class="font-semibold" x-text="selectedConsumeEvent.remarks || '-'"></p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">æ“ä½œå“¡</p>
                                <p class="font-semibold" x-text="selectedConsumeEvent.operator"></p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">ç«™é»</p>
                                <p class="font-semibold" x-text="selectedConsumeEvent.station_id"></p>
                            </div>
                        </div>
                    </div>
                </template>

                <div class="pt-4">
                    <button type="button" @click="showConsumeDetailModal = false" class="w-full bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors">
                        é—œé–‰
                    </button>
                </div>
            </div>
        </div>

        <!-- è¡€åº«æ­·å²è¨˜éŒ„ Modal -->
        <div x-show="showBloodHistoryModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-start justify-center z-50 overflow-y-auto py-4" style="display: none;">
            <div @click.away="showBloodHistoryModal = false" class="bg-white rounded-xl shadow-2xl p-3 sm:p-4 md:p-6 max-w-6xl w-full mx-4 my-4 max-h-[95vh] overflow-y-auto">
                <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                    <svg class="w-6 h-6 text-blood-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                    è¡€åº«æ­·å²è¨˜éŒ„
                </h3>

                <!-- ç¯©é¸æ¢ä»¶ -->
                <div class="mb-4 grid grid-cols-1 md:grid-cols-4 gap-3">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">é–‹å§‹æ—¥æœŸ</label>
                        <input type="date" x-model="bloodHistorySearch.startDate" @change="loadBloodHistory()"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blood-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">çµæŸæ—¥æœŸ</label>
                        <input type="date" x-model="bloodHistorySearch.endDate" @change="loadBloodHistory()"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blood-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">è¡€å‹</label>
                        <select x-model="bloodHistorySearch.bloodType" @change="loadBloodHistory()"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blood-500 focus:border-transparent">
                            <option value="">å…¨éƒ¨è¡€å‹</option>
                            <option value="A+">A+</option>
                            <option value="A-">A-</option>
                            <option value="B+">B+</option>
                            <option value="B-">B-</option>
                            <option value="O+">O+</option>
                            <option value="O-">O-</option>
                            <option value="AB+">AB+</option>
                            <option value="AB-">AB-</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">é¡å‹</label>
                        <select x-model="bloodHistorySearch.eventType" @change="loadBloodHistory()"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blood-500 focus:border-transparent">
                            <option value="">å…¨éƒ¨</option>
                            <option value="RECEIVE">å…¥åº«</option>
                            <option value="CONSUME">å‡ºåº«</option>
                        </select>
                    </div>
                </div>

                <!-- æ­·å²è¨˜éŒ„è¡¨æ ¼ -->
                <div class="overflow-x-auto max-h-96">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50 sticky top-0">
                            <tr>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">æ™‚é–“</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">é¡å‹</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">è¡€å‹</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">æ•¸é‡</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">ä¾†æº/ç”¨é€”</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">æ“ä½œå“¡</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            <template x-for="record in bloodHistory" :key="record.id">
                                <tr class="hover:bg-gray-50">
                                    <td class="px-4 py-2 text-sm" x-text="new Date(record.timestamp).toLocaleString('zh-TW')"></td>
                                    <td class="px-4 py-2 text-sm">
                                        <span :class="record.event_type === 'RECEIVE' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'"
                                              class="px-2 py-1 rounded-full text-xs font-medium"
                                              x-text="record.event_type === 'RECEIVE' ? 'å…¥åº«' : 'å‡ºåº«'"></span>
                                    </td>
                                    <td class="px-4 py-2 text-sm font-semibold" x-text="record.blood_type"></td>
                                    <td class="px-4 py-2 text-sm font-bold" x-text="record.quantity + ' U'"></td>
                                    <td class="px-4 py-2 text-sm text-gray-600" x-text="record.remarks || '-'"></td>
                                    <td class="px-4 py-2 text-sm" x-text="record.operator"></td>
                                    <td class="px-4 py-2 text-sm">
                                        <div class="flex gap-2 items-center">
                                            <button @click="printBloodLabelFromHistory(record)"
                                                    class="text-claude-red-500 hover:text-claude-red-600 font-medium flex items-center gap-1"
                                                    title="åˆ—å°æ¨™ç±¤">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"/>
                                                </svg>
                                                <span>åˆ—å°</span>
                                            </button>
                                            <button @click="viewBloodDetail(record)" class="text-blood-500 hover:text-blood-600 font-medium">è©³æƒ…</button>
                                        </div>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>

                    <div x-show="!bloodHistory || bloodHistory.length === 0" class="text-center py-8 text-gray-400">
                        ç„¡ç¬¦åˆæ¢ä»¶çš„è¨˜éŒ„
                    </div>
                </div>

                <div class="mt-4 flex justify-between items-center">
                    <button @click="exportBloodHistoryCSV()" class="bg-teal-custom-500 text-white px-4 py-2 rounded-lg hover:bg-teal-custom-600 transition-colors flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                        åŒ¯å‡º CSV
                    </button>
                    <button type="button" @click="showBloodHistoryModal = false" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors">
                        é—œé–‰
                    </button>
                </div>
            </div>
        </div>

        <!-- åº«å­˜ç›¤é»æ ¸å°è¨˜éŒ„ Modal -->
        <div x-show="showInventoryCheckHistoryModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-start justify-center z-50 overflow-y-auto py-4" style="display: none;">
            <div @click.away="showInventoryCheckHistoryModal = false" class="bg-white rounded-xl shadow-2xl p-3 sm:p-4 md:p-6 max-w-6xl w-full mx-4 my-4 max-h-[95vh] overflow-y-auto">
                <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                    <svg class="w-6 h-6 text-cyan-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/>
                    </svg>
                    åº«å­˜ç›¤é»æ ¸å°è¨˜éŒ„
                </h3>

                <!-- çµ±è¨ˆæ‘˜è¦ -->
                <div class="mb-4 grid grid-cols-2 md:grid-cols-4 gap-3">
                    <div class="bg-gray-100 rounded-xl p-4 text-center">
                        <div class="text-2xl font-bold text-gray-800" x-text="inventoryCheckStats.totalChecks || 0"></div>
                        <div class="text-sm text-gray-500">ç¸½ç›¤é»æ¬¡æ•¸</div>
                    </div>
                    <div class="bg-gray-100 rounded-xl p-4 text-center">
                        <div class="text-2xl font-bold text-teal-custom-600" x-text="inventoryCheckStats.totalConfirmed || 0"></div>
                        <div class="text-sm text-gray-500">å·²ç¢ºèªé …ç›®</div>
                    </div>
                    <div class="bg-gray-100 rounded-xl p-4 text-center">
                        <div class="text-2xl font-bold text-[#D96754]" x-text="inventoryCheckStats.totalErrors || 0"></div>
                        <div class="text-sm text-gray-500">éŒ¯èª¤é …ç›®</div>
                    </div>
                    <div class="bg-gray-100 rounded-xl p-4 text-center">
                        <div class="text-2xl font-bold text-teal-custom-600" x-text="inventoryCheckStats.pendingErrors || 0"></div>
                        <div class="text-sm text-gray-500">å¾…è™•ç†</div>
                    </div>
                </div>

                <!-- ç¯©é¸æ¢ä»¶ -->
                <div class="mb-4 grid grid-cols-1 md:grid-cols-3 gap-3">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">é–‹å§‹æ—¥æœŸ</label>
                        <input type="date" x-model="inventoryCheckSearch.startDate" @change="loadInventoryCheckHistory()"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">çµæŸæ—¥æœŸ</label>
                        <input type="date" x-model="inventoryCheckSearch.endDate" @change="loadInventoryCheckHistory()"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ç‹€æ…‹</label>
                        <select x-model="inventoryCheckSearch.status" @change="loadInventoryCheckHistory()"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-transparent">
                            <option value="">å…¨éƒ¨</option>
                            <option value="has_errors">æœ‰éŒ¯èª¤</option>
                            <option value="all_confirmed">å…¨éƒ¨ç¢ºèª</option>
                        </select>
                    </div>
                </div>

                <!-- æ­·å²è¨˜éŒ„è¡¨æ ¼ -->
                <div class="overflow-x-auto max-h-96">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50 sticky top-0">
                            <tr>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">ç›¤é»æ™‚é–“</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">ç›¤é»äººå“¡</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">ç¸½é …ç›®</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">å·²ç¢ºèª</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">éŒ¯èª¤</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">ç‹€æ…‹</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            <template x-for="check in inventoryCheckHistory" :key="check.check_id">
                                <tr class="hover:bg-gray-50">
                                    <td class="px-4 py-2 text-sm" x-text="new Date(check.checked_at).toLocaleString('zh-TW')"></td>
                                    <td class="px-4 py-2 text-sm font-medium" x-text="check.checker_name"></td>
                                    <td class="px-4 py-2 text-sm" x-text="check.total_items"></td>
                                    <td class="px-4 py-2 text-sm text-teal-custom-600 font-medium" x-text="check.confirmed_count"></td>
                                    <td class="px-4 py-2 text-sm text-[#D96754] font-medium" x-text="check.error_count"></td>
                                    <td class="px-4 py-2 text-sm">
                                        <span x-show="check.error_count === 0" class="bg-gray-100 text-teal-custom-600 px-2 py-1 rounded-full text-xs font-medium">
                                            å…¨éƒ¨ç¢ºèª
                                        </span>
                                        <span x-show="check.error_count > 0 && check.errors_pending === 0" class="bg-gray-100 text-teal-custom-600 px-2 py-1 rounded-full text-xs font-medium">
                                            å·²è™•ç†
                                        </span>
                                        <span x-show="check.errors_pending > 0" class="bg-gray-100 text-[#D96754] px-2 py-1 rounded-full text-xs font-medium">
                                            å¾…è™•ç† (<span x-text="check.errors_pending"></span>)
                                        </span>
                                    </td>
                                    <td class="px-4 py-2 text-sm">
                                        <button @click="viewInventoryCheckDetail(check)" class="text-cyan-600 hover:text-cyan-800 font-medium">
                                            è©³æƒ…
                                        </button>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>

                    <div x-show="!inventoryCheckHistory || inventoryCheckHistory.length === 0" class="text-center py-8 text-gray-400">
                        ç„¡ç›¤é»è¨˜éŒ„
                    </div>
                </div>

                <div class="mt-4 flex justify-between items-center">
                    <button @click="exportInventoryCheckCSV()" class="bg-teal-custom-500 text-white px-4 py-2 rounded-lg hover:bg-teal-custom-600 transition-colors flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                        åŒ¯å‡º CSV
                    </button>
                    <button type="button" @click="showInventoryCheckHistoryModal = false" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors">
                        é—œé–‰
                    </button>
                </div>
            </div>
        </div>

        <!-- ç›¤é»éŒ¯èª¤è©³æƒ… Modal -->
        <div x-show="showInventoryCheckDetailModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-start justify-center z-50 overflow-y-auto py-4" style="display: none;">
            <div @click.away="showInventoryCheckDetailModal = false" class="bg-white rounded-xl shadow-2xl p-3 sm:p-4 md:p-6 max-w-2xl w-full mx-4 my-4 max-h-[95vh] overflow-y-auto">
                <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                    <svg class="w-6 h-6 text-cyan-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                    </svg>
                    ç›¤é»è©³æƒ…
                </h3>

                <!-- ç›¤é»æ‘˜è¦ -->
                <div class="bg-gray-50 rounded-xl p-4 mb-4" x-show="selectedInventoryCheck">
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div>
                            <span class="text-gray-500">ç›¤é»äººå“¡ï¼š</span>
                            <span class="font-medium" x-text="selectedInventoryCheck?.checker_name"></span>
                        </div>
                        <div>
                            <span class="text-gray-500">ç›¤é»æ™‚é–“ï¼š</span>
                            <span class="font-medium" x-text="selectedInventoryCheck ? new Date(selectedInventoryCheck.checked_at).toLocaleString('zh-TW') : ''"></span>
                        </div>
                        <div>
                            <span class="text-gray-500">ç¢ºèªé …ç›®ï¼š</span>
                            <span class="font-medium text-teal-custom-600" x-text="selectedInventoryCheck?.confirmed_count"></span>
                        </div>
                        <div>
                            <span class="text-gray-500">éŒ¯èª¤é …ç›®ï¼š</span>
                            <span class="font-medium text-[#D96754]" x-text="selectedInventoryCheck?.error_count"></span>
                        </div>
                    </div>
                </div>

                <!-- éŒ¯èª¤é …ç›®åˆ—è¡¨ -->
                <div x-show="selectedInventoryCheck?.errors?.length > 0">
                    <h4 class="font-semibold text-[#D96754] mb-3 flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                        </svg>
                        éŒ¯èª¤é …ç›®
                    </h4>
                    <div class="space-y-3">
                        <template x-for="error in selectedInventoryCheck?.errors || []" :key="error.item_code">
                            <div class="bg-gray-100 border border-gray-200 rounded-lg p-3">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <div class="font-medium text-[#D96754]" x-text="error.item_name || error.item_code"></div>
                                        <div class="text-xs text-gray-500" x-text="error.item_code"></div>
                                        <div class="text-sm text-gray-600 mt-1" x-text="error.notes"></div>
                                    </div>
                                    <div x-show="!error.resolved">
                                        <button @click="resolveInventoryError(selectedInventoryCheck.check_id, error.item_code)"
                                                class="bg-cyan-600 text-white px-3 py-1 rounded-lg text-sm hover:bg-cyan-700">
                                            è™•ç†
                                        </button>
                                    </div>
                                    <div x-show="error.resolved" class="text-green-600 text-sm font-medium">
                                        âœ“ å·²è™•ç†
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>

                <div x-show="!selectedInventoryCheck?.errors?.length" class="text-center py-4 text-gray-400">
                    æ­¤æ¬¡ç›¤é»ç„¡éŒ¯èª¤é …ç›®
                </div>

                <div class="mt-4 flex justify-end">
                    <button type="button" @click="showInventoryCheckDetailModal = false" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors">
                        é—œé–‰
                    </button>
                </div>
            </div>
        </div>

        <!-- Toast é€šçŸ¥ -->
        <div x-show="showToast" x-transition class="fixed bottom-4 right-4 z-50" style="display: none;">
            <div :class="{
                'bg-teal-custom-500': toastType === 'success',
                'bg-red-500': toastType === 'error',
                'bg-blue-500': toastType === 'info'
            }" class="text-white px-6 py-3 rounded-lg shadow-lg">
                <p x-text="toastMessage"></p>
            </div>
        </div>

        <!-- ç·Šæ€¥åŠŸèƒ½æŒ‰éˆ• -->
        <div class="fixed bottom-24 right-4 z-40">
            <button @click="showEmergencyModal = true"
                    class="bg-red-600 hover:bg-red-700 text-white p-4 rounded-full shadow-2xl transition-all duration-300 transform hover:scale-110">
                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                </svg>
            </button>
        </div>

        <!-- ç·Šæ€¥åŠŸèƒ½é¸å–® Modal -->
        <div x-show="showEmergencyModal" class="fixed inset-0 bg-black bg-opacity-60 flex items-start justify-center z-50 overflow-y-auto py-4" style="display: none;">
            <div @click.away="showEmergencyModal = false" class="bg-white rounded-2xl shadow-2xl p-6 max-w-md w-full mx-4 my-4 max-h-[90vh] overflow-y-auto">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-2xl font-bold text-red-600 flex items-center gap-2">
                        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                        </svg>
                        ç·Šæ€¥åŠŸèƒ½
                    </h3>
                    <button @click="showEmergencyModal = false" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>

                <p class="text-sm text-gray-600 mb-6">
                    æˆ°æ™‚ç·Šæ€¥æ’¤é›¢ä½¿ç”¨ - å¿«é€Ÿä¿å…¨æ‰€æœ‰è³‡æ–™
                </p>

                <div class="space-y-3">
                    <!-- é¸é …1: æ’¤é›¢ - ä¸‹è¼‰æ‰€æœ‰è³‡æ–™ -->
                    <button @click="emergencyDownloadAll()"
                            class="w-full bg-red-600 hover:bg-red-700 text-white p-4 rounded-xl transition-all duration-200 flex items-center gap-3 shadow-lg">
                        <svg class="w-6 h-6 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                        <div class="text-left flex-1">
                            <p class="font-bold">æ’¤é›¢ - ä¸‹è¼‰æ‰€æœ‰è³‡æ–™</p>
                            <p class="text-xs text-red-100">å®Œæ•´å‚™ä»½åŒ…ï¼ˆZIPæª”æ¡ˆï¼‰</p>
                        </div>
                    </button>

                    <!-- é¸é …2: å¿«é€Ÿå‚™ä»½è³‡æ–™åº« -->
                    <button @click="emergencyQuickBackup()"
                            class="w-full bg-orange-600 hover:bg-orange-700 text-white p-4 rounded-xl transition-all duration-200 flex items-center gap-3 shadow-lg">
                        <svg class="w-6 h-6 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4"/>
                        </svg>
                        <div class="text-left flex-1">
                            <p class="font-bold">å¿«é€Ÿå‚™ä»½è³‡æ–™åº«</p>
                            <p class="text-xs text-orange-100">åƒ…ä¸‹è¼‰ .db æª”æ¡ˆï¼ˆæœ€å¿«ï¼‰</p>
                        </div>
                    </button>

                    <!-- é¸é …3: å–æ¶ˆ -->
                    <button @click="showEmergencyModal = false"
                            class="w-full bg-gray-200 hover:bg-gray-300 text-gray-700 p-4 rounded-xl transition-all duration-200 flex items-center justify-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                        <span class="font-medium">å–æ¶ˆ</span>
                    </button>
                </div>

                <div class="mt-6 p-3 bg-red-50 rounded-lg border border-red-200">
                    <p class="text-xs text-red-700 flex items-start gap-2">
                        <svg class="w-4 h-4 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        <span><strong>æç¤ºï¼š</strong>å»ºè­°ä½¿ç”¨ã€Œæ’¤é›¢ã€åŠŸèƒ½ä¸‹è¼‰å®Œæ•´å‚™ä»½åŒ…ï¼ŒåŒ…å«æ‰€æœ‰è³‡æ–™å’Œèªªæ˜æ–‡ä»¶ã€‚</span>
                    </p>
                </div>
            </div>
        </div>

        <!-- ç·Šæ€¥é ˜ç”¨åŸå›  Modal (MIRS v2.3) -->
        <div x-show="showEmergencyReasonModal" class="fixed inset-0 bg-black bg-opacity-60 flex items-start justify-center z-50 overflow-y-auto py-4" style="display: none;">
            <div @click.away="showEmergencyReasonModal = false" class="bg-white rounded-xl shadow-2xl p-6 max-w-lg w-full mx-4 my-4 max-h-[90vh] overflow-y-auto">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-bold text-dispense-purple-900 flex items-center gap-2">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                        </svg>
                        ç·Šæ€¥é ˜ç”¨ (Break-the-Glass)
                    </h3>
                    <button @click="showEmergencyReasonModal = false" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>

                <div class="mb-4 p-4 bg-yellow-50 border-l-4 border-yellow-400 rounded">
                    <div class="flex items-start gap-2">
                        <svg class="w-5 h-5 text-yellow-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        <div class="text-sm text-yellow-800">
                            <p class="font-semibold mb-1">é‡è¦æé†’</p>
                            <ul class="list-disc list-inside space-y-1 text-xs">
                                <li>ç·Šæ€¥é ˜ç”¨æœƒç«‹å³æ‰£é™¤åº«å­˜</li>
                                <li>ä¸éœ€è¦è—¥å¸« PIN ç¢¼</li>
                                <li>å¿…é ˆå¡«å¯«ç·Šæ€¥åŸå›  (è‡³å°‘5å€‹å­—)</li>
                                <li>è—¥å¸«ç¨å¾Œæœƒç¢ºèªæ­¤ç­†é ˜ç”¨</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <form @submit.prevent="batchDispenseForm.isEmergency = true; submitBatchDispense()" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <span class="text-red-500">*</span> ç·Šæ€¥åŸå›  (5-200å­—)
                        </label>
                        <textarea x-model="batchDispenseForm.emergencyReason"
                                  required
                                  minlength="5"
                                  maxlength="200"
                                  rows="4"
                                  placeholder="ä¾‹å¦‚ï¼šå¤§é‡å‚·æ‚£æ¹§å…¥ï¼Œéœ€è¦ç·Šæ€¥ç‰©è³‡ï¼Œè—¥å¸«ä¸åœ¨ç¾å ´..."
                                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-dispense-purple-700 resize-none"></textarea>
                        <p class="text-xs text-gray-500 mt-1" x-text="`å·²è¼¸å…¥ ${batchDispenseForm.emergencyReason.length} å­— (æœ€å°‘5å­—ï¼Œæœ€å¤š200å­—)`"></p>
                    </div>

                    <div class="flex gap-3">
                        <button type="submit" class="flex-1 bg-dispense-purple-700 text-white px-6 py-3 rounded-lg hover:bg-dispense-purple-900 transition-colors flex items-center justify-center gap-2 font-semibold">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                            </svg>
                            <span>ç¢ºèªç·Šæ€¥é ˜ç”¨</span>
                        </button>
                        <button type="button" @click="showEmergencyReasonModal = false" class="flex-1 bg-gray-500 text-white px-6 py-3 rounded-lg hover:bg-gray-600 transition-colors flex items-center justify-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                            <span>å–æ¶ˆ</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- è—¥å¸«å¯©æ ¸ Modal (MIRS v2.3) -->
        <div x-show="showPharmacistApprovalModal" class="fixed inset-0 bg-black bg-opacity-60 flex items-start justify-center z-50 overflow-y-auto py-4" style="display: none;">
            <div @click.away="showPharmacistApprovalModal = false" class="bg-white rounded-xl shadow-2xl p-6 max-w-lg w-full mx-4 my-4 max-h-[90vh] overflow-y-auto">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-bold text-dispense-purple-900 flex items-center gap-2">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
                        </svg>
                        è—¥å¸«å¯©æ ¸ç¢ºèª
                    </h3>
                    <button @click="showPharmacistApprovalModal = false" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>

                <!-- é ˜ç”¨è¨˜éŒ„è©³æƒ… -->
                <template x-if="selectedDispenseForApproval">
                    <div class="mb-4 p-4 bg-gray-50 rounded-lg border border-gray-200">
                        <h4 class="font-semibold text-gray-700 mb-2">é ˜ç”¨è¨˜éŒ„è©³æƒ…</h4>
                        <div class="space-y-1 text-sm">
                            <p><span class="text-gray-600">è—¥å“:</span> <span class="font-semibold" x-text="`${selectedDispenseForApproval.medicine_code} - ${selectedDispenseForApproval.medicine_name}`"></span></p>
                            <p><span class="text-gray-600">æ•¸é‡:</span> <span class="font-semibold" x-text="selectedDispenseForApproval.quantity"></span> <span x-text="selectedDispenseForApproval.unit"></span></p>
                            <p><span class="text-gray-600">é ˜è—¥äºº:</span> <span class="font-semibold" x-text="selectedDispenseForApproval.dispensed_by"></span></p>
                            <p x-show="selectedDispenseForApproval.patient_name"><span class="text-gray-600">ç—…æ‚£:</span> <span x-text="selectedDispenseForApproval.patient_name"></span></p>
                            <p x-show="selectedDispenseForApproval.emergency_reason" class="text-claude-red-600 font-medium pt-2">
                                <span class="text-gray-600">ç·Šæ€¥åŸå› :</span> <span x-text="selectedDispenseForApproval.emergency_reason"></span>
                            </p>
                        </div>
                    </div>
                </template>

                <form @submit.prevent="submitPharmacistApproval()" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <span class="text-red-500">*</span> è—¥å¸«å§“å
                        </label>
                        <input type="text"
                               x-model="pharmacistApprovalForm.approvedBy"
                               required
                               placeholder="è—¥å¸«-æ—å¤§è¯"
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-dispense-purple-700">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <span class="text-red-500">*</span> PIN ç¢¼ (è—¥å¸«å¯†ç¢¼)
                        </label>
                        <input type="password"
                               x-model="pharmacistApprovalForm.pinCode"
                               required
                               placeholder="è«‹è¼¸å…¥4ä½æ•¸PINç¢¼"
                               maxlength="4"
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-dispense-purple-700">
                        <p class="text-xs text-gray-500 mt-1">é è¨­PINç¢¼: 1234 (ç”Ÿç”¢ç’°å¢ƒè«‹æ›´æ”¹)</p>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            è—¥å¸«å‚™è¨» (é¸å¡«)
                        </label>
                        <textarea x-model="pharmacistApprovalForm.pharmacistNotes"
                                  rows="3"
                                  placeholder="ç¢ºèªç„¡èª¤ï¼Œå·²æ ¸å°ç—…æ‚£ç”¨è—¥è¨˜éŒ„..."
                                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-dispense-purple-700 resize-none"></textarea>
                    </div>

                    <div class="flex gap-3">
                        <button type="submit" class="flex-1 bg-dispense-purple-700 text-white px-6 py-3 rounded-lg hover:bg-dispense-purple-900 transition-colors flex items-center justify-center gap-2 font-semibold">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                            </svg>
                            <span>ç¢ºèªå¯©æ ¸</span>
                        </button>
                        <button type="button" @click="showPharmacistApprovalModal = false" class="flex-1 bg-gray-500 text-white px-6 py-3 rounded-lg hover:bg-gray-600 transition-colors flex items-center justify-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                            <span>å–æ¶ˆ</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- è¡€è¢‹é¸æ“‡å‡ºåº« Modal (v1.4.2-plus) -->
        <div x-show="showBloodBagSelectModal" class="fixed inset-0 bg-black bg-opacity-60 flex items-start justify-center z-50 overflow-y-auto py-4" style="display: none;">
            <div @click.away="showBloodBagSelectModal = false" class="bg-white rounded-xl shadow-2xl p-6 max-w-2xl w-full mx-4 my-4 max-h-[95vh] overflow-y-auto">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-bold text-red-700 flex items-center gap-2">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
                        </svg>
                        é¸æ“‡å‡ºåº«è¡€è¢‹
                    </h3>
                    <button @click="showBloodBagSelectModal = false" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>

                <!-- ç—…æ‚£è³‡è¨Šæ‘˜è¦ -->
                <div class="mb-4 p-3 bg-red-50 rounded-lg border border-red-200">
                    <div class="flex items-center gap-4 text-sm">
                        <span class="font-semibold text-red-700">è¡€å‹: <span x-text="bloodConsumeForm.bloodType" class="text-lg"></span></span>
                        <span class="text-gray-600">ç—…æ‚£: <span x-text="bloodConsumeForm.patientName || '-'" class="font-medium"></span></span>
                        <span class="text-gray-600">éœ€æ±‚: <span x-text="bloodConsumeForm.quantity" class="font-medium"></span> U</span>
                    </div>
                </div>

                <!-- å¯ç”¨è¡€è¢‹åˆ—è¡¨ -->
                <div class="mb-4">
                    <div class="flex items-center justify-between mb-2">
                        <h4 class="font-semibold text-gray-700">å¯ç”¨è¡€è¢‹ (<span x-text="availableBagsForConsume.length"></span> è¢‹)</h4>
                        <span class="text-sm text-gray-500">å·²é¸: <span x-text="selectedBagsForConsume.length" class="font-bold text-red-600"></span> è¢‹</span>
                    </div>

                    <div class="max-h-64 overflow-y-auto border border-gray-200 rounded-lg">
                        <template x-if="availableBagsForConsume.length === 0">
                            <div class="p-4 text-center text-gray-500">
                                <svg class="w-12 h-12 mx-auto mb-2 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"/>
                                </svg>
                                æ­¤è¡€å‹ç›®å‰ç„¡å¯ç”¨è¡€è¢‹
                            </div>
                        </template>
                        <template x-for="bag in availableBagsForConsume" :key="bag.bag_code">
                            <label class="flex items-center p-3 hover:bg-gray-50 cursor-pointer border-b border-gray-100 last:border-b-0"
                                   :class="{
                                       'bg-red-100': isExpired(bag.expiry_date),
                                       'bg-amber-50': isExpiringSoon(bag.expiry_date) && !isExpired(bag.expiry_date)
                                   }">
                                <input type="checkbox"
                                       :value="bag.bag_code"
                                       x-model="selectedBagsForConsume"
                                       class="rounded text-red-600 focus:ring-red-500 mr-3">
                                <div class="flex-1">
                                    <div class="flex items-center gap-2">
                                        <span class="font-mono text-sm font-medium" x-text="bag.bag_code"></span>
                                        <span class="px-1.5 py-0.5 text-xs font-bold rounded bg-red-600 text-white" x-text="bag.blood_type"></span>
                                        <span class="text-xs text-gray-500" x-text="bag.volume_ml + ' ml'"></span>
                                    </div>
                                    <div class="flex items-center gap-3 mt-1 text-xs">
                                        <span class="text-gray-500">æ•ˆæœŸ:</span>
                                        <span :class="{
                                            'text-red-600 font-bold': isExpired(bag.expiry_date),
                                            'text-amber-600 font-semibold': isExpiringSoon(bag.expiry_date) && !isExpired(bag.expiry_date),
                                            'text-gray-600': !isExpiringSoon(bag.expiry_date) && !isExpired(bag.expiry_date)
                                        }">
                                            <span x-text="bag.expiry_date"></span>
                                            <template x-if="isExpired(bag.expiry_date)">
                                                <span class="ml-1 text-red-600">(å·²éæœŸ!)</span>
                                            </template>
                                            <template x-if="isExpiringSoon(bag.expiry_date) && !isExpired(bag.expiry_date)">
                                                <span class="ml-1 text-amber-600">(å³å°‡éæœŸ)</span>
                                            </template>
                                        </span>
                                        <template x-if="bag.donor_info">
                                            <span class="text-blue-600" x-text="bag.donor_info"></span>
                                        </template>
                                    </div>
                                </div>
                            </label>
                        </template>
                    </div>
                </div>

                <!-- æ“ä½œæŒ‰éˆ• -->
                <div class="flex gap-3">
                    <button @click="confirmBloodBagConsume()"
                            :disabled="selectedBagsForConsume.length === 0"
                            :class="selectedBagsForConsume.length === 0 ? 'bg-gray-300 cursor-not-allowed' : 'bg-claude-red-500 hover:bg-claude-red-600'"
                            class="flex-1 text-white px-6 py-3 rounded-lg transition-colors flex items-center justify-center gap-2 font-semibold">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                        </svg>
                        <span>ç¢ºèªå‡ºåº« (<span x-text="selectedBagsForConsume.length"></span> è¢‹)</span>
                    </button>
                    <button @click="showBloodBagSelectModal = false" class="flex-1 bg-gray-500 text-white px-6 py-3 rounded-lg hover:bg-gray-600 transition-colors flex items-center justify-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                        <span>å–æ¶ˆ</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="mt-12 pt-8 border-t border-gray-200">
            <div class="flex flex-col items-center justify-center gap-4">
                <!-- iRehab Logo -->
                <div class="flex items-center justify-center">
                    <img src="/static/iRehab_logo.png" alt="iRehab Logo" class="h-12 w-auto object-contain opacity-80 hover:opacity-100 transition-opacity">
                </div>

                <!-- Upgrade to Multi-Station Button -->
                <div class="flex items-center justify-center">
                    <button @click="showUpgradeModal = true"
                            class="group flex items-center gap-2 px-4 py-2 bg-gradient-to-r from-purple-500 to-indigo-600 text-white text-sm font-medium rounded-lg hover:from-purple-600 hover:to-indigo-700 transition-all duration-200 shadow-md hover:shadow-lg">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                        </svg>
                        <span>å‡ç´šè‡³å¤šç«™ç‰ˆ</span>
                        <svg class="w-4 h-4 group-hover:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                        </svg>
                    </button>
                </div>

                <!-- Footer Text -->
                <div class="text-center text-xs text-gray-400 space-y-1">
                    <p>é†«ç™‚ç«™åº«å­˜ç®¡ç†ç³»çµ± v2.9.2</p>
                    <p class="flex items-center justify-center gap-2">
                        <span>Powered by</span>
                        <a href="https://denovortho-site.vercel.app/zh-TW/resilience" target="_blank"
                           class="font-semibold text-gray-500 hover:text-teal-600 transition-colors">
                            De Novo Orthopedics Inc
                        </a>
                    </p>
                </div>
            </div>
        </footer>

        <!-- Upgrade Modal -->
        <div x-show="showUpgradeModal" class="fixed inset-0 bg-black bg-opacity-60 flex items-start justify-center z-50 overflow-y-auto py-4" style="display: none;">
            <div @click.away="showUpgradeModal = false" class="bg-white rounded-2xl shadow-2xl p-6 max-w-lg w-full mx-4 my-4 max-h-[90vh] overflow-y-auto">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-2xl font-bold text-gray-800 flex items-center gap-3">
                        <div class="w-10 h-10 bg-gradient-to-br from-purple-500 to-indigo-600 rounded-xl flex items-center justify-center">
                            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                            </svg>
                        </div>
                        å‡ç´šè‡³å¤šç«™ç‰ˆ
                    </h3>
                    <button @click="showUpgradeModal = false" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>

                <!-- Feature Comparison -->
                <div class="mb-6">
                    <h4 class="font-semibold text-gray-700 mb-3">å¤šç«™ç‰ˆåŠŸèƒ½</h4>
                    <div class="space-y-2">
                        <div class="flex items-center gap-2 text-sm">
                            <svg class="w-5 h-5 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                            </svg>
                            <span>å¤šç«™é»è³‡æ–™åŒæ­¥èˆ‡ç®¡ç†</span>
                        </div>
                        <div class="flex items-center gap-2 text-sm">
                            <svg class="w-5 h-5 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                            </svg>
                            <span>ä¸­å¤®åº«å­˜ç›£æ§å„€è¡¨æ¿</span>
                        </div>
                        <div class="flex items-center gap-2 text-sm">
                            <svg class="w-5 h-5 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                            </svg>
                            <span>è·¨ç«™é»ç‰©è³‡èª¿æ’¥</span>
                        </div>
                        <div class="flex items-center gap-2 text-sm">
                            <svg class="w-5 h-5 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                            </svg>
                            <span>é€²éšå ±è¡¨èˆ‡åˆ†æ</span>
                        </div>
                    </div>
                </div>

                <!-- Upgrade Steps -->
                <div class="mb-6 p-4 bg-gray-50 rounded-xl">
                    <h4 class="font-semibold text-gray-700 mb-3">å‡ç´šæ­¥é©Ÿ</h4>
                    <ol class="space-y-3 text-sm">
                        <li class="flex items-start gap-3">
                            <span class="flex-shrink-0 w-6 h-6 bg-purple-100 text-purple-600 rounded-full flex items-center justify-center font-semibold text-xs">1</span>
                            <span>é»æ“Šä¸‹æ–¹ã€ŒåŒ¯å‡ºè³‡æ–™ã€ä¸‹è¼‰ç›®å‰æ‰€æœ‰è³‡æ–™</span>
                        </li>
                        <li class="flex items-start gap-3">
                            <span class="flex-shrink-0 w-6 h-6 bg-purple-100 text-purple-600 rounded-full flex items-center justify-center font-semibold text-xs">2</span>
                            <span>è¯ç¹«æˆ‘å€‘å–å¾—å¤šç«™ç‰ˆæˆæ¬Šç¢¼</span>
                        </li>
                        <li class="flex items-start gap-3">
                            <span class="flex-shrink-0 w-6 h-6 bg-purple-100 text-purple-600 rounded-full flex items-center justify-center font-semibold text-xs">3</span>
                            <span>åœ¨å¤šç«™ç‰ˆç³»çµ±åŒ¯å…¥è³‡æ–™ä¸¦è¼¸å…¥æˆæ¬Šç¢¼</span>
                        </li>
                    </ol>
                </div>

                <!-- Action Buttons -->
                <div class="space-y-3">
                    <button @click="exportUpgradeData()"
                            class="w-full bg-gradient-to-r from-purple-500 to-indigo-600 text-white px-6 py-3 rounded-xl hover:from-purple-600 hover:to-indigo-700 transition-all duration-200 flex items-center justify-center gap-2 font-semibold shadow-md">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                        åŒ¯å‡ºè³‡æ–™ (ZIP)
                    </button>

                    <a href="mailto:tom@denovortho.com?subject=MIRS%20å¤šç«™ç‰ˆå‡ç´šç”³è«‹&body=ç«™é»IDï¼š%0Aç›®å‰ç‰ˆæœ¬ï¼šv1.4.2-plus%0A%0Aè«‹æä¾›å¤šç«™ç‰ˆæˆæ¬Šç¢¼"
                       class="w-full bg-gray-100 text-gray-700 px-6 py-3 rounded-xl hover:bg-gray-200 transition-colors flex items-center justify-center gap-2 font-medium">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                        </svg>
                        è¯ç¹«å–å¾—æˆæ¬Šç¢¼
                    </a>

                    <button @click="showUpgradeModal = false"
                            class="w-full text-gray-500 px-6 py-2 rounded-xl hover:text-gray-700 transition-colors text-sm">
                        ç¨å¾Œå†èªª
                    </button>
                </div>
            </div>
        </div>

    </div>

    <script>
        function medicalInventory() {
            // v1.4.2-plus: å‹•æ…‹åµæ¸¬ API URL (æ”¯æ´é ç«¯å­˜å–)
            const currentHost = window.location.hostname;
            const currentPort = window.location.port;
            // v2.5.2: çµ±ä¸€ä½¿ç”¨ç›¸å°è·¯å¾‘ï¼Œå› ç‚ºå‰ç«¯ç”±åŒä¸€å€‹ uvicorn ä¼ºæœå™¨æä¾›
            // é€™æ¨£ç„¡è«– port æ˜¯ 8000 é‚„æ˜¯ 8090 éƒ½èƒ½æ­£å¸¸é‹ä½œ
            const apiBaseUrl = '/api';

            return {
                // åŸºæœ¬è¨­å®š
                apiUrl: apiBaseUrl,
                detectedServerUrl: null,  // v2.5: å¾å¾Œç«¯åµæ¸¬çš„ä¼ºæœå™¨ URL
                stationId: localStorage.getItem('stationId') || 'HC-000000',
                stationName: localStorage.getItem('stationName') || 'å‰ç·šé†«ç™‚ç«™',
                stationType: localStorage.getItem('stationType') || '',
                showCustomStationInput: false,
                customStationType: 'TC',
                customStationNumber: '',
                currentTab: 'items',
                treatmentMode: 'surgery', // è™•ç½®æ¨™ç±¤é æ¨¡å¼: 'surgery' æˆ– 'consume'
                currentTime: '',
                demoMode: false,  // Vercel demo mode flag

                // v1.1: CIRS å¾…è™•ç½®æ¸…å–®
                // v1.2: åŠ å…¥ lastSynced é¡¯ç¤ºæœ€å¾ŒåŒæ­¥æ™‚é–“
                cirsProcedureStatus: { online: false, lastSynced: null },
                cirsProcedurePatients: [],
                
                // è³‡æ–™
                items: [],
                filteredItems: [],
                bloodInventory: [],
                equipment: [],
                surgeryRecords: [],
                receiveHistory: [],
                consumeHistory: [],
                stats: {
                    totalItems: 0,
                    lowStockItems: 0,
                    totalBlood: 0,
                    equipmentAlerts: 0
                },

                // éŸŒæ€§ä¼°ç®—
                resilienceStatus: {
                    lifelines: [],
                    reagents: [],
                    summary: null,
                    context: {}
                },
                resilienceConfig: {
                    isolation_target_days: 5,
                    population_count: 2,
                    population_label: 'æ’ç®¡æ‚£è€…æ•¸'
                },
                expandedLifeline: null,  // v1.2.6: å±•é–‹çš„ç”Ÿå‘½ç·šé …ç›®
                lifelinesRefreshKey: 0,  // v1.4.6: å¼·åˆ¶é‡æ–°æ¸²æŸ“ key
                equipmentRefreshKey: 0,  // v1.4.7: è¨­å‚™åˆ—è¡¨å¼·åˆ¶é‡æ–°æ¸²æŸ“ key
                showUnitEditModal: false,  // v1.2.7: å–®ä½ç·¨è¼¯ Modal
                unitEditForm: {
                    equipment_id: '',
                    unit_label: '',
                    label: '',
                    level: 100,
                    status: 'AVAILABLE',
                    checked: false  // v1.2.8: æ˜¯å¦å·²æª¢æŸ¥
                },
                // v1.4.7: é›»åŠ›è¨­å‚™å–®ä½ç·¨è¼¯ Modal
                showPowerUnitEditModal: false,
                powerUnitEditForm: {
                    equipment_id: '',
                    unit_label: '',
                    label: '',
                    level: 100,
                    status: 'AVAILABLE',
                    device_type: 'POWER_STATION',
                    unit: 'Wh'
                },
                // v1.2.8: æª¢æŸ¥å ±è¡¨
                showCheckReportModal: false,
                checkReportDate: new Date().toISOString().split('T')[0],
                checkReportData: null,

                // Mobile é…å°
                showMobilePairing: false,
                pairingInfo: null,
                pairingQRUrl: '',
                pairingExpiry: null,
                pairingLoading: false,
                pairingError: null,
                pairingConfig: {
                    role: 'nurse',
                    scopes: {
                        equipment: true,
                        inventory: true,
                        bloodReceive: false,
                        supplyReceive: false
                    }
                },
                // é…å°è¨˜éŒ„
                showPairedDevices: false,
                pairedDevices: [],
                pairedDevicesLoading: false,

                // v2.9: CIRS Hub é€£ç·šç‹€æ…‹ (Phase 9)
                hubStatus: {
                    connected: false,
                    checking: false,
                    lastCheck: null,
                    hubUrl: null,
                    error: null
                },
                snapshotStatus: {
                    hasSnapshot: false,
                    version: null,
                    expiresAt: null,
                    isExpired: false,
                    userCount: 0,
                    syncing: false
                },
                showHubSettingsModal: false,

                // æœå°‹èˆ‡ç¯©é¸
                itemSearchText: '',
                itemCategoryFilter: '',  // åˆ†é¡ç¯©é¸ (ç©ºå­—ä¸²=å…¨éƒ¨, 'medicine'=è—¥å“, 'consumable'=è€—æ)
                receiveItemSearch: '',
                filteredReceiveItems: [],
                showReceiveDropdown: false,

                // Modal ç‹€æ…‹
                showAddItemModal: false,
                showEditItemModal: false,
                showAddEquipmentModal: false,
                showEditEquipmentModal: false,
                showCheckEquipmentModal: false,
                showAddSurgeryModal: false,
                showSurgeryDetailModal: false,
                showReceiveHistoryModal: false,
                showConsumeHistoryModal: false,
                showConsumeDetailModal: false,
                showBloodHistoryModal: false,
                showEmergencyReasonModal: false,
                showPharmacistApprovalModal: false,
                showBloodBagSelectModal: false,  // v1.4.2-plus: è¡€è¢‹é¸æ“‡å‡ºåº«
                showInventoryCheckHistoryModal: false,  // v0.7: åº«å­˜ç›¤é»æ ¸å°è¨˜éŒ„
                showInventoryCheckDetailModal: false,   // v0.7: ç›¤é»è©³æƒ…
                showUpgradeModal: false,  // å‡ç´šè‡³å¤šç«™ç‰ˆ
                showUnitManageModal: false,  // v2.1: è¨­å‚™å–®ä½ç®¡ç†

                // v2.1: è¨­å‚™å–®ä½ç®¡ç†è¡¨å–®
                unitManageForm: {
                    equipment_id: '',
                    equipment_name: '',
                    type_code: '',
                    unit_prefix: '',
                    units: [],
                    inactive_units: [],
                    loading: false,
                    showInactive: false,
                    addForm: {
                        level_percent: 100,
                        status: 'AVAILABLE',
                        reason: ''
                    },
                    removeReason: '',
                    targetQuantity: null
                },

                // è¡€è¢‹é¸æ“‡å‡ºåº« (v1.4.2-plus)
                availableBagsForConsume: [],  // è©²è¡€å‹å¯ç”¨çš„è¡€è¢‹åˆ—è¡¨
                selectedBagsForConsume: [],   // é¸ä¸­è¦å‡ºåº«çš„è¡€è¢‹

                // è¡€åº«æ­·å²è¨˜éŒ„
                bloodHistory: [],
                bloodHistorySearch: {
                    startDate: '',
                    endDate: '',
                    bloodType: '',
                    eventType: ''
                },
                selectedBloodRecord: null,

                // åº«å­˜ç›¤é»æ ¸å°è¨˜éŒ„ (v0.7)
                inventoryCheckHistory: [],
                inventoryCheckStats: {
                    totalChecks: 0,
                    totalConfirmed: 0,
                    totalErrors: 0,
                    pendingErrors: 0
                },
                lastKnownCheckCount: 0, // ç”¨æ–¼åµæ¸¬æ–°åŒæ­¥è¨˜éŒ„
                inventoryCheckSearch: {
                    startDate: '',
                    endDate: '',
                    status: ''
                },
                selectedInventoryCheck: null,

                // å€‹åˆ¥è¡€è¢‹è¿½è¹¤ (v1.4.2-plus)
                bloodBags: [],
                selectedBagCodes: [],
                bloodBagForm: {
                    blood_type: '',
                    volume_ml: 250,
                    collection_date: '',
                    expiry_date: '',
                    donor_info: ''
                },

                // è—¥å“é ˜ç”¨è¨˜éŒ„ (MIRS v2.3)
                pendingDispenses: [],
                dispenseHistory: [],
                selectedDispenseForApproval: null,

                // è—¥å±€æ’¥ç™¼ (MIRS v2.4 - Pharmacy Dispatch)
                showDispatchModal: false,
                showDispatchQRModal: false,
                dispatchList: [],
                dispatchForm: {
                    target_station_id: '',
                    target_station_name: '',
                    items: [{ code: '', name: '', quantity: 1, searchText: '', filteredItems: [], showDropdown: false }]
                },
                dispatchQRData: {
                    dispatch_id: '',
                    qr_codes: [],
                    current_index: 0
                },

                // è¡¨å–®
                receiveForm: {
                    itemCode: '',
                    quantity: 1,
                    batchNumber: '',
                    expiryDate: '',
                    remarks: '',
                    stationId: 'HC-000000'
                },
                // v3.0: consumeForm å’Œ batchConsumeForm å·²ç§»é™¤ (é·ç§»è‡³ Nursing PWA)
                bloodReceiveForm: {
                    bloodType: '',
                    quantity: 1,
                    remarks: '',
                    source: 'blood_center',  // æ–°å¢ï¼šè¡€æ¶²ä¾†æº
                    donorName: '',           // æ–°å¢ï¼šæè¡€è€…å§“å
                    donorPhone: '',          // æ–°å¢ï¼šæè¡€è€…é›»è©±
                    stationId: 'HC-000000'
                },
                bloodConsumeForm: {
                    bloodType: '',
                    quantity: 1,
                    patientName: '',
                    patientId: '',
                    purpose: '',
                    stationId: 'HC-000000'
                },
                bloodTransferForm: {
                    sourceStationId: 'HC-000000',
                    targetStationId: '',
                    bloodType: '',
                    quantity: 1,
                    operator: 'SYSTEM',
                    remarks: ''
                },
                addItemForm: {
                    code: '',
                    name: '',
                    unit: 'EA',
                    minStock: 10,
                    category: 'å…¶ä»–'
                },
                editItemForm: {
                    code: '',
                    name: '',
                    unit: '',
                    minStock: 0,
                    category: ''
                },
                addEquipmentForm: {
                    name: '',
                    category: 'å…¶ä»–',
                    quantity: 1,
                    remarks: '',
                    stationId: localStorage.getItem('stationId') || 'HC-000000'
                },
                editEquipmentForm: {
                    id: '',
                    name: '',
                    category: '',
                    quantity: 1,
                    remarks: ''
                },
                checkEquipmentForm: {
                    id: '',
                    name: '',
                    status: 'NORMAL',
                    powerLevel: null,
                    remarks: '',
                    stationId: 'HC-000000',
                    // v2: unit-centric fields
                    units: [],           // è¨­å‚™çš„æ‰€æœ‰å–®ä½
                    selectedUnitId: null, // é¸ä¸­çš„å–®ä½ ID
                    statusOptions: []     // è©²è¨­å‚™é¡å‹çš„ç‹€æ…‹é¸é …
                },
                addSurgeryForm: {
                    patientName: '',
                    triageTagId: '',
                    surgeryType: '',
                    surgeonName: '',
                    anesthesiaType: '',
                    durationMinutes: null,
                    remarks: '',
                    consumptions: [],
                    intraopMeds: [],  // è¡“ä¸­ç”¨è—¥
                    stationId: 'HC-000000',
                    // v1.1: CIRS æ•´åˆ
                    cirsRegistrationRef: null,
                    cirsPersonId: null,
                    // v2.7.4: è¡“å¼èˆ‡è‡ªè²» Queue
                    surgeryQueue: [],      // [{code, name_zh, points, category_code, reduction_rate, final_points}]
                    selfPayQueue: [],      // [{item_id, name, unit_price, quantity}]
                    surgerySearchText: '', // è¡“å¼æœå°‹
                    selfPayFormSearchText: '' // è‡ªè²»æœå°‹
                },
                // v2.7.4: è¡¨å–®è¡“å¼æœå°‹çµæœ
                formSurgerySearchResults: [],
                formSelfPaySearchResults: [],
                surgerySearchForm: {
                    startDate: '',
                    endDate: '',
                    patientName: ''
                },
                receiveHistorySearch: {
                    startDate: '',
                    endDate: '',
                    itemCode: ''
                },
                consumeHistorySearch: {
                    startDate: '',
                    endDate: '',
                    itemCode: ''
                },
                dispenseForm: {
                    medicineCode: '',
                    quantity: 1,
                    dispensedBy: '',
                    patientRefId: '',
                    patientName: '',
                    stationCode: 'HC-000000',
                    emergencyReason: ''
                },
                batchDispenseForm: {
                    dispensedBy: '',
                    patientRefId: '',
                    patientName: '',
                    items: [],
                    stationCode: 'HC-000000',
                    isEmergency: false,
                    emergencyReason: ''
                },
                pharmacistApprovalForm: {
                    dispenseId: null,
                    approvedBy: '',
                    pharmacistNotes: '',
                    pinCode: ''
                },
                selectedSurgery: null,
                selectedConsumeEvent: null,

                // Toast
                showToast: false,
                toastMessage: '',
                toastType: 'info',

                // ç·Šæ€¥åŠŸèƒ½ (v1.4.5æ–°å¢)
                showEmergencyModal: false,

                // åŒæ­¥ç®¡ç† (è¯é‚¦æ¶æ§‹ Phase 1-2)
                syncPackageForm: {
                    syncType: 'DELTA',
                    sinceTimestamp: ''
                },
                generatedPackage: null,
                uploadedPackage: null,
                importResult: null,
                syncStats: {
                    pendingChanges: 0,
                    syncedPackages: 0,
                    lastSync: null
                },

                // è¼‰å…¥ç‹€æ…‹è¿½è¹¤ (v1.4.5æ•ˆèƒ½å„ªåŒ–)
                dataLoaded: {
                    items: false,
                    blood: false,
                    equipment: false,
                    surgery: false,
                    dispense: false,
                    surgeryMaster: false
                },

                // è¡“å¼ä¸»æª” (v2.6 - Phase 1-3)
                surgeryMasterSubTab: 'codes',
                surgeryCodes: [],
                surgeryCodesTotal: 0,
                surgeryCodesPage: 1,
                surgeryCodesPageSize: 50,
                selfPayItems: [],
                selfPayItemsTotal: 0,
                selfPayItemsPage: 1,
                selfPayItemsPageSize: 50,
                surgeryCategories: [],
                selfPayCategories: [],
                surgeryCodeSearchText: '',
                surgeryCodeCategoryFilter: '',
                selfPaySearchText: '',
                selfPayCategoryFilter: '',
                surgeryMasterStats: null,
                surgeryMasterLoading: false,
                // é»æ•¸è¨ˆç®—å™¨
                calculatorSurgeries: [],
                calculatorSearchText: '',
                calculatorSearchResults: [],
                calculatorShowDropdown: false,
                // è‡ªè²»é …ç›® Queue (v2.7.3)
                selfPayQueue: [],

                // åˆå§‹åŒ– (v1.4.5å„ªåŒ–: å»¶é²è¼‰å…¥)
                async init() {
                    this.updateTime();
                    setInterval(() => this.updateTime(), 1000);

                    // é©—è­‰ QRCode å‡½å¼åº«æ˜¯å¦å¯ç”¨ (qrcodejs)
                    if (typeof QRCode !== 'undefined' && QRCode.CorrectLevel) {
                        console.log('[Init] qrcodejs library loaded successfully');
                    } else {
                        console.error('[Init] qrcodejs library NOT loaded!');
                    }

                    // Check if running in Vercel demo mode
                    try {
                        const demoRes = await fetch(`${this.apiUrl}/demo-status`);
                        if (demoRes.ok) {
                            const demoData = await demoRes.json();
                            this.demoMode = demoData.is_demo || false;
                            console.log('Demo mode:', this.demoMode);
                        }
                    } catch (e) {
                        // Not in demo mode or API not available
                        this.demoMode = false;
                    }

                    // v2.5: å–å¾—ä¼ºæœå™¨ IP è³‡è¨Š
                    try {
                        const infoRes = await fetch(`${this.apiUrl}/info`);
                        if (infoRes.ok) {
                            const infoData = await infoRes.json();
                            this.detectedServerUrl = infoData.server_url;
                            console.log('[Init] Server URL:', this.detectedServerUrl);
                        }
                    } catch (e) {
                        console.log('[Init] Could not detect server IP');
                    }

                    // åŒæ­¥æ‰€æœ‰è¡¨å–®çš„ stationId
                    this.syncFormStationIds();

                    // åªè¼‰å…¥çµ±è¨ˆè³‡æ–™ï¼ˆè¼•é‡ç´šï¼‰
                    await this.loadStats();

                    // æ ¹æ“šç•¶å‰æ¨™ç±¤è¼‰å…¥å°æ‡‰è³‡æ–™
                    await this.lazyLoadTabData(this.currentTab);

                    // åˆå§‹åŒ–åŒæ­¥é€šçŸ¥è¼ªè©¢ (æ¯ 30 ç§’æª¢æŸ¥ä¸€æ¬¡ PWA åŒæ­¥)
                    await this.initSyncNotifications();
                    setInterval(() => this.checkForNewSyncs(), 30000);

                    // v2.9: CIRS Hub é€£ç·šæª¢æŸ¥ (Phase 9)
                    await this.checkHubConnection();
                    await this.checkSnapshotStatus();
                    // æ¯ 5 åˆ†é˜æª¢æŸ¥ä¸€æ¬¡ Hub é€£ç·š
                    setInterval(() => this.checkHubConnection(), 5 * 60 * 1000);
                },

                // v2.8.0: Initialize xIRS UI Components
                initXirsUI() {
                    // Initialize Offline Banner
                    if (typeof XIRS_OFFLINE !== 'undefined') {
                        XIRS_OFFLINE.init({
                            // MIRS å¯èƒ½æ²’æœ‰ offline_expï¼Œé›¢ç·šæ™‚é¡¯ç¤ºç¶ è‰²ç‹€æ…‹
                        });
                    }

                    // Initialize Toast
                    if (typeof XIRS_TOAST !== 'undefined') {
                        XIRS_TOAST.init();
                    }

                    // Initialize 403 Handler (Break-Glass disabled for MIRS)
                    if (typeof XIRS_403 !== 'undefined') {
                        XIRS_403.init({
                            allowBreakGlass: false,  // MIRS æš«ä¸å•Ÿç”¨ Break-Glass
                        });
                    }

                    // Initialize Draft Recovery
                    if (typeof XIRS_DRAFT !== 'undefined') {
                        XIRS_DRAFT.init();
                    }

                    console.log('[MIRS] xIRS UI Components initialized');
                },

                // Helper: é¡¯ç¤º Toast é€šçŸ¥
                showToast(message, type = 'info') {
                    if (typeof XIRS_TOAST !== 'undefined') {
                        XIRS_TOAST[type](message);
                    } else {
                        console.log(`[Toast ${type}] ${message}`);
                    }
                },

                // Reset demo data (Vercel demo mode only)
                async resetDemo() {
                    if (!this.demoMode) return;
                    if (!confirm('ç¢ºå®šè¦é‡ç½®å±•ç¤ºè³‡æ–™å—ï¼Ÿæ‰€æœ‰è®Šæ›´å°‡æœƒéºå¤±ã€‚')) return;
                    try {
                        const res = await fetch('/api/demo/reset', { method: 'POST' });
                        if (res.ok) {
                            alert('å±•ç¤ºè³‡æ–™å·²é‡ç½®ï¼é é¢å°‡é‡æ–°è¼‰å…¥ã€‚');
                            window.location.reload();
                        } else {
                            alert('é‡ç½®å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
                        }
                    } catch (e) {
                        alert('é‡ç½®å¤±æ•—ï¼š' + e.message);
                    }
                },

                // ç”¢ç”Ÿ Mobile é…å°ç¢¼èˆ‡ QR Code
                async generatePairingCode() {
                    this.pairingLoading = true;
                    this.pairingError = null;
                    this.pairingInfo = null;
                    this.pairingQRUrl = '';

                    // å°‡åŠŸèƒ½é–‹é—œè½‰æ›ç‚º scope å­—ä¸²é™£åˆ—
                    const scopes = ['mirs:resilience:read'];
                    if (this.pairingConfig.scopes.equipment) {
                        scopes.push('mirs:equipment:read', 'mirs:equipment:write');
                    }
                    if (this.pairingConfig.scopes.inventory) {
                        scopes.push('mirs:inventory:read', 'mirs:inventory:check');
                    }
                    if (this.pairingConfig.scopes.bloodReceive) {
                        scopes.push('mirs:blood:receive');
                    }
                    if (this.pairingConfig.scopes.supplyReceive) {
                        scopes.push('mirs:items:receive');
                    }

                    try {
                        // 1. å–å¾— QR Code åœ–ç‰‡
                        const qrRes = await fetch(`${this.apiUrl}/mirs-mobile/v1/auth/pairing-qr`);
                        if (qrRes.ok) {
                            const blob = await qrRes.blob();
                            this.pairingQRUrl = URL.createObjectURL(blob);
                        } else {
                            throw new Error('ç„¡æ³•ç”¢ç”Ÿ QR Code');
                        }

                        // 2. ç”¢ç”Ÿé…å°ç¢¼ï¼ˆå¸¶ä¸Šè§’è‰²èˆ‡æ¬Šé™ï¼‰
                        const pairingReq = {
                            role: this.pairingConfig.role,
                            scopes: scopes
                        };

                        // å˜—è©¦ POSTï¼ˆæ–°ç‰ˆ APIï¼‰ï¼Œå¦‚æœå¤±æ•—å‰‡é€€å› GETï¼ˆèˆŠç‰ˆ APIï¼‰
                        let infoRes = await fetch(`${this.apiUrl}/mirs-mobile/v1/auth/pairing-info`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(pairingReq)
                        });

                        // å¦‚æœ POST ä¸æ”¯æ´ (405)ï¼Œé€€å› GETï¼ˆä½¿ç”¨é è¨­æ¬Šé™ï¼‰
                        if (infoRes.status === 405) {
                            console.warn('POST /auth/pairing-info not supported, falling back to GET');
                            infoRes = await fetch(`${this.apiUrl}/mirs-mobile/v1/auth/pairing-info`);
                        }

                        if (!infoRes.ok) {
                            const err = await infoRes.json();
                            throw new Error(err.detail || 'ç”¢ç”Ÿé…å°ç¢¼å¤±æ•—');
                        }

                        this.pairingInfo = await infoRes.json();

                        // è¨ˆç®—å‰©é¤˜æ™‚é–“
                        const expiresAt = new Date(this.pairingInfo.expires_at);
                        const updateExpiry = () => {
                            const now = new Date();
                            const diff = Math.max(0, Math.floor((expiresAt - now) / 1000));
                            const mins = Math.floor(diff / 60);
                            const secs = diff % 60;
                            this.pairingExpiry = `${mins}:${secs.toString().padStart(2, '0')}`;

                            if (diff <= 0) {
                                this.pairingExpiry = 'å·²éæœŸ';
                            }
                        };
                        updateExpiry();
                        const timer = setInterval(() => {
                            updateExpiry();
                            if (this.pairingExpiry === 'å·²éæœŸ' || !this.showMobilePairing) {
                                clearInterval(timer);
                            }
                        }, 1000);

                    } catch (e) {
                        console.error('Generate pairing code error:', e);
                        this.pairingError = e.message || 'ç„¡æ³•é€£æ¥åˆ° Mobile API';
                    } finally {
                        this.pairingLoading = false;
                    }
                },

                // è¼‰å…¥å·²é…å°è£ç½®åˆ—è¡¨
                async loadPairedDevices() {
                    this.pairedDevicesLoading = true;
                    try {
                        const response = await fetch(`${this.apiUrl}/mirs-mobile/v1/devices`);
                        if (response.ok) {
                            const data = await response.json();
                            this.pairedDevices = data.devices || [];
                            console.log('âœ“ å·²è¼‰å…¥é…å°è£ç½®:', this.pairedDevices.length, 'ç­†');
                        } else {
                            console.error('è¼‰å…¥é…å°è£ç½®å¤±æ•—:', response.status);
                            this.pairedDevices = [];
                        }
                    } catch (e) {
                        console.error('è¼‰å…¥é…å°è£ç½®éŒ¯èª¤:', e);
                        this.pairedDevices = [];
                    } finally {
                        this.pairedDevicesLoading = false;
                    }
                },

                // æ’¤éŠ·è£ç½®é…å°
                async revokeDevice(deviceId) {
                    const reason = prompt('è«‹è¼¸å…¥æ’¤éŠ·åŸå› ï¼ˆé¸å¡«ï¼‰ï¼š');
                    if (reason === null) return; // ä½¿ç”¨è€…å–æ¶ˆ

                    try {
                        const response = await fetch(`${this.apiUrl}/mirs-mobile/v1/devices/${deviceId}/revoke`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ reason: reason || 'ç®¡ç†å“¡æ’¤éŠ·' })
                        });

                        if (response.ok) {
                            this.toast('è£ç½®å·²æ’¤éŠ·', 'success');
                            this.loadPairedDevices(); // é‡æ–°è¼‰å…¥åˆ—è¡¨
                        } else {
                            const err = await response.json();
                            this.toast(err.detail || 'æ’¤éŠ·å¤±æ•—', 'error');
                        }
                    } catch (e) {
                        console.error('æ’¤éŠ·è£ç½®å¤±æ•—:', e);
                        this.toast('æ’¤éŠ·å¤±æ•—: ' + e.message, 'error');
                    }
                },

                // ============================================================
                // v2.9: CIRS Hub é€£ç·šç®¡ç† (Phase 9)
                // ============================================================

                async checkHubConnection() {
                    this.hubStatus.checking = true;
                    try {
                        const response = await fetch(`${this.apiUrl}/local-auth/hub-status`);
                        if (response.ok) {
                            const data = await response.json();
                            this.hubStatus.connected = data.connected;
                            this.hubStatus.hubUrl = data.hub_url;
                            this.hubStatus.error = data.error || null;
                            this.hubStatus.lastCheck = new Date().toISOString();
                            console.log('[Hub] Status:', data.connected ? 'Connected' : 'Disconnected');
                        }
                    } catch (e) {
                        this.hubStatus.connected = false;
                        this.hubStatus.error = e.message;
                        console.warn('[Hub] Check failed:', e.message);
                    } finally {
                        this.hubStatus.checking = false;
                    }
                },

                async checkSnapshotStatus() {
                    try {
                        const response = await fetch(`${this.apiUrl}/local-auth/snapshot-status`);
                        if (response.ok) {
                            const data = await response.json();
                            this.snapshotStatus.hasSnapshot = data.has_snapshot;
                            this.snapshotStatus.version = data.snapshot_version;
                            this.snapshotStatus.expiresAt = data.expires_at;
                            this.snapshotStatus.isExpired = data.is_expired;
                            this.snapshotStatus.userCount = data.user_count || 0;
                            console.log('[Snapshot] Status:', data.has_snapshot ? `v${data.snapshot_version}` : 'None');
                        }
                    } catch (e) {
                        console.warn('[Snapshot] Check failed:', e.message);
                    }
                },

                async syncPolicySnapshot() {
                    this.snapshotStatus.syncing = true;
                    try {
                        const response = await fetch(`${this.apiUrl}/local-auth/sync-snapshot`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' }
                        });
                        const data = await response.json();
                        if (data.success) {
                            this.toast(`å¿«ç…§åŒæ­¥æˆåŠŸ (v${data.snapshot_version}, ${data.user_count} ä½¿ç”¨è€…)`, 'success');
                            await this.checkSnapshotStatus();
                        } else {
                            this.toast(`åŒæ­¥å¤±æ•—: ${data.error}`, 'error');
                        }
                    } catch (e) {
                        this.toast(`åŒæ­¥å¤±æ•—: ${e.message}`, 'error');
                    } finally {
                        this.snapshotStatus.syncing = false;
                    }
                },

                getHubStatusColor() {
                    if (this.hubStatus.checking) return 'bg-gray-400';
                    if (this.hubStatus.connected) return 'bg-green-500';
                    return 'bg-red-500';
                },

                getHubStatusText() {
                    if (this.hubStatus.checking) return 'æª¢æŸ¥ä¸­...';
                    if (this.hubStatus.connected) return 'Hub å·²é€£ç·š';
                    return 'Hub é›¢ç·š';
                },

                // ============================================================

                // åŒæ­¥æ‰€æœ‰è¡¨å–®çš„ stationId èˆ‡ç•¶å‰ç«™é»
                syncFormStationIds() {
                    this.receiveForm.stationId = this.stationId;
                    // v3.0: consumeForm/batchConsumeForm å·²ç§»é™¤
                    this.bloodReceiveForm.stationId = this.stationId;
                    this.bloodConsumeForm.stationId = this.stationId;
                },

                updateTime() {
                    const now = new Date();
                    this.currentTime = now.toLocaleString('zh-TW', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit',
                        hour12: false
                    });
                },

                getStationTypeName() {
                    const types = {
                        'health_center': 'è¡›ç”Ÿæ‰€',
                        'hospital_custom': 'é†«é™¢è‡ªè¨‚',
                        'surgical_station': 'BORP å‚™æ´æ‰‹è¡“ç«™',
                        'logistics_hub': 'ç‰©è³‡ä¸­ç¹¼ç«™'
                    };
                    return types[this.stationType] || this.stationType;
                },

                // å»¶é²è¼‰å…¥æ¨™ç±¤è³‡æ–™ (v1.4.5æ•ˆèƒ½å„ªåŒ–)
                async lazyLoadTabData(tab) {
                    if (tab === 'items' && !this.dataLoaded.items) {
                        await this.loadItems();
                        this.dataLoaded.items = true;
                    }
                    if (tab === 'blood' && !this.dataLoaded.blood) {
                        await this.loadBloodInventory();
                        await this.loadBloodBags();
                        this.dataLoaded.blood = true;
                    }
                    if (tab === 'equipment' && !this.dataLoaded.equipment) {
                        await this.loadEquipment();
                        this.dataLoaded.equipment = true;
                    }
                    if (tab === 'surgery' && !this.dataLoaded.surgery) {
                        await this.loadSurgeryRecords();
                        this.dataLoaded.surgery = true;
                    }
                    if (tab === 'treatment' && !this.dataLoaded.items) {
                        // è™•ç½®æ¨™ç±¤éœ€è¦ç‰©å“è³‡æ–™ (ç”¨æ–¼æ¶ˆè€—å“é …æœå°‹)
                        await this.loadItems();
                        this.dataLoaded.items = true;
                    }
                    if (tab === 'dispense' && !this.dataLoaded.dispense) {
                        await this.loadPendingDispenses();
                        this.dataLoaded.dispense = true;
                    }
                    if (tab === 'resilience') {
                        // éŸŒæ€§è¨­å‚™è¡¨æ ¼éœ€è¦ equipment è³‡æ–™
                        if (!this.dataLoaded.equipment) {
                            await this.loadEquipment();
                            this.dataLoaded.equipment = true;
                        }
                        await this.loadResilienceConfig();
                        await this.loadResilienceStatus();
                    }
                    if (tab === 'surgeryMaster' && !this.dataLoaded.surgeryMaster) {
                        await this.loadSurgeryCategories();
                        await this.loadSelfPayCategories();
                        await this.loadSurgeryMasterStats();
                        await this.loadSurgeryCodes();
                        this.dataLoaded.surgeryMaster = true;
                    }
                },

                // åˆ†é åˆ‡æ› (v1.4.5å„ªåŒ–: å»¶é²è¼‰å…¥)
                async switchTab(tab) {
                    this.currentTab = tab;
                    await this.lazyLoadTabData(tab);
                },

                // ============================================================
                // è¡“å¼ä¸»æª”æ–¹æ³• (v2.6 - Phase 1-3)
                // ============================================================

                async loadSurgeryCategories() {
                    try {
                        const response = await fetch(`${this.apiUrl}/surgery-codes/categories`);
                        if (response.ok) {
                            const data = await response.json();
                            this.surgeryCategories = data.categories || [];
                        }
                    } catch (error) {
                        console.error('è¼‰å…¥è¡“å¼åˆ†é¡å¤±æ•—:', error);
                    }
                },

                async loadSelfPayCategories() {
                    try {
                        const response = await fetch(`${this.apiUrl}/surgery-codes/selfpay/categories`);
                        if (response.ok) {
                            const data = await response.json();
                            this.selfPayCategories = data.categories || [];
                        }
                    } catch (error) {
                        console.error('è¼‰å…¥è‡ªè²»åˆ†é¡å¤±æ•—:', error);
                    }
                },

                async loadSurgeryMasterStats() {
                    try {
                        const response = await fetch(`${this.apiUrl}/surgery-codes/stats`);
                        if (response.ok) {
                            this.surgeryMasterStats = await response.json();
                        }
                    } catch (error) {
                        console.error('è¼‰å…¥è¡“å¼çµ±è¨ˆå¤±æ•—:', error);
                    }
                },

                async loadSurgeryCodes() {
                    // é˜²æ­¢é‡è¤‡è«‹æ±‚
                    if (this.surgeryMasterLoading) return;
                    this.surgeryMasterLoading = true;
                    try {
                        let url;
                        if (this.surgeryCodeSearchText && this.surgeryCodeSearchText.trim()) {
                            // æœ‰æœå°‹æ–‡å­—æ™‚ä½¿ç”¨ FTS æœå°‹ç«¯é»
                            url = `${this.apiUrl}/surgery-codes/codes/search?q=${encodeURIComponent(this.surgeryCodeSearchText)}&limit=50`;
                            if (this.surgeryCodeCategoryFilter) {
                                url += `&category=${encodeURIComponent(this.surgeryCodeCategoryFilter)}`;
                            }
                        } else {
                            // ç„¡æœå°‹æ–‡å­—æ™‚ä½¿ç”¨åˆ—è¡¨ç«¯é»
                            url = `${this.apiUrl}/surgery-codes/codes?page=${this.surgeryCodesPage}&page_size=${this.surgeryCodesPageSize}`;
                            if (this.surgeryCodeCategoryFilter) {
                                url += `&category=${encodeURIComponent(this.surgeryCodeCategoryFilter)}`;
                            }
                        }
                        const response = await fetch(url);
                        if (response.ok) {
                            const data = await response.json();
                            this.surgeryCodes = data.codes || [];
                            this.surgeryCodesTotal = data.total || this.surgeryCodes.length;
                        }
                    } catch (error) {
                        console.error('è¼‰å…¥è¡“å¼ä»£ç¢¼å¤±æ•—:', error);
                    } finally {
                        this.surgeryMasterLoading = false;
                    }
                },

                async searchSurgeryCodes() {
                    this.surgeryCodesPage = 1;
                    // å…ˆæ¸…ç©ºå†è¼‰å…¥ï¼Œé¿å…é¡¯ç¤ºèˆŠè³‡æ–™
                    this.surgeryCodes = [];
                    await this.loadSurgeryCodes();
                },

                async loadSelfPayItems() {
                    this.surgeryMasterLoading = true;
                    try {
                        let url;
                        if (this.selfPaySearchText && this.selfPaySearchText.trim()) {
                            // æœ‰æœå°‹æ–‡å­—æ™‚ä½¿ç”¨ FTS æœå°‹ç«¯é»
                            url = `${this.apiUrl}/surgery-codes/selfpay/search?q=${encodeURIComponent(this.selfPaySearchText)}&limit=50`;
                            if (this.selfPayCategoryFilter) {
                                url += `&category=${encodeURIComponent(this.selfPayCategoryFilter)}`;
                            }
                        } else {
                            // ç„¡æœå°‹æ–‡å­—æ™‚ä½¿ç”¨åˆ—è¡¨ç«¯é»
                            url = `${this.apiUrl}/surgery-codes/selfpay?limit=50`;
                            if (this.selfPayCategoryFilter) {
                                url += `&category=${encodeURIComponent(this.selfPayCategoryFilter)}`;
                            }
                        }
                        const response = await fetch(url);
                        if (response.ok) {
                            const data = await response.json();
                            this.selfPayItems = data.items || [];
                            this.selfPayItemsTotal = data.total || this.selfPayItems.length;
                        }
                    } catch (error) {
                        console.error('è¼‰å…¥è‡ªè²»é …ç›®å¤±æ•—:', error);
                    } finally {
                        this.surgeryMasterLoading = false;
                    }
                },

                async searchSelfPayItems() {
                    this.selfPayItemsPage = 1;
                    await this.loadSelfPayItems();
                },

                // è¡“å¼ä¸»æª”å­æ¨™ç±¤åˆ‡æ›
                async switchSurgeryMasterSubTab(subTab) {
                    this.surgeryMasterSubTab = subTab;
                    if (subTab === 'codes' && this.surgeryCodes.length === 0) {
                        await this.loadSurgeryCodes();
                    } else if (subTab === 'selfpay' && this.selfPayItems.length === 0) {
                        await this.loadSelfPayItems();
                    }
                },

                // é»æ•¸è¨ˆç®—å™¨æ–¹æ³•
                async searchForCalculator() {
                    if (!this.calculatorSearchText || this.calculatorSearchText.length < 1) {
                        this.calculatorSearchResults = [];
                        this.calculatorShowDropdown = false;
                        return;
                    }
                    try {
                        const response = await fetch(`${this.apiUrl}/surgery-codes/codes/search?q=${encodeURIComponent(this.calculatorSearchText)}&limit=10`);
                        if (response.ok) {
                            const data = await response.json();
                            this.calculatorSearchResults = data.codes || [];
                            this.calculatorShowDropdown = this.calculatorSearchResults.length > 0;
                        }
                    } catch (error) {
                        console.error('æœå°‹è¡“å¼å¤±æ•—:', error);
                    }
                },

                addToCalculator(surgery) {
                    // æª¢æŸ¥æ˜¯å¦å·²æ·»åŠ 
                    if (this.calculatorSurgeries.find(s => s.code === surgery.code)) {
                        this.showToastMessage('æ­¤è¡“å¼å·²åœ¨æ¸…å–®ä¸­', 'warning');
                        return;
                    }
                    this.calculatorSurgeries.push({
                        code: surgery.code,
                        name_zh: surgery.name_zh,
                        points: surgery.points,
                        category_code: surgery.category_code || null,
                        reduction_rate: 1.0,
                        final_points: surgery.points
                    });
                    this.recalculatePoints();
                    this.calculatorSearchText = '';
                    this.calculatorSearchResults = [];
                    this.calculatorShowDropdown = false;
                },

                removeFromCalculator(index) {
                    this.calculatorSurgeries.splice(index, 1);
                    this.recalculatePoints();
                },

                async recalculatePoints() {
                    if (this.calculatorSurgeries.length === 0) return;

                    try {
                        // ä½¿ç”¨ API è¨ˆç®—éæ¸› (v2.7.4: æ­£ç¢ºçš„å¥ä¿è¦å‰‡)
                        const response = await fetch(`${this.apiUrl}/surgery-codes/calculate-points`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                surgeries: this.calculatorSurgeries.map(s => ({
                                    code: s.code,
                                    name: s.name_zh,
                                    points: s.points,
                                    category_code: s.category_code
                                })),
                                apply_reduction: true
                            })
                        });

                        if (response.ok) {
                            const result = await response.json();
                            // ç”¨ API å›å‚³çš„ sequence æ’åºï¼Œä¸¦æ›´æ–° reduction_rate å’Œ final_points
                            const resultMap = {};
                            result.items.forEach(item => {
                                resultMap[item.code] = {
                                    reduction_rate: item.reduction_rate,
                                    final_points: item.final_points,
                                    sequence: item.sequence
                                };
                            });

                            this.calculatorSurgeries = this.calculatorSurgeries.map(s => ({
                                ...s,
                                reduction_rate: resultMap[s.code]?.reduction_rate ?? 1.0,
                                final_points: resultMap[s.code]?.final_points ?? s.points,
                                sequence: resultMap[s.code]?.sequence ?? 99
                            }));

                            // æŒ‰ sequence æ’åºé¡¯ç¤º
                            this.calculatorSurgeries.sort((a, b) => a.sequence - b.sequence);
                        }
                    } catch (error) {
                        console.error('è¨ˆç®—é»æ•¸å¤±æ•—:', error);
                        // Fallback: ç°¡æ˜“è¨ˆç®—
                        this.calculatorSurgeries.forEach((s, idx) => {
                            s.reduction_rate = idx === 0 ? 1.0 : (idx <= 2 ? 0.5 : 0.0);
                            s.final_points = Math.round(s.points * s.reduction_rate);
                        });
                    }
                },

                getCalculatorTotal() {
                    return this.calculatorSurgeries.reduce((sum, s) => sum + (s.final_points || 0), 0);
                },

                getCalculatorOriginalTotal() {
                    return this.calculatorSurgeries.reduce((sum, s) => sum + (s.points || 0), 0);
                },

                clearCalculator() {
                    this.calculatorSurgeries = [];
                },

                // è‡ªè²»é …ç›® Queue æ–¹æ³• (v2.7.3)
                addToSelfPayQueue(item) {
                    const existing = this.selfPayQueue.find(q => q.item_id === item.item_id);
                    if (existing) {
                        existing.quantity++;
                    } else {
                        this.selfPayQueue.push({
                            item_id: item.item_id,
                            name: item.name,
                            unit_price: item.unit_price || 0,
                            unit: item.unit || 'çµ„',
                            category: item.category,
                            quantity: 1
                        });
                    }
                },

                removeFromSelfPayQueue(index) {
                    this.selfPayQueue.splice(index, 1);
                },

                updateSelfPayQueueQty(index, delta) {
                    const item = this.selfPayQueue[index];
                    if (item) {
                        item.quantity = Math.max(1, item.quantity + delta);
                    }
                },

                getSelfPayQueueTotal() {
                    return this.selfPayQueue.reduce((sum, item) => sum + (item.unit_price * item.quantity), 0);
                },

                clearSelfPayQueue() {
                    this.selfPayQueue = [];
                },

                // ============================================================
                // v2.7.4: è™•ç½®è€—æè¨˜éŒ„è¡¨å–® Queue æ–¹æ³•
                // ============================================================

                async searchFormSurgery() {
                    const q = this.addSurgeryForm.surgerySearchText;
                    if (!q || q.length < 1) {
                        this.formSurgerySearchResults = [];
                        return;
                    }
                    try {
                        const response = await fetch(`${this.apiUrl}/surgery-codes/codes/search?q=${encodeURIComponent(q)}&limit=10`);
                        if (response.ok) {
                            const data = await response.json();
                            this.formSurgerySearchResults = data.codes || [];
                        }
                    } catch (error) {
                        console.error('æœå°‹è¡“å¼å¤±æ•—:', error);
                    }
                },

                addToFormSurgeryQueue(surgery) {
                    if (this.addSurgeryForm.surgeryQueue.find(s => s.code === surgery.code)) {
                        this.showToastMessage('æ­¤è¡“å¼å·²åœ¨æ¸…å–®ä¸­', 'warning');
                        return;
                    }
                    this.addSurgeryForm.surgeryQueue.push({
                        code: surgery.code,
                        name_zh: surgery.name_zh,
                        points: surgery.points,
                        category_code: surgery.category_code || null,
                        reduction_rate: 1.0,
                        final_points: surgery.points
                    });
                    this.recalculateFormSurgeryPoints();
                    this.addSurgeryForm.surgerySearchText = '';
                    this.formSurgerySearchResults = [];
                },

                removeFromFormSurgeryQueue(index) {
                    this.addSurgeryForm.surgeryQueue.splice(index, 1);
                    this.recalculateFormSurgeryPoints();
                },

                async recalculateFormSurgeryPoints() {
                    const queue = this.addSurgeryForm.surgeryQueue;
                    if (queue.length === 0) return;

                    try {
                        const response = await fetch(`${this.apiUrl}/surgery-codes/calculate-points`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                surgeries: queue.map(s => ({
                                    code: s.code,
                                    name: s.name_zh,
                                    points: s.points,
                                    category_code: s.category_code
                                })),
                                apply_reduction: true
                            })
                        });

                        if (response.ok) {
                            const result = await response.json();
                            const resultMap = {};
                            result.items.forEach(item => {
                                resultMap[item.code] = {
                                    reduction_rate: item.reduction_rate,
                                    final_points: item.final_points,
                                    sequence: item.sequence
                                };
                            });

                            this.addSurgeryForm.surgeryQueue = queue.map(s => ({
                                ...s,
                                reduction_rate: resultMap[s.code]?.reduction_rate ?? 1.0,
                                final_points: resultMap[s.code]?.final_points ?? s.points,
                                sequence: resultMap[s.code]?.sequence ?? 99
                            })).sort((a, b) => a.sequence - b.sequence);
                        }
                    } catch (error) {
                        console.error('è¨ˆç®—é»æ•¸å¤±æ•—:', error);
                    }
                },

                getFormSurgeryTotal() {
                    return this.addSurgeryForm.surgeryQueue.reduce((sum, s) => sum + (s.final_points || 0), 0);
                },

                async searchFormSelfPay() {
                    const q = this.addSurgeryForm.selfPayFormSearchText;
                    if (!q || q.length < 1) {
                        this.formSelfPaySearchResults = [];
                        return;
                    }
                    try {
                        const response = await fetch(`${this.apiUrl}/surgery-codes/selfpay/search?q=${encodeURIComponent(q)}&limit=10`);
                        if (response.ok) {
                            const data = await response.json();
                            this.formSelfPaySearchResults = data.items || [];
                        }
                    } catch (error) {
                        console.error('æœå°‹è‡ªè²»é …ç›®å¤±æ•—:', error);
                    }
                },

                addToFormSelfPayQueue(item) {
                    const existing = this.addSurgeryForm.selfPayQueue.find(q => q.item_id === item.item_id);
                    if (existing) {
                        existing.quantity++;
                    } else {
                        this.addSurgeryForm.selfPayQueue.push({
                            item_id: item.item_id,
                            name: item.name,
                            unit_price: item.unit_price || 0,
                            unit: item.unit || 'çµ„',
                            quantity: 1
                        });
                    }
                },

                removeFromFormSelfPayQueue(index) {
                    this.addSurgeryForm.selfPayQueue.splice(index, 1);
                },

                updateFormSelfPayQty(index, delta) {
                    const item = this.addSurgeryForm.selfPayQueue[index];
                    if (item) {
                        item.quantity = Math.max(1, item.quantity + delta);
                    }
                },

                getFormSelfPayTotal() {
                    return this.addSurgeryForm.selfPayQueue.reduce((sum, item) => sum + (item.unit_price * item.quantity), 0);
                },

                // æ ¼å¼åŒ–æ•¸å­—åŠ åƒåˆ†ä½
                formatNumber(num) {
                    return (num || 0).toLocaleString();
                },

                // ============================================================
                // éŸŒæ€§ä¼°ç®—æ–¹æ³•
                // ============================================================

                // ä½¿ç”¨ v1 API (å®Œæ•´è¨ˆç®—é‚è¼¯: population, power dependency)
                async loadResilienceStatus() {
                    try {
                        // ä¿å­˜æ»¾å‹•ä½ç½®
                        const scrollY = window.scrollY;

                        // v1 API: /api/resilience/status (å®Œæ•´è¨ˆç®—é‚è¼¯)
                        const response = await fetch(`${this.apiUrl}/resilience/status`, {
                            cache: 'no-store'
                        });
                        if (response.ok) {
                            const data = await response.json();
                            // v1 API ç›´æ¥å›å‚³å®Œæ•´çµæ§‹ï¼Œç„¡éœ€è½‰æ›

                            // æ›´æ–°ç‹€æ…‹
                            this.resilienceStatus = {};
                            await this.$nextTick();
                            this.resilienceStatus = this.transformV1ToFrontend(data);
                            await this.$nextTick();

                            // æ¢å¾©æ»¾å‹•ä½ç½®
                            window.scrollTo(0, scrollY);

                            console.log('âœ“ éŸŒæ€§ç‹€æ…‹å·²è¼‰å…¥ (v1 API)');
                        }
                    } catch (error) {
                        console.error('è¼‰å…¥éŸŒæ€§ç‹€æ…‹å¤±æ•—:', error);
                    }
                },

                // v1 API å›æ‡‰è½‰æ›ç‚ºå‰ç«¯æ ¼å¼
                transformV1ToFrontend(data) {
                    // æ‰¾å‡ºæœ€å¼±ç”Ÿå‘½ç·š
                    const weakestLifeline = data.lifelines?.reduce((min, ll) =>
                        (!min || (ll.endurance?.effective_hours || 0) < (min.endurance?.effective_hours || 0)) ? ll : min, null);

                    return {
                        summary: {
                            overall_status: data.summary?.overall_status || 'UNKNOWN',
                            weakest_link: weakestLifeline ? {
                                hours: weakestLifeline.endurance?.effective_hours || 0,
                                type: weakestLifeline.type,
                                name: weakestLifeline.name
                            } : null,
                            check_progress: data.summary?.check_progress || { total: 0, checked: 0, percentage: 0 },
                            isolation_target_days: data.context?.isolation_target_days || 3
                        },
                        lifelines: data.lifelines || []
                    };
                },

                // v2: å°‡ dashboard API å›æ‡‰è½‰æ›ç‚ºå‰ç«¯ç›¸å®¹æ ¼å¼
                transformDashboardToLegacy(dashboard) {
                    // æ‰¾å‡ºæœ€å¼±ç”Ÿå‘½ç·š
                    const weakestLifeline = dashboard.lifelines?.reduce((min, ll) =>
                        (!min || ll.total_hours < min.total_hours) ? ll : min, null);

                    return {
                        summary: {
                            overall_status: dashboard.summary?.overall_status || 'UNKNOWN',
                            weakest_link: weakestLifeline ? {
                                hours: weakestLifeline.total_hours,
                                type: weakestLifeline.category,
                                name: weakestLifeline.name
                            } : null,
                            check_progress: dashboard.summary?.check_progress || { total: 0, checked: 0, percentage: 0 },
                            isolation_target_days: dashboard.summary?.isolation_target_days || 3
                        },
                        lifelines: dashboard.lifelines?.map(ll => ({
                            type: ll.category,  // 'POWER' or 'OXYGEN'
                            item_code: ll.category,
                            name: ll.name,
                            status: ll.status,
                            // v1 ç›¸å®¹: endurance çµæ§‹
                            endurance: {
                                effective_hours: ll.total_hours >= 999999 ? 'âˆ' : Math.round(ll.total_hours * 10) / 10,
                                effective_days: Math.round(ll.total_hours / 24 * 10) / 10
                            },
                            // v1 ç›¸å®¹: inventory çµæ§‹
                            inventory: {
                                items: ll.items?.map(item => ({
                                    item_code: item.equipment_id,
                                    name: item.name,
                                    device_type: item.type_code,
                                    qty: item.units?.length || 1,
                                    avg_level: item.units?.length > 0
                                        ? Math.round(item.units.reduce((sum, u) => sum + (u.level_percent || 0), 0) / item.units.length)
                                        : 100,
                                    tracking_mode: 'PER_UNIT',
                                    units: item.units?.map(u => ({
                                        id: u.unit_id,
                                        serial: u.serial,
                                        label: u.label,
                                        level: u.level_percent,  // v1 ç›¸å®¹
                                        level_percent: u.level_percent,
                                        status: u.status,
                                        hours: u.hours,
                                        last_check: u.last_check,
                                        checked: !!u.last_check  // v1 ç›¸å®¹: æœ‰ last_check è¡¨ç¤ºå·²æª¢æŸ¥
                                    })) || []
                                })) || []
                            },
                            charging_warnings: ll.charging_warnings || [],
                            // v2: ä¿ç•™å®Œæ•´è³‡è¨Šä¾›æ–° UI ä½¿ç”¨
                            _v2_data: ll
                        })) || []
                    };
                },

                async loadResilienceConfig() {
                    try {
                        const response = await fetch('/api/resilience/config?t=' + Date.now(), {
                            cache: 'no-store'
                        });
                        if (response.ok) {
                            const config = await response.json();
                            this.resilienceConfig = {
                                ...this.resilienceConfig,
                                ...config
                            };
                        }
                    } catch (error) {
                        console.error('è¼‰å…¥éŸŒæ€§è¨­å®šå¤±æ•—:', error);
                    }
                },

                async updateResilienceConfig() {
                    try {
                        const response = await fetch('/api/resilience/config', {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(this.resilienceConfig)
                        });
                        if (response.ok) {
                            // v1.4.3: ç«‹å³é‡æ–°è¨ˆç®—éŸŒæ€§ç‹€æ…‹
                            await this.loadResilienceStatus();
                            // Show feedback with new resilience hours
                            const hours = this.resilienceStatus.summary?.weakest_link?.hours;
                            const statusText = {
                                'SAFE': 'å®‰å…¨',
                                'WARNING': 'è­¦æˆ’',
                                'CRITICAL': 'å±éšª'
                            }[this.resilienceStatus.summary?.overall_status] || '';
                            const msg = hours !== undefined
                                ? `éŸŒæ€§å·²æ›´æ–°ï¼šå¯ç¨ç«‹é‹ä½œ ${hours.toFixed(1)} å°æ™‚ (${statusText})`
                                : 'éŸŒæ€§è¨­å®šå·²æ›´æ–°';
                            this.toast(msg, 'success');
                        } else {
                            const err = await response.json();
                            this.toast(err.detail || 'æ›´æ–°å¤±æ•—', 'error');
                        }
                    } catch (error) {
                        console.error('æ›´æ–°éŸŒæ€§è¨­å®šå¤±æ•—:', error);
                        this.toast('æ›´æ–°éŸŒæ€§è¨­å®šå¤±æ•—: ' + error.message, 'error');
                    }
                },

                // åˆ‡æ›ç«™é»
                async changeStation(newStationId) {
                    // If same station, do nothing
                    if (newStationId === this.stationId) return;

                    // Store old station for rollback
                    const oldStationId = this.stationId;

                    // Infer station type and name from ID
                    const getStationInfo = (stationId) => {
                        // Hardcoded mappings for common stations
                        const hardcoded = {
                            'HC-000000': { name: 'é†«ç™‚ç«™ HC-000000', type: 'health_center' },
                            'BORP-01': { name: 'BORP å‚™æ´æ‰‹è¡“ç«™', type: 'surgical_station' },
                            'LOG-HUB': { name: 'ç‰©è³‡ä¸­å¿ƒ LOG-HUB', type: 'logistics_hub' }
                        };

                        if (hardcoded[stationId]) {
                            return hardcoded[stationId];
                        }

                        // Parse prefix for custom stations
                        let type, name;
                        if (stationId.startsWith('TC-')) {
                            type = 'health_center';
                            name = `é†«ç™‚ç«™ ${stationId}`;
                        } else if (stationId.startsWith('BORP-')) {
                            type = 'surgical_station';
                            name = `BORP å‚™æ´æ‰‹è¡“ç«™ ${stationId}`;
                        } else if (stationId.startsWith('LOG-')) {
                            type = 'logistics_hub';
                            name = `ç‰©è³‡ä¸­å¿ƒ ${stationId}`;
                        } else {
                            // Unknown type - use generic
                            type = 'custom';
                            name = stationId;
                        }

                        return { name, type };
                    };

                    const oldInfo = getStationInfo(oldStationId);
                    const newInfo = getStationInfo(newStationId);

                    // Confirm station switch
                    const confirmed = confirm(
                        `ç¢ºå®šè¦åˆ‡æ›è‡³ã€Œ${newInfo.name}ã€å—ï¼Ÿ\n\n` +
                        `ğŸ“Œ é‡è¦èªªæ˜ï¼š\n` +
                        `â€¢ åˆ‡æ›ç«™é»å¾Œï¼Œæ‚¨å°‡åªèƒ½çœ‹åˆ°è©²ç«™é»çš„è³‡æ–™\n` +
                        `â€¢ å„ç«™é»çš„è³‡æ–™éƒ½ä¿å­˜åœ¨è³‡æ–™åº«ä¸­ï¼Œä¸æœƒè¢«åˆªé™¤\n` +
                        `â€¢ åœ¨ ${oldInfo.name} æ–°å¢çš„è³‡æ–™ä»å±¬æ–¼ ${oldInfo.name}\n` +
                        `â€¢ åˆ‡æ›å›åŸç«™é»æ™‚ï¼Œè³‡æ–™ä»æœƒåœ¨é‚£è£¡\n\n` +
                        `æ˜¯å¦ç¹¼çºŒåˆ‡æ›ï¼Ÿ`
                    );

                    if (!confirmed) {
                        // Reset select element back to old station
                        if (typeof event !== 'undefined' && event.target) {
                            event.target.value = oldStationId;
                        }
                        return;
                    }

                    // Update station
                    this.stationId = newStationId;
                    this.stationName = newInfo.name;
                    this.stationType = newInfo.type;

                    localStorage.setItem('stationId', newStationId);
                    localStorage.setItem('stationName', this.stationName);
                    localStorage.setItem('stationType', this.stationType);

                    // åŒæ­¥æ‰€æœ‰è¡¨å–®çš„ stationId
                    this.syncFormStationIds();

                    // Reset data loaded flags
                    this.dataLoaded = {
                        items: false,
                        blood: false,
                        equipment: false,
                        surgery: false,
                        dispense: false
                    };

                    // Reload current tab data
                    await this.loadStats();
                    await this.lazyLoadTabData(this.currentTab);

                    // Auto-initialize new station with template if empty
                    if (this.currentTab === 'equipment' || !this.dataLoaded.equipment) {
                        await this.loadEquipment();
                        await this.autoInitializeStationTemplate();
                    }

                    this.toast(`å·²å¾ ${oldInfo.name} åˆ‡æ›è‡³ ${this.stationName}`, 'info');
                },

                // Auto-initialize station with equipment template
                async autoInitializeStationTemplate() {
                    // Only auto-initialize if equipment is empty
                    if (this.equipment && this.equipment.length > 0) {
                        return; // Station already has equipment
                    }

                    // Don't auto-initialize if it's a well-known station (already set up manually)
                    const knownStations = ['HC-000000', 'BORP-01', 'LOG-HUB'];
                    if (knownStations.includes(this.stationId)) {
                        return;
                    }

                    // Determine template based on station type
                    let templateStationId;
                    if (this.stationId.startsWith('TC-')) {
                        templateStationId = 'HC-000000';
                    } else if (this.stationId.startsWith('BORP-')) {
                        templateStationId = 'BORP-01';
                    } else if (this.stationId.startsWith('LOG-')) {
                        templateStationId = 'LOG-HUB';
                    } else {
                        return; // Unknown type, skip auto-initialization
                    }

                    // Fetch template equipment
                    try {
                        const response = await fetch(`${this.apiUrl}/equipment?station_id=${templateStationId}`);
                        if (!response.ok) return;

                        const data = await response.json();
                        const templateEquipment = data.equipment || [];

                        if (templateEquipment.length === 0) return;

                        // Ask user if they want to copy template
                        const confirmed = confirm(
                            `æª¢æ¸¬åˆ° ${this.stationName} å°šç„¡è¨­å‚™ã€‚\n\n` +
                            `æ˜¯å¦è¦å¾ ${templateStationId} è¤‡è£½ ${templateEquipment.length} é …è¨­å‚™æ¨¡æ¿ï¼Ÿ\n\n` +
                            `é€™å°‡å¹«åŠ©æ‚¨å¿«é€Ÿè¨­ç½®æ–°ç«™é»ã€‚`
                        );

                        if (!confirmed) return;

                        // Copy equipment from template
                        let successCount = 0;
                        for (const eq of templateEquipment) {
                            // Generate new equipment ID for this station
                            const oldPrefix = templateStationId.replace('-', '');
                            const newPrefix = this.stationId.replace('-', '');
                            const newId = eq.id.replace(oldPrefix, newPrefix);

                            const newEquipment = {
                                id: newId,
                                name: eq.name,
                                category: eq.category,
                                quantity: eq.quantity,
                                status: 'UNCHECKED',
                                power_level: eq.power_level,
                                remarks: `å¾ ${templateStationId} è¤‡è£½`,
                                station_id: this.stationId
                            };

                            try {
                                const addResponse = await fetch(`${this.apiUrl}/equipment`, {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify(newEquipment)
                                });

                                if (addResponse.ok) {
                                    successCount++;
                                }
                            } catch (error) {
                                console.error('è¤‡è£½è¨­å‚™å¤±æ•—:', newId, error);
                            }
                        }

                        if (successCount > 0) {
                            this.toast(`å·²æˆåŠŸè¤‡è£½ ${successCount} é …è¨­å‚™`, 'success');
                            await this.loadEquipment();
                            await this.loadStats();
                        }
                    } catch (error) {
                        console.error('è‡ªå‹•åˆå§‹åŒ–å¤±æ•—:', error);
                    }
                },

                // è™•ç†ç«™é»é¸æ“‡è®Šæ›´
                handleStationSelectChange(value) {
                    if (value === '__CUSTOM__') {
                        this.showCustomStationInput = true;
                        this.customStationType = 'TC';
                        this.customStationNumber = '';
                        // Auto-focus the input after it appears
                        this.$nextTick(() => {
                            const input = document.querySelector('input[x-model="customStationNumber"]');
                            if (input) input.focus();
                        });
                    } else {
                        this.showCustomStationInput = false;
                        this.changeStation(value);
                    }
                },

                // æ‡‰ç”¨è‡ªè¨‚ç«™é»ID
                applyCustomStation() {
                    if (!this.customStationNumber || !this.customStationNumber.trim()) {
                        this.toast('è«‹è¼¸å…¥ç«™é»ç·¨è™Ÿ', 'error');
                        return;
                    }

                    // Validate number format (digits only, padded with leading zeros)
                    const number = this.customStationNumber.trim();
                    if (!/^\d+$/.test(number)) {
                        this.toast('ç·¨è™Ÿåªèƒ½åŒ…å«æ•¸å­—', 'error');
                        return;
                    }

                    // Pad number with leading zeros to 2 digits
                    const paddedNumber = number.padStart(2, '0');

                    // Generate station ID based on type
                    let stationId;
                    if (this.customStationType === 'LOG') {
                        // LOG stations use different format: LOG-XXX or LOG-HUB
                        if (paddedNumber === '01') {
                            stationId = 'LOG-HUB'; // Special case for main hub
                        } else {
                            stationId = `LOG-${paddedNumber}`;
                        }
                    } else {
                        stationId = `${this.customStationType}-${paddedNumber}`;
                    }

                    this.showCustomStationInput = false;
                    this.customStationNumber = '';
                    this.changeStation(stationId);
                },

                // ç¢ºä¿itemså·²è¼‰å…¥ (ç”¨æ–¼æœå°‹è€—æåŠŸèƒ½)
                async ensureItemsLoaded() {
                    if (!this.dataLoaded.items || this.items.length === 0) {
                        await this.loadItems();
                        this.dataLoaded.items = true;
                    }
                },

                // è¼‰å…¥çµ±è¨ˆ
                async loadStats() {
                    try {
                        const url = this.stationId
                            ? `${this.apiUrl}/stats?station_id=${this.stationId}`
                            : `${this.apiUrl}/stats`;
                        const response = await fetch(url);
                        if (response.ok) {
                            this.stats = await response.json();
                            console.log(`âœ“ çµ±è¨ˆå·²è¼‰å…¥ (ç«™é»: ${this.stationId}):`, this.stats);
                        }
                    } catch (error) {
                        console.error('è¼‰å…¥çµ±è¨ˆå¤±æ•—:', error);
                    }
                },

                // è¼‰å…¥ç‰©å“
                async loadItems() {
                    try {
                        const response = await fetch(`${this.apiUrl}/items`);
                        if (response.ok) {
                            const data = await response.json();
                            this.items = data.items;
                            this.filteredItems = data.items;
                        }
                    } catch (error) {
                        console.error('è¼‰å…¥ç‰©å“å¤±æ•—:', error);
                        this.toast('è¼‰å…¥ç‰©å“å¤±æ•—', 'error');
                    }
                },

                // ç¯©é¸ç‰©å“ (v1.4.2-plus: æ”¯æ´è—¥å“/è€—æ/è©¦åŠ‘åˆ†é¡ç¯©é¸)
                filterItems() {
                    let result = this.items;

                    // åˆ†é¡ç¯©é¸
                    // - è—¥å“ = MED- é–‹é ­
                    // - è©¦åŠ‘ = REA- é–‹é ­ (æª¢é©—ç§‘ç®¡ç†)
                    // - è€—æ = é MED- ä¸”é REA- é–‹é ­ (è­·ç†ç®¡ç†)
                    if (this.itemCategoryFilter === 'medicine') {
                        result = result.filter(item => item.code.startsWith('MED-'));
                    } else if (this.itemCategoryFilter === 'reagent') {
                        result = result.filter(item => item.code.startsWith('REA-'));
                    } else if (this.itemCategoryFilter === 'consumable') {
                        result = result.filter(item => !item.code.startsWith('MED-') && !item.code.startsWith('REA-'));
                    }

                    // æ–‡å­—æœå°‹
                    const searchText = this.itemSearchText.toLowerCase();
                    if (searchText) {
                        result = result.filter(item =>
                            item.code.toLowerCase().includes(searchText) ||
                            item.name.toLowerCase().includes(searchText) ||
                            item.category.toLowerCase().includes(searchText)
                        );
                    }

                    this.filteredItems = result;
                },

                // åŒ¯å‡ºåº«å­˜CSV
                exportInventoryCSV() {
                    const url = `${this.apiUrl}/inventory/export/csv`;
                    window.open(url, '_blank');
                    this.toast('CSV åŒ¯å‡ºæˆåŠŸ', 'success');
                },

                // åŒ¯å‡ºåº«å­˜JSON
                exportInventoryJSON() {
                    const url = `${this.apiUrl}/inventory/export/json`;
                    window.open(url, '_blank');
                    this.toast('JSON åŒ¯å‡ºæˆåŠŸ', 'success');
                },

                // å‡ç´šè‡³å¤šç«™ç‰ˆ - åŒ¯å‡ºå®Œæ•´è³‡æ–™
                async exportUpgradeData() {
                    try {
                        this.toast('æ­£åœ¨æº–å‚™åŒ¯å‡ºè³‡æ–™...', 'info');

                        const url = `${this.apiUrl}/export/upgrade-package`;
                        const response = await fetch(url);

                        if (response.ok) {
                            const blob = await response.blob();
                            const filename = `mirs_upgrade_${this.stationId}_${new Date().toISOString().slice(0,10)}.zip`;

                            // å»ºç«‹ä¸‹è¼‰é€£çµ
                            const downloadUrl = window.URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = downloadUrl;
                            a.download = filename;
                            document.body.appendChild(a);
                            a.click();
                            document.body.removeChild(a);
                            window.URL.revokeObjectURL(downloadUrl);

                            this.toast('å‡ç´šè³‡æ–™åŒ¯å‡ºæˆåŠŸï¼è«‹å¦¥å–„ä¿å­˜æ­¤æª”æ¡ˆ', 'success');
                        } else {
                            const data = await response.json();
                            this.toast(data.detail || 'åŒ¯å‡ºå¤±æ•—', 'error');
                        }
                    } catch (error) {
                        console.error('åŒ¯å‡ºå‡ç´šè³‡æ–™å¤±æ•—:', error);
                        this.toast('åŒ¯å‡ºå‡ç´šè³‡æ–™å¤±æ•—', 'error');
                    }
                },

                // æ–°å¢ç‰©å“
                async submitAddItem() {
                    try {
                        const response = await fetch(`${this.apiUrl}/items`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(this.addItemForm)
                        });
                        
                        const data = await response.json();
                        
                        if (response.ok) {
                            this.toast(data.message || 'ç‰©å“æ–°å¢æˆåŠŸ', 'success');
                            this.showAddItemModal = false;
                            this.resetAddItemForm();
                            await this.loadItems();
                            await this.loadStats();
                        } else {
                            this.toast(data.detail || 'æ–°å¢å¤±æ•—', 'error');
                        }
                    } catch (error) {
                        console.error('æ–°å¢ç‰©å“å¤±æ•—:', error);
                        this.toast('æ–°å¢ç‰©å“å¤±æ•—', 'error');
                    }
                },

                resetAddItemForm() {
                    this.addItemForm = {
                        code: '',
                        name: '',
                        unit: 'EA',
                        minStock: 10,
                        category: 'å…¶ä»–'
                    };
                },

                // ç·¨è¼¯ç‰©å“
                editItem(item) {
                    this.editItemForm = {
                        code: item.code,
                        name: item.name,
                        unit: item.unit,
                        minStock: item.min_stock,
                        category: item.category
                    };
                    this.showEditItemModal = true;
                },

                async submitEditItem() {
                    try {
                        const response = await fetch(`${this.apiUrl}/items/${this.editItemForm.code}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                name: this.editItemForm.name,
                                unit: this.editItemForm.unit,
                                minStock: this.editItemForm.minStock,
                                category: this.editItemForm.category
                            })
                        });
                        
                        const data = await response.json();
                        
                        if (response.ok) {
                            this.toast(data.message || 'ç‰©å“æ›´æ–°æˆåŠŸ', 'success');
                            this.showEditItemModal = false;
                            await this.loadItems();
                        } else {
                            this.toast(data.detail || 'æ›´æ–°å¤±æ•—', 'error');
                        }
                    } catch (error) {
                        console.error('æ›´æ–°ç‰©å“å¤±æ•—:', error);
                        this.toast('æ›´æ–°ç‰©å“å¤±æ•—', 'error');
                    }
                },

                // åˆªé™¤ç‰©å“
                async deleteItem(code, name) {
                    if (!confirm(`ç¢ºå®šè¦åˆªé™¤ç‰©å“ã€Œ${name}ã€å—?`)) return;
                    
                    try {
                        const response = await fetch(`${this.apiUrl}/items/${code}`, {
                            method: 'DELETE'
                        });
                        
                        const data = await response.json();
                        
                        if (response.ok) {
                            this.toast(data.message || 'ç‰©å“å·²åˆªé™¤', 'success');
                            await this.loadItems();
                            await this.loadStats();
                        } else {
                            this.toast(data.detail || 'åˆªé™¤å¤±æ•—', 'error');
                        }
                    } catch (error) {
                        console.error('åˆªé™¤ç‰©å“å¤±æ•—:', error);
                        this.toast('åˆªé™¤ç‰©å“å¤±æ•—', 'error');
                    }
                },

                // é€²è²¨
                async submitReceive() {
                    try {
                        const response = await fetch(`${this.apiUrl}/receive`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(this.receiveForm)
                        });
                        
                        const data = await response.json();
                        
                        if (response.ok) {
                            this.toast(data.message || 'é€²è²¨è¨˜éŒ„æˆåŠŸ', 'success');
                            this.resetReceiveForm();
                            await this.loadItems();
                            await this.loadStats();
                        } else {
                            this.toast(data.detail || 'é€²è²¨å¤±æ•—', 'error');
                        }
                    } catch (error) {
                        console.error('é€²è²¨å¤±æ•—:', error);
                        this.toast('é€²è²¨å¤±æ•—', 'error');
                    }
                },

                resetReceiveForm() {
                    this.receiveForm = {
                        itemCode: '',
                        quantity: 1,
                        batchNumber: '',
                        expiryDate: '',
                        remarks: '',
                        stationId: this.stationId
                    };
                    this.receiveItemSearch = '';
                },

                // é€²è²¨é é¢ - ç‰©å“æœå°‹
                filterReceiveItems() {
                    const searchText = this.receiveItemSearch.toLowerCase();
                    if (!searchText) {
                        this.filteredReceiveItems = this.items;
                    } else {
                        this.filteredReceiveItems = this.items.filter(item =>
                            item.code.toLowerCase().includes(searchText) ||
                            item.name.toLowerCase().includes(searchText)
                        );
                    }
                },

                // é€²è²¨é é¢ - é¸æ“‡ç‰©å“
                selectReceiveItem(item) {
                    this.receiveForm.itemCode = item.code;
                    this.receiveItemSearch = `${item.code} - ${item.name}`;
                    this.showReceiveDropdown = false;
                },

                // è¼‰å…¥é€²è²¨è¨˜éŒ„
                async loadReceiveHistory() {
                    try {
                        let url = `${this.apiUrl}/inventory/events?event_type=RECEIVE&limit=100`;

                        if (this.receiveHistorySearch.startDate) {
                            url += `&start_date=${this.receiveHistorySearch.startDate}`;
                        }
                        if (this.receiveHistorySearch.endDate) {
                            url += `&end_date=${this.receiveHistorySearch.endDate}`;
                        }
                        if (this.receiveHistorySearch.itemCode) {
                            url += `&item_code=${encodeURIComponent(this.receiveHistorySearch.itemCode)}`;
                        }

                        const response = await fetch(url);
                        if (response.ok) {
                            const data = await response.json();
                            this.receiveHistory = data.events;
                        }
                    } catch (error) {
                        console.error('è¼‰å…¥é€²è²¨è¨˜éŒ„å¤±æ•—:', error);
                        this.toast('è¼‰å…¥é€²è²¨è¨˜éŒ„å¤±æ•—', 'error');
                    }
                },

                // åŒ¯å‡ºé€²è²¨è¨˜éŒ„
                exportReceiveHistoryCSV() {
                    let url = `${this.apiUrl}/inventory/events/export/csv?event_type=RECEIVE`;

                    if (this.receiveHistorySearch.startDate) {
                        url += `&start_date=${this.receiveHistorySearch.startDate}`;
                    }
                    if (this.receiveHistorySearch.endDate) {
                        url += `&end_date=${this.receiveHistorySearch.endDate}`;
                    }

                    window.open(url, '_blank');
                    this.toast('é€²è²¨è¨˜éŒ„åŒ¯å‡ºæˆåŠŸ', 'success');
                },

                // v3.0: æ¶ˆè€—è¼¸å…¥æ–¹æ³•å·²ç§»é™¤ (é·ç§»è‡³ Nursing PWA)
                // - submitConsume, resetConsumeForm
                // - addBatchConsumeItem, removeBatchConsumeItem
                // - filterBatchConsumeItems, selectBatchConsumeItem
                // - submitBatchConsume, resetBatchConsumeForm

                // è¼‰å…¥æ¶ˆè€—è¨˜éŒ„ (å”¯è®€)
                async loadConsumeHistory() {
                    try {
                        let url = `${this.apiUrl}/inventory/events?event_type=CONSUME&limit=100`;

                        if (this.consumeHistorySearch.startDate) {
                            url += `&start_date=${this.consumeHistorySearch.startDate}`;
                        }
                        if (this.consumeHistorySearch.endDate) {
                            url += `&end_date=${this.consumeHistorySearch.endDate}`;
                        }
                        if (this.consumeHistorySearch.itemCode) {
                            url += `&item_code=${encodeURIComponent(this.consumeHistorySearch.itemCode)}`;
                        }

                        const response = await fetch(url);
                        if (response.ok) {
                            const data = await response.json();
                            this.consumeHistory = data.events;
                        }
                    } catch (error) {
                        console.error('è¼‰å…¥æ¶ˆè€—è¨˜éŒ„å¤±æ•—:', error);
                        this.toast('è¼‰å…¥æ¶ˆè€—è¨˜éŒ„å¤±æ•—', 'error');
                    }
                },

                // æŸ¥çœ‹æ¶ˆè€—è©³æƒ…
                viewConsumeDetail(event) {
                    this.selectedConsumeEvent = event;
                    this.showConsumeDetailModal = true;
                },

                // è¼‰å…¥è¡€åº«æ­·å²è¨˜éŒ„
                async loadBloodHistory() {
                    try {
                        let url = `${this.apiUrl}/blood/events?station_id=${this.stationId}`;

                        // æ·»åŠ ç¯©é¸æ¢ä»¶
                        if (this.bloodHistorySearch.startDate) {
                            url += `&start_date=${this.bloodHistorySearch.startDate}`;
                        }
                        if (this.bloodHistorySearch.endDate) {
                            url += `&end_date=${this.bloodHistorySearch.endDate}`;
                        }
                        if (this.bloodHistorySearch.bloodType) {
                            url += `&blood_type=${this.bloodHistorySearch.bloodType}`;
                        }
                        if (this.bloodHistorySearch.eventType) {
                            url += `&event_type=${this.bloodHistorySearch.eventType}`;
                        }

                        const response = await fetch(url);
                        const data = await response.json();

                        if (data.status === 'success') {
                            this.bloodHistory = data.data || [];
                        } else {
                            this.toast('è¼‰å…¥è¡€åº«æ­·å²è¨˜éŒ„å¤±æ•—', 'error');
                        }
                    } catch (error) {
                        console.error('è¼‰å…¥è¡€åº«æ­·å²è¨˜éŒ„éŒ¯èª¤:', error);
                        this.toast('è¼‰å…¥è¡€åº«æ­·å²è¨˜éŒ„éŒ¯èª¤', 'error');
                    }
                },

                // æŸ¥çœ‹è¡€æ¶²è¨˜éŒ„è©³æƒ…
                viewBloodDetail(record) {
                    this.selectedBloodRecord = record;
                    // å¯ä»¥æ“´å±•ç‚ºé¡¯ç¤ºè©³æƒ… Modal
                    let detailText = `
=== è¡€åº«è¨˜éŒ„è©³æƒ… ===
é¡å‹: ${record.event_type === 'RECEIVE' ? 'å…¥åº«' : 'å‡ºåº«'}
è¡€å‹: ${record.blood_type}
æ•¸é‡: ${record.quantity} U
æ™‚é–“: ${new Date(record.timestamp).toLocaleString('zh-TW')}
æ“ä½œå“¡: ${record.operator}
å‚™è¨»: ${record.remarks || 'ç„¡'}
`;

                    // å¦‚æœæœ‰æè¡€è€…è³‡è¨Šï¼ˆWalking Blood Bankï¼‰
                    if (record.donor_name || record.donor_phone) {
                        detailText += `\n--- ç·Šæ€¥æè¡€è€…è³‡è¨Š ---\n`;
                        if (record.donor_name) detailText += `å§“å: ${record.donor_name}\n`;
                        if (record.donor_phone) detailText += `é›»è©±: ${record.donor_phone}\n`;
                    }

                    // å¦‚æœæœ‰ç—…æ‚£è³‡è¨Šï¼ˆå‡ºåº«è¨˜éŒ„ï¼‰
                    if (record.patient_name) {
                        detailText += `\n--- ç—…æ‚£è³‡è¨Š ---\n`;
                        detailText += `å§“å: ${record.patient_name}\n`;
                        if (record.patient_id) detailText += `ç—…æ­·è™Ÿ: ${record.patient_id}\n`;
                        if (record.diagnosis) detailText += `è¨ºæ–·: ${record.diagnosis}\n`;
                    }

                    alert(detailText);
                },

                // åŒ¯å‡ºè¡€åº«æ­·å²è¨˜éŒ„ CSV
                exportBloodHistoryCSV() {
                    let url = `${this.apiUrl}/blood/events/export/csv?station_id=${this.stationId}`;

                    if (this.bloodHistorySearch.startDate) {
                        url += `&start_date=${this.bloodHistorySearch.startDate}`;
                    }
                    if (this.bloodHistorySearch.endDate) {
                        url += `&end_date=${this.bloodHistorySearch.endDate}`;
                    }
                    if (this.bloodHistorySearch.bloodType) {
                        url += `&blood_type=${this.bloodHistorySearch.bloodType}`;
                    }
                    if (this.bloodHistorySearch.eventType) {
                        url += `&event_type=${this.bloodHistorySearch.eventType}`;
                    }

                    window.open(url, '_blank');
                    this.toast('è¡€åº«è¨˜éŒ„åŒ¯å‡ºæˆåŠŸ', 'success');
                },

                // ========== åº«å­˜ç›¤é»æ ¸å°è¨˜éŒ„ (v0.7) ==========
                async loadInventoryCheckHistory() {
                    try {
                        let url = `${this.apiUrl}/inventory-check/history`;
                        const params = [];

                        if (this.inventoryCheckSearch.startDate) {
                            params.push(`from_date=${this.inventoryCheckSearch.startDate}`);
                        }
                        if (this.inventoryCheckSearch.endDate) {
                            params.push(`to_date=${this.inventoryCheckSearch.endDate}`);
                        }
                        if (this.inventoryCheckSearch.status) {
                            params.push(`status=${this.inventoryCheckSearch.status}`);
                        }
                        if (params.length > 0) {
                            url += '?' + params.join('&');
                        }

                        const response = await fetch(url);
                        if (response.ok) {
                            const data = await response.json();
                            this.inventoryCheckHistory = data.checks || [];

                            // è¨ˆç®—çµ±è¨ˆ
                            this.inventoryCheckStats = {
                                totalChecks: this.inventoryCheckHistory.length,
                                totalConfirmed: this.inventoryCheckHistory.reduce((sum, c) => sum + (c.confirmed_count || 0), 0),
                                totalErrors: this.inventoryCheckHistory.reduce((sum, c) => sum + (c.error_count || 0), 0),
                                pendingErrors: this.inventoryCheckHistory.reduce((sum, c) => sum + (c.errors_pending || 0), 0)
                            };

                            console.log('âœ“ ç›¤é»è¨˜éŒ„å·²è¼‰å…¥:', this.inventoryCheckHistory.length, 'ç­†');
                        } else {
                            // API å°šæœªå¯¦ä½œæ™‚ä½¿ç”¨æ¨¡æ“¬è³‡æ–™
                            console.log('ç›¤é»è¨˜éŒ„ API å°šæœªå¯¦ä½œï¼Œä½¿ç”¨æœ¬åœ°è¨˜éŒ„');
                            this.loadLocalInventoryChecks();
                        }
                    } catch (error) {
                        console.error('è¼‰å…¥ç›¤é»è¨˜éŒ„å¤±æ•—:', error);
                        this.loadLocalInventoryChecks();
                    }
                },

                loadLocalInventoryChecks() {
                    // å¾ localStorage è¼‰å…¥æœ¬åœ°æš«å­˜çš„ç›¤é»è¨˜éŒ„
                    const saved = localStorage.getItem('mirs_inventory_check_history');
                    if (saved) {
                        try {
                            this.inventoryCheckHistory = JSON.parse(saved);
                            this.inventoryCheckStats = {
                                totalChecks: this.inventoryCheckHistory.length,
                                totalConfirmed: this.inventoryCheckHistory.reduce((sum, c) => sum + (c.confirmed_count || 0), 0),
                                totalErrors: this.inventoryCheckHistory.reduce((sum, c) => sum + (c.error_count || 0), 0),
                                pendingErrors: this.inventoryCheckHistory.reduce((sum, c) => sum + (c.errors_pending || 0), 0)
                            };
                        } catch (e) {
                            this.inventoryCheckHistory = [];
                        }
                    } else {
                        this.inventoryCheckHistory = [];
                        this.inventoryCheckStats = { totalChecks: 0, totalConfirmed: 0, totalErrors: 0, pendingErrors: 0 };
                    }
                },

                viewInventoryCheckDetail(check) {
                    this.selectedInventoryCheck = check;
                    this.showInventoryCheckDetailModal = true;
                },

                async resolveInventoryError(checkId, itemCode) {
                    const notes = prompt('è«‹è¼¸å…¥è™•ç†èªªæ˜ï¼š');
                    if (notes === null) return;

                    try {
                        const response = await fetch(`${this.apiUrl}/inventory-check/resolve-error`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                check_id: checkId,
                                item_code: itemCode,
                                resolution: 'ADJUSTED',
                                resolver_name: this.currentUser || 'Admin',
                                notes: notes || 'å·²è™•ç†'
                            })
                        });

                        if (response.ok) {
                            this.toast('éŒ¯èª¤é …ç›®å·²è™•ç†', 'success');
                            // æ›´æ–°æœ¬åœ°ç‹€æ…‹
                            if (this.selectedInventoryCheck?.errors) {
                                const error = this.selectedInventoryCheck.errors.find(e => e.item_code === itemCode);
                                if (error) error.resolved = true;
                            }
                            await this.loadInventoryCheckHistory();
                        } else {
                            // API å°šæœªå¯¦ä½œæ™‚ï¼Œç›´æ¥æ›´æ–°æœ¬åœ°ç‹€æ…‹
                            if (this.selectedInventoryCheck?.errors) {
                                const error = this.selectedInventoryCheck.errors.find(e => e.item_code === itemCode);
                                if (error) error.resolved = true;
                            }
                            this.toast('éŒ¯èª¤é …ç›®å·²æ¨™è¨˜è™•ç†ï¼ˆæœ¬åœ°ï¼‰', 'success');
                        }
                    } catch (error) {
                        console.error('è™•ç†éŒ¯èª¤å¤±æ•—:', error);
                        // æœ¬åœ°è™•ç†
                        if (this.selectedInventoryCheck?.errors) {
                            const error = this.selectedInventoryCheck.errors.find(e => e.item_code === itemCode);
                            if (error) error.resolved = true;
                        }
                        this.toast('éŒ¯èª¤é …ç›®å·²æ¨™è¨˜è™•ç†ï¼ˆæœ¬åœ°ï¼‰', 'info');
                    }
                },

                exportInventoryCheckCSV() {
                    let url = `${this.apiUrl}/inventory-check/export/csv?station_id=${this.stationId}`;

                    if (this.inventoryCheckSearch.startDate) {
                        url += `&from_date=${this.inventoryCheckSearch.startDate}`;
                    }
                    if (this.inventoryCheckSearch.endDate) {
                        url += `&to_date=${this.inventoryCheckSearch.endDate}`;
                    }

                    window.open(url, '_blank');
                    this.toast('ç›¤é»è¨˜éŒ„åŒ¯å‡ºæˆåŠŸ', 'success');
                },

                // åŒ¯å‡ºæ¶ˆè€—è¨˜éŒ„
                exportConsumeHistoryCSV() {
                    let url = `${this.apiUrl}/inventory/events/export/csv?event_type=CONSUME`;

                    if (this.consumeHistorySearch.startDate) {
                        url += `&start_date=${this.consumeHistorySearch.startDate}`;
                    }
                    if (this.consumeHistorySearch.endDate) {
                        url += `&end_date=${this.consumeHistorySearch.endDate}`;
                    }

                    window.open(url, '_blank');
                    this.toast('æ¶ˆè€—è¨˜éŒ„åŒ¯å‡ºæˆåŠŸ', 'success');
                },

                // è¡€è¢‹
                async loadBloodInventory() {
                    try {
                        // Add cache busting for Safari
                        const timestamp = new Date().getTime();
                        const response = await fetch(`${this.apiUrl}/blood/inventory?_t=${timestamp}`, {
                            cache: 'no-cache',
                            headers: {
                                'Cache-Control': 'no-cache',
                                'Pragma': 'no-cache'
                            }
                        });
                        if (response.ok) {
                            const data = await response.json();
                            console.log('API Response:', data);
                            console.log('Current station:', this.stationId);

                            // Filter by current station only
                            const stationBlood = data.bloodInventory.filter(b => b.station_id === this.stationId);
                            console.log('Filtered blood for station:', stationBlood);

                            // Ensure all blood types are present with at least 0 quantity
                            const allBloodTypes = ['A+', 'A-', 'B+', 'B-', 'O+', 'O-', 'AB+', 'AB-'];
                            this.bloodInventory = allBloodTypes.map(type => {
                                const existing = stationBlood.find(b => b.blood_type === type);
                                return existing || {
                                    blood_type: type,
                                    quantity: 0,
                                    station_id: this.stationId
                                };
                            });

                            console.log('âœ“ è¡€è¢‹åº«å­˜å·²è¼‰å…¥:', this.bloodInventory.length, 'ç­†', `(ç«™é»: ${this.stationId})`);
                            console.log('Blood inventory array:', JSON.stringify(this.bloodInventory));

                            // Force Alpine.js to reactively update
                            this.$nextTick(() => {
                                console.log('Next tick - blood inventory updated');
                            });
                        } else {
                            console.error('è¡€è¢‹åº«å­˜APIéŒ¯èª¤:', response.status);
                        }
                    } catch (error) {
                        console.error('è¼‰å…¥è¡€è¢‹åº«å­˜å¤±æ•—:', error);
                    }
                },

                async submitBloodReceive() {
                    try {
                        const response = await fetch(`${this.apiUrl}/blood/receive`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(this.bloodReceiveForm)
                        });

                        const data = await response.json();

                        if (response.ok) {
                            this.toast(data.message || 'è¡€è¢‹å…¥åº«æˆåŠŸ', 'success');
                            this.bloodReceiveForm = {
                                bloodType: '',
                                quantity: 1,
                                remarks: '',
                                source: 'blood_center',
                                donorName: '',
                                donorPhone: '',
                                stationId: this.stationId
                            };
                            await this.loadBloodInventory();
                            await this.loadBloodBags();  // åˆ·æ–°å€‹åˆ¥è¡€è¢‹åˆ—è¡¨
                            await this.loadStats();
                        } else {
                            this.toast(data.detail || 'å…¥åº«å¤±æ•—', 'error');
                        }
                    } catch (error) {
                        console.error('è¡€è¢‹å…¥åº«å¤±æ•—:', error);
                        this.toast('è¡€è¢‹å…¥åº«å¤±æ•—', 'error');
                    }
                },

                printBloodLabel() {
                    // æª¢æŸ¥å¿…å¡«æ¬„ä½
                    if (!this.bloodReceiveForm.bloodType) {
                        this.toast('è«‹é¸æ“‡è¡€å‹', 'error');
                        return;
                    }
                    if (!this.bloodReceiveForm.quantity || this.bloodReceiveForm.quantity < 1) {
                        this.toast('è«‹è¼¸å…¥æœ‰æ•ˆæ•¸é‡', 'error');
                        return;
                    }

                    // æ§‹å»ºURLåƒæ•¸
                    const params = new URLSearchParams({
                        blood_type: this.bloodReceiveForm.bloodType,
                        quantity: this.bloodReceiveForm.quantity,
                        station_id: this.stationId,
                        remarks: this.bloodReceiveForm.remarks || ''
                    });

                    // é–‹å•Ÿåˆ—å°æ¨™ç±¤é é¢
                    window.open(`${this.apiUrl}/blood/label?${params.toString()}`, '_blank');
                    this.toast('æ­£åœ¨é–‹å•Ÿæ¨™ç±¤åˆ—å°...', 'info');
                },

                printBloodLabelFromHistory(record) {
                    // å¾æ­·å²è¨˜éŒ„åˆ—å°æ¨™ç±¤
                    const params = new URLSearchParams({
                        blood_type: record.blood_type,
                        quantity: Math.abs(record.quantity),
                        station_id: record.station_id,
                        remarks: record.remarks || ''
                    });

                    // é–‹å•Ÿåˆ—å°æ¨™ç±¤é é¢
                    window.open(`${this.apiUrl}/blood/label?${params.toString()}`, '_blank');
                    this.toast('æ­£åœ¨é–‹å•Ÿæ¨™ç±¤åˆ—å°...', 'info');
                },

                async submitBloodConsume() {
                    // v1.4.2-plus: æ”¹ç‚ºé–‹å•Ÿè¡€è¢‹é¸æ“‡æ¨¡æ…‹çª—
                    if (!this.bloodConsumeForm.bloodType) {
                        this.toast('è«‹é¸æ“‡è¡€å‹', 'error');
                        return;
                    }
                    if (!this.bloodConsumeForm.patientName) {
                        this.toast('è«‹è¼¸å…¥ç—…æ‚£å§“å', 'error');
                        return;
                    }

                    // è¼‰å…¥è©²è¡€å‹çš„å¯ç”¨è¡€è¢‹
                    try {
                        const response = await fetch(`${this.apiUrl}/blood-bags/list?blood_type=${encodeURIComponent(this.bloodConsumeForm.bloodType)}&status=AVAILABLE`);
                        if (response.ok) {
                            const data = await response.json();
                            this.availableBagsForConsume = data.bags || [];
                            this.selectedBagsForConsume = [];
                            this.showBloodBagSelectModal = true;
                        } else {
                            this.toast('ç„¡æ³•è¼‰å…¥è¡€è¢‹åˆ—è¡¨', 'error');
                        }
                    } catch (error) {
                        console.error('è¼‰å…¥è¡€è¢‹å¤±æ•—:', error);
                        this.toast('è¼‰å…¥è¡€è¢‹å¤±æ•—', 'error');
                    }
                },

                async confirmBloodBagConsume() {
                    // v1.4.2-plus: ç¢ºèªå‡ºåº«é¸ä¸­çš„è¡€è¢‹
                    if (this.selectedBagsForConsume.length === 0) {
                        this.toast('è«‹é¸æ“‡è¦å‡ºåº«çš„è¡€è¢‹', 'error');
                        return;
                    }

                    try {
                        const response = await fetch(`${this.apiUrl}/blood-bags/consume`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                bagCodes: this.selectedBagsForConsume,
                                patientName: this.bloodConsumeForm.patientName,
                                patientId: this.bloodConsumeForm.patientId || '',
                                purpose: this.bloodConsumeForm.purpose || '',
                                stationId: this.bloodConsumeForm.stationId
                            })
                        });

                        const data = await response.json();

                        if (response.ok) {
                            this.toast(data.message || `æˆåŠŸå‡ºåº« ${this.selectedBagsForConsume.length} è¢‹è¡€è¢‹`, 'success');
                            this.showBloodBagSelectModal = false;
                            this.bloodConsumeForm = { bloodType: '', quantity: 1, patientName: '', patientId: '', purpose: '', stationId: this.stationId };
                            this.selectedBagsForConsume = [];
                            await this.loadBloodInventory();
                            await this.loadBloodBags();
                            await this.loadStats();
                        } else {
                            this.toast(data.detail || 'å‡ºåº«å¤±æ•—', 'error');
                        }
                    } catch (error) {
                        console.error('è¡€è¢‹å‡ºåº«å¤±æ•—:', error);
                        this.toast('è¡€è¢‹å‡ºåº«å¤±æ•—', 'error');
                    }
                },

                async submitBloodTransfer() {
                    try {
                        // é©—è­‰å¿…å¡«æ¬„ä½
                        if (!this.bloodTransferForm.sourceStationId || !this.bloodTransferForm.targetStationId) {
                            this.toast('è«‹è¼¸å…¥ä¾†æºç«™é»å’Œç›®æ¨™ç«™é»', 'error');
                            return;
                        }
                        if (this.bloodTransferForm.sourceStationId === this.bloodTransferForm.targetStationId) {
                            this.toast('ä¾†æºç«™é»èˆ‡ç›®æ¨™ç«™é»ä¸èƒ½ç›¸åŒ', 'error');
                            return;
                        }
                        if (!this.bloodTransferForm.bloodType) {
                            this.toast('è«‹é¸æ“‡è¡€å‹', 'error');
                            return;
                        }

                        const response = await fetch(`${this.apiUrl}/blood/transfer`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(this.bloodTransferForm)
                        });

                        const data = await response.json();

                        if (response.ok) {
                            this.toast(data.message || 'è¡€è¢‹è½‰ç§»æˆåŠŸ', 'success');
                            // é‡ç½®è¡¨å–®
                            this.bloodTransferForm = {
                                sourceStationId: 'HC-000000',
                                targetStationId: '',
                                bloodType: '',
                                quantity: 1,
                                operator: 'SYSTEM',
                                remarks: ''
                            };
                            await this.loadBloodInventory();
                            await this.loadStats();
                        } else {
                            this.toast(data.detail || 'è½‰ç§»å¤±æ•—', 'error');
                        }
                    } catch (error) {
                        console.error('è¡€è¢‹ç«™é»è½‰ç§»å¤±æ•—:', error);
                        this.toast('è¡€è¢‹ç«™é»è½‰ç§»å¤±æ•—', 'error');
                    }
                },

                // ========== å€‹åˆ¥è¡€è¢‹è¿½è¹¤ (v1.4.2-plus) ==========
                async loadBloodBags() {
                    try {
                        const response = await fetch(`${this.apiUrl}/blood-bags/list?status=AVAILABLE`);
                        if (response.ok) {
                            const data = await response.json();
                            this.bloodBags = data.bags || [];
                            console.log('âœ“ è¡€è¢‹å·²è¼‰å…¥:', this.bloodBags.length, 'è¢‹');
                        }
                    } catch (error) {
                        console.error('è¼‰å…¥è¡€è¢‹å¤±æ•—:', error);
                    }
                },

                async createBloodBag() {
                    if (!this.bloodBagForm.blood_type) {
                        this.toast('è«‹é¸æ“‡è¡€å‹', 'error');
                        return;
                    }

                    try {
                        const response = await fetch(`${this.apiUrl}/blood-bags/create`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                blood_type: this.bloodBagForm.blood_type,
                                volume_ml: parseInt(this.bloodBagForm.volume_ml) || 250,
                                collection_date: this.bloodBagForm.collection_date || null,
                                expiry_date: this.bloodBagForm.expiry_date || null,
                                donor_info: this.bloodBagForm.donor_info || null
                            })
                        });

                        const data = await response.json();

                        if (response.ok) {
                            this.toast(`è¡€è¢‹å»ºç«‹æˆåŠŸ: ${data.bag_code}`, 'success');
                            this.bloodBagForm = { blood_type: '', volume_ml: 250, collection_date: '', expiry_date: '', donor_info: '' };
                            await this.loadBloodBags();
                            await this.loadBloodInventory();
                            await this.loadStats();
                        } else {
                            this.toast(data.detail || 'å»ºç«‹å¤±æ•—', 'error');
                        }
                    } catch (error) {
                        console.error('å»ºç«‹è¡€è¢‹å¤±æ•—:', error);
                        this.toast('å»ºç«‹è¡€è¢‹å¤±æ•—', 'error');
                    }
                },

                async useBloodBag(bagCode) {
                    const patientName = prompt('è«‹è¼¸å…¥ä½¿ç”¨è€…/ç—…æ‚£å§“å:');
                    if (!patientName) return;

                    try {
                        const response = await fetch(`${this.apiUrl}/blood-bags/use`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                bagCode: bagCode,
                                usedFor: patientName
                            })
                        });

                        const data = await response.json();

                        if (response.ok) {
                            this.toast(data.message || 'è¡€è¢‹å·²æ¨™è¨˜ç‚ºä½¿ç”¨', 'success');
                            await this.loadBloodBags();
                            await this.loadBloodInventory();
                            await this.loadStats();
                        } else {
                            this.toast(data.detail || 'æ“ä½œå¤±æ•—', 'error');
                        }
                    } catch (error) {
                        console.error('ä½¿ç”¨è¡€è¢‹å¤±æ•—:', error);
                        this.toast('ä½¿ç”¨è¡€è¢‹å¤±æ•—', 'error');
                    }
                },

                async discardBloodBag(bagCode) {
                    const reasons = ['expired (éæœŸ)', 'damaged (æå£)', 'other (å…¶ä»–)'];
                    const reason = prompt(`è«‹é¸æ“‡ä¸Ÿæ£„åŸå› :\n1. éæœŸ\n2. æå£\n3. å…¶ä»–\n\nè«‹è¼¸å…¥ 1, 2, æˆ– 3:`);

                    if (!reason) return;

                    let reasonCode = 'other';
                    if (reason === '1') reasonCode = 'expired';
                    else if (reason === '2') reasonCode = 'damaged';
                    else if (reason === '3') reasonCode = 'other';

                    if (!confirm(`ç¢ºå®šè¦ä¸Ÿæ£„è¡€è¢‹ ${bagCode} å—ï¼Ÿ\nåŸå› : ${reasonCode}\n\næ­¤æ“ä½œç„¡æ³•å¾©åŸï¼`)) return;

                    try {
                        const response = await fetch(`${this.apiUrl}/blood-bags/discard`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                bagCode: bagCode,
                                reason: reasonCode
                            })
                        });

                        const data = await response.json();

                        if (response.ok) {
                            this.toast(data.message || 'è¡€è¢‹å·²æ¨™è¨˜ç‚ºä¸Ÿæ£„', 'success');
                            await this.loadBloodBags();
                            await this.loadBloodInventory();
                            await this.loadStats();
                        } else {
                            this.toast(data.detail || 'æ“ä½œå¤±æ•—', 'error');
                        }
                    } catch (error) {
                        console.error('ä¸Ÿæ£„è¡€è¢‹å¤±æ•—:', error);
                        this.toast('ä¸Ÿæ£„è¡€è¢‹å¤±æ•—', 'error');
                    }
                },

                printSingleBagLabel(bagCode) {
                    window.open(`${this.apiUrl}/blood-bags/print-labels/${bagCode}`, '_blank');
                    this.toast('æ­£åœ¨é–‹å•Ÿæ¨™ç±¤åˆ—å°...', 'info');
                },

                printSelectedBagLabels() {
                    if (this.selectedBagCodes.length === 0) {
                        this.toast('è«‹å…ˆé¸æ“‡è¡€è¢‹', 'error');
                        return;
                    }
                    const codes = this.selectedBagCodes.join(',');
                    window.open(`${this.apiUrl}/blood-bags/print-labels/${codes}`, '_blank');
                    this.toast(`æ­£åœ¨åˆ—å° ${this.selectedBagCodes.length} è¢‹æ¨™ç±¤...`, 'info');
                    this.selectedBagCodes = [];
                },

                toggleAllBags(checked) {
                    if (checked) {
                        this.selectedBagCodes = this.bloodBags.filter(b => b.status === 'AVAILABLE').map(b => b.bag_code);
                    } else {
                        this.selectedBagCodes = [];
                    }
                },

                async checkExpiringBags() {
                    try {
                        const response = await fetch(`${this.apiUrl}/blood-bags/expiring?days=7`);
                        if (response.ok) {
                            const data = await response.json();
                            const expiring = data.expiring_bags || [];
                            if (expiring.length === 0) {
                                this.toast('ç›®å‰ç„¡å³å°‡éæœŸçš„è¡€è¢‹', 'info');
                            } else {
                                alert(`å³æœŸè¡€è¢‹è­¦ç¤º (7å¤©å…§):\n\n${expiring.map(b => `${b.bag_code} (${b.blood_type}) - æ•ˆæœŸ: ${b.expiry_date}`).join('\n')}`);
                            }
                        }
                    } catch (error) {
                        console.error('æª¢æŸ¥å³æœŸè¡€è¢‹å¤±æ•—:', error);
                    }
                },

                isExpiringSoon(expiryDate) {
                    if (!expiryDate) return false;
                    const expiry = new Date(expiryDate);
                    const now = new Date();
                    const diffDays = (expiry - now) / (1000 * 60 * 60 * 24);
                    return diffDays <= 7 && diffDays >= 0;  // 7å¤©å…§å³å°‡éæœŸ
                },

                isExpired(expiryDate) {
                    if (!expiryDate) return false;
                    const expiry = new Date(expiryDate);
                    const now = new Date();
                    return expiry < now;  // å·²éæœŸ
                },

                // ========== è¨­å‚™ç®¡ç† (v2 API) ==========
                async loadEquipment() {
                    try {
                        // v2 API: ä½¿ç”¨ v_equipment_status View èšåˆè³‡æ–™
                        const response = await fetch(`${this.apiUrl}/v2/equipment`);
                        if (response.ok) {
                            const data = await response.json();
                            // v2 API returns: { equipment: [...], count: n }
                            // Each equipment has: id, name, type_code, type_name, category,
                            // resilience_category, unit_count, avg_level, checked_count, last_check, check_status
                            this.equipment = data.equipment.map(eq => ({
                                ...eq,
                                // v2 â†’ v1 field mapping for template compatibility
                                quantity: eq.unit_count,
                                power_level: eq.avg_level,
                                status: this.mapCheckStatusToLegacy(eq.check_status)
                            }));
                            console.log('âœ“ è¨­å‚™å·²è¼‰å…¥ (v2 API):', this.equipment.length, 'é …');
                            // é‡æ–°è¼‰å…¥çµ±è¨ˆæ•¸æ“šä»¥æ›´æ–°å¾…æª¢æŸ¥è¨­å‚™æ•¸é‡
                            await this.loadStats();
                        } else {
                            console.error('è¨­å‚™APIéŒ¯èª¤:', response.status);
                            this.toast('è¼‰å…¥è¨­å‚™å¤±æ•—', 'error');
                        }
                    } catch (error) {
                        console.error('è¼‰å…¥è¨­å‚™å¤±æ•—:', error);
                        this.toast('è¼‰å…¥è¨­å‚™å¤±æ•—', 'error');
                    }
                },

                // v2: å°‡ check_status æ˜ å°„åˆ°èˆŠç‰ˆ status é¡¯ç¤º
                mapCheckStatusToLegacy(checkStatus) {
                    const mapping = {
                        'CHECKED': 'NORMAL',
                        'PARTIAL': 'WARNING',
                        'UNCHECKED': 'UNCHECKED'
                    };
                    return mapping[checkStatus] || 'UNCHECKED';
                },

                async submitAddEquipment() {
                    try {
                        // Ensure station_id is set
                        const equipmentData = {
                            ...this.addEquipmentForm,
                            station_id: this.stationId
                        };

                        const response = await fetch(`${this.apiUrl}/equipment`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(equipmentData)
                        });
                        
                        const data = await response.json();
                        
                        if (response.ok) {
                            this.toast(data.message || 'è¨­å‚™æ–°å¢æˆåŠŸ', 'success');
                            this.showAddEquipmentModal = false;
                            this.resetAddEquipmentForm();
                            await this.loadEquipment();
                            await this.loadStats();
                        } else {
                            this.toast(data.detail || 'æ–°å¢å¤±æ•—', 'error');
                        }
                    } catch (error) {
                        console.error('æ–°å¢è¨­å‚™å¤±æ•—:', error);
                        this.toast('æ–°å¢è¨­å‚™å¤±æ•—', 'error');
                    }
                },

                resetAddEquipmentForm() {
                    this.addEquipmentForm = {
                        name: '',
                        category: 'å…¶ä»–',
                        quantity: 1,
                        remarks: ''
                    };
                },

                editEquipment(eq) {
                    this.editEquipmentForm = {
                        id: eq.id,
                        name: eq.name,
                        category: eq.category,
                        quantity: eq.quantity,
                        remarks: eq.remarks || ''
                    };
                    this.showEditEquipmentModal = true;
                },

                async submitEditEquipment() {
                    try {
                        const response = await fetch(`${this.apiUrl}/equipment/${this.editEquipmentForm.id}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                name: this.editEquipmentForm.name,
                                category: this.editEquipmentForm.category,
                                quantity: this.editEquipmentForm.quantity,
                                remarks: this.editEquipmentForm.remarks
                            })
                        });
                        
                        const data = await response.json();
                        
                        if (response.ok) {
                            this.toast(data.message || 'è¨­å‚™æ›´æ–°æˆåŠŸ', 'success');
                            this.showEditEquipmentModal = false;
                            await this.loadEquipment();
                        } else {
                            this.toast(data.detail || 'æ›´æ–°å¤±æ•—', 'error');
                        }
                    } catch (error) {
                        console.error('æ›´æ–°è¨­å‚™å¤±æ•—:', error);
                        this.toast('æ›´æ–°è¨­å‚™å¤±æ•—', 'error');
                    }
                },

                async deleteEquipment(id, name) {
                    if (!confirm(`ç¢ºå®šè¦åˆªé™¤è¨­å‚™ã€Œ${name}ã€å—?`)) return;
                    
                    try {
                        const response = await fetch(`${this.apiUrl}/equipment/${id}`, {
                            method: 'DELETE'
                        });
                        
                        const data = await response.json();
                        
                        if (response.ok) {
                            this.toast(data.message || 'è¨­å‚™å·²åˆªé™¤', 'success');
                            await this.loadEquipment();
                            await this.loadStats();
                        } else {
                            this.toast(data.detail || 'åˆªé™¤å¤±æ•—', 'error');
                        }
                    } catch (error) {
                        console.error('åˆªé™¤è¨­å‚™å¤±æ•—:', error);
                        this.toast('åˆªé™¤è¨­å‚™å¤±æ•—', 'error');
                    }
                },

                // è¨­å‚™æŒ‡æ¨™æ¨™ç±¤ (æ ¹æ“šè¨­å‚™é¡å‹é¡¯ç¤ºä¸åŒæ¨™ç±¤)
                getEquipmentMetricLabel(equipmentId) {
                    const labels = {
                        'RESP-001': 'æ°£é«”å­˜é‡ (0-100%)',      // æ°§æ°£é‹¼ç“¶
                        'EMER-EQ-006': 'æ°£é«”å­˜é‡ (0-100%)',   // æ°§æ°£ç“¶ E size
                        'UTIL-002': 'ç‡ƒæ²¹å­˜é‡ (0-100%)',      // ç™¼é›»æ©Ÿ
                        'UTIL-001': 'é›»æ± é›»é‡ (0-100%)',      // è¡Œå‹•é›»æºç«™
                        'EQ-010': 'é›»æ± é›»é‡ (0-100%)',        // è¡Œå‹•é›»æºç«™
                        'EMER-EQ-001': 'é›»æ± é›»é‡ (0-100%)',   // AED
                    };
                    return labels[equipmentId] || 'ç‹€æ…‹ç­‰ç´š (0-100%)';
                },

                // åˆ¤æ–·æ˜¯å¦ç‚ºéŸŒæ€§ç›¸é—œè¨­å‚™
                isResilienceEquipment(equipmentId) {
                    const resilienceEquipment = [
                        'RESP-001', 'RESP-002', 'EMER-EQ-006',  // æ°§æ°£ç›¸é—œ
                        'UTIL-001', 'UTIL-002', 'EQ-010'         // é›»åŠ›ç›¸é—œ
                    ];
                    return resilienceEquipment.includes(equipmentId);
                },

                // è¨ˆç®—è¨­å‚™éŸŒæ€§è²¢ç»æ™‚æ•¸
                calculateEquipmentHours(equipmentId, level) {
                    const capacity = {
                        'RESP-001': { hours: 20, label: 'æ°§æ°£' },       // æ°§æ°£é‹¼ç“¶: 100% = 20h
                        'EMER-EQ-006': { hours: 2.3, label: 'æ°§æ°£' },   // æ°§æ°£ç“¶E: 100% = 2.3h
                        'UTIL-002': { hours: 24, label: 'é›»åŠ›' },       // ç™¼é›»æ©Ÿ: 100% = 24h
                        'UTIL-001': { hours: 20, label: 'é›»åŠ›' },       // è¡Œå‹•é›»æºç«™: 100% = 20h
                        'EQ-010': { hours: 20, label: 'é›»åŠ›' }          // è¡Œå‹•é›»æºç«™: 100% = 20h
                    };
                    const config = capacity[equipmentId];
                    if (!config || !level) return 0;
                    return (level / 100 * config.hours).toFixed(1);
                },

                // å–å¾—éŸŒæ€§è¨­å‚™æ¸…å–® (ç”¨æ–¼éŸŒæ€§ä¼°ç®—Tabé¡¯ç¤º)
                getResilienceEquipment() {
                    const resilienceIds = ['RESP-001', 'RESP-002', 'EMER-EQ-006', 'UTIL-001', 'UTIL-002', 'EQ-010'];
                    return this.equipment.filter(eq => resilienceIds.includes(eq.id));
                },

                // è¨ˆç®—è¨­å‚™éŸŒæ€§æ™‚æ•¸ (ç”¨æ–¼éŸŒæ€§ä¼°ç®—Tabé¡¯ç¤º)
                getResilienceHours(eq) {
                    const hours = this.calculateEquipmentHours(eq.id, eq.power_level);
                    return hours > 0 ? hours : null;
                },

                // v1.2.6: å–å¾—é›»åŠ›å€ç‹€æ…‹
                getPowerStatus() {
                    const powerLifeline = (this.resilienceStatus.lifelines || []).find(l => l.type === 'POWER');
                    return powerLifeline?.status || 'UNKNOWN';
                },

                // v1.2.6: å–å¾—é›»åŠ›å€æ™‚æ•¸
                getPowerHours() {
                    const powerLifeline = (this.resilienceStatus.lifelines || []).find(l => l.type === 'POWER');
                    return powerLifeline?.endurance?.effective_hours || 0;
                },

                // v1.2.6: å–å¾—æ°§æ°£å€ç‹€æ…‹ (å–æœ€åš´é‡çš„)
                getOxygenStatus() {
                    const oxygenLifelines = (this.resilienceStatus.lifelines || []).filter(l => l.type === 'OXYGEN');
                    if (oxygenLifelines.some(l => l.status === 'CRITICAL')) return 'CRITICAL';
                    if (oxygenLifelines.some(l => l.status === 'WARNING')) return 'WARNING';
                    if (oxygenLifelines.some(l => l.status === 'SAFE')) return 'SAFE';
                    return 'UNKNOWN';
                },

                // v1.2.6: å–å¾—æ°§æ°£å€æ™‚æ•¸
                // v1.4.8: ä¿®æ­£é‚è¼¯ - æ’é™¤å—ä¾è³´é™åˆ¶çš„ä¾†æºï¼ˆå¦‚æ¿ƒç¸®æ©Ÿå—é›»åŠ›é™åˆ¶ï¼‰
                //         æ°§æ°£é‹¼ç“¶æ˜¯ç¨ç«‹ä¾†æºï¼Œæ‡‰é¡¯ç¤ºå…¶æ™‚æ•¸
                getOxygenHours() {
                    const oxygenLifelines = (this.resilienceStatus.lifelines || []).filter(l => l.type === 'OXYGEN');
                    // åªå–ç¨ç«‹ä¾†æºï¼ˆæ²’æœ‰ dependency æˆ– dependency.is_limiting ç‚º falseï¼‰
                    const independentHours = oxygenLifelines
                        .filter(l => !l.dependency || !l.dependency.is_limiting)
                        .map(l => l.endurance?.effective_hours)
                        .filter(h => h !== 'âˆ' && typeof h === 'number');
                    // å¦‚æœæœ‰ç¨ç«‹ä¾†æºï¼ŒåŠ ç¸½å®ƒå€‘ï¼›å¦å‰‡å–æ‰€æœ‰ä¾†æºçš„æœ€å¤§å€¼
                    if (independentHours.length > 0) {
                        return independentHours.reduce((sum, h) => sum + h, 0);
                    }
                    // Fallback: å–æœ€å¤§å€¼ï¼ˆé¿å… 0ï¼‰
                    const allHours = oxygenLifelines
                        .map(l => l.endurance?.effective_hours)
                        .filter(h => h !== 'âˆ' && typeof h === 'number');
                    return allHours.length > 0 ? Math.max(...allHours) : 0;
                },

                // v1.2.7: é–‹å•Ÿå–®ä½ç·¨è¼¯ Modal
                openUnitEditModal(item, unit, idx) {
                    // v2: ç›´æ¥ä½¿ç”¨ item.item_code ä½œç‚º equipment_id
                    const equipment_id = item.item_code || item.equipment_id || '';

                    this.unitEditForm = {
                        equipment_id: equipment_id,
                        unit_label: unit.label,
                        label: unit.label,
                        level: unit.level_percent ?? unit.level ?? 100,  // v2 ç›¸å®¹
                        status: unit.status,
                        checked: unit.checked || !!unit.last_check  // v2: æœ‰ last_check è¡¨ç¤ºå·²æª¢æŸ¥
                    };
                    this.showUnitEditModal = true;
                },

                // v1.2.7: å„²å­˜å–®ä½ç·¨è¼¯
                async submitUnitEdit() {
                    const payload = {
                        equipment_id: this.unitEditForm.equipment_id,
                        unit_label: this.unitEditForm.unit_label,
                        level_percent: parseInt(this.unitEditForm.level) || 0,
                        status: this.unitEditForm.status || 'AVAILABLE'
                    };
                    console.log('Unit update request:', payload);

                    try {
                        const response = await fetch('/api/equipment/units/update', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (response.ok) {
                            const result = await response.json();
                            this.showUnitEditModal = false;
                            this.toast(`${result.message} (å¹³å‡${result.avg_level}%)`, 'success');

                            // ä¿å­˜æ»¾å‹•ä½ç½®å’Œå±•é–‹ç‹€æ…‹
                            const scrollY = window.scrollY;
                            const oldExpanded = this.expandedLifeline;

                            // é‡æ–°è¼‰å…¥è³‡æ–™
                            await this.loadResilienceStatus();
                            await this.loadEquipment();

                            // éå¢ key å¼·åˆ¶ x-for é‡å»º DOM
                            this.lifelinesRefreshKey++;
                            this.equipmentRefreshKey++;

                            // æ¢å¾©å±•é–‹ç‹€æ…‹å’Œæ»¾å‹•ä½ç½®
                            await this.$nextTick();
                            this.expandedLifeline = oldExpanded;
                            window.scrollTo(0, scrollY);
                        } else {
                            const error = await response.json();
                            this.toast(error.detail || 'æ›´æ–°å¤±æ•—', 'error');
                        }
                    } catch (err) {
                        console.error('Update unit error:', err);
                        this.toast('æ›´æ–°å¤±æ•—: ' + err.message, 'error');
                    }
                },

                // v1.4.7: é–‹å•Ÿé›»åŠ›è¨­å‚™å–®ä½ç·¨è¼¯ Modal
                openPowerUnitEditModal(item, unit, idx) {
                    this.powerUnitEditForm = {
                        equipment_id: item.item_code,
                        unit_label: unit.label,
                        label: unit.label,
                        level: unit.level,
                        status: unit.status,
                        device_type: item.device_type,
                        unit: item.unit
                    };
                    this.showPowerUnitEditModal = true;
                },

                // v1.4.7: å„²å­˜é›»åŠ›è¨­å‚™å–®ä½ç·¨è¼¯
                async submitPowerUnitEdit() {
                    try {
                        const response = await fetch('/api/equipment/units/update', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                equipment_id: this.powerUnitEditForm.equipment_id,
                                unit_label: this.powerUnitEditForm.unit_label,
                                level_percent: this.powerUnitEditForm.level,
                                status: this.powerUnitEditForm.status
                            })
                        });

                        if (response.ok) {
                            const result = await response.json();
                            this.showPowerUnitEditModal = false;
                            this.toast(`${result.message} (å¹³å‡${result.avg_level}%)`, 'success');

                            // ä¿å­˜æ»¾å‹•ä½ç½®å’Œå±•é–‹ç‹€æ…‹
                            const scrollY = window.scrollY;
                            const oldExpanded = this.expandedLifeline;

                            await this.loadResilienceStatus();
                            await this.loadEquipment();
                            this.lifelinesRefreshKey++;
                            this.equipmentRefreshKey++;

                            await this.$nextTick();
                            this.expandedLifeline = oldExpanded;
                            window.scrollTo(0, scrollY);
                        } else {
                            const error = await response.json();
                            this.toast(error.detail || 'æ›´æ–°å¤±æ•—', 'error');
                        }
                    } catch (err) {
                        console.error('Update power unit error:', err);
                        this.toast('æ›´æ–°å¤±æ•—: ' + err.message, 'error');
                    }
                },

                // v1.2.8: é‡ç½®å–®ä½æª¢æŸ¥ç‹€æ…‹
                async resetUnitCheck() {
                    if (!confirm('ç¢ºå®šè¦é‡ç½®æ­¤å–®ä½çš„æª¢æŸ¥ç‹€æ…‹å—ï¼Ÿ')) return;

                    try {
                        const response = await fetch('/api/equipment/units/reset-check', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                equipment_id: this.unitEditForm.equipment_id,
                                unit_label: this.unitEditForm.unit_label
                            })
                        });

                        if (response.ok) {
                            const result = await response.json();
                            this.showUnitEditModal = false;
                            this.toast(result.message, 'success');
                            // v1.2.8: å¼·åˆ¶é‡æ–°æ¸²æŸ“ - å…ˆæ”¶åˆå†è¼‰å…¥å†å±•é–‹
                            const currentExpanded = this.expandedLifeline;
                            this.expandedLifeline = null;
                            // é‡æ–°è¼‰å…¥éŸŒæ€§ç‹€æ…‹å’Œè¨­å‚™åˆ—è¡¨
                            await this.loadResilienceStatus();
                            await this.loadEquipment();
                            // å»¶é²æ¢å¾©å±•é–‹ç‹€æ…‹ç¢ºä¿ DOM æ›´æ–°
                            setTimeout(() => {
                                this.expandedLifeline = currentExpanded;
                            }, 100);
                        } else {
                            const error = await response.json();
                            this.toast(error.detail || 'é‡ç½®å¤±æ•—', 'error');
                        }
                    } catch (err) {
                        console.error('Reset unit check error:', err);
                        this.toast('é‡ç½®å¤±æ•—', 'error');
                    }
                },

                // v1.2.8: è¼‰å…¥æª¢æŸ¥å ±è¡¨
                async loadCheckReport() {
                    try {
                        const response = await fetch(`/api/equipment/check-report/${this.checkReportDate}`);
                        if (response.ok) {
                            this.checkReportData = await response.json();
                        }
                    } catch (err) {
                        console.error('Load check report error:', err);
                    }
                },

                // v1.2.8: åŒ¯å‡ºæª¢æŸ¥å ±è¡¨ CSV
                exportCheckReportCSV() {
                    if (!this.checkReportData?.records?.length) {
                        this.toast('ç„¡è³‡æ–™å¯åŒ¯å‡º', 'error');
                        return;
                    }
                    const headers = ['æª¢æŸ¥æ™‚é–“', 'è¨­å‚™ID', 'è¨­å‚™åç¨±', 'å–®ä½', 'è®Šæ›´å‰%', 'è®Šæ›´å¾Œ%', 'ç‹€æ…‹'];
                    const rows = this.checkReportData.records.map(r => [
                        r.check_time || '',
                        r.equipment_id || '',
                        r.equipment_name || '',
                        r.unit_label || '',
                        r.level_before || '',
                        r.level_after || '',
                        r.status_after || ''
                    ]);
                    const csv = [headers.join(','), ...rows.map(r => r.join(','))].join('\n');
                    const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `æª¢æŸ¥å ±è¡¨_${this.checkReportDate}.csv`;
                    a.click();
                    URL.revokeObjectURL(url);
                    this.toast('CSV åŒ¯å‡ºæˆåŠŸ', 'success');
                },

                // å–å¾—ä¾›é›»è¨­å‚™ (ç™¼é›»æ©Ÿã€é›»æºç«™ã€UPS)
                getPowerSupplyEquipment() {
                    const powerSupplyIds = ['UTIL-001', 'UTIL-002', 'EQ-010'];
                    const powerSupplyCategories = ['é›»åŠ›è¨­å‚™'];
                    return this.equipment.filter(eq =>
                        !eq.id.includes('-SURG-') && !eq.id.startsWith('SURG-') &&
                        (powerSupplyIds.includes(eq.id) ||
                         powerSupplyCategories.includes(eq.category) ||
                         eq.name.includes('ç™¼é›»æ©Ÿ') ||
                         eq.name.includes('é›»æºç«™') ||
                         eq.name.includes('UPS'))
                    );
                },

                // å–å¾—è€—é›»è¨­å‚™ (å†°ç®±ã€å‘¼å¸å™¨ã€ç›£è¦–å™¨ç­‰éœ€è¦é›»åŠ›é‹ä½œçš„è¨­å‚™)
                getPowerConsumingEquipment() {
                    const powerConsumingCategories = ['å„²å­˜è¨­å‚™', 'å†·è—è¨­å‚™', 'ç›£æ¸¬è¨­å‚™', 'å‘¼å¸è¨­å‚™', 'è¼¸æ¶²è¨­å‚™', 'æ‰‹è¡“è¨­å‚™', 'éº»é†‰è¨­å‚™'];
                    const oxygenCylinderIds = ['RESP-001', 'EMER-EQ-006']; // æ°§æ°£é‹¼ç“¶ä¸è€—é›»
                    const powerSupplyIds = ['UTIL-001', 'UTIL-002', 'EQ-010']; // æ’é™¤ä¾›é›»è¨­å‚™
                    return this.equipment.filter(eq =>
                        !eq.id.includes('-SURG-') && !eq.id.startsWith('SURG-') &&
                        !powerSupplyIds.includes(eq.id) &&
                        !oxygenCylinderIds.includes(eq.id) &&
                        (powerConsumingCategories.includes(eq.category) ||
                         eq.name.includes('å†°ç®±') || eq.name.includes('å†·å‡') ||
                         eq.name.includes('å‘¼å¸') || eq.name.includes('ç›£è¦–') ||
                         eq.name.includes('è¼¸æ¶²') || eq.name.includes('æŠ½å¸') ||
                         eq.name.includes('æ¿ƒç¸®æ©Ÿ') ||  // æ°§æ°£æ¿ƒç¸®æ©Ÿéœ€è¦é›»åŠ›
                         eq.category === 'é›»åŠ›è¨­å‚™' && !eq.name.includes('ç™¼é›»æ©Ÿ') && !eq.name.includes('é›»æºç«™'))
                    );
                },

                // å–å¾—éè€—é›»è¨­å‚™ (æ‰‹å‹•è¨­å‚™ã€æ“”æ¶ã€è¨ºæ–·å·¥å…·ç­‰)
                getNonElectricEquipment() {
                    const nonElectricCategories = ['æ¬é‹è¨­å‚™', 'è¨ºæ–·è¨­å‚™', 'æ€¥æ•‘è¨­å‚™', 'æ‰‹å‹•è¨­å‚™'];
                    const oxygenCylinderIds = ['RESP-001', 'EMER-EQ-006']; // æ°§æ°£é‹¼ç“¶ä¸è€—é›»
                    const powerSupplyIds = ['UTIL-001', 'UTIL-002', 'EQ-010'];
                    const powerConsumingCategories = ['å„²å­˜è¨­å‚™', 'å†·è—è¨­å‚™', 'ç›£æ¸¬è¨­å‚™', 'å‘¼å¸è¨­å‚™', 'è¼¸æ¶²è¨­å‚™', 'æ‰‹è¡“è¨­å‚™', 'éº»é†‰è¨­å‚™', 'é›»åŠ›è¨­å‚™'];
                    return this.equipment.filter(eq => {
                        if (eq.id.includes('-SURG-') || eq.id.startsWith('SURG-')) return false;
                        if (powerSupplyIds.includes(eq.id)) return false;
                        // æ°§æ°£é‹¼ç“¶æ­¸å…¥éè€—é›» (ä¸éœ€è¦é›»)
                        if (oxygenCylinderIds.includes(eq.id)) return true;
                        // æ°§æ°£æ¿ƒç¸®æ©Ÿéœ€è¦é›»ï¼Œä¸åœ¨æ­¤åˆ—
                        if (eq.name.includes('æ¿ƒç¸®æ©Ÿ')) return false;
                        // æ˜ç¢ºçš„éè€—é›»é¡åˆ¥
                        if (nonElectricCategories.includes(eq.category)) return true;
                        // æ’é™¤è€—é›»è¨­å‚™å¾Œçš„å…¶ä»–è¨­å‚™
                        if (powerConsumingCategories.includes(eq.category)) return false;
                        if (eq.name.includes('å†°ç®±') || eq.name.includes('å†·å‡') ||
                            eq.name.includes('å‘¼å¸') || eq.name.includes('ç›£è¦–') ||
                            eq.name.includes('è¼¸æ¶²') || eq.name.includes('æŠ½å¸')) return false;
                        return true; // å…¶ä»–æ­¸å…¥éè€—é›»
                    });
                },

                // v2: é–‹å•Ÿè¨­å‚™æª¢æŸ¥ modalï¼Œè¼‰å…¥è¨­å‚™è©³æƒ…å«å–®ä½
                async checkEquipment(eq) {
                    try {
                        // v2 API: è¼‰å…¥è¨­å‚™è©³æƒ…å«æ‰€æœ‰å–®ä½
                        const response = await fetch(`${this.apiUrl}/v2/equipment/${eq.id}`);
                        if (!response.ok) {
                            this.toast('è¼‰å…¥è¨­å‚™è©³æƒ…å¤±æ•—', 'error');
                            return;
                        }
                        const detail = await response.json();

                        // è¨­ç½®è¡¨å–®
                        this.checkEquipmentForm = {
                            id: eq.id,
                            name: detail.name,
                            status: 'AVAILABLE',
                            powerLevel: detail.units?.[0]?.level_percent || 100,
                            remarks: '',
                            stationId: this.stationId,
                            // v2 fields
                            units: detail.units || [],
                            selectedUnitId: detail.units?.[0]?.id || null,
                            statusOptions: detail.status_options || ['AVAILABLE', 'IN_USE', 'MAINTENANCE']
                        };
                        this.showCheckEquipmentModal = true;
                    } catch (error) {
                        console.error('è¼‰å…¥è¨­å‚™è©³æƒ…å¤±æ•—:', error);
                        this.toast('è¼‰å…¥è¨­å‚™è©³æƒ…å¤±æ•—', 'error');
                    }
                },

                // v2: é¸æ“‡å–®ä½æ™‚æ›´æ–°è¡¨å–®
                selectUnit(unit) {
                    this.checkEquipmentForm.selectedUnitId = unit.id;
                    this.checkEquipmentForm.powerLevel = unit.level_percent;
                    // v2.8.4: UNCHECKED ç‹€æ…‹æ‡‰è‡ªå‹•è®Šç‚º AVAILABLEï¼ˆå·²æª¢æŸ¥ = å¯ç”¨ï¼‰
                    this.checkEquipmentForm.status = (unit.status === 'UNCHECKED' || !unit.status) ? 'AVAILABLE' : unit.status;
                },

                // v2: æäº¤è¨­å‚™å–®ä½æª¢æŸ¥
                async submitCheckEquipment() {
                    try {
                        const unitId = this.checkEquipmentForm.selectedUnitId;
                        if (!unitId) {
                            this.toast('è«‹é¸æ“‡è¦æª¢æŸ¥çš„å–®ä½', 'error');
                            return;
                        }

                        // v2 API: POST /api/v2/equipment/units/{unit_id}/check
                        const response = await fetch(`${this.apiUrl}/v2/equipment/units/${unitId}/check`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                level_percent: parseInt(this.checkEquipmentForm.powerLevel) || 100,
                                status: this.checkEquipmentForm.status,
                                remarks: this.checkEquipmentForm.remarks || null
                            })
                        });

                        const data = await response.json();

                        if (response.ok) {
                            this.toast('è¨­å‚™æª¢æŸ¥å®Œæˆ', 'success');
                            this.showCheckEquipmentModal = false;

                            // v2: ç›´æ¥å¾ API å›æ‡‰æ›´æ–° UIï¼Œä¸éœ€é‡æ–°è¼‰å…¥å…¨éƒ¨
                            this.updateEquipmentFromResponse(data);

                            // æ›´æ–°éŸŒæ€§ç‹€æ…‹ï¼ˆå¦‚æœ API å›å‚³ dashboard deltaï¼‰
                            if (data.dashboard_delta) {
                                this.applyDashboardDelta(data.dashboard_delta);
                            } else {
                                // fallback: é‡æ–°è¼‰å…¥éŸŒæ€§ç‹€æ…‹
                                await this.loadResilienceStatus();
                            }

                            await this.loadStats();
                        } else {
                            this.toast(data.detail || 'æª¢æŸ¥å¤±æ•—', 'error');
                        }
                    } catch (error) {
                        console.error('è¨­å‚™æª¢æŸ¥å¤±æ•—:', error);
                        this.toast('è¨­å‚™æª¢æŸ¥å¤±æ•—', 'error');
                    }
                },

                // v2: å¾ API å›æ‡‰ç›´æ¥æ›´æ–°è¨­å‚™åˆ—è¡¨ï¼ˆOptimistic UIï¼‰
                updateEquipmentFromResponse(data) {
                    if (!data.equipment_aggregate) return;

                    const eqId = data.equipment_aggregate.equipment_id;
                    const idx = this.equipment.findIndex(e => e.id === eqId);
                    if (idx === -1) return;

                    // æ›´æ–°è¨­å‚™èšåˆç‹€æ…‹
                    this.equipment[idx] = {
                        ...this.equipment[idx],
                        unit_count: data.equipment_aggregate.unit_count,
                        avg_level: data.equipment_aggregate.avg_level,
                        check_status: data.equipment_aggregate.check_status,
                        // v1 compatibility
                        quantity: data.equipment_aggregate.unit_count,
                        power_level: data.equipment_aggregate.avg_level,
                        status: this.mapCheckStatusToLegacy(data.equipment_aggregate.check_status)
                    };

                    console.log('âœ“ è¨­å‚™ç‹€æ…‹å·²æ›´æ–° (optimistic):', eqId);
                },

                // v2: å¥—ç”¨éŸŒæ€§å„€è¡¨æ¿å·®ç•°æ›´æ–° (Optimistic UI)
                applyDashboardDelta(delta) {
                    if (!delta || !delta.category) {
                        console.log('No dashboard delta to apply');
                        return;
                    }

                    console.log('âœ“ Applying dashboard delta:', delta);

                    // æ‰¾åˆ°å°æ‡‰çš„ lifeline ä¸¦æ›´æ–°
                    const lifelineIdx = this.resilienceStatus.lifelines?.findIndex(
                        ll => ll.type === delta.category
                    );

                    if (lifelineIdx !== -1 && this.resilienceStatus.lifelines) {
                        // æ›´æ–°è©²ç”Ÿå‘½ç·šçš„ç¸½æ™‚æ•¸ (åŒæ™‚æ›´æ–° endurance çµæ§‹ä»¥ä¾› v1 UI ä½¿ç”¨)
                        const ll = this.resilienceStatus.lifelines[lifelineIdx];
                        ll.total_hours = delta.total_hours;
                        if (ll.endurance) {
                            ll.endurance.effective_hours = delta.total_hours >= 999999 ? 'âˆ' : Math.round(delta.total_hours * 10) / 10;
                            ll.endurance.effective_days = Math.round(delta.total_hours / 24 * 10) / 10;
                        }

                        // é‡æ–°è¨ˆç®—æœ€å¼±ç”Ÿå‘½ç·š
                        const weakest = this.resilienceStatus.lifelines.reduce((min, ll) =>
                            (!min || ll.total_hours < min.total_hours) ? ll : min, null);

                        if (weakest && this.resilienceStatus.summary) {
                            this.resilienceStatus.summary.weakest_link = {
                                hours: weakest.total_hours,
                                type: weakest.type,
                                name: weakest.name
                            };

                            // æ›´æ–°æ•´é«”ç‹€æ…‹
                            const targetHours = (this.resilienceStatus.summary.isolation_target_days || 3) * 24;
                            if (weakest.total_hours >= targetHours * 1.2) {
                                this.resilienceStatus.summary.overall_status = 'SAFE';
                            } else if (weakest.total_hours >= targetHours) {
                                this.resilienceStatus.summary.overall_status = 'WARNING';
                            } else {
                                this.resilienceStatus.summary.overall_status = 'CRITICAL';
                            }
                        }

                        // æ›´æ–°æª¢æŸ¥é€²åº¦
                        if (this.resilienceStatus.summary?.check_progress) {
                            this.resilienceStatus.summary.check_progress.checked = delta.checked_count;
                            this.resilienceStatus.summary.check_progress.total = delta.total_units;
                            this.resilienceStatus.summary.check_progress.percentage =
                                Math.round((delta.checked_count / delta.total_units) * 100) || 0;
                        }

                        console.log('âœ“ Dashboard updated optimistically');
                    }
                },

                // ============================================
                // v2.1: è¨­å‚™å–®ä½ç®¡ç†åŠŸèƒ½
                // ============================================

                async openUnitManageModal(eq) {
                    this.unitManageForm.equipment_id = eq.id;
                    this.unitManageForm.equipment_name = eq.name;
                    this.unitManageForm.type_code = eq.type_code;
                    this.unitManageForm.loading = true;
                    this.unitManageForm.showInactive = false;
                    this.unitManageForm.units = [];
                    this.unitManageForm.inactive_units = [];
                    this.showUnitManageModal = true;

                    try {
                        const response = await fetch(`${this.apiUrl}/v2/equipment/${eq.id}/units?include_inactive=true`);
                        if (response.ok) {
                            const data = await response.json();
                            this.unitManageForm.units = data.units || [];
                            this.unitManageForm.inactive_units = data.inactive_units || [];
                            this.unitManageForm.unit_prefix = data.unit_prefix;
                            this.unitManageForm.targetQuantity = data.active_count;
                        } else {
                            this.toast('è¼‰å…¥å–®ä½åˆ—è¡¨å¤±æ•—', 'error');
                        }
                    } catch (error) {
                        console.error('è¼‰å…¥è¨­å‚™å–®ä½å¤±æ•—:', error);
                        this.toast('è¼‰å…¥è¨­å‚™å–®ä½å¤±æ•—', 'error');
                    } finally {
                        this.unitManageForm.loading = false;
                    }
                },

                async addUnit() {
                    const equipmentId = this.unitManageForm.equipment_id;
                    const form = this.unitManageForm.addForm;

                    try {
                        const response = await fetch(`${this.apiUrl}/v2/equipment/${equipmentId}/units`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                level_percent: parseInt(form.level_percent) || 100,
                                status: form.status || 'AVAILABLE',
                                reason: form.reason || null
                            })
                        });

                        const data = await response.json();

                        if (response.ok) {
                            this.toast(data.message || 'å·²æ–°å¢å–®ä½', 'success');
                            // æ–°å¢åˆ°åˆ—è¡¨
                            this.unitManageForm.units.push(data.unit);
                            this.unitManageForm.targetQuantity = data.equipment_summary?.active_unit_count;
                            // é‡ç½®è¡¨å–®
                            this.unitManageForm.addForm = { level_percent: 100, status: 'AVAILABLE', reason: '' };
                            // æ›´æ–°ä¸»åˆ—è¡¨
                            await this.loadEquipment();
                            await this.loadResilienceStatus();
                        } else {
                            this.toast(data.detail || 'æ–°å¢å¤±æ•—', 'error');
                        }
                    } catch (error) {
                        console.error('æ–°å¢å–®ä½å¤±æ•—:', error);
                        this.toast('æ–°å¢å–®ä½å¤±æ•—', 'error');
                    }
                },

                async removeUnit(unit) {
                    const reason = this.unitManageForm.removeReason || 'æ¼”ç¿’èª¿æ•´';

                    if (!confirm(`ç¢ºå®šè¦ç§»é™¤ã€Œ${unit.unit_label}ã€ï¼Ÿ\nåŸå› : ${reason}`)) {
                        return;
                    }

                    try {
                        const response = await fetch(`${this.apiUrl}/v2/equipment/units/${unit.id}`, {
                            method: 'DELETE',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ reason: reason })
                        });

                        const data = await response.json();

                        if (response.ok) {
                            this.toast(data.message || 'å·²ç§»é™¤å–®ä½', 'success');
                            // å¾ active åˆ—è¡¨ç§»é™¤
                            this.unitManageForm.units = this.unitManageForm.units.filter(u => u.id !== unit.id);
                            // åŠ å…¥ inactive åˆ—è¡¨
                            this.unitManageForm.inactive_units.unshift({
                                ...unit,
                                is_active: false,
                                removed_at: new Date().toISOString(),
                                removal_reason: reason
                            });
                            this.unitManageForm.targetQuantity = data.equipment_summary?.active_unit_count;
                            // æ›´æ–°ä¸»åˆ—è¡¨
                            await this.loadEquipment();
                            await this.loadResilienceStatus();
                        } else {
                            this.toast(data.detail || 'ç§»é™¤å¤±æ•—', 'error');
                        }
                    } catch (error) {
                        console.error('ç§»é™¤å–®ä½å¤±æ•—:', error);
                        this.toast('ç§»é™¤å–®ä½å¤±æ•—', 'error');
                    }
                },

                async restoreUnit(unit) {
                    if (!confirm(`ç¢ºå®šè¦æ¢å¾©ã€Œ${unit.unit_label}ã€ï¼Ÿ`)) {
                        return;
                    }

                    try {
                        const response = await fetch(`${this.apiUrl}/v2/equipment/units/${unit.id}/restore`, {
                            method: 'POST'
                        });

                        const data = await response.json();

                        if (response.ok) {
                            this.toast(data.message || 'å·²æ¢å¾©å–®ä½', 'success');
                            // å¾ inactive åˆ—è¡¨ç§»é™¤
                            this.unitManageForm.inactive_units = this.unitManageForm.inactive_units.filter(u => u.id !== unit.id);
                            // åŠ å…¥ active åˆ—è¡¨
                            this.unitManageForm.units.push({
                                ...unit,
                                is_active: true,
                                removed_at: null,
                                removal_reason: null
                            });
                            this.unitManageForm.targetQuantity = data.equipment_summary?.active_unit_count;
                            // æ›´æ–°ä¸»åˆ—è¡¨
                            await this.loadEquipment();
                            await this.loadResilienceStatus();
                        } else {
                            this.toast(data.detail || 'æ¢å¾©å¤±æ•—', 'error');
                        }
                    } catch (error) {
                        console.error('æ¢å¾©å–®ä½å¤±æ•—:', error);
                        this.toast('æ¢å¾©å–®ä½å¤±æ•—', 'error');
                    }
                },

                async batchAdjustQuantity() {
                    const equipmentId = this.unitManageForm.equipment_id;
                    const target = parseInt(this.unitManageForm.targetQuantity);
                    const current = this.unitManageForm.units.length;

                    if (target === current) {
                        this.toast('æ•¸é‡æœªè®Šæ›´', 'info');
                        return;
                    }

                    const action = target > current ? 'æ–°å¢' : 'ç§»é™¤';
                    const diff = Math.abs(target - current);

                    if (!confirm(`ç¢ºå®šè¦${action} ${diff} å€‹å–®ä½ï¼Ÿ\n(${current} â†’ ${target})`)) {
                        return;
                    }

                    try {
                        const response = await fetch(`${this.apiUrl}/v2/equipment/${equipmentId}/quantity`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                target_quantity: target,
                                reason: 'æ‰¹æ¬¡æ•¸é‡èª¿æ•´'
                            })
                        });

                        const data = await response.json();

                        if (response.ok) {
                            this.toast(data.message || 'èª¿æ•´å®Œæˆ', 'success');
                            // é‡æ–°è¼‰å…¥å–®ä½åˆ—è¡¨
                            await this.openUnitManageModal({
                                id: equipmentId,
                                name: this.unitManageForm.equipment_name,
                                type_code: this.unitManageForm.type_code
                            });
                            // æ›´æ–°ä¸»åˆ—è¡¨
                            await this.loadEquipment();
                            await this.loadResilienceStatus();
                        } else {
                            this.toast(data.detail || 'èª¿æ•´å¤±æ•—', 'error');
                        }
                    } catch (error) {
                        console.error('æ‰¹æ¬¡èª¿æ•´å¤±æ•—:', error);
                        this.toast('æ‰¹æ¬¡èª¿æ•´å¤±æ•—', 'error');
                    }
                },

                getStatusBadgeClass(status) {
                    const classes = {
                        'AVAILABLE': 'bg-green-100 text-green-800',
                        'IN_USE': 'bg-blue-100 text-blue-800',
                        'CHARGING': 'bg-yellow-100 text-yellow-800',
                        'MAINTENANCE': 'bg-gray-100 text-gray-800',
                        'EMPTY': 'bg-red-100 text-red-800'
                    };
                    return classes[status] || 'bg-gray-100 text-gray-800';
                },

                // æ‰‹è¡“è¨˜éŒ„
                async loadSurgeryRecords() {
                    try {
                        let url = `${this.apiUrl}/surgery/records?limit=50`;
                        
                        if (this.surgerySearchForm.startDate) {
                            url += `&start_date=${this.surgerySearchForm.startDate}`;
                        }
                        if (this.surgerySearchForm.endDate) {
                            url += `&end_date=${this.surgerySearchForm.endDate}`;
                        }
                        if (this.surgerySearchForm.patientName) {
                            url += `&patient_name=${encodeURIComponent(this.surgerySearchForm.patientName)}`;
                        }
                        
                        const response = await fetch(url);
                        if (response.ok) {
                            const data = await response.json();
                            this.surgeryRecords = data.records;
                        }
                    } catch (error) {
                        console.error('è¼‰å…¥æ‰‹è¡“è¨˜éŒ„å¤±æ•—:', error);
                        this.toast('è¼‰å…¥æ‰‹è¡“è¨˜éŒ„å¤±æ•—', 'error');
                    }
                },

                addConsumptionItem() {
                    this.addSurgeryForm.consumptions.push({
                        itemCode: '',
                        itemName: '',
                        quantity: 1,
                        unit: '',
                        searchText: '',
                        showDropdown: false,
                        filteredItems: []
                    });
                },

                filterConsumptionItems(index) {
                    const item = this.addSurgeryForm.consumptions[index];
                    const searchText = item.searchText.toLowerCase();

                    // æ’é™¤è—¥å“ (medicines) - è—¥å“æ‡‰è©²é€éè—¥å“é ˜ç”¨æµç¨‹
                    const nonMedicineItems = this.items.filter(i => i.category !== 'è—¥å“');

                    if (!searchText) {
                        item.filteredItems = nonMedicineItems;
                    } else {
                        item.filteredItems = nonMedicineItems.filter(i =>
                            i.code.toLowerCase().includes(searchText) ||
                            i.name.toLowerCase().includes(searchText)
                        );
                    }
                },

                selectConsumptionItem(index, selectedItem) {
                    const item = this.addSurgeryForm.consumptions[index];
                    item.itemCode = selectedItem.code;
                    item.itemName = selectedItem.name;
                    item.unit = selectedItem.unit;
                    item.searchText = `${selectedItem.code} - ${selectedItem.name}`;
                    item.showDropdown = false;
                },

                removeConsumptionItem(index) {
                    this.addSurgeryForm.consumptions.splice(index, 1);
                },

                updateConsumptionItemName(index) {
                    const itemCode = this.addSurgeryForm.consumptions[index].itemCode;
                    const item = this.items.find(i => i.code === itemCode);
                    if (item) {
                        this.addSurgeryForm.consumptions[index].itemName = item.name;
                        this.addSurgeryForm.consumptions[index].unit = item.unit;
                    }
                },

                // è¡“ä¸­ç”¨è—¥æ–¹æ³•
                addIntraopMed() {
                    this.addSurgeryForm.intraopMeds.push({
                        name: '',
                        dose: '',
                        unit: ''
                    });
                },

                removeIntraopMed(index) {
                    this.addSurgeryForm.intraopMeds.splice(index, 1);
                },

                addQuickIntraopMed(name, dose, unit) {
                    // æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒè—¥ç‰©
                    const existing = this.addSurgeryForm.intraopMeds.find(m => m.name === name);
                    if (existing) {
                        this.toast(`${name} å·²åœ¨åˆ—è¡¨ä¸­`, 'warning');
                        return;
                    }
                    this.addSurgeryForm.intraopMeds.push({ name, dose, unit });
                },

                async submitAddSurgery() {
                    // è‡³å°‘éœ€è¦è€—ææˆ–è¡“ä¸­ç”¨è—¥å…¶ä¸­ä¹‹ä¸€
                    if (this.addSurgeryForm.consumptions.length === 0 && this.addSurgeryForm.intraopMeds.length === 0) {
                        this.toast('è«‹è‡³å°‘æ–°å¢ä¸€é …è€—ææˆ–è¡“ä¸­ç”¨è—¥', 'error');
                        return;
                    }

                    try {
                        const response = await fetch(`${this.apiUrl}/surgery/record`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(this.addSurgeryForm)
                        });
                        
                        const data = await response.json();
                        
                        if (response.ok) {
                            this.toast(data.message || 'æ‰‹è¡“è¨˜éŒ„å»ºç«‹æˆåŠŸ', 'success');
                            this.showAddSurgeryModal = false;
                            this.resetAddSurgeryForm();
                            await this.loadSurgeryRecords();
                            await this.loadItems();
                            await this.loadStats();
                        } else {
                            this.toast(data.detail || 'å»ºç«‹å¤±æ•—', 'error');
                        }
                    } catch (error) {
                        console.error('å»ºç«‹æ‰‹è¡“è¨˜éŒ„å¤±æ•—:', error);
                        this.toast('å»ºç«‹æ‰‹è¡“è¨˜éŒ„å¤±æ•—', 'error');
                    }
                },

                resetAddSurgeryForm() {
                    this.addSurgeryForm = {
                        patientName: '',
                        triageTagId: '',
                        surgeryType: '',
                        surgeonName: '',
                        anesthesiaType: '',
                        durationMinutes: null,
                        remarks: '',
                        consumptions: [],
                        intraopMeds: [],  // è¡“ä¸­ç”¨è—¥
                        stationId: this.stationId,
                        // v1.1: CIRS æ•´åˆ
                        cirsRegistrationRef: null,
                        cirsPersonId: null
                    };
                },

                // v1.1: è¼‰å…¥ CIRS å¾…è™•ç½®æ¸…å–®
                // v1.2: åŠ å…¥ lastSynced é¡¯ç¤ºæœ€å¾ŒåŒæ­¥æ™‚é–“
                async loadCirsProcedureWaiting() {
                    try {
                        const response = await fetch(`${this.apiUrl}/procedure/proxy/cirs/waiting-procedure`);
                        const data = await response.json();

                        this.cirsProcedureStatus.online = data.online;
                        this.cirsProcedurePatients = data.patients || [];

                        // v1.2: è¨˜éŒ„æœ€å¾ŒåŒæ­¥æ™‚é–“
                        this.cirsProcedureStatus.lastSynced = data.local_timestamp || new Date().toISOString();

                        if (data.online) {
                            console.log(`CIRS å¾…è™•ç½®æ¸…å–®: ${data.count} ä½ç—…æ‚£`);
                        }
                    } catch (error) {
                        console.error('è¼‰å…¥ CIRS å¾…è™•ç½®æ¸…å–®å¤±æ•—:', error);
                        this.cirsProcedureStatus.online = false;
                        this.cirsProcedurePatients = [];
                        this.cirsProcedureStatus.lastSynced = new Date().toISOString();
                    }
                },

                // v1.1: å¾å¾…è™•ç½®æ¸…å–®é¸å–ç—…æ‚£
                selectProcedurePatient(patient) {
                    this.ensureItemsLoaded();

                    // è‡ªå‹•å¸¶å…¥ç—…æ‚£è³‡æ–™
                    this.addSurgeryForm.patientName = patient.name || patient.patient_ref || '';
                    this.addSurgeryForm.triageTagId = patient.patient_id || '';
                    this.addSurgeryForm.surgeryType = patient.procedure_notes || patient.chief_complaint || '';
                    this.addSurgeryForm.remarks = patient.chief_complaint ? `ä¸»è¨´: ${patient.chief_complaint}` : '';

                    // v1.1: CIRS æ•´åˆæ¬„ä½
                    this.addSurgeryForm.cirsRegistrationRef = patient.registration_id;
                    this.addSurgeryForm.cirsPersonId = patient.patient_id;

                    // é–‹å•Ÿ Modal
                    this.showAddSurgeryModal = true;

                    this.toast(`å·²é¸å–ç—…æ‚£: ${patient.name || patient.patient_ref}`, 'success');
                },

                viewSurgeryDetail(record) {
                    this.selectedSurgery = record;
                    this.showSurgeryDetailModal = true;
                },

                async exportSurgeryCSV() {
                    try {
                        let url = `${this.apiUrl}/surgery/export/csv`;
                        const params = [];
                        
                        if (this.surgerySearchForm.startDate) {
                            params.push(`start_date=${this.surgerySearchForm.startDate}`);
                        }
                        if (this.surgerySearchForm.endDate) {
                            params.push(`end_date=${this.surgerySearchForm.endDate}`);
                        }
                        
                        if (params.length > 0) {
                            url += '?' + params.join('&');
                        }
                        
                        window.open(url, '_blank');
                        this.toast('CSV åŒ¯å‡ºæˆåŠŸ', 'success');
                    } catch (error) {
                        console.error('åŒ¯å‡º CSV å¤±æ•—:', error);
                        this.toast('åŒ¯å‡º CSV å¤±æ•—', 'error');
                    }
                },

                // Toast é€šçŸ¥
                toast(message, type = 'info') {
                    this.toastMessage = message;
                    this.toastType = type;
                    this.showToast = true;
                    setTimeout(() => {
                        this.showToast = false;
                    }, 3000);
                },

                // ========== ä¼ºæœå™¨ä½å€é¡¯ç¤º (v2.5) ==========
                isLocalhostAccess() {
                    // å¦‚æœå·²åµæ¸¬åˆ°ä¼ºæœå™¨ URLï¼Œå°±ä¸éœ€è¦è­¦å‘Š
                    if (this.detectedServerUrl) return false;
                    const host = window.location.hostname;
                    return host === 'localhost' || host === '127.0.0.1';
                },

                getDisplayServerUrl() {
                    // å„ªå…ˆä½¿ç”¨å¾Œç«¯åµæ¸¬çš„ IP
                    if (this.detectedServerUrl) {
                        return this.detectedServerUrl;
                    }
                    // å‚™ç”¨ï¼šä½¿ç”¨å‰ç«¯çš„ hostname
                    const host = window.location.hostname;
                    const port = '8000';
                    if (host === 'localhost' || host === '127.0.0.1') {
                        return `http://<é›»è…¦IP>:${port}/api`;
                    }
                    return `http://${host}:${port}/api`;
                },

                // ========== PWA åŒæ­¥é€šçŸ¥ (v0.8) ==========
                async initSyncNotifications() {
                    // åˆå§‹åŒ–æ™‚è¨˜éŒ„ç•¶å‰çš„ç›¤é»è¨˜éŒ„æ•¸é‡
                    try {
                        const response = await fetch(`${this.apiUrl}/inventory-check/history`);
                        if (response.ok) {
                            const data = await response.json();
                            this.lastKnownCheckCount = (data.checks || []).length;
                            console.log('âœ“ åŒæ­¥é€šçŸ¥å·²åˆå§‹åŒ–, ç•¶å‰ç›¤é»è¨˜éŒ„:', this.lastKnownCheckCount);
                        }
                    } catch (e) {
                        console.log('åŒæ­¥é€šçŸ¥åˆå§‹åŒ–ç•¥é');
                    }
                },

                async checkForNewSyncs() {
                    // å®šæœŸæª¢æŸ¥æ˜¯å¦æœ‰æ–°çš„ PWA åŒæ­¥è³‡æ–™
                    try {
                        const response = await fetch(`${this.apiUrl}/inventory-check/history`);
                        if (response.ok) {
                            const data = await response.json();
                            const currentCount = (data.checks || []).length;

                            if (currentCount > this.lastKnownCheckCount) {
                                const newCount = currentCount - this.lastKnownCheckCount;

                                // è¨ˆç®—æ–°åŒæ­¥çš„ç¢ºèªå’ŒéŒ¯èª¤æ•¸é‡
                                const newChecks = (data.checks || []).slice(0, newCount);
                                const newConfirmed = newChecks.reduce((sum, c) => sum + (c.confirmed_count || 0), 0);
                                const newErrors = newChecks.reduce((sum, c) => sum + (c.error_count || 0), 0);

                                // é¡¯ç¤ºåŒæ­¥é€šçŸ¥
                                let msg = `ğŸ“± PWA åŒæ­¥: ${newCount} ç­†æ–°ç›¤é»è¨˜éŒ„`;
                                if (newConfirmed > 0 || newErrors > 0) {
                                    msg += ` (ç¢ºèª ${newConfirmed}, éŒ¯èª¤ ${newErrors})`;
                                }

                                this.toast(msg, newErrors > 0 ? 'error' : 'success');

                                // æ›´æ–°å·²çŸ¥æ•¸é‡
                                this.lastKnownCheckCount = currentCount;

                                // å¦‚æœç›¤é»è¨˜éŒ„æ¨¡æ…‹çª—é–‹å•Ÿä¸­ï¼Œè‡ªå‹•åˆ·æ–°
                                if (this.showInventoryCheckHistoryModal) {
                                    this.loadInventoryCheckHistory();
                                }

                                // åˆ·æ–°çµ±è¨ˆæ•¸æ“š
                                this.loadStats();

                                console.log(`âœ“ PWA åŒæ­¥é€šçŸ¥: ${newCount} ç­†æ–°è¨˜éŒ„`);
                            }
                        }
                    } catch (e) {
                        // éœé»˜å¤±æ•—ï¼Œä¸å½±éŸ¿æ­£å¸¸ä½¿ç”¨
                    }
                },

                // ç·Šæ€¥åŠŸèƒ½ (v1.4.5æ–°å¢)
                emergencyDownloadAll() {
                    window.open(`${this.apiUrl}/emergency/download-all`, '_blank');
                    this.showEmergencyModal = false;
                    this.toast('æ­£åœ¨ç”Ÿæˆå®Œæ•´å‚™ä»½åŒ…ï¼Œè«‹ç¨å€™...', 'info');
                },

                emergencyQuickBackup() {
                    window.open(`${this.apiUrl}/emergency/quick-backup`, '_blank');
                    this.showEmergencyModal = false;
                    this.toast('æ­£åœ¨ä¸‹è¼‰è³‡æ–™åº«å‚™ä»½...', 'info');
                },

                // ========== åŒæ­¥ç®¡ç†åŠŸèƒ½ (è¯é‚¦æ¶æ§‹ Phase 1-2) ==========

                // ç”¢ç”ŸåŒæ­¥å°åŒ…
                async generateSyncPackage() {
                    try {
                        const requestBody = {
                            stationId: this.stationId,
                            hospitalId: 'HOSP-001',
                            syncType: this.syncPackageForm.syncType
                        };

                        // å¦‚æœæ˜¯å¢é‡åŒæ­¥ä¸”æœ‰æŒ‡å®šæ™‚é–“
                        if (this.syncPackageForm.syncType === 'DELTA' && this.syncPackageForm.sinceTimestamp) {
                            // è½‰æ›ç‚º ISO 8601 æ ¼å¼
                            const dt = new Date(this.syncPackageForm.sinceTimestamp);
                            requestBody.sinceTimestamp = dt.toISOString();
                        }

                        const response = await fetch(`${this.apiUrl}/station/sync/generate`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(requestBody)
                        });

                        if (response.ok) {
                            const data = await response.json();
                            this.generatedPackage = data;
                            this.syncStats.pendingChanges = data.changes_count;
                            this.toast(`å°åŒ…å·²ç”¢ç”Ÿï¼š${data.changes_count} é …è®Šæ›´`, 'success');
                        } else {
                            const error = await response.json();
                            this.toast(`ç”¢ç”Ÿå°åŒ…å¤±æ•—ï¼š${error.detail}`, 'error');
                        }
                    } catch (error) {
                        console.error('ç”¢ç”ŸåŒæ­¥å°åŒ…å¤±æ•—:', error);
                        this.toast('ç”¢ç”ŸåŒæ­¥å°åŒ…å¤±æ•—', 'error');
                    }
                },

                // ä¸‹è¼‰åŒæ­¥å°åŒ…ç‚º JSON æª”æ¡ˆ
                downloadSyncPackage() {
                    if (!this.generatedPackage) {
                        this.toast('è«‹å…ˆç”¢ç”ŸåŒæ­¥å°åŒ…', 'error');
                        return;
                    }

                    const dataStr = JSON.stringify(this.generatedPackage, null, 2);
                    const dataBlob = new Blob([dataStr], { type: 'application/json' });
                    const url = URL.createObjectURL(dataBlob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `${this.generatedPackage.package_id}.json`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);

                    this.toast('å°åŒ…å·²ä¸‹è¼‰', 'success');
                },

                // è¤‡è£½åŒæ­¥å°åŒ…åˆ°å‰ªè²¼ç°¿
                async copySyncPackage() {
                    if (!this.generatedPackage) {
                        this.toast('è«‹å…ˆç”¢ç”ŸåŒæ­¥å°åŒ…', 'error');
                        return;
                    }

                    try {
                        const dataStr = JSON.stringify(this.generatedPackage, null, 2);
                        await navigator.clipboard.writeText(dataStr);
                        this.toast('å°åŒ…å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿', 'success');
                    } catch (error) {
                        console.error('è¤‡è£½å¤±æ•—:', error);
                        this.toast('è¤‡è£½å¤±æ•—', 'error');
                    }
                },

                // è™•ç†åŒæ­¥æª”æ¡ˆä¸Šå‚³
                handleSyncFileUpload(event) {
                    const file = event.target.files[0];
                    if (!file) return;

                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const jsonData = JSON.parse(e.target.result);
                            this.uploadedPackage = {
                                packageId: jsonData.package_id,
                                changes: jsonData.changes,
                                checksum: jsonData.checksum
                            };
                            this.importResult = null; // æ¸…é™¤ä¹‹å‰çš„åŒ¯å…¥çµæœ
                            this.toast('å°åŒ…å·²è¼‰å…¥', 'info');
                        } catch (error) {
                            console.error('è§£æ JSON å¤±æ•—:', error);
                            this.toast('æª”æ¡ˆæ ¼å¼éŒ¯èª¤', 'error');
                        }
                    };
                    reader.readAsText(file);
                },

                // æ¸…é™¤å·²ä¸Šå‚³çš„å°åŒ…
                clearUploadedPackage() {
                    this.uploadedPackage = null;
                    this.importResult = null;
                    // æ¸…é™¤ file input
                    const fileInput = document.querySelector('input[type="file"]');
                    if (fileInput) fileInput.value = '';
                    this.toast('å·²æ¸…é™¤ä¸Šå‚³å°åŒ…', 'info');
                },

                // åŒ¯å…¥åŒæ­¥å°åŒ…
                async importSyncPackage() {
                    if (!this.uploadedPackage) {
                        this.toast('è«‹å…ˆä¸Šå‚³åŒæ­¥å°åŒ…', 'error');
                        return;
                    }

                    try {
                        const response = await fetch(`${this.apiUrl}/station/sync/import`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                stationId: this.stationId,
                                packageId: this.uploadedPackage.packageId,
                                changes: this.uploadedPackage.changes,
                                checksum: this.uploadedPackage.checksum
                            })
                        });

                        if (response.ok) {
                            const data = await response.json();
                            this.importResult = data;

                            if (data.success) {
                                this.syncStats.syncedPackages += 1;
                                this.syncStats.lastSync = new Date().toLocaleString('zh-TW');
                                this.toast(`åŒ¯å…¥æˆåŠŸï¼š${data.changes_applied} é …è®Šæ›´å·²å¥—ç”¨`, 'success');

                                // é‡æ–°è¼‰å…¥è³‡æ–™
                                await this.loadStats();
                                await this.loadItems();
                                await this.loadBloodInventory();
                            } else {
                                this.toast(`åŒ¯å…¥å¤±æ•—ï¼š${data.message}`, 'error');
                            }
                        } else {
                            const error = await response.json();
                            this.importResult = {
                                success: false,
                                message: error.detail || 'åŒ¯å…¥å¤±æ•—'
                            };
                            this.toast(`åŒ¯å…¥å¤±æ•—ï¼š${error.detail}`, 'error');
                        }
                    } catch (error) {
                        console.error('åŒ¯å…¥åŒæ­¥å°åŒ…å¤±æ•—:', error);
                        this.importResult = {
                            success: false,
                            message: 'åŒ¯å…¥å¤±æ•—ï¼šç¶²è·¯éŒ¯èª¤'
                        };
                        this.toast('åŒ¯å…¥åŒæ­¥å°åŒ…å¤±æ•—', 'error');
                    }
                },

                // ========== è—¥å“é ˜ç”¨ API (MIRS v2.3 - Emergency Dispense) ==========

                // è¼‰å…¥å¾…è™•ç†é ˜ç”¨æ¸…å–®
                async loadPendingDispenses() {
                    try {
                        const response = await fetch(`${this.apiUrl}/pharmacy/dispense/pending`);
                        if (response.ok) {
                            const data = await response.json();
                            this.pendingDispenses = data.records || [];
                            console.log('å¾…è™•ç†é ˜ç”¨æ¸…å–®:', this.pendingDispenses);
                        } else {
                            console.error('è¼‰å…¥å¾…è™•ç†é ˜ç”¨æ¸…å–®å¤±æ•—');
                            this.toast('è¼‰å…¥å¾…è™•ç†é ˜ç”¨æ¸…å–®å¤±æ•—', 'error');
                        }
                    } catch (error) {
                        console.error('è¼‰å…¥å¾…è™•ç†é ˜ç”¨æ¸…å–®éŒ¯èª¤:', error);
                        this.toast('è¼‰å…¥å¾…è™•ç†é ˜ç”¨æ¸…å–®éŒ¯èª¤', 'error');
                    }
                },

                // æ­£å¸¸é ˜ç”¨ (éœ€å¯©æ ¸)
                async normalDispense() {
                    if (!this.dispenseForm.medicineCode) {
                        this.toast('è«‹é¸æ“‡è—¥å“', 'error');
                        return;
                    }

                    if (!this.dispenseForm.dispensedBy) {
                        this.toast('è«‹è¼¸å…¥é ˜è—¥äºº', 'error');
                        return;
                    }

                    try {
                        const response = await fetch(`${this.apiUrl}/pharmacy/dispense/normal`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                medicineCode: this.dispenseForm.medicineCode,
                                quantity: this.dispenseForm.quantity,
                                dispensedBy: this.dispenseForm.dispensedBy,
                                patientRefId: this.dispenseForm.patientRefId || null,
                                patientName: this.dispenseForm.patientName || null,
                                stationCode: this.dispenseForm.stationCode
                            })
                        });

                        const data = await response.json();

                        if (response.ok) {
                            this.toast(`æ­£å¸¸é ˜ç”¨è«‹æ±‚å·²é€å‡ºï¼Œç­‰å¾…è—¥å¸«å¯©æ ¸ (ID: ${data.dispense_id})`, 'success');
                            this.resetDispenseForm();
                            await this.loadPendingDispenses();
                        } else {
                            this.toast(`é ˜ç”¨å¤±æ•—: ${data.detail}`, 'error');
                        }
                    } catch (error) {
                        console.error('æ­£å¸¸é ˜ç”¨éŒ¯èª¤:', error);
                        this.toast('æ­£å¸¸é ˜ç”¨å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
                    }
                },

                // ç·Šæ€¥é ˜ç”¨ (Break-the-Glass)
                async emergencyDispense() {
                    if (!this.dispenseForm.medicineCode) {
                        this.toast('è«‹é¸æ“‡è—¥å“', 'error');
                        return;
                    }

                    if (!this.dispenseForm.dispensedBy) {
                        this.toast('è«‹è¼¸å…¥é ˜è—¥äºº', 'error');
                        return;
                    }

                    if (!this.dispenseForm.emergencyReason || this.dispenseForm.emergencyReason.length < 5) {
                        this.toast('ç·Šæ€¥åŸå› å¿…é ˆè‡³å°‘5å€‹å­—', 'error');
                        return;
                    }

                    try {
                        const response = await fetch(`${this.apiUrl}/pharmacy/dispense/emergency`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                medicineCode: this.dispenseForm.medicineCode,
                                quantity: this.dispenseForm.quantity,
                                dispensedBy: this.dispenseForm.dispensedBy,
                                emergencyReason: this.dispenseForm.emergencyReason,
                                patientRefId: this.dispenseForm.patientRefId || null,
                                patientName: this.dispenseForm.patientName || null,
                                stationCode: this.dispenseForm.stationCode
                            })
                        });

                        const data = await response.json();

                        if (response.ok) {
                            this.toast(`ç·Šæ€¥é ˜ç”¨æˆåŠŸï¼å·²ç«‹å³æ‰£é™¤åº«å­˜ (ID: ${data.dispense_id})`, 'success');
                            this.showEmergencyReasonModal = false;
                            this.resetDispenseForm();
                            await this.loadPendingDispenses();
                            await this.loadItems();
                            await this.loadStats();
                        } else {
                            this.toast(`ç·Šæ€¥é ˜ç”¨å¤±æ•—: ${data.detail}`, 'error');
                        }
                    } catch (error) {
                        console.error('ç·Šæ€¥é ˜ç”¨éŒ¯èª¤:', error);
                        this.toast('ç·Šæ€¥é ˜ç”¨å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
                    }
                },

                // é–‹å•Ÿè—¥å¸«å¯©æ ¸ Modal
                openPharmacistApproval(dispense) {
                    this.selectedDispenseForApproval = dispense;
                    this.pharmacistApprovalForm.dispenseId = dispense.id;
                    this.showPharmacistApprovalModal = true;
                },

                // è—¥å¸«å¯©æ ¸ç¢ºèª
                async submitPharmacistApproval() {
                    if (!this.pharmacistApprovalForm.approvedBy) {
                        this.toast('è«‹è¼¸å…¥è—¥å¸«å§“å', 'error');
                        return;
                    }

                    if (!this.pharmacistApprovalForm.pinCode) {
                        this.toast('è«‹è¼¸å…¥ PIN ç¢¼', 'error');
                        return;
                    }

                    try {
                        const response = await fetch(`${this.apiUrl}/pharmacy/dispense/approve`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                dispenseId: this.pharmacistApprovalForm.dispenseId,
                                approvedBy: this.pharmacistApprovalForm.approvedBy,
                                pharmacistNotes: this.pharmacistApprovalForm.pharmacistNotes || null,
                                pinCode: this.pharmacistApprovalForm.pinCode
                            })
                        });

                        const data = await response.json();

                        if (response.ok) {
                            const wasEmergency = this.selectedDispenseForApproval?.status === 'EMERGENCY';
                            this.toast(wasEmergency ? 'ç·Šæ€¥é ˜ç”¨å·²ç¢ºèª' : 'é ˜ç”¨å¯©æ ¸é€šéï¼Œå·²æ‰£é™¤åº«å­˜', 'success');
                            this.showPharmacistApprovalModal = false;
                            this.resetPharmacistApprovalForm();
                            await this.loadPendingDispenses();
                            await this.loadItems();
                            await this.loadStats();
                        } else {
                            if (response.status === 401) {
                                this.toast('PIN ç¢¼éŒ¯èª¤ï¼Œæ‹’çµ•å¯©æ ¸', 'error');
                            } else {
                                this.toast(`å¯©æ ¸å¤±æ•—: ${data.detail}`, 'error');
                            }
                        }
                    } catch (error) {
                        console.error('è—¥å¸«å¯©æ ¸éŒ¯èª¤:', error);
                        this.toast('è—¥å¸«å¯©æ ¸å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
                    }
                },

                // é‡ç½®é ˜ç”¨è¡¨å–®
                resetDispenseForm() {
                    this.dispenseForm = {
                        medicineCode: '',
                        quantity: 1,
                        dispensedBy: '',
                        patientRefId: '',
                        patientName: '',
                        stationCode: 'HC-000000',
                        emergencyReason: ''
                    };
                },

                // é‡ç½®è—¥å¸«å¯©æ ¸è¡¨å–®
                resetPharmacistApprovalForm() {
                    this.pharmacistApprovalForm = {
                        dispenseId: null,
                        approvedBy: '',
                        pharmacistNotes: '',
                        pinCode: ''
                    };
                    this.selectedDispenseForApproval = null;
                },

                // === æ‰¹æ¬¡é ˜ç”¨åŠŸèƒ½ (Batch Dispense) ===
                addBatchDispenseItem() {
                    this.batchDispenseForm.items.push({
                        medicineCode: '',
                        medicineName: '',
                        quantity: 1,
                        searchText: '',
                        showDropdown: false,
                        filteredItems: []
                    });
                },

                removeBatchDispenseItem(index) {
                    this.batchDispenseForm.items.splice(index, 1);
                },

                filterBatchDispenseItems(index) {
                    const item = this.batchDispenseForm.items[index];
                    const searchText = item.searchText.toLowerCase();

                    // åªé¡¯ç¤ºè—¥å“ (MED- é–‹é ­) - ä¸€èˆ¬ç‰©å“æ‡‰è©²é€éè™•ç½®æ¶ˆè€—æµç¨‹
                    const medicineItems = this.items.filter(i => i.code.startsWith('MED-'));

                    if (!searchText) {
                        item.filteredItems = medicineItems;
                    } else {
                        item.filteredItems = medicineItems.filter(i =>
                            i.code.toLowerCase().includes(searchText) ||
                            i.name.toLowerCase().includes(searchText)
                        );
                    }
                },

                selectBatchDispenseItem(index, selectedItem) {
                    const item = this.batchDispenseForm.items[index];
                    item.medicineCode = selectedItem.code;
                    item.medicineName = selectedItem.name;
                    item.searchText = `${selectedItem.code} - ${selectedItem.name}`;
                    item.showDropdown = false;
                },

                async submitBatchDispense() {
                    try {
                        if (this.batchDispenseForm.items.length === 0) {
                            this.toast('è«‹è‡³å°‘æ–°å¢ä¸€ç­†è—¥å“', 'error');
                            return;
                        }

                        if (!this.batchDispenseForm.dispensedBy) {
                            this.toast('è«‹è¼¸å…¥é ˜è—¥äºº', 'error');
                            return;
                        }

                        // å¦‚æœæ˜¯ç·Šæ€¥é ˜ç”¨ï¼Œéœ€è¦æª¢æŸ¥ç·Šæ€¥åŸå› 
                        if (this.batchDispenseForm.isEmergency) {
                            if (!this.batchDispenseForm.emergencyReason || this.batchDispenseForm.emergencyReason.length < 5) {
                                this.toast('ç·Šæ€¥åŸå› å¿…é ˆè‡³å°‘5å€‹å­—', 'error');
                                return;
                            }
                        }

                        // æ‰¹æ¬¡æäº¤æ¯å€‹è—¥å“é ˜ç”¨
                        let successCount = 0;
                        let failCount = 0;
                        const endpoint = this.batchDispenseForm.isEmergency ? 'emergency' : 'normal';

                        for (const item of this.batchDispenseForm.items) {
                            try {
                                const requestBody = {
                                    medicineCode: item.medicineCode,
                                    quantity: item.quantity,
                                    dispensedBy: this.batchDispenseForm.dispensedBy,
                                    patientRefId: this.batchDispenseForm.patientRefId || null,
                                    patientName: this.batchDispenseForm.patientName || null,
                                    stationCode: this.batchDispenseForm.stationCode
                                };

                                // ç·Šæ€¥é ˜ç”¨éœ€è¦åŠ ä¸Šç·Šæ€¥åŸå› 
                                if (this.batchDispenseForm.isEmergency) {
                                    requestBody.emergencyReason = this.batchDispenseForm.emergencyReason;
                                }

                                const response = await fetch(`${this.apiUrl}/pharmacy/dispense/${endpoint}`, {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify(requestBody)
                                });

                                if (response.ok) {
                                    successCount++;
                                } else {
                                    failCount++;
                                    const data = await response.json();
                                    console.error(`${item.medicineName} é ˜ç”¨å¤±æ•—:`, data.detail);
                                }
                            } catch (error) {
                                failCount++;
                                console.error(`${item.medicineName} é ˜ç”¨å¤±æ•—:`, error);
                            }
                        }

                        // é¡¯ç¤ºçµæœ
                        if (failCount === 0) {
                            const message = this.batchDispenseForm.isEmergency
                                ? `æˆåŠŸç·Šæ€¥é ˜ç”¨ ${successCount} é …è—¥å“ï¼Œå·²ç«‹å³æ‰£é™¤åº«å­˜`
                                : `æˆåŠŸé€å‡º ${successCount} é …é ˜ç”¨è«‹æ±‚ï¼Œç­‰å¾…è—¥å¸«å¯©æ ¸`;
                            this.toast(message, 'success');
                            this.resetBatchDispenseForm();
                            this.showEmergencyReasonModal = false;
                            await this.loadPendingDispenses();
                            await this.loadItems();
                            await this.loadStats();
                        } else {
                            this.toast(`æˆåŠŸ ${successCount} é …ï¼Œå¤±æ•— ${failCount} é …`, 'warning');
                            await this.loadPendingDispenses();
                            await this.loadItems();
                            await this.loadStats();
                        }
                    } catch (error) {
                        console.error('æ‰¹æ¬¡é ˜ç”¨å¤±æ•—:', error);
                        this.toast('æ‰¹æ¬¡é ˜ç”¨å¤±æ•—', 'error');
                    }
                },

                resetBatchDispenseForm() {
                    this.batchDispenseForm = {
                        dispensedBy: '',
                        patientRefId: '',
                        patientName: '',
                        items: [],
                        stationCode: this.stationId,
                        isEmergency: false,
                        emergencyReason: ''
                    };
                },

                // ============================================================
                // è—¥å±€æ’¥ç™¼åŠŸèƒ½ (MIRS v2.4 - Pharmacy Dispatch)
                // ============================================================

                async openDispatchModal() {
                    await this.ensureItemsLoaded();
                    await this.loadDispatchList();
                    this.showDispatchModal = true;
                },

                resetDispatchForm() {
                    this.dispatchForm = {
                        target_station_id: '',
                        target_station_name: '',
                        items: [{ code: '', name: '', quantity: 1, searchText: '', filteredItems: [], showDropdown: false }]
                    };
                },

                addDispatchItem() {
                    this.dispatchForm.items.push({
                        code: '',
                        name: '',
                        quantity: 1,
                        searchText: '',
                        filteredItems: [],
                        showDropdown: false
                    });
                },

                removeDispatchItem(index) {
                    if (this.dispatchForm.items.length > 1) {
                        this.dispatchForm.items.splice(index, 1);
                    }
                },

                filterDispatchItems(index) {
                    const searchText = this.dispatchForm.items[index].searchText.toLowerCase();
                    if (!searchText) {
                        this.dispatchForm.items[index].filteredItems = [];
                        return;
                    }
                    // åªé¡¯ç¤ºè—¥å“ (MED- å‰ç¶´)
                    this.dispatchForm.items[index].filteredItems = this.items.filter(item =>
                        item.code.startsWith('MED-') &&
                        (item.code.toLowerCase().includes(searchText) ||
                         item.name.toLowerCase().includes(searchText))
                    );
                },

                selectDispatchItem(index, med) {
                    this.dispatchForm.items[index].code = med.code;
                    this.dispatchForm.items[index].name = med.name;
                    this.dispatchForm.items[index].searchText = `${med.code} - ${med.name}`;
                    this.dispatchForm.items[index].showDropdown = false;
                    this.dispatchForm.items[index].filteredItems = [];
                },

                async loadDispatchList() {
                    try {
                        const response = await fetch(`${this.apiUrl}/pharmacy/dispatch`);
                        if (response.ok) {
                            const data = await response.json();
                            this.dispatchList = data.dispatches || [];
                        }
                    } catch (error) {
                        console.error('è¼‰å…¥æ’¥ç™¼å–®åˆ—è¡¨å¤±æ•—:', error);
                    }
                },

                async createDispatch() {
                    // é©—è­‰
                    const validItems = this.dispatchForm.items.filter(item => item.code && item.quantity > 0);
                    if (validItems.length === 0) {
                        this.toast('è«‹è‡³å°‘é¸æ“‡ä¸€é …è—¥å“', 'error');
                        return;
                    }

                    try {
                        // Step 1: å»ºç«‹æ’¥ç™¼å–® (DRAFT)
                        const createPayload = {
                            target_station_id: this.dispatchForm.target_station_id || null,
                            target_station_name: this.dispatchForm.target_station_name || null,
                            created_by: this.stationId || 'MIRS',
                            items: validItems.map(item => ({
                                medicine_code: item.code,
                                quantity: parseInt(item.quantity)
                            }))
                        };

                        const createResponse = await fetch(`${this.apiUrl}/pharmacy/dispatch`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(createPayload)
                        });

                        if (!createResponse.ok) {
                            const errData = await createResponse.json();
                            const errMsg = typeof errData.detail === 'string' ? errData.detail : JSON.stringify(errData.detail);
                            this.toast(`å»ºç«‹æ’¥ç™¼å–®å¤±æ•—: ${errMsg}`, 'error');
                            return;
                        }

                        const createData = await createResponse.json();
                        const dispatchId = createData.dispatch_id;

                        // Step 2: é æ‰£åº«å­˜ (DRAFT â†’ RESERVED)
                        const reserveResponse = await fetch(`${this.apiUrl}/pharmacy/dispatch/${dispatchId}/reserve`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ reserved_by: this.stationId || 'MIRS' })
                        });

                        if (!reserveResponse.ok) {
                            const errData = await reserveResponse.json();
                            const errMsg = typeof errData.detail === 'string' ? errData.detail : JSON.stringify(errData.detail);
                            this.toast(`é æ‰£åº«å­˜å¤±æ•—: ${errMsg}`, 'error');
                            // è‹¥é æ‰£å¤±æ•—å‰‡è‡ªå‹•å–æ¶ˆæ’¥ç™¼å–® (silent mode)
                            await this.cancelDispatch(dispatchId, true);
                            return;
                        }

                        // Step 3: å–å¾— QR Code ä¸¦æ¸²æŸ“ç‚ºåœ–ç‰‡
                        const qrResponse = await fetch(`${this.apiUrl}/pharmacy/dispatch/${dispatchId}/qr`);
                        if (!qrResponse.ok) {
                            this.toast('ç„¡æ³•å–å¾— QR Code', 'error');
                            return;
                        }

                        const qrData = await qrResponse.json();
                        console.log('[Dispatch] Got QR data:', qrData.qr_data?.length, 'chunks');
                        const qrCodes = await this.generateQRDataURLs(qrData.qr_data || []);
                        console.log('[Dispatch] Generated QR codes:', qrCodes.length, 'first data_url:', qrCodes[0]?.data_url?.substring(0, 50));

                        this.dispatchQRData = {
                            dispatch_id: dispatchId,
                            qr_codes: qrCodes,
                            current_index: 0
                        };
                        console.log('[Dispatch] dispatchQRData set:', this.dispatchQRData.qr_codes?.length);

                        this.toast('æ’¥ç™¼å–®å»ºç«‹æˆåŠŸï¼Œè«‹è®“è—¥å±€æƒæ QR Code', 'success');
                        this.resetDispatchForm();
                        await this.loadDispatchList();
                        await this.loadItems();
                        await this.loadStats();

                        // é¡¯ç¤º QR Modal
                        console.log('[Dispatch] Showing QR modal');
                        this.showDispatchQRModal = true;

                    } catch (error) {
                        console.error('å»ºç«‹æ’¥ç™¼å–®éŒ¯èª¤:', error);
                        this.toast('å»ºç«‹æ’¥ç™¼å–®å¤±æ•—', 'error');
                    }
                },

                // Adapter: ä½¿ç”¨ qrcodejs (DOM-based) ç”¢ç”Ÿ DataURL
                generateQRToDataURL(text, width = 250) {
                    return new Promise((resolve, reject) => {
                        try {
                            // 1. å‰µå»ºè‡¨æ™‚éš±è—å®¹å™¨
                            const tempDiv = document.createElement('div');
                            tempDiv.style.position = 'absolute';
                            tempDiv.style.left = '-9999px';
                            document.body.appendChild(tempDiv);

                            // 2. ä½¿ç”¨ qrcodejs ç”Ÿæˆ QR Code
                            new QRCode(tempDiv, {
                                text: text,
                                width: width,
                                height: width,
                                colorDark: "#000000",
                                colorLight: "#ffffff",
                                correctLevel: QRCode.CorrectLevel.L
                            });

                            // 3. å˜—è©¦å¾ Canvas æå– Data URL (æœ€ç©©å®š)
                            const canvas = tempDiv.querySelector('canvas');
                            if (canvas) {
                                const dataUrl = canvas.toDataURL("image/png");
                                document.body.removeChild(tempDiv);
                                resolve(dataUrl);
                                return;
                            }

                            // 4. Fallback: å»¶é²æŠ“å– img.src (é‡å°èˆŠç‰ˆç€è¦½å™¨)
                            setTimeout(() => {
                                const canvasRetry = tempDiv.querySelector('canvas');
                                if (canvasRetry) {
                                    const dataUrl = canvasRetry.toDataURL("image/png");
                                    document.body.removeChild(tempDiv);
                                    resolve(dataUrl);
                                } else {
                                    const img = tempDiv.querySelector('img');
                                    document.body.removeChild(tempDiv);
                                    if (img && img.src) {
                                        resolve(img.src);
                                    } else {
                                        reject(new Error("Failed to generate QR Data URL"));
                                    }
                                }
                            }, 50);
                        } catch (e) {
                            reject(e);
                        }
                    });
                },

                // å°‡ XIR1 chunk strings è½‰æ›ç‚º QR Code DataURL
                async generateQRDataURLs(chunks) {
                    console.log('[Dispatch] generateQRDataURLs called with', chunks?.length, 'chunks');
                    if (!chunks || chunks.length === 0) {
                        console.error('[Dispatch] No chunks provided');
                        return [];
                    }

                    if (typeof QRCode === 'undefined') {
                        console.error('[Dispatch] QRCode library not loaded (qrcodejs)');
                        return chunks.map(chunk => ({ chunk, data_url: '' }));
                    }

                    const results = [];
                    for (const chunk of chunks) {
                        try {
                            console.log('[Dispatch] Generating QR for chunk:', chunk.substring(0, 30) + '...');
                            // ä½¿ç”¨ Adapter å‡½å¼ (qrcodejs DOM-based)
                            const dataUrl = await this.generateQRToDataURL(chunk, 250);
                            console.log('[Dispatch] QR generated, dataUrl length:', dataUrl?.length);
                            results.push({ chunk, data_url: dataUrl });
                        } catch (e) {
                            console.error('[Dispatch] QR generation failed:', e);
                            results.push({ chunk, data_url: '' });
                        }
                    }
                    console.log('[Dispatch] Generated', results.length, 'QR codes');
                    return results;
                },

                async showDispatchQR(dispatch) {
                    try {
                        const response = await fetch(`${this.apiUrl}/pharmacy/dispatch/${dispatch.dispatch_id}/qr`);
                        if (response.ok) {
                            const data = await response.json();
                            const qrCodes = await this.generateQRDataURLs(data.qr_data || []);
                            this.dispatchQRData = {
                                dispatch_id: dispatch.dispatch_id,
                                qr_codes: qrCodes,
                                current_index: 0
                            };
                            this.showDispatchQRModal = true;
                        } else {
                            this.toast('ç„¡æ³•å–å¾— QR Code', 'error');
                        }
                    } catch (error) {
                        console.error('å–å¾— QR Code å¤±æ•—:', error);
                        this.toast('å–å¾— QR Code å¤±æ•—', 'error');
                    }
                },

                async confirmDispatch(dispatchId) {
                    try {
                        const response = await fetch(`${this.apiUrl}/pharmacy/dispatch/${dispatchId}/confirm`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ dispatched_by: this.stationId || 'MIRS' })
                        });

                        if (response.ok) {
                            this.toast('æ’¥ç™¼å–®å·²ç¢ºèªé€å‡º', 'success');
                            this.showDispatchQRModal = false;
                            await this.loadDispatchList();
                            await this.loadItems();
                            await this.loadStats();
                        } else {
                            const errData = await response.json();
                            const errMsg = typeof errData.detail === 'string' ? errData.detail : JSON.stringify(errData.detail);
                            this.toast(`ç¢ºèªå¤±æ•—: ${errMsg}`, 'error');
                        }
                    } catch (error) {
                        console.error('ç¢ºèªæ’¥ç™¼å–®å¤±æ•—:', error);
                        this.toast('ç¢ºèªæ’¥ç™¼å–®å¤±æ•—', 'error');
                    }
                },

                async cancelDispatch(dispatchId, silent = false) {
                    if (!silent && !confirm('ç¢ºå®šè¦å–æ¶ˆæ­¤æ’¥ç™¼å–®å—ï¼Ÿåº«å­˜å°‡æœƒé‡‹æ”¾å›å¯ç”¨ç‹€æ…‹ã€‚')) {
                        return;
                    }

                    try {
                        const response = await fetch(`${this.apiUrl}/pharmacy/dispatch/${dispatchId}`, {
                            method: 'DELETE'
                        });

                        if (response.ok) {
                            if (!silent) {
                                this.toast('æ’¥ç™¼å–®å·²å–æ¶ˆ', 'success');
                            }
                            await this.loadDispatchList();
                            await this.loadItems();
                            await this.loadStats();
                        } else {
                            const errData = await response.json();
                            if (!silent) {
                                this.toast(`å–æ¶ˆå¤±æ•—: ${errData.detail || 'æœªçŸ¥éŒ¯èª¤'}`, 'error');
                            }
                        }
                    } catch (error) {
                        console.error('å–æ¶ˆæ’¥ç™¼å–®å¤±æ•—:', error);
                        if (!silent) {
                            this.toast('å–æ¶ˆæ’¥ç™¼å–®å¤±æ•—', 'error');
                        }
                    }
                },

                // æ ¼å¼åŒ–ä½å…ƒçµ„å¤§å°
                formatBytes(bytes) {
                    if (!bytes) return '0 Bytes';
                    const k = 1024;
                    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                    const i = Math.floor(Math.log(bytes) / Math.log(k));
                    return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
                }
            };
        }
    </script>
</body>
</html>
