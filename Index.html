<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>ÈÜ´ÁôÇÁ´ôÂ∫´Â≠òÁÆ°ÁêÜÁ≥ªÁµ± v1.5.0</title>
    <!-- v1.5.0: Êú¨Âú∞Âåñ‰æùË≥¥ÔºåÊîØÊè¥Èõ¢Á∑öÈÅã‰Ωú -->
    <link rel="stylesheet" href="/static/css/tailwind.min.css">
    <link rel="stylesheet" href="/static/css/mirs-colors.css">
    <script defer src="/static/js/alpine.min.js"></script>
    <script src="/static/js/qrcode.min.js"></script>
    <script>
        // È©óË≠â QRCode ËºâÂÖ•
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof QRCode !== 'undefined') {
                console.log('[QRCode] qrcodejs library loaded successfully');
            } else {
                console.error('[QRCode] qrcodejs library NOT loaded');
            }
        });
    </script>
    <style>
        [x-cloak] { display: none !important; }
        
        /* Ê∑∫ teal ËÉåÊôØÊº∏ËÆä */
        body {
            background: linear-gradient(135deg, #f0f9f8 0%, #e6f7f5 25%, #f5f8ff 50%, #faf5ff 75%, #fff 100%);
            background-attachment: fixed;
        }

        /* Ëá™ÂÆöÁæ©ÊªæÂãïÊ¢ù */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* Ë°®Ê†ºÊñëÈ¶¨Á¥ãÂÑ™Âåñ */
        .table-hover tbody tr:hover {
            background-color: #f0f9ff;
            transition: background-color 0.2s;
        }

        /* ÈüøÊáâÂºèÁµ±Ë®àÂç°ÁâáÂÑ™Âåñ */
        @media (max-width: 640px) {
            .stat-card {
                height: 6rem;
                padding: 0.75rem;
            }
            .stat-card .text-2xl {
                font-size: 1.5rem;
            }
        }
    </style>
</head>
<body class="min-h-screen">
    <div x-data="medicalInventory()" x-init="init()" x-cloak class="w-full max-w-7xl mx-auto px-3 sm:px-4 md:px-6 py-4 sm:py-6">

        <!-- Demo Mode Banner -->
        <div x-show="demoMode" class="bg-amber-50 border border-amber-200 rounded-xl p-4 mb-4 shadow-sm">
            <div class="flex items-center justify-between flex-wrap gap-3">
                <div class="flex items-center gap-3">
                    <div class="p-2 bg-amber-100 rounded-lg">
                        <svg class="w-5 h-5 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <div>
                        <p class="font-semibold text-amber-800">Â±ïÁ§∫Ê®°Âºè Demo Mode (ÂîØËÆÄ)</p>
                        <p class="text-sm text-amber-600">
                            ‚ö†Ô∏è <strong>Â∑≤Áü•ÈôêÂà∂</strong>ÔºöÂõ† Serverless Êû∂ÊßãÔºåË≥áÊñô‰øÆÊîπÁÑ°Ê≥ïÂç≥ÊôÇÂèçÊò†„ÄÇ
                            Ëã•ÈúÄÂÆåÊï¥Ê∏¨Ë©¶ÂäüËÉΩÔºåË´ã‰ΩøÁî®Êú¨Ê©üÁâàÊú¨ (localhost:8000) ÊàñÊ®πËéìÊ¥æÂØ¶Ê©üÈÉ®ÁΩ≤„ÄÇ
                        </p>
                        <details class="mt-1">
                            <summary class="text-xs text-amber-500 cursor-pointer hover:text-amber-700">Ë©≥Á¥∞Ë™™Êòé...</summary>
                            <ul class="text-xs text-amber-600 mt-1 ml-4 list-disc space-y-0.5">
                                <li>‰øÆÊîπË®≠ÂÇôÊï∏Èáè„ÄÅÊèíÁÆ°‰∫∫Êï∏Á≠â ‚Üí Ë®àÁÆóÁµêÊûúÂèØËÉΩ‰∏çÊúÉÁ´ãÂç≥Êõ¥Êñ∞</li>
                                <li>ÊØèÊ¨°È†ÅÈù¢ÈáçÊï¥ÂèØËÉΩÈÄ£Êé•Âà∞‰∏çÂêå‰º∫ÊúçÂô®ÂØ¶‰æãÔºàÂÜ∑ÂïüÂãïÔºâ</li>
                                <li>ÈªûÊìä„ÄåÈáçÁΩÆË≥áÊñô„ÄçÂèØÂº∑Âà∂ÈáçÊñ∞ËºâÂÖ•ÂàùÂßãÂ±ïÁ§∫Ë≥áÊñô</li>
                            </ul>
                        </details>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <a href="https://github.com/chihkang/MIRS" target="_blank"
                       class="inline-flex items-center gap-1 px-3 py-1.5 bg-gray-800 text-white text-sm rounded-lg hover:bg-gray-700 transition-colors">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                            <path fill-rule="evenodd" d="M12 2C6.477 2 2 6.484 2 12.017c0 4.425 2.865 8.18 6.839 9.504.5.092.682-.217.682-.483 0-.237-.008-.868-.013-1.703-2.782.605-3.369-1.343-3.369-1.343-.454-1.158-1.11-1.466-1.11-1.466-.908-.62.069-.608.069-.608 1.003.07 1.531 1.032 1.531 1.032.892 1.53 2.341 1.088 2.91.832.092-.647.35-1.088.636-1.338-2.22-.253-4.555-1.113-4.555-4.951 0-1.093.39-1.988 1.029-2.688-.103-.253-.446-1.272.098-2.65 0 0 .84-.27 2.75 1.026A9.564 9.564 0 0112 6.844c.85.004 1.705.115 2.504.337 1.909-1.296 2.747-1.027 2.747-1.027.546 1.379.202 2.398.1 2.651.64.7 1.028 1.595 1.028 2.688 0 3.848-2.339 4.695-4.566 4.943.359.309.678.92.678 1.855 0 1.338-.012 2.419-.012 2.747 0 .268.18.58.688.482A10.019 10.019 0 0022 12.017C22 6.484 17.522 2 12 2z" clip-rule="evenodd"></path>
                        </svg>
                        GitHub
                    </a>
                    <button @click="resetDemo()"
                            class="inline-flex items-center gap-1 px-3 py-1.5 bg-amber-500 text-white text-sm rounded-lg hover:bg-amber-600 transition-colors">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                        </svg>
                        ÈáçÁΩÆË≥áÊñô
                    </button>
                </div>
            </div>
        </div>

        <!-- Header -->
        <div class="bg-white rounded-xl sm:rounded-2xl shadow-lg p-3 sm:p-4 md:p-6 mb-4 sm:mb-6">
            <div class="flex items-center justify-between flex-wrap gap-3 sm:gap-4">
                <div class="flex items-center gap-2 sm:gap-3 md:gap-4">
                    <!-- Âè§ÈôµLogo -->
                    <a href="https://denovortho-site.vercel.app/zh-TW/resilience" target="_blank" class="flex-shrink-0 hover:opacity-80 transition-opacity">
                        <img src="/static/guling_logo.png" alt="De Novo Orthopedics Logo" class="h-10 sm:h-12 md:h-16 w-auto object-contain">
                    </a>

                    <div class="border-l border-gray-300 pl-2 sm:pl-3 md:pl-4">
                        <h1 class="text-lg sm:text-xl md:text-2xl font-bold text-gray-800 flex items-center gap-1 sm:gap-2">
                            <svg class="w-5 h-5 sm:w-6 sm:h-6 md:w-7 md:h-7 text-teal-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                            </svg>
                            BORPÂÇôÊè¥ÊâãË°ìÁ´ôÔºàÂñÆÁ´ôÁâàÔºâ
                        </h1>
                        <p class="text-xs sm:text-sm text-gray-500">
                            BORP-DNO-01 - v2.9.1
                        </p>
                        <div class="hidden sm:flex items-center gap-2 mt-1 text-xs text-gray-400">
                            <span class="font-medium">Designed in Taiwan</span>
                            <span>‚Ä¢</span>
                            <span>De Novo Orthopedics Inc</span>
                        </div>
                    </div>
                </div>
                <div class="flex items-center gap-2 sm:gap-4">
                    <!-- È∫ªÈÜâÁ´ô PWA ÊåâÈàï -->
                    <a href="/anesthesia" target="_blank"
                       class="flex items-center gap-1.5 px-3 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg text-sm font-medium transition-colors">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
                        </svg>
                        <span class="hidden sm:inline">È∫ªÈÜâÁ´ô</span>
                    </a>
                    <!-- EMT Transfer PWA ÊåâÈàï -->
                    <a href="/emt" target="_blank"
                       class="flex items-center gap-1.5 px-3 py-2 bg-orange-600 hover:bg-orange-700 text-white rounded-lg text-sm font-medium transition-colors">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                        </svg>
                        <span class="hidden sm:inline">ËΩâÈÄÅ</span>
                    </a>
                    <!-- Mobile ÈÖçÂ∞çÊåâÈàï -->
                    <button @click="showMobilePairing = true; pairingInfo = null; pairingError = null"
                            class="flex items-center gap-1.5 px-3 py-2 bg-teal-600 hover:bg-teal-700 text-white rounded-lg text-sm font-medium transition-colors">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                        </svg>
                        <span class="hidden sm:inline">Ë°åÂãïÈÖçÂ∞ç</span>
                    </button>
                    <!-- ÈÖçÂ∞çË®òÈåÑÊåâÈàï -->
                    <button @click="showPairedDevices = true; loadPairedDevices()"
                            class="flex items-center gap-1.5 px-2 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg text-sm font-medium transition-colors"
                            title="ÈÖçÂ∞çË®òÈåÑ">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                        </svg>
                        <span class="hidden sm:inline">ÈÖçÂ∞çË®òÈåÑ</span>
                    </button>
                    <div class="text-right">
                        <p class="text-xs text-gray-400">
                            <span x-text="currentTime"></span>
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Mobile ÈÖçÂ∞ç Modal (GitHub Device Flow È¢®Ê†º) -->
        <div x-show="showMobilePairing" x-cloak
             class="fixed inset-0 z-50 flex items-center justify-center bg-black/50"
             @click.self="showMobilePairing = false">
            <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg mx-4 overflow-hidden max-h-[90vh] overflow-y-auto">
                <div class="sticky top-0 bg-teal-600 text-white px-6 py-4 z-10">
                    <h3 class="text-lg font-semibold flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                        </svg>
                        MIRS Mobile ÈÖçÂ∞ç
                    </h3>
                    <p class="text-teal-100 text-sm mt-1">ËÆì‰∫∫Âì°‰ΩøÁî®ÊâãÊ©üÈÄ≤Ë°åÂ∑°ÊàøÊ™¢Êü•</p>
                </div>

                <!-- ÈÖçÁΩÆÊ≠•È©üÔºöÈÅ∏ÊìáËßíËâ≤ËàáÊ¨äÈôê -->
                <div x-show="!pairingInfo && !pairingLoading && !pairingError" class="p-6">
                    <div class="space-y-4">
                        <!-- ËßíËâ≤ÈÅ∏Êìá -->
                        <div>
                            <label class="text-sm font-medium text-gray-700 block mb-2">ÈÖçÂ∞çËßíËâ≤</label>
                            <select x-model="pairingConfig.role"
                                    class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-teal-500 focus:border-transparent">
                                <option value="nurse">Ë≠∑ÁêÜÂ∏´</option>
                                <option value="warehouse">Â∫´Êàø‰∫∫Âì°</option>
                                <option value="maintenance">Â∑•Âãô / Ë®≠ÂÇôÁ∂≠Ë≠∑</option>
                                <option value="admin">ÁÆ°ÁêÜÂì°</option>
                            </select>
                        </div>

                        <!-- ÂäüËÉΩÊ¨äÈôêÈñãÈóú -->
                        <div>
                            <label class="text-sm font-medium text-gray-700 block mb-2">ÂïüÁî®ÂäüËÉΩ</label>
                            <div class="space-y-3 bg-gray-50 rounded-xl p-4">
                                <!-- Ë®≠ÂÇôÊ™¢Êü• -->
                                <label class="flex items-center justify-between cursor-pointer">
                                    <div class="flex items-center gap-3">
                                        <div class="w-8 h-8 bg-teal-100 rounded-lg flex items-center justify-center">
                                            <svg class="w-4 h-4 text-teal-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                            </svg>
                                        </div>
                                        <span class="text-gray-700">Ë®≠ÂÇôÊ™¢Êü•</span>
                                    </div>
                                    <div class="relative">
                                        <input type="checkbox" x-model="pairingConfig.scopes.equipment" class="sr-only">
                                        <div class="toggle-switch toggle-teal" :class="pairingConfig.scopes.equipment ? 'active' : ''"></div>
                                    </div>
                                </label>
                                <!-- Â∫´Â≠òÁõ§Èªû -->
                                <label class="flex items-center justify-between cursor-pointer">
                                    <div class="flex items-center gap-3">
                                        <div class="w-8 h-8 bg-cyan-100 rounded-lg flex items-center justify-center">
                                            <svg class="w-4 h-4 text-cyan-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                                            </svg>
                                        </div>
                                        <span class="text-gray-700">Â∫´Â≠òÁõ§Èªû</span>
                                    </div>
                                    <div class="relative">
                                        <input type="checkbox" x-model="pairingConfig.scopes.inventory" class="sr-only">
                                        <div class="toggle-switch toggle-cyan" :class="pairingConfig.scopes.inventory ? 'active' : ''"></div>
                                    </div>
                                </label>
                                <!-- Ë°ÄË¢ãÂÖ•Â∫´ -->
                                <label class="flex items-center justify-between cursor-pointer">
                                    <div class="flex items-center gap-3">
                                        <div class="w-8 h-8 bg-red-100 rounded-lg flex items-center justify-center">
                                            <svg class="w-4 h-4 text-[#D96754]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"/>
                                            </svg>
                                        </div>
                                        <span class="text-gray-700">Ë°ÄË¢ãÂÖ•Â∫´</span>
                                    </div>
                                    <div class="relative">
                                        <input type="checkbox" x-model="pairingConfig.scopes.bloodReceive" class="sr-only">
                                        <div class="toggle-switch toggle-blood" :class="pairingConfig.scopes.bloodReceive ? 'active' : ''"></div>
                                    </div>
                                </label>
                                <!-- ËÄóÊùêÂÖ•Â∫´ -->
                                <label class="flex items-center justify-between cursor-pointer">
                                    <div class="flex items-center gap-3">
                                        <div class="w-8 h-8 bg-sky-100 rounded-lg flex items-center justify-center">
                                            <svg class="w-4 h-4 text-sky-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"/>
                                            </svg>
                                        </div>
                                        <span class="text-gray-700">ËÄóÊùêÂÖ•Â∫´</span>
                                    </div>
                                    <div class="relative">
                                        <input type="checkbox" x-model="pairingConfig.scopes.supplyReceive" class="sr-only">
                                        <div class="toggle-switch toggle-sky" :class="pairingConfig.scopes.supplyReceive ? 'active' : ''"></div>
                                    </div>
                                </label>
                            </div>
                        </div>

                        <!-- Áî¢ÁîüÈÖçÂ∞çÁ¢ºÊåâÈàï -->
                        <button @click="generatePairingCode()"
                                class="w-full bg-teal-600 text-white rounded-xl py-3 font-semibold hover:bg-teal-700 transition-colors flex items-center justify-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z"/>
                            </svg>
                            Áî¢ÁîüÈÖçÂ∞çÁ¢º
                        </button>
                    </div>
                </div>

                <!-- Loading ÁãÄÊÖã -->
                <div x-show="pairingLoading" class="p-8 text-center">
                    <div class="animate-spin w-10 h-10 border-4 border-teal-600 border-t-transparent rounded-full mx-auto mb-4"></div>
                    <p class="text-gray-500">Áî¢ÁîüÈÖçÂ∞çÁ¢º‰∏≠...</p>
                </div>

                <!-- ÈåØË™§ÁãÄÊÖã -->
                <div x-show="pairingError && !pairingLoading" class="p-6 text-center">
                    <div class="text-red-500 text-4xl mb-4">‚ö†Ô∏è</div>
                    <p class="text-red-600 mb-4" x-text="pairingError"></p>
                    <button @click="pairingError = null"
                            class="px-4 py-2 bg-teal-600 text-white rounded-lg hover:bg-teal-700">
                        ÈáçË©¶
                    </button>
                </div>

                <!-- ÊàêÂäüÁãÄÊÖãÔºöQR Code + ÈÖçÂ∞çÁ¢º -->
                <div x-show="pairingInfo && !pairingLoading && !pairingError" class="p-6">
                    <!-- Ê≠•È©üË™™Êòé -->
                    <div class="flex items-start gap-4 mb-6 p-4 bg-teal-50 rounded-xl">
                        <div class="flex-shrink-0 w-8 h-8 bg-teal-600 text-white rounded-full flex items-center justify-center font-bold">1</div>
                        <div>
                            <p class="font-medium text-gray-800">Áî®ÊâãÊ©üÊéÉÊèè QR Code</p>
                            <p class="text-sm text-gray-500">ÈñãÂïü MIRS Mobile Á∂≤È†Å</p>
                        </div>
                    </div>

                    <!-- ÂÖ©Ê¨ÑÔºöQR Code + ÈÖçÂ∞çÁ¢º -->
                    <div class="grid grid-cols-2 gap-6 mb-6">
                        <!-- QR Code -->
                        <div class="text-center">
                            <div class="bg-white border-2 border-gray-200 rounded-xl p-2 inline-block">
                                <img :src="pairingQRUrl" alt="Mobile PWA QR Code" class="w-32 h-32">
                            </div>
                            <p class="text-xs text-gray-400 mt-2">ÊéÉÊèèÈñãÂïüÁ∂≤È†Å</p>
                        </div>

                        <!-- ÈÖçÂ∞çÁ¢º -->
                        <div class="text-center flex flex-col justify-center">
                            <div class="flex items-start gap-4 mb-2 p-3 bg-gray-50 rounded-xl">
                                <div class="flex-shrink-0 w-6 h-6 bg-teal-600 text-white rounded-full flex items-center justify-center font-bold text-sm">2</div>
                                <p class="text-sm text-gray-600 text-left">Ëº∏ÂÖ•ÈÖçÂ∞çÁ¢º</p>
                            </div>
                            <div class="bg-gray-100 rounded-xl py-4 px-2">
                                <div class="text-3xl font-mono font-bold tracking-[0.3em] text-teal-600" x-text="pairingInfo?.pairing_code || '------'"></div>
                            </div>
                            <p class="text-sm text-gray-500 mt-2">
                                ÊúâÊïàÊôÇÈñìÔºö<span class="font-medium text-orange-600" x-text="pairingExpiry"></span>
                            </p>
                        </div>
                    </div>

                    <!-- Hub IP Ë≥áË®ä -->
                    <div class="bg-gray-50 rounded-xl p-4 mb-4">
                        <div class="flex items-center justify-between text-sm">
                            <span class="text-gray-500">Hub IP:</span>
                            <span class="font-mono font-medium text-gray-800" x-text="pairingInfo?.hub_ip || 'N/A'"></span>
                        </div>
                        <div class="flex items-center justify-between text-sm mt-2">
                            <span class="text-gray-500">Mobile URL:</span>
                            <code class="text-xs bg-white px-2 py-1 rounded text-gray-700" x-text="pairingInfo?.mobile_url || ''"></code>
                        </div>
                    </div>

                    <!-- WiFi ÊèêÈÜí -->
                    <div class="bg-yellow-50 border border-yellow-200 rounded-xl p-3 text-sm">
                        <p class="text-yellow-800">
                            <span class="font-medium">‚ö†Ô∏è Á¢∫Ë™çÊâãÊ©üËàáÊ≠§ÈõªËÖ¶Âú®Âêå‰∏ÄÂÄã WiFi Á∂≤Ë∑Ø</span>
                        </p>
                    </div>

                    <!-- ÈáçÊñ∞Áî¢ÁîüÊåâÈàï -->
                    <div class="text-center mt-4">
                        <button @click="generatePairingCode()"
                                class="text-teal-600 hover:text-teal-700 text-sm font-medium">
                            üîÑ ÈáçÊñ∞Áî¢ÁîüÈÖçÂ∞çÁ¢º
                        </button>
                    </div>
                </div>

                <div class="bg-gray-50 px-6 py-3 flex justify-end border-t">
                    <button @click="showMobilePairing = false; pairingInfo = null; pairingQRUrl = ''"
                            class="px-4 py-2 text-gray-600 hover:text-gray-800 font-medium">
                        ÈóúÈñâ
                    </button>
                </div>
            </div>
        </div>

        <!-- ÈÖçÂ∞çË®òÈåÑ Modal -->
        <div x-show="showPairedDevices" x-cloak
             class="fixed inset-0 z-50 flex items-center justify-center bg-black/50"
             @click.self="showPairedDevices = false">
            <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl mx-4 overflow-hidden max-h-[90vh] overflow-y-auto">
                <div class="sticky top-0 bg-gray-700 text-white px-6 py-4 z-10">
                    <h3 class="text-lg font-semibold flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                        </svg>
                        Â∑≤ÈÖçÂ∞çË£ùÁΩÆË®òÈåÑ
                    </h3>
                    <p class="text-gray-300 text-sm mt-1">Êü•ÁúãÂíåÁÆ°ÁêÜÂ∑≤ÈÖçÂ∞çÁöÑË°åÂãïË£ùÁΩÆ</p>
                </div>

                <div class="p-6">
                    <!-- ËºâÂÖ•‰∏≠ -->
                    <div x-show="pairedDevicesLoading" class="text-center py-8">
                        <div class="animate-spin w-8 h-8 border-4 border-gray-300 border-t-teal-600 rounded-full mx-auto mb-3"></div>
                        <p class="text-gray-500">ËºâÂÖ•‰∏≠...</p>
                    </div>

                    <!-- ÁÑ°Ë®òÈåÑ -->
                    <div x-show="!pairedDevicesLoading && pairedDevices.length === 0" class="text-center py-8">
                        <svg class="w-12 h-12 text-gray-300 mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                        </svg>
                        <p class="text-gray-500">Â∞öÁÑ°ÈÖçÂ∞çË®òÈåÑ</p>
                    </div>

                    <!-- Ë£ùÁΩÆÂàóË°® -->
                    <div x-show="!pairedDevicesLoading && pairedDevices.length > 0" class="space-y-3">
                        <template x-for="device in pairedDevices" :key="device.device_id">
                            <div class="bg-gray-50 rounded-xl p-4 border" :class="device.revoked ? 'border-red-200 opacity-60' : 'border-gray-200'">
                                <div class="flex items-start justify-between gap-3">
                                    <div class="flex items-start gap-3">
                                        <div class="w-10 h-10 rounded-full flex items-center justify-center text-white font-bold"
                                             :class="device.revoked ? 'bg-gray-400' : 'bg-teal-600'">
                                            <span x-text="(device.staff_name || 'U')[0]"></span>
                                        </div>
                                        <div class="min-w-0">
                                            <div class="font-semibold text-gray-800 flex items-center gap-2">
                                                <span x-text="device.staff_name || 'Êú™Áü•'"></span>
                                                <span x-show="device.revoked" class="text-xs bg-red-100 text-red-600 px-2 py-0.5 rounded-full">Â∑≤Êí§Èä∑</span>
                                            </div>
                                            <div class="text-sm text-gray-500" x-text="device.role === 'admin' ? 'ÁÆ°ÁêÜÂì°' : device.role === 'nurse' ? 'Ë≠∑ÁêÜÂ∏´' : device.role"></div>
                                            <div class="text-xs text-gray-400 mt-1">
                                                <span>Ë£ùÁΩÆ ID: </span>
                                                <span x-text="device.device_id.substring(0, 8) + '...'"></span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="text-right text-xs text-gray-400">
                                        <div>ÈÖçÂ∞ç: <span x-text="new Date(device.paired_at).toLocaleString('zh-TW')"></span></div>
                                        <div x-show="device.last_seen">
                                            ÊúÄÂæåÊ¥ªÂãï: <span x-text="device.last_seen ? new Date(device.last_seen).toLocaleString('zh-TW') : '-'"></span>
                                        </div>
                                    </div>
                                </div>
                                <!-- Êí§Èä∑ÊåâÈàï -->
                                <div x-show="!device.revoked" class="mt-3 pt-3 border-t border-gray-200 flex justify-end">
                                    <button @click="revokeDevice(device.device_id)"
                                            class="text-sm text-red-600 hover:text-red-800 font-medium">
                                        Êí§Èä∑ÈÖçÂ∞ç
                                    </button>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>

                <div class="bg-gray-50 px-6 py-3 flex justify-between items-center border-t">
                    <button @click="loadPairedDevices()"
                            class="text-sm text-teal-600 hover:text-teal-800 font-medium flex items-center gap-1">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                        </svg>
                        ÈáçÊñ∞Êï¥ÁêÜ
                    </button>
                    <button @click="showPairedDevices = false"
                            class="px-4 py-2 text-gray-600 hover:text-gray-800 font-medium">
                        ÈóúÈñâ
                    </button>
                </div>
            </div>
        </div>

        <!-- Áµ±Ë®àÂç°Áâá -->
        <!-- Á≤æÁ∞°Áµ±Ë®àÂç°Áâá - ÁÅ∞ÈöéÈÖçËâ≤ -->
        <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-5 gap-2 mb-4">
            <!-- Á∏ΩÁâ©ÂìÅÊï∏ -->
            <div class="bg-white rounded-lg shadow-sm p-2.5">
                <div class="flex items-center gap-2">
                    <div class="p-1.5 bg-gray-100 rounded">
                        <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                        </svg>
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="text-xs text-gray-500 truncate">Á∏ΩÁâ©ÂìÅÊï∏</p>
                        <p class="text-lg font-bold text-gray-700" x-text="stats.totalItems"></p>
                    </div>
                </div>
            </div>

            <!-- Â∫´Â≠òË≠¶Êàí -->
            <div class="bg-white rounded-lg shadow-sm p-2.5">
                <div class="flex items-center gap-2">
                    <div class="p-1.5 bg-gray-100 rounded">
                        <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                        </svg>
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center gap-1">
                            <p class="text-xs text-gray-500 truncate">Â∫´Â≠òË≠¶Êàí</p>
                            <div class="group relative cursor-help">
                                <svg class="w-3 h-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                <div class="invisible group-hover:visible absolute bottom-full left-0 mb-1 px-2 py-1 bg-gray-800 text-white text-xs rounded whitespace-nowrap z-50">
                                    ÂÉÖÁµ±Ë®àÊúâÈÄ≤Ë≤®Ë®òÈåÑÁöÑÂìÅÈ†Ö
                                </div>
                            </div>
                        </div>
                        <p class="text-lg font-bold text-gray-700" x-text="stats.lowStockItems"></p>
                    </div>
                </div>
            </div>

            <!-- Ë°ÄË¢ãÂ∫´Â≠ò -->
            <div class="bg-white rounded-lg shadow-sm p-2.5">
                <div class="flex items-center gap-2">
                    <div class="p-1.5 bg-gray-100 rounded">
                        <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
                        </svg>
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="text-xs text-gray-500 truncate">Ë°ÄË¢ãÂ∫´Â≠ò</p>
                        <p class="text-lg font-bold text-gray-700"><span x-text="stats.totalBlood"></span> U</p>
                    </div>
                </div>
            </div>

            <!-- ÂæÖÁ¢∫Ë™çË®≠ÂÇô -->
            <div class="bg-white rounded-lg shadow-sm p-2.5">
                <div class="flex items-center gap-2">
                    <div class="p-1.5 bg-gray-100 rounded">
                        <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z"></path>
                        </svg>
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="text-xs text-gray-500 truncate">ÂæÖÁ¢∫Ë™çË®≠ÂÇô</p>
                        <p class="text-lg font-bold text-gray-700" x-text="stats.equipmentAlerts"></p>
                    </div>
                </div>
            </div>

            <!-- ÂèØÁç®Á´ãÈÅã‰Ωú -->
            <div class="bg-white rounded-lg shadow-sm p-2.5">
                <div class="flex items-center gap-2">
                    <div class="p-1.5 bg-gray-100 rounded">
                        <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
                        </svg>
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="text-xs text-gray-500 truncate">ÂèØÁç®Á´ãÈÅã‰Ωú</p>
                        <p class="text-lg font-bold"
                           :class="{
                               'text-red-600': resilienceStatus.summary?.overall_status === 'CRITICAL',
                               'text-yellow-600': resilienceStatus.summary?.overall_status === 'WARNING',
                               'text-green-600': resilienceStatus.summary?.overall_status === 'SAFE',
                               'text-gray-400': !resilienceStatus.summary?.weakest_link
                           }">
                            <span x-text="resilienceStatus.summary?.weakest_link?.hours?.toFixed(1) || '‚Äî'"></span>
                            <span class="text-xs font-normal" x-show="resilienceStatus.summary?.weakest_link">h</span>
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- ÂàÜÈ†ÅÈÅ∏ÂñÆ - Ê∑±Ëâ≤Â∫ïÁôΩÂ≠ó -->
        <div class="bg-white rounded-xl shadow mb-4 sm:mb-6">
            <div class="grid grid-cols-2 sm:flex sm:flex-nowrap gap-1.5 sm:gap-2 p-1.5 sm:p-2">
                <!-- Áâ©ÂìÅÊü•Ë©¢ - TealËâ≤Á≥ª -->
                <button @click="switchTab('items')"
                        :class="currentTab === 'items' ? 'bg-teal-custom-500 text-white font-semibold shadow-md' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'"
                        class="flex-1 py-2.5 sm:py-3 px-2 sm:px-3 md:px-4 rounded-lg transition-all duration-200 flex items-center justify-center gap-1.5 sm:gap-2 min-w-0">
                    <svg class="w-4 h-4 sm:w-5 sm:h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/>
                    </svg>
                    <span class="text-sm sm:text-base font-medium truncate">Â∫´Â≠òÊü•Ë©¢</span>
                </button>

                <!-- ÈÄ≤Ë≤®ÁôªË®ò - ËóçËâ≤Á≥ª -->
                <button @click="switchTab('receive')"
                        :class="currentTab === 'receive' ? 'bg-blue-600 text-white font-semibold shadow-md' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'"
                        class="flex-1 py-2.5 sm:py-3 px-2 sm:px-3 md:px-4 rounded-lg transition-all duration-200 flex items-center justify-center gap-1.5 sm:gap-2 min-w-0">
                    <svg class="w-4 h-4 sm:w-5 sm:h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"/>
                    </svg>
                    <span class="text-sm sm:text-base font-medium truncate">ÈÄ≤Ë≤®</span>
                </button>

                <!-- ËôïÁΩÆ - ËôïÁΩÆËâ≤Á≥ª #4E5488 -->
                <button @click="switchTab('treatment')"
                        :class="currentTab === 'treatment' ? 'bg-treatment-500 text-white font-semibold shadow-md' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'"
                        class="flex-1 py-2.5 sm:py-3 px-2 sm:px-3 md:px-4 rounded-lg transition-all duration-200 flex items-center justify-center gap-1.5 sm:gap-2 min-w-0">
                    <svg class="w-4 h-4 sm:w-5 sm:h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                    <span class="text-sm sm:text-base font-medium truncate">ËôïÁΩÆ</span>
                </button>

                <!-- Ë°ÄË¢ãÁÆ°ÁêÜ - Ë°ÄÂ∫´Ëâ≤Á≥ª #D96754 (claude-red) -->
                <button @click="switchTab('blood')"
                        :class="currentTab === 'blood' ? 'bg-claude-red-500 text-white font-semibold shadow-md' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'"
                        class="flex-1 py-2.5 sm:py-3 px-2 sm:px-3 md:px-4 rounded-lg transition-all duration-200 flex items-center justify-center gap-1.5 sm:gap-2 min-w-0">
                    <svg class="w-4 h-4 sm:w-5 sm:h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"/>
                    </svg>
                    <span class="text-sm sm:text-base font-medium truncate">Ë°ÄË¢ãÁÆ°ÁêÜ</span>
                </button>

                <!-- Ë®≠ÂÇôÁÆ°ÁêÜ - Ë®≠ÂÇôËâ≤Á≥ª #6C7362 -->
                <button @click="switchTab('equipment')"
                        :class="currentTab === 'equipment' ? 'bg-equipment-500 text-white font-semibold shadow-md' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'"
                        class="flex-1 py-2.5 sm:py-3 px-2 sm:px-3 md:px-4 rounded-lg transition-all duration-200 flex items-center justify-center gap-1.5 sm:gap-2 min-w-0">
                    <svg class="w-4 h-4 sm:w-5 sm:h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                    </svg>
                    <span class="text-sm sm:text-base font-medium truncate">Ë®≠ÂÇôÁÆ°ÁêÜ</span>
                </button>

                <!-- ÈüåÊÄß‰º∞ÁÆó - Ê©ôËâ≤Á≥ª #F59E0B -->
                <button @click="switchTab('resilience')"
                        :class="currentTab === 'resilience' ? 'bg-amber-500 text-white font-semibold shadow-md' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'"
                        class="flex-1 py-2.5 sm:py-3 px-2 sm:px-3 md:px-4 rounded-lg transition-all duration-200 flex items-center justify-center gap-1.5 sm:gap-2 min-w-0">
                    <svg class="w-4 h-4 sm:w-5 sm:h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
                    </svg>
                    <span class="text-sm sm:text-base font-medium truncate">ÈüåÊÄß‰º∞ÁÆó</span>
                </button>

            </div>
        </div>

        <!-- Áâ©ÂìÅÊü•Ë©¢ÂàÜÈ†Å -->
        <div x-show="currentTab === 'items'" class="bg-white rounded-xl shadow-lg p-3 sm:p-4 md:p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                    <svg class="w-6 h-6 text-teal-custom-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/>
                    </svg>
                    Â∫´Â≠òÊü•Ë©¢
                </h2>
                <div class="flex gap-2">
                    <button @click="showInventoryCheckHistoryModal = true; loadInventoryCheckHistory()" class="bg-cyan-600 text-white px-4 py-2 rounded-lg hover:bg-cyan-700 transition-colors flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/>
                        </svg>
                        <span>Ê†∏Â∞çË®òÈåÑ</span>
                    </button>
                    <button @click="showAddItemModal = true" class="bg-teal-custom-500 text-white px-4 py-2 rounded-lg hover:bg-teal-custom-600 transition-colors flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                        </svg>
                        <span>Êñ∞Â¢ûÁâ©ÂìÅ</span>
                    </button>
                    <button @click="loadItems()" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                        </svg>
                        <span>ÈáçÊñ∞ËºâÂÖ•</span>
                    </button>
                </div>
            </div>

            <!-- ÂàÜÈ°ûÁØ©ÈÅ∏Ê®ôÁ±§ (v1.4.2-plus: Ëó•ÂìÅ/ËÄóÊùêÂàÜÈ°û) -->
            <div class="flex flex-wrap gap-2 mb-4">
                <button @click="itemCategoryFilter = ''; filterItems()"
                        :class="itemCategoryFilter === '' ? 'bg-teal-custom-500 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'"
                        class="px-4 py-2 rounded-lg text-sm font-medium transition-colors">ÂÖ®ÈÉ®</button>
                <button @click="itemCategoryFilter = 'medicine'; filterItems()"
                        :class="itemCategoryFilter === 'medicine' ? 'bg-pharma-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'"
                        class="px-4 py-2 rounded-lg text-sm font-medium transition-colors flex items-center gap-1">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"/>
                    </svg>
                    Ëó•ÂìÅ
                </button>
                <button @click="itemCategoryFilter = 'consumable'; filterItems()"
                        :class="itemCategoryFilter === 'consumable' ? 'bg-pharma-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'"
                        class="px-4 py-2 rounded-lg text-sm font-medium transition-colors flex items-center gap-1">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/>
                    </svg>
                    ËÄóÊùê
                </button>
                <button @click="itemCategoryFilter = 'reagent'; filterItems()"
                        :class="itemCategoryFilter === 'reagent' ? 'bg-pharma-600 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'"
                        class="px-4 py-2 rounded-lg text-sm font-medium transition-colors flex items-center gap-1">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z"/>
                    </svg>
                    Ë©¶Âäë
                </button>
            </div>

            <!-- ÊêúÂ∞ãÊ°ÜÂíåÂåØÂá∫ÊåâÈàï -->
            <div class="mb-4 flex gap-4 items-end flex-wrap sm:flex-nowrap">
                <div class="flex-1 w-full sm:w-auto">
                    <label class="block text-sm font-medium text-gray-700 mb-2 flex items-center gap-2">
                        <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                        </svg>
                        ÊêúÂ∞ãÁâ©ÂìÅ
                    </label>
                    <input type="text" x-model="itemSearchText" @input="filterItems()" placeholder="Ëº∏ÂÖ•‰ª£Á¢ºÊàñÂêçÁ®±ÊêúÂ∞ã..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-custom-500">
                </div>
                <div class="flex gap-2">
                    <button @click.prevent.stop="exportInventoryCSV()" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                        <span>CSV</span>
                    </button>
                    <button @click.prevent.stop="exportInventoryJSON()" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                        <span>JSON</span>
                    </button>
                </div>
            </div>

            <!-- ÊâãÊ©üÁâà: Âç°ÁâáÂºèÂàóË°® -->
            <div class="block sm:hidden space-y-3">
                <template x-for="item in filteredItems" :key="item.code">
                    <div class="border rounded-lg p-3" :class="item.current_stock < item.min_stock ? 'border-red-300 bg-red-50' : 'border-gray-200'">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <span class="font-mono text-xs text-gray-500" x-text="item.code"></span>
                                <h3 class="font-medium text-gray-900" x-text="item.name"></h3>
                            </div>
                            <span class="px-2 py-1 text-xs font-medium rounded-full bg-teal-variant-100 text-teal-variant-700" x-text="item.category"></span>
                        </div>
                        <div class="flex justify-between items-center">
                            <div class="flex gap-4 text-sm">
                                <span>
                                    <span class="text-gray-500">Â∫´Â≠ò:</span>
                                    <span :class="item.current_stock < item.min_stock ? 'text-red-600 font-bold' : 'text-green-600 font-semibold'" x-text="item.current_stock"></span>
                                    <span class="text-gray-400" x-text="item.unit"></span>
                                </span>
                                <span class="text-gray-400">ÂÆâÂÖ®Èáè: <span x-text="item.min_stock"></span></span>
                            </div>
                            <div class="flex gap-2">
                                <button @click="editItem(item)" class="text-teal-custom-500 hover:text-teal-custom-600 text-sm">Á∑®ËºØ</button>
                                <button @click="deleteItem(item.code, item.name)" class="text-red-600 hover:text-red-800 text-sm">Âà™Èô§</button>
                            </div>
                        </div>
                    </div>
                </template>
            </div>

            <!-- Ê°åÈù¢Áâà: Ë°®Ê†º -->
            <div class="hidden sm:block overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200 table-hover">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‰ª£Á¢º</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ÂêçÁ®±</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ÂàÜÈ°û</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Â∫´Â≠ò</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ÂÆâÂÖ®Èáè</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ÂñÆ‰Ωç</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Êìç‰Ωú</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        <template x-for="item in filteredItems" :key="item.code">
                            <tr :class="item.current_stock < item.min_stock ? 'bg-red-50' : ''">
                                <td class="px-4 py-3 whitespace-nowrap text-sm font-mono text-gray-900" x-text="item.code"></td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900" x-text="item.name"></td>
                                <td class="px-4 py-3 whitespace-nowrap">
                                    <span class="px-2 py-1 text-xs font-medium rounded-full bg-teal-variant-100 text-teal-variant-700" x-text="item.category"></span>
                                </td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm">
                                    <span :class="item.current_stock < item.min_stock ? 'text-red-600 font-bold' : 'text-green-600 font-semibold'"
                                          x-text="item.current_stock"></span>
                                </td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500" x-text="item.min_stock"></td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500" x-text="item.unit"></td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm space-x-2">
                                    <button @click="editItem(item)" class="text-teal-custom-500 hover:text-teal-custom-600">Á∑®ËºØ</button>
                                    <button @click="deleteItem(item.code, item.name)" class="text-red-600 hover:text-red-800">Âà™Èô§</button>
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- ÈÄ≤Ë≤®ÂàÜÈ†Å -->
        <div x-show="currentTab === 'receive'" class="bg-white rounded-xl shadow-lg p-3 sm:p-4 md:p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                    <svg class="w-6 h-6 text-sky-custom-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"/>
                    </svg>
                    ÈÄ≤Ë≤®ÁôªË®ò
                </h2>
                <button @click.prevent.stop="showReceiveHistoryModal = true; loadReceiveHistory()" class="bg-sky-custom-600 text-white px-4 py-2 rounded-lg hover:bg-sky-custom-500 transition-colors flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                    <span>Êü•ÁúãÈÄ≤Ë≤®Ë®òÈåÑ</span>
                </button>
            </div>

            <form @submit.prevent="submitReceive()" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="relative">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Áâ©ÂìÅ‰ª£Á¢º * (ÂèØÊêúÂ∞ã)</label>
                        <input
                            type="text"
                            x-model="receiveItemSearch"
                            @input="filterReceiveItems()"
                            @focus="showReceiveDropdown = true; if (filteredReceiveItems.length === 0) filterReceiveItems();"
                            @blur="setTimeout(() => showReceiveDropdown = false, 200)"
                            placeholder="Ëº∏ÂÖ•‰ª£Á¢ºÊàñÂêçÁ®±ÊêúÂ∞ã..."
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-sky-custom-600 focus:border-transparent"
                        >
                        <div x-show="showReceiveDropdown && filteredReceiveItems.length > 0" class="absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-y-auto">
                            <template x-for="item in filteredReceiveItems.slice(0, 10)" :key="item.code">
                                <div @click.stop="selectReceiveItem(item)" class="px-4 py-2 hover:bg-sky-100 cursor-pointer">
                                    <span class="font-mono text-sm" x-text="item.code"></span> -
                                    <span x-text="item.name"></span>
                                    <span class="text-xs text-gray-500" x-text="`(Â∫´Â≠ò: ${item.current_stock})`"></span>
                                </div>
                            </template>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Êï∏Èáè *</label>
                        <input type="number" x-model="receiveForm.quantity" required min="1" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-sky-custom-600 focus:border-transparent">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ÊâπËôü</label>
                        <input type="text" x-model="receiveForm.batchNumber" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-sky-custom-600 focus:border-transparent">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ÊïàÊúü</label>
                        <input type="date" x-model="receiveForm.expiryDate" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-sky-custom-600 focus:border-transparent">
                    </div>

                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">ÂÇôË®ª</label>
                        <textarea x-model="receiveForm.remarks" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-sky-custom-600 focus:border-transparent"></textarea>
                    </div>
                </div>

                <div class="flex gap-4">
                    <button type="submit" class="bg-sky-custom-600 text-white px-6 py-2 rounded-lg hover:bg-sky-custom-500 transition-colors flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                        </svg>
                        <span>Á¢∫Ë™çÈÄ≤Ë≤®</span>
                    </button>
                    <button type="button" @click="resetReceiveForm()" class="bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-600 transition-colors flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                        </svg>
                        <span>ÈáçÁΩÆ</span>
                    </button>
                </div>
            </form>
        </div>

        <!-- ËôïÁΩÆÂàÜÈ†Å (Êï¥ÂêàÊâãË°ìË®òÈåÑ + ‰∏ÄËà¨Ê∂àËÄó) -->
        <div x-show="currentTab === 'treatment'" class="bg-white rounded-xl shadow-lg p-3 sm:p-4 md:p-6">
            <!-- Ê®ôÈ°åËàáÊ®°ÂºèÂàáÊèõ -->
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-4">
                <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                    <svg class="w-6 h-6 text-treatment-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                    ËôïÁΩÆÁÆ°ÁêÜ
                </h2>

                <!-- Â∑¶ÂÅ¥ÂàáÊèõÊåâÈàï -->
                <div class="flex gap-2 flex-wrap">
                    <button @click="treatmentMode = 'surgery'"
                            :class="treatmentMode === 'surgery' ? 'bg-treatment-500 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'"
                            class="px-4 py-2 rounded-lg transition-colors flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                        </svg>
                        <span>ËôïÁΩÆËÄóÊùêË®òÈåÑ</span>
                    </button>
                    <button @click="treatmentMode = 'consume'"
                            :class="treatmentMode === 'consume' ? 'bg-treatment-500 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'"
                            class="px-4 py-2 rounded-lg transition-colors flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                        </svg>
                        <span>‰∏ÄËà¨Ê∂àËÄó</span>
                    </button>
                    <button @click="treatmentMode = 'dispense'; loadPendingDispenses()"
                            :class="treatmentMode === 'dispense' ? 'bg-dispense-purple-700 text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'"
                            class="px-4 py-2 rounded-lg transition-colors flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/>
                        </svg>
                        <span>Ëó•ÂìÅÈ†òÁî®</span>
                    </button>
                </div>
            </div>

            <!-- ËôïÁΩÆËÄóÊùêË®òÈåÑÊ®°Âºè (ÊâãË°ìË®òÈåÑ) -->
            <div x-show="treatmentMode === 'surgery'" x-init="loadCirsProcedureWaiting()">

                <!-- v1.1: CIRS ÂæÖËôïÁΩÆÊ∏ÖÂñÆ -->
                <div class="mb-6 bg-gray-50 rounded-lg p-4 border border-gray-200">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="font-semibold text-gray-700 flex items-center gap-2">
                            <svg class="w-5 h-5 text-treatment-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                            </svg>
                            CIRS ÂæÖËôïÁΩÆÊ∏ÖÂñÆ
                        </h3>
                        <div class="flex items-center gap-2">
                            <span x-show="cirsProcedureStatus.online" class="text-sm text-green-600 flex items-center gap-1">
                                <span class="w-2 h-2 bg-green-500 rounded-full"></span>
                                ÈÄ£Á∑ö (<span x-text="cirsProcedurePatients.length"></span> ‰Ωç)
                            </span>
                            <span x-show="!cirsProcedureStatus.online" class="text-sm text-gray-500 flex items-center gap-1">
                                <span class="w-2 h-2 bg-gray-400 rounded-full"></span>
                                Èõ¢Á∑ö
                            </span>
                            <!-- v1.2: È°ØÁ§∫ÊúÄÂæåÂêåÊ≠•ÊôÇÈñì -->
                            <span x-show="cirsProcedureStatus.lastSynced" class="text-xs text-gray-400"
                                  x-text="'ÂêåÊ≠•: ' + (cirsProcedureStatus.lastSynced ? new Date(cirsProcedureStatus.lastSynced).toLocaleTimeString('zh-TW', {hour: '2-digit', minute: '2-digit'}) : '')"></span>
                            <button @click="loadCirsProcedureWaiting()" class="text-gray-500 hover:text-treatment-500 p-1">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                                </svg>
                            </button>
                        </div>
                    </div>

                    <!-- ÂæÖËôïÁΩÆÁóÖÊÇ£ÂàóË°® -->
                    <div x-show="cirsProcedurePatients.length > 0" class="space-y-2 max-h-48 overflow-y-auto">
                        <template x-for="patient in cirsProcedurePatients" :key="patient.registration_id">
                            <div @click="selectProcedurePatient(patient)"
                                 class="p-3 bg-white rounded-lg border border-gray-200 hover:border-treatment-500 hover:bg-treatment-50 cursor-pointer transition-all">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <span class="font-medium" x-text="patient.name || patient.patient_ref || 'Êú™Áü•'"></span>
                                        <span class="text-sm text-gray-500 ml-2" x-text="patient.patient_id || ''"></span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <span x-show="patient.waiting_minutes" class="text-xs text-gray-400" x-text="'Á≠âÂæÖ ' + patient.waiting_minutes + ' ÂàÜ'"></span>
                                        <span class="text-xs px-2 py-0.5 rounded"
                                              :class="{
                                                  'bg-red-100 text-red-700': patient.priority === 'STAT',
                                                  'bg-orange-100 text-orange-700': patient.priority === 'URGENT',
                                                  'bg-green-100 text-green-700': patient.priority === 'ROUTINE' || !patient.priority
                                              }"
                                              x-text="patient.priority === 'STAT' ? 'ÊÄ•' : patient.priority === 'URGENT' ? 'Á∑ä' : 'Â∏∏'"></span>
                                    </div>
                                </div>
                                <div class="text-sm text-gray-600 mt-1">
                                    <span x-show="patient.chief_complaint" x-text="patient.chief_complaint"></span>
                                    <span x-show="patient.procedure_notes" class="text-treatment-600 ml-2" x-text="'[' + patient.procedure_notes + ']'"></span>
                                </div>
                                <div x-show="patient.consultation_by" class="text-xs text-gray-400 mt-1" x-text="'ÈÜ´Â∏´: ' + patient.consultation_by"></div>
                            </div>
                        </template>
                    </div>

                    <div x-show="cirsProcedurePatients.length === 0 && cirsProcedureStatus.online" class="text-center text-gray-500 py-4">
                        ÁõÆÂâçÁÑ°ÂæÖËôïÁΩÆÁóÖÊÇ£
                        <div class="text-xs text-gray-400 mt-1">ÈÜ´Â∏´ÂÆåÊàêÁúãË®∫‰∏¶ÂãæÈÅ∏„ÄåÈúÄËôïÁΩÆ„ÄçÂæåÔºåÁóÖÊÇ£ÊúÉÂá∫ÁèæÂú®Ê≠§</div>
                    </div>

                    <div x-show="!cirsProcedureStatus.online" class="text-center text-gray-500 py-4">
                        CIRS Êú™ÈÄ£Á∑ö
                        <div class="text-xs text-gray-400 mt-1">Ë´ã‰ΩøÁî®‰∏ãÊñπ„ÄåÊñ∞Â¢ûËôïÁΩÆËÄóÊùêË®òÈåÑ„ÄçÊâãÂãïËº∏ÂÖ•</div>
                    </div>
                </div>

                <!-- ÂàÜÈöîÁ∑ö -->
                <div class="relative mb-4">
                    <div class="absolute inset-0 flex items-center"><div class="w-full border-t border-gray-200"></div></div>
                    <div class="relative flex justify-center text-sm"><span class="px-2 bg-white text-gray-500">Êàñ</span></div>
                </div>

                <div class="flex flex-wrap gap-2 mb-4">
                    <button @click.prevent.stop="ensureItemsLoaded(); showAddSurgeryModal = true" class="bg-treatment-500 text-white px-4 py-2 rounded-lg hover:bg-[#3d4270] transition-colors flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                        </svg>
                        <span>ÊâãÂãïÊñ∞Â¢ûËôïÁΩÆËÄóÊùêË®òÈåÑ</span>
                    </button>
                    <button @click.prevent.stop="exportSurgeryCSV()" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                        <span>ÂåØÂá∫ CSV</span>
                    </button>
                    <button @click.prevent.stop="loadSurgeryRecords()" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                        </svg>
                        <span>ÈáçÊñ∞ËºâÂÖ•</span>
                    </button>
                </div>

                <!-- ÊêúÂ∞ãÁØ©ÈÅ∏ -->
                <div class="mb-4 grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ÈñãÂßãÊó•Êúü</label>
                        <input type="date" x-model="surgerySearchForm.startDate" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-treatment-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ÁµêÊùüÊó•Êúü</label>
                        <input type="date" x-model="surgerySearchForm.endDate" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-treatment-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ÁóÖÊÇ£ÂßìÂêç</label>
                        <input type="text" x-model="surgerySearchForm.patientName" placeholder="ÊêúÂ∞ãÁóÖÊÇ£..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-treatment-500">
                    </div>
                </div>

                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200 table-hover">
                        <thead class="bg-treatment-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ë®òÈåÑÁ∑®Ëôü</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Êó•Êúü</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ÁóÖÊÇ£ÂßìÂêç</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ËôïÁΩÆÈ°ûÂûã</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‰∏ªÂàÄÈÜ´Â∏´</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ÊôÇÈï∑(ÂàÜ)</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Êìç‰Ωú</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            <template x-for="record in surgeryRecords" :key="record.id">
                                <tr>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-mono text-gray-900" x-text="record.record_number"></td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" x-text="record.record_date"></td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" x-text="record.patient_name"></td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" x-text="record.surgery_type"></td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" x-text="record.surgeon_name"></td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" x-text="record.duration_minutes || '-'"></td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                                        <button @click="viewSurgeryDetail(record)" class="text-treatment-500 hover:text-[#3d4270] font-medium">Ë©≥ÊÉÖ</button>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>

                <!-- Ë°ìÂºè‰∏ªÊ™îÂø´Êü• (treatment Ëâ≤Á≥ª) -->
                <div class="mt-6 border-2 border-treatment-300 rounded-lg p-4 bg-treatment-50" x-init="$nextTick(() => { if(!dataLoaded.surgeryMaster) { loadSurgeryCategories(); loadSelfPayCategories(); } })">
                    <h4 class="text-lg font-semibold text-treatment-700 flex items-center gap-2 mb-4">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"/>
                        </svg>
                        Ë°ìÂºè‰∏ªÊ™îÂø´Êü•
                    </h4>

                    <!-- Â≠ê Tab ÂàáÊèõ -->
                    <div class="flex gap-2 mb-4">
                        <button @click="surgeryMasterSubTab = 'codes'; if(surgeryCodes.length === 0) searchSurgeryCodes()"
                                :class="surgeryMasterSubTab === 'codes' ? 'bg-treatment-500 text-white' : 'bg-white text-treatment-700 border border-treatment-300'"
                                class="px-3 py-1.5 rounded text-sm font-medium transition-colors">
                            Ë°ìÂºè‰ª£Á¢º
                        </button>
                        <button @click="surgeryMasterSubTab = 'selfpay'; if(selfPayItems.length === 0) searchSelfPayItems()"
                                :class="surgeryMasterSubTab === 'selfpay' ? 'bg-treatment-500 text-white' : 'bg-white text-treatment-700 border border-treatment-300'"
                                class="px-3 py-1.5 rounded text-sm font-medium transition-colors">
                            Ëá™Ë≤ªÈ†ÖÁõÆ
                        </button>
                        <button @click="surgeryMasterSubTab = 'calculator'"
                                :class="surgeryMasterSubTab === 'calculator' ? 'bg-treatment-500 text-white' : 'bg-white text-treatment-700 border border-treatment-300'"
                                class="px-3 py-1.5 rounded text-sm font-medium transition-colors">
                            ÈªûÊï∏Ë®àÁÆó
                        </button>
                    </div>

                    <!-- Ë°ìÂºè‰ª£Á¢º -->
                    <div x-show="surgeryMasterSubTab === 'codes'">
                        <div class="flex gap-2 mb-3">
                            <select x-model="surgeryCodeCategoryFilter" @change="searchSurgeryCodes()"
                                    class="px-2 py-1 border border-treatment-300 rounded text-sm focus:ring-treatment-500">
                                <option value="">ÂÖ®ÈÉ®ÂàÜÈ°û</option>
                                <template x-for="cat in surgeryCategories" :key="cat.category_code">
                                    <option :value="cat.category_code" x-text="cat.category_name"></option>
                                </template>
                            </select>
                            <input type="text" x-model="surgeryCodeSearchText" @input.debounce.300ms="searchSurgeryCodes()"
                                   placeholder="ÊêúÂ∞ã..." class="flex-1 px-3 py-1 border border-treatment-300 rounded text-sm focus:ring-treatment-500">
                        </div>
                        <div class="max-h-64 overflow-y-auto space-y-2">
                            <template x-for="code in surgeryCodes.slice(0, 20)" :key="code.code">
                                <div class="flex justify-between items-center px-3 py-2 bg-white rounded border border-treatment-200">
                                    <div>
                                        <span class="font-mono text-xs text-gray-500" x-text="code.code"></span>
                                        <span class="ml-2 text-sm" x-text="code.name_zh"></span>
                                    </div>
                                    <span class="text-sm font-medium text-treatment-600" x-text="code.points?.toLocaleString() + ' Èªû'"></span>
                                </div>
                            </template>
                        </div>
                        <p class="text-xs text-treatment-500 mt-2" x-text="'ÂÖ± ' + surgeryCodes.length + ' Á≠Ü' + (surgeryCodes.length > 20 ? 'ÔºåÈ°ØÁ§∫Ââç 20 Á≠Ü' : '')"></p>
                    </div>

                    <!-- Ëá™Ë≤ªÈ†ÖÁõÆ (v2.7.3: Âä†ÂÖ• Queue ÂäüËÉΩ) -->
                    <div x-show="surgeryMasterSubTab === 'selfpay'">
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                            <!-- Â∑¶ÂÅ¥ÔºöËá™Ë≤ªÈ†ÖÁõÆÂàóË°® -->
                            <div>
                                <div class="flex gap-2 mb-3">
                                    <select x-model="selfPayCategoryFilter" @change="searchSelfPayItems()"
                                            class="px-2 py-1 border border-treatment-300 rounded text-sm focus:ring-treatment-500">
                                        <option value="">ÂÖ®ÈÉ®ÂàÜÈ°û</option>
                                        <template x-for="cat in selfPayCategories" :key="cat.category">
                                            <option :value="cat.category" x-text="cat.category"></option>
                                        </template>
                                    </select>
                                    <input type="text" x-model="selfPaySearchText" @input.debounce.300ms="searchSelfPayItems()"
                                           placeholder="ÊêúÂ∞ã..." class="flex-1 px-3 py-1 border border-treatment-300 rounded text-sm focus:ring-treatment-500">
                                </div>
                                <div class="max-h-48 overflow-y-auto space-y-1">
                                    <template x-for="item in selfPayItems.slice(0, 15)" :key="item.item_id">
                                        <button @click="addToSelfPayQueue(item)"
                                                class="w-full text-left flex justify-between items-center px-3 py-2 bg-white rounded border border-treatment-200 hover:bg-treatment-100 hover:border-treatment-400 transition-colors">
                                            <div class="truncate flex-1 mr-2">
                                                <span class="text-sm" x-text="item.name"></span>
                                            </div>
                                            <span class="text-sm font-medium text-green-600 whitespace-nowrap" x-text="'$' + item.unit_price?.toLocaleString()"></span>
                                        </button>
                                    </template>
                                </div>
                                <p class="text-xs text-treatment-500 mt-1" x-text="'ÂÖ± ' + selfPayItems.length + ' Á≠Ü' + (selfPayItems.length > 15 ? 'ÔºåÈ°ØÁ§∫Ââç 15 Á≠Ü' : '') + ' (ÈªûÊìäÂä†ÂÖ•)'"></p>
                            </div>

                            <!-- Âè≥ÂÅ¥ÔºöËá™Ë≤ª Queue -->
                            <div class="bg-treatment-50 rounded-lg p-3">
                                <div class="flex justify-between items-center mb-2">
                                    <h5 class="font-medium text-treatment-700">Ë≤ªÁî®Ê∏ÖÂñÆ</h5>
                                    <button x-show="selfPayQueue.length > 0" @click="clearSelfPayQueue()"
                                            class="text-xs text-red-500 hover:text-red-700">Ê∏ÖÁ©∫</button>
                                </div>
                                <div class="max-h-40 overflow-y-auto space-y-1 mb-2">
                                    <template x-for="(item, idx) in selfPayQueue" :key="item.item_id">
                                        <div class="flex justify-between items-center px-2 py-1 bg-white rounded border border-treatment-200">
                                            <span class="text-sm truncate flex-1 mr-2" x-text="item.name"></span>
                                            <div class="flex items-center gap-1">
                                                <button @click="updateSelfPayQueueQty(idx, -1)" class="w-5 h-5 text-xs bg-gray-200 rounded hover:bg-gray-300">‚àí</button>
                                                <span class="text-sm w-6 text-center" x-text="item.quantity"></span>
                                                <button @click="updateSelfPayQueueQty(idx, 1)" class="w-5 h-5 text-xs bg-gray-200 rounded hover:bg-gray-300">+</button>
                                                <span class="text-sm font-medium text-green-600 w-16 text-right" x-text="'$' + (item.unit_price * item.quantity).toLocaleString()"></span>
                                                <button @click="removeFromSelfPayQueue(idx)" class="text-red-500 text-xs ml-1">‚úï</button>
                                            </div>
                                        </div>
                                    </template>
                                </div>
                                <div x-show="selfPayQueue.length === 0" class="text-center text-gray-400 py-4 text-sm">
                                    ÈªûÊìäÂ∑¶ÂÅ¥ÂìÅÈ†ÖÂä†ÂÖ•Ê∏ÖÂñÆ
                                </div>
                                <div x-show="selfPayQueue.length > 0" class="border-t border-treatment-200 pt-2">
                                    <div class="flex justify-between items-center text-treatment-700 font-bold">
                                        <span>Á∏ΩË®àÔºö</span>
                                        <span class="text-lg" x-text="'$' + getSelfPayQueueTotal().toLocaleString()"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ÈªûÊï∏Ë®àÁÆóÂô® -->
                    <div x-show="surgeryMasterSubTab === 'calculator'">
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                            <div>
                                <input type="text" x-model="calculatorSearchText" @input.debounce.300ms="searchForCalculator()"
                                       placeholder="ÊêúÂ∞ãË°ìÂºè..." class="w-full px-3 py-2 border border-treatment-300 rounded text-sm mb-2">
                                <div class="max-h-40 overflow-y-auto space-y-1">
                                    <template x-for="code in calculatorSearchResults.slice(0, 10)" :key="code.code">
                                        <button @click="addToCalculator(code)"
                                                class="w-full text-left px-2 py-1 text-sm bg-white rounded border border-treatment-200 hover:bg-treatment-100">
                                            <span class="font-mono text-xs" x-text="code.code"></span>
                                            <span x-text="code.name_zh"></span>
                                            <span class="float-right text-treatment-600" x-text="code.points + 'Èªû'"></span>
                                        </button>
                                    </template>
                                </div>
                            </div>
                            <div>
                                <div class="space-y-1 mb-2">
                                    <template x-for="(item, idx) in calculatorSurgeries" :key="item.code">
                                        <div class="flex justify-between items-center px-2 py-1 rounded text-sm"
                                             :class="item.reduction_rate === 1 ? 'bg-green-100' : (item.reduction_rate === 0.5 ? 'bg-yellow-100' : 'bg-red-100')">
                                            <div class="flex-1">
                                                <span x-text="item.name_zh"></span>
                                                <span class="text-xs text-gray-500 ml-1" x-text="'(' + Math.round(item.reduction_rate * 100) + '%)'"></span>
                                            </div>
                                            <div class="flex items-center gap-2">
                                                <span x-text="(item.final_points || 0).toLocaleString() + 'Èªû'"></span>
                                                <button @click="removeFromCalculator(idx)" class="text-red-500 text-xs">‚úï</button>
                                            </div>
                                        </div>
                                    </template>
                                </div>
                                <div x-show="calculatorSurgeries.length > 0" class="text-right font-bold text-treatment-700">
                                    Á∏ΩË®à: <span x-text="getCalculatorTotal().toLocaleString()"></span> Èªû
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ‰∏ÄËà¨Ê∂àËÄóÊ®°Âºè -->
            <div x-show="treatmentMode === 'consume'">
                <div class="mb-4 flex justify-between items-center">
                    <button @click.prevent.stop="showConsumeHistoryModal = true; loadConsumeHistory()" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                        <span>Êü•ÁúãÊ∂àËÄóË®òÈåÑ</span>
                    </button>
                </div>

                <form @submit.prevent="submitBatchConsume()" class="space-y-4">
                    <!-- Ê∂àËÄóÂéüÂõ†ÔºàÊï¥ÊâπÂÖ±Áî®Ôºâ -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Ê∂àËÄóÂéüÂõ† *</label>
                        <textarea x-model="batchConsumeForm.purpose" required rows="2"
                                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-treatment-500 focus:border-transparent"></textarea>
                    </div>

                    <!-- ËÄóÊùêÊ∏ÖÂñÆ -->
                    <div class="border-2 border-gray-200 rounded-lg p-4">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="text-lg font-semibold text-gray-700 flex items-center gap-2">
                                <svg class="w-5 h-5 text-treatment-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"/>
                                </svg>
                                Ê∂àËÄóÂìÅÈ†Ö
                            </h4>
                            <button type="button" @click="ensureItemsLoaded(); addBatchConsumeItem()"
                                    class="bg-treatment-500 text-white px-3 py-1 rounded-lg hover:bg-[#3d4270] text-sm flex items-center gap-1">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                                </svg>
                                Êñ∞Â¢ûÂìÅÈ†Ö
                            </button>
                        </div>

                        <div class="space-y-3">
                            <template x-for="(item, index) in batchConsumeForm.items" :key="index">
                                <div class="flex gap-2 items-start border border-gray-200 rounded-lg p-3">
                                    <div class="flex-1 grid grid-cols-3 gap-2">
                                        <!-- ÊêúÂ∞ãËº∏ÂÖ•Ê°ÜÔºà‰ΩøÁî® relative divÔºâ -->
                                        <div class="relative col-span-2">
                                            <input
                                                type="text"
                                                x-model="item.searchText"
                                                @input="filterBatchConsumeItems(index)"
                                                @focus="filterBatchConsumeItems(index); item.showDropdown = true"
                                                @blur="setTimeout(() => item.showDropdown = false, 200)"
                                                placeholder="ÊêúÂ∞ãÁâ©ÂìÅ..."
                                                required
                                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-treatment-500"
                                            >
                                            <div x-show="item.showDropdown && Array.isArray(item.filteredItems) && item.filteredItems.length > 0"
                                                 class="absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-48 overflow-y-auto">
                                                <template x-for="(availableItem, itemIdx) in (item.filteredItems || []).slice(0, 8)" :key="`${index}-${itemIdx}-${availableItem.code || ''}`">
                                                    <div @click.stop="selectBatchConsumeItem(index, availableItem)"
                                                         class="px-3 py-2 hover:bg-treatment-50 cursor-pointer text-sm">
                                                        <span class="font-mono" x-text="availableItem.code"></span> -
                                                        <span x-text="availableItem.name"></span>
                                                        <span class="text-xs text-gray-500" x-text="`(Â∫´Â≠ò: ${availableItem.current_stock || 0})`"></span>
                                                    </div>
                                                </template>
                                            </div>
                                        </div>

                                        <!-- Êï∏ÈáèËº∏ÂÖ•Ê°Ü -->
                                        <input type="number" x-model="item.quantity" required min="1" placeholder="Êï∏Èáè"
                                               class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-treatment-500">
                                    </div>

                                    <!-- Âà™Èô§ÊåâÈàï -->
                                    <button type="button" @click="removeBatchConsumeItem(index)" class="text-red-600 hover:text-red-800 p-2">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                        </svg>
                                    </button>
                                </div>
                            </template>
                        </div>

                        <div x-show="batchConsumeForm.items.length === 0" class="text-center text-gray-400 py-4">
                            Â∞öÊú™Êñ∞Â¢ûÊ∂àËÄóÂìÅÈ†Ö
                        </div>
                    </div>

                    <!-- Êèê‰∫§ÊåâÈàï -->
                    <div class="flex gap-4">
                        <button type="submit" class="bg-treatment-500 text-white px-6 py-2 rounded-lg hover:bg-[#3d4270] transition-colors flex items-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                            </svg>
                            <span>Á¢∫Ë™çÊ∂àËÄó</span>
                        </button>
                        <button type="button" @click="resetBatchConsumeForm()" class="bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-600 transition-colors flex items-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                            </svg>
                            <span>ÈáçÁΩÆ</span>
                        </button>
                    </div>
                </form>
            </div>

            <!-- Ëó•ÂìÅÈ†òÁî®Ê®°Âºè (MIRS v2.3 - Emergency Dispense) -->
            <div x-show="treatmentMode === 'dispense'">
                <div class="flex justify-between mb-4">
                    <!-- Êí•ÁôºÁµ¶Ëó•Â±ÄÊåâÈàï (MIRS v2.4) -->
                    <button @click.prevent.stop="openDispatchModal()" class="bg-treatment-500 text-white px-4 py-2 rounded-lg hover:bg-[#3d4270] transition-colors flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"/>
                        </svg>
                        <span>Êí•ÁôºÁµ¶Ëó•Â±Ä</span>
                    </button>
                    <button @click.prevent.stop="loadPendingDispenses()" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                        </svg>
                        <span>ÈáçÊñ∞ËºâÂÖ•</span>
                    </button>
                </div>

                <!-- Á∑äÊÄ•È†òÁî®Ë≠¶Á§∫ (Â¶ÇÊûúÊúâÂæÖÁ¢∫Ë™çÁöÑÁ∑äÊÄ•È†òÁî®) -->
                <div x-show="pendingDispenses.filter(d => d.status === 'EMERGENCY').length > 0" class="mb-4 p-4 bg-dispense-purple-50 border-l-4 border-dispense-purple-700 rounded">
                <div class="flex items-start gap-3">
                    <svg class="w-6 h-6 text-dispense-purple-700 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                    </svg>
                    <div class="flex-1">
                        <p class="font-semibold text-dispense-purple-900">Á∑äÊÄ•È†òÁî®ÂæÖÁ¢∫Ë™ç</p>
                        <p class="text-sm text-gray-600 mt-1">
                            Êúâ <span class="font-bold text-dispense-purple-700" x-text="pendingDispenses.filter(d => d.status === 'EMERGENCY').length"></span> Á≠ÜÁ∑äÊÄ•È†òÁî®ÈúÄË¶ÅËó•Â∏´Á¢∫Ë™ç
                        </p>
                    </div>
                </div>
                </div>

                <!-- Ëó•ÂìÅÈ†òÁî®Ë°®ÂñÆ (ÊâπÊ¨°) -->
                <div class="bg-gray-50 rounded-lg p-4 mb-6">
                    <h3 class="text-lg font-semibold text-gray-700 mb-4 flex items-center gap-2">
                        <svg class="w-5 h-5 text-dispense-purple-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                    </svg>
                    È†òÁî®ÁôªË®ò
                </h3>
                <form @submit.prevent="submitBatchDispense()" class="space-y-4">
                    <!-- Âü∫Êú¨Ë≥áË®äÔºàÊï¥ÊâπÂÖ±Áî®Ôºâ -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- È†òËó•‰∫∫ -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                <span class="text-red-500">*</span> È†òËó•‰∫∫
                            </label>
                            <input type="text" x-model="batchDispenseForm.dispensedBy" required placeholder="Ë≠∑ÁêÜÂ∏´-ÁéãÂ∞èÁæé" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-dispense-purple-700">
                        </div>

                        <!-- ÁóÖÊÇ£Á∑®Ëôü (ÈÅ∏Â°´) -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                ÁóÖÊÇ£Á∑®Ëôü (ÈÅ∏Â°´)
                            </label>
                            <input type="text" x-model="batchDispenseForm.patientRefId" placeholder="Triage Tag ID" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-dispense-purple-700">
                        </div>

                        <!-- ÁóÖÊÇ£ÂßìÂêç (ÈÅ∏Â°´) -->
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                ÁóÖÊÇ£ÂßìÂêç (ÈÅ∏Â°´)
                            </label>
                            <input type="text" x-model="batchDispenseForm.patientName" placeholder="Âºµ‰∏â" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-dispense-purple-700">
                        </div>
                    </div>

                    <!-- Ëó•ÂìÅÊ∏ÖÂñÆ -->
                    <div class="border-2 border-dispense-purple-200 rounded-lg p-4">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="text-lg font-semibold text-gray-700 flex items-center gap-2">
                                <svg class="w-5 h-5 text-dispense-purple-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"/>
                                </svg>
                                Ëó•ÂìÅÊ∏ÖÂñÆ
                            </h4>
                            <button type="button" @click="addBatchDispenseItem()"
                                    class="bg-dispense-purple-700 text-white px-3 py-1 rounded-lg hover:bg-dispense-purple-900 text-sm flex items-center gap-1">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                                </svg>
                                Êñ∞Â¢ûËó•ÂìÅ
                            </button>
                        </div>

                        <div class="space-y-3">
                            <template x-for="(item, index) in batchDispenseForm.items" :key="index">
                                <div class="flex gap-2 items-start border border-gray-200 rounded-lg p-3 bg-white">
                                    <div class="flex-1 grid grid-cols-3 gap-2">
                                        <!-- ÊêúÂ∞ãËº∏ÂÖ•Ê°Ü -->
                                        <div class="relative col-span-2">
                                            <input
                                                type="text"
                                                x-model="item.searchText"
                                                @input="filterBatchDispenseItems(index)"
                                                @focus="item.showDropdown = true"
                                                @blur="setTimeout(() => item.showDropdown = false, 200)"
                                                placeholder="ÊêúÂ∞ãËó•ÂìÅ..."
                                                required
                                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-dispense-purple-700"
                                            >
                                            <div x-show="item.showDropdown && item.filteredItems && item.filteredItems.length > 0"
                                                 class="absolute z-10 w-full mt-1 bg-white border border-dispense-purple-300 rounded-lg shadow-lg max-h-48 overflow-y-auto">
                                                <template x-for="availableItem in item.filteredItems.slice(0, 8)" :key="availableItem.code">
                                                    <div @click.stop="selectBatchDispenseItem(index, availableItem)"
                                                         class="px-3 py-2 hover:bg-dispense-purple-50 cursor-pointer text-sm">
                                                        <span class="font-mono" x-text="availableItem.code"></span> -
                                                        <span x-text="availableItem.name"></span>
                                                        <span class="text-xs text-gray-500" x-text="`(Â∫´Â≠ò: ${availableItem.current_stock})`"></span>
                                                    </div>
                                                </template>
                                            </div>
                                        </div>

                                        <!-- Êï∏ÈáèËº∏ÂÖ•Ê°Ü -->
                                        <input type="number" x-model="item.quantity" required min="1" placeholder="Êï∏Èáè"
                                               class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-dispense-purple-700">
                                    </div>

                                    <!-- Âà™Èô§ÊåâÈàï -->
                                    <button type="button" @click="removeBatchDispenseItem(index)" class="text-red-600 hover:text-red-800 p-2">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                        </svg>
                                    </button>
                                </div>
                            </template>
                        </div>

                        <div x-show="batchDispenseForm.items.length === 0" class="text-center text-gray-400 py-4">
                            Â∞öÊú™Êñ∞Â¢ûËó•ÂìÅ
                        </div>
                    </div>

                    <!-- ÊåâÈàïÁµÑ -->
                    <div class="flex flex-col sm:flex-row gap-3 pt-2">
                        <!-- Ê≠£Â∏∏È†òÁî® (ÁÅ∞Ëâ≤) -->
                        <button type="button" @click="batchDispenseForm.isEmergency = false; submitBatchDispense()"
                                class="flex-1 bg-gray-600 text-white px-6 py-3 rounded-lg hover:bg-gray-700 transition-colors flex items-center justify-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            <span>ÈÄÅÂá∫ÂØ©Ê†∏ (Ê≠£Â∏∏ÊµÅÁ®ã)</span>
                        </button>

                        <!-- Á∑äÊÄ•È†òÁî® (Á¥´Ëâ≤) -->
                        <button type="button" @click="showEmergencyReasonModal = true"
                                class="flex-1 bg-dispense-purple-700 text-white px-6 py-3 rounded-lg hover:bg-dispense-purple-900 transition-colors flex items-center justify-center gap-2 font-semibold shadow-md">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                            </svg>
                            <span>Á∑äÊÄ•È†òÁî® (Break-the-Glass)</span>
                        </button>
                    </div>
                </form>
            </div>

            <!-- ÂæÖËôïÁêÜÈ†òÁî®Ê∏ÖÂñÆ (Ëó•Â∏´ÂØ©Ê†∏ÂçÄ) -->
            <div class="bg-gray-50 rounded-lg p-4">
                <h3 class="text-lg font-semibold text-gray-700 mb-4 flex items-center gap-2">
                    <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                    </svg>
                    ÂæÖËôïÁêÜÈ†òÁî® (Ëó•Â∏´ÂØ©Ê†∏)
                </h3>

                <div x-show="pendingDispenses.length === 0" class="text-center py-8 text-gray-400">
                    <svg class="w-12 h-12 mx-auto mb-2 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    <p>ÁõÆÂâçÊ≤íÊúâÂæÖËôïÁêÜÁöÑÈ†òÁî®Ë®òÈåÑ</p>
                </div>

                <div x-show="pendingDispenses.length > 0" class="space-y-3">
                    <template x-for="dispense in pendingDispenses" :key="dispense.id">
                        <div class="bg-white rounded-lg p-4 shadow-sm border" :class="dispense.status === 'EMERGENCY' ? 'border-dispense-purple-700 bg-dispense-purple-50' : 'border-gray-200'">
                            <div class="flex flex-col sm:flex-row justify-between gap-4">
                                <div class="flex-1">
                                    <div class="flex items-center gap-2 mb-2">
                                        <span class="px-2 py-1 rounded text-xs font-semibold"
                                              :class="dispense.status === 'EMERGENCY' ? 'bg-dispense-purple-700 text-white' : 'bg-yellow-500 text-white'"
                                              x-text="dispense.status === 'EMERGENCY' ? 'Á∑äÊÄ•È†òÁî®' : 'ÂæÖÂØ©Ê†∏'"></span>
                                        <span class="text-xs text-gray-500" x-text="`${dispense.hours_pending || 0} Â∞èÊôÇÂâç`"></span>
                                    </div>
                                    <p class="font-semibold text-gray-800" x-text="`${dispense.medicine_code} - ${dispense.medicine_name}`"></p>
                                    <p class="text-sm text-gray-600">Êï∏Èáè: <span class="font-semibold" x-text="dispense.quantity"></span> <span x-text="dispense.unit"></span></p>
                                    <p class="text-sm text-gray-600">È†òËó•‰∫∫: <span class="font-semibold" x-text="dispense.dispensed_by"></span></p>
                                    <p x-show="dispense.patient_name" class="text-sm text-gray-600">ÁóÖÊÇ£: <span x-text="dispense.patient_name"></span></p>
                                    <p x-show="dispense.emergency_reason" class="text-sm text-dispense-purple-900 mt-2 font-medium">
                                        Á∑äÊÄ•ÂéüÂõ†: <span x-text="dispense.emergency_reason"></span>
                                    </p>
                                </div>
                                <div class="flex items-center">
                                    <button @click="openPharmacistApproval(dispense)" class="bg-dispense-purple-700 text-white px-4 py-2 rounded-lg hover:bg-dispense-purple-900 transition-colors flex items-center gap-2">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                        </svg>
                                        <span>Ëó•Â∏´Á¢∫Ë™ç</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>
            </div>
            </div>
        </div>

        <!-- Ë°ÄË¢ãÂàÜÈ†Å -->
        <!-- CHANGED: x-show to style binding to force reactivity -->
        <div :style="currentTab === 'blood' ? '' : 'display: none !important'" class="bg-white rounded-xl shadow-lg p-3 sm:p-4 md:p-6">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-4">
                <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                    <svg class="w-6 h-6 text-blood-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/>
                    </svg>
                    Ë°ÄÂ∫´ÁÆ°ÁêÜ
                </h2>
                <button @click.prevent.stop="showBloodHistoryModal = true; loadBloodHistory()" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                    <span>Ê≠∑Âè≤Ë®òÈåÑ</span>
                </button>
            </div>

            <!-- Ë°ÄÂûãÂ∫´Â≠òÁµ±Ë®àÂçÄ - Ê∑±Á¥ÖËâ≤ËÉåÊôØ -->
            <div class="bg-gradient-to-br from-red-900 to-red-950 rounded-xl p-6 mb-8 shadow-xl">
                <h3 class="text-white text-lg font-bold mb-4 flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                    </svg>
                    Ë°ÄÂûãÂ∫´Â≠òÁµ±Ë®à
                </h3>
                <div class="grid grid-cols-2 sm:grid-cols-4 md:grid-cols-8 gap-3">
                    <template x-for="blood in bloodInventory" :key="blood.blood_type">
                        <div class="bg-red-800 bg-opacity-50 backdrop-blur rounded-lg p-4 border border-red-700 hover:border-red-500 transition-all duration-200 hover:shadow-lg">
                            <div class="text-center">
                                <!-- Ë°ÄÂûãÊ®ôÁ±§ -->
                                <div class="text-sm font-bold text-red-100 mb-2" x-text="blood.blood_type"></div>
                                <!-- Êï∏ÈáèÂ§ßÂ≠óÈ°ØÁ§∫ - Èùû0ÁôΩËâ≤Ôºå0Ê∑∫ÁÅ∞Ëâ≤ -->
                                <div class="text-4xl font-extrabold mb-1"
                                     :class="blood.quantity > 0 ? 'text-white' : 'text-gray-400'"
                                     x-text="blood.quantity"></div>
                                <div class="text-xs text-red-200">Ë¢ã</div>
                            </div>
                        </div>
                    </template>
                </div>
            </div>

            <!-- ÂäüËÉΩÂçÄ - Ê∑∫Ëâ≤È¢®Ê†ºÔºåÁµ±‰∏Ä red Ëâ≤Á≥ª -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Ë°ÄË¢ãÂÖ•Â∫´ -->
                <div class="bg-white border-2 border-red-200 rounded-xl p-5 shadow-sm hover:shadow-md transition-shadow">
                    <h3 class="text-lg font-semibold text-red-700 mb-4 flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                        </svg>
                        Ë°ÄË¢ãÂÖ•Â∫´
                    </h3>
                    <form @submit.prevent="submitBloodReceive()" class="space-y-3">
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Ë°ÄÂûã *</label>
                                <select x-model="bloodReceiveForm.bloodType" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent">
                                    <option value="">ÈÅ∏ÊìáË°ÄÂûã</option>
                                    <option value="A+">A+</option>
                                    <option value="A-">A-</option>
                                    <option value="B+">B+</option>
                                    <option value="B-">B-</option>
                                    <option value="O+">O+</option>
                                    <option value="O-">O-</option>
                                    <option value="AB+">AB+</option>
                                    <option value="AB-">AB-</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Êï∏Èáè (U) *</label>
                                <input type="number" x-model="bloodReceiveForm.quantity" required min="1" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent">
                            </div>
                        </div>

                        <!-- ‰æÜÊ∫êÈÅ∏Êìá -->
                        <div class="col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Ë°ÄÊ∂≤‰æÜÊ∫ê</label>
                            <select x-model="bloodReceiveForm.source" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent">
                                <option value="blood_center">ÊçêË°Ä‰∏≠ÂøÉ</option>
                                <option value="walking_donor">Walking Blood Bank (Á∑äÊÄ•ÊçêË°ÄËÄÖ)</option>
                            </select>
                        </div>

                        <!-- Walking Blood Bank Ë≥áË®ä (Ê¢ù‰ª∂È°ØÁ§∫) -->
                        <div x-show="bloodReceiveForm.source === 'walking_donor'" class="col-span-2 border-t border-red-200 pt-3 space-y-2">
                            <div class="text-sm font-medium text-red-700 flex items-center gap-1 mb-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                                </svg>
                                Á∑äÊÄ•ÊçêË°ÄËÄÖË≥áË®ä
                            </div>
                            <div class="grid grid-cols-2 gap-2">
                                <div>
                                    <label class="block text-xs font-medium text-gray-600 mb-1">ÊçêË°ÄËÄÖÂßìÂêç</label>
                                    <input type="text" x-model="bloodReceiveForm.donorName"
                                           class="w-full px-2 py-1.5 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-red-500 focus:border-transparent"
                                           placeholder="ÈÅ∏Â°´">
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-600 mb-1">ËÅØÁµ°ÈõªË©±</label>
                                    <input type="tel" x-model="bloodReceiveForm.donorPhone"
                                           class="w-full px-2 py-1.5 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-red-500 focus:border-transparent"
                                           placeholder="ÈÅ∏Â°´">
                                </div>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">ÂÇôË®ª</label>
                            <input type="text" x-model="bloodReceiveForm.remarks" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent" placeholder="ÊâπËôü„ÄÅ‰æÜÊ∫êÁ≠â">
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <button type="submit" class="bg-claude-red-500 text-white px-4 py-2 rounded-lg hover:bg-claude-red-600 transition-colors flex items-center justify-center gap-2 font-medium shadow-md">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                </svg>
                                <span>Á¢∫Ë™çÂÖ•Â∫´</span>
                            </button>
                            <button type="button" @click="printBloodLabel()" class="bg-white text-claude-red-500 px-4 py-2 rounded-lg hover:bg-red-50 transition-colors flex items-center justify-center gap-2 border-2 border-claude-red-500">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"/>
                                </svg>
                                <span>ÂàóÂç∞Ê®ôÁ±§</span>
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Ë°ÄË¢ãÂá∫Â∫´ (Âê´ÁóÖÊÇ£Ë≥áË®ä) -->
                <div class="border-2 border-red-200 rounded-lg p-4 bg-white">
                    <h3 class="text-lg font-semibold text-red-700 mb-4 flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"/>
                        </svg>
                        Ë°ÄË¢ãÂá∫Â∫´
                    </h3>
                    <form @submit.prevent="submitBloodConsume()" class="space-y-3">
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Ë°ÄÂûã *</label>
                                <select x-model="bloodConsumeForm.bloodType" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent">
                                    <option value="">ÈÅ∏ÊìáË°ÄÂûã</option>
                                    <option value="A+">A+</option>
                                    <option value="A-">A-</option>
                                    <option value="B+">B+</option>
                                    <option value="B-">B-</option>
                                    <option value="O+">O+</option>
                                    <option value="O-">O-</option>
                                    <option value="AB+">AB+</option>
                                    <option value="AB-">AB-</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Êï∏Èáè (U) *</label>
                                <input type="number" x-model="bloodConsumeForm.quantity" required min="1" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent">
                            </div>
                        </div>
                        <!-- ÁóÖÊÇ£Ë≥áË®ä -->
                        <div class="border-t border-red-200 pt-3 space-y-3">
                            <div class="text-sm font-medium text-gray-700 flex items-center gap-2">
                                <svg class="w-4 h-4 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                                </svg>
                                ÁóÖÊÇ£Ë≥áË®ä
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-600 mb-1">ÁóÖÊÇ£ÂßìÂêç *</label>
                                <input type="text" x-model="bloodConsumeForm.patientName" required class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent" placeholder="Ë´ãËº∏ÂÖ•ÁóÖÊÇ£ÂßìÂêç">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-600 mb-1">ÁóÖÊ≠∑Ëôü</label>
                                <input type="text" x-model="bloodConsumeForm.patientId" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent" placeholder="ÈÅ∏Â°´">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-600 mb-1">Áî®ÈÄîË™™Êòé</label>
                                <textarea x-model="bloodConsumeForm.purpose" rows="2" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent" placeholder="ÊâãË°ì„ÄÅÁ∑äÊÄ•Ëº∏Ë°ÄÁ≠â"></textarea>
                            </div>
                        </div>
                        <button type="submit" class="w-full bg-claude-red-500 text-white px-4 py-2 rounded-lg hover:bg-claude-red-600 transition-colors flex items-center justify-center gap-2 font-medium shadow-md">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                            </svg>
                            <span>Á¢∫Ë™çÂá∫Â∫´</span>
                        </button>
                    </form>
                </div>
            </div>

            <!-- v1.4.2-plus: ÂÄãÂà•Ë°ÄË¢ãËøΩËπ§Á≥ªÁµ± -->
            <div class="mt-8 border-t border-red-200 pt-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold text-red-700 flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"/>
                        </svg>
                        ÂÄãÂà•Ë°ÄË¢ãËøΩËπ§
                    </h3>
                    <div class="flex gap-2">
                        <button @click="loadBloodBags()" class="bg-gray-500 text-white px-3 py-1.5 rounded-lg hover:bg-gray-600 text-sm flex items-center gap-1">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                            </svg>
                            ÈáçÊñ∞Êï¥ÁêÜ
                        </button>
                        <button @click="checkExpiringBags()" class="bg-amber-500 text-white px-3 py-1.5 rounded-lg hover:bg-amber-600 text-sm flex items-center gap-1">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            Âç≥ÊúüË°ÄË¢ã
                        </button>
                    </div>
                </div>

                <!-- Êñ∞Â¢ûË°ÄË¢ãË°®ÂñÆ -->
                <div class="bg-red-50 rounded-xl p-4 mb-4">
                    <h4 class="text-md font-semibold text-red-700 mb-3">Âª∫Á´ãÂÄãÂà•Ë°ÄË¢ã</h4>
                    <form @submit.prevent="createBloodBag()" class="grid grid-cols-2 md:grid-cols-4 gap-3">
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">Ë°ÄÂûã *</label>
                            <select x-model="bloodBagForm.blood_type" required class="w-full px-2 py-1.5 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500">
                                <option value="">ÈÅ∏Êìá</option>
                                <option value="A+">A+</option>
                                <option value="A-">A-</option>
                                <option value="B+">B+</option>
                                <option value="B-">B-</option>
                                <option value="O+">O+</option>
                                <option value="O-">O-</option>
                                <option value="AB+">AB+</option>
                                <option value="AB-">AB-</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">ÂÆπÈáè (ml)</label>
                            <input type="number" x-model="bloodBagForm.volume_ml" min="100" max="500"
                                   class="w-full px-2 py-1.5 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500"
                                   placeholder="250">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">Êé°ÈõÜÊó•Êúü</label>
                            <input type="date" x-model="bloodBagForm.collection_date"
                                   class="w-full px-2 py-1.5 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">ÊïàÊúü</label>
                            <input type="date" x-model="bloodBagForm.expiry_date"
                                   class="w-full px-2 py-1.5 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500">
                        </div>
                        <div class="col-span-2 md:col-span-3">
                            <label class="block text-xs font-medium text-gray-700 mb-1">ÊçêË¥àËÄÖ/‰æÜÊ∫ê</label>
                            <input type="text" x-model="bloodBagForm.donor_info" placeholder="ÈÅ∏Â°´"
                                   class="w-full px-2 py-1.5 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500">
                        </div>
                        <div class="flex items-end">
                            <button type="submit" class="w-full bg-claude-red-500 text-white px-3 py-1.5 rounded-lg hover:bg-claude-red-600 text-sm flex items-center justify-center gap-1">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                                </svg>
                                Âª∫Á´ãË°ÄË¢ã
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Ë°ÄË¢ãÂàóË°® -->
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200 text-sm">
                        <thead class="bg-red-100">
                            <tr>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-600 uppercase">
                                    <input type="checkbox" @change="toggleAllBags($event.target.checked)" class="rounded">
                                </th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-600 uppercase">Ë°ÄË¢ãÁ∑®Ëôü</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-600 uppercase">Ë°ÄÂûã</th>
                                <th class="px-3 py-2 text-center text-xs font-medium text-gray-600 uppercase">ÂÆπÈáè</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-600 uppercase">ÊïàÊúü</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-600 uppercase">ÁãÄÊÖã</th>
                                <th class="px-3 py-2 text-center text-xs font-medium text-gray-600 uppercase">Êìç‰Ωú</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            <template x-for="bag in bloodBags" :key="bag.bag_code">
                                <tr :class="{
                                    'bg-red-200 animate-pulse': isExpired(bag.expiry_date) && bag.status === 'AVAILABLE',
                                    'bg-amber-100': isExpiringSoon(bag.expiry_date) && !isExpired(bag.expiry_date) && bag.status === 'AVAILABLE',
                                    'bg-gray-50': bag.status === 'USED' || bag.status === 'DISCARDED'
                                }">
                                    <td class="px-3 py-2">
                                        <input type="checkbox" :value="bag.bag_code" x-model="selectedBagCodes" class="rounded">
                                    </td>
                                    <td class="px-3 py-2 font-mono text-xs" x-text="bag.bag_code"></td>
                                    <td class="px-3 py-2">
                                        <span class="px-2 py-0.5 text-xs font-bold rounded bg-red-600 text-white" x-text="bag.blood_type"></span>
                                    </td>
                                    <td class="px-3 py-2 text-center" x-text="bag.volume_ml + ' ml'"></td>
                                    <td class="px-3 py-2 text-xs">
                                        <span :class="{
                                            'text-red-700 font-bold': isExpired(bag.expiry_date),
                                            'text-amber-600 font-semibold': isExpiringSoon(bag.expiry_date) && !isExpired(bag.expiry_date),
                                            'text-gray-600': !isExpiringSoon(bag.expiry_date) && !isExpired(bag.expiry_date)
                                        }">
                                            <template x-if="isExpired(bag.expiry_date) && bag.status === 'AVAILABLE'">
                                                <span class="inline-flex items-center gap-1">
                                                    <svg class="w-4 h-4 text-red-600" fill="currentColor" viewBox="0 0 20 20">
                                                        <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                                                    </svg>
                                                    <span>Â∑≤ÈÅéÊúü!</span>
                                                </span>
                                            </template>
                                            <template x-if="isExpiringSoon(bag.expiry_date) && !isExpired(bag.expiry_date) && bag.status === 'AVAILABLE'">
                                                <span class="inline-flex items-center gap-1">
                                                    <svg class="w-4 h-4 text-amber-500" fill="currentColor" viewBox="0 0 20 20">
                                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"/>
                                                    </svg>
                                                    <span x-text="bag.expiry_date"></span>
                                                </span>
                                            </template>
                                            <template x-if="!isExpiringSoon(bag.expiry_date) && !isExpired(bag.expiry_date)">
                                                <span x-text="bag.expiry_date || '-'"></span>
                                            </template>
                                            <template x-if="(isExpiringSoon(bag.expiry_date) || isExpired(bag.expiry_date)) && bag.status !== 'AVAILABLE'">
                                                <span x-text="bag.expiry_date || '-'"></span>
                                            </template>
                                        </span>
                                    </td>
                                    <td class="px-3 py-2">
                                        <span class="px-2 py-0.5 text-xs font-medium rounded-full"
                                              :class="{
                                                  'bg-green-100 text-green-700': bag.status === 'AVAILABLE',
                                                  'bg-gray-100 text-gray-700': bag.status === 'USED',
                                                  'bg-red-100 text-red-700': bag.status === 'EXPIRED' || bag.status === 'DISCARDED',
                                                  'bg-yellow-100 text-yellow-700': bag.status === 'RESERVED'
                                              }"
                                              x-text="bag.status === 'AVAILABLE' ? 'ÂèØÁî®' : bag.status === 'USED' ? 'Â∑≤‰ΩøÁî®' : bag.status === 'EXPIRED' ? 'Â∑≤ÈÅéÊúü' : bag.status === 'DISCARDED' ? 'Â∑≤‰∏üÊ£Ñ' : 'Â∑≤È†êÁïô'"></span>
                                    </td>
                                    <td class="px-3 py-2 text-center space-x-1">
                                        <button @click="printSingleBagLabel(bag.bag_code)" class="text-gray-600 hover:text-gray-800 text-xs" title="ÂàóÂç∞Ê®ôÁ±§">
                                            <svg class="w-4 h-4 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"/>
                                            </svg>
                                        </button>
                                        <button x-show="bag.status === 'AVAILABLE'" @click="useBloodBag(bag.bag_code)" class="text-blue-600 hover:text-blue-800 text-xs" title="‰ΩøÁî®Ë°ÄË¢ã">
                                            ‰ΩøÁî®
                                        </button>
                                        <button x-show="bag.status === 'AVAILABLE'" @click="discardBloodBag(bag.bag_code)" class="text-red-600 hover:text-red-800 text-xs" title="‰∏üÊ£ÑË°ÄË¢ã(ÈÅéÊúü/ÊêçÂ£û)">
                                            ‰∏üÊ£Ñ
                                        </button>
                                    </td>
                                </tr>
                            </template>
                            <tr x-show="bloodBags.length === 0">
                                <td colspan="7" class="px-3 py-4 text-center text-gray-500 text-sm">Â∞öÁÑ°ÂÄãÂà•Ë°ÄË¢ãË≥áÊñô</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- ÊâπÊ¨°Êìç‰Ωú -->
                <div x-show="selectedBagCodes.length > 0" class="mt-4 bg-red-100 rounded-lg p-3 flex items-center justify-between">
                    <span class="text-sm text-red-700">Â∑≤ÈÅ∏Êìá <span x-text="selectedBagCodes.length" class="font-bold"></span> Ë¢ãË°ÄË¢ã</span>
                    <button @click="printSelectedBagLabels()" class="bg-claude-red-500 text-white px-4 py-2 rounded-lg hover:bg-claude-red-600 text-sm flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"/>
                        </svg>
                        ÊâπÊ¨°ÂàóÂç∞Ê®ôÁ±§
                    </button>
                </div>
            </div>
        </div>
        <!-- CHANGED: x-show to style binding for equipment tab -->
        <div :style="currentTab === 'equipment' ? '' : 'display: none !important'" class="bg-white rounded-xl shadow-lg p-3 sm:p-4 md:p-6">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-4">
                <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                    <svg class="w-6 h-6 text-equipment-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                    </svg>
                    Ë®≠ÂÇôÁÆ°ÁêÜ
                </h2>
                <div class="flex flex-wrap gap-2">
                    <button @click="showAddEquipmentModal = true" class="bg-equipment-500 text-white px-4 py-2 rounded-lg hover:bg-[#5a6155] transition-colors flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                        </svg>
                        <span>Êñ∞Â¢ûË®≠ÂÇô</span>
                    </button>
                    <button @click="loadEquipment()" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                        </svg>
                        <span>ÈáçÊñ∞ËºâÂÖ•</span>
                    </button>
                </div>
            </div>

            <!-- Ëá™ÂãïÂà∑Êñ∞ÊèêÁ§∫ -->
            <div class="mb-4 p-3 bg-equipment-500 bg-opacity-10 rounded-lg flex items-center gap-2 text-sm text-gray-700">
                <svg class="w-5 h-5 text-equipment-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                <span>Ë®≠ÂÇôÁãÄÊÖãÂ∞áÊñºÊØèÊó• <strong class="text-equipment-500">07:00am</strong> Ëá™ÂãïÈáçÁΩÆÁÇ∫ÂæÖÊ™¢Êü•</span>
            </div>

            <!-- ‰æõÈõªË®≠ÂÇôÂçÄÂüü -->
            <div class="bg-gradient-to-br from-equipment-100 to-equipment-200 border-2 border-equipment-200 rounded-xl p-5 mb-6 shadow-sm">
                <div class="bg-equipment-900 text-white px-6 py-3.5 -mx-5 -mt-5 mb-5 rounded-t-xl">
                    <h3 class="text-lg font-semibold flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                        </svg>
                        ‰æõÈõªË®≠ÂÇô
                        <span class="ml-2 text-sm font-normal opacity-80" x-text="'(' + getPowerSupplyEquipment().length + ' È†Ö)'"></span>
                        <span class="ml-auto text-xs font-normal bg-amber-500 px-2 py-0.5 rounded">ÈüåÊÄßÈóúÈçµ</span>
                    </h3>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead class="bg-gray-50 text-gray-600">
                            <tr>
                                <th class="px-3 py-2 text-left font-medium">Á∑®Ëôü</th>
                                <th class="px-3 py-2 text-left font-medium">ÂêçÁ®±</th>
                                <th class="px-3 py-2 text-center font-medium">Êï∏Èáè</th>
                                <th class="px-3 py-2 text-center font-medium">Â≠òÈáè <span class="text-amber-500 text-xs">‚ö°ÈüåÊÄß</span></th>
                                <th class="px-3 py-2 text-center font-medium">ÁãÄÊÖã</th>
                                <th class="px-3 py-2 text-left font-medium hidden lg:table-cell">ÊúÄÂæåÊ™¢Êü•</th>
                                <th class="px-3 py-2 text-center font-medium">Êìç‰Ωú</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-100">
                            <template x-for="eq in getPowerSupplyEquipment()" :key="eq.id + '-' + equipmentRefreshKey">
                                <tr class="hover:bg-gray-50" :class="{ 'bg-green-50': eq.status === 'NORMAL', 'bg-yellow-50': eq.status === 'WARNING', 'bg-red-50': eq.status === 'ERROR' }">
                                    <td class="px-3 py-2 font-mono text-xs text-gray-500" x-text="eq.id"></td>
                                    <td class="px-3 py-2 font-medium text-gray-900" x-text="eq.name"></td>
                                    <td class="px-3 py-2 text-center font-semibold" x-text="eq.quantity"></td>
                                    <td class="px-3 py-2 text-center">
                                        <template x-if="eq.power_level !== null">
                                            <div>
                                                <span class="font-medium" :class="{ 'text-green-600': eq.power_level >= 60, 'text-yellow-600': eq.power_level >= 30 && eq.power_level < 60, 'text-red-600': eq.power_level < 30 }" x-text="eq.power_level + '%'"></span>
                                                <div class="text-xs text-amber-600">‚âà<span x-text="getResilienceHours(eq) || '‚Äî'"></span>h</div>
                                            </div>
                                        </template>
                                        <span x-show="eq.power_level === null" class="text-gray-400">-</span>
                                    </td>
                                    <td class="px-3 py-2 text-center">
                                        <span :class="{ 'bg-green-100 text-green-800': eq.status === 'NORMAL', 'bg-yellow-100 text-yellow-800': eq.status === 'WARNING', 'bg-red-100 text-red-800': eq.status === 'ERROR', 'bg-gray-100 text-gray-800': eq.status === 'UNCHECKED' || eq.status === 'PENDING' }" class="px-2 py-0.5 text-xs font-medium rounded-full" x-text="eq.status"></span>
                                    </td>
                                    <td class="px-3 py-2 text-xs text-gray-500 hidden lg:table-cell" x-text="eq.last_check ? new Date(eq.last_check).toLocaleString('zh-TW') : '-'"></td>
                                    <td class="px-3 py-2 text-center">
                                        <div class="flex gap-1 justify-center">
                                            <button @click="checkEquipment(eq)" class="text-equipment-500 hover:text-[#5a6155] text-xs font-medium px-1.5 sm:px-2 py-1 bg-equipment-100 rounded" title="Ê™¢Êü•">‚úì</button>
                                            <button @click="openUnitManageModal(eq)" class="text-equipment-500 hover:text-[#5a6155] text-xs font-medium px-1.5 sm:px-2 py-1 bg-equipment-100 rounded" title="ÁÆ°ÁêÜÂñÆ‰Ωç">‚äû</button>
                                            <button @click="editEquipment(eq)" class="hidden sm:inline-block text-gray-600 hover:text-gray-800 text-xs font-medium px-2 py-1 bg-gray-100 rounded" title="Á∑®ËºØ">‚úé</button>
                                            <button @click="deleteEquipment(eq.id, eq.name)" class="hidden sm:inline-block text-red-600 hover:text-red-800 text-xs font-medium px-2 py-1 bg-red-50 rounded" title="Âà™Èô§">‚úï</button>
                                            <!-- ÊâãÊ©üÁâàÊõ¥Â§öÈÅ∏ÂñÆ -->
                                            <div class="relative sm:hidden" x-data="{ open: false }">
                                                <button @click="open = !open" class="text-gray-500 hover:text-gray-700 text-xs font-medium px-1.5 py-1 bg-gray-100 rounded" title="Êõ¥Â§ö">‚ãØ</button>
                                                <div x-show="open" @click.away="open = false" class="absolute right-0 mt-1 bg-white border rounded-lg shadow-lg z-10 py-1 min-w-[80px]">
                                                    <button @click="editEquipment(eq); open = false" class="block w-full text-left px-3 py-1.5 text-xs hover:bg-gray-100">‚úé Á∑®ËºØ</button>
                                                    <button @click="deleteEquipment(eq.id, eq.name); open = false" class="block w-full text-left px-3 py-1.5 text-xs text-red-600 hover:bg-red-50">‚úï Âà™Èô§</button>
                                                </div>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                    <div x-show="getPowerSupplyEquipment().length === 0" class="text-center text-gray-400 py-8">ÁõÆÂâçÊ≤íÊúâ‰æõÈõªË®≠ÂÇô</div>
                </div>
            </div>

            <!-- ËÄóÈõªË®≠ÂÇôÂçÄÂüü -->
            <div class="bg-gradient-to-br from-equipment-100 to-equipment-200 border-2 border-equipment-200 rounded-xl p-5 mb-6 shadow-sm">
                <div class="bg-equipment-900 text-white px-6 py-3.5 -mx-5 -mt-5 mb-5 rounded-t-xl">
                    <h3 class="text-lg font-semibold flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z"/>
                        </svg>
                        ËÄóÈõªË®≠ÂÇô
                        <span class="ml-2 text-sm font-normal opacity-80" x-text="'(' + getPowerConsumingEquipment().length + ' È†Ö)'"></span>
                    </h3>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead class="bg-gray-50 text-gray-600">
                            <tr>
                                <th class="px-3 py-2 text-left font-medium">Á∑®Ëôü</th>
                                <th class="px-3 py-2 text-left font-medium">ÂêçÁ®±</th>
                                <th class="px-3 py-2 text-left font-medium hidden sm:table-cell">È°ûÂà•</th>
                                <th class="px-3 py-2 text-center font-medium">Êï∏Èáè</th>
                                <th class="px-3 py-2 text-center font-medium">ÁãÄÊÖã</th>
                                <th class="px-3 py-2 text-left font-medium hidden lg:table-cell">ÊúÄÂæåÊ™¢Êü•</th>
                                <th class="px-3 py-2 text-center font-medium">Êìç‰Ωú</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-100">
                            <template x-for="eq in getPowerConsumingEquipment()" :key="eq.id + '-' + equipmentRefreshKey">
                                <tr class="hover:bg-gray-50" :class="{ 'bg-green-50': eq.status === 'NORMAL', 'bg-yellow-50': eq.status === 'WARNING', 'bg-red-50': eq.status === 'ERROR' }">
                                    <td class="px-3 py-2 font-mono text-xs text-gray-500" x-text="eq.id"></td>
                                    <td class="px-3 py-2 font-medium text-gray-900" x-text="eq.name"></td>
                                    <td class="px-3 py-2 text-gray-600 hidden sm:table-cell" x-text="eq.category"></td>
                                    <td class="px-3 py-2 text-center font-semibold" x-text="eq.quantity"></td>
                                    <td class="px-3 py-2 text-center">
                                        <span :class="{ 'bg-green-100 text-green-800': eq.status === 'NORMAL', 'bg-yellow-100 text-yellow-800': eq.status === 'WARNING', 'bg-red-100 text-red-800': eq.status === 'ERROR', 'bg-gray-100 text-gray-800': eq.status === 'UNCHECKED' || eq.status === 'PENDING' }" class="px-2 py-0.5 text-xs font-medium rounded-full" x-text="eq.status"></span>
                                    </td>
                                    <td class="px-3 py-2 text-xs text-gray-500 hidden lg:table-cell" x-text="eq.last_check ? new Date(eq.last_check).toLocaleString('zh-TW') : '-'"></td>
                                    <td class="px-3 py-2 text-center">
                                        <div class="flex gap-1 justify-center">
                                            <button @click="checkEquipment(eq)" class="text-equipment-500 hover:text-[#5a6155] text-xs font-medium px-1.5 sm:px-2 py-1 bg-equipment-100 rounded" title="Ê™¢Êü•">‚úì</button>
                                            <button @click="openUnitManageModal(eq)" class="text-equipment-500 hover:text-[#5a6155] text-xs font-medium px-1.5 sm:px-2 py-1 bg-equipment-100 rounded" title="ÁÆ°ÁêÜÂñÆ‰Ωç">‚äû</button>
                                            <button @click="editEquipment(eq)" class="hidden sm:inline-block text-gray-600 hover:text-gray-800 text-xs font-medium px-2 py-1 bg-gray-100 rounded" title="Á∑®ËºØ">‚úé</button>
                                            <button @click="deleteEquipment(eq.id, eq.name)" class="hidden sm:inline-block text-red-600 hover:text-red-800 text-xs font-medium px-2 py-1 bg-red-50 rounded" title="Âà™Èô§">‚úï</button>
                                            <!-- ÊâãÊ©üÁâàÊõ¥Â§öÈÅ∏ÂñÆ -->
                                            <div class="relative sm:hidden" x-data="{ open: false }">
                                                <button @click="open = !open" class="text-gray-500 hover:text-gray-700 text-xs font-medium px-1.5 py-1 bg-gray-100 rounded" title="Êõ¥Â§ö">‚ãØ</button>
                                                <div x-show="open" @click.away="open = false" class="absolute right-0 mt-1 bg-white border rounded-lg shadow-lg z-10 py-1 min-w-[80px]">
                                                    <button @click="editEquipment(eq); open = false" class="block w-full text-left px-3 py-1.5 text-xs hover:bg-gray-100">‚úé Á∑®ËºØ</button>
                                                    <button @click="deleteEquipment(eq.id, eq.name); open = false" class="block w-full text-left px-3 py-1.5 text-xs text-red-600 hover:bg-red-50">‚úï Âà™Èô§</button>
                                                </div>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                    <div x-show="getPowerConsumingEquipment().length === 0" class="text-center text-gray-400 py-8">ÁõÆÂâçÊ≤íÊúâËÄóÈõªË®≠ÂÇô</div>
                </div>
            </div>

            <!-- ÈùûËÄóÈõªË®≠ÂÇôÂçÄÂüü -->
            <div class="bg-gradient-to-br from-equipment-100 to-equipment-200 border-2 border-equipment-200 rounded-xl p-5 mb-6 shadow-sm">
                <div class="bg-equipment-900 text-white px-6 py-3.5 -mx-5 -mt-5 mb-5 rounded-t-xl">
                    <h3 class="text-lg font-semibold flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                        </svg>
                        ÈùûËÄóÈõªË®≠ÂÇô
                        <span class="ml-2 text-sm font-normal opacity-80" x-text="'(' + getNonElectricEquipment().length + ' È†Ö)'"></span>
                    </h3>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead class="bg-gray-50 text-gray-600">
                            <tr>
                                <th class="px-3 py-2 text-left font-medium">Á∑®Ëôü</th>
                                <th class="px-3 py-2 text-left font-medium">ÂêçÁ®±</th>
                                <th class="px-3 py-2 text-left font-medium hidden sm:table-cell">È°ûÂà•</th>
                                <th class="px-3 py-2 text-center font-medium">Êï∏Èáè</th>
                                <th class="px-3 py-2 text-center font-medium">ÁãÄÊÖã</th>
                                <th class="px-3 py-2 text-left font-medium hidden lg:table-cell">ÊúÄÂæåÊ™¢Êü•</th>
                                <th class="px-3 py-2 text-center font-medium">Êìç‰Ωú</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-100">
                            <template x-for="eq in getNonElectricEquipment()" :key="eq.id + '-' + equipmentRefreshKey">
                                <tr class="hover:bg-gray-50" :class="{ 'bg-green-50': eq.status === 'NORMAL', 'bg-yellow-50': eq.status === 'WARNING', 'bg-red-50': eq.status === 'ERROR' }">
                                    <td class="px-3 py-2 font-mono text-xs text-gray-500" x-text="eq.id"></td>
                                    <td class="px-3 py-2 font-medium text-gray-900" x-text="eq.name"></td>
                                    <td class="px-3 py-2 text-gray-600 hidden sm:table-cell" x-text="eq.category"></td>
                                    <td class="px-3 py-2 text-center font-semibold" x-text="eq.quantity"></td>
                                    <td class="px-3 py-2 text-center">
                                        <span :class="{ 'bg-green-100 text-green-800': eq.status === 'NORMAL', 'bg-yellow-100 text-yellow-800': eq.status === 'WARNING', 'bg-red-100 text-red-800': eq.status === 'ERROR', 'bg-gray-100 text-gray-800': eq.status === 'UNCHECKED' || eq.status === 'PENDING' }" class="px-2 py-0.5 text-xs font-medium rounded-full" x-text="eq.status"></span>
                                    </td>
                                    <td class="px-3 py-2 text-xs text-gray-500 hidden lg:table-cell" x-text="eq.last_check ? new Date(eq.last_check).toLocaleString('zh-TW') : '-'"></td>
                                    <td class="px-3 py-2 text-center">
                                        <div class="flex gap-1 justify-center">
                                            <button @click="checkEquipment(eq)" class="text-equipment-500 hover:text-[#5a6155] text-xs font-medium px-1.5 sm:px-2 py-1 bg-equipment-100 rounded" title="Ê™¢Êü•">‚úì</button>
                                            <button @click="openUnitManageModal(eq)" class="text-equipment-500 hover:text-[#5a6155] text-xs font-medium px-1.5 sm:px-2 py-1 bg-equipment-100 rounded" title="ÁÆ°ÁêÜÂñÆ‰Ωç">‚äû</button>
                                            <button @click="editEquipment(eq)" class="hidden sm:inline-block text-gray-600 hover:text-gray-800 text-xs font-medium px-2 py-1 bg-gray-100 rounded" title="Á∑®ËºØ">‚úé</button>
                                            <button @click="deleteEquipment(eq.id, eq.name)" class="hidden sm:inline-block text-red-600 hover:text-red-800 text-xs font-medium px-2 py-1 bg-red-50 rounded" title="Âà™Èô§">‚úï</button>
                                            <!-- ÊâãÊ©üÁâàÊõ¥Â§öÈÅ∏ÂñÆ -->
                                            <div class="relative sm:hidden" x-data="{ open: false }">
                                                <button @click="open = !open" class="text-gray-500 hover:text-gray-700 text-xs font-medium px-1.5 py-1 bg-gray-100 rounded" title="Êõ¥Â§ö">‚ãØ</button>
                                                <div x-show="open" @click.away="open = false" class="absolute right-0 mt-1 bg-white border rounded-lg shadow-lg z-10 py-1 min-w-[80px]">
                                                    <button @click="editEquipment(eq); open = false" class="block w-full text-left px-3 py-1.5 text-xs hover:bg-gray-100">‚úé Á∑®ËºØ</button>
                                                    <button @click="deleteEquipment(eq.id, eq.name); open = false" class="block w-full text-left px-3 py-1.5 text-xs text-red-600 hover:bg-red-50">‚úï Âà™Èô§</button>
                                                </div>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                    <div x-show="getNonElectricEquipment().length === 0" class="text-center text-gray-400 py-8">ÁõÆÂâçÊ≤íÊúâÈùûËÄóÈõªË®≠ÂÇô</div>
                </div>
            </div>

            <!-- ÊâãË°ìÂåÖÂçÄÂüü -->
            <div class="bg-gradient-to-br from-equipment-100 to-equipment-200 border-2 border-equipment-200 rounded-xl p-5 shadow-sm">
                <div class="bg-equipment-900 text-white px-6 py-3.5 -mx-5 -mt-5 mb-5 rounded-t-xl">
                    <h3 class="text-lg font-semibold flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
                        </svg>
                        ÊâãË°ìÂåÖ
                        <span class="ml-2 text-sm font-normal opacity-80" x-text="'(' + equipment.filter(e => e.id.includes('-SURG-') || e.id.startsWith('SURG-')).length + ' È†Ö)'"></span>
                    </h3>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead class="bg-gray-50 text-gray-600">
                            <tr>
                                <th class="px-3 py-2 text-left font-medium">Á∑®Ëôü</th>
                                <th class="px-3 py-2 text-left font-medium">ÂêçÁ®±</th>
                                <th class="px-3 py-2 text-center font-medium">Êï∏Èáè</th>
                                <th class="px-3 py-2 text-center font-medium">ÁãÄÊÖã</th>
                                <th class="px-3 py-2 text-left font-medium hidden md:table-cell">ÊúÄÂæåÊ™¢Êü•</th>
                                <th class="px-3 py-2 text-center font-medium">Êìç‰Ωú</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-100">
                            <template x-for="eq in equipment.filter(e => e.id.includes('-SURG-') || e.id.startsWith('SURG-'))" :key="eq.id + '-' + equipmentRefreshKey">
                                <tr class="hover:bg-gray-50" :class="{
                                    'bg-green-50': eq.status === 'NORMAL',
                                    'bg-yellow-50': eq.status === 'WARNING',
                                    'bg-red-50': eq.status === 'ERROR'
                                }">
                                    <td class="px-3 py-2 font-mono text-xs text-gray-500" x-text="eq.id"></td>
                                    <td class="px-3 py-2 font-medium text-gray-900" x-text="eq.name"></td>
                                    <td class="px-3 py-2 text-center font-semibold" x-text="eq.quantity"></td>
                                    <td class="px-3 py-2 text-center">
                                        <span :class="{
                                            'bg-green-100 text-green-800': eq.status === 'NORMAL',
                                            'bg-yellow-100 text-yellow-800': eq.status === 'WARNING',
                                            'bg-red-100 text-red-800': eq.status === 'ERROR',
                                            'bg-gray-100 text-gray-800': eq.status === 'UNCHECKED' || eq.status === 'PENDING'
                                        }" class="px-2 py-0.5 text-xs font-medium rounded-full" x-text="eq.status"></span>
                                    </td>
                                    <td class="px-3 py-2 text-xs text-gray-500 hidden md:table-cell" x-text="eq.last_check ? new Date(eq.last_check).toLocaleString('zh-TW') : '-'"></td>
                                    <td class="px-3 py-2 text-center">
                                        <div class="flex gap-1 justify-center">
                                            <button @click="checkEquipment(eq)" class="text-equipment-500 hover:text-[#5a6155] text-xs font-medium px-1.5 sm:px-2 py-1 bg-equipment-100 rounded" title="Ê™¢Êü•">‚úì</button>
                                            <button @click="openUnitManageModal(eq)" class="text-equipment-500 hover:text-[#5a6155] text-xs font-medium px-1.5 sm:px-2 py-1 bg-equipment-100 rounded" title="ÁÆ°ÁêÜÂñÆ‰Ωç">‚äû</button>
                                            <button @click="editEquipment(eq)" class="hidden sm:inline-block text-gray-600 hover:text-gray-800 text-xs font-medium px-2 py-1 bg-gray-100 rounded" title="Á∑®ËºØ">‚úé</button>
                                            <button @click="deleteEquipment(eq.id, eq.name)" class="hidden sm:inline-block text-red-600 hover:text-red-800 text-xs font-medium px-2 py-1 bg-red-50 rounded" title="Âà™Èô§">‚úï</button>
                                            <!-- ÊâãÊ©üÁâàÊõ¥Â§öÈÅ∏ÂñÆ -->
                                            <div class="relative sm:hidden" x-data="{ open: false }">
                                                <button @click="open = !open" class="text-gray-500 hover:text-gray-700 text-xs font-medium px-1.5 py-1 bg-gray-100 rounded" title="Êõ¥Â§ö">‚ãØ</button>
                                                <div x-show="open" @click.away="open = false" class="absolute right-0 mt-1 bg-white border rounded-lg shadow-lg z-10 py-1 min-w-[80px]">
                                                    <button @click="editEquipment(eq); open = false" class="block w-full text-left px-3 py-1.5 text-xs hover:bg-gray-100">‚úé Á∑®ËºØ</button>
                                                    <button @click="deleteEquipment(eq.id, eq.name); open = false" class="block w-full text-left px-3 py-1.5 text-xs text-red-600 hover:bg-red-50">‚úï Âà™Èô§</button>
                                                </div>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                    <div x-show="equipment.filter(e => e.id.includes('-SURG-') || e.id.startsWith('SURG-')).length === 0" class="text-center text-gray-400 py-8">
                        ÁõÆÂâçÊ≤íÊúâÊâãË°ìÂåÖ
                    </div>
                </div>
            </div>
        </div>

        <!-- ÈüåÊÄß‰º∞ÁÆóÂàÜÈ†Å -->
        <div :style="currentTab === 'resilience' ? '' : 'display: none !important'" class="bg-white rounded-xl shadow-lg p-3 sm:p-4 md:p-6">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-4">
                <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                    <svg class="w-6 h-6 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
                    </svg>
                    ÈüåÊÄß‰º∞ÁÆó
                </h2>
                <div class="flex gap-2">
                    <button @click="loadResilienceStatus()" class="px-4 py-2 bg-amber-500 text-white rounded-lg hover:bg-amber-600 transition-colors flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                        </svg>
                        ÈáçÊñ∞Ë®àÁÆó
                    </button>
                    <!-- v1.2.8: Ê™¢Êü•Â†±Ë°®ÊåâÈàï -->
                    <button @click="showCheckReportModal = true; loadCheckReport()" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                        Ê™¢Êü•Â†±Ë°®
                    </button>
                </div>
            </div>

            <!-- Ë®≠ÂÆöÂçÄ -->
            <div class="bg-amber-50 rounded-lg p-4 mb-6">
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">È†ê‰º∞Â≠§Á´ãÂ§©Êï∏</label>
                        <div class="flex items-center gap-2">
                            <input type="number" x-model.number="resilienceConfig.isolation_target_days" min="1" max="30"
                                   @input.debounce.500ms="updateResilienceConfig()"
                                   class="w-20 px-3 py-2 border border-amber-300 rounded-lg focus:ring-2 focus:ring-amber-500">
                            <span class="text-gray-600">Â§©</span>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            <span x-text="resilienceConfig.population_label || 'Ê∞ßÊ∞£ÈúÄÊ±Ç'"></span>
                            <span class="text-xs text-gray-400 ml-1">(Á≠âÊïàÊèíÁÆ°‰∫∫Êï∏)</span>
                        </label>
                        <div class="flex items-center gap-2">
                            <input type="number" x-model.number="resilienceConfig.population_count" min="0" max="100" step="0.1"
                                   @input.debounce.500ms="updateResilienceConfig()"
                                   class="w-24 px-3 py-2 border border-amber-300 rounded-lg focus:ring-2 focus:ring-amber-500"
                                   title="ÊèíÁÆ°=1.0, Èù¢ÁΩ©‚âà0.6, ÈºªÂ∞éÁÆ°‚âà0.3">
                            <span class="text-gray-500 text-sm">Á≠âÊïà‰∫∫</span>
                        </div>
                        <p class="text-xs text-gray-400 mt-1">ÊèíÁÆ°=1.0 | Èù¢ÁΩ©‚âà0.6 | ÈºªÂ∞éÁÆ°‚âà0.3</p>
                    </div>
                    <div class="flex items-end gap-3">
                        <button @click="updateResilienceConfig()"
                                class="px-3 py-1.5 bg-amber-100 text-amber-700 rounded-lg hover:bg-amber-200 text-sm font-medium">
                            Â•óÁî®
                        </button>
                        <div class="text-sm text-amber-700">
                            <span class="font-medium">ÁõÆÊ®ôÔºö</span>
                            ÊíêÈÅé <span class="font-bold" x-text="resilienceConfig.isolation_target_days"></span> Â§©Â≠§Á´ãÊúü
                        </div>
                    </div>
                </div>
            </div>

            <!-- Ë®àÁÆóÂÖ¨ÂºèË™™Êòé -->
            <div class="mb-4" x-data="{ showFormula: false }">
                <button @click="showFormula = !showFormula"
                        class="text-sm text-amber-600 hover:text-amber-700 flex items-center gap-1">
                    <svg class="w-4 h-4" :class="showFormula ? 'rotate-90' : ''" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                    </svg>
                    Ë®àÁÆóÂÖ¨ÂºèË™™Êòé
                </button>
                <div x-show="showFormula" x-collapse class="mt-2 p-3 bg-amber-50 border border-amber-200 rounded-lg text-sm">
                    <div class="space-y-2 text-gray-700">
                        <p class="font-medium text-amber-700 mb-1">‚ñéÈãºÁì∂Ê∞ßÊ∞£‰æõÊáâ</p>
                        <p><strong>Ê∞ßÊ∞£ÊôÇÊï∏</strong> = Œ£(ÊØèÁì∂ÂÆπÈáè √ó ÂÖÖÂ°´%) √∑ (10 L/min √ó Á≠âÊïà‰∫∫Êï∏ √ó 60)</p>
                        <p class="text-xs text-gray-500 ml-4">‚Ä¢ HÂûãÈãºÁì∂ = 6,900 L | EÂûãÊ∞ßÊ∞£Áì∂ = 680 L</p>
                        <hr class="border-amber-200 my-2">
                        <p class="font-medium text-amber-700 mb-1">‚ñéÊ∞ßÊ∞£ÊøÉÁ∏ÆÊ©ü (‰æùË≥¥ÈõªÂäõ)</p>
                        <p><strong>ÊøÉÁ∏ÆÊ©üËº∏Âá∫</strong> = 5 L/min (Âõ∫ÂÆöÊµÅÈáè)</p>
                        <p><strong>ÂèØ‰æõÊáâ‰∫∫Êï∏</strong> = 5 √∑ 10 = 0.5 Á≠âÊïà‰∫∫ (ËÄóÈõªÁ¥Ñ 300W)</p>
                        <p class="text-xs text-gray-500 ml-4">‚ö° ÊøÉÁ∏ÆÊ©üÈÅã‰ΩúÊôÇÈñì ‚â§ ÈõªÂäõÂèØÁî®ÊôÇÊï∏</p>
                        <hr class="border-amber-200 my-2">
                        <p class="font-medium text-amber-700 mb-1">‚ñéÈõªÂäõ‰æõÊáâ</p>
                        <p><strong>ÈõªÂäõÊôÇÊï∏</strong> = (Ê≤πÁÆ±ÂÆπÈáè √ó Ê™¢Êü•%) √∑ 3.0 L/hr</p>
                        <p class="text-xs text-gray-500 ml-4">‚Ä¢ UTIL-002 ÁôºÈõªÊ©üÊ≤πÁÆ± = 50 L (Á¥Ñ 16.7 Â∞èÊôÇ)</p>
                        <hr class="border-amber-200 my-2">
                        <p class="font-medium text-amber-700 mb-1">‚ñéÁ∂úÂêàÈüåÊÄß</p>
                        <p><strong>ÂèØÁç®Á´ãÈÅã‰Ωú</strong> = MIN(Ê∞ßÊ∞£ÊôÇÊï∏, ÈõªÂäõÊôÇÊï∏)</p>
                        <p class="text-xs text-gray-500 ml-4">‚Ä¢ Ëã•Ê∞ßÊ∞£ÊøÉÁ∏ÆÊ©üÁÇ∫‰∏ªË¶Å‰æõÊ∞ßÔºåÂâáÂèóÈõªÂäõÈôêÂà∂</p>
                        <hr class="border-amber-200 my-2">
                        <p class="text-xs text-gray-600 mb-1"><strong>Á≠âÊïà‰∫∫Êï∏ÊèõÁÆóÔºö</strong></p>
                        <p class="text-xs text-gray-600">‚Ä¢ ÊèíÁÆ° = 1.0 | Èù¢ÁΩ© ‚âà 0.6 | ÈºªÂ∞éÁÆ° ‚âà 0.3 | Ë®≠ÁÇ∫ 0 = ÁÑ°ÈúÄÊ±Ç</p>
                        <hr class="border-amber-200 my-2">
                        <p class="text-xs text-amber-600">
                            <strong>v1.2.8:</strong> ÂàÜÈ†ÖÁ∑®ËºØËá™ÂãïÂêåÊ≠• + Êú™Ê™¢Êü•ÁÅ∞È°Ø + Ê™¢Êü•Ê≠∑Âè≤Ë®òÈåÑ
                        </p>
                    </div>
                </div>
            </div>

            <!-- Êï¥È´îÁãÄÊÖã - Á∞°ÊΩîÂ§ßÊï∏Â≠ó -->
            <div class="mb-6" x-show="resilienceStatus.summary">
                <div class="p-4 rounded-lg border-2"
                     :class="{
                         'bg-red-50 border-red-300': resilienceStatus.summary?.overall_status === 'CRITICAL',
                         'bg-yellow-50 border-yellow-300': resilienceStatus.summary?.overall_status === 'WARNING',
                         'bg-green-50 border-green-300': resilienceStatus.summary?.overall_status === 'SAFE',
                         'bg-gray-50 border-gray-300': !resilienceStatus.summary?.overall_status
                     }">
                    <div class="flex flex-col sm:flex-row items-center gap-4">
                        <!-- Â§ßÊï∏Â≠ó -->
                        <div class="text-center sm:text-left">
                            <div class="text-xs text-gray-500 uppercase tracking-wide">ÂèØÁç®Á´ãÈÅã‰Ωú</div>
                            <div class="text-4xl sm:text-5xl font-bold"
                                 :class="{
                                     'text-red-600': resilienceStatus.summary?.overall_status === 'CRITICAL',
                                     'text-yellow-600': resilienceStatus.summary?.overall_status === 'WARNING',
                                     'text-green-600': resilienceStatus.summary?.overall_status === 'SAFE'
                                 }">
                                <span x-text="resilienceStatus.summary?.weakest_link?.hours?.toFixed(1) || '‚Äî'"></span>
                                <span class="text-xl font-normal text-gray-500">Â∞èÊôÇ</span>
                            </div>
                        </div>
                        <!-- ÁãÄÊÖã -->
                        <div class="text-center sm:text-right">
                            <span class="w-3 h-3 rounded-full inline-block mr-1"
                                  :class="{
                                      'bg-red-500': resilienceStatus.summary?.overall_status === 'CRITICAL',
                                      'bg-yellow-500': resilienceStatus.summary?.overall_status === 'WARNING',
                                      'bg-green-500': resilienceStatus.summary?.overall_status === 'SAFE'
                                  }"></span>
                            <span class="text-sm font-medium"
                                  :class="{
                                      'text-red-700': resilienceStatus.summary?.overall_status === 'CRITICAL',
                                      'text-yellow-700': resilienceStatus.summary?.overall_status === 'WARNING',
                                      'text-green-700': resilienceStatus.summary?.overall_status === 'SAFE'
                                  }">
                                <span x-show="resilienceStatus.summary?.overall_status === 'CRITICAL'">ÁÑ°Ê≥ïÊíêÈÅéÁõÆÊ®ô</span>
                                <span x-show="resilienceStatus.summary?.overall_status === 'WARNING'">ÂãâÂº∑ÈÅîÊ®ô</span>
                                <span x-show="resilienceStatus.summary?.overall_status === 'SAFE'">ÂÖÖË∂≥</span>
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Á∂≠ÁîüË≥áÊ∫ê - Á∞°ÊΩîÁâà -->
            <!-- v1.2.7: ÁîüÂëΩÁ∑ö (amber/gray Áµ±‰∏ÄËâ≤Á≥ª) -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <!-- ÈõªÂäõÂçÄ -->
                <div class="border border-gray-200 rounded-xl p-4 bg-white">
                    <div class="flex items-center gap-3 mb-3">
                        <div class="p-2 rounded-lg bg-amber-100">
                            <svg class="w-6 h-6 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                            </svg>
                        </div>
                        <div class="flex-1">
                            <div class="text-sm font-medium text-gray-500">ÈõªÂäõ‰æõÊáâ</div>
                            <div class="text-2xl font-bold text-gray-800">
                                <span x-text="getPowerHours()"></span>
                                <span class="text-sm font-normal text-gray-400">h</span>
                                <span class="text-xs font-normal text-gray-400" x-text="'(' + (getPowerHours() / 24).toFixed(1) + 'Â§©)'"></span>
                            </div>
                        </div>
                        <!-- ÁãÄÊÖãÂúñÁ§∫ -->
                        <div class="flex-shrink-0">
                            <template x-if="getPowerStatus() === 'CRITICAL'">
                                <svg class="w-6 h-6 text-amber-600" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                                </svg>
                            </template>
                            <template x-if="getPowerStatus() === 'WARNING'">
                                <svg class="w-6 h-6 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                                </svg>
                            </template>
                            <template x-if="getPowerStatus() === 'SAFE'">
                                <svg class="w-6 h-6 text-gray-300" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                                </svg>
                            </template>
                        </div>
                    </div>
                    <!-- ÈõªÂäõÂ≠êÈ†ÖÁõÆ -->
                    <div class="text-xs text-gray-400 space-y-1 border-t border-gray-100 pt-2">
                        <template x-for="lifeline in (resilienceStatus.lifelines || []).filter(l => l.type === 'POWER')" :key="lifeline.item_code">
                            <div class="flex justify-between">
                                <span x-text="lifeline.name"></span>
                                <span class="text-gray-600" x-text="(lifeline.endurance ? lifeline.endurance.effective_hours : 0) + 'h'"></span>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- Ê∞ßÊ∞£ÂçÄ -->
                <div class="border border-gray-200 rounded-xl p-4 bg-white">
                    <div class="flex items-center gap-3 mb-3">
                        <div class="p-2 rounded-lg bg-amber-100">
                            <svg class="w-6 h-6 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"/>
                            </svg>
                        </div>
                        <div class="flex-1">
                            <div class="text-sm font-medium text-gray-500">Ê∞ßÊ∞£‰æõÊáâ</div>
                            <div class="text-2xl font-bold text-gray-800">
                                <span x-text="getOxygenHours()"></span>
                                <span class="text-sm font-normal text-gray-400">h</span>
                                <span class="text-xs font-normal text-gray-400" x-text="'(' + (getOxygenHours() / 24).toFixed(1) + 'Â§©)'"></span>
                            </div>
                        </div>
                        <!-- ÁãÄÊÖãÂúñÁ§∫ -->
                        <div class="flex-shrink-0">
                            <template x-if="getOxygenStatus() === 'CRITICAL'">
                                <svg class="w-6 h-6 text-amber-600" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                                </svg>
                            </template>
                            <template x-if="getOxygenStatus() === 'WARNING'">
                                <svg class="w-6 h-6 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                                </svg>
                            </template>
                            <template x-if="getOxygenStatus() === 'SAFE'">
                                <svg class="w-6 h-6 text-gray-300" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                                </svg>
                            </template>
                        </div>
                    </div>
                    <!-- Ê∞ßÊ∞£Â≠êÈ†ÖÁõÆ -->
                    <div class="text-xs text-gray-400 space-y-1 border-t border-gray-100 pt-2">
                        <template x-for="lifeline in (resilienceStatus.lifelines || []).filter(l => l.type === 'OXYGEN')" :key="lifeline.item_code">
                            <div class="flex justify-between">
                                <span x-text="lifeline.name"></span>
                                <span class="text-gray-600" x-text="(lifeline.endurance && lifeline.endurance.effective_hours === '‚àû') ? '‚àûh' : ((lifeline.endurance && lifeline.endurance.effective_hours) || 0) + 'h'"></span>
                            </div>
                        </template>
                    </div>
                </div>
            </div>

            <!-- ÂèØÁç®Á´ãÈÅã‰Ωú = MIN(ÈõªÂäõ, Ê∞ßÊ∞£) -->
            <div class="mb-6 p-4 rounded-xl border border-amber-200 bg-amber-50">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <svg class="w-8 h-8 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
                        </svg>
                        <div>
                            <div class="text-sm font-medium text-gray-500">ÂèØÁç®Á´ãÈÅã‰Ωú = MIN(ÈõªÂäõ, Ê∞ßÊ∞£)</div>
                            <div class="text-3xl font-bold text-amber-600">
                                <span x-text="resilienceStatus.summary?.weakest_link?.hours?.toFixed(1) || '‚Äî'"></span>
                                <span class="text-lg font-normal text-gray-400">h</span>
                                <span class="text-sm font-normal text-gray-400" x-text="'(' + ((resilienceStatus.summary?.weakest_link?.hours || 0) / 24).toFixed(1) + 'Â§©)'"></span>
                            </div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-xs text-gray-400 mb-1">Áì∂È†∏‰æÜÊ∫ê</div>
                        <span class="px-3 py-1 rounded-full text-sm font-medium bg-gray-100 text-gray-600"
                              x-text="resilienceStatus.summary?.weakest_link?.type === 'POWER' ? 'ÈõªÂäõ' : 'Ê∞ßÊ∞£'"></span>
                    </div>
                </div>
            </div>

            <!-- v1.2.7: ÈüåÊÄßË®≠ÂÇôÊòéÁ¥∞ (amber/gray Áµ±‰∏ÄËâ≤Á≥ª) -->
            <div class="border border-gray-200 rounded-xl bg-white overflow-hidden">
                <div class="bg-gray-50 border-b border-gray-200 px-5 py-3">
                    <h3 class="text-base font-semibold text-gray-700 flex items-center gap-2">
                        <svg class="w-5 h-5 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"/>
                        </svg>
                        ÈüåÊÄßË®≠ÂÇôÊòéÁ¥∞
                    </h3>
                </div>

                <div class="p-4 space-y-3">
                    <!-- Ê∞ßÊ∞£‰æõÊáâÊòéÁ¥∞ -->
                    <template x-for="lifeline in (resilienceStatus.lifelines || []).filter(l => l.type === 'OXYGEN' && l.inventory?.items)" :key="lifeline.item_code + '-' + lifelinesRefreshKey">
                        <div class="border border-gray-100 rounded-lg">
                            <!-- ‰∏ªÈ†ÖÁõÆÂàó -->
                            <div class="flex items-center gap-2 p-3 cursor-pointer hover:bg-gray-50"
                                 @click="expandedLifeline = expandedLifeline === lifeline.item_code ? null : lifeline.item_code">
                                <!-- Â±ïÈñãÁÆ≠È†≠ -->
                                <svg class="w-4 h-4 transition-transform text-gray-400"
                                     :class="{ 'rotate-90': expandedLifeline === lifeline.item_code }"
                                     fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                                </svg>
                                <!-- Ê∞ßÊ∞£ÂúñÁ§∫ -->
                                <svg class="w-5 h-5 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"/>
                                </svg>
                                <span class="font-medium text-gray-700" x-text="lifeline.name"></span>
                                <span class="text-sm text-gray-400" x-text="'(' + (lifeline.inventory?.items?.reduce((sum, i) => sum + i.qty, 0) || 0) + 'ÊîØ)'"></span>
                                <span class="ml-auto font-bold text-amber-600" x-text="(lifeline.endurance ? lifeline.endurance.effective_hours : 0) + 'h'"></span>
                            </div>

                            <!-- Â±ïÈñãÁöÑÂ≠êÈ†ÖÁõÆ (ÂÄãÂà•ÈãºÁì∂) -->
                            <div x-show="expandedLifeline === lifeline.item_code"
                                 x-transition
                                 class="border-t border-gray-100 bg-gray-50 p-3">
                                <template x-for="item in lifeline.inventory?.items || []" :key="item.name">
                                    <div class="mb-3 last:mb-0">
                                        <!-- Ë®≠ÂÇôÈ°ûÂûãÊ®ôÈ°å -->
                                        <div class="flex items-center gap-2 text-sm text-gray-600 font-medium mb-2">
                                            <span x-text="item.name"></span>
                                            <span class="text-gray-400 text-xs" x-text="'[' + item.qty + 'ÊîØ, Âπ≥Âùá ' + (item.avg_level || 100) + '%]'"></span>
                                        </div>
                                        <!-- ÂÄãÂà•ÂñÆ‰Ωç (PER_UNIT Ê®°Âºè) -->
                                        <template x-if="item.tracking_mode === 'PER_UNIT' && item.units">
                                            <div class="space-y-1.5">
                                                <!-- Ê™¢Êü•ÈÄ≤Â∫¶ -->
                                                <div class="flex items-center justify-between text-xs text-gray-500 mb-1">
                                                    <span>Ê™¢Êü•ÈÄ≤Â∫¶</span>
                                                    <span :class="item.units.filter(u => u.checked).length === item.units.length ? 'text-amber-600 font-medium' : 'text-amber-500'">
                                                        <span x-text="item.units.filter(u => u.checked).length"></span>/<span x-text="item.units.length"></span> Â∑≤Ê™¢Êü•
                                                    </span>
                                                </div>
                                                <template x-for="(unit, idx) in item.units" :key="unit.label">
                                                    <div class="flex items-center gap-2 text-xs rounded px-3 py-2 transition-all"
                                                         :class="unit.checked ? 'bg-white border border-gray-100' : 'bg-gray-100 border border-dashed border-gray-300'">
                                                        <!-- Ê™¢Êü•ÁãÄÊÖãÂúñÁ§∫ -->
                                                        <span class="w-4">
                                                            <template x-if="unit.checked">
                                                                <svg class="w-4 h-4 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                                                </svg>
                                                            </template>
                                                            <template x-if="!unit.checked">
                                                                <svg class="w-4 h-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                                                </svg>
                                                            </template>
                                                        </span>
                                                        <!-- Ê®ôÁ±§ -->
                                                        <span class="font-medium w-14" :class="unit.checked ? 'text-gray-600' : 'text-gray-400'" x-text="unit.label"></span>
                                                        <!-- ÂÖÖÂ°´ÈÄ≤Â∫¶Ê¢ù -->
                                                        <div class="flex-1 h-2.5 bg-gray-200 rounded-full overflow-hidden">
                                                            <div class="h-full rounded-full transition-all"
                                                                 :class="unit.checked ? (unit.level >= 30 ? 'bg-amber-400' : 'bg-amber-600') : 'bg-gray-300'"
                                                                 :style="'width: ' + unit.level + '%'"></div>
                                                        </div>
                                                        <!-- ÁôæÂàÜÊØî -->
                                                        <span class="w-10 text-right font-medium" :class="unit.checked ? 'text-gray-700' : 'text-gray-400'" x-text="unit.level + '%'"></span>
                                                        <!-- ÂÆπÈáè -->
                                                        <span class="w-14 text-right text-gray-400" x-text="(unit.capacity ? unit.capacity.toLocaleString() : '0') + 'L'"></span>
                                                        <!-- ÁãÄÊÖãÊ®ôÁ±§ -->
                                                        <span class="px-2 py-0.5 text-xs rounded"
                                                              :class="unit.checked ? 'bg-gray-100 text-gray-600' : 'bg-gray-200 text-gray-400'"
                                                              x-text="unit.status === 'AVAILABLE' ? 'ÂÇôÁî®' : unit.status === 'IN_USE' ? '‰ΩøÁî®‰∏≠' : unit.status === 'EMPTY' ? 'Á©∫Áì∂' : 'Á∂≠Ë≠∑'"></span>
                                                        <!-- Á∑®ËºØ/Ê™¢Êü•ÊåâÈàï -->
                                                        <button @click.stop="openUnitEditModal(item, unit, idx)"
                                                                class="p-1 rounded"
                                                                :class="unit.checked ? 'text-gray-400 hover:text-amber-600 hover:bg-amber-50' : 'text-amber-500 hover:text-amber-700 bg-amber-50'"
                                                                :title="unit.checked ? 'Á∑®ËºØ' : 'ÈªûÊìäÊ™¢Êü•'">
                                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/>
                                                            </svg>
                                                        </button>
                                                    </div>
                                                </template>
                                            </div>
                                        </template>
                                        <!-- AGGREGATE Ê®°Âºè (ÁÑ°ÂÄãÂà•ËøΩËπ§) -->
                                        <template x-if="item.tracking_mode !== 'PER_UNIT'">
                                            <div class="text-xs text-gray-400">
                                                Á∏ΩÂÆπÈáè: <span x-text="((item.capacity_each || 0) * (item.qty || 0)).toLocaleString()"></span> L
                                            </div>
                                        </template>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </template>

                    <!-- ÈõªÂäõ‰æõÊáâÊòéÁ¥∞ -->
                    <template x-for="lifeline in (resilienceStatus.lifelines || []).filter(l => l.type === 'POWER')" :key="lifeline.item_code">
                        <div class="border border-gray-100 rounded-lg">
                            <div class="flex items-center gap-2 p-3 cursor-pointer hover:bg-gray-50"
                                 @click="expandedLifeline = expandedLifeline === lifeline.item_code ? null : lifeline.item_code">
                                <svg class="w-4 h-4 transition-transform text-gray-400"
                                     :class="{ 'rotate-90': expandedLifeline === lifeline.item_code }"
                                     fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                                </svg>
                                <svg class="w-5 h-5 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                                </svg>
                                <span class="font-medium text-gray-700" x-text="lifeline.name"></span>
                                <span class="text-sm text-gray-400" x-text="'(' + (lifeline.consumption ? lifeline.consumption.load_display : '-') + ')'"></span>
                                <span class="ml-auto font-bold text-amber-600" x-text="(lifeline.endurance ? lifeline.endurance.effective_hours : 0) + 'h'"></span>
                            </div>
                            <!-- ÈõªÂäõÊòéÁ¥∞ (v1.4.7: ÊîØÊè¥ PER_UNIT) -->
                            <div x-show="expandedLifeline === lifeline.item_code"
                                 x-transition
                                 class="border-t border-gray-100 bg-gray-50 p-3 space-y-3">

                                <!-- ÂÖÖÈõªÊèêÈÜí -->
                                <template x-if="lifeline.charging_warnings?.length > 0">
                                    <div class="bg-orange-50 border border-orange-200 rounded-lg p-2 text-xs text-orange-700">
                                        <div class="flex items-center gap-1 font-medium mb-1">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                            </svg>
                                            ÂÖÖÈõªÊèêÈÜí
                                        </div>
                                        <template x-for="warn in lifeline.charging_warnings" :key="warn">
                                            <p x-text="warn"></p>
                                        </template>
                                    </div>
                                </template>

                                <!-- v1.4.7: PER_UNIT ÂÄãÂà•ÂñÆ‰ΩçÈ°ØÁ§∫ -->
                                <template x-if="lifeline.inventory?.items?.some(i => i.tracking_mode === 'PER_UNIT')">
                                    <div class="space-y-3">
                                        <template x-for="item in lifeline.inventory?.items || []" :key="item.item_code">
                                            <div class="bg-white rounded-lg border border-gray-100 p-3">
                                                <!-- Ë®≠ÂÇôÈ°ûÂûãÊ®ôÈ°å -->
                                                <div class="flex items-center gap-2 text-sm text-gray-600 font-medium mb-2">
                                                    <template x-if="item.device_type === 'POWER_STATION'">
                                                        <svg class="w-4 h-4 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z"/>
                                                        </svg>
                                                    </template>
                                                    <template x-if="item.device_type === 'GENERATOR'">
                                                        <svg class="w-4 h-4 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                                                        </svg>
                                                    </template>
                                                    <span x-text="item.name"></span>
                                                    <span class="text-gray-400 text-xs" x-text="'[' + item.qty + 'Âè∞, Âπ≥Âùá ' + (item.avg_level || 100) + '%]'"></span>
                                                    <span class="ml-auto text-xs text-gray-400" x-text="item.effective_total + ' ' + item.unit"></span>
                                                </div>
                                                <!-- PER_UNIT ÂÄãÂà•ÂñÆ‰Ωç -->
                                                <template x-if="item.tracking_mode === 'PER_UNIT' && item.units">
                                                    <div class="space-y-1.5">
                                                        <!-- Ê™¢Êü•ÈÄ≤Â∫¶ (ËàáÊ∞ßÊ∞£ÈãºÁì∂‰∏ÄËá¥) -->
                                                        <div class="flex items-center justify-between text-xs text-gray-500 mb-1">
                                                            <span>Ê™¢Êü•ÈÄ≤Â∫¶</span>
                                                            <span :class="item.units.filter(u => u.last_check).length === item.units.length ? 'text-amber-600 font-medium' : 'text-amber-500'">
                                                                <span x-text="item.units.filter(u => u.last_check).length"></span>/<span x-text="item.units.length"></span> Â∑≤Ê™¢Êü•
                                                            </span>
                                                        </div>
                                                        <template x-for="(unit, idx) in item.units" :key="unit.label">
                                                            <div class="flex items-center gap-2 text-xs rounded px-3 py-2 transition-all"
                                                                 :class="unit.last_check ? 'bg-white border border-gray-100' : 'bg-gray-100 border border-dashed border-gray-300'">
                                                                <!-- Ê™¢Êü•ÁãÄÊÖãÂúñÁ§∫ (ËàáÊ∞ßÊ∞£ÈãºÁì∂‰∏ÄËá¥) -->
                                                                <span class="w-4">
                                                                    <template x-if="unit.last_check">
                                                                        <svg class="w-4 h-4 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                                                        </svg>
                                                                    </template>
                                                                    <template x-if="!unit.last_check">
                                                                        <svg class="w-4 h-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                                                        </svg>
                                                                    </template>
                                                                </span>
                                                                <!-- Ê®ôÁ±§ -->
                                                                <span class="font-medium w-16" :class="unit.last_check ? 'text-gray-600' : 'text-gray-400'" x-text="unit.label"></span>
                                                                <!-- ÈõªÈáè/Ê≤πÈáèÈÄ≤Â∫¶Ê¢ù (amber/gray Ëâ≤Á≥ª) -->
                                                                <div class="flex-1 h-2.5 bg-gray-200 rounded-full overflow-hidden">
                                                                    <div class="h-full rounded-full transition-all"
                                                                         :class="unit.last_check ? (unit.level >= 60 ? 'bg-amber-500' : unit.level >= 30 ? 'bg-amber-300' : 'bg-gray-400') : 'bg-gray-300'"
                                                                         :style="'width: ' + unit.level + '%'"></div>
                                                                </div>
                                                                <!-- ÁôæÂàÜÊØî -->
                                                                <span class="w-10 text-right font-medium" :class="unit.last_check ? 'text-gray-700' : 'text-gray-400'" x-text="unit.level + '%'"></span>
                                                                <!-- ÂÆπÈáè -->
                                                                <span class="w-16 text-right text-gray-400" x-text="unit.capacity + ' ' + item.unit"></span>
                                                                <!-- ÁãÄÊÖãÊ®ôÁ±§ (amber Ëâ≤Á≥ª) -->
                                                                <span class="px-2 py-0.5 text-xs rounded"
                                                                      :class="{
                                                                          'bg-amber-100 text-amber-700': unit.status === 'IN_USE',
                                                                          'bg-orange-100 text-orange-700': unit.status === 'CHARGING',
                                                                          'bg-gray-100 text-gray-600': unit.status === 'AVAILABLE' || unit.status === 'MAINTENANCE' || unit.status === 'OFFLINE'
                                                                      }"
                                                                      x-text="unit.status === 'AVAILABLE' ? 'ÂæÖÂëΩ' : unit.status === 'IN_USE' ? '‰æõÈõª‰∏≠' : unit.status === 'CHARGING' ? 'ÂÖÖÈõª‰∏≠' : unit.status === 'MAINTENANCE' ? 'Á∂≠Ë≠∑' : 'Èõ¢Á∑ö'"></span>
                                                                <!-- Á∑®ËºØÊåâÈàï -->
                                                                <button @click.stop="openPowerUnitEditModal(item, unit, idx)"
                                                                        class="p-1 rounded"
                                                                        :class="unit.last_check ? 'text-gray-400 hover:text-amber-600 hover:bg-amber-50' : 'text-amber-500 hover:text-amber-700 bg-amber-50'"
                                                                        :title="unit.last_check ? 'Á∑®ËºØ' : 'ÈªûÊìäÊ™¢Êü•'">
                                                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/>
                                                                    </svg>
                                                                </button>
                                                            </div>
                                                        </template>
                                                    </div>
                                                </template>
                                                <!-- AGGREGATE Ê®°Âºè -->
                                                <template x-if="item.tracking_mode !== 'PER_UNIT'">
                                                    <div class="flex items-center gap-2 text-xs text-gray-500">
                                                        <div class="flex-1 h-2 bg-gray-200 rounded-full overflow-hidden">
                                                            <div class="h-full bg-amber-400 rounded-full" :style="'width: ' + (item.avg_level || 100) + '%'"></div>
                                                        </div>
                                                        <span x-text="(item.avg_level || 100) + '%'"></span>
                                                        <span class="text-gray-400">|</span>
                                                        <span x-text="item.effective_total + ' ' + item.unit"></span>
                                                    </div>
                                                </template>
                                            </div>
                                        </template>
                                    </div>
                                </template>

                                <!-- ÂéüÊúâÁ∞°ÊòìÈ°ØÁ§∫ (ÁÑ° items ÊôÇÁöÑÂÇôÊè¥) -->
                                <template x-if="!lifeline.inventory?.items?.length">
                                    <div class="space-y-1.5">
                                        <template x-for="source in lifeline.inventory?.sources || []" :key="source.name">
                                            <div class="flex items-center gap-2 text-xs bg-white border border-gray-100 rounded px-3 py-2">
                                                <span class="flex-1 text-gray-600" x-text="source.name"></span>
                                                <span class="text-gray-400" x-text="source.capacity"></span>
                                                <span class="font-medium text-amber-600" x-text="source.hours + 'h'"></span>
                                            </div>
                                        </template>
                                    </div>
                                </template>

                                <!-- Á∏ΩË®à -->
                                <div class="flex items-center gap-3 text-xs text-gray-500 pt-2 border-t border-gray-200">
                                    <span>ÈõªÊ±†: <span class="font-medium text-gray-700" x-text="(lifeline.endurance ? lifeline.endurance.battery_hours : 0) + 'h'"></span></span>
                                    <span>+ ÁôºÈõªÊ©ü: <span class="font-medium text-gray-700" x-text="(lifeline.endurance ? lifeline.endurance.generator_hours : 0) + 'h'"></span></span>
                                    <span class="ml-auto">= Á∏ΩË®à: <span class="font-bold text-amber-600" x-text="(lifeline.endurance ? lifeline.endurance.effective_hours : 0) + 'h'"></span></span>
                                </div>
                            </div>
                        </div>
                    </template>

                    <div x-show="!resilienceStatus.lifelines?.length" class="text-center text-gray-400 py-8">
                        <p>Â∞öÁÑ°ÈüåÊÄßË®≠ÂÇôË≥áÊñô</p>
                        <p class="text-xs mt-1">Ë´ãÂú®Ë®≠ÂÇôÁÆ°ÁêÜ‰∏≠Êñ∞Â¢ûÊ∞ßÊ∞£Áì∂„ÄÅÁôºÈõªÊ©üÁ≠âÈüåÊÄßË®≠ÂÇô</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Ë°ìÂºè‰∏ªÊ™îÂ∑≤Êï¥ÂêàËá≥„ÄåËôïÁΩÆËÄóÊùêË®òÈåÑ„ÄçÂ∫ïÈÉ®ÔºåÊ≠§Áç®Á´ã Tab Â∑≤ÁßªÈô§ (v2.7.1) -->

        <!-- v1.2.7: ÂñÆ‰ΩçÁ∑®ËºØ Modal -->
        <div x-show="showUnitEditModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" style="display: none;">
            <div @click.away="showUnitEditModal = false" class="bg-white rounded-xl shadow-2xl p-6 max-w-sm w-full mx-4">
                <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                    <svg class="w-5 h-5 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/>
                    </svg>
                    Á∑®ËºØÂñÆ‰ΩçÁãÄÊÖã
                </h3>
                <form @submit.prevent="submitUnitEdit()">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-600 mb-1">ÂñÆ‰Ωç</label>
                        <div class="text-lg font-semibold text-gray-800" x-text="unitEditForm.label"></div>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-600 mb-2">ÂÖÖÂ°´ÁôæÂàÜÊØî</label>
                        <div class="flex items-center gap-3">
                            <input type="range" x-model="unitEditForm.level" min="0" max="100" step="5"
                                   class="flex-1 h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                            <div class="w-16 text-center">
                                <input type="number" x-model.number="unitEditForm.level" min="0" max="100"
                                       class="w-full px-2 py-1 text-center border border-gray-300 rounded text-sm">
                            </div>
                        </div>
                        <!-- Âø´Êç∑ÊåâÈàï -->
                        <div class="flex gap-2 mt-2">
                            <button type="button" @click="unitEditForm.level = 100" class="flex-1 px-2 py-1 text-xs bg-gray-100 hover:bg-gray-200 rounded">100%</button>
                            <button type="button" @click="unitEditForm.level = 75" class="flex-1 px-2 py-1 text-xs bg-gray-100 hover:bg-gray-200 rounded">75%</button>
                            <button type="button" @click="unitEditForm.level = 50" class="flex-1 px-2 py-1 text-xs bg-gray-100 hover:bg-gray-200 rounded">50%</button>
                            <button type="button" @click="unitEditForm.level = 25" class="flex-1 px-2 py-1 text-xs bg-gray-100 hover:bg-gray-200 rounded">25%</button>
                            <button type="button" @click="unitEditForm.level = 0" class="flex-1 px-2 py-1 text-xs bg-gray-100 hover:bg-gray-200 rounded">0%</button>
                        </div>
                    </div>
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-600 mb-2">ÁãÄÊÖã</label>
                        <div class="grid grid-cols-2 gap-2">
                            <button type="button" @click="unitEditForm.status = 'AVAILABLE'"
                                    :class="unitEditForm.status === 'AVAILABLE' ? 'bg-amber-100 border-amber-400 text-amber-700' : 'bg-gray-50 border-gray-200 text-gray-600'"
                                    class="px-3 py-2 text-sm border rounded-lg">ÂÇôÁî®</button>
                            <button type="button" @click="unitEditForm.status = 'IN_USE'"
                                    :class="unitEditForm.status === 'IN_USE' ? 'bg-amber-100 border-amber-400 text-amber-700' : 'bg-gray-50 border-gray-200 text-gray-600'"
                                    class="px-3 py-2 text-sm border rounded-lg">‰ΩøÁî®‰∏≠</button>
                            <button type="button" @click="unitEditForm.status = 'EMPTY'"
                                    :class="unitEditForm.status === 'EMPTY' ? 'bg-amber-100 border-amber-400 text-amber-700' : 'bg-gray-50 border-gray-200 text-gray-600'"
                                    class="px-3 py-2 text-sm border rounded-lg">Á©∫Áì∂</button>
                            <button type="button" @click="unitEditForm.status = 'MAINTENANCE'"
                                    :class="unitEditForm.status === 'MAINTENANCE' ? 'bg-amber-100 border-amber-400 text-amber-700' : 'bg-gray-50 border-gray-200 text-gray-600'"
                                    class="px-3 py-2 text-sm border rounded-lg">Á∂≠Ë≠∑‰∏≠</button>
                        </div>
                    </div>
                    <div class="flex gap-3">
                        <button type="button" @click="showUnitEditModal = false"
                                class="flex-1 px-4 py-2 border border-gray-300 text-gray-600 rounded-lg hover:bg-gray-50">
                            ÂèñÊ∂à
                        </button>
                        <button type="submit"
                                class="flex-1 px-4 py-2 bg-amber-500 text-white rounded-lg hover:bg-amber-600">
                            ÂÑ≤Â≠òÂ∑≤Ê™¢Êü•
                        </button>
                    </div>
                    <!-- v1.2.8: ÈáçÁΩÆÊ™¢Êü•ÁãÄÊÖãÊåâÈàï (ÂÉÖÂ∑≤Ê™¢Êü•È†ÖÁõÆÈ°ØÁ§∫) -->
                    <div x-show="unitEditForm.checked" class="mt-4 pt-4 border-t border-gray-200">
                        <button type="button" @click="resetUnitCheck()"
                                class="w-full px-4 py-2 text-sm text-gray-500 border border-dashed border-gray-300 rounded-lg hover:bg-gray-50 hover:text-gray-700 flex items-center justify-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                            </svg>
                            ÈáçÁΩÆÁÇ∫Êú™Ê™¢Êü•
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- v1.4.7: ÈõªÂäõË®≠ÂÇôÂñÆ‰ΩçÁ∑®ËºØ Modal -->
        <div x-show="showPowerUnitEditModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" style="display: none;">
            <div @click.away="showPowerUnitEditModal = false" class="bg-white rounded-xl shadow-2xl p-6 max-w-sm w-full mx-4">
                <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                    <svg class="w-5 h-5 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                    </svg>
                    Á∑®ËºØÈõªÂäõË®≠ÂÇôÁãÄÊÖã
                </h3>
                <form @submit.prevent="submitPowerUnitEdit()">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-600 mb-1">Ë®≠ÂÇô</label>
                        <div class="text-lg font-semibold text-gray-800" x-text="powerUnitEditForm.label"></div>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-600 mb-2" x-text="powerUnitEditForm.device_type === 'GENERATOR' ? 'Ê≤πÈáèÁôæÂàÜÊØî' : 'ÈõªÈáèÁôæÂàÜÊØî'"></label>
                        <div class="flex items-center gap-3">
                            <input type="range" x-model="powerUnitEditForm.level" min="0" max="100" step="5"
                                   class="flex-1 h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                            <div class="w-16 text-center">
                                <input type="number" x-model.number="powerUnitEditForm.level" min="0" max="100"
                                       class="w-full px-2 py-1 text-center border border-gray-300 rounded text-sm">
                            </div>
                        </div>
                        <!-- Âø´Êç∑ÊåâÈàï -->
                        <div class="flex gap-2 mt-2">
                            <button type="button" @click="powerUnitEditForm.level = 100" class="flex-1 px-2 py-1 text-xs bg-gray-100 hover:bg-gray-200 rounded">100%</button>
                            <button type="button" @click="powerUnitEditForm.level = 75" class="flex-1 px-2 py-1 text-xs bg-gray-100 hover:bg-gray-200 rounded">75%</button>
                            <button type="button" @click="powerUnitEditForm.level = 50" class="flex-1 px-2 py-1 text-xs bg-gray-100 hover:bg-gray-200 rounded">50%</button>
                            <button type="button" @click="powerUnitEditForm.level = 25" class="flex-1 px-2 py-1 text-xs bg-gray-100 hover:bg-gray-200 rounded">25%</button>
                        </div>
                    </div>
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-600 mb-2">ÁãÄÊÖã</label>
                        <div class="grid grid-cols-2 gap-2">
                            <button type="button" @click="powerUnitEditForm.status = 'AVAILABLE'"
                                    :class="powerUnitEditForm.status === 'AVAILABLE' ? 'bg-gray-100 border-gray-400 text-gray-700' : 'bg-gray-50 border-gray-200 text-gray-600'"
                                    class="px-3 py-2 text-sm border rounded-lg">ÂæÖÂëΩ</button>
                            <button type="button" @click="powerUnitEditForm.status = 'IN_USE'"
                                    :class="powerUnitEditForm.status === 'IN_USE' ? 'bg-amber-100 border-amber-400 text-amber-700' : 'bg-gray-50 border-gray-200 text-gray-600'"
                                    class="px-3 py-2 text-sm border rounded-lg">‰æõÈõª‰∏≠</button>
                            <button type="button" @click="powerUnitEditForm.status = 'CHARGING'"
                                    :class="powerUnitEditForm.status === 'CHARGING' ? 'bg-orange-100 border-orange-400 text-orange-700' : 'bg-gray-50 border-gray-200 text-gray-600'"
                                    class="px-3 py-2 text-sm border rounded-lg">ÂÖÖÈõª‰∏≠</button>
                            <button type="button" @click="powerUnitEditForm.status = 'MAINTENANCE'"
                                    :class="powerUnitEditForm.status === 'MAINTENANCE' ? 'bg-gray-100 border-gray-400 text-gray-700' : 'bg-gray-50 border-gray-200 text-gray-600'"
                                    class="px-3 py-2 text-sm border rounded-lg">Á∂≠Ë≠∑‰∏≠</button>
                        </div>
                        <!-- ÂÖÖÈõª‰∏≠ÊèêÈÜí -->
                        <div x-show="powerUnitEditForm.status === 'CHARGING'" class="mt-3 p-2 bg-orange-50 border border-orange-200 rounded text-xs text-orange-700">
                            <strong>ÊèêÈÜí</strong>ÔºöÂÖÖÈõª‰∏≠ÁöÑË®≠ÂÇôÊúÉË®àÂÖ•Áï∂ÂâçÈõªÈáè„ÄÇË´ãÊñºÂÖÖÈõªÂÆåÊàêÂæåË®òÂæóÊõ¥Êñ∞ÁãÄÊÖã„ÄÇ
                        </div>
                    </div>
                    <div class="flex gap-3">
                        <button type="button" @click="showPowerUnitEditModal = false"
                                class="flex-1 px-4 py-2 border border-gray-300 text-gray-600 rounded-lg hover:bg-gray-50">
                            ÂèñÊ∂à
                        </button>
                        <button type="submit"
                                class="flex-1 px-4 py-2 bg-amber-500 text-white rounded-lg hover:bg-amber-600">
                            ÂÑ≤Â≠ò
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- v1.2.8: Ê™¢Êü•Â†±Ë°® Modal -->
        <div x-show="showCheckReportModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-start justify-center z-50 overflow-y-auto py-4" style="display: none;">
            <div @click.away="showCheckReportModal = false" class="bg-white rounded-xl shadow-2xl p-6 max-w-2xl w-full mx-4 my-4 max-h-[95vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                        <svg class="w-6 h-6 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                        ÊØèÊó•Ê™¢Êü•Â†±Ë°®
                    </h3>
                    <button @click="exportCheckReportCSV()" class="px-3 py-1 bg-amber-500 text-white rounded-lg hover:bg-amber-600 text-sm flex items-center gap-1">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                        ÂåØÂá∫CSV
                    </button>
                </div>

                <!-- Êó•ÊúüÈÅ∏Êìá -->
                <div class="mb-4 flex gap-4">
                    <div class="flex-1">
                        <label class="block text-sm font-medium text-gray-700 mb-1">ÈÅ∏ÊìáÊó•Êúü</label>
                        <input type="date" x-model="checkReportDate" @change="loadCheckReport()"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500">
                    </div>
                    <div class="flex items-end">
                        <button @click="checkReportDate = new Date().toISOString().split('T')[0]; loadCheckReport()"
                                class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200">
                            ‰ªäÊó•
                        </button>
                    </div>
                </div>

                <!-- Â†±Ë°®ÊëòË¶Å -->
                <div class="mb-4 p-4 bg-amber-50 rounded-lg border border-amber-200" x-show="checkReportData?.summary">
                    <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 text-center">
                        <div>
                            <div class="text-2xl font-bold text-amber-600" x-text="checkReportData?.summary?.equipment_count || 0"></div>
                            <div class="text-xs text-gray-500">Ë®≠ÂÇôÊï∏</div>
                        </div>
                        <div>
                            <div class="text-2xl font-bold text-amber-600" x-text="checkReportData?.summary?.unit_count || 0"></div>
                            <div class="text-xs text-gray-500">ÂñÆ‰ΩçÊï∏</div>
                        </div>
                        <div>
                            <div class="text-2xl font-bold text-amber-600" x-text="checkReportData?.summary?.check_count || 0"></div>
                            <div class="text-xs text-gray-500">Ê™¢Êü•Ê¨°Êï∏</div>
                        </div>
                        <div>
                            <div class="text-sm font-medium text-gray-600" x-text="checkReportData?.summary?.first_check?.split(' ')[1]?.substring(0,5) || '-'"></div>
                            <div class="text-xs text-gray-500">È¶ñÊ¨°Ê™¢Êü•</div>
                        </div>
                    </div>
                </div>

                <!-- Ê™¢Êü•Ë®òÈåÑË°® -->
                <div class="overflow-x-auto max-h-72 border border-gray-200 rounded-lg">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50 sticky top-0">
                            <tr>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">ÊôÇÈñì</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Ë®≠ÂÇô/ÂñÆ‰Ωç</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">ËÆäÊõ¥Ââç</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">ËÆäÊõ¥Âæå</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">ÁãÄÊÖã</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            <template x-for="record in checkReportData?.records || []" :key="record.id">
                                <tr class="hover:bg-gray-50">
                                    <td class="px-3 py-2 text-xs text-gray-500" x-text="record.check_time?.split(' ')[1]?.substring(0,5) || '-'"></td>
                                    <td class="px-3 py-2 text-sm">
                                        <span class="font-medium" x-text="record.equipment_name || record.equipment_id"></span>
                                        <span class="text-xs text-gray-400 ml-1" x-text="record.unit_label ? '(' + record.unit_label + ')' : ''"></span>
                                    </td>
                                    <td class="px-3 py-2 text-sm text-gray-500" x-text="record.level_before + '%'"></td>
                                    <td class="px-3 py-2 text-sm font-medium"
                                        :class="record.level_after > record.level_before ? 'text-green-600' : record.level_after < record.level_before ? 'text-amber-600' : 'text-gray-600'"
                                        x-text="record.level_after + '%'"></td>
                                    <td class="px-3 py-2 text-xs">
                                        <span class="px-2 py-0.5 rounded-full bg-gray-100 text-gray-600"
                                              x-text="record.status_after === 'AVAILABLE' ? 'ÂÇôÁî®' : record.status_after === 'IN_USE' ? '‰ΩøÁî®‰∏≠' : record.status_after === 'EMPTY' ? 'Á©∫Áì∂' : 'Á∂≠Ë≠∑'"></span>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                    <div x-show="!checkReportData?.records?.length" class="text-center py-8 text-gray-400">
                        <svg class="w-12 h-12 mx-auto mb-2 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                        <p>Ê≠§Êó•ÊúüÁÑ°Ê™¢Êü•Ë®òÈåÑ</p>
                    </div>
                </div>

                <div class="mt-4 pt-4 border-t border-gray-200">
                    <button @click="showCheckReportModal = false" class="w-full px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">
                        ÈóúÈñâ
                    </button>
                </div>
            </div>
        </div>

        <!-- Êñ∞Â¢ûÁâ©ÂìÅ Modal -->
        <div x-show="showAddItemModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-start justify-center z-50 overflow-y-auto py-4" style="display: none;">
            <div @click.away="showAddItemModal = false" class="bg-white rounded-xl shadow-2xl p-6 max-w-md w-full mx-4 my-4 max-h-[90vh] overflow-y-auto">
                <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                    <svg class="w-6 h-6 text-teal-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                    </svg>
                    Êñ∞Â¢ûÁâ©ÂìÅ
                </h3>
                <form @submit.prevent="submitAddItem()" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Áâ©ÂìÅ‰ª£Á¢º (ÁïôÁ©∫Ëá™ÂãïÁîüÊàê)</label>
                        <input type="text" x-model="addItemForm.code" placeholder="ÁïôÁ©∫Â∞áËá™ÂãïÁîüÊàê" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Áâ©ÂìÅÂêçÁ®± *</label>
                        <input type="text" x-model="addItemForm.name" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ÂàÜÈ°û *</label>
                        <select x-model="addItemForm.category" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500">
                            <option value="ÊâãË°ìËÄóÊùê">ÊâãË°ìËÄóÊùê</option>
                            <option value="ÊÄ•ÊïëÁâ©Ë≥á">ÊÄ•ÊïëÁâ©Ë≥á</option>
                            <option value="Ëó•ÂìÅ">Ëó•ÂìÅ</option>
                            <option value="Èò≤Ë≠∑Áî®ÂìÅ">Èò≤Ë≠∑Áî®ÂìÅ</option>
                            <option value="ÈÜ´ÁôÇË®≠ÂÇô">ÈÜ´ÁôÇË®≠ÂÇô</option>
                            <option value="ÂÖ∂‰ªñ">ÂÖ∂‰ªñ</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ÂñÆ‰Ωç</label>
                        <input type="text" x-model="addItemForm.unit" placeholder="EA" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ÊúÄÂ∞èÂ∫´Â≠ò</label>
                        <input type="number" x-model="addItemForm.minStock" min="0" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500">
                    </div>
                    <div class="flex gap-4">
                        <button type="submit" class="flex-1 bg-teal-600 text-white px-4 py-2 rounded-lg hover:bg-teal-700 transition-colors flex items-center justify-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                            </svg>
                            <span>Á¢∫Ë™çÊñ∞Â¢û</span>
                        </button>
                        <button type="button" @click="showAddItemModal = false" class="flex-1 bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors flex items-center justify-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                            <span>ÂèñÊ∂à</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Á∑®ËºØÁâ©ÂìÅ Modal -->
        <div x-show="showEditItemModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-start justify-center z-50 overflow-y-auto py-4" style="display: none;">
            <div @click.away="showEditItemModal = false" class="bg-white rounded-xl shadow-2xl p-6 max-w-md w-full mx-4 my-4 max-h-[90vh] overflow-y-auto">
                <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                    <svg class="w-6 h-6 text-teal-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                    </svg>
                    Á∑®ËºØÁâ©ÂìÅ
                </h3>
                <form @submit.prevent="submitEditItem()" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Áâ©ÂìÅ‰ª£Á¢º</label>
                        <input type="text" x-model="editItemForm.code" disabled class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-100">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Áâ©ÂìÅÂêçÁ®± *</label>
                        <input type="text" x-model="editItemForm.name" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ÂàÜÈ°û *</label>
                        <select x-model="editItemForm.category" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500">
                            <option value="ÊâãË°ìËÄóÊùê">ÊâãË°ìËÄóÊùê</option>
                            <option value="ÊÄ•ÊïëÁâ©Ë≥á">ÊÄ•ÊïëÁâ©Ë≥á</option>
                            <option value="Ëó•ÂìÅ">Ëó•ÂìÅ</option>
                            <option value="Èò≤Ë≠∑Áî®ÂìÅ">Èò≤Ë≠∑Áî®ÂìÅ</option>
                            <option value="ÈÜ´ÁôÇË®≠ÂÇô">ÈÜ´ÁôÇË®≠ÂÇô</option>
                            <option value="ÂÖ∂‰ªñ">ÂÖ∂‰ªñ</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ÂñÆ‰Ωç</label>
                        <input type="text" x-model="editItemForm.unit" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ÊúÄÂ∞èÂ∫´Â≠ò</label>
                        <input type="number" x-model="editItemForm.minStock" min="0" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500">
                    </div>
                    <div class="flex gap-4">
                        <button type="submit" class="flex-1 bg-teal-600 text-white px-4 py-2 rounded-lg hover:bg-teal-700 transition-colors flex items-center justify-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                            </svg>
                            <span>Á¢∫Ë™çÊõ¥Êñ∞</span>
                        </button>
                        <button type="button" @click="showEditItemModal = false" class="flex-1 bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors flex items-center justify-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                            <span>ÂèñÊ∂à</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Êñ∞Â¢ûË®≠ÂÇô Modal -->
        <div x-show="showAddEquipmentModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 overflow-y-auto py-4" style="display: none;">
            <div @click.away="showAddEquipmentModal = false" class="bg-white rounded-xl shadow-2xl p-6 max-w-md w-full mx-4 max-h-[90vh] overflow-y-auto">
                <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                    <svg class="w-6 h-6 text-equipment-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                    </svg>
                    Êñ∞Â¢ûË®≠ÂÇô
                </h3>
                <form @submit.prevent="submitAddEquipment()" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Ë®≠ÂÇôÂêçÁ®± *</label>
                        <input type="text" x-model="addEquipmentForm.name" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-equipment-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ÂàÜÈ°û *</label>
                        <select x-model="addEquipmentForm.category" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-equipment-500">
                            <option value="ÊâãË°ìÂåÖ">ÊâãË°ìÂåÖ</option>
                            <option value="ÈõªÂäõË®≠ÂÇô">ÈõªÂäõË®≠ÂÇô</option>
                            <option value="Á©∫Ê∞£Ê∑®Âåñ">Á©∫Ê∞£Ê∑®Âåñ</option>
                            <option value="Ê∞¥ËôïÁêÜ">Ê∞¥ËôïÁêÜ</option>
                            <option value="ÂÜ∑ËóèË®≠ÂÇô">ÂÜ∑ËóèË®≠ÂÇô</option>
                            <option value="ÈÄöË®äË®≠ÂÇô">ÈÄöË®äË®≠ÂÇô</option>
                            <option value="ÁÖßÊòéË®≠ÂÇô">ÁÖßÊòéË®≠ÂÇô</option>
                            <option value="ÂÖ∂‰ªñ">ÂÖ∂‰ªñ</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Êï∏Èáè</label>
                        <input type="number" x-model="addEquipmentForm.quantity" min="1" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-equipment-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ÂÇôË®ª</label>
                        <textarea x-model="addEquipmentForm.remarks" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-equipment-500"></textarea>
                    </div>
                    <div class="flex gap-4">
                        <button type="submit" class="flex-1 bg-equipment-500 text-white px-4 py-2 rounded-lg hover:bg-[#5a6155] transition-colors flex items-center justify-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                            </svg>
                            <span>Á¢∫Ë™çÊñ∞Â¢û</span>
                        </button>
                        <button type="button" @click="showAddEquipmentModal = false" class="flex-1 bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors flex items-center justify-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                            <span>ÂèñÊ∂à</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Á∑®ËºØË®≠ÂÇô Modal -->
        <div x-show="showEditEquipmentModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 overflow-y-auto py-4" style="display: none;">
            <div @click.away="showEditEquipmentModal = false" class="bg-white rounded-xl shadow-2xl p-6 max-w-md w-full mx-4 max-h-[90vh] overflow-y-auto">
                <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                    <svg class="w-6 h-6 text-equipment-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                    </svg>
                    Á∑®ËºØË®≠ÂÇô
                </h3>
                <form @submit.prevent="submitEditEquipment()" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Ë®≠ÂÇôID</label>
                        <input type="text" x-model="editEquipmentForm.id" disabled class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-100">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Ë®≠ÂÇôÂêçÁ®± *</label>
                        <input type="text" x-model="editEquipmentForm.name" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-equipment-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ÂàÜÈ°û *</label>
                        <select x-model="editEquipmentForm.category" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-equipment-500">
                            <option value="ÊâãË°ìÂåÖ">ÊâãË°ìÂåÖ</option>
                            <option value="ÈõªÂäõË®≠ÂÇô">ÈõªÂäõË®≠ÂÇô</option>
                            <option value="Á©∫Ê∞£Ê∑®Âåñ">Á©∫Ê∞£Ê∑®Âåñ</option>
                            <option value="Ê∞¥ËôïÁêÜ">Ê∞¥ËôïÁêÜ</option>
                            <option value="ÂÜ∑ËóèË®≠ÂÇô">ÂÜ∑ËóèË®≠ÂÇô</option>
                            <option value="ÈÄöË®äË®≠ÂÇô">ÈÄöË®äË®≠ÂÇô</option>
                            <option value="ÁÖßÊòéË®≠ÂÇô">ÁÖßÊòéË®≠ÂÇô</option>
                            <option value="ÂÖ∂‰ªñ">ÂÖ∂‰ªñ</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Êï∏Èáè</label>
                        <input type="number" x-model="editEquipmentForm.quantity" min="0" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-equipment-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ÂÇôË®ª</label>
                        <textarea x-model="editEquipmentForm.remarks" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-equipment-500"></textarea>
                    </div>
                    <div class="flex gap-4">
                        <button type="submit" class="flex-1 bg-equipment-500 text-white px-4 py-2 rounded-lg hover:bg-[#5a6155] transition-colors flex items-center justify-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                            </svg>
                            <span>Á¢∫Ë™çÊõ¥Êñ∞</span>
                        </button>
                        <button type="button" @click="showEditEquipmentModal = false" class="flex-1 bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors flex items-center justify-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                            <span>ÂèñÊ∂à</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Ë®≠ÂÇôÊ™¢Êü• Modal (v2: Unit-Centric) -->
        <div x-show="showCheckEquipmentModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 overflow-y-auto py-4" style="display: none;">
            <div @click.away="showCheckEquipmentModal = false" class="bg-white rounded-xl shadow-2xl p-6 max-w-md w-full mx-4 max-h-[90vh] overflow-y-auto">
                <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                    <svg class="w-6 h-6 text-equipment-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/>
                    </svg>
                    Ë®≠ÂÇôÊ™¢Êü•
                </h3>
                <form @submit.prevent="submitCheckEquipment()" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Ë®≠ÂÇôÂêçÁ®±</label>
                        <input type="text" x-model="checkEquipmentForm.name" disabled class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-100">
                    </div>

                    <!-- v2: ÂñÆ‰ΩçÈÅ∏ÊìáÂô® (Â§öÂñÆ‰ΩçË®≠ÂÇô) -->
                    <div x-show="checkEquipmentForm.units.length > 1">
                        <label class="block text-sm font-medium text-gray-700 mb-2">ÈÅ∏ÊìáÂñÆ‰Ωç *</label>
                        <div class="grid grid-cols-2 gap-2 max-h-32 overflow-y-auto">
                            <template x-for="unit in checkEquipmentForm.units" :key="unit.id">
                                <button type="button"
                                        @click="selectUnit(unit)"
                                        :class="checkEquipmentForm.selectedUnitId === unit.id
                                            ? 'border-equipment-500 bg-equipment-50 ring-2 ring-equipment-500'
                                            : 'border-gray-300 hover:border-gray-400'"
                                        class="p-2 border rounded-lg text-left transition-all">
                                    <div class="font-medium text-sm" x-text="unit.unit_label || unit.unit_serial"></div>
                                    <div class="text-xs text-gray-500 flex justify-between">
                                        <span x-text="unit.level_percent + '%'"></span>
                                        <span :class="{
                                            'text-green-600': unit.status === 'AVAILABLE',
                                            'text-blue-600': unit.status === 'IN_USE',
                                            'text-yellow-600': unit.status === 'CHARGING',
                                            'text-gray-600': unit.status === 'MAINTENANCE'
                                        }" x-text="unit.status"></span>
                                    </div>
                                </button>
                            </template>
                        </div>
                    </div>

                    <!-- ÂñÆ‰ΩçË≥áË®ä (ÂñÆ‰∏ÄÂñÆ‰ΩçË®≠ÂÇô) -->
                    <div x-show="checkEquipmentForm.units.length === 1" class="text-sm text-gray-600 bg-gray-50 p-2 rounded">
                        <span x-text="checkEquipmentForm.units[0]?.unit_label || 'ÂñÆ‰∏ÄË®≠ÂÇô'"></span>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ÁãÄÊÖã *</label>
                        <select x-model="checkEquipmentForm.status" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-equipment-500">
                            <!-- v2: ÂãïÊÖãÁãÄÊÖãÈÅ∏È†Ö -->
                            <template x-for="opt in checkEquipmentForm.statusOptions" :key="opt">
                                <option :value="opt" x-text="opt"></option>
                            </template>
                            <!-- fallback -->
                            <template x-if="!checkEquipmentForm.statusOptions.length">
                                <option value="AVAILABLE">ÂèØÁî® (AVAILABLE)</option>
                            </template>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2"
                               x-text="getEquipmentMetricLabel(checkEquipmentForm.id)"></label>
                        <input type="number" x-model="checkEquipmentForm.powerLevel" min="0" max="100" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-equipment-500">
                        <!-- ÈüåÊÄßÂΩ±ÈüøÊèêÁ§∫ -->
                        <p class="text-xs text-amber-600 mt-1" x-show="checkEquipmentForm.powerLevel && isResilienceEquipment(checkEquipmentForm.id)">
                            <span x-text="'‚âà ' + calculateEquipmentHours(checkEquipmentForm.id, checkEquipmentForm.powerLevel) + ' Â∞èÊôÇÈüåÊÄßË≤¢Áçª'"></span>
                        </p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ÂÇôË®ª</label>
                        <textarea x-model="checkEquipmentForm.remarks" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-equipment-500"></textarea>
                    </div>
                    <div class="flex gap-4">
                        <button type="submit" class="flex-1 bg-equipment-500 text-white px-4 py-2 rounded-lg hover:bg-[#5a6155] transition-colors flex items-center justify-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                            </svg>
                            <span>Á¢∫Ë™çÊ™¢Êü•</span>
                        </button>
                        <button type="button" @click="showCheckEquipmentModal = false" class="flex-1 bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors flex items-center justify-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                            <span>ÂèñÊ∂à</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- v2.1: Ë®≠ÂÇôÂñÆ‰ΩçÁÆ°ÁêÜ Modal -->
        <div x-show="showUnitManageModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-start justify-center z-50 overflow-y-auto py-4" style="display: none;">
            <div @click.away="showUnitManageModal = false" class="bg-white rounded-xl shadow-2xl p-4 sm:p-5 md:p-6 max-w-2xl w-full mx-4 my-4 max-h-[95vh] overflow-y-auto">
                <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                    <svg class="w-6 h-6 text-equipment-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
                    </svg>
                    <span>ÂñÆ‰ΩçÁÆ°ÁêÜ - </span>
                    <span x-text="unitManageForm.equipment_name"></span>
                </h3>

                <!-- ËºâÂÖ•‰∏≠ -->
                <div x-show="unitManageForm.loading" class="text-center py-8">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-equipment-500 mx-auto"></div>
                    <p class="text-gray-500 mt-2">ËºâÂÖ•‰∏≠...</p>
                </div>

                <div x-show="!unitManageForm.loading" class="space-y-4">
                    <!-- Âø´ÈÄüÊï∏ÈáèË™øÊï¥ -->
                    <div class="bg-equipment-50 border border-equipment-200 rounded-lg p-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Âø´ÈÄüÊï∏ÈáèË™øÊï¥</label>
                        <div class="flex items-center gap-3">
                            <button type="button" @click="unitManageForm.targetQuantity = Math.max(0, unitManageForm.targetQuantity - 1)"
                                    class="w-10 h-10 rounded-full bg-gray-200 hover:bg-gray-300 flex items-center justify-center text-xl font-bold">
                                ‚àí
                            </button>
                            <input type="number" x-model="unitManageForm.targetQuantity" min="0"
                                   class="w-20 text-center text-xl font-bold border-2 border-equipment-300 rounded-lg py-2">
                            <button type="button" @click="unitManageForm.targetQuantity++"
                                    class="w-10 h-10 rounded-full bg-gray-200 hover:bg-gray-300 flex items-center justify-center text-xl font-bold">
                                +
                            </button>
                            <button type="button" @click="batchAdjustQuantity()"
                                    :disabled="unitManageForm.targetQuantity === unitManageForm.units.length"
                                    :class="unitManageForm.targetQuantity === unitManageForm.units.length ? 'bg-gray-300 cursor-not-allowed' : 'bg-equipment-500 hover:bg-equipment-600'"
                                    class="px-4 py-2 text-white rounded-lg transition-colors">
                                Â•óÁî®
                            </button>
                        </div>
                        <p class="text-xs text-gray-500 mt-2">
                            ÁõÆÂâç: <span x-text="unitManageForm.units.length"></span> ÂÄãÂñÆ‰Ωç
                            <span x-show="unitManageForm.targetQuantity !== unitManageForm.units.length" class="text-equipment-600 font-medium">
                                ‚Üí <span x-text="unitManageForm.targetQuantity"></span>
                            </span>
                        </p>
                    </div>

                    <!-- ÁèæÊúâÂñÆ‰ΩçÂàóË°® -->
                    <div>
                        <h4 class="font-medium text-gray-700 mb-2">ÁèæÊúâÂñÆ‰Ωç (<span x-text="unitManageForm.units.length"></span>)</h4>
                        <div class="space-y-2 max-h-48 overflow-y-auto">
                            <template x-for="unit in unitManageForm.units" :key="unit.id">
                                <div class="flex items-center justify-between bg-gray-50 rounded-lg p-3 border">
                                    <div class="flex items-center gap-3">
                                        <span class="font-medium" x-text="unit.unit_label || unit.unit_serial"></span>
                                        <span class="text-sm text-gray-500" x-text="unit.level_percent + '%'"></span>
                                        <span class="text-xs px-2 py-1 rounded-full" :class="getStatusBadgeClass(unit.status)" x-text="unit.status"></span>
                                    </div>
                                    <button type="button" @click="removeUnit(unit)"
                                            class="text-red-500 hover:text-red-700 p-1" title="ÁßªÈô§">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                        </svg>
                                    </button>
                                </div>
                            </template>
                            <div x-show="unitManageForm.units.length === 0" class="text-center text-gray-400 py-4">
                                ÁõÆÂâçÊ≤íÊúâÂèØÁî®ÂñÆ‰Ωç
                            </div>
                        </div>
                    </div>

                    <!-- ÁßªÈô§ÂéüÂõ† -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ÁßªÈô§ÂéüÂõ†ÔºàÂèØÈÅ∏Ôºâ</label>
                        <input type="text" x-model="unitManageForm.removeReason" placeholder="‰æãÂ¶ÇÔºöË®≠ÂÇôÊïÖÈöú„ÄÅÈÄÅ‰øÆ"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                    </div>

                    <!-- Êñ∞Â¢ûÂñÆ‰Ωç -->
                    <div class="border-t pt-4">
                        <h4 class="font-medium text-gray-700 mb-2">Êñ∞Â¢ûÂñÆ‰Ωç</h4>
                        <div class="grid grid-cols-3 gap-3">
                            <div>
                                <label class="block text-xs text-gray-500 mb-1">ÈõªÈáè %</label>
                                <input type="number" x-model="unitManageForm.addForm.level_percent" min="0" max="100"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                            </div>
                            <div>
                                <label class="block text-xs text-gray-500 mb-1">ÁãÄÊÖã</label>
                                <select x-model="unitManageForm.addForm.status"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                    <option value="AVAILABLE">ÂèØÁî®</option>
                                    <option value="IN_USE">‰ΩøÁî®‰∏≠</option>
                                    <option value="CHARGING">ÂÖÖÈõª‰∏≠</option>
                                    <option value="MAINTENANCE">Á∂≠Ë≠∑‰∏≠</option>
                                </select>
                            </div>
                            <div class="flex items-end">
                                <button type="button" @click="addUnit()"
                                        class="w-full bg-equipment-500 text-white px-4 py-2 rounded-lg hover:bg-[#5a6155] transition-colors text-sm">
                                    + Êñ∞Â¢û
                                </button>
                            </div>
                        </div>
                        <div class="mt-2">
                            <label class="block text-xs text-gray-500 mb-1">Êñ∞Â¢ûÂéüÂõ†ÔºàÂèØÈÅ∏Ôºâ</label>
                            <input type="text" x-model="unitManageForm.addForm.reason" placeholder="‰æãÂ¶ÇÔºöÊºîÁøíÂ¢ûÊè¥"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                        </div>
                    </div>

                    <!-- Â∑≤ÁßªÈô§ÂñÆ‰Ωç -->
                    <div class="border-t pt-4">
                        <button type="button" @click="unitManageForm.showInactive = !unitManageForm.showInactive"
                                class="flex items-center gap-2 text-gray-600 hover:text-gray-800">
                            <svg class="w-4 h-4 transition-transform" :class="unitManageForm.showInactive ? 'rotate-90' : ''" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                            </svg>
                            <span class="text-sm font-medium">Â∑≤ÁßªÈô§ÂñÆ‰Ωç (<span x-text="unitManageForm.inactive_units.length"></span>)</span>
                        </button>
                        <div x-show="unitManageForm.showInactive" x-collapse class="mt-2 space-y-2 max-h-32 overflow-y-auto">
                            <template x-for="unit in unitManageForm.inactive_units" :key="unit.id">
                                <div class="flex items-center justify-between bg-red-50 rounded-lg p-3 border border-red-200">
                                    <div>
                                        <span class="font-medium text-gray-600 line-through" x-text="unit.unit_label || unit.unit_serial"></span>
                                        <span class="text-xs text-red-500 ml-2" x-text="unit.removal_reason || 'Â∑≤ÁßªÈô§'"></span>
                                    </div>
                                    <button type="button" @click="restoreUnit(unit)"
                                            class="text-green-600 hover:text-green-800 px-3 py-1 text-sm bg-green-100 rounded-lg">
                                        ÊÅ¢Âæ©
                                    </button>
                                </div>
                            </template>
                            <div x-show="unitManageForm.inactive_units.length === 0" class="text-center text-gray-400 py-2 text-sm">
                                Ê≤íÊúâÂ∑≤ÁßªÈô§ÁöÑÂñÆ‰Ωç
                            </div>
                        </div>
                    </div>

                    <!-- ÈóúÈñâÊåâÈàï -->
                    <div class="flex justify-end pt-4 border-t">
                        <button type="button" @click="showUnitManageModal = false"
                                class="bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-600 transition-colors">
                            ÈóúÈñâ
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Ëó•Â±ÄÊí•Áôº Modal (MIRS v2.4) -->
        <div x-show="showDispatchModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-start justify-center z-50 overflow-y-auto py-4" style="display: none;">
            <div @click.away="showDispatchModal = false" class="bg-white rounded-xl shadow-2xl p-4 sm:p-5 md:p-6 max-w-3xl w-full mx-4 my-4 max-h-[95vh] overflow-y-auto">
                <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                    <svg class="w-6 h-6 text-treatment-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"/>
                    </svg>
                    Êí•ÁôºËó•ÂìÅÁµ¶Ëó•Â±Ä
                </h3>

                <form @submit.prevent="createDispatch()" class="space-y-4">
                    <!-- ÁõÆÊ®ôËó•Â±ÄË≥áË®ä -->
                    <div class="bg-treatment-50 rounded-lg p-4 border border-treatment-500/30">
                        <h4 class="font-semibold text-gray-800 mb-3">ÁõÆÊ®ôËó•Â±Ä</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Ëó•Â±ÄÁ∑®Ëôü (ÈÅ∏Â°´)</label>
                                <input type="text" x-model="dispatchForm.target_station_id" placeholder="PHR-001"
                                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-treatment-500">
                                <p class="text-xs text-gray-500 mt-1">ÁÆ°Âà∂Ëó•ÂìÅÂøÖÈ†àÊåáÂÆö</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Ëó•Â±ÄÂêçÁ®± (ÈÅ∏Â°´)</label>
                                <input type="text" x-model="dispatchForm.target_station_name" placeholder="Ë°õÁîüÁ´ôËó•Â±Ä"
                                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-treatment-500">
                            </div>
                        </div>
                    </div>

                    <!-- Ëó•ÂìÅÊ∏ÖÂñÆ -->
                    <div class="border-2 border-treatment-500/30 rounded-lg p-4">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="font-semibold text-gray-700 flex items-center gap-2">
                                <svg class="w-5 h-5 text-treatment-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"/>
                                </svg>
                                Êí•ÁôºËó•ÂìÅÊ∏ÖÂñÆ
                            </h4>
                            <button type="button" @click="addDispatchItem()"
                                    class="bg-treatment-500 text-white px-3 py-1 rounded-lg hover:bg-[#3d4270] text-sm flex items-center gap-1">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                                </svg>
                                Êñ∞Â¢ûËó•ÂìÅ
                            </button>
                        </div>

                        <div class="space-y-3">
                            <template x-for="(item, index) in dispatchForm.items" :key="index">
                                <div class="flex gap-2 items-start border border-gray-200 rounded-lg p-3 bg-white">
                                    <div class="flex-1 grid grid-cols-3 gap-2">
                                        <!-- Ëó•ÂìÅÊêúÂ∞ã -->
                                        <div class="relative col-span-2">
                                            <input type="text" x-model="item.searchText"
                                                   @input="filterDispatchItems(index)"
                                                   @focus="item.showDropdown = true"
                                                   @blur="setTimeout(() => item.showDropdown = false, 200)"
                                                   placeholder="ÊêúÂ∞ãËó•ÂìÅ..."
                                                   required
                                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-treatment-500">
                                            <div x-show="item.showDropdown && item.filteredItems && item.filteredItems.length > 0"
                                                 class="absolute z-10 w-full mt-1 bg-white border border-treatment-500/50 rounded-lg shadow-lg max-h-48 overflow-y-auto">
                                                <template x-for="med in item.filteredItems.slice(0, 8)" :key="med.code">
                                                    <div @click.stop="selectDispatchItem(index, med)"
                                                         class="px-3 py-2 hover:bg-treatment-50 cursor-pointer text-sm">
                                                        <span class="font-mono" x-text="med.code"></span> -
                                                        <span x-text="med.name"></span>
                                                        <span class="text-xs text-gray-500" x-text="`(ÂèØÁî®: ${med.current_stock - (med.reserved_qty || 0)})`"></span>
                                                    </div>
                                                </template>
                                            </div>
                                        </div>
                                        <!-- Êï∏Èáè -->
                                        <input type="number" x-model="item.quantity" required min="1" placeholder="Êï∏Èáè"
                                               class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-treatment-500">
                                    </div>
                                    <!-- Âà™Èô§ -->
                                    <button type="button" @click="removeDispatchItem(index)"
                                            x-show="dispatchForm.items.length > 1"
                                            class="text-red-600 hover:text-red-800 p-2">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                        </svg>
                                    </button>
                                </div>
                            </template>
                        </div>
                    </div>

                    <!-- Êìç‰ΩúÊåâÈàï -->
                    <div class="flex flex-col sm:flex-row gap-3 pt-4 border-t">
                        <button type="submit" class="flex-1 bg-treatment-500 text-white px-4 py-2 rounded-lg hover:bg-[#3d4270] transition-colors flex items-center justify-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z"/>
                            </svg>
                            Âª∫Á´ãÊí•ÁôºÂñÆ + Áî¢Áîü QR
                        </button>
                        <button type="button" @click="showDispatchModal = false; resetDispatchForm()"
                                class="flex-1 bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors flex items-center justify-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                            ÂèñÊ∂à
                        </button>
                    </div>
                </form>

                <!-- Â∑≤Âª∫Á´ãÁöÑÊí•ÁôºÂñÆÂàóË°® -->
                <div x-show="dispatchList.length > 0" class="mt-6 border-t pt-4">
                    <h4 class="font-semibold text-gray-700 mb-3">ÊúÄËøëÊí•ÁôºÂñÆ</h4>
                    <div class="space-y-2 max-h-48 overflow-y-auto">
                        <template x-for="dispatch in dispatchList" :key="dispatch.dispatch_id">
                            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg border">
                                <div>
                                    <span class="font-mono text-sm" x-text="dispatch.dispatch_id"></span>
                                    <span class="ml-2 px-2 py-0.5 text-xs rounded-full"
                                          :class="{
                                              'bg-gray-200 text-gray-700': dispatch.status === 'DRAFT',
                                              'bg-yellow-100 text-yellow-800': dispatch.status === 'RESERVED',
                                              'bg-blue-100 text-blue-800': dispatch.status === 'DISPATCHED',
                                              'bg-green-100 text-green-800': dispatch.status === 'RECEIVED',
                                              'bg-red-100 text-red-800': dispatch.status === 'CANCELLED'
                                          }"
                                          x-text="dispatch.status"></span>
                                    <span class="text-xs text-gray-500 ml-2" x-text="dispatch.target_station_name || 'Êú™ÊåáÂÆö'"></span>
                                </div>
                                <div class="flex gap-2">
                                    <button @click="showDispatchQR(dispatch)"
                                            x-show="dispatch.status === 'RESERVED' || dispatch.status === 'DISPATCHED'"
                                            class="text-treatment-500 hover:text-[#3d4270] text-sm">
                                        QR
                                    </button>
                                    <button @click="confirmDispatch(dispatch.dispatch_id)"
                                            x-show="dispatch.status === 'RESERVED'"
                                            class="text-green-600 hover:text-green-800 text-sm">
                                        Á¢∫Ë™ç
                                    </button>
                                    <button @click="cancelDispatch(dispatch.dispatch_id)"
                                            x-show="dispatch.status === 'DRAFT' || dispatch.status === 'RESERVED'"
                                            class="text-red-600 hover:text-red-800 text-sm">
                                        ÂèñÊ∂à
                                    </button>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
        </div>

        <!-- Êí•Áôº QR Code È°ØÁ§∫ Modal -->
        <div x-show="showDispatchQRModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" style="display: none;">
            <div @click.away="showDispatchQRModal = false" class="bg-white rounded-xl shadow-2xl p-6 max-w-md w-full mx-4">
                <h3 class="text-lg font-bold text-gray-800 mb-4 text-center">ÊéÉÊèèÊ≠§ QR Code</h3>

                <div class="flex justify-center mb-4">
                    <div class="p-4 bg-white border-4 border-treatment-500 rounded-lg">
                        <!-- È°ØÁ§∫ QR Code ÊàñËºâÂÖ•‰∏≠ -->
                        <template x-if="dispatchQRData.qr_codes[dispatchQRData.current_index]?.data_url">
                            <img :src="dispatchQRData.qr_codes[dispatchQRData.current_index]?.data_url"
                                 alt="Dispatch QR Code" class="w-48 h-48">
                        </template>
                        <template x-if="!dispatchQRData.qr_codes[dispatchQRData.current_index]?.data_url">
                            <div class="w-48 h-48 flex items-center justify-center text-gray-400 bg-gray-100 rounded">
                                <span x-show="dispatchQRData.qr_codes.length === 0">ËºâÂÖ•‰∏≠...</span>
                                <span x-show="dispatchQRData.qr_codes.length > 0">QR ÁîüÊàêÂ§±Êïó</span>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- Â§öÁâáËº™Êí≠ÊéßÂà∂ -->
                <div x-show="dispatchQRData.qr_codes.length > 1" class="flex justify-center items-center gap-4 mb-4">
                    <button @click="dispatchQRData.current_index = Math.max(0, dispatchQRData.current_index - 1)"
                            :disabled="dispatchQRData.current_index === 0"
                            class="px-3 py-1 bg-gray-200 rounded-lg disabled:opacity-50">
                        ‚óÄ ‰∏ä‰∏ÄÁâá
                    </button>
                    <span class="text-sm text-gray-600"
                          x-text="`${dispatchQRData.current_index + 1} / ${dispatchQRData.qr_codes.length}`"></span>
                    <button @click="dispatchQRData.current_index = Math.min(dispatchQRData.qr_codes.length - 1, dispatchQRData.current_index + 1)"
                            :disabled="dispatchQRData.current_index >= dispatchQRData.qr_codes.length - 1"
                            class="px-3 py-1 bg-gray-200 rounded-lg disabled:opacity-50">
                        ‰∏ã‰∏ÄÁâá ‚ñ∂
                    </button>
                </div>

                <div class="text-center text-sm text-gray-600 mb-4 space-y-1">
                    <p>Êí•ÁôºÂñÆ: <span class="font-mono" x-text="dispatchQRData.dispatch_id"></span></p>
                    <p class="text-xs text-gray-400">
                        ‰º∫ÊúçÂô®: <span class="font-mono" x-text="getDisplayServerUrl()"></span>
                    </p>
                    <p x-show="isLocalhostAccess()" class="text-xs text-amber-600 mt-1">
                        ‚ö†Ô∏è ÊâãÊ©üË´ãÊîπÁî®ÈõªËÖ¶ IP Â≠òÂèñ MIRS
                    </p>
                </div>

                <div class="flex gap-3">
                    <button @click="confirmDispatch(dispatchQRData.dispatch_id)"
                            class="flex-1 bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">
                        Á¢∫Ë™çÈÄÅÂá∫
                    </button>
                    <button @click="showDispatchQRModal = false"
                            class="flex-1 bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600">
                        ÈóúÈñâ
                    </button>
                </div>
            </div>
        </div>

        <!-- Êñ∞Â¢ûËôïÁΩÆËÄóÊùêË®òÈåÑ Modal -->
        <div x-show="showAddSurgeryModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-start justify-center z-50 overflow-y-auto py-4" style="display: none;">
            <div @click.away="showAddSurgeryModal = false" class="bg-white rounded-xl shadow-2xl p-4 sm:p-5 md:p-6 max-w-2xl w-full mx-4 my-4 max-h-[95vh] overflow-y-auto">
                <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                    <svg class="w-6 h-6 text-treatment-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                    </svg>
                    Êñ∞Â¢ûËôïÁΩÆËÄóÊùêË®òÈåÑ
                </h3>
                <form @submit.prevent="submitAddSurgery()" class="space-y-4">
                    <!-- Âü∫Êú¨Ë≥áË®ä -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ÁóÖÊÇ£ÂßìÂêç *</label>
                            <input type="text" x-model="addSurgeryForm.patientName" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-treatment-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Ê™¢ÂÇ∑Á∑®Ëôü (Triage Tag ID)</label>
                            <input type="text" x-model="addSurgeryForm.triageTagId" placeholder="‰æãÂ¶Ç: RED-001" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-treatment-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">‰∏ªÂàÄÈÜ´Â∏´ *</label>
                            <input type="text" x-model="addSurgeryForm.surgeonName" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-treatment-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">È∫ªÈÜâÊñπÂºè</label>
                            <input type="text" x-model="addSurgeryForm.anesthesiaType" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-treatment-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ËôïÁΩÆÊôÇÈï∑ (ÂàÜÈêò)</label>
                            <input type="number" x-model="addSurgeryForm.durationMinutes" min="0" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-treatment-500">
                        </div>
                    </div>

                    <!-- Ë°ìÂºè‰ª£Á¢º Queue (v2.7.4) -->
                    <div class="border-2 border-treatment-300 rounded-lg p-4 bg-treatment-50">
                        <h4 class="text-lg font-semibold text-treatment-700 flex items-center gap-2 mb-3">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                            </svg>
                            Ë°ìÂºè‰ª£Á¢º
                            <span class="text-xs text-gray-500 font-normal">(ÂèØÂ§öÈÅ∏ÔºåËá™ÂãïË®àÁÆóÈÅûÊ∏õÈªûÊï∏)</span>
                        </h4>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-3">
                            <div>
                                <input type="text" x-model="addSurgeryForm.surgerySearchText" @input.debounce.300ms="searchFormSurgery()"
                                       placeholder="ÊêúÂ∞ãË°ìÂºè..." class="w-full px-3 py-2 border border-treatment-300 rounded text-sm mb-2">
                                <div class="max-h-32 overflow-y-auto space-y-1">
                                    <template x-for="code in formSurgerySearchResults" :key="code.code">
                                        <button type="button" @click="addToFormSurgeryQueue(code)"
                                                class="w-full text-left px-2 py-1 text-sm bg-white rounded border border-treatment-200 hover:bg-treatment-100">
                                            <span class="font-mono text-xs" x-text="code.code"></span>
                                            <span x-text="code.name_zh"></span>
                                            <span class="float-right text-treatment-600" x-text="code.points?.toLocaleString() + 'Èªû'"></span>
                                        </button>
                                    </template>
                                </div>
                            </div>
                            <div class="bg-white rounded p-2 min-h-[80px]">
                                <div class="space-y-1 mb-2">
                                    <template x-for="(item, idx) in addSurgeryForm.surgeryQueue" :key="item.code">
                                        <div class="flex justify-between items-center px-2 py-1 rounded text-sm"
                                             :class="item.reduction_rate === 1 ? 'bg-green-100' : (item.reduction_rate === 0.5 ? 'bg-yellow-100' : 'bg-red-100')">
                                            <div class="flex-1 truncate">
                                                <span class="text-xs" x-text="item.name_zh"></span>
                                                <span class="text-xs text-gray-500" x-text="'(' + Math.round(item.reduction_rate * 100) + '%)'"></span>
                                            </div>
                                            <div class="flex items-center gap-1">
                                                <span class="text-xs" x-text="(item.final_points || 0).toLocaleString() + 'Èªû'"></span>
                                                <button type="button" @click="removeFromFormSurgeryQueue(idx)" class="text-red-500 text-xs">‚úï</button>
                                            </div>
                                        </div>
                                    </template>
                                </div>
                                <div x-show="addSurgeryForm.surgeryQueue.length === 0" class="text-center text-gray-400 text-sm py-2">
                                    ÊêúÂ∞ã‰∏¶ÈªûÊìäÂä†ÂÖ•Ë°ìÂºè
                                </div>
                                <div x-show="addSurgeryForm.surgeryQueue.length > 0" class="text-right text-sm font-bold text-treatment-700 border-t pt-1">
                                    Á∏ΩË®à: <span x-text="getFormSurgeryTotal().toLocaleString()"></span> Èªû
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Ëá™Ë≤ªÈ†ÖÁõÆ Queue (v2.7.4) -->
                    <div class="border-2 border-green-300 rounded-lg p-4 bg-green-50">
                        <h4 class="text-lg font-semibold text-green-700 flex items-center gap-2 mb-3">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            Ëá™Ë≤ªÈ†ÖÁõÆ
                            <span class="text-xs text-gray-500 font-normal">(ÂèØÂ§öÈÅ∏ÔºåÈªûÊìäÂä†ÂÖ•)</span>
                        </h4>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-3">
                            <div>
                                <input type="text" x-model="addSurgeryForm.selfPayFormSearchText" @input.debounce.300ms="searchFormSelfPay()"
                                       placeholder="ÊêúÂ∞ãËá™Ë≤ªÈ†ÖÁõÆ..." class="w-full px-3 py-2 border border-green-300 rounded text-sm mb-2">
                                <div class="max-h-32 overflow-y-auto space-y-1">
                                    <template x-for="item in formSelfPaySearchResults" :key="item.item_id">
                                        <button type="button" @click="addToFormSelfPayQueue(item)"
                                                class="w-full text-left px-2 py-1 text-sm bg-white rounded border border-green-200 hover:bg-green-100">
                                            <span x-text="item.name"></span>
                                            <span class="float-right text-green-600" x-text="'$' + item.unit_price?.toLocaleString()"></span>
                                        </button>
                                    </template>
                                </div>
                            </div>
                            <div class="bg-white rounded p-2 min-h-[80px]">
                                <div class="space-y-1 mb-2">
                                    <template x-for="(item, idx) in addSurgeryForm.selfPayQueue" :key="item.item_id">
                                        <div class="flex justify-between items-center px-2 py-1 bg-green-50 rounded text-sm">
                                            <span class="truncate flex-1 mr-2" x-text="item.name"></span>
                                            <div class="flex items-center gap-1">
                                                <button type="button" @click="updateFormSelfPayQty(idx, -1)" class="w-5 h-5 text-xs bg-gray-200 rounded">‚àí</button>
                                                <span class="w-6 text-center" x-text="item.quantity"></span>
                                                <button type="button" @click="updateFormSelfPayQty(idx, 1)" class="w-5 h-5 text-xs bg-gray-200 rounded">+</button>
                                                <span class="text-green-600 w-16 text-right text-xs" x-text="'$' + (item.unit_price * item.quantity).toLocaleString()"></span>
                                                <button type="button" @click="removeFromFormSelfPayQueue(idx)" class="text-red-500 text-xs ml-1">‚úï</button>
                                            </div>
                                        </div>
                                    </template>
                                </div>
                                <div x-show="addSurgeryForm.selfPayQueue.length === 0" class="text-center text-gray-400 text-sm py-2">
                                    ÊêúÂ∞ã‰∏¶ÈªûÊìäÂä†ÂÖ•Ëá™Ë≤ªÈ†ÖÁõÆ
                                </div>
                                <div x-show="addSurgeryForm.selfPayQueue.length > 0" class="text-right text-sm font-bold text-green-700 border-t pt-1">
                                    Á∏ΩË®à: $<span x-text="getFormSelfPayTotal().toLocaleString()"></span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ÂÇôË®ª -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            ËôïÁΩÆÂÇôË®ª
                            <span class="text-xs text-gray-500 font-normal">(ÂèØË®òÈåÑÊ™¢ÂÇ∑Á∑®Ëôü„ÄÅÂÇ∑Âã¢ÁãÄÊ≥ÅÁ≠âË≥áË®ä)</span>
                        </label>
                        <textarea x-model="addSurgeryForm.remarks" rows="3" placeholder="‰æãÂ¶Ç: Ê™¢ÂÇ∑Á∑®Ëôü RED-001, Âè≥ËÖøÈñãÊîæÊÄßÈ™®Êäò..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-treatment-500"></textarea>
                    </div>

                    <!-- ËÄóÊùêÊ∏ÖÂñÆ -->
                    <div class="border-2 border-gray-200 rounded-lg p-4">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="text-lg font-semibold text-gray-700 flex items-center gap-2">
                                <svg class="w-5 h-5 text-treatment-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"/>
                                </svg>
                                ‰ΩøÁî®ËÄóÊùê
                            </h4>
                            <button type="button" @click="addConsumptionItem()" class="bg-treatment-500 text-white px-3 py-1 rounded-lg hover:bg-[#3d4270] text-sm flex items-center gap-1">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                                </svg>
                                Êñ∞Â¢ûËÄóÊùê
                            </button>
                        </div>

                        <div class="space-y-3">
                            <template x-for="(item, index) in addSurgeryForm.consumptions" :key="index">
                                <div class="flex gap-2 items-start border border-gray-200 rounded-lg p-3">
                                    <div class="flex-1 grid grid-cols-3 gap-2">
                                        <div class="relative">
                                            <input
                                                type="text"
                                                x-model="item.searchText"
                                                @input="filterConsumptionItems(index)"
                                                @focus="filterConsumptionItems(index); item.showDropdown = true"
                                                @blur="setTimeout(() => item.showDropdown = false, 200)"
                                                placeholder="ÊêúÂ∞ãËÄóÊùê..."
                                                required
                                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-treatment-500"
                                            >
                                            <div x-show="item.showDropdown && item.filteredItems && item.filteredItems.length > 0"
                                                 class="absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-48 overflow-y-auto">
                                                <template x-for="availableItem in item.filteredItems.slice(0, 8)" :key="availableItem.code">
                                                    <div @click.stop="selectConsumptionItem(index, availableItem)"
                                                         class="px-3 py-2 hover:bg-treatment-50 cursor-pointer text-sm">
                                                        <span class="font-mono" x-text="availableItem.code"></span> -
                                                        <span x-text="availableItem.name"></span>
                                                        <span class="text-xs text-gray-500" x-text="`(Â∫´Â≠ò: ${availableItem.current_stock})`"></span>
                                                    </div>
                                                </template>
                                            </div>
                                        </div>
                                        <input type="number" x-model="item.quantity" required min="1" placeholder="Êï∏Èáè" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-treatment-500">
                                        <input type="text" x-model="item.unit" readonly placeholder="ÂñÆ‰Ωç" class="px-3 py-2 border border-gray-300 rounded-lg bg-gray-50">
                                    </div>
                                    <button type="button" @click="removeConsumptionItem(index)" class="text-red-600 hover:text-red-800 p-2">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                        </svg>
                                    </button>
                                </div>
                            </template>
                        </div>

                        <div x-show="addSurgeryForm.consumptions.length === 0" class="text-center text-gray-400 py-4">
                            Â∞öÊú™Êñ∞Â¢ûËÄóÊùê
                        </div>
                    </div>

                    <!-- Ë°ì‰∏≠Áî®Ëó• -->
                    <div class="border-2 border-dispense-purple-500 rounded-lg p-4 bg-dispense-purple-50">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="text-lg font-semibold text-gray-700 flex items-center gap-2">
                                <svg class="w-5 h-5 text-dispense-purple-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"/>
                                </svg>
                                Ë°ì‰∏≠Áî®Ëó•
                                <span class="text-xs text-gray-500 font-normal">(Â±ÄÈÉ®Ê≥®Â∞ÑËó•Áâ©)</span>
                            </h4>
                            <button type="button" @click="addIntraopMed()" class="bg-dispense-purple-700 text-white px-3 py-1 rounded-lg hover:bg-dispense-purple-900 text-sm flex items-center gap-1">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                                </svg>
                                Êñ∞Â¢ûËó•Áâ©
                            </button>
                        </div>

                        <!-- Â∏∏Áî®Ë°ì‰∏≠Áî®Ëó•Âø´ÈÅ∏ -->
                        <div class="flex flex-wrap gap-2 mb-3">
                            <button type="button" @click="addQuickIntraopMed('Morphine', '10', 'mg')" class="px-2 py-1 text-xs bg-dispense-purple-50 text-dispense-purple-700 rounded border border-dispense-purple-500 hover:bg-dispense-purple-500 hover:text-white">Morphine</button>
                            <button type="button" @click="addQuickIntraopMed('Ketorolac', '30', 'mg')" class="px-2 py-1 text-xs bg-dispense-purple-50 text-dispense-purple-700 rounded border border-dispense-purple-500 hover:bg-dispense-purple-500 hover:text-white">Ketorolac</button>
                            <button type="button" @click="addQuickIntraopMed('Triamcinolone', '40', 'mg')" class="px-2 py-1 text-xs bg-dispense-purple-50 text-dispense-purple-700 rounded border border-dispense-purple-500 hover:bg-dispense-purple-500 hover:text-white">Triamcinolone</button>
                            <button type="button" @click="addQuickIntraopMed('Xylocaine 2%', '10', 'ml')" class="px-2 py-1 text-xs bg-dispense-purple-50 text-dispense-purple-700 rounded border border-dispense-purple-500 hover:bg-dispense-purple-500 hover:text-white">Xylocaine</button>
                            <button type="button" @click="addQuickIntraopMed('Marcaine 0.5%', '10', 'ml')" class="px-2 py-1 text-xs bg-dispense-purple-50 text-dispense-purple-700 rounded border border-dispense-purple-500 hover:bg-dispense-purple-500 hover:text-white">Marcaine</button>
                        </div>

                        <div class="space-y-3">
                            <template x-for="(med, index) in addSurgeryForm.intraopMeds" :key="index">
                                <div class="flex gap-2 items-center border border-dispense-purple-500 rounded-lg p-3 bg-white">
                                    <div class="flex-1 grid grid-cols-3 gap-2">
                                        <input type="text" x-model="med.name" required placeholder="Ëó•Áâ©ÂêçÁ®±"
                                               class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-dispense-purple-700">
                                        <input type="text" x-model="med.dose" required placeholder="ÂäëÈáè"
                                               class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-dispense-purple-700">
                                        <input type="text" x-model="med.unit" required placeholder="ÂñÆ‰Ωç"
                                               class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-dispense-purple-700">
                                    </div>
                                    <button type="button" @click="removeIntraopMed(index)" class="text-red-600 hover:text-red-800 p-2">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                        </svg>
                                    </button>
                                </div>
                            </template>
                        </div>

                        <div x-show="addSurgeryForm.intraopMeds.length === 0" class="text-center text-gray-400 py-4">
                            Â∞öÊú™Êñ∞Â¢ûË°ì‰∏≠Áî®Ëó•
                        </div>
                    </div>

                    <div class="flex gap-4 pt-4">
                        <button type="submit" class="flex-1 bg-treatment-500 text-white px-4 py-2 rounded-lg hover:bg-[#3d4270] transition-colors flex items-center justify-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                            </svg>
                            Á¢∫Ë™çÂª∫Á´ã
                        </button>
                        <button type="button" @click="showAddSurgeryModal = false; resetAddSurgeryForm()" class="flex-1 bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors flex items-center justify-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                            ÂèñÊ∂à
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- ËôïÁΩÆË©≥ÊÉÖ Modal -->
        <div x-show="showSurgeryDetailModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-start justify-center z-50 overflow-y-auto py-4" style="display: none;">
            <div @click.away="showSurgeryDetailModal = false" class="bg-white rounded-xl shadow-2xl p-6 max-w-2xl w-full mx-4 my-4 max-h-[95vh] overflow-y-auto">
                <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                    <svg class="w-6 h-6 text-treatment-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                    </svg>
                    ËôïÁΩÆËÄóÊùêË®òÈåÑË©≥ÊÉÖ
                </h3>

                <template x-if="selectedSurgery">
                    <div class="space-y-4">
                        <!-- Âü∫Êú¨Ë≥áË®ä -->
                        <div class="grid grid-cols-2 gap-4 bg-gray-50 p-4 rounded-lg">
                            <div>
                                <p class="text-sm text-gray-600">Ë®òÈåÑÁ∑®Ëôü</p>
                                <p class="font-semibold" x-text="selectedSurgery.record_number"></p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Êó•Êúü</p>
                                <p class="font-semibold" x-text="selectedSurgery.record_date"></p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">ÁóÖÊÇ£ÂßìÂêç</p>
                                <p class="font-semibold" x-text="selectedSurgery.patient_name"></p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Áï∂Êó•Á¨¨ N Âè∞</p>
                                <p class="font-semibold" x-text="selectedSurgery.surgery_sequence"></p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">ËôïÁΩÆÈ°ûÂûã</p>
                                <p class="font-semibold" x-text="selectedSurgery.surgery_type"></p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">‰∏ªÂàÄÈÜ´Â∏´</p>
                                <p class="font-semibold" x-text="selectedSurgery.surgeon_name"></p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">È∫ªÈÜâÊñπÂºè</p>
                                <p class="font-semibold" x-text="selectedSurgery.anesthesia_type || '-'"></p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">ËôïÁΩÆÊôÇÈï∑</p>
                                <p class="font-semibold" x-text="selectedSurgery.duration_minutes ? selectedSurgery.duration_minutes + ' ÂàÜÈêò' : '-'"></p>
                            </div>
                        </div>

                        <!-- ÂÇôË®ª -->
                        <div x-show="selectedSurgery.remarks" class="bg-yellow-50 p-4 rounded-lg">
                            <p class="text-sm text-gray-600 mb-1">ÂÇôË®ª</p>
                            <p class="text-gray-800" x-text="selectedSurgery.remarks"></p>
                        </div>

                        <!-- ËÄóÊùêÊ∏ÖÂñÆ -->
                        <div class="border-2 border-gray-200 rounded-lg p-4">
                            <h4 class="text-lg font-semibold text-gray-700 mb-3 flex items-center gap-2">
                                <svg class="w-5 h-5 text-treatment-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"/>
                                </svg>
                                ‰ΩøÁî®ËÄóÊùê
                            </h4>
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">‰ª£Á¢º</th>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">ÂêçÁ®±</th>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Êï∏Èáè</th>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">ÂñÆ‰Ωç</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white divide-y divide-gray-200">
                                        <template x-for="consumption in selectedSurgery.consumptions" :key="consumption.item_code">
                                            <tr>
                                                <td class="px-4 py-2 text-sm font-mono" x-text="consumption.item_code"></td>
                                                <td class="px-4 py-2 text-sm" x-text="consumption.item_name"></td>
                                                <td class="px-4 py-2 text-sm font-semibold" x-text="consumption.quantity"></td>
                                                <td class="px-4 py-2 text-sm" x-text="consumption.unit"></td>
                                            </tr>
                                        </template>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <div class="pt-4">
                            <button type="button" @click="showSurgeryDetailModal = false" class="w-full bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors">
                                ÈóúÈñâ
                            </button>
                        </div>
                    </div>
                </template>
            </div>
        </div>

        <!-- ÈÄ≤Ë≤®Ë®òÈåÑ Modal -->
        <div x-show="showReceiveHistoryModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-start justify-center z-50 overflow-y-auto py-4" style="display: none;">
            <div @click.away="showReceiveHistoryModal = false" class="bg-white rounded-xl shadow-2xl p-3 sm:p-4 md:p-6 max-w-6xl w-full mx-4 my-4 max-h-[95vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                        <svg class="w-6 h-6 text-teal-custom-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"/>
                        </svg>
                        ÈÄ≤Ë≤®Ë®òÈåÑ
                    </h3>
                    <button @click="exportReceiveHistoryCSV()" class="bg-teal-custom-500 text-white px-4 py-2 rounded-lg hover:bg-teal-custom-600 transition-colors text-sm flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                        ÂåØÂá∫CSV
                    </button>
                </div>

                <!-- ÁØ©ÈÅ∏Ê¢ù‰ª∂ -->
                <div class="mb-4 grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ÈñãÂßãÊó•Êúü</label>
                        <input type="date" x-model="receiveHistorySearch.startDate" @change="loadReceiveHistory()" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-custom-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ÁµêÊùüÊó•Êúü</label>
                        <input type="date" x-model="receiveHistorySearch.endDate" @change="loadReceiveHistory()" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-custom-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Áâ©ÂìÅ‰ª£Á¢º</label>
                        <input type="text" x-model="receiveHistorySearch.itemCode" @input="loadReceiveHistory()" placeholder="ÊêúÂ∞ãÁâ©ÂìÅ..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-custom-500">
                    </div>
                </div>

                <div class="overflow-x-auto max-h-96">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50 sticky top-0">
                            <tr>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">ÊôÇÈñì</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Áâ©ÂìÅ‰ª£Á¢º</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Áâ©ÂìÅÂêçÁ®±</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Êï∏Èáè</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">ÊâπËôü</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">ÊïàÊúü</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">ÂÇôË®ª</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            <template x-for="event in receiveHistory" :key="event.id">
                                <tr class="hover:bg-gray-50">
                                    <td class="px-4 py-2 text-sm" x-text="new Date(event.timestamp).toLocaleString('zh-TW')"></td>
                                    <td class="px-4 py-2 text-sm font-mono" x-text="event.item_code"></td>
                                    <td class="px-4 py-2 text-sm" x-text="event.item_name"></td>
                                    <td class="px-4 py-2 text-sm font-semibold text-green-600" x-text="'+' + event.quantity + ' ' + event.unit"></td>
                                    <td class="px-4 py-2 text-sm" x-text="event.batch_number || '-'"></td>
                                    <td class="px-4 py-2 text-sm" x-text="event.expiry_date || '-'"></td>
                                    <td class="px-4 py-2 text-sm text-gray-600" x-text="event.remarks || '-'"></td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>

                <div class="pt-4">
                    <button type="button" @click="showReceiveHistoryModal = false" class="w-full bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors">
                        ÈóúÈñâ
                    </button>
                </div>
            </div>
        </div>

        <!-- Ê∂àËÄóË®òÈåÑ Modal -->
        <div x-show="showConsumeHistoryModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-start justify-center z-50 overflow-y-auto py-4" style="display: none;">
            <div @click.away="showConsumeHistoryModal = false" class="bg-white rounded-xl shadow-2xl p-3 sm:p-4 md:p-6 max-w-6xl w-full mx-4 my-4 max-h-[95vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                        <svg class="w-6 h-6 text-treatment-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                        </svg>
                        Ê∂àËÄóË®òÈåÑ
                    </h3>
                    <button @click="exportConsumeHistoryCSV()" class="bg-teal-custom-500 text-white px-4 py-2 rounded-lg hover:bg-teal-custom-600 transition-colors text-sm flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                        ÂåØÂá∫CSV
                    </button>
                </div>

                <!-- ÁØ©ÈÅ∏Ê¢ù‰ª∂ -->
                <div class="mb-4 grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ÈñãÂßãÊó•Êúü</label>
                        <input type="date" x-model="consumeHistorySearch.startDate" @change="loadConsumeHistory()" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-treatment-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ÁµêÊùüÊó•Êúü</label>
                        <input type="date" x-model="consumeHistorySearch.endDate" @change="loadConsumeHistory()" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-treatment-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Áâ©ÂìÅ‰ª£Á¢º</label>
                        <input type="text" x-model="consumeHistorySearch.itemCode" @input="loadConsumeHistory()" placeholder="ÊêúÂ∞ãÁâ©ÂìÅ..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-treatment-500">
                    </div>
                </div>

                <div class="overflow-x-auto max-h-96">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50 sticky top-0">
                            <tr>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">ÊôÇÈñì</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Áâ©ÂìÅ‰ª£Á¢º</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Áâ©ÂìÅÂêçÁ®±</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Êï∏Èáè</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Áî®ÈÄî</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Êìç‰Ωú</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            <template x-for="event in consumeHistory" :key="event.id">
                                <tr class="hover:bg-gray-50">
                                    <td class="px-4 py-2 text-sm" x-text="new Date(event.timestamp).toLocaleString('zh-TW')"></td>
                                    <td class="px-4 py-2 text-sm font-mono" x-text="event.item_code"></td>
                                    <td class="px-4 py-2 text-sm" x-text="event.item_name"></td>
                                    <td class="px-4 py-2 text-sm font-semibold text-red-600" x-text="'-' + event.quantity + ' ' + event.unit"></td>
                                    <td class="px-4 py-2 text-sm text-gray-600" x-text="event.remarks || '-'"></td>
                                    <td class="px-4 py-2 text-sm">
                                        <button @click="viewConsumeDetail(event)" class="text-blue-600 hover:text-blue-800">Ë©≥ÊÉÖ</button>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>

                <div class="pt-4">
                    <button type="button" @click="showConsumeHistoryModal = false" class="w-full bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors">
                        ÈóúÈñâ
                    </button>
                </div>
            </div>
        </div>

        <!-- Ê∂àËÄóË©≥ÊÉÖ Modal -->
        <div x-show="showConsumeDetailModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-start justify-center z-50 overflow-y-auto py-4" style="display: none;">
            <div @click.away="showConsumeDetailModal = false" class="bg-white rounded-xl shadow-2xl p-6 max-w-md w-full mx-4 my-4 max-h-[90vh] overflow-y-auto">
                <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                    <svg class="w-6 h-6 text-treatment-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                    Ê∂àËÄóË©≥ÊÉÖ
                </h3>

                <template x-if="selectedConsumeEvent">
                    <div class="space-y-3">
                        <div class="grid grid-cols-2 gap-4 bg-gray-50 p-4 rounded-lg">
                            <div>
                                <p class="text-sm text-gray-600">ÊôÇÈñì</p>
                                <p class="font-semibold" x-text="new Date(selectedConsumeEvent.timestamp).toLocaleString('zh-TW')"></p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Áâ©ÂìÅ‰ª£Á¢º</p>
                                <p class="font-semibold font-mono" x-text="selectedConsumeEvent.item_code"></p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Áâ©ÂìÅÂêçÁ®±</p>
                                <p class="font-semibold" x-text="selectedConsumeEvent.item_name"></p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Ê∂àËÄóÊï∏Èáè</p>
                                <p class="font-semibold text-red-600" x-text="selectedConsumeEvent.quantity + ' ' + selectedConsumeEvent.unit"></p>
                            </div>
                            <div class="col-span-2">
                                <p class="text-sm text-gray-600">Áî®ÈÄîË™™Êòé</p>
                                <p class="font-semibold" x-text="selectedConsumeEvent.remarks || '-'"></p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Êìç‰ΩúÂì°</p>
                                <p class="font-semibold" x-text="selectedConsumeEvent.operator"></p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Á´ôÈªû</p>
                                <p class="font-semibold" x-text="selectedConsumeEvent.station_id"></p>
                            </div>
                        </div>
                    </div>
                </template>

                <div class="pt-4">
                    <button type="button" @click="showConsumeDetailModal = false" class="w-full bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors">
                        ÈóúÈñâ
                    </button>
                </div>
            </div>
        </div>

        <!-- Ë°ÄÂ∫´Ê≠∑Âè≤Ë®òÈåÑ Modal -->
        <div x-show="showBloodHistoryModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-start justify-center z-50 overflow-y-auto py-4" style="display: none;">
            <div @click.away="showBloodHistoryModal = false" class="bg-white rounded-xl shadow-2xl p-3 sm:p-4 md:p-6 max-w-6xl w-full mx-4 my-4 max-h-[95vh] overflow-y-auto">
                <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                    <svg class="w-6 h-6 text-blood-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                    Ë°ÄÂ∫´Ê≠∑Âè≤Ë®òÈåÑ
                </h3>

                <!-- ÁØ©ÈÅ∏Ê¢ù‰ª∂ -->
                <div class="mb-4 grid grid-cols-1 md:grid-cols-4 gap-3">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ÈñãÂßãÊó•Êúü</label>
                        <input type="date" x-model="bloodHistorySearch.startDate" @change="loadBloodHistory()"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blood-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ÁµêÊùüÊó•Êúü</label>
                        <input type="date" x-model="bloodHistorySearch.endDate" @change="loadBloodHistory()"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blood-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Ë°ÄÂûã</label>
                        <select x-model="bloodHistorySearch.bloodType" @change="loadBloodHistory()"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blood-500 focus:border-transparent">
                            <option value="">ÂÖ®ÈÉ®Ë°ÄÂûã</option>
                            <option value="A+">A+</option>
                            <option value="A-">A-</option>
                            <option value="B+">B+</option>
                            <option value="B-">B-</option>
                            <option value="O+">O+</option>
                            <option value="O-">O-</option>
                            <option value="AB+">AB+</option>
                            <option value="AB-">AB-</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">È°ûÂûã</label>
                        <select x-model="bloodHistorySearch.eventType" @change="loadBloodHistory()"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blood-500 focus:border-transparent">
                            <option value="">ÂÖ®ÈÉ®</option>
                            <option value="RECEIVE">ÂÖ•Â∫´</option>
                            <option value="CONSUME">Âá∫Â∫´</option>
                        </select>
                    </div>
                </div>

                <!-- Ê≠∑Âè≤Ë®òÈåÑË°®Ê†º -->
                <div class="overflow-x-auto max-h-96">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50 sticky top-0">
                            <tr>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">ÊôÇÈñì</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">È°ûÂûã</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Ë°ÄÂûã</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Êï∏Èáè</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">‰æÜÊ∫ê/Áî®ÈÄî</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Êìç‰ΩúÂì°</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Êìç‰Ωú</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            <template x-for="record in bloodHistory" :key="record.id">
                                <tr class="hover:bg-gray-50">
                                    <td class="px-4 py-2 text-sm" x-text="new Date(record.timestamp).toLocaleString('zh-TW')"></td>
                                    <td class="px-4 py-2 text-sm">
                                        <span :class="record.event_type === 'RECEIVE' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'"
                                              class="px-2 py-1 rounded-full text-xs font-medium"
                                              x-text="record.event_type === 'RECEIVE' ? 'ÂÖ•Â∫´' : 'Âá∫Â∫´'"></span>
                                    </td>
                                    <td class="px-4 py-2 text-sm font-semibold" x-text="record.blood_type"></td>
                                    <td class="px-4 py-2 text-sm font-bold" x-text="record.quantity + ' U'"></td>
                                    <td class="px-4 py-2 text-sm text-gray-600" x-text="record.remarks || '-'"></td>
                                    <td class="px-4 py-2 text-sm" x-text="record.operator"></td>
                                    <td class="px-4 py-2 text-sm">
                                        <div class="flex gap-2 items-center">
                                            <button @click="printBloodLabelFromHistory(record)"
                                                    class="text-claude-red-500 hover:text-claude-red-600 font-medium flex items-center gap-1"
                                                    title="ÂàóÂç∞Ê®ôÁ±§">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"/>
                                                </svg>
                                                <span>ÂàóÂç∞</span>
                                            </button>
                                            <button @click="viewBloodDetail(record)" class="text-blood-500 hover:text-blood-600 font-medium">Ë©≥ÊÉÖ</button>
                                        </div>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>

                    <div x-show="!bloodHistory || bloodHistory.length === 0" class="text-center py-8 text-gray-400">
                        ÁÑ°Á¨¶ÂêàÊ¢ù‰ª∂ÁöÑË®òÈåÑ
                    </div>
                </div>

                <div class="mt-4 flex justify-between items-center">
                    <button @click="exportBloodHistoryCSV()" class="bg-teal-custom-500 text-white px-4 py-2 rounded-lg hover:bg-teal-custom-600 transition-colors flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                        ÂåØÂá∫ CSV
                    </button>
                    <button type="button" @click="showBloodHistoryModal = false" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors">
                        ÈóúÈñâ
                    </button>
                </div>
            </div>
        </div>

        <!-- Â∫´Â≠òÁõ§ÈªûÊ†∏Â∞çË®òÈåÑ Modal -->
        <div x-show="showInventoryCheckHistoryModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-start justify-center z-50 overflow-y-auto py-4" style="display: none;">
            <div @click.away="showInventoryCheckHistoryModal = false" class="bg-white rounded-xl shadow-2xl p-3 sm:p-4 md:p-6 max-w-6xl w-full mx-4 my-4 max-h-[95vh] overflow-y-auto">
                <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                    <svg class="w-6 h-6 text-cyan-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/>
                    </svg>
                    Â∫´Â≠òÁõ§ÈªûÊ†∏Â∞çË®òÈåÑ
                </h3>

                <!-- Áµ±Ë®àÊëòË¶Å -->
                <div class="mb-4 grid grid-cols-2 md:grid-cols-4 gap-3">
                    <div class="bg-gray-100 rounded-xl p-4 text-center">
                        <div class="text-2xl font-bold text-gray-800" x-text="inventoryCheckStats.totalChecks || 0"></div>
                        <div class="text-sm text-gray-500">Á∏ΩÁõ§ÈªûÊ¨°Êï∏</div>
                    </div>
                    <div class="bg-gray-100 rounded-xl p-4 text-center">
                        <div class="text-2xl font-bold text-teal-custom-600" x-text="inventoryCheckStats.totalConfirmed || 0"></div>
                        <div class="text-sm text-gray-500">Â∑≤Á¢∫Ë™çÈ†ÖÁõÆ</div>
                    </div>
                    <div class="bg-gray-100 rounded-xl p-4 text-center">
                        <div class="text-2xl font-bold text-[#D96754]" x-text="inventoryCheckStats.totalErrors || 0"></div>
                        <div class="text-sm text-gray-500">ÈåØË™§È†ÖÁõÆ</div>
                    </div>
                    <div class="bg-gray-100 rounded-xl p-4 text-center">
                        <div class="text-2xl font-bold text-teal-custom-600" x-text="inventoryCheckStats.pendingErrors || 0"></div>
                        <div class="text-sm text-gray-500">ÂæÖËôïÁêÜ</div>
                    </div>
                </div>

                <!-- ÁØ©ÈÅ∏Ê¢ù‰ª∂ -->
                <div class="mb-4 grid grid-cols-1 md:grid-cols-3 gap-3">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ÈñãÂßãÊó•Êúü</label>
                        <input type="date" x-model="inventoryCheckSearch.startDate" @change="loadInventoryCheckHistory()"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ÁµêÊùüÊó•Êúü</label>
                        <input type="date" x-model="inventoryCheckSearch.endDate" @change="loadInventoryCheckHistory()"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ÁãÄÊÖã</label>
                        <select x-model="inventoryCheckSearch.status" @change="loadInventoryCheckHistory()"
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-cyan-500 focus:border-transparent">
                            <option value="">ÂÖ®ÈÉ®</option>
                            <option value="has_errors">ÊúâÈåØË™§</option>
                            <option value="all_confirmed">ÂÖ®ÈÉ®Á¢∫Ë™ç</option>
                        </select>
                    </div>
                </div>

                <!-- Ê≠∑Âè≤Ë®òÈåÑË°®Ê†º -->
                <div class="overflow-x-auto max-h-96">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50 sticky top-0">
                            <tr>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Áõ§ÈªûÊôÇÈñì</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Áõ§Èªû‰∫∫Âì°</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Á∏ΩÈ†ÖÁõÆ</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Â∑≤Á¢∫Ë™ç</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">ÈåØË™§</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">ÁãÄÊÖã</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Êìç‰Ωú</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            <template x-for="check in inventoryCheckHistory" :key="check.check_id">
                                <tr class="hover:bg-gray-50">
                                    <td class="px-4 py-2 text-sm" x-text="new Date(check.checked_at).toLocaleString('zh-TW')"></td>
                                    <td class="px-4 py-2 text-sm font-medium" x-text="check.checker_name"></td>
                                    <td class="px-4 py-2 text-sm" x-text="check.total_items"></td>
                                    <td class="px-4 py-2 text-sm text-teal-custom-600 font-medium" x-text="check.confirmed_count"></td>
                                    <td class="px-4 py-2 text-sm text-[#D96754] font-medium" x-text="check.error_count"></td>
                                    <td class="px-4 py-2 text-sm">
                                        <span x-show="check.error_count === 0" class="bg-gray-100 text-teal-custom-600 px-2 py-1 rounded-full text-xs font-medium">
                                            ÂÖ®ÈÉ®Á¢∫Ë™ç
                                        </span>
                                        <span x-show="check.error_count > 0 && check.errors_pending === 0" class="bg-gray-100 text-teal-custom-600 px-2 py-1 rounded-full text-xs font-medium">
                                            Â∑≤ËôïÁêÜ
                                        </span>
                                        <span x-show="check.errors_pending > 0" class="bg-gray-100 text-[#D96754] px-2 py-1 rounded-full text-xs font-medium">
                                            ÂæÖËôïÁêÜ (<span x-text="check.errors_pending"></span>)
                                        </span>
                                    </td>
                                    <td class="px-4 py-2 text-sm">
                                        <button @click="viewInventoryCheckDetail(check)" class="text-cyan-600 hover:text-cyan-800 font-medium">
                                            Ë©≥ÊÉÖ
                                        </button>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>

                    <div x-show="!inventoryCheckHistory || inventoryCheckHistory.length === 0" class="text-center py-8 text-gray-400">
                        ÁÑ°Áõ§ÈªûË®òÈåÑ
                    </div>
                </div>

                <div class="mt-4 flex justify-between items-center">
                    <button @click="exportInventoryCheckCSV()" class="bg-teal-custom-500 text-white px-4 py-2 rounded-lg hover:bg-teal-custom-600 transition-colors flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                        ÂåØÂá∫ CSV
                    </button>
                    <button type="button" @click="showInventoryCheckHistoryModal = false" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors">
                        ÈóúÈñâ
                    </button>
                </div>
            </div>
        </div>

        <!-- Áõ§ÈªûÈåØË™§Ë©≥ÊÉÖ Modal -->
        <div x-show="showInventoryCheckDetailModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-start justify-center z-50 overflow-y-auto py-4" style="display: none;">
            <div @click.away="showInventoryCheckDetailModal = false" class="bg-white rounded-xl shadow-2xl p-3 sm:p-4 md:p-6 max-w-2xl w-full mx-4 my-4 max-h-[95vh] overflow-y-auto">
                <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                    <svg class="w-6 h-6 text-cyan-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                    </svg>
                    Áõ§ÈªûË©≥ÊÉÖ
                </h3>

                <!-- Áõ§ÈªûÊëòË¶Å -->
                <div class="bg-gray-50 rounded-xl p-4 mb-4" x-show="selectedInventoryCheck">
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div>
                            <span class="text-gray-500">Áõ§Èªû‰∫∫Âì°Ôºö</span>
                            <span class="font-medium" x-text="selectedInventoryCheck?.checker_name"></span>
                        </div>
                        <div>
                            <span class="text-gray-500">Áõ§ÈªûÊôÇÈñìÔºö</span>
                            <span class="font-medium" x-text="selectedInventoryCheck ? new Date(selectedInventoryCheck.checked_at).toLocaleString('zh-TW') : ''"></span>
                        </div>
                        <div>
                            <span class="text-gray-500">Á¢∫Ë™çÈ†ÖÁõÆÔºö</span>
                            <span class="font-medium text-teal-custom-600" x-text="selectedInventoryCheck?.confirmed_count"></span>
                        </div>
                        <div>
                            <span class="text-gray-500">ÈåØË™§È†ÖÁõÆÔºö</span>
                            <span class="font-medium text-[#D96754]" x-text="selectedInventoryCheck?.error_count"></span>
                        </div>
                    </div>
                </div>

                <!-- ÈåØË™§È†ÖÁõÆÂàóË°® -->
                <div x-show="selectedInventoryCheck?.errors?.length > 0">
                    <h4 class="font-semibold text-[#D96754] mb-3 flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                        </svg>
                        ÈåØË™§È†ÖÁõÆ
                    </h4>
                    <div class="space-y-3">
                        <template x-for="error in selectedInventoryCheck?.errors || []" :key="error.item_code">
                            <div class="bg-gray-100 border border-gray-200 rounded-lg p-3">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <div class="font-medium text-[#D96754]" x-text="error.item_name || error.item_code"></div>
                                        <div class="text-xs text-gray-500" x-text="error.item_code"></div>
                                        <div class="text-sm text-gray-600 mt-1" x-text="error.notes"></div>
                                    </div>
                                    <div x-show="!error.resolved">
                                        <button @click="resolveInventoryError(selectedInventoryCheck.check_id, error.item_code)"
                                                class="bg-cyan-600 text-white px-3 py-1 rounded-lg text-sm hover:bg-cyan-700">
                                            ËôïÁêÜ
                                        </button>
                                    </div>
                                    <div x-show="error.resolved" class="text-green-600 text-sm font-medium">
                                        ‚úì Â∑≤ËôïÁêÜ
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>

                <div x-show="!selectedInventoryCheck?.errors?.length" class="text-center py-4 text-gray-400">
                    Ê≠§Ê¨°Áõ§ÈªûÁÑ°ÈåØË™§È†ÖÁõÆ
                </div>

                <div class="mt-4 flex justify-end">
                    <button type="button" @click="showInventoryCheckDetailModal = false" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors">
                        ÈóúÈñâ
                    </button>
                </div>
            </div>
        </div>

        <!-- Toast ÈÄöÁü• -->
        <div x-show="showToast" x-transition class="fixed bottom-4 right-4 z-50" style="display: none;">
            <div :class="{
                'bg-teal-custom-500': toastType === 'success',
                'bg-red-500': toastType === 'error',
                'bg-blue-500': toastType === 'info'
            }" class="text-white px-6 py-3 rounded-lg shadow-lg">
                <p x-text="toastMessage"></p>
            </div>
        </div>

        <!-- Á∑äÊÄ•ÂäüËÉΩÊåâÈàï -->
        <div class="fixed bottom-24 right-4 z-40">
            <button @click="showEmergencyModal = true"
                    class="bg-red-600 hover:bg-red-700 text-white p-4 rounded-full shadow-2xl transition-all duration-300 transform hover:scale-110">
                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                </svg>
            </button>
        </div>

        <!-- Á∑äÊÄ•ÂäüËÉΩÈÅ∏ÂñÆ Modal -->
        <div x-show="showEmergencyModal" class="fixed inset-0 bg-black bg-opacity-60 flex items-start justify-center z-50 overflow-y-auto py-4" style="display: none;">
            <div @click.away="showEmergencyModal = false" class="bg-white rounded-2xl shadow-2xl p-6 max-w-md w-full mx-4 my-4 max-h-[90vh] overflow-y-auto">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-2xl font-bold text-red-600 flex items-center gap-2">
                        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                        </svg>
                        Á∑äÊÄ•ÂäüËÉΩ
                    </h3>
                    <button @click="showEmergencyModal = false" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>

                <p class="text-sm text-gray-600 mb-6">
                    Êà∞ÊôÇÁ∑äÊÄ•Êí§Èõ¢‰ΩøÁî® - Âø´ÈÄü‰øùÂÖ®ÊâÄÊúâË≥áÊñô
                </p>

                <div class="space-y-3">
                    <!-- ÈÅ∏È†Ö1: Êí§Èõ¢ - ‰∏ãËºâÊâÄÊúâË≥áÊñô -->
                    <button @click="emergencyDownloadAll()"
                            class="w-full bg-red-600 hover:bg-red-700 text-white p-4 rounded-xl transition-all duration-200 flex items-center gap-3 shadow-lg">
                        <svg class="w-6 h-6 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                        <div class="text-left flex-1">
                            <p class="font-bold">Êí§Èõ¢ - ‰∏ãËºâÊâÄÊúâË≥áÊñô</p>
                            <p class="text-xs text-red-100">ÂÆåÊï¥ÂÇô‰ªΩÂåÖÔºàZIPÊ™îÊ°àÔºâ</p>
                        </div>
                    </button>

                    <!-- ÈÅ∏È†Ö2: Âø´ÈÄüÂÇô‰ªΩË≥áÊñôÂ∫´ -->
                    <button @click="emergencyQuickBackup()"
                            class="w-full bg-orange-600 hover:bg-orange-700 text-white p-4 rounded-xl transition-all duration-200 flex items-center gap-3 shadow-lg">
                        <svg class="w-6 h-6 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4"/>
                        </svg>
                        <div class="text-left flex-1">
                            <p class="font-bold">Âø´ÈÄüÂÇô‰ªΩË≥áÊñôÂ∫´</p>
                            <p class="text-xs text-orange-100">ÂÉÖ‰∏ãËºâ .db Ê™îÊ°àÔºàÊúÄÂø´Ôºâ</p>
                        </div>
                    </button>

                    <!-- ÈÅ∏È†Ö3: ÂèñÊ∂à -->
                    <button @click="showEmergencyModal = false"
                            class="w-full bg-gray-200 hover:bg-gray-300 text-gray-700 p-4 rounded-xl transition-all duration-200 flex items-center justify-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                        <span class="font-medium">ÂèñÊ∂à</span>
                    </button>
                </div>

                <div class="mt-6 p-3 bg-red-50 rounded-lg border border-red-200">
                    <p class="text-xs text-red-700 flex items-start gap-2">
                        <svg class="w-4 h-4 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        <span><strong>ÊèêÁ§∫Ôºö</strong>Âª∫Ë≠∞‰ΩøÁî®„ÄåÊí§Èõ¢„ÄçÂäüËÉΩ‰∏ãËºâÂÆåÊï¥ÂÇô‰ªΩÂåÖÔºåÂåÖÂê´ÊâÄÊúâË≥áÊñôÂíåË™™ÊòéÊñá‰ª∂„ÄÇ</span>
                    </p>
                </div>
            </div>
        </div>

        <!-- Á∑äÊÄ•È†òÁî®ÂéüÂõ† Modal (MIRS v2.3) -->
        <div x-show="showEmergencyReasonModal" class="fixed inset-0 bg-black bg-opacity-60 flex items-start justify-center z-50 overflow-y-auto py-4" style="display: none;">
            <div @click.away="showEmergencyReasonModal = false" class="bg-white rounded-xl shadow-2xl p-6 max-w-lg w-full mx-4 my-4 max-h-[90vh] overflow-y-auto">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-bold text-dispense-purple-900 flex items-center gap-2">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                        </svg>
                        Á∑äÊÄ•È†òÁî® (Break-the-Glass)
                    </h3>
                    <button @click="showEmergencyReasonModal = false" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>

                <div class="mb-4 p-4 bg-yellow-50 border-l-4 border-yellow-400 rounded">
                    <div class="flex items-start gap-2">
                        <svg class="w-5 h-5 text-yellow-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        <div class="text-sm text-yellow-800">
                            <p class="font-semibold mb-1">ÈáçË¶ÅÊèêÈÜí</p>
                            <ul class="list-disc list-inside space-y-1 text-xs">
                                <li>Á∑äÊÄ•È†òÁî®ÊúÉÁ´ãÂç≥Êâ£Èô§Â∫´Â≠ò</li>
                                <li>‰∏çÈúÄË¶ÅËó•Â∏´ PIN Á¢º</li>
                                <li>ÂøÖÈ†àÂ°´ÂØ´Á∑äÊÄ•ÂéüÂõ† (Ëá≥Â∞ë5ÂÄãÂ≠ó)</li>
                                <li>Ëó•Â∏´Á®çÂæåÊúÉÁ¢∫Ë™çÊ≠§Á≠ÜÈ†òÁî®</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <form @submit.prevent="batchDispenseForm.isEmergency = true; submitBatchDispense()" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <span class="text-red-500">*</span> Á∑äÊÄ•ÂéüÂõ† (5-200Â≠ó)
                        </label>
                        <textarea x-model="batchDispenseForm.emergencyReason"
                                  required
                                  minlength="5"
                                  maxlength="200"
                                  rows="4"
                                  placeholder="‰æãÂ¶ÇÔºöÂ§ßÈáèÂÇ∑ÊÇ£ÊπßÂÖ•ÔºåÈúÄË¶ÅÁ∑äÊÄ•Áâ©Ë≥áÔºåËó•Â∏´‰∏çÂú®ÁèæÂ†¥..."
                                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-dispense-purple-700 resize-none"></textarea>
                        <p class="text-xs text-gray-500 mt-1" x-text="`Â∑≤Ëº∏ÂÖ• ${batchDispenseForm.emergencyReason.length} Â≠ó (ÊúÄÂ∞ë5Â≠óÔºåÊúÄÂ§ö200Â≠ó)`"></p>
                    </div>

                    <div class="flex gap-3">
                        <button type="submit" class="flex-1 bg-dispense-purple-700 text-white px-6 py-3 rounded-lg hover:bg-dispense-purple-900 transition-colors flex items-center justify-center gap-2 font-semibold">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                            </svg>
                            <span>Á¢∫Ë™çÁ∑äÊÄ•È†òÁî®</span>
                        </button>
                        <button type="button" @click="showEmergencyReasonModal = false" class="flex-1 bg-gray-500 text-white px-6 py-3 rounded-lg hover:bg-gray-600 transition-colors flex items-center justify-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                            <span>ÂèñÊ∂à</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Ëó•Â∏´ÂØ©Ê†∏ Modal (MIRS v2.3) -->
        <div x-show="showPharmacistApprovalModal" class="fixed inset-0 bg-black bg-opacity-60 flex items-start justify-center z-50 overflow-y-auto py-4" style="display: none;">
            <div @click.away="showPharmacistApprovalModal = false" class="bg-white rounded-xl shadow-2xl p-6 max-w-lg w-full mx-4 my-4 max-h-[90vh] overflow-y-auto">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-bold text-dispense-purple-900 flex items-center gap-2">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
                        </svg>
                        Ëó•Â∏´ÂØ©Ê†∏Á¢∫Ë™ç
                    </h3>
                    <button @click="showPharmacistApprovalModal = false" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>

                <!-- È†òÁî®Ë®òÈåÑË©≥ÊÉÖ -->
                <template x-if="selectedDispenseForApproval">
                    <div class="mb-4 p-4 bg-gray-50 rounded-lg border border-gray-200">
                        <h4 class="font-semibold text-gray-700 mb-2">È†òÁî®Ë®òÈåÑË©≥ÊÉÖ</h4>
                        <div class="space-y-1 text-sm">
                            <p><span class="text-gray-600">Ëó•ÂìÅ:</span> <span class="font-semibold" x-text="`${selectedDispenseForApproval.medicine_code} - ${selectedDispenseForApproval.medicine_name}`"></span></p>
                            <p><span class="text-gray-600">Êï∏Èáè:</span> <span class="font-semibold" x-text="selectedDispenseForApproval.quantity"></span> <span x-text="selectedDispenseForApproval.unit"></span></p>
                            <p><span class="text-gray-600">È†òËó•‰∫∫:</span> <span class="font-semibold" x-text="selectedDispenseForApproval.dispensed_by"></span></p>
                            <p x-show="selectedDispenseForApproval.patient_name"><span class="text-gray-600">ÁóÖÊÇ£:</span> <span x-text="selectedDispenseForApproval.patient_name"></span></p>
                            <p x-show="selectedDispenseForApproval.emergency_reason" class="text-claude-red-600 font-medium pt-2">
                                <span class="text-gray-600">Á∑äÊÄ•ÂéüÂõ†:</span> <span x-text="selectedDispenseForApproval.emergency_reason"></span>
                            </p>
                        </div>
                    </div>
                </template>

                <form @submit.prevent="submitPharmacistApproval()" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <span class="text-red-500">*</span> Ëó•Â∏´ÂßìÂêç
                        </label>
                        <input type="text"
                               x-model="pharmacistApprovalForm.approvedBy"
                               required
                               placeholder="Ëó•Â∏´-ÊûóÂ§ßËèØ"
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-dispense-purple-700">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <span class="text-red-500">*</span> PIN Á¢º (Ëó•Â∏´ÂØÜÁ¢º)
                        </label>
                        <input type="password"
                               x-model="pharmacistApprovalForm.pinCode"
                               required
                               placeholder="Ë´ãËº∏ÂÖ•4‰ΩçÊï∏PINÁ¢º"
                               maxlength="4"
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-dispense-purple-700">
                        <p class="text-xs text-gray-500 mt-1">È†êË®≠PINÁ¢º: 1234 (ÁîüÁî¢Áí∞Â¢ÉË´ãÊõ¥Êîπ)</p>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Ëó•Â∏´ÂÇôË®ª (ÈÅ∏Â°´)
                        </label>
                        <textarea x-model="pharmacistApprovalForm.pharmacistNotes"
                                  rows="3"
                                  placeholder="Á¢∫Ë™çÁÑ°Ë™§ÔºåÂ∑≤Ê†∏Â∞çÁóÖÊÇ£Áî®Ëó•Ë®òÈåÑ..."
                                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-dispense-purple-700 resize-none"></textarea>
                    </div>

                    <div class="flex gap-3">
                        <button type="submit" class="flex-1 bg-dispense-purple-700 text-white px-6 py-3 rounded-lg hover:bg-dispense-purple-900 transition-colors flex items-center justify-center gap-2 font-semibold">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                            </svg>
                            <span>Á¢∫Ë™çÂØ©Ê†∏</span>
                        </button>
                        <button type="button" @click="showPharmacistApprovalModal = false" class="flex-1 bg-gray-500 text-white px-6 py-3 rounded-lg hover:bg-gray-600 transition-colors flex items-center justify-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                            <span>ÂèñÊ∂à</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Ë°ÄË¢ãÈÅ∏ÊìáÂá∫Â∫´ Modal (v1.4.2-plus) -->
        <div x-show="showBloodBagSelectModal" class="fixed inset-0 bg-black bg-opacity-60 flex items-start justify-center z-50 overflow-y-auto py-4" style="display: none;">
            <div @click.away="showBloodBagSelectModal = false" class="bg-white rounded-xl shadow-2xl p-6 max-w-2xl w-full mx-4 my-4 max-h-[95vh] overflow-y-auto">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-bold text-red-700 flex items-center gap-2">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
                        </svg>
                        ÈÅ∏ÊìáÂá∫Â∫´Ë°ÄË¢ã
                    </h3>
                    <button @click="showBloodBagSelectModal = false" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>

                <!-- ÁóÖÊÇ£Ë≥áË®äÊëòË¶Å -->
                <div class="mb-4 p-3 bg-red-50 rounded-lg border border-red-200">
                    <div class="flex items-center gap-4 text-sm">
                        <span class="font-semibold text-red-700">Ë°ÄÂûã: <span x-text="bloodConsumeForm.bloodType" class="text-lg"></span></span>
                        <span class="text-gray-600">ÁóÖÊÇ£: <span x-text="bloodConsumeForm.patientName || '-'" class="font-medium"></span></span>
                        <span class="text-gray-600">ÈúÄÊ±Ç: <span x-text="bloodConsumeForm.quantity" class="font-medium"></span> U</span>
                    </div>
                </div>

                <!-- ÂèØÁî®Ë°ÄË¢ãÂàóË°® -->
                <div class="mb-4">
                    <div class="flex items-center justify-between mb-2">
                        <h4 class="font-semibold text-gray-700">ÂèØÁî®Ë°ÄË¢ã (<span x-text="availableBagsForConsume.length"></span> Ë¢ã)</h4>
                        <span class="text-sm text-gray-500">Â∑≤ÈÅ∏: <span x-text="selectedBagsForConsume.length" class="font-bold text-red-600"></span> Ë¢ã</span>
                    </div>

                    <div class="max-h-64 overflow-y-auto border border-gray-200 rounded-lg">
                        <template x-if="availableBagsForConsume.length === 0">
                            <div class="p-4 text-center text-gray-500">
                                <svg class="w-12 h-12 mx-auto mb-2 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"/>
                                </svg>
                                Ê≠§Ë°ÄÂûãÁõÆÂâçÁÑ°ÂèØÁî®Ë°ÄË¢ã
                            </div>
                        </template>
                        <template x-for="bag in availableBagsForConsume" :key="bag.bag_code">
                            <label class="flex items-center p-3 hover:bg-gray-50 cursor-pointer border-b border-gray-100 last:border-b-0"
                                   :class="{
                                       'bg-red-100': isExpired(bag.expiry_date),
                                       'bg-amber-50': isExpiringSoon(bag.expiry_date) && !isExpired(bag.expiry_date)
                                   }">
                                <input type="checkbox"
                                       :value="bag.bag_code"
                                       x-model="selectedBagsForConsume"
                                       class="rounded text-red-600 focus:ring-red-500 mr-3">
                                <div class="flex-1">
                                    <div class="flex items-center gap-2">
                                        <span class="font-mono text-sm font-medium" x-text="bag.bag_code"></span>
                                        <span class="px-1.5 py-0.5 text-xs font-bold rounded bg-red-600 text-white" x-text="bag.blood_type"></span>
                                        <span class="text-xs text-gray-500" x-text="bag.volume_ml + ' ml'"></span>
                                    </div>
                                    <div class="flex items-center gap-3 mt-1 text-xs">
                                        <span class="text-gray-500">ÊïàÊúü:</span>
                                        <span :class="{
                                            'text-red-600 font-bold': isExpired(bag.expiry_date),
                                            'text-amber-600 font-semibold': isExpiringSoon(bag.expiry_date) && !isExpired(bag.expiry_date),
                                            'text-gray-600': !isExpiringSoon(bag.expiry_date) && !isExpired(bag.expiry_date)
                                        }">
                                            <span x-text="bag.expiry_date"></span>
                                            <template x-if="isExpired(bag.expiry_date)">
                                                <span class="ml-1 text-red-600">(Â∑≤ÈÅéÊúü!)</span>
                                            </template>
                                            <template x-if="isExpiringSoon(bag.expiry_date) && !isExpired(bag.expiry_date)">
                                                <span class="ml-1 text-amber-600">(Âç≥Â∞áÈÅéÊúü)</span>
                                            </template>
                                        </span>
                                        <template x-if="bag.donor_info">
                                            <span class="text-blue-600" x-text="bag.donor_info"></span>
                                        </template>
                                    </div>
                                </div>
                            </label>
                        </template>
                    </div>
                </div>

                <!-- Êìç‰ΩúÊåâÈàï -->
                <div class="flex gap-3">
                    <button @click="confirmBloodBagConsume()"
                            :disabled="selectedBagsForConsume.length === 0"
                            :class="selectedBagsForConsume.length === 0 ? 'bg-gray-300 cursor-not-allowed' : 'bg-claude-red-500 hover:bg-claude-red-600'"
                            class="flex-1 text-white px-6 py-3 rounded-lg transition-colors flex items-center justify-center gap-2 font-semibold">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                        </svg>
                        <span>Á¢∫Ë™çÂá∫Â∫´ (<span x-text="selectedBagsForConsume.length"></span> Ë¢ã)</span>
                    </button>
                    <button @click="showBloodBagSelectModal = false" class="flex-1 bg-gray-500 text-white px-6 py-3 rounded-lg hover:bg-gray-600 transition-colors flex items-center justify-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                        <span>ÂèñÊ∂à</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="mt-12 pt-8 border-t border-gray-200">
            <div class="flex flex-col items-center justify-center gap-4">
                <!-- iRehab Logo -->
                <div class="flex items-center justify-center">
                    <img src="/static/iRehab_logo.png" alt="iRehab Logo" class="h-12 w-auto object-contain opacity-80 hover:opacity-100 transition-opacity">
                </div>

                <!-- Upgrade to Multi-Station Button -->
                <div class="flex items-center justify-center">
                    <button @click="showUpgradeModal = true"
                            class="group flex items-center gap-2 px-4 py-2 bg-gradient-to-r from-purple-500 to-indigo-600 text-white text-sm font-medium rounded-lg hover:from-purple-600 hover:to-indigo-700 transition-all duration-200 shadow-md hover:shadow-lg">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                        </svg>
                        <span>ÂçáÁ¥öËá≥Â§öÁ´ôÁâà</span>
                        <svg class="w-4 h-4 group-hover:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                        </svg>
                    </button>
                </div>

                <!-- Footer Text -->
                <div class="text-center text-xs text-gray-400 space-y-1">
                    <p>ÈÜ´ÁôÇÁ´ôÂ∫´Â≠òÁÆ°ÁêÜÁ≥ªÁµ± v2.9.1</p>
                    <p class="flex items-center justify-center gap-2">
                        <span>Powered by</span>
                        <a href="https://denovortho-site.vercel.app/zh-TW/resilience" target="_blank"
                           class="font-semibold text-gray-500 hover:text-teal-600 transition-colors">
                            De Novo Orthopedics Inc
                        </a>
                    </p>
                </div>
            </div>
        </footer>

        <!-- Upgrade Modal -->
        <div x-show="showUpgradeModal" class="fixed inset-0 bg-black bg-opacity-60 flex items-start justify-center z-50 overflow-y-auto py-4" style="display: none;">
            <div @click.away="showUpgradeModal = false" class="bg-white rounded-2xl shadow-2xl p-6 max-w-lg w-full mx-4 my-4 max-h-[90vh] overflow-y-auto">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-2xl font-bold text-gray-800 flex items-center gap-3">
                        <div class="w-10 h-10 bg-gradient-to-br from-purple-500 to-indigo-600 rounded-xl flex items-center justify-center">
                            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                            </svg>
                        </div>
                        ÂçáÁ¥öËá≥Â§öÁ´ôÁâà
                    </h3>
                    <button @click="showUpgradeModal = false" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>

                <!-- Feature Comparison -->
                <div class="mb-6">
                    <h4 class="font-semibold text-gray-700 mb-3">Â§öÁ´ôÁâàÂäüËÉΩ</h4>
                    <div class="space-y-2">
                        <div class="flex items-center gap-2 text-sm">
                            <svg class="w-5 h-5 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                            </svg>
                            <span>Â§öÁ´ôÈªûË≥áÊñôÂêåÊ≠•ËàáÁÆ°ÁêÜ</span>
                        </div>
                        <div class="flex items-center gap-2 text-sm">
                            <svg class="w-5 h-5 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                            </svg>
                            <span>‰∏≠Â§ÆÂ∫´Â≠òÁõ£ÊéßÂÑÄË°®Êùø</span>
                        </div>
                        <div class="flex items-center gap-2 text-sm">
                            <svg class="w-5 h-5 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                            </svg>
                            <span>Ë∑®Á´ôÈªûÁâ©Ë≥áË™øÊí•</span>
                        </div>
                        <div class="flex items-center gap-2 text-sm">
                            <svg class="w-5 h-5 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                            </svg>
                            <span>ÈÄ≤ÈöéÂ†±Ë°®ËàáÂàÜÊûê</span>
                        </div>
                    </div>
                </div>

                <!-- Upgrade Steps -->
                <div class="mb-6 p-4 bg-gray-50 rounded-xl">
                    <h4 class="font-semibold text-gray-700 mb-3">ÂçáÁ¥öÊ≠•È©ü</h4>
                    <ol class="space-y-3 text-sm">
                        <li class="flex items-start gap-3">
                            <span class="flex-shrink-0 w-6 h-6 bg-purple-100 text-purple-600 rounded-full flex items-center justify-center font-semibold text-xs">1</span>
                            <span>ÈªûÊìä‰∏ãÊñπ„ÄåÂåØÂá∫Ë≥áÊñô„Äç‰∏ãËºâÁõÆÂâçÊâÄÊúâË≥áÊñô</span>
                        </li>
                        <li class="flex items-start gap-3">
                            <span class="flex-shrink-0 w-6 h-6 bg-purple-100 text-purple-600 rounded-full flex items-center justify-center font-semibold text-xs">2</span>
                            <span>ËÅØÁπ´ÊàëÂÄëÂèñÂæóÂ§öÁ´ôÁâàÊéàÊ¨äÁ¢º</span>
                        </li>
                        <li class="flex items-start gap-3">
                            <span class="flex-shrink-0 w-6 h-6 bg-purple-100 text-purple-600 rounded-full flex items-center justify-center font-semibold text-xs">3</span>
                            <span>Âú®Â§öÁ´ôÁâàÁ≥ªÁµ±ÂåØÂÖ•Ë≥áÊñô‰∏¶Ëº∏ÂÖ•ÊéàÊ¨äÁ¢º</span>
                        </li>
                    </ol>
                </div>

                <!-- Action Buttons -->
                <div class="space-y-3">
                    <button @click="exportUpgradeData()"
                            class="w-full bg-gradient-to-r from-purple-500 to-indigo-600 text-white px-6 py-3 rounded-xl hover:from-purple-600 hover:to-indigo-700 transition-all duration-200 flex items-center justify-center gap-2 font-semibold shadow-md">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                        ÂåØÂá∫Ë≥áÊñô (ZIP)
                    </button>

                    <a href="mailto:tom@denovortho.com?subject=MIRS%20Â§öÁ´ôÁâàÂçáÁ¥öÁî≥Ë´ã&body=Á´ôÈªûIDÔºö%0AÁõÆÂâçÁâàÊú¨Ôºöv1.4.2-plus%0A%0AË´ãÊèê‰æõÂ§öÁ´ôÁâàÊéàÊ¨äÁ¢º"
                       class="w-full bg-gray-100 text-gray-700 px-6 py-3 rounded-xl hover:bg-gray-200 transition-colors flex items-center justify-center gap-2 font-medium">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                        </svg>
                        ËÅØÁπ´ÂèñÂæóÊéàÊ¨äÁ¢º
                    </a>

                    <button @click="showUpgradeModal = false"
                            class="w-full text-gray-500 px-6 py-2 rounded-xl hover:text-gray-700 transition-colors text-sm">
                        Á®çÂæåÂÜçË™™
                    </button>
                </div>
            </div>
        </div>

    </div>

    <script>
        function medicalInventory() {
            // v1.4.2-plus: ÂãïÊÖãÂÅµÊ∏¨ API URL (ÊîØÊè¥ÈÅ†Á´ØÂ≠òÂèñ)
            const currentHost = window.location.hostname;
            const currentPort = window.location.port;
            // v2.5.2: Áµ±‰∏Ä‰ΩøÁî®Áõ∏Â∞çË∑ØÂæëÔºåÂõ†ÁÇ∫ÂâçÁ´ØÁî±Âêå‰∏ÄÂÄã uvicorn ‰º∫ÊúçÂô®Êèê‰æõ
            // ÈÄôÊ®£ÁÑ°Ë´ñ port ÊòØ 8000 ÈÇÑÊòØ 8090 ÈÉΩËÉΩÊ≠£Â∏∏ÈÅã‰Ωú
            const apiBaseUrl = '/api';

            return {
                // Âü∫Êú¨Ë®≠ÂÆö
                apiUrl: apiBaseUrl,
                detectedServerUrl: null,  // v2.5: ÂæûÂæåÁ´ØÂÅµÊ∏¨ÁöÑ‰º∫ÊúçÂô® URL
                stationId: localStorage.getItem('stationId') || 'HC-000000',
                stationName: localStorage.getItem('stationName') || 'ÂâçÁ∑öÈÜ´ÁôÇÁ´ô',
                stationType: localStorage.getItem('stationType') || '',
                showCustomStationInput: false,
                customStationType: 'TC',
                customStationNumber: '',
                currentTab: 'items',
                treatmentMode: 'surgery', // ËôïÁΩÆÊ®ôÁ±§È†ÅÊ®°Âºè: 'surgery' Êàñ 'consume'
                currentTime: '',
                demoMode: false,  // Vercel demo mode flag

                // v1.1: CIRS ÂæÖËôïÁΩÆÊ∏ÖÂñÆ
                // v1.2: Âä†ÂÖ• lastSynced È°ØÁ§∫ÊúÄÂæåÂêåÊ≠•ÊôÇÈñì
                cirsProcedureStatus: { online: false, lastSynced: null },
                cirsProcedurePatients: [],
                
                // Ë≥áÊñô
                items: [],
                filteredItems: [],
                bloodInventory: [],
                equipment: [],
                surgeryRecords: [],
                receiveHistory: [],
                consumeHistory: [],
                stats: {
                    totalItems: 0,
                    lowStockItems: 0,
                    totalBlood: 0,
                    equipmentAlerts: 0
                },

                // ÈüåÊÄß‰º∞ÁÆó
                resilienceStatus: {
                    lifelines: [],
                    reagents: [],
                    summary: null,
                    context: {}
                },
                resilienceConfig: {
                    isolation_target_days: 5,
                    population_count: 2,
                    population_label: 'ÊèíÁÆ°ÊÇ£ËÄÖÊï∏'
                },
                expandedLifeline: null,  // v1.2.6: Â±ïÈñãÁöÑÁîüÂëΩÁ∑öÈ†ÖÁõÆ
                lifelinesRefreshKey: 0,  // v1.4.6: Âº∑Âà∂ÈáçÊñ∞Ê∏≤Êüì key
                equipmentRefreshKey: 0,  // v1.4.7: Ë®≠ÂÇôÂàóË°®Âº∑Âà∂ÈáçÊñ∞Ê∏≤Êüì key
                showUnitEditModal: false,  // v1.2.7: ÂñÆ‰ΩçÁ∑®ËºØ Modal
                unitEditForm: {
                    equipment_id: '',
                    unit_label: '',
                    label: '',
                    level: 100,
                    status: 'AVAILABLE',
                    checked: false  // v1.2.8: ÊòØÂê¶Â∑≤Ê™¢Êü•
                },
                // v1.4.7: ÈõªÂäõË®≠ÂÇôÂñÆ‰ΩçÁ∑®ËºØ Modal
                showPowerUnitEditModal: false,
                powerUnitEditForm: {
                    equipment_id: '',
                    unit_label: '',
                    label: '',
                    level: 100,
                    status: 'AVAILABLE',
                    device_type: 'POWER_STATION',
                    unit: 'Wh'
                },
                // v1.2.8: Ê™¢Êü•Â†±Ë°®
                showCheckReportModal: false,
                checkReportDate: new Date().toISOString().split('T')[0],
                checkReportData: null,

                // Mobile ÈÖçÂ∞ç
                showMobilePairing: false,
                pairingInfo: null,
                pairingQRUrl: '',
                pairingExpiry: null,
                pairingLoading: false,
                pairingError: null,
                pairingConfig: {
                    role: 'nurse',
                    scopes: {
                        equipment: true,
                        inventory: true,
                        bloodReceive: false,
                        supplyReceive: false
                    }
                },
                // ÈÖçÂ∞çË®òÈåÑ
                showPairedDevices: false,
                pairedDevices: [],
                pairedDevicesLoading: false,

                // ÊêúÂ∞ãËàáÁØ©ÈÅ∏
                itemSearchText: '',
                itemCategoryFilter: '',  // ÂàÜÈ°ûÁØ©ÈÅ∏ (Á©∫Â≠ó‰∏≤=ÂÖ®ÈÉ®, 'medicine'=Ëó•ÂìÅ, 'consumable'=ËÄóÊùê)
                receiveItemSearch: '',
                filteredReceiveItems: [],
                showReceiveDropdown: false,

                // Modal ÁãÄÊÖã
                showAddItemModal: false,
                showEditItemModal: false,
                showAddEquipmentModal: false,
                showEditEquipmentModal: false,
                showCheckEquipmentModal: false,
                showAddSurgeryModal: false,
                showSurgeryDetailModal: false,
                showReceiveHistoryModal: false,
                showConsumeHistoryModal: false,
                showConsumeDetailModal: false,
                showBloodHistoryModal: false,
                showEmergencyReasonModal: false,
                showPharmacistApprovalModal: false,
                showBloodBagSelectModal: false,  // v1.4.2-plus: Ë°ÄË¢ãÈÅ∏ÊìáÂá∫Â∫´
                showInventoryCheckHistoryModal: false,  // v0.7: Â∫´Â≠òÁõ§ÈªûÊ†∏Â∞çË®òÈåÑ
                showInventoryCheckDetailModal: false,   // v0.7: Áõ§ÈªûË©≥ÊÉÖ
                showUpgradeModal: false,  // ÂçáÁ¥öËá≥Â§öÁ´ôÁâà
                showUnitManageModal: false,  // v2.1: Ë®≠ÂÇôÂñÆ‰ΩçÁÆ°ÁêÜ

                // v2.1: Ë®≠ÂÇôÂñÆ‰ΩçÁÆ°ÁêÜË°®ÂñÆ
                unitManageForm: {
                    equipment_id: '',
                    equipment_name: '',
                    type_code: '',
                    unit_prefix: '',
                    units: [],
                    inactive_units: [],
                    loading: false,
                    showInactive: false,
                    addForm: {
                        level_percent: 100,
                        status: 'AVAILABLE',
                        reason: ''
                    },
                    removeReason: '',
                    targetQuantity: null
                },

                // Ë°ÄË¢ãÈÅ∏ÊìáÂá∫Â∫´ (v1.4.2-plus)
                availableBagsForConsume: [],  // Ë©≤Ë°ÄÂûãÂèØÁî®ÁöÑË°ÄË¢ãÂàóË°®
                selectedBagsForConsume: [],   // ÈÅ∏‰∏≠Ë¶ÅÂá∫Â∫´ÁöÑË°ÄË¢ã

                // Ë°ÄÂ∫´Ê≠∑Âè≤Ë®òÈåÑ
                bloodHistory: [],
                bloodHistorySearch: {
                    startDate: '',
                    endDate: '',
                    bloodType: '',
                    eventType: ''
                },
                selectedBloodRecord: null,

                // Â∫´Â≠òÁõ§ÈªûÊ†∏Â∞çË®òÈåÑ (v0.7)
                inventoryCheckHistory: [],
                inventoryCheckStats: {
                    totalChecks: 0,
                    totalConfirmed: 0,
                    totalErrors: 0,
                    pendingErrors: 0
                },
                lastKnownCheckCount: 0, // Áî®ÊñºÂÅµÊ∏¨Êñ∞ÂêåÊ≠•Ë®òÈåÑ
                inventoryCheckSearch: {
                    startDate: '',
                    endDate: '',
                    status: ''
                },
                selectedInventoryCheck: null,

                // ÂÄãÂà•Ë°ÄË¢ãËøΩËπ§ (v1.4.2-plus)
                bloodBags: [],
                selectedBagCodes: [],
                bloodBagForm: {
                    blood_type: '',
                    volume_ml: 250,
                    collection_date: '',
                    expiry_date: '',
                    donor_info: ''
                },

                // Ëó•ÂìÅÈ†òÁî®Ë®òÈåÑ (MIRS v2.3)
                pendingDispenses: [],
                dispenseHistory: [],
                selectedDispenseForApproval: null,

                // Ëó•Â±ÄÊí•Áôº (MIRS v2.4 - Pharmacy Dispatch)
                showDispatchModal: false,
                showDispatchQRModal: false,
                dispatchList: [],
                dispatchForm: {
                    target_station_id: '',
                    target_station_name: '',
                    items: [{ code: '', name: '', quantity: 1, searchText: '', filteredItems: [], showDropdown: false }]
                },
                dispatchQRData: {
                    dispatch_id: '',
                    qr_codes: [],
                    current_index: 0
                },

                // Ë°®ÂñÆ
                receiveForm: {
                    itemCode: '',
                    quantity: 1,
                    batchNumber: '',
                    expiryDate: '',
                    remarks: '',
                    stationId: 'HC-000000'
                },
                consumeForm: {
                    itemCode: '',
                    quantity: 1,
                    purpose: '',
                    stationId: 'HC-000000'
                },
                batchConsumeForm: {
                    purpose: '',
                    items: [],
                    stationId: 'HC-000000'
                },
                bloodReceiveForm: {
                    bloodType: '',
                    quantity: 1,
                    remarks: '',
                    source: 'blood_center',  // Êñ∞Â¢ûÔºöË°ÄÊ∂≤‰æÜÊ∫ê
                    donorName: '',           // Êñ∞Â¢ûÔºöÊçêË°ÄËÄÖÂßìÂêç
                    donorPhone: '',          // Êñ∞Â¢ûÔºöÊçêË°ÄËÄÖÈõªË©±
                    stationId: 'HC-000000'
                },
                bloodConsumeForm: {
                    bloodType: '',
                    quantity: 1,
                    patientName: '',
                    patientId: '',
                    purpose: '',
                    stationId: 'HC-000000'
                },
                bloodTransferForm: {
                    sourceStationId: 'HC-000000',
                    targetStationId: '',
                    bloodType: '',
                    quantity: 1,
                    operator: 'SYSTEM',
                    remarks: ''
                },
                addItemForm: {
                    code: '',
                    name: '',
                    unit: 'EA',
                    minStock: 10,
                    category: 'ÂÖ∂‰ªñ'
                },
                editItemForm: {
                    code: '',
                    name: '',
                    unit: '',
                    minStock: 0,
                    category: ''
                },
                addEquipmentForm: {
                    name: '',
                    category: 'ÂÖ∂‰ªñ',
                    quantity: 1,
                    remarks: '',
                    stationId: localStorage.getItem('stationId') || 'HC-000000'
                },
                editEquipmentForm: {
                    id: '',
                    name: '',
                    category: '',
                    quantity: 1,
                    remarks: ''
                },
                checkEquipmentForm: {
                    id: '',
                    name: '',
                    status: 'NORMAL',
                    powerLevel: null,
                    remarks: '',
                    stationId: 'HC-000000',
                    // v2: unit-centric fields
                    units: [],           // Ë®≠ÂÇôÁöÑÊâÄÊúâÂñÆ‰Ωç
                    selectedUnitId: null, // ÈÅ∏‰∏≠ÁöÑÂñÆ‰Ωç ID
                    statusOptions: []     // Ë©≤Ë®≠ÂÇôÈ°ûÂûãÁöÑÁãÄÊÖãÈÅ∏È†Ö
                },
                addSurgeryForm: {
                    patientName: '',
                    triageTagId: '',
                    surgeryType: '',
                    surgeonName: '',
                    anesthesiaType: '',
                    durationMinutes: null,
                    remarks: '',
                    consumptions: [],
                    intraopMeds: [],  // Ë°ì‰∏≠Áî®Ëó•
                    stationId: 'HC-000000',
                    // v1.1: CIRS Êï¥Âêà
                    cirsRegistrationRef: null,
                    cirsPersonId: null,
                    // v2.7.4: Ë°ìÂºèËàáËá™Ë≤ª Queue
                    surgeryQueue: [],      // [{code, name_zh, points, category_code, reduction_rate, final_points}]
                    selfPayQueue: [],      // [{item_id, name, unit_price, quantity}]
                    surgerySearchText: '', // Ë°ìÂºèÊêúÂ∞ã
                    selfPayFormSearchText: '' // Ëá™Ë≤ªÊêúÂ∞ã
                },
                // v2.7.4: Ë°®ÂñÆË°ìÂºèÊêúÂ∞ãÁµêÊûú
                formSurgerySearchResults: [],
                formSelfPaySearchResults: [],
                surgerySearchForm: {
                    startDate: '',
                    endDate: '',
                    patientName: ''
                },
                receiveHistorySearch: {
                    startDate: '',
                    endDate: '',
                    itemCode: ''
                },
                consumeHistorySearch: {
                    startDate: '',
                    endDate: '',
                    itemCode: ''
                },
                dispenseForm: {
                    medicineCode: '',
                    quantity: 1,
                    dispensedBy: '',
                    patientRefId: '',
                    patientName: '',
                    stationCode: 'HC-000000',
                    emergencyReason: ''
                },
                batchDispenseForm: {
                    dispensedBy: '',
                    patientRefId: '',
                    patientName: '',
                    items: [],
                    stationCode: 'HC-000000',
                    isEmergency: false,
                    emergencyReason: ''
                },
                pharmacistApprovalForm: {
                    dispenseId: null,
                    approvedBy: '',
                    pharmacistNotes: '',
                    pinCode: ''
                },
                selectedSurgery: null,
                selectedConsumeEvent: null,

                // Toast
                showToast: false,
                toastMessage: '',
                toastType: 'info',

                // Á∑äÊÄ•ÂäüËÉΩ (v1.4.5Êñ∞Â¢û)
                showEmergencyModal: false,

                // ÂêåÊ≠•ÁÆ°ÁêÜ (ËÅØÈÇ¶Êû∂Êßã Phase 1-2)
                syncPackageForm: {
                    syncType: 'DELTA',
                    sinceTimestamp: ''
                },
                generatedPackage: null,
                uploadedPackage: null,
                importResult: null,
                syncStats: {
                    pendingChanges: 0,
                    syncedPackages: 0,
                    lastSync: null
                },

                // ËºâÂÖ•ÁãÄÊÖãËøΩËπ§ (v1.4.5ÊïàËÉΩÂÑ™Âåñ)
                dataLoaded: {
                    items: false,
                    blood: false,
                    equipment: false,
                    surgery: false,
                    dispense: false,
                    surgeryMaster: false
                },

                // Ë°ìÂºè‰∏ªÊ™î (v2.6 - Phase 1-3)
                surgeryMasterSubTab: 'codes',
                surgeryCodes: [],
                surgeryCodesTotal: 0,
                surgeryCodesPage: 1,
                surgeryCodesPageSize: 50,
                selfPayItems: [],
                selfPayItemsTotal: 0,
                selfPayItemsPage: 1,
                selfPayItemsPageSize: 50,
                surgeryCategories: [],
                selfPayCategories: [],
                surgeryCodeSearchText: '',
                surgeryCodeCategoryFilter: '',
                selfPaySearchText: '',
                selfPayCategoryFilter: '',
                surgeryMasterStats: null,
                surgeryMasterLoading: false,
                // ÈªûÊï∏Ë®àÁÆóÂô®
                calculatorSurgeries: [],
                calculatorSearchText: '',
                calculatorSearchResults: [],
                calculatorShowDropdown: false,
                // Ëá™Ë≤ªÈ†ÖÁõÆ Queue (v2.7.3)
                selfPayQueue: [],

                // ÂàùÂßãÂåñ (v1.4.5ÂÑ™Âåñ: Âª∂ÈÅ≤ËºâÂÖ•)
                async init() {
                    this.updateTime();
                    setInterval(() => this.updateTime(), 1000);

                    // È©óË≠â QRCode ÂáΩÂºèÂ∫´ÊòØÂê¶ÂèØÁî® (qrcodejs)
                    if (typeof QRCode !== 'undefined' && QRCode.CorrectLevel) {
                        console.log('[Init] qrcodejs library loaded successfully');
                    } else {
                        console.error('[Init] qrcodejs library NOT loaded!');
                    }

                    // Check if running in Vercel demo mode
                    try {
                        const demoRes = await fetch(`${this.apiUrl}/demo-status`);
                        if (demoRes.ok) {
                            const demoData = await demoRes.json();
                            this.demoMode = demoData.is_demo || false;
                            console.log('Demo mode:', this.demoMode);
                        }
                    } catch (e) {
                        // Not in demo mode or API not available
                        this.demoMode = false;
                    }

                    // v2.5: ÂèñÂæó‰º∫ÊúçÂô® IP Ë≥áË®ä
                    try {
                        const infoRes = await fetch(`${this.apiUrl}/info`);
                        if (infoRes.ok) {
                            const infoData = await infoRes.json();
                            this.detectedServerUrl = infoData.server_url;
                            console.log('[Init] Server URL:', this.detectedServerUrl);
                        }
                    } catch (e) {
                        console.log('[Init] Could not detect server IP');
                    }

                    // ÂêåÊ≠•ÊâÄÊúâË°®ÂñÆÁöÑ stationId
                    this.syncFormStationIds();

                    // Âè™ËºâÂÖ•Áµ±Ë®àË≥áÊñôÔºàËºïÈáèÁ¥öÔºâ
                    await this.loadStats();

                    // Ê†πÊìöÁï∂ÂâçÊ®ôÁ±§ËºâÂÖ•Â∞çÊáâË≥áÊñô
                    await this.lazyLoadTabData(this.currentTab);

                    // ÂàùÂßãÂåñÂêåÊ≠•ÈÄöÁü•Ëº™Ë©¢ (ÊØè 30 ÁßíÊ™¢Êü•‰∏ÄÊ¨° PWA ÂêåÊ≠•)
                    await this.initSyncNotifications();
                    setInterval(() => this.checkForNewSyncs(), 30000);
                },

                // Reset demo data (Vercel demo mode only)
                async resetDemo() {
                    if (!this.demoMode) return;
                    if (!confirm('Á¢∫ÂÆöË¶ÅÈáçÁΩÆÂ±ïÁ§∫Ë≥áÊñôÂóéÔºüÊâÄÊúâËÆäÊõ¥Â∞áÊúÉÈÅ∫Â§±„ÄÇ')) return;
                    try {
                        const res = await fetch('/api/demo/reset', { method: 'POST' });
                        if (res.ok) {
                            alert('Â±ïÁ§∫Ë≥áÊñôÂ∑≤ÈáçÁΩÆÔºÅÈ†ÅÈù¢Â∞áÈáçÊñ∞ËºâÂÖ•„ÄÇ');
                            window.location.reload();
                        } else {
                            alert('ÈáçÁΩÆÂ§±ÊïóÔºåË´ãÁ®çÂæåÂÜçË©¶„ÄÇ');
                        }
                    } catch (e) {
                        alert('ÈáçÁΩÆÂ§±ÊïóÔºö' + e.message);
                    }
                },

                // Áî¢Áîü Mobile ÈÖçÂ∞çÁ¢ºËàá QR Code
                async generatePairingCode() {
                    this.pairingLoading = true;
                    this.pairingError = null;
                    this.pairingInfo = null;
                    this.pairingQRUrl = '';

                    // Â∞áÂäüËÉΩÈñãÈóúËΩâÊèõÁÇ∫ scope Â≠ó‰∏≤Èô£Âàó
                    const scopes = ['mirs:resilience:read'];
                    if (this.pairingConfig.scopes.equipment) {
                        scopes.push('mirs:equipment:read', 'mirs:equipment:write');
                    }
                    if (this.pairingConfig.scopes.inventory) {
                        scopes.push('mirs:inventory:read', 'mirs:inventory:check');
                    }
                    if (this.pairingConfig.scopes.bloodReceive) {
                        scopes.push('mirs:blood:receive');
                    }
                    if (this.pairingConfig.scopes.supplyReceive) {
                        scopes.push('mirs:items:receive');
                    }

                    try {
                        // 1. ÂèñÂæó QR Code ÂúñÁâá
                        const qrRes = await fetch(`${this.apiUrl}/mirs-mobile/v1/auth/pairing-qr`);
                        if (qrRes.ok) {
                            const blob = await qrRes.blob();
                            this.pairingQRUrl = URL.createObjectURL(blob);
                        } else {
                            throw new Error('ÁÑ°Ê≥ïÁî¢Áîü QR Code');
                        }

                        // 2. Áî¢ÁîüÈÖçÂ∞çÁ¢ºÔºàÂ∏∂‰∏äËßíËâ≤ËàáÊ¨äÈôêÔºâ
                        const pairingReq = {
                            role: this.pairingConfig.role,
                            scopes: scopes
                        };

                        // ÂòóË©¶ POSTÔºàÊñ∞Áâà APIÔºâÔºåÂ¶ÇÊûúÂ§±ÊïóÂâáÈÄÄÂõû GETÔºàËàäÁâà APIÔºâ
                        let infoRes = await fetch(`${this.apiUrl}/mirs-mobile/v1/auth/pairing-info`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(pairingReq)
                        });

                        // Â¶ÇÊûú POST ‰∏çÊîØÊè¥ (405)ÔºåÈÄÄÂõû GETÔºà‰ΩøÁî®È†êË®≠Ê¨äÈôêÔºâ
                        if (infoRes.status === 405) {
                            console.warn('POST /auth/pairing-info not supported, falling back to GET');
                            infoRes = await fetch(`${this.apiUrl}/mirs-mobile/v1/auth/pairing-info`);
                        }

                        if (!infoRes.ok) {
                            const err = await infoRes.json();
                            throw new Error(err.detail || 'Áî¢ÁîüÈÖçÂ∞çÁ¢ºÂ§±Êïó');
                        }

                        this.pairingInfo = await infoRes.json();

                        // Ë®àÁÆóÂâ©È§òÊôÇÈñì
                        const expiresAt = new Date(this.pairingInfo.expires_at);
                        const updateExpiry = () => {
                            const now = new Date();
                            const diff = Math.max(0, Math.floor((expiresAt - now) / 1000));
                            const mins = Math.floor(diff / 60);
                            const secs = diff % 60;
                            this.pairingExpiry = `${mins}:${secs.toString().padStart(2, '0')}`;

                            if (diff <= 0) {
                                this.pairingExpiry = 'Â∑≤ÈÅéÊúü';
                            }
                        };
                        updateExpiry();
                        const timer = setInterval(() => {
                            updateExpiry();
                            if (this.pairingExpiry === 'Â∑≤ÈÅéÊúü' || !this.showMobilePairing) {
                                clearInterval(timer);
                            }
                        }, 1000);

                    } catch (e) {
                        console.error('Generate pairing code error:', e);
                        this.pairingError = e.message || 'ÁÑ°Ê≥ïÈÄ£Êé•Âà∞ Mobile API';
                    } finally {
                        this.pairingLoading = false;
                    }
                },

                // ËºâÂÖ•Â∑≤ÈÖçÂ∞çË£ùÁΩÆÂàóË°®
                async loadPairedDevices() {
                    this.pairedDevicesLoading = true;
                    try {
                        const response = await fetch(`${this.apiUrl}/mirs-mobile/v1/devices`);
                        if (response.ok) {
                            const data = await response.json();
                            this.pairedDevices = data.devices || [];
                            console.log('‚úì Â∑≤ËºâÂÖ•ÈÖçÂ∞çË£ùÁΩÆ:', this.pairedDevices.length, 'Á≠Ü');
                        } else {
                            console.error('ËºâÂÖ•ÈÖçÂ∞çË£ùÁΩÆÂ§±Êïó:', response.status);
                            this.pairedDevices = [];
                        }
                    } catch (e) {
                        console.error('ËºâÂÖ•ÈÖçÂ∞çË£ùÁΩÆÈåØË™§:', e);
                        this.pairedDevices = [];
                    } finally {
                        this.pairedDevicesLoading = false;
                    }
                },

                // Êí§Èä∑Ë£ùÁΩÆÈÖçÂ∞ç
                async revokeDevice(deviceId) {
                    const reason = prompt('Ë´ãËº∏ÂÖ•Êí§Èä∑ÂéüÂõ†ÔºàÈÅ∏Â°´ÔºâÔºö');
                    if (reason === null) return; // ‰ΩøÁî®ËÄÖÂèñÊ∂à

                    try {
                        const response = await fetch(`${this.apiUrl}/mirs-mobile/v1/devices/${deviceId}/revoke`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ reason: reason || 'ÁÆ°ÁêÜÂì°Êí§Èä∑' })
                        });

                        if (response.ok) {
                            this.toast('Ë£ùÁΩÆÂ∑≤Êí§Èä∑', 'success');
                            this.loadPairedDevices(); // ÈáçÊñ∞ËºâÂÖ•ÂàóË°®
                        } else {
                            const err = await response.json();
                            this.toast(err.detail || 'Êí§Èä∑Â§±Êïó', 'error');
                        }
                    } catch (e) {
                        console.error('Êí§Èä∑Ë£ùÁΩÆÂ§±Êïó:', e);
                        this.toast('Êí§Èä∑Â§±Êïó: ' + e.message, 'error');
                    }
                },

                // ÂêåÊ≠•ÊâÄÊúâË°®ÂñÆÁöÑ stationId ËàáÁï∂ÂâçÁ´ôÈªû
                syncFormStationIds() {
                    this.receiveForm.stationId = this.stationId;
                    this.consumeForm.stationId = this.stationId;
                    this.batchConsumeForm.stationId = this.stationId;
                    this.bloodReceiveForm.stationId = this.stationId;
                    this.bloodConsumeForm.stationId = this.stationId;
                },

                updateTime() {
                    const now = new Date();
                    this.currentTime = now.toLocaleString('zh-TW', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit',
                        hour12: false
                    });
                },

                getStationTypeName() {
                    const types = {
                        'health_center': 'Ë°õÁîüÊâÄ',
                        'hospital_custom': 'ÈÜ´Èô¢Ëá™Ë®Ç',
                        'surgical_station': 'BORP ÂÇôÊè¥ÊâãË°ìÁ´ô',
                        'logistics_hub': 'Áâ©Ë≥á‰∏≠ÁπºÁ´ô'
                    };
                    return types[this.stationType] || this.stationType;
                },

                // Âª∂ÈÅ≤ËºâÂÖ•Ê®ôÁ±§Ë≥áÊñô (v1.4.5ÊïàËÉΩÂÑ™Âåñ)
                async lazyLoadTabData(tab) {
                    if (tab === 'items' && !this.dataLoaded.items) {
                        await this.loadItems();
                        this.dataLoaded.items = true;
                    }
                    if (tab === 'blood' && !this.dataLoaded.blood) {
                        await this.loadBloodInventory();
                        await this.loadBloodBags();
                        this.dataLoaded.blood = true;
                    }
                    if (tab === 'equipment' && !this.dataLoaded.equipment) {
                        await this.loadEquipment();
                        this.dataLoaded.equipment = true;
                    }
                    if (tab === 'surgery' && !this.dataLoaded.surgery) {
                        await this.loadSurgeryRecords();
                        this.dataLoaded.surgery = true;
                    }
                    if (tab === 'treatment' && !this.dataLoaded.items) {
                        // ËôïÁΩÆÊ®ôÁ±§ÈúÄË¶ÅÁâ©ÂìÅË≥áÊñô (Áî®ÊñºÊ∂àËÄóÂìÅÈ†ÖÊêúÂ∞ã)
                        await this.loadItems();
                        this.dataLoaded.items = true;
                    }
                    if (tab === 'dispense' && !this.dataLoaded.dispense) {
                        await this.loadPendingDispenses();
                        this.dataLoaded.dispense = true;
                    }
                    if (tab === 'resilience') {
                        // ÈüåÊÄßË®≠ÂÇôË°®Ê†ºÈúÄË¶Å equipment Ë≥áÊñô
                        if (!this.dataLoaded.equipment) {
                            await this.loadEquipment();
                            this.dataLoaded.equipment = true;
                        }
                        await this.loadResilienceConfig();
                        await this.loadResilienceStatus();
                    }
                    if (tab === 'surgeryMaster' && !this.dataLoaded.surgeryMaster) {
                        await this.loadSurgeryCategories();
                        await this.loadSelfPayCategories();
                        await this.loadSurgeryMasterStats();
                        await this.loadSurgeryCodes();
                        this.dataLoaded.surgeryMaster = true;
                    }
                },

                // ÂàÜÈ†ÅÂàáÊèõ (v1.4.5ÂÑ™Âåñ: Âª∂ÈÅ≤ËºâÂÖ•)
                async switchTab(tab) {
                    this.currentTab = tab;
                    await this.lazyLoadTabData(tab);
                },

                // ============================================================
                // Ë°ìÂºè‰∏ªÊ™îÊñπÊ≥ï (v2.6 - Phase 1-3)
                // ============================================================

                async loadSurgeryCategories() {
                    try {
                        const response = await fetch(`${this.apiUrl}/surgery-codes/categories`);
                        if (response.ok) {
                            const data = await response.json();
                            this.surgeryCategories = data.categories || [];
                        }
                    } catch (error) {
                        console.error('ËºâÂÖ•Ë°ìÂºèÂàÜÈ°ûÂ§±Êïó:', error);
                    }
                },

                async loadSelfPayCategories() {
                    try {
                        const response = await fetch(`${this.apiUrl}/surgery-codes/selfpay/categories`);
                        if (response.ok) {
                            const data = await response.json();
                            this.selfPayCategories = data.categories || [];
                        }
                    } catch (error) {
                        console.error('ËºâÂÖ•Ëá™Ë≤ªÂàÜÈ°ûÂ§±Êïó:', error);
                    }
                },

                async loadSurgeryMasterStats() {
                    try {
                        const response = await fetch(`${this.apiUrl}/surgery-codes/stats`);
                        if (response.ok) {
                            this.surgeryMasterStats = await response.json();
                        }
                    } catch (error) {
                        console.error('ËºâÂÖ•Ë°ìÂºèÁµ±Ë®àÂ§±Êïó:', error);
                    }
                },

                async loadSurgeryCodes() {
                    // Èò≤Ê≠¢ÈáçË§áË´ãÊ±Ç
                    if (this.surgeryMasterLoading) return;
                    this.surgeryMasterLoading = true;
                    try {
                        let url;
                        if (this.surgeryCodeSearchText && this.surgeryCodeSearchText.trim()) {
                            // ÊúâÊêúÂ∞ãÊñáÂ≠óÊôÇ‰ΩøÁî® FTS ÊêúÂ∞ãÁ´ØÈªû
                            url = `${this.apiUrl}/surgery-codes/codes/search?q=${encodeURIComponent(this.surgeryCodeSearchText)}&limit=50`;
                            if (this.surgeryCodeCategoryFilter) {
                                url += `&category=${encodeURIComponent(this.surgeryCodeCategoryFilter)}`;
                            }
                        } else {
                            // ÁÑ°ÊêúÂ∞ãÊñáÂ≠óÊôÇ‰ΩøÁî®ÂàóË°®Á´ØÈªû
                            url = `${this.apiUrl}/surgery-codes/codes?page=${this.surgeryCodesPage}&page_size=${this.surgeryCodesPageSize}`;
                            if (this.surgeryCodeCategoryFilter) {
                                url += `&category=${encodeURIComponent(this.surgeryCodeCategoryFilter)}`;
                            }
                        }
                        const response = await fetch(url);
                        if (response.ok) {
                            const data = await response.json();
                            this.surgeryCodes = data.codes || [];
                            this.surgeryCodesTotal = data.total || this.surgeryCodes.length;
                        }
                    } catch (error) {
                        console.error('ËºâÂÖ•Ë°ìÂºè‰ª£Á¢ºÂ§±Êïó:', error);
                    } finally {
                        this.surgeryMasterLoading = false;
                    }
                },

                async searchSurgeryCodes() {
                    this.surgeryCodesPage = 1;
                    // ÂÖàÊ∏ÖÁ©∫ÂÜçËºâÂÖ•ÔºåÈÅøÂÖçÈ°ØÁ§∫ËàäË≥áÊñô
                    this.surgeryCodes = [];
                    await this.loadSurgeryCodes();
                },

                async loadSelfPayItems() {
                    this.surgeryMasterLoading = true;
                    try {
                        let url;
                        if (this.selfPaySearchText && this.selfPaySearchText.trim()) {
                            // ÊúâÊêúÂ∞ãÊñáÂ≠óÊôÇ‰ΩøÁî® FTS ÊêúÂ∞ãÁ´ØÈªû
                            url = `${this.apiUrl}/surgery-codes/selfpay/search?q=${encodeURIComponent(this.selfPaySearchText)}&limit=50`;
                            if (this.selfPayCategoryFilter) {
                                url += `&category=${encodeURIComponent(this.selfPayCategoryFilter)}`;
                            }
                        } else {
                            // ÁÑ°ÊêúÂ∞ãÊñáÂ≠óÊôÇ‰ΩøÁî®ÂàóË°®Á´ØÈªû
                            url = `${this.apiUrl}/surgery-codes/selfpay?limit=50`;
                            if (this.selfPayCategoryFilter) {
                                url += `&category=${encodeURIComponent(this.selfPayCategoryFilter)}`;
                            }
                        }
                        const response = await fetch(url);
                        if (response.ok) {
                            const data = await response.json();
                            this.selfPayItems = data.items || [];
                            this.selfPayItemsTotal = data.total || this.selfPayItems.length;
                        }
                    } catch (error) {
                        console.error('ËºâÂÖ•Ëá™Ë≤ªÈ†ÖÁõÆÂ§±Êïó:', error);
                    } finally {
                        this.surgeryMasterLoading = false;
                    }
                },

                async searchSelfPayItems() {
                    this.selfPayItemsPage = 1;
                    await this.loadSelfPayItems();
                },

                // Ë°ìÂºè‰∏ªÊ™îÂ≠êÊ®ôÁ±§ÂàáÊèõ
                async switchSurgeryMasterSubTab(subTab) {
                    this.surgeryMasterSubTab = subTab;
                    if (subTab === 'codes' && this.surgeryCodes.length === 0) {
                        await this.loadSurgeryCodes();
                    } else if (subTab === 'selfpay' && this.selfPayItems.length === 0) {
                        await this.loadSelfPayItems();
                    }
                },

                // ÈªûÊï∏Ë®àÁÆóÂô®ÊñπÊ≥ï
                async searchForCalculator() {
                    if (!this.calculatorSearchText || this.calculatorSearchText.length < 1) {
                        this.calculatorSearchResults = [];
                        this.calculatorShowDropdown = false;
                        return;
                    }
                    try {
                        const response = await fetch(`${this.apiUrl}/surgery-codes/codes/search?q=${encodeURIComponent(this.calculatorSearchText)}&limit=10`);
                        if (response.ok) {
                            const data = await response.json();
                            this.calculatorSearchResults = data.codes || [];
                            this.calculatorShowDropdown = this.calculatorSearchResults.length > 0;
                        }
                    } catch (error) {
                        console.error('ÊêúÂ∞ãË°ìÂºèÂ§±Êïó:', error);
                    }
                },

                addToCalculator(surgery) {
                    // Ê™¢Êü•ÊòØÂê¶Â∑≤Ê∑ªÂä†
                    if (this.calculatorSurgeries.find(s => s.code === surgery.code)) {
                        this.showToastMessage('Ê≠§Ë°ìÂºèÂ∑≤Âú®Ê∏ÖÂñÆ‰∏≠', 'warning');
                        return;
                    }
                    this.calculatorSurgeries.push({
                        code: surgery.code,
                        name_zh: surgery.name_zh,
                        points: surgery.points,
                        category_code: surgery.category_code || null,
                        reduction_rate: 1.0,
                        final_points: surgery.points
                    });
                    this.recalculatePoints();
                    this.calculatorSearchText = '';
                    this.calculatorSearchResults = [];
                    this.calculatorShowDropdown = false;
                },

                removeFromCalculator(index) {
                    this.calculatorSurgeries.splice(index, 1);
                    this.recalculatePoints();
                },

                async recalculatePoints() {
                    if (this.calculatorSurgeries.length === 0) return;

                    try {
                        // ‰ΩøÁî® API Ë®àÁÆóÈÅûÊ∏õ (v2.7.4: Ê≠£Á¢∫ÁöÑÂÅ•‰øùË¶èÂâá)
                        const response = await fetch(`${this.apiUrl}/surgery-codes/calculate-points`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                surgeries: this.calculatorSurgeries.map(s => ({
                                    code: s.code,
                                    name: s.name_zh,
                                    points: s.points,
                                    category_code: s.category_code
                                })),
                                apply_reduction: true
                            })
                        });

                        if (response.ok) {
                            const result = await response.json();
                            // Áî® API ÂõûÂÇ≥ÁöÑ sequence ÊéíÂ∫èÔºå‰∏¶Êõ¥Êñ∞ reduction_rate Âíå final_points
                            const resultMap = {};
                            result.items.forEach(item => {
                                resultMap[item.code] = {
                                    reduction_rate: item.reduction_rate,
                                    final_points: item.final_points,
                                    sequence: item.sequence
                                };
                            });

                            this.calculatorSurgeries = this.calculatorSurgeries.map(s => ({
                                ...s,
                                reduction_rate: resultMap[s.code]?.reduction_rate ?? 1.0,
                                final_points: resultMap[s.code]?.final_points ?? s.points,
                                sequence: resultMap[s.code]?.sequence ?? 99
                            }));

                            // Êåâ sequence ÊéíÂ∫èÈ°ØÁ§∫
                            this.calculatorSurgeries.sort((a, b) => a.sequence - b.sequence);
                        }
                    } catch (error) {
                        console.error('Ë®àÁÆóÈªûÊï∏Â§±Êïó:', error);
                        // Fallback: Á∞°ÊòìË®àÁÆó
                        this.calculatorSurgeries.forEach((s, idx) => {
                            s.reduction_rate = idx === 0 ? 1.0 : (idx <= 2 ? 0.5 : 0.0);
                            s.final_points = Math.round(s.points * s.reduction_rate);
                        });
                    }
                },

                getCalculatorTotal() {
                    return this.calculatorSurgeries.reduce((sum, s) => sum + (s.final_points || 0), 0);
                },

                getCalculatorOriginalTotal() {
                    return this.calculatorSurgeries.reduce((sum, s) => sum + (s.points || 0), 0);
                },

                clearCalculator() {
                    this.calculatorSurgeries = [];
                },

                // Ëá™Ë≤ªÈ†ÖÁõÆ Queue ÊñπÊ≥ï (v2.7.3)
                addToSelfPayQueue(item) {
                    const existing = this.selfPayQueue.find(q => q.item_id === item.item_id);
                    if (existing) {
                        existing.quantity++;
                    } else {
                        this.selfPayQueue.push({
                            item_id: item.item_id,
                            name: item.name,
                            unit_price: item.unit_price || 0,
                            unit: item.unit || 'ÁµÑ',
                            category: item.category,
                            quantity: 1
                        });
                    }
                },

                removeFromSelfPayQueue(index) {
                    this.selfPayQueue.splice(index, 1);
                },

                updateSelfPayQueueQty(index, delta) {
                    const item = this.selfPayQueue[index];
                    if (item) {
                        item.quantity = Math.max(1, item.quantity + delta);
                    }
                },

                getSelfPayQueueTotal() {
                    return this.selfPayQueue.reduce((sum, item) => sum + (item.unit_price * item.quantity), 0);
                },

                clearSelfPayQueue() {
                    this.selfPayQueue = [];
                },

                // ============================================================
                // v2.7.4: ËôïÁΩÆËÄóÊùêË®òÈåÑË°®ÂñÆ Queue ÊñπÊ≥ï
                // ============================================================

                async searchFormSurgery() {
                    const q = this.addSurgeryForm.surgerySearchText;
                    if (!q || q.length < 1) {
                        this.formSurgerySearchResults = [];
                        return;
                    }
                    try {
                        const response = await fetch(`${this.apiUrl}/surgery-codes/codes/search?q=${encodeURIComponent(q)}&limit=10`);
                        if (response.ok) {
                            const data = await response.json();
                            this.formSurgerySearchResults = data.codes || [];
                        }
                    } catch (error) {
                        console.error('ÊêúÂ∞ãË°ìÂºèÂ§±Êïó:', error);
                    }
                },

                addToFormSurgeryQueue(surgery) {
                    if (this.addSurgeryForm.surgeryQueue.find(s => s.code === surgery.code)) {
                        this.showToastMessage('Ê≠§Ë°ìÂºèÂ∑≤Âú®Ê∏ÖÂñÆ‰∏≠', 'warning');
                        return;
                    }
                    this.addSurgeryForm.surgeryQueue.push({
                        code: surgery.code,
                        name_zh: surgery.name_zh,
                        points: surgery.points,
                        category_code: surgery.category_code || null,
                        reduction_rate: 1.0,
                        final_points: surgery.points
                    });
                    this.recalculateFormSurgeryPoints();
                    this.addSurgeryForm.surgerySearchText = '';
                    this.formSurgerySearchResults = [];
                },

                removeFromFormSurgeryQueue(index) {
                    this.addSurgeryForm.surgeryQueue.splice(index, 1);
                    this.recalculateFormSurgeryPoints();
                },

                async recalculateFormSurgeryPoints() {
                    const queue = this.addSurgeryForm.surgeryQueue;
                    if (queue.length === 0) return;

                    try {
                        const response = await fetch(`${this.apiUrl}/surgery-codes/calculate-points`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                surgeries: queue.map(s => ({
                                    code: s.code,
                                    name: s.name_zh,
                                    points: s.points,
                                    category_code: s.category_code
                                })),
                                apply_reduction: true
                            })
                        });

                        if (response.ok) {
                            const result = await response.json();
                            const resultMap = {};
                            result.items.forEach(item => {
                                resultMap[item.code] = {
                                    reduction_rate: item.reduction_rate,
                                    final_points: item.final_points,
                                    sequence: item.sequence
                                };
                            });

                            this.addSurgeryForm.surgeryQueue = queue.map(s => ({
                                ...s,
                                reduction_rate: resultMap[s.code]?.reduction_rate ?? 1.0,
                                final_points: resultMap[s.code]?.final_points ?? s.points,
                                sequence: resultMap[s.code]?.sequence ?? 99
                            })).sort((a, b) => a.sequence - b.sequence);
                        }
                    } catch (error) {
                        console.error('Ë®àÁÆóÈªûÊï∏Â§±Êïó:', error);
                    }
                },

                getFormSurgeryTotal() {
                    return this.addSurgeryForm.surgeryQueue.reduce((sum, s) => sum + (s.final_points || 0), 0);
                },

                async searchFormSelfPay() {
                    const q = this.addSurgeryForm.selfPayFormSearchText;
                    if (!q || q.length < 1) {
                        this.formSelfPaySearchResults = [];
                        return;
                    }
                    try {
                        const response = await fetch(`${this.apiUrl}/surgery-codes/selfpay/search?q=${encodeURIComponent(q)}&limit=10`);
                        if (response.ok) {
                            const data = await response.json();
                            this.formSelfPaySearchResults = data.items || [];
                        }
                    } catch (error) {
                        console.error('ÊêúÂ∞ãËá™Ë≤ªÈ†ÖÁõÆÂ§±Êïó:', error);
                    }
                },

                addToFormSelfPayQueue(item) {
                    const existing = this.addSurgeryForm.selfPayQueue.find(q => q.item_id === item.item_id);
                    if (existing) {
                        existing.quantity++;
                    } else {
                        this.addSurgeryForm.selfPayQueue.push({
                            item_id: item.item_id,
                            name: item.name,
                            unit_price: item.unit_price || 0,
                            unit: item.unit || 'ÁµÑ',
                            quantity: 1
                        });
                    }
                },

                removeFromFormSelfPayQueue(index) {
                    this.addSurgeryForm.selfPayQueue.splice(index, 1);
                },

                updateFormSelfPayQty(index, delta) {
                    const item = this.addSurgeryForm.selfPayQueue[index];
                    if (item) {
                        item.quantity = Math.max(1, item.quantity + delta);
                    }
                },

                getFormSelfPayTotal() {
                    return this.addSurgeryForm.selfPayQueue.reduce((sum, item) => sum + (item.unit_price * item.quantity), 0);
                },

                // Ê†ºÂºèÂåñÊï∏Â≠óÂä†ÂçÉÂàÜ‰Ωç
                formatNumber(num) {
                    return (num || 0).toLocaleString();
                },

                // ============================================================
                // ÈüåÊÄß‰º∞ÁÆóÊñπÊ≥ï
                // ============================================================

                // ‰ΩøÁî® v1 API (ÂÆåÊï¥Ë®àÁÆóÈÇèËºØ: population, power dependency)
                async loadResilienceStatus() {
                    try {
                        // ‰øùÂ≠òÊªæÂãï‰ΩçÁΩÆ
                        const scrollY = window.scrollY;

                        // v1 API: /api/resilience/status (ÂÆåÊï¥Ë®àÁÆóÈÇèËºØ)
                        const response = await fetch(`${this.apiUrl}/resilience/status`, {
                            cache: 'no-store'
                        });
                        if (response.ok) {
                            const data = await response.json();
                            // v1 API Áõ¥Êé•ÂõûÂÇ≥ÂÆåÊï¥ÁµêÊßãÔºåÁÑ°ÈúÄËΩâÊèõ

                            // Êõ¥Êñ∞ÁãÄÊÖã
                            this.resilienceStatus = {};
                            await this.$nextTick();
                            this.resilienceStatus = this.transformV1ToFrontend(data);
                            await this.$nextTick();

                            // ÊÅ¢Âæ©ÊªæÂãï‰ΩçÁΩÆ
                            window.scrollTo(0, scrollY);

                            console.log('‚úì ÈüåÊÄßÁãÄÊÖãÂ∑≤ËºâÂÖ• (v1 API)');
                        }
                    } catch (error) {
                        console.error('ËºâÂÖ•ÈüåÊÄßÁãÄÊÖãÂ§±Êïó:', error);
                    }
                },

                // v1 API ÂõûÊáâËΩâÊèõÁÇ∫ÂâçÁ´ØÊ†ºÂºè
                transformV1ToFrontend(data) {
                    // ÊâæÂá∫ÊúÄÂº±ÁîüÂëΩÁ∑ö
                    const weakestLifeline = data.lifelines?.reduce((min, ll) =>
                        (!min || (ll.endurance?.effective_hours || 0) < (min.endurance?.effective_hours || 0)) ? ll : min, null);

                    return {
                        summary: {
                            overall_status: data.summary?.overall_status || 'UNKNOWN',
                            weakest_link: weakestLifeline ? {
                                hours: weakestLifeline.endurance?.effective_hours || 0,
                                type: weakestLifeline.type,
                                name: weakestLifeline.name
                            } : null,
                            check_progress: data.summary?.check_progress || { total: 0, checked: 0, percentage: 0 },
                            isolation_target_days: data.context?.isolation_target_days || 3
                        },
                        lifelines: data.lifelines || []
                    };
                },

                // v2: Â∞á dashboard API ÂõûÊáâËΩâÊèõÁÇ∫ÂâçÁ´ØÁõ∏ÂÆπÊ†ºÂºè
                transformDashboardToLegacy(dashboard) {
                    // ÊâæÂá∫ÊúÄÂº±ÁîüÂëΩÁ∑ö
                    const weakestLifeline = dashboard.lifelines?.reduce((min, ll) =>
                        (!min || ll.total_hours < min.total_hours) ? ll : min, null);

                    return {
                        summary: {
                            overall_status: dashboard.summary?.overall_status || 'UNKNOWN',
                            weakest_link: weakestLifeline ? {
                                hours: weakestLifeline.total_hours,
                                type: weakestLifeline.category,
                                name: weakestLifeline.name
                            } : null,
                            check_progress: dashboard.summary?.check_progress || { total: 0, checked: 0, percentage: 0 },
                            isolation_target_days: dashboard.summary?.isolation_target_days || 3
                        },
                        lifelines: dashboard.lifelines?.map(ll => ({
                            type: ll.category,  // 'POWER' or 'OXYGEN'
                            item_code: ll.category,
                            name: ll.name,
                            status: ll.status,
                            // v1 Áõ∏ÂÆπ: endurance ÁµêÊßã
                            endurance: {
                                effective_hours: ll.total_hours >= 999999 ? '‚àû' : Math.round(ll.total_hours * 10) / 10,
                                effective_days: Math.round(ll.total_hours / 24 * 10) / 10
                            },
                            // v1 Áõ∏ÂÆπ: inventory ÁµêÊßã
                            inventory: {
                                items: ll.items?.map(item => ({
                                    item_code: item.equipment_id,
                                    name: item.name,
                                    device_type: item.type_code,
                                    qty: item.units?.length || 1,
                                    avg_level: item.units?.length > 0
                                        ? Math.round(item.units.reduce((sum, u) => sum + (u.level_percent || 0), 0) / item.units.length)
                                        : 100,
                                    tracking_mode: 'PER_UNIT',
                                    units: item.units?.map(u => ({
                                        id: u.unit_id,
                                        serial: u.serial,
                                        label: u.label,
                                        level: u.level_percent,  // v1 Áõ∏ÂÆπ
                                        level_percent: u.level_percent,
                                        status: u.status,
                                        hours: u.hours,
                                        last_check: u.last_check,
                                        checked: !!u.last_check  // v1 Áõ∏ÂÆπ: Êúâ last_check Ë°®Á§∫Â∑≤Ê™¢Êü•
                                    })) || []
                                })) || []
                            },
                            charging_warnings: ll.charging_warnings || [],
                            // v2: ‰øùÁïôÂÆåÊï¥Ë≥áË®ä‰æõÊñ∞ UI ‰ΩøÁî®
                            _v2_data: ll
                        })) || []
                    };
                },

                async loadResilienceConfig() {
                    try {
                        const response = await fetch('/api/resilience/config?t=' + Date.now(), {
                            cache: 'no-store'
                        });
                        if (response.ok) {
                            const config = await response.json();
                            this.resilienceConfig = {
                                ...this.resilienceConfig,
                                ...config
                            };
                        }
                    } catch (error) {
                        console.error('ËºâÂÖ•ÈüåÊÄßË®≠ÂÆöÂ§±Êïó:', error);
                    }
                },

                async updateResilienceConfig() {
                    try {
                        const response = await fetch('/api/resilience/config', {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(this.resilienceConfig)
                        });
                        if (response.ok) {
                            // v1.4.3: Á´ãÂç≥ÈáçÊñ∞Ë®àÁÆóÈüåÊÄßÁãÄÊÖã
                            await this.loadResilienceStatus();
                            // Show feedback with new resilience hours
                            const hours = this.resilienceStatus.summary?.weakest_link?.hours;
                            const statusText = {
                                'SAFE': 'ÂÆâÂÖ®',
                                'WARNING': 'Ë≠¶Êàí',
                                'CRITICAL': 'Âç±Èö™'
                            }[this.resilienceStatus.summary?.overall_status] || '';
                            const msg = hours !== undefined
                                ? `ÈüåÊÄßÂ∑≤Êõ¥Êñ∞ÔºöÂèØÁç®Á´ãÈÅã‰Ωú ${hours.toFixed(1)} Â∞èÊôÇ (${statusText})`
                                : 'ÈüåÊÄßË®≠ÂÆöÂ∑≤Êõ¥Êñ∞';
                            this.toast(msg, 'success');
                        } else {
                            const err = await response.json();
                            this.toast(err.detail || 'Êõ¥Êñ∞Â§±Êïó', 'error');
                        }
                    } catch (error) {
                        console.error('Êõ¥Êñ∞ÈüåÊÄßË®≠ÂÆöÂ§±Êïó:', error);
                        this.toast('Êõ¥Êñ∞ÈüåÊÄßË®≠ÂÆöÂ§±Êïó: ' + error.message, 'error');
                    }
                },

                // ÂàáÊèõÁ´ôÈªû
                async changeStation(newStationId) {
                    // If same station, do nothing
                    if (newStationId === this.stationId) return;

                    // Store old station for rollback
                    const oldStationId = this.stationId;

                    // Infer station type and name from ID
                    const getStationInfo = (stationId) => {
                        // Hardcoded mappings for common stations
                        const hardcoded = {
                            'HC-000000': { name: 'ÈÜ´ÁôÇÁ´ô HC-000000', type: 'health_center' },
                            'BORP-01': { name: 'BORP ÂÇôÊè¥ÊâãË°ìÁ´ô', type: 'surgical_station' },
                            'LOG-HUB': { name: 'Áâ©Ë≥á‰∏≠ÂøÉ LOG-HUB', type: 'logistics_hub' }
                        };

                        if (hardcoded[stationId]) {
                            return hardcoded[stationId];
                        }

                        // Parse prefix for custom stations
                        let type, name;
                        if (stationId.startsWith('TC-')) {
                            type = 'health_center';
                            name = `ÈÜ´ÁôÇÁ´ô ${stationId}`;
                        } else if (stationId.startsWith('BORP-')) {
                            type = 'surgical_station';
                            name = `BORP ÂÇôÊè¥ÊâãË°ìÁ´ô ${stationId}`;
                        } else if (stationId.startsWith('LOG-')) {
                            type = 'logistics_hub';
                            name = `Áâ©Ë≥á‰∏≠ÂøÉ ${stationId}`;
                        } else {
                            // Unknown type - use generic
                            type = 'custom';
                            name = stationId;
                        }

                        return { name, type };
                    };

                    const oldInfo = getStationInfo(oldStationId);
                    const newInfo = getStationInfo(newStationId);

                    // Confirm station switch
                    const confirmed = confirm(
                        `Á¢∫ÂÆöË¶ÅÂàáÊèõËá≥„Äå${newInfo.name}„ÄçÂóéÔºü\n\n` +
                        `üìå ÈáçË¶ÅË™™ÊòéÔºö\n` +
                        `‚Ä¢ ÂàáÊèõÁ´ôÈªûÂæåÔºåÊÇ®Â∞áÂè™ËÉΩÁúãÂà∞Ë©≤Á´ôÈªûÁöÑË≥áÊñô\n` +
                        `‚Ä¢ ÂêÑÁ´ôÈªûÁöÑË≥áÊñôÈÉΩ‰øùÂ≠òÂú®Ë≥áÊñôÂ∫´‰∏≠Ôºå‰∏çÊúÉË¢´Âà™Èô§\n` +
                        `‚Ä¢ Âú® ${oldInfo.name} Êñ∞Â¢ûÁöÑË≥áÊñô‰ªçÂ±¨Êñº ${oldInfo.name}\n` +
                        `‚Ä¢ ÂàáÊèõÂõûÂéüÁ´ôÈªûÊôÇÔºåË≥áÊñô‰ªçÊúÉÂú®ÈÇ£Ë£°\n\n` +
                        `ÊòØÂê¶ÁπºÁ∫åÂàáÊèõÔºü`
                    );

                    if (!confirmed) {
                        // Reset select element back to old station
                        if (typeof event !== 'undefined' && event.target) {
                            event.target.value = oldStationId;
                        }
                        return;
                    }

                    // Update station
                    this.stationId = newStationId;
                    this.stationName = newInfo.name;
                    this.stationType = newInfo.type;

                    localStorage.setItem('stationId', newStationId);
                    localStorage.setItem('stationName', this.stationName);
                    localStorage.setItem('stationType', this.stationType);

                    // ÂêåÊ≠•ÊâÄÊúâË°®ÂñÆÁöÑ stationId
                    this.syncFormStationIds();

                    // Reset data loaded flags
                    this.dataLoaded = {
                        items: false,
                        blood: false,
                        equipment: false,
                        surgery: false,
                        dispense: false
                    };

                    // Reload current tab data
                    await this.loadStats();
                    await this.lazyLoadTabData(this.currentTab);

                    // Auto-initialize new station with template if empty
                    if (this.currentTab === 'equipment' || !this.dataLoaded.equipment) {
                        await this.loadEquipment();
                        await this.autoInitializeStationTemplate();
                    }

                    this.toast(`Â∑≤Âæû ${oldInfo.name} ÂàáÊèõËá≥ ${this.stationName}`, 'info');
                },

                // Auto-initialize station with equipment template
                async autoInitializeStationTemplate() {
                    // Only auto-initialize if equipment is empty
                    if (this.equipment && this.equipment.length > 0) {
                        return; // Station already has equipment
                    }

                    // Don't auto-initialize if it's a well-known station (already set up manually)
                    const knownStations = ['HC-000000', 'BORP-01', 'LOG-HUB'];
                    if (knownStations.includes(this.stationId)) {
                        return;
                    }

                    // Determine template based on station type
                    let templateStationId;
                    if (this.stationId.startsWith('TC-')) {
                        templateStationId = 'HC-000000';
                    } else if (this.stationId.startsWith('BORP-')) {
                        templateStationId = 'BORP-01';
                    } else if (this.stationId.startsWith('LOG-')) {
                        templateStationId = 'LOG-HUB';
                    } else {
                        return; // Unknown type, skip auto-initialization
                    }

                    // Fetch template equipment
                    try {
                        const response = await fetch(`${this.apiUrl}/equipment?station_id=${templateStationId}`);
                        if (!response.ok) return;

                        const data = await response.json();
                        const templateEquipment = data.equipment || [];

                        if (templateEquipment.length === 0) return;

                        // Ask user if they want to copy template
                        const confirmed = confirm(
                            `Ê™¢Ê∏¨Âà∞ ${this.stationName} Â∞öÁÑ°Ë®≠ÂÇô„ÄÇ\n\n` +
                            `ÊòØÂê¶Ë¶ÅÂæû ${templateStationId} Ë§áË£Ω ${templateEquipment.length} È†ÖË®≠ÂÇôÊ®°ÊùøÔºü\n\n` +
                            `ÈÄôÂ∞áÂπ´Âä©ÊÇ®Âø´ÈÄüË®≠ÁΩÆÊñ∞Á´ôÈªû„ÄÇ`
                        );

                        if (!confirmed) return;

                        // Copy equipment from template
                        let successCount = 0;
                        for (const eq of templateEquipment) {
                            // Generate new equipment ID for this station
                            const oldPrefix = templateStationId.replace('-', '');
                            const newPrefix = this.stationId.replace('-', '');
                            const newId = eq.id.replace(oldPrefix, newPrefix);

                            const newEquipment = {
                                id: newId,
                                name: eq.name,
                                category: eq.category,
                                quantity: eq.quantity,
                                status: 'UNCHECKED',
                                power_level: eq.power_level,
                                remarks: `Âæû ${templateStationId} Ë§áË£Ω`,
                                station_id: this.stationId
                            };

                            try {
                                const addResponse = await fetch(`${this.apiUrl}/equipment`, {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify(newEquipment)
                                });

                                if (addResponse.ok) {
                                    successCount++;
                                }
                            } catch (error) {
                                console.error('Ë§áË£ΩË®≠ÂÇôÂ§±Êïó:', newId, error);
                            }
                        }

                        if (successCount > 0) {
                            this.toast(`Â∑≤ÊàêÂäüË§áË£Ω ${successCount} È†ÖË®≠ÂÇô`, 'success');
                            await this.loadEquipment();
                            await this.loadStats();
                        }
                    } catch (error) {
                        console.error('Ëá™ÂãïÂàùÂßãÂåñÂ§±Êïó:', error);
                    }
                },

                // ËôïÁêÜÁ´ôÈªûÈÅ∏ÊìáËÆäÊõ¥
                handleStationSelectChange(value) {
                    if (value === '__CUSTOM__') {
                        this.showCustomStationInput = true;
                        this.customStationType = 'TC';
                        this.customStationNumber = '';
                        // Auto-focus the input after it appears
                        this.$nextTick(() => {
                            const input = document.querySelector('input[x-model="customStationNumber"]');
                            if (input) input.focus();
                        });
                    } else {
                        this.showCustomStationInput = false;
                        this.changeStation(value);
                    }
                },

                // ÊáâÁî®Ëá™Ë®ÇÁ´ôÈªûID
                applyCustomStation() {
                    if (!this.customStationNumber || !this.customStationNumber.trim()) {
                        this.toast('Ë´ãËº∏ÂÖ•Á´ôÈªûÁ∑®Ëôü', 'error');
                        return;
                    }

                    // Validate number format (digits only, padded with leading zeros)
                    const number = this.customStationNumber.trim();
                    if (!/^\d+$/.test(number)) {
                        this.toast('Á∑®ËôüÂè™ËÉΩÂåÖÂê´Êï∏Â≠ó', 'error');
                        return;
                    }

                    // Pad number with leading zeros to 2 digits
                    const paddedNumber = number.padStart(2, '0');

                    // Generate station ID based on type
                    let stationId;
                    if (this.customStationType === 'LOG') {
                        // LOG stations use different format: LOG-XXX or LOG-HUB
                        if (paddedNumber === '01') {
                            stationId = 'LOG-HUB'; // Special case for main hub
                        } else {
                            stationId = `LOG-${paddedNumber}`;
                        }
                    } else {
                        stationId = `${this.customStationType}-${paddedNumber}`;
                    }

                    this.showCustomStationInput = false;
                    this.customStationNumber = '';
                    this.changeStation(stationId);
                },

                // Á¢∫‰øùitemsÂ∑≤ËºâÂÖ• (Áî®ÊñºÊêúÂ∞ãËÄóÊùêÂäüËÉΩ)
                async ensureItemsLoaded() {
                    if (!this.dataLoaded.items || this.items.length === 0) {
                        await this.loadItems();
                        this.dataLoaded.items = true;
                    }
                },

                // ËºâÂÖ•Áµ±Ë®à
                async loadStats() {
                    try {
                        const url = this.stationId
                            ? `${this.apiUrl}/stats?station_id=${this.stationId}`
                            : `${this.apiUrl}/stats`;
                        const response = await fetch(url);
                        if (response.ok) {
                            this.stats = await response.json();
                            console.log(`‚úì Áµ±Ë®àÂ∑≤ËºâÂÖ• (Á´ôÈªû: ${this.stationId}):`, this.stats);
                        }
                    } catch (error) {
                        console.error('ËºâÂÖ•Áµ±Ë®àÂ§±Êïó:', error);
                    }
                },

                // ËºâÂÖ•Áâ©ÂìÅ
                async loadItems() {
                    try {
                        const response = await fetch(`${this.apiUrl}/items`);
                        if (response.ok) {
                            const data = await response.json();
                            this.items = data.items;
                            this.filteredItems = data.items;
                        }
                    } catch (error) {
                        console.error('ËºâÂÖ•Áâ©ÂìÅÂ§±Êïó:', error);
                        this.toast('ËºâÂÖ•Áâ©ÂìÅÂ§±Êïó', 'error');
                    }
                },

                // ÁØ©ÈÅ∏Áâ©ÂìÅ (v1.4.2-plus: ÊîØÊè¥Ëó•ÂìÅ/ËÄóÊùê/Ë©¶ÂäëÂàÜÈ°ûÁØ©ÈÅ∏)
                filterItems() {
                    let result = this.items;

                    // ÂàÜÈ°ûÁØ©ÈÅ∏
                    // - Ëó•ÂìÅ = MED- ÈñãÈ†≠
                    // - Ë©¶Âäë = REA- ÈñãÈ†≠ (Ê™¢È©óÁßëÁÆ°ÁêÜ)
                    // - ËÄóÊùê = Èùû MED- ‰∏îÈùû REA- ÈñãÈ†≠ (Ë≠∑ÁêÜÁÆ°ÁêÜ)
                    if (this.itemCategoryFilter === 'medicine') {
                        result = result.filter(item => item.code.startsWith('MED-'));
                    } else if (this.itemCategoryFilter === 'reagent') {
                        result = result.filter(item => item.code.startsWith('REA-'));
                    } else if (this.itemCategoryFilter === 'consumable') {
                        result = result.filter(item => !item.code.startsWith('MED-') && !item.code.startsWith('REA-'));
                    }

                    // ÊñáÂ≠óÊêúÂ∞ã
                    const searchText = this.itemSearchText.toLowerCase();
                    if (searchText) {
                        result = result.filter(item =>
                            item.code.toLowerCase().includes(searchText) ||
                            item.name.toLowerCase().includes(searchText) ||
                            item.category.toLowerCase().includes(searchText)
                        );
                    }

                    this.filteredItems = result;
                },

                // ÂåØÂá∫Â∫´Â≠òCSV
                exportInventoryCSV() {
                    const url = `${this.apiUrl}/inventory/export/csv`;
                    window.open(url, '_blank');
                    this.toast('CSV ÂåØÂá∫ÊàêÂäü', 'success');
                },

                // ÂåØÂá∫Â∫´Â≠òJSON
                exportInventoryJSON() {
                    const url = `${this.apiUrl}/inventory/export/json`;
                    window.open(url, '_blank');
                    this.toast('JSON ÂåØÂá∫ÊàêÂäü', 'success');
                },

                // ÂçáÁ¥öËá≥Â§öÁ´ôÁâà - ÂåØÂá∫ÂÆåÊï¥Ë≥áÊñô
                async exportUpgradeData() {
                    try {
                        this.toast('Ê≠£Âú®Ê∫ñÂÇôÂåØÂá∫Ë≥áÊñô...', 'info');

                        const url = `${this.apiUrl}/export/upgrade-package`;
                        const response = await fetch(url);

                        if (response.ok) {
                            const blob = await response.blob();
                            const filename = `mirs_upgrade_${this.stationId}_${new Date().toISOString().slice(0,10)}.zip`;

                            // Âª∫Á´ã‰∏ãËºâÈÄ£Áµê
                            const downloadUrl = window.URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = downloadUrl;
                            a.download = filename;
                            document.body.appendChild(a);
                            a.click();
                            document.body.removeChild(a);
                            window.URL.revokeObjectURL(downloadUrl);

                            this.toast('ÂçáÁ¥öË≥áÊñôÂåØÂá∫ÊàêÂäüÔºÅË´ãÂ¶•ÂñÑ‰øùÂ≠òÊ≠§Ê™îÊ°à', 'success');
                        } else {
                            const data = await response.json();
                            this.toast(data.detail || 'ÂåØÂá∫Â§±Êïó', 'error');
                        }
                    } catch (error) {
                        console.error('ÂåØÂá∫ÂçáÁ¥öË≥áÊñôÂ§±Êïó:', error);
                        this.toast('ÂåØÂá∫ÂçáÁ¥öË≥áÊñôÂ§±Êïó', 'error');
                    }
                },

                // Êñ∞Â¢ûÁâ©ÂìÅ
                async submitAddItem() {
                    try {
                        const response = await fetch(`${this.apiUrl}/items`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(this.addItemForm)
                        });
                        
                        const data = await response.json();
                        
                        if (response.ok) {
                            this.toast(data.message || 'Áâ©ÂìÅÊñ∞Â¢ûÊàêÂäü', 'success');
                            this.showAddItemModal = false;
                            this.resetAddItemForm();
                            await this.loadItems();
                            await this.loadStats();
                        } else {
                            this.toast(data.detail || 'Êñ∞Â¢ûÂ§±Êïó', 'error');
                        }
                    } catch (error) {
                        console.error('Êñ∞Â¢ûÁâ©ÂìÅÂ§±Êïó:', error);
                        this.toast('Êñ∞Â¢ûÁâ©ÂìÅÂ§±Êïó', 'error');
                    }
                },

                resetAddItemForm() {
                    this.addItemForm = {
                        code: '',
                        name: '',
                        unit: 'EA',
                        minStock: 10,
                        category: 'ÂÖ∂‰ªñ'
                    };
                },

                // Á∑®ËºØÁâ©ÂìÅ
                editItem(item) {
                    this.editItemForm = {
                        code: item.code,
                        name: item.name,
                        unit: item.unit,
                        minStock: item.min_stock,
                        category: item.category
                    };
                    this.showEditItemModal = true;
                },

                async submitEditItem() {
                    try {
                        const response = await fetch(`${this.apiUrl}/items/${this.editItemForm.code}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                name: this.editItemForm.name,
                                unit: this.editItemForm.unit,
                                minStock: this.editItemForm.minStock,
                                category: this.editItemForm.category
                            })
                        });
                        
                        const data = await response.json();
                        
                        if (response.ok) {
                            this.toast(data.message || 'Áâ©ÂìÅÊõ¥Êñ∞ÊàêÂäü', 'success');
                            this.showEditItemModal = false;
                            await this.loadItems();
                        } else {
                            this.toast(data.detail || 'Êõ¥Êñ∞Â§±Êïó', 'error');
                        }
                    } catch (error) {
                        console.error('Êõ¥Êñ∞Áâ©ÂìÅÂ§±Êïó:', error);
                        this.toast('Êõ¥Êñ∞Áâ©ÂìÅÂ§±Êïó', 'error');
                    }
                },

                // Âà™Èô§Áâ©ÂìÅ
                async deleteItem(code, name) {
                    if (!confirm(`Á¢∫ÂÆöË¶ÅÂà™Èô§Áâ©ÂìÅ„Äå${name}„ÄçÂóé?`)) return;
                    
                    try {
                        const response = await fetch(`${this.apiUrl}/items/${code}`, {
                            method: 'DELETE'
                        });
                        
                        const data = await response.json();
                        
                        if (response.ok) {
                            this.toast(data.message || 'Áâ©ÂìÅÂ∑≤Âà™Èô§', 'success');
                            await this.loadItems();
                            await this.loadStats();
                        } else {
                            this.toast(data.detail || 'Âà™Èô§Â§±Êïó', 'error');
                        }
                    } catch (error) {
                        console.error('Âà™Èô§Áâ©ÂìÅÂ§±Êïó:', error);
                        this.toast('Âà™Èô§Áâ©ÂìÅÂ§±Êïó', 'error');
                    }
                },

                // ÈÄ≤Ë≤®
                async submitReceive() {
                    try {
                        const response = await fetch(`${this.apiUrl}/receive`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(this.receiveForm)
                        });
                        
                        const data = await response.json();
                        
                        if (response.ok) {
                            this.toast(data.message || 'ÈÄ≤Ë≤®Ë®òÈåÑÊàêÂäü', 'success');
                            this.resetReceiveForm();
                            await this.loadItems();
                            await this.loadStats();
                        } else {
                            this.toast(data.detail || 'ÈÄ≤Ë≤®Â§±Êïó', 'error');
                        }
                    } catch (error) {
                        console.error('ÈÄ≤Ë≤®Â§±Êïó:', error);
                        this.toast('ÈÄ≤Ë≤®Â§±Êïó', 'error');
                    }
                },

                resetReceiveForm() {
                    this.receiveForm = {
                        itemCode: '',
                        quantity: 1,
                        batchNumber: '',
                        expiryDate: '',
                        remarks: '',
                        stationId: this.stationId
                    };
                    this.receiveItemSearch = '';
                },

                // ÈÄ≤Ë≤®È†ÅÈù¢ - Áâ©ÂìÅÊêúÂ∞ã
                filterReceiveItems() {
                    const searchText = this.receiveItemSearch.toLowerCase();
                    if (!searchText) {
                        this.filteredReceiveItems = this.items;
                    } else {
                        this.filteredReceiveItems = this.items.filter(item =>
                            item.code.toLowerCase().includes(searchText) ||
                            item.name.toLowerCase().includes(searchText)
                        );
                    }
                },

                // ÈÄ≤Ë≤®È†ÅÈù¢ - ÈÅ∏ÊìáÁâ©ÂìÅ
                selectReceiveItem(item) {
                    this.receiveForm.itemCode = item.code;
                    this.receiveItemSearch = `${item.code} - ${item.name}`;
                    this.showReceiveDropdown = false;
                },

                // ËºâÂÖ•ÈÄ≤Ë≤®Ë®òÈåÑ
                async loadReceiveHistory() {
                    try {
                        let url = `${this.apiUrl}/inventory/events?event_type=RECEIVE&limit=100`;

                        if (this.receiveHistorySearch.startDate) {
                            url += `&start_date=${this.receiveHistorySearch.startDate}`;
                        }
                        if (this.receiveHistorySearch.endDate) {
                            url += `&end_date=${this.receiveHistorySearch.endDate}`;
                        }
                        if (this.receiveHistorySearch.itemCode) {
                            url += `&item_code=${encodeURIComponent(this.receiveHistorySearch.itemCode)}`;
                        }

                        const response = await fetch(url);
                        if (response.ok) {
                            const data = await response.json();
                            this.receiveHistory = data.events;
                        }
                    } catch (error) {
                        console.error('ËºâÂÖ•ÈÄ≤Ë≤®Ë®òÈåÑÂ§±Êïó:', error);
                        this.toast('ËºâÂÖ•ÈÄ≤Ë≤®Ë®òÈåÑÂ§±Êïó', 'error');
                    }
                },

                // ÂåØÂá∫ÈÄ≤Ë≤®Ë®òÈåÑ
                exportReceiveHistoryCSV() {
                    let url = `${this.apiUrl}/inventory/events/export/csv?event_type=RECEIVE`;

                    if (this.receiveHistorySearch.startDate) {
                        url += `&start_date=${this.receiveHistorySearch.startDate}`;
                    }
                    if (this.receiveHistorySearch.endDate) {
                        url += `&end_date=${this.receiveHistorySearch.endDate}`;
                    }

                    window.open(url, '_blank');
                    this.toast('ÈÄ≤Ë≤®Ë®òÈåÑÂåØÂá∫ÊàêÂäü', 'success');
                },

                // Ê∂àËÄó
                async submitConsume() {
                    try {
                        const response = await fetch(`${this.apiUrl}/consume`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(this.consumeForm)
                        });
                        
                        const data = await response.json();
                        
                        if (response.ok) {
                            this.toast(data.message || 'Ê∂àËÄóË®òÈåÑÊàêÂäü', 'success');
                            this.resetConsumeForm();
                            await this.loadItems();
                            await this.loadStats();
                        } else {
                            this.toast(data.detail || 'Ê∂àËÄóÂ§±Êïó', 'error');
                        }
                    } catch (error) {
                        console.error('Ê∂àËÄóÂ§±Êïó:', error);
                        this.toast('Ê∂àËÄóÂ§±Êïó', 'error');
                    }
                },

                resetConsumeForm() {
                    this.consumeForm = {
                        itemCode: '',
                        quantity: 1,
                        purpose: '',
                        stationId: this.stationId
                    };
                },

                // ÊâπÊ¨°Ê∂àËÄóÂäüËÉΩ
                addBatchConsumeItem() {
                    this.batchConsumeForm.items.push({
                        itemCode: '',
                        itemName: '',
                        quantity: 1,
                        searchText: '',
                        showDropdown: false,
                        filteredItems: []
                    });
                },

                removeBatchConsumeItem(index) {
                    this.batchConsumeForm.items.splice(index, 1);
                },

                filterBatchConsumeItems(index) {
                    const item = this.batchConsumeForm.items[index];
                    if (!item) return;

                    const searchText = (item.searchText || '').toLowerCase();

                    // Á¢∫‰øù items Â∑≤ËºâÂÖ•‰∏îÊúâË≥áÊñô
                    if (!this.items || this.items.length === 0) {
                        item.filteredItems = [];
                        return;
                    }

                    // ÊéíÈô§Ëó•ÂìÅ (medicines) - Ëó•ÂìÅÊáâË©≤ÈÄèÈÅéËó•ÂìÅÈ†òÁî®ÊµÅÁ®ã
                    // Âä†ÂÖ•Ê™¢Êü•Á¢∫‰øùÊØèÂÄãÂÖÉÁ¥†ÈÉΩÊúâÂøÖË¶ÅÁöÑÂ±¨ÊÄß
                    const nonMedicineItems = this.items.filter(i =>
                        i && i.category && i.category !== 'Ëó•ÂìÅ'
                    );

                    if (!searchText) {
                        item.filteredItems = nonMedicineItems;
                    } else {
                        item.filteredItems = nonMedicineItems.filter(i =>
                            i && i.code && i.name &&
                            (i.code.toLowerCase().includes(searchText) ||
                             i.name.toLowerCase().includes(searchText))
                        );
                    }
                },

                selectBatchConsumeItem(index, selectedItem) {
                    const item = this.batchConsumeForm.items[index];
                    item.itemCode = selectedItem.code;
                    item.itemName = selectedItem.name;
                    item.searchText = `${selectedItem.code} - ${selectedItem.name}`;
                    item.showDropdown = false;
                },

                async submitBatchConsume() {
                    try {
                        if (this.batchConsumeForm.items.length === 0) {
                            this.toast('Ë´ãËá≥Â∞ëÊñ∞Â¢û‰∏ÄÂÄãÊ∂àËÄóÂìÅÈ†Ö', 'error');
                            return;
                        }

                        // ÊâπÊ¨°Êèê‰∫§ÊØèÂÄãÊ∂àËÄóÂìÅÈ†Ö
                        let successCount = 0;
                        let failCount = 0;

                        for (const item of this.batchConsumeForm.items) {
                            try {
                                const response = await fetch(`${this.apiUrl}/consume`, {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({
                                        itemCode: item.itemCode,
                                        quantity: item.quantity,
                                        purpose: this.batchConsumeForm.purpose,
                                        stationId: this.batchConsumeForm.stationId
                                    })
                                });

                                if (response.ok) {
                                    successCount++;
                                } else {
                                    failCount++;
                                }
                            } catch (error) {
                                failCount++;
                            }
                        }

                        // È°ØÁ§∫ÁµêÊûú
                        if (failCount === 0) {
                            this.toast(`ÊàêÂäüÊ∂àËÄó ${successCount} È†ÖÁâ©ÂìÅ`, 'success');
                            this.resetBatchConsumeForm();
                            await this.loadItems();
                            await this.loadStats();
                        } else {
                            this.toast(`ÊàêÂäü ${successCount} È†ÖÔºåÂ§±Êïó ${failCount} È†Ö`, 'warning');
                            await this.loadItems();
                            await this.loadStats();
                        }
                    } catch (error) {
                        console.error('ÊâπÊ¨°Ê∂àËÄóÂ§±Êïó:', error);
                        this.toast('ÊâπÊ¨°Ê∂àËÄóÂ§±Êïó', 'error');
                    }
                },

                resetBatchConsumeForm() {
                    this.batchConsumeForm = {
                        purpose: '',
                        items: [],
                        stationId: this.stationId
                    };
                },

                // ËºâÂÖ•Ê∂àËÄóË®òÈåÑ
                async loadConsumeHistory() {
                    try {
                        let url = `${this.apiUrl}/inventory/events?event_type=CONSUME&limit=100`;

                        if (this.consumeHistorySearch.startDate) {
                            url += `&start_date=${this.consumeHistorySearch.startDate}`;
                        }
                        if (this.consumeHistorySearch.endDate) {
                            url += `&end_date=${this.consumeHistorySearch.endDate}`;
                        }
                        if (this.consumeHistorySearch.itemCode) {
                            url += `&item_code=${encodeURIComponent(this.consumeHistorySearch.itemCode)}`;
                        }

                        const response = await fetch(url);
                        if (response.ok) {
                            const data = await response.json();
                            this.consumeHistory = data.events;
                        }
                    } catch (error) {
                        console.error('ËºâÂÖ•Ê∂àËÄóË®òÈåÑÂ§±Êïó:', error);
                        this.toast('ËºâÂÖ•Ê∂àËÄóË®òÈåÑÂ§±Êïó', 'error');
                    }
                },

                // Êü•ÁúãÊ∂àËÄóË©≥ÊÉÖ
                viewConsumeDetail(event) {
                    this.selectedConsumeEvent = event;
                    this.showConsumeDetailModal = true;
                },

                // ËºâÂÖ•Ë°ÄÂ∫´Ê≠∑Âè≤Ë®òÈåÑ
                async loadBloodHistory() {
                    try {
                        let url = `${this.apiUrl}/blood/events?station_id=${this.stationId}`;

                        // Ê∑ªÂä†ÁØ©ÈÅ∏Ê¢ù‰ª∂
                        if (this.bloodHistorySearch.startDate) {
                            url += `&start_date=${this.bloodHistorySearch.startDate}`;
                        }
                        if (this.bloodHistorySearch.endDate) {
                            url += `&end_date=${this.bloodHistorySearch.endDate}`;
                        }
                        if (this.bloodHistorySearch.bloodType) {
                            url += `&blood_type=${this.bloodHistorySearch.bloodType}`;
                        }
                        if (this.bloodHistorySearch.eventType) {
                            url += `&event_type=${this.bloodHistorySearch.eventType}`;
                        }

                        const response = await fetch(url);
                        const data = await response.json();

                        if (data.status === 'success') {
                            this.bloodHistory = data.data || [];
                        } else {
                            this.toast('ËºâÂÖ•Ë°ÄÂ∫´Ê≠∑Âè≤Ë®òÈåÑÂ§±Êïó', 'error');
                        }
                    } catch (error) {
                        console.error('ËºâÂÖ•Ë°ÄÂ∫´Ê≠∑Âè≤Ë®òÈåÑÈåØË™§:', error);
                        this.toast('ËºâÂÖ•Ë°ÄÂ∫´Ê≠∑Âè≤Ë®òÈåÑÈåØË™§', 'error');
                    }
                },

                // Êü•ÁúãË°ÄÊ∂≤Ë®òÈåÑË©≥ÊÉÖ
                viewBloodDetail(record) {
                    this.selectedBloodRecord = record;
                    // ÂèØ‰ª•Êì¥Â±ïÁÇ∫È°ØÁ§∫Ë©≥ÊÉÖ Modal
                    let detailText = `
=== Ë°ÄÂ∫´Ë®òÈåÑË©≥ÊÉÖ ===
È°ûÂûã: ${record.event_type === 'RECEIVE' ? 'ÂÖ•Â∫´' : 'Âá∫Â∫´'}
Ë°ÄÂûã: ${record.blood_type}
Êï∏Èáè: ${record.quantity} U
ÊôÇÈñì: ${new Date(record.timestamp).toLocaleString('zh-TW')}
Êìç‰ΩúÂì°: ${record.operator}
ÂÇôË®ª: ${record.remarks || 'ÁÑ°'}
`;

                    // Â¶ÇÊûúÊúâÊçêË°ÄËÄÖË≥áË®äÔºàWalking Blood BankÔºâ
                    if (record.donor_name || record.donor_phone) {
                        detailText += `\n--- Á∑äÊÄ•ÊçêË°ÄËÄÖË≥áË®ä ---\n`;
                        if (record.donor_name) detailText += `ÂßìÂêç: ${record.donor_name}\n`;
                        if (record.donor_phone) detailText += `ÈõªË©±: ${record.donor_phone}\n`;
                    }

                    // Â¶ÇÊûúÊúâÁóÖÊÇ£Ë≥áË®äÔºàÂá∫Â∫´Ë®òÈåÑÔºâ
                    if (record.patient_name) {
                        detailText += `\n--- ÁóÖÊÇ£Ë≥áË®ä ---\n`;
                        detailText += `ÂßìÂêç: ${record.patient_name}\n`;
                        if (record.patient_id) detailText += `ÁóÖÊ≠∑Ëôü: ${record.patient_id}\n`;
                        if (record.diagnosis) detailText += `Ë®∫Êñ∑: ${record.diagnosis}\n`;
                    }

                    alert(detailText);
                },

                // ÂåØÂá∫Ë°ÄÂ∫´Ê≠∑Âè≤Ë®òÈåÑ CSV
                exportBloodHistoryCSV() {
                    let url = `${this.apiUrl}/blood/events/export/csv?station_id=${this.stationId}`;

                    if (this.bloodHistorySearch.startDate) {
                        url += `&start_date=${this.bloodHistorySearch.startDate}`;
                    }
                    if (this.bloodHistorySearch.endDate) {
                        url += `&end_date=${this.bloodHistorySearch.endDate}`;
                    }
                    if (this.bloodHistorySearch.bloodType) {
                        url += `&blood_type=${this.bloodHistorySearch.bloodType}`;
                    }
                    if (this.bloodHistorySearch.eventType) {
                        url += `&event_type=${this.bloodHistorySearch.eventType}`;
                    }

                    window.open(url, '_blank');
                    this.toast('Ë°ÄÂ∫´Ë®òÈåÑÂåØÂá∫ÊàêÂäü', 'success');
                },

                // ========== Â∫´Â≠òÁõ§ÈªûÊ†∏Â∞çË®òÈåÑ (v0.7) ==========
                async loadInventoryCheckHistory() {
                    try {
                        let url = `${this.apiUrl}/inventory-check/history`;
                        const params = [];

                        if (this.inventoryCheckSearch.startDate) {
                            params.push(`from_date=${this.inventoryCheckSearch.startDate}`);
                        }
                        if (this.inventoryCheckSearch.endDate) {
                            params.push(`to_date=${this.inventoryCheckSearch.endDate}`);
                        }
                        if (this.inventoryCheckSearch.status) {
                            params.push(`status=${this.inventoryCheckSearch.status}`);
                        }
                        if (params.length > 0) {
                            url += '?' + params.join('&');
                        }

                        const response = await fetch(url);
                        if (response.ok) {
                            const data = await response.json();
                            this.inventoryCheckHistory = data.checks || [];

                            // Ë®àÁÆóÁµ±Ë®à
                            this.inventoryCheckStats = {
                                totalChecks: this.inventoryCheckHistory.length,
                                totalConfirmed: this.inventoryCheckHistory.reduce((sum, c) => sum + (c.confirmed_count || 0), 0),
                                totalErrors: this.inventoryCheckHistory.reduce((sum, c) => sum + (c.error_count || 0), 0),
                                pendingErrors: this.inventoryCheckHistory.reduce((sum, c) => sum + (c.errors_pending || 0), 0)
                            };

                            console.log('‚úì Áõ§ÈªûË®òÈåÑÂ∑≤ËºâÂÖ•:', this.inventoryCheckHistory.length, 'Á≠Ü');
                        } else {
                            // API Â∞öÊú™ÂØ¶‰ΩúÊôÇ‰ΩøÁî®Ê®°Êì¨Ë≥áÊñô
                            console.log('Áõ§ÈªûË®òÈåÑ API Â∞öÊú™ÂØ¶‰ΩúÔºå‰ΩøÁî®Êú¨Âú∞Ë®òÈåÑ');
                            this.loadLocalInventoryChecks();
                        }
                    } catch (error) {
                        console.error('ËºâÂÖ•Áõ§ÈªûË®òÈåÑÂ§±Êïó:', error);
                        this.loadLocalInventoryChecks();
                    }
                },

                loadLocalInventoryChecks() {
                    // Âæû localStorage ËºâÂÖ•Êú¨Âú∞Êö´Â≠òÁöÑÁõ§ÈªûË®òÈåÑ
                    const saved = localStorage.getItem('mirs_inventory_check_history');
                    if (saved) {
                        try {
                            this.inventoryCheckHistory = JSON.parse(saved);
                            this.inventoryCheckStats = {
                                totalChecks: this.inventoryCheckHistory.length,
                                totalConfirmed: this.inventoryCheckHistory.reduce((sum, c) => sum + (c.confirmed_count || 0), 0),
                                totalErrors: this.inventoryCheckHistory.reduce((sum, c) => sum + (c.error_count || 0), 0),
                                pendingErrors: this.inventoryCheckHistory.reduce((sum, c) => sum + (c.errors_pending || 0), 0)
                            };
                        } catch (e) {
                            this.inventoryCheckHistory = [];
                        }
                    } else {
                        this.inventoryCheckHistory = [];
                        this.inventoryCheckStats = { totalChecks: 0, totalConfirmed: 0, totalErrors: 0, pendingErrors: 0 };
                    }
                },

                viewInventoryCheckDetail(check) {
                    this.selectedInventoryCheck = check;
                    this.showInventoryCheckDetailModal = true;
                },

                async resolveInventoryError(checkId, itemCode) {
                    const notes = prompt('Ë´ãËº∏ÂÖ•ËôïÁêÜË™™ÊòéÔºö');
                    if (notes === null) return;

                    try {
                        const response = await fetch(`${this.apiUrl}/inventory-check/resolve-error`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                check_id: checkId,
                                item_code: itemCode,
                                resolution: 'ADJUSTED',
                                resolver_name: this.currentUser || 'Admin',
                                notes: notes || 'Â∑≤ËôïÁêÜ'
                            })
                        });

                        if (response.ok) {
                            this.toast('ÈåØË™§È†ÖÁõÆÂ∑≤ËôïÁêÜ', 'success');
                            // Êõ¥Êñ∞Êú¨Âú∞ÁãÄÊÖã
                            if (this.selectedInventoryCheck?.errors) {
                                const error = this.selectedInventoryCheck.errors.find(e => e.item_code === itemCode);
                                if (error) error.resolved = true;
                            }
                            await this.loadInventoryCheckHistory();
                        } else {
                            // API Â∞öÊú™ÂØ¶‰ΩúÊôÇÔºåÁõ¥Êé•Êõ¥Êñ∞Êú¨Âú∞ÁãÄÊÖã
                            if (this.selectedInventoryCheck?.errors) {
                                const error = this.selectedInventoryCheck.errors.find(e => e.item_code === itemCode);
                                if (error) error.resolved = true;
                            }
                            this.toast('ÈåØË™§È†ÖÁõÆÂ∑≤Ê®ôË®òËôïÁêÜÔºàÊú¨Âú∞Ôºâ', 'success');
                        }
                    } catch (error) {
                        console.error('ËôïÁêÜÈåØË™§Â§±Êïó:', error);
                        // Êú¨Âú∞ËôïÁêÜ
                        if (this.selectedInventoryCheck?.errors) {
                            const error = this.selectedInventoryCheck.errors.find(e => e.item_code === itemCode);
                            if (error) error.resolved = true;
                        }
                        this.toast('ÈåØË™§È†ÖÁõÆÂ∑≤Ê®ôË®òËôïÁêÜÔºàÊú¨Âú∞Ôºâ', 'info');
                    }
                },

                exportInventoryCheckCSV() {
                    let url = `${this.apiUrl}/inventory-check/export/csv?station_id=${this.stationId}`;

                    if (this.inventoryCheckSearch.startDate) {
                        url += `&from_date=${this.inventoryCheckSearch.startDate}`;
                    }
                    if (this.inventoryCheckSearch.endDate) {
                        url += `&to_date=${this.inventoryCheckSearch.endDate}`;
                    }

                    window.open(url, '_blank');
                    this.toast('Áõ§ÈªûË®òÈåÑÂåØÂá∫ÊàêÂäü', 'success');
                },

                // ÂåØÂá∫Ê∂àËÄóË®òÈåÑ
                exportConsumeHistoryCSV() {
                    let url = `${this.apiUrl}/inventory/events/export/csv?event_type=CONSUME`;

                    if (this.consumeHistorySearch.startDate) {
                        url += `&start_date=${this.consumeHistorySearch.startDate}`;
                    }
                    if (this.consumeHistorySearch.endDate) {
                        url += `&end_date=${this.consumeHistorySearch.endDate}`;
                    }

                    window.open(url, '_blank');
                    this.toast('Ê∂àËÄóË®òÈåÑÂåØÂá∫ÊàêÂäü', 'success');
                },

                // Ë°ÄË¢ã
                async loadBloodInventory() {
                    try {
                        // Add cache busting for Safari
                        const timestamp = new Date().getTime();
                        const response = await fetch(`${this.apiUrl}/blood/inventory?_t=${timestamp}`, {
                            cache: 'no-cache',
                            headers: {
                                'Cache-Control': 'no-cache',
                                'Pragma': 'no-cache'
                            }
                        });
                        if (response.ok) {
                            const data = await response.json();
                            console.log('API Response:', data);
                            console.log('Current station:', this.stationId);

                            // Filter by current station only
                            const stationBlood = data.bloodInventory.filter(b => b.station_id === this.stationId);
                            console.log('Filtered blood for station:', stationBlood);

                            // Ensure all blood types are present with at least 0 quantity
                            const allBloodTypes = ['A+', 'A-', 'B+', 'B-', 'O+', 'O-', 'AB+', 'AB-'];
                            this.bloodInventory = allBloodTypes.map(type => {
                                const existing = stationBlood.find(b => b.blood_type === type);
                                return existing || {
                                    blood_type: type,
                                    quantity: 0,
                                    station_id: this.stationId
                                };
                            });

                            console.log('‚úì Ë°ÄË¢ãÂ∫´Â≠òÂ∑≤ËºâÂÖ•:', this.bloodInventory.length, 'Á≠Ü', `(Á´ôÈªû: ${this.stationId})`);
                            console.log('Blood inventory array:', JSON.stringify(this.bloodInventory));

                            // Force Alpine.js to reactively update
                            this.$nextTick(() => {
                                console.log('Next tick - blood inventory updated');
                            });
                        } else {
                            console.error('Ë°ÄË¢ãÂ∫´Â≠òAPIÈåØË™§:', response.status);
                        }
                    } catch (error) {
                        console.error('ËºâÂÖ•Ë°ÄË¢ãÂ∫´Â≠òÂ§±Êïó:', error);
                    }
                },

                async submitBloodReceive() {
                    try {
                        const response = await fetch(`${this.apiUrl}/blood/receive`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(this.bloodReceiveForm)
                        });

                        const data = await response.json();

                        if (response.ok) {
                            this.toast(data.message || 'Ë°ÄË¢ãÂÖ•Â∫´ÊàêÂäü', 'success');
                            this.bloodReceiveForm = {
                                bloodType: '',
                                quantity: 1,
                                remarks: '',
                                source: 'blood_center',
                                donorName: '',
                                donorPhone: '',
                                stationId: this.stationId
                            };
                            await this.loadBloodInventory();
                            await this.loadStats();
                        } else {
                            this.toast(data.detail || 'ÂÖ•Â∫´Â§±Êïó', 'error');
                        }
                    } catch (error) {
                        console.error('Ë°ÄË¢ãÂÖ•Â∫´Â§±Êïó:', error);
                        this.toast('Ë°ÄË¢ãÂÖ•Â∫´Â§±Êïó', 'error');
                    }
                },

                printBloodLabel() {
                    // Ê™¢Êü•ÂøÖÂ°´Ê¨Ñ‰Ωç
                    if (!this.bloodReceiveForm.bloodType) {
                        this.toast('Ë´ãÈÅ∏ÊìáË°ÄÂûã', 'error');
                        return;
                    }
                    if (!this.bloodReceiveForm.quantity || this.bloodReceiveForm.quantity < 1) {
                        this.toast('Ë´ãËº∏ÂÖ•ÊúâÊïàÊï∏Èáè', 'error');
                        return;
                    }

                    // ÊßãÂª∫URLÂèÉÊï∏
                    const params = new URLSearchParams({
                        blood_type: this.bloodReceiveForm.bloodType,
                        quantity: this.bloodReceiveForm.quantity,
                        station_id: this.stationId,
                        remarks: this.bloodReceiveForm.remarks || ''
                    });

                    // ÈñãÂïüÂàóÂç∞Ê®ôÁ±§È†ÅÈù¢
                    window.open(`${this.apiUrl}/blood/label?${params.toString()}`, '_blank');
                    this.toast('Ê≠£Âú®ÈñãÂïüÊ®ôÁ±§ÂàóÂç∞...', 'info');
                },

                printBloodLabelFromHistory(record) {
                    // ÂæûÊ≠∑Âè≤Ë®òÈåÑÂàóÂç∞Ê®ôÁ±§
                    const params = new URLSearchParams({
                        blood_type: record.blood_type,
                        quantity: Math.abs(record.quantity),
                        station_id: record.station_id,
                        remarks: record.remarks || ''
                    });

                    // ÈñãÂïüÂàóÂç∞Ê®ôÁ±§È†ÅÈù¢
                    window.open(`${this.apiUrl}/blood/label?${params.toString()}`, '_blank');
                    this.toast('Ê≠£Âú®ÈñãÂïüÊ®ôÁ±§ÂàóÂç∞...', 'info');
                },

                async submitBloodConsume() {
                    // v1.4.2-plus: ÊîπÁÇ∫ÈñãÂïüË°ÄË¢ãÈÅ∏ÊìáÊ®°ÊÖãÁ™ó
                    if (!this.bloodConsumeForm.bloodType) {
                        this.toast('Ë´ãÈÅ∏ÊìáË°ÄÂûã', 'error');
                        return;
                    }
                    if (!this.bloodConsumeForm.patientName) {
                        this.toast('Ë´ãËº∏ÂÖ•ÁóÖÊÇ£ÂßìÂêç', 'error');
                        return;
                    }

                    // ËºâÂÖ•Ë©≤Ë°ÄÂûãÁöÑÂèØÁî®Ë°ÄË¢ã
                    try {
                        const response = await fetch(`${this.apiUrl}/blood-bags/list?blood_type=${encodeURIComponent(this.bloodConsumeForm.bloodType)}&status=AVAILABLE`);
                        if (response.ok) {
                            const data = await response.json();
                            this.availableBagsForConsume = data.bags || [];
                            this.selectedBagsForConsume = [];
                            this.showBloodBagSelectModal = true;
                        } else {
                            this.toast('ÁÑ°Ê≥ïËºâÂÖ•Ë°ÄË¢ãÂàóË°®', 'error');
                        }
                    } catch (error) {
                        console.error('ËºâÂÖ•Ë°ÄË¢ãÂ§±Êïó:', error);
                        this.toast('ËºâÂÖ•Ë°ÄË¢ãÂ§±Êïó', 'error');
                    }
                },

                async confirmBloodBagConsume() {
                    // v1.4.2-plus: Á¢∫Ë™çÂá∫Â∫´ÈÅ∏‰∏≠ÁöÑË°ÄË¢ã
                    if (this.selectedBagsForConsume.length === 0) {
                        this.toast('Ë´ãÈÅ∏ÊìáË¶ÅÂá∫Â∫´ÁöÑË°ÄË¢ã', 'error');
                        return;
                    }

                    try {
                        const response = await fetch(`${this.apiUrl}/blood-bags/consume`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                bagCodes: this.selectedBagsForConsume,
                                patientName: this.bloodConsumeForm.patientName,
                                patientId: this.bloodConsumeForm.patientId || '',
                                purpose: this.bloodConsumeForm.purpose || '',
                                stationId: this.bloodConsumeForm.stationId
                            })
                        });

                        const data = await response.json();

                        if (response.ok) {
                            this.toast(data.message || `ÊàêÂäüÂá∫Â∫´ ${this.selectedBagsForConsume.length} Ë¢ãË°ÄË¢ã`, 'success');
                            this.showBloodBagSelectModal = false;
                            this.bloodConsumeForm = { bloodType: '', quantity: 1, patientName: '', patientId: '', purpose: '', stationId: this.stationId };
                            this.selectedBagsForConsume = [];
                            await this.loadBloodInventory();
                            await this.loadBloodBags();
                            await this.loadStats();
                        } else {
                            this.toast(data.detail || 'Âá∫Â∫´Â§±Êïó', 'error');
                        }
                    } catch (error) {
                        console.error('Ë°ÄË¢ãÂá∫Â∫´Â§±Êïó:', error);
                        this.toast('Ë°ÄË¢ãÂá∫Â∫´Â§±Êïó', 'error');
                    }
                },

                async submitBloodTransfer() {
                    try {
                        // È©óË≠âÂøÖÂ°´Ê¨Ñ‰Ωç
                        if (!this.bloodTransferForm.sourceStationId || !this.bloodTransferForm.targetStationId) {
                            this.toast('Ë´ãËº∏ÂÖ•‰æÜÊ∫êÁ´ôÈªûÂíåÁõÆÊ®ôÁ´ôÈªû', 'error');
                            return;
                        }
                        if (this.bloodTransferForm.sourceStationId === this.bloodTransferForm.targetStationId) {
                            this.toast('‰æÜÊ∫êÁ´ôÈªûËàáÁõÆÊ®ôÁ´ôÈªû‰∏çËÉΩÁõ∏Âêå', 'error');
                            return;
                        }
                        if (!this.bloodTransferForm.bloodType) {
                            this.toast('Ë´ãÈÅ∏ÊìáË°ÄÂûã', 'error');
                            return;
                        }

                        const response = await fetch(`${this.apiUrl}/blood/transfer`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(this.bloodTransferForm)
                        });

                        const data = await response.json();

                        if (response.ok) {
                            this.toast(data.message || 'Ë°ÄË¢ãËΩâÁßªÊàêÂäü', 'success');
                            // ÈáçÁΩÆË°®ÂñÆ
                            this.bloodTransferForm = {
                                sourceStationId: 'HC-000000',
                                targetStationId: '',
                                bloodType: '',
                                quantity: 1,
                                operator: 'SYSTEM',
                                remarks: ''
                            };
                            await this.loadBloodInventory();
                            await this.loadStats();
                        } else {
                            this.toast(data.detail || 'ËΩâÁßªÂ§±Êïó', 'error');
                        }
                    } catch (error) {
                        console.error('Ë°ÄË¢ãÁ´ôÈªûËΩâÁßªÂ§±Êïó:', error);
                        this.toast('Ë°ÄË¢ãÁ´ôÈªûËΩâÁßªÂ§±Êïó', 'error');
                    }
                },

                // ========== ÂÄãÂà•Ë°ÄË¢ãËøΩËπ§ (v1.4.2-plus) ==========
                async loadBloodBags() {
                    try {
                        const response = await fetch(`${this.apiUrl}/blood-bags/list?status=AVAILABLE`);
                        if (response.ok) {
                            const data = await response.json();
                            this.bloodBags = data.bags || [];
                            console.log('‚úì Ë°ÄË¢ãÂ∑≤ËºâÂÖ•:', this.bloodBags.length, 'Ë¢ã');
                        }
                    } catch (error) {
                        console.error('ËºâÂÖ•Ë°ÄË¢ãÂ§±Êïó:', error);
                    }
                },

                async createBloodBag() {
                    if (!this.bloodBagForm.blood_type) {
                        this.toast('Ë´ãÈÅ∏ÊìáË°ÄÂûã', 'error');
                        return;
                    }

                    try {
                        const response = await fetch(`${this.apiUrl}/blood-bags/create`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                blood_type: this.bloodBagForm.blood_type,
                                volume_ml: parseInt(this.bloodBagForm.volume_ml) || 250,
                                collection_date: this.bloodBagForm.collection_date || null,
                                expiry_date: this.bloodBagForm.expiry_date || null,
                                donor_info: this.bloodBagForm.donor_info || null
                            })
                        });

                        const data = await response.json();

                        if (response.ok) {
                            this.toast(`Ë°ÄË¢ãÂª∫Á´ãÊàêÂäü: ${data.bag_code}`, 'success');
                            this.bloodBagForm = { blood_type: '', volume_ml: 250, collection_date: '', expiry_date: '', donor_info: '' };
                            await this.loadBloodBags();
                            await this.loadBloodInventory();
                            await this.loadStats();
                        } else {
                            this.toast(data.detail || 'Âª∫Á´ãÂ§±Êïó', 'error');
                        }
                    } catch (error) {
                        console.error('Âª∫Á´ãË°ÄË¢ãÂ§±Êïó:', error);
                        this.toast('Âª∫Á´ãË°ÄË¢ãÂ§±Êïó', 'error');
                    }
                },

                async useBloodBag(bagCode) {
                    const patientName = prompt('Ë´ãËº∏ÂÖ•‰ΩøÁî®ËÄÖ/ÁóÖÊÇ£ÂßìÂêç:');
                    if (!patientName) return;

                    try {
                        const response = await fetch(`${this.apiUrl}/blood-bags/use`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                bagCode: bagCode,
                                usedFor: patientName
                            })
                        });

                        const data = await response.json();

                        if (response.ok) {
                            this.toast(data.message || 'Ë°ÄË¢ãÂ∑≤Ê®ôË®òÁÇ∫‰ΩøÁî®', 'success');
                            await this.loadBloodBags();
                            await this.loadBloodInventory();
                            await this.loadStats();
                        } else {
                            this.toast(data.detail || 'Êìç‰ΩúÂ§±Êïó', 'error');
                        }
                    } catch (error) {
                        console.error('‰ΩøÁî®Ë°ÄË¢ãÂ§±Êïó:', error);
                        this.toast('‰ΩøÁî®Ë°ÄË¢ãÂ§±Êïó', 'error');
                    }
                },

                async discardBloodBag(bagCode) {
                    const reasons = ['expired (ÈÅéÊúü)', 'damaged (ÊêçÂ£û)', 'other (ÂÖ∂‰ªñ)'];
                    const reason = prompt(`Ë´ãÈÅ∏Êìá‰∏üÊ£ÑÂéüÂõ†:\n1. ÈÅéÊúü\n2. ÊêçÂ£û\n3. ÂÖ∂‰ªñ\n\nË´ãËº∏ÂÖ• 1, 2, Êàñ 3:`);

                    if (!reason) return;

                    let reasonCode = 'other';
                    if (reason === '1') reasonCode = 'expired';
                    else if (reason === '2') reasonCode = 'damaged';
                    else if (reason === '3') reasonCode = 'other';

                    if (!confirm(`Á¢∫ÂÆöË¶Å‰∏üÊ£ÑË°ÄË¢ã ${bagCode} ÂóéÔºü\nÂéüÂõ†: ${reasonCode}\n\nÊ≠§Êìç‰ΩúÁÑ°Ê≥ïÂæ©ÂéüÔºÅ`)) return;

                    try {
                        const response = await fetch(`${this.apiUrl}/blood-bags/discard`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                bagCode: bagCode,
                                reason: reasonCode
                            })
                        });

                        const data = await response.json();

                        if (response.ok) {
                            this.toast(data.message || 'Ë°ÄË¢ãÂ∑≤Ê®ôË®òÁÇ∫‰∏üÊ£Ñ', 'success');
                            await this.loadBloodBags();
                            await this.loadBloodInventory();
                            await this.loadStats();
                        } else {
                            this.toast(data.detail || 'Êìç‰ΩúÂ§±Êïó', 'error');
                        }
                    } catch (error) {
                        console.error('‰∏üÊ£ÑË°ÄË¢ãÂ§±Êïó:', error);
                        this.toast('‰∏üÊ£ÑË°ÄË¢ãÂ§±Êïó', 'error');
                    }
                },

                printSingleBagLabel(bagCode) {
                    window.open(`${this.apiUrl}/blood-bags/print-labels/${bagCode}`, '_blank');
                    this.toast('Ê≠£Âú®ÈñãÂïüÊ®ôÁ±§ÂàóÂç∞...', 'info');
                },

                printSelectedBagLabels() {
                    if (this.selectedBagCodes.length === 0) {
                        this.toast('Ë´ãÂÖàÈÅ∏ÊìáË°ÄË¢ã', 'error');
                        return;
                    }
                    const codes = this.selectedBagCodes.join(',');
                    window.open(`${this.apiUrl}/blood-bags/print-labels/${codes}`, '_blank');
                    this.toast(`Ê≠£Âú®ÂàóÂç∞ ${this.selectedBagCodes.length} Ë¢ãÊ®ôÁ±§...`, 'info');
                    this.selectedBagCodes = [];
                },

                toggleAllBags(checked) {
                    if (checked) {
                        this.selectedBagCodes = this.bloodBags.filter(b => b.status === 'AVAILABLE').map(b => b.bag_code);
                    } else {
                        this.selectedBagCodes = [];
                    }
                },

                async checkExpiringBags() {
                    try {
                        const response = await fetch(`${this.apiUrl}/blood-bags/expiring?days=7`);
                        if (response.ok) {
                            const data = await response.json();
                            const expiring = data.expiring_bags || [];
                            if (expiring.length === 0) {
                                this.toast('ÁõÆÂâçÁÑ°Âç≥Â∞áÈÅéÊúüÁöÑË°ÄË¢ã', 'info');
                            } else {
                                alert(`Âç≥ÊúüË°ÄË¢ãË≠¶Á§∫ (7Â§©ÂÖß):\n\n${expiring.map(b => `${b.bag_code} (${b.blood_type}) - ÊïàÊúü: ${b.expiry_date}`).join('\n')}`);
                            }
                        }
                    } catch (error) {
                        console.error('Ê™¢Êü•Âç≥ÊúüË°ÄË¢ãÂ§±Êïó:', error);
                    }
                },

                isExpiringSoon(expiryDate) {
                    if (!expiryDate) return false;
                    const expiry = new Date(expiryDate);
                    const now = new Date();
                    const diffDays = (expiry - now) / (1000 * 60 * 60 * 24);
                    return diffDays <= 7 && diffDays >= 0;  // 7Â§©ÂÖßÂç≥Â∞áÈÅéÊúü
                },

                isExpired(expiryDate) {
                    if (!expiryDate) return false;
                    const expiry = new Date(expiryDate);
                    const now = new Date();
                    return expiry < now;  // Â∑≤ÈÅéÊúü
                },

                // ========== Ë®≠ÂÇôÁÆ°ÁêÜ (v2 API) ==========
                async loadEquipment() {
                    try {
                        // v2 API: ‰ΩøÁî® v_equipment_status View ËÅöÂêàË≥áÊñô
                        const response = await fetch(`${this.apiUrl}/v2/equipment`);
                        if (response.ok) {
                            const data = await response.json();
                            // v2 API returns: { equipment: [...], count: n }
                            // Each equipment has: id, name, type_code, type_name, category,
                            // resilience_category, unit_count, avg_level, checked_count, last_check, check_status
                            this.equipment = data.equipment.map(eq => ({
                                ...eq,
                                // v2 ‚Üí v1 field mapping for template compatibility
                                quantity: eq.unit_count,
                                power_level: eq.avg_level,
                                status: this.mapCheckStatusToLegacy(eq.check_status)
                            }));
                            console.log('‚úì Ë®≠ÂÇôÂ∑≤ËºâÂÖ• (v2 API):', this.equipment.length, 'È†Ö');
                            // ÈáçÊñ∞ËºâÂÖ•Áµ±Ë®àÊï∏Êìö‰ª•Êõ¥Êñ∞ÂæÖÊ™¢Êü•Ë®≠ÂÇôÊï∏Èáè
                            await this.loadStats();
                        } else {
                            console.error('Ë®≠ÂÇôAPIÈåØË™§:', response.status);
                            this.toast('ËºâÂÖ•Ë®≠ÂÇôÂ§±Êïó', 'error');
                        }
                    } catch (error) {
                        console.error('ËºâÂÖ•Ë®≠ÂÇôÂ§±Êïó:', error);
                        this.toast('ËºâÂÖ•Ë®≠ÂÇôÂ§±Êïó', 'error');
                    }
                },

                // v2: Â∞á check_status Êò†Â∞ÑÂà∞ËàäÁâà status È°ØÁ§∫
                mapCheckStatusToLegacy(checkStatus) {
                    const mapping = {
                        'CHECKED': 'NORMAL',
                        'PARTIAL': 'WARNING',
                        'UNCHECKED': 'UNCHECKED'
                    };
                    return mapping[checkStatus] || 'UNCHECKED';
                },

                async submitAddEquipment() {
                    try {
                        // Ensure station_id is set
                        const equipmentData = {
                            ...this.addEquipmentForm,
                            station_id: this.stationId
                        };

                        const response = await fetch(`${this.apiUrl}/equipment`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(equipmentData)
                        });
                        
                        const data = await response.json();
                        
                        if (response.ok) {
                            this.toast(data.message || 'Ë®≠ÂÇôÊñ∞Â¢ûÊàêÂäü', 'success');
                            this.showAddEquipmentModal = false;
                            this.resetAddEquipmentForm();
                            await this.loadEquipment();
                            await this.loadStats();
                        } else {
                            this.toast(data.detail || 'Êñ∞Â¢ûÂ§±Êïó', 'error');
                        }
                    } catch (error) {
                        console.error('Êñ∞Â¢ûË®≠ÂÇôÂ§±Êïó:', error);
                        this.toast('Êñ∞Â¢ûË®≠ÂÇôÂ§±Êïó', 'error');
                    }
                },

                resetAddEquipmentForm() {
                    this.addEquipmentForm = {
                        name: '',
                        category: 'ÂÖ∂‰ªñ',
                        quantity: 1,
                        remarks: ''
                    };
                },

                editEquipment(eq) {
                    this.editEquipmentForm = {
                        id: eq.id,
                        name: eq.name,
                        category: eq.category,
                        quantity: eq.quantity,
                        remarks: eq.remarks || ''
                    };
                    this.showEditEquipmentModal = true;
                },

                async submitEditEquipment() {
                    try {
                        const response = await fetch(`${this.apiUrl}/equipment/${this.editEquipmentForm.id}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                name: this.editEquipmentForm.name,
                                category: this.editEquipmentForm.category,
                                quantity: this.editEquipmentForm.quantity,
                                remarks: this.editEquipmentForm.remarks
                            })
                        });
                        
                        const data = await response.json();
                        
                        if (response.ok) {
                            this.toast(data.message || 'Ë®≠ÂÇôÊõ¥Êñ∞ÊàêÂäü', 'success');
                            this.showEditEquipmentModal = false;
                            await this.loadEquipment();
                        } else {
                            this.toast(data.detail || 'Êõ¥Êñ∞Â§±Êïó', 'error');
                        }
                    } catch (error) {
                        console.error('Êõ¥Êñ∞Ë®≠ÂÇôÂ§±Êïó:', error);
                        this.toast('Êõ¥Êñ∞Ë®≠ÂÇôÂ§±Êïó', 'error');
                    }
                },

                async deleteEquipment(id, name) {
                    if (!confirm(`Á¢∫ÂÆöË¶ÅÂà™Èô§Ë®≠ÂÇô„Äå${name}„ÄçÂóé?`)) return;
                    
                    try {
                        const response = await fetch(`${this.apiUrl}/equipment/${id}`, {
                            method: 'DELETE'
                        });
                        
                        const data = await response.json();
                        
                        if (response.ok) {
                            this.toast(data.message || 'Ë®≠ÂÇôÂ∑≤Âà™Èô§', 'success');
                            await this.loadEquipment();
                            await this.loadStats();
                        } else {
                            this.toast(data.detail || 'Âà™Èô§Â§±Êïó', 'error');
                        }
                    } catch (error) {
                        console.error('Âà™Èô§Ë®≠ÂÇôÂ§±Êïó:', error);
                        this.toast('Âà™Èô§Ë®≠ÂÇôÂ§±Êïó', 'error');
                    }
                },

                // Ë®≠ÂÇôÊåáÊ®ôÊ®ôÁ±§ (Ê†πÊìöË®≠ÂÇôÈ°ûÂûãÈ°ØÁ§∫‰∏çÂêåÊ®ôÁ±§)
                getEquipmentMetricLabel(equipmentId) {
                    const labels = {
                        'RESP-001': 'Ê∞£È´îÂ≠òÈáè (0-100%)',      // Ê∞ßÊ∞£ÈãºÁì∂
                        'EMER-EQ-006': 'Ê∞£È´îÂ≠òÈáè (0-100%)',   // Ê∞ßÊ∞£Áì∂ E size
                        'UTIL-002': 'ÁáÉÊ≤πÂ≠òÈáè (0-100%)',      // ÁôºÈõªÊ©ü
                        'UTIL-001': 'ÈõªÊ±†ÈõªÈáè (0-100%)',      // Ë°åÂãïÈõªÊ∫êÁ´ô
                        'EQ-010': 'ÈõªÊ±†ÈõªÈáè (0-100%)',        // Ë°åÂãïÈõªÊ∫êÁ´ô
                        'EMER-EQ-001': 'ÈõªÊ±†ÈõªÈáè (0-100%)',   // AED
                    };
                    return labels[equipmentId] || 'ÁãÄÊÖãÁ≠âÁ¥ö (0-100%)';
                },

                // Âà§Êñ∑ÊòØÂê¶ÁÇ∫ÈüåÊÄßÁõ∏ÈóúË®≠ÂÇô
                isResilienceEquipment(equipmentId) {
                    const resilienceEquipment = [
                        'RESP-001', 'RESP-002', 'EMER-EQ-006',  // Ê∞ßÊ∞£Áõ∏Èóú
                        'UTIL-001', 'UTIL-002', 'EQ-010'         // ÈõªÂäõÁõ∏Èóú
                    ];
                    return resilienceEquipment.includes(equipmentId);
                },

                // Ë®àÁÆóË®≠ÂÇôÈüåÊÄßË≤¢ÁçªÊôÇÊï∏
                calculateEquipmentHours(equipmentId, level) {
                    const capacity = {
                        'RESP-001': { hours: 20, label: 'Ê∞ßÊ∞£' },       // Ê∞ßÊ∞£ÈãºÁì∂: 100% = 20h
                        'EMER-EQ-006': { hours: 2.3, label: 'Ê∞ßÊ∞£' },   // Ê∞ßÊ∞£Áì∂E: 100% = 2.3h
                        'UTIL-002': { hours: 24, label: 'ÈõªÂäõ' },       // ÁôºÈõªÊ©ü: 100% = 24h
                        'UTIL-001': { hours: 20, label: 'ÈõªÂäõ' },       // Ë°åÂãïÈõªÊ∫êÁ´ô: 100% = 20h
                        'EQ-010': { hours: 20, label: 'ÈõªÂäõ' }          // Ë°åÂãïÈõªÊ∫êÁ´ô: 100% = 20h
                    };
                    const config = capacity[equipmentId];
                    if (!config || !level) return 0;
                    return (level / 100 * config.hours).toFixed(1);
                },

                // ÂèñÂæóÈüåÊÄßË®≠ÂÇôÊ∏ÖÂñÆ (Áî®ÊñºÈüåÊÄß‰º∞ÁÆóTabÈ°ØÁ§∫)
                getResilienceEquipment() {
                    const resilienceIds = ['RESP-001', 'RESP-002', 'EMER-EQ-006', 'UTIL-001', 'UTIL-002', 'EQ-010'];
                    return this.equipment.filter(eq => resilienceIds.includes(eq.id));
                },

                // Ë®àÁÆóË®≠ÂÇôÈüåÊÄßÊôÇÊï∏ (Áî®ÊñºÈüåÊÄß‰º∞ÁÆóTabÈ°ØÁ§∫)
                getResilienceHours(eq) {
                    const hours = this.calculateEquipmentHours(eq.id, eq.power_level);
                    return hours > 0 ? hours : null;
                },

                // v1.2.6: ÂèñÂæóÈõªÂäõÂçÄÁãÄÊÖã
                getPowerStatus() {
                    const powerLifeline = (this.resilienceStatus.lifelines || []).find(l => l.type === 'POWER');
                    return powerLifeline?.status || 'UNKNOWN';
                },

                // v1.2.6: ÂèñÂæóÈõªÂäõÂçÄÊôÇÊï∏
                getPowerHours() {
                    const powerLifeline = (this.resilienceStatus.lifelines || []).find(l => l.type === 'POWER');
                    return powerLifeline?.endurance?.effective_hours || 0;
                },

                // v1.2.6: ÂèñÂæóÊ∞ßÊ∞£ÂçÄÁãÄÊÖã (ÂèñÊúÄÂö¥ÈáçÁöÑ)
                getOxygenStatus() {
                    const oxygenLifelines = (this.resilienceStatus.lifelines || []).filter(l => l.type === 'OXYGEN');
                    if (oxygenLifelines.some(l => l.status === 'CRITICAL')) return 'CRITICAL';
                    if (oxygenLifelines.some(l => l.status === 'WARNING')) return 'WARNING';
                    if (oxygenLifelines.some(l => l.status === 'SAFE')) return 'SAFE';
                    return 'UNKNOWN';
                },

                // v1.2.6: ÂèñÂæóÊ∞ßÊ∞£ÂçÄÊôÇÊï∏
                // v1.4.8: ‰øÆÊ≠£ÈÇèËºØ - ÊéíÈô§Âèó‰æùË≥¥ÈôêÂà∂ÁöÑ‰æÜÊ∫êÔºàÂ¶ÇÊøÉÁ∏ÆÊ©üÂèóÈõªÂäõÈôêÂà∂Ôºâ
                //         Ê∞ßÊ∞£ÈãºÁì∂ÊòØÁç®Á´ã‰æÜÊ∫êÔºåÊáâÈ°ØÁ§∫ÂÖ∂ÊôÇÊï∏
                getOxygenHours() {
                    const oxygenLifelines = (this.resilienceStatus.lifelines || []).filter(l => l.type === 'OXYGEN');
                    // Âè™ÂèñÁç®Á´ã‰æÜÊ∫êÔºàÊ≤íÊúâ dependency Êàñ dependency.is_limiting ÁÇ∫ falseÔºâ
                    const independentHours = oxygenLifelines
                        .filter(l => !l.dependency || !l.dependency.is_limiting)
                        .map(l => l.endurance?.effective_hours)
                        .filter(h => h !== '‚àû' && typeof h === 'number');
                    // Â¶ÇÊûúÊúâÁç®Á´ã‰æÜÊ∫êÔºåÂä†Á∏ΩÂÆÉÂÄëÔºõÂê¶ÂâáÂèñÊâÄÊúâ‰æÜÊ∫êÁöÑÊúÄÂ§ßÂÄº
                    if (independentHours.length > 0) {
                        return independentHours.reduce((sum, h) => sum + h, 0);
                    }
                    // Fallback: ÂèñÊúÄÂ§ßÂÄºÔºàÈÅøÂÖç 0Ôºâ
                    const allHours = oxygenLifelines
                        .map(l => l.endurance?.effective_hours)
                        .filter(h => h !== '‚àû' && typeof h === 'number');
                    return allHours.length > 0 ? Math.max(...allHours) : 0;
                },

                // v1.2.7: ÈñãÂïüÂñÆ‰ΩçÁ∑®ËºØ Modal
                openUnitEditModal(item, unit, idx) {
                    // v2: Áõ¥Êé•‰ΩøÁî® item.item_code ‰ΩúÁÇ∫ equipment_id
                    const equipment_id = item.item_code || item.equipment_id || '';

                    this.unitEditForm = {
                        equipment_id: equipment_id,
                        unit_label: unit.label,
                        label: unit.label,
                        level: unit.level_percent ?? unit.level ?? 100,  // v2 Áõ∏ÂÆπ
                        status: unit.status,
                        checked: unit.checked || !!unit.last_check  // v2: Êúâ last_check Ë°®Á§∫Â∑≤Ê™¢Êü•
                    };
                    this.showUnitEditModal = true;
                },

                // v1.2.7: ÂÑ≤Â≠òÂñÆ‰ΩçÁ∑®ËºØ
                async submitUnitEdit() {
                    const payload = {
                        equipment_id: this.unitEditForm.equipment_id,
                        unit_label: this.unitEditForm.unit_label,
                        level_percent: parseInt(this.unitEditForm.level) || 0,
                        status: this.unitEditForm.status || 'AVAILABLE'
                    };
                    console.log('Unit update request:', payload);

                    try {
                        const response = await fetch('/api/equipment/units/update', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (response.ok) {
                            const result = await response.json();
                            this.showUnitEditModal = false;
                            this.toast(`${result.message} (Âπ≥Âùá${result.avg_level}%)`, 'success');

                            // ‰øùÂ≠òÊªæÂãï‰ΩçÁΩÆÂíåÂ±ïÈñãÁãÄÊÖã
                            const scrollY = window.scrollY;
                            const oldExpanded = this.expandedLifeline;

                            // ÈáçÊñ∞ËºâÂÖ•Ë≥áÊñô
                            await this.loadResilienceStatus();
                            await this.loadEquipment();

                            // ÈÅûÂ¢û key Âº∑Âà∂ x-for ÈáçÂª∫ DOM
                            this.lifelinesRefreshKey++;
                            this.equipmentRefreshKey++;

                            // ÊÅ¢Âæ©Â±ïÈñãÁãÄÊÖãÂíåÊªæÂãï‰ΩçÁΩÆ
                            await this.$nextTick();
                            this.expandedLifeline = oldExpanded;
                            window.scrollTo(0, scrollY);
                        } else {
                            const error = await response.json();
                            this.toast(error.detail || 'Êõ¥Êñ∞Â§±Êïó', 'error');
                        }
                    } catch (err) {
                        console.error('Update unit error:', err);
                        this.toast('Êõ¥Êñ∞Â§±Êïó: ' + err.message, 'error');
                    }
                },

                // v1.4.7: ÈñãÂïüÈõªÂäõË®≠ÂÇôÂñÆ‰ΩçÁ∑®ËºØ Modal
                openPowerUnitEditModal(item, unit, idx) {
                    this.powerUnitEditForm = {
                        equipment_id: item.item_code,
                        unit_label: unit.label,
                        label: unit.label,
                        level: unit.level,
                        status: unit.status,
                        device_type: item.device_type,
                        unit: item.unit
                    };
                    this.showPowerUnitEditModal = true;
                },

                // v1.4.7: ÂÑ≤Â≠òÈõªÂäõË®≠ÂÇôÂñÆ‰ΩçÁ∑®ËºØ
                async submitPowerUnitEdit() {
                    try {
                        const response = await fetch('/api/equipment/units/update', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                equipment_id: this.powerUnitEditForm.equipment_id,
                                unit_label: this.powerUnitEditForm.unit_label,
                                level_percent: this.powerUnitEditForm.level,
                                status: this.powerUnitEditForm.status
                            })
                        });

                        if (response.ok) {
                            const result = await response.json();
                            this.showPowerUnitEditModal = false;
                            this.toast(`${result.message} (Âπ≥Âùá${result.avg_level}%)`, 'success');

                            // ‰øùÂ≠òÊªæÂãï‰ΩçÁΩÆÂíåÂ±ïÈñãÁãÄÊÖã
                            const scrollY = window.scrollY;
                            const oldExpanded = this.expandedLifeline;

                            await this.loadResilienceStatus();
                            await this.loadEquipment();
                            this.lifelinesRefreshKey++;
                            this.equipmentRefreshKey++;

                            await this.$nextTick();
                            this.expandedLifeline = oldExpanded;
                            window.scrollTo(0, scrollY);
                        } else {
                            const error = await response.json();
                            this.toast(error.detail || 'Êõ¥Êñ∞Â§±Êïó', 'error');
                        }
                    } catch (err) {
                        console.error('Update power unit error:', err);
                        this.toast('Êõ¥Êñ∞Â§±Êïó: ' + err.message, 'error');
                    }
                },

                // v1.2.8: ÈáçÁΩÆÂñÆ‰ΩçÊ™¢Êü•ÁãÄÊÖã
                async resetUnitCheck() {
                    if (!confirm('Á¢∫ÂÆöË¶ÅÈáçÁΩÆÊ≠§ÂñÆ‰ΩçÁöÑÊ™¢Êü•ÁãÄÊÖãÂóéÔºü')) return;

                    try {
                        const response = await fetch('/api/equipment/units/reset-check', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                equipment_id: this.unitEditForm.equipment_id,
                                unit_label: this.unitEditForm.unit_label
                            })
                        });

                        if (response.ok) {
                            const result = await response.json();
                            this.showUnitEditModal = false;
                            this.toast(result.message, 'success');
                            // v1.2.8: Âº∑Âà∂ÈáçÊñ∞Ê∏≤Êüì - ÂÖàÊî∂ÂêàÂÜçËºâÂÖ•ÂÜçÂ±ïÈñã
                            const currentExpanded = this.expandedLifeline;
                            this.expandedLifeline = null;
                            // ÈáçÊñ∞ËºâÂÖ•ÈüåÊÄßÁãÄÊÖãÂíåË®≠ÂÇôÂàóË°®
                            await this.loadResilienceStatus();
                            await this.loadEquipment();
                            // Âª∂ÈÅ≤ÊÅ¢Âæ©Â±ïÈñãÁãÄÊÖãÁ¢∫‰øù DOM Êõ¥Êñ∞
                            setTimeout(() => {
                                this.expandedLifeline = currentExpanded;
                            }, 100);
                        } else {
                            const error = await response.json();
                            this.toast(error.detail || 'ÈáçÁΩÆÂ§±Êïó', 'error');
                        }
                    } catch (err) {
                        console.error('Reset unit check error:', err);
                        this.toast('ÈáçÁΩÆÂ§±Êïó', 'error');
                    }
                },

                // v1.2.8: ËºâÂÖ•Ê™¢Êü•Â†±Ë°®
                async loadCheckReport() {
                    try {
                        const response = await fetch(`/api/equipment/check-report/${this.checkReportDate}`);
                        if (response.ok) {
                            this.checkReportData = await response.json();
                        }
                    } catch (err) {
                        console.error('Load check report error:', err);
                    }
                },

                // v1.2.8: ÂåØÂá∫Ê™¢Êü•Â†±Ë°® CSV
                exportCheckReportCSV() {
                    if (!this.checkReportData?.records?.length) {
                        this.toast('ÁÑ°Ë≥áÊñôÂèØÂåØÂá∫', 'error');
                        return;
                    }
                    const headers = ['Ê™¢Êü•ÊôÇÈñì', 'Ë®≠ÂÇôID', 'Ë®≠ÂÇôÂêçÁ®±', 'ÂñÆ‰Ωç', 'ËÆäÊõ¥Ââç%', 'ËÆäÊõ¥Âæå%', 'ÁãÄÊÖã'];
                    const rows = this.checkReportData.records.map(r => [
                        r.check_time || '',
                        r.equipment_id || '',
                        r.equipment_name || '',
                        r.unit_label || '',
                        r.level_before || '',
                        r.level_after || '',
                        r.status_after || ''
                    ]);
                    const csv = [headers.join(','), ...rows.map(r => r.join(','))].join('\n');
                    const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `Ê™¢Êü•Â†±Ë°®_${this.checkReportDate}.csv`;
                    a.click();
                    URL.revokeObjectURL(url);
                    this.toast('CSV ÂåØÂá∫ÊàêÂäü', 'success');
                },

                // ÂèñÂæó‰æõÈõªË®≠ÂÇô (ÁôºÈõªÊ©ü„ÄÅÈõªÊ∫êÁ´ô„ÄÅUPS)
                getPowerSupplyEquipment() {
                    const powerSupplyIds = ['UTIL-001', 'UTIL-002', 'EQ-010'];
                    const powerSupplyCategories = ['ÈõªÂäõË®≠ÂÇô'];
                    return this.equipment.filter(eq =>
                        !eq.id.includes('-SURG-') && !eq.id.startsWith('SURG-') &&
                        (powerSupplyIds.includes(eq.id) ||
                         powerSupplyCategories.includes(eq.category) ||
                         eq.name.includes('ÁôºÈõªÊ©ü') ||
                         eq.name.includes('ÈõªÊ∫êÁ´ô') ||
                         eq.name.includes('UPS'))
                    );
                },

                // ÂèñÂæóËÄóÈõªË®≠ÂÇô (ÂÜ∞ÁÆ±„ÄÅÂëºÂê∏Âô®„ÄÅÁõ£Ë¶ñÂô®Á≠âÈúÄË¶ÅÈõªÂäõÈÅã‰ΩúÁöÑË®≠ÂÇô)
                getPowerConsumingEquipment() {
                    const powerConsumingCategories = ['ÂÑ≤Â≠òË®≠ÂÇô', 'ÂÜ∑ËóèË®≠ÂÇô', 'Áõ£Ê∏¨Ë®≠ÂÇô', 'ÂëºÂê∏Ë®≠ÂÇô', 'Ëº∏Ê∂≤Ë®≠ÂÇô', 'ÊâãË°ìË®≠ÂÇô', 'È∫ªÈÜâË®≠ÂÇô'];
                    const oxygenCylinderIds = ['RESP-001', 'EMER-EQ-006']; // Ê∞ßÊ∞£ÈãºÁì∂‰∏çËÄóÈõª
                    const powerSupplyIds = ['UTIL-001', 'UTIL-002', 'EQ-010']; // ÊéíÈô§‰æõÈõªË®≠ÂÇô
                    return this.equipment.filter(eq =>
                        !eq.id.includes('-SURG-') && !eq.id.startsWith('SURG-') &&
                        !powerSupplyIds.includes(eq.id) &&
                        !oxygenCylinderIds.includes(eq.id) &&
                        (powerConsumingCategories.includes(eq.category) ||
                         eq.name.includes('ÂÜ∞ÁÆ±') || eq.name.includes('ÂÜ∑Âáç') ||
                         eq.name.includes('ÂëºÂê∏') || eq.name.includes('Áõ£Ë¶ñ') ||
                         eq.name.includes('Ëº∏Ê∂≤') || eq.name.includes('ÊäΩÂê∏') ||
                         eq.name.includes('ÊøÉÁ∏ÆÊ©ü') ||  // Ê∞ßÊ∞£ÊøÉÁ∏ÆÊ©üÈúÄË¶ÅÈõªÂäõ
                         eq.category === 'ÈõªÂäõË®≠ÂÇô' && !eq.name.includes('ÁôºÈõªÊ©ü') && !eq.name.includes('ÈõªÊ∫êÁ´ô'))
                    );
                },

                // ÂèñÂæóÈùûËÄóÈõªË®≠ÂÇô (ÊâãÂãïË®≠ÂÇô„ÄÅÊìîÊû∂„ÄÅË®∫Êñ∑Â∑•ÂÖ∑Á≠â)
                getNonElectricEquipment() {
                    const nonElectricCategories = ['Êê¨ÈÅãË®≠ÂÇô', 'Ë®∫Êñ∑Ë®≠ÂÇô', 'ÊÄ•ÊïëË®≠ÂÇô', 'ÊâãÂãïË®≠ÂÇô'];
                    const oxygenCylinderIds = ['RESP-001', 'EMER-EQ-006']; // Ê∞ßÊ∞£ÈãºÁì∂‰∏çËÄóÈõª
                    const powerSupplyIds = ['UTIL-001', 'UTIL-002', 'EQ-010'];
                    const powerConsumingCategories = ['ÂÑ≤Â≠òË®≠ÂÇô', 'ÂÜ∑ËóèË®≠ÂÇô', 'Áõ£Ê∏¨Ë®≠ÂÇô', 'ÂëºÂê∏Ë®≠ÂÇô', 'Ëº∏Ê∂≤Ë®≠ÂÇô', 'ÊâãË°ìË®≠ÂÇô', 'È∫ªÈÜâË®≠ÂÇô', 'ÈõªÂäõË®≠ÂÇô'];
                    return this.equipment.filter(eq => {
                        if (eq.id.includes('-SURG-') || eq.id.startsWith('SURG-')) return false;
                        if (powerSupplyIds.includes(eq.id)) return false;
                        // Ê∞ßÊ∞£ÈãºÁì∂Ê≠∏ÂÖ•ÈùûËÄóÈõª (‰∏çÈúÄË¶ÅÈõª)
                        if (oxygenCylinderIds.includes(eq.id)) return true;
                        // Ê∞ßÊ∞£ÊøÉÁ∏ÆÊ©üÈúÄË¶ÅÈõªÔºå‰∏çÂú®Ê≠§Âàó
                        if (eq.name.includes('ÊøÉÁ∏ÆÊ©ü')) return false;
                        // ÊòéÁ¢∫ÁöÑÈùûËÄóÈõªÈ°ûÂà•
                        if (nonElectricCategories.includes(eq.category)) return true;
                        // ÊéíÈô§ËÄóÈõªË®≠ÂÇôÂæåÁöÑÂÖ∂‰ªñË®≠ÂÇô
                        if (powerConsumingCategories.includes(eq.category)) return false;
                        if (eq.name.includes('ÂÜ∞ÁÆ±') || eq.name.includes('ÂÜ∑Âáç') ||
                            eq.name.includes('ÂëºÂê∏') || eq.name.includes('Áõ£Ë¶ñ') ||
                            eq.name.includes('Ëº∏Ê∂≤') || eq.name.includes('ÊäΩÂê∏')) return false;
                        return true; // ÂÖ∂‰ªñÊ≠∏ÂÖ•ÈùûËÄóÈõª
                    });
                },

                // v2: ÈñãÂïüË®≠ÂÇôÊ™¢Êü• modalÔºåËºâÂÖ•Ë®≠ÂÇôË©≥ÊÉÖÂê´ÂñÆ‰Ωç
                async checkEquipment(eq) {
                    try {
                        // v2 API: ËºâÂÖ•Ë®≠ÂÇôË©≥ÊÉÖÂê´ÊâÄÊúâÂñÆ‰Ωç
                        const response = await fetch(`${this.apiUrl}/v2/equipment/${eq.id}`);
                        if (!response.ok) {
                            this.toast('ËºâÂÖ•Ë®≠ÂÇôË©≥ÊÉÖÂ§±Êïó', 'error');
                            return;
                        }
                        const detail = await response.json();

                        // Ë®≠ÁΩÆË°®ÂñÆ
                        this.checkEquipmentForm = {
                            id: eq.id,
                            name: detail.name,
                            status: 'AVAILABLE',
                            powerLevel: detail.units?.[0]?.level_percent || 100,
                            remarks: '',
                            stationId: this.stationId,
                            // v2 fields
                            units: detail.units || [],
                            selectedUnitId: detail.units?.[0]?.id || null,
                            statusOptions: detail.status_options || ['AVAILABLE', 'IN_USE', 'MAINTENANCE']
                        };
                        this.showCheckEquipmentModal = true;
                    } catch (error) {
                        console.error('ËºâÂÖ•Ë®≠ÂÇôË©≥ÊÉÖÂ§±Êïó:', error);
                        this.toast('ËºâÂÖ•Ë®≠ÂÇôË©≥ÊÉÖÂ§±Êïó', 'error');
                    }
                },

                // v2: ÈÅ∏ÊìáÂñÆ‰ΩçÊôÇÊõ¥Êñ∞Ë°®ÂñÆ
                selectUnit(unit) {
                    this.checkEquipmentForm.selectedUnitId = unit.id;
                    this.checkEquipmentForm.powerLevel = unit.level_percent;
                    this.checkEquipmentForm.status = unit.status || 'AVAILABLE';
                },

                // v2: Êèê‰∫§Ë®≠ÂÇôÂñÆ‰ΩçÊ™¢Êü•
                async submitCheckEquipment() {
                    try {
                        const unitId = this.checkEquipmentForm.selectedUnitId;
                        if (!unitId) {
                            this.toast('Ë´ãÈÅ∏ÊìáË¶ÅÊ™¢Êü•ÁöÑÂñÆ‰Ωç', 'error');
                            return;
                        }

                        // v2 API: POST /api/v2/equipment/units/{unit_id}/check
                        const response = await fetch(`${this.apiUrl}/v2/equipment/units/${unitId}/check`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                level_percent: parseInt(this.checkEquipmentForm.powerLevel) || 100,
                                status: this.checkEquipmentForm.status,
                                remarks: this.checkEquipmentForm.remarks || null
                            })
                        });

                        const data = await response.json();

                        if (response.ok) {
                            this.toast('Ë®≠ÂÇôÊ™¢Êü•ÂÆåÊàê', 'success');
                            this.showCheckEquipmentModal = false;

                            // v2: Áõ¥Êé•Âæû API ÂõûÊáâÊõ¥Êñ∞ UIÔºå‰∏çÈúÄÈáçÊñ∞ËºâÂÖ•ÂÖ®ÈÉ®
                            this.updateEquipmentFromResponse(data);

                            // Êõ¥Êñ∞ÈüåÊÄßÁãÄÊÖãÔºàÂ¶ÇÊûú API ÂõûÂÇ≥ dashboard deltaÔºâ
                            if (data.dashboard_delta) {
                                this.applyDashboardDelta(data.dashboard_delta);
                            } else {
                                // fallback: ÈáçÊñ∞ËºâÂÖ•ÈüåÊÄßÁãÄÊÖã
                                await this.loadResilienceStatus();
                            }

                            await this.loadStats();
                        } else {
                            this.toast(data.detail || 'Ê™¢Êü•Â§±Êïó', 'error');
                        }
                    } catch (error) {
                        console.error('Ë®≠ÂÇôÊ™¢Êü•Â§±Êïó:', error);
                        this.toast('Ë®≠ÂÇôÊ™¢Êü•Â§±Êïó', 'error');
                    }
                },

                // v2: Âæû API ÂõûÊáâÁõ¥Êé•Êõ¥Êñ∞Ë®≠ÂÇôÂàóË°®ÔºàOptimistic UIÔºâ
                updateEquipmentFromResponse(data) {
                    if (!data.equipment_aggregate) return;

                    const eqId = data.equipment_aggregate.equipment_id;
                    const idx = this.equipment.findIndex(e => e.id === eqId);
                    if (idx === -1) return;

                    // Êõ¥Êñ∞Ë®≠ÂÇôËÅöÂêàÁãÄÊÖã
                    this.equipment[idx] = {
                        ...this.equipment[idx],
                        unit_count: data.equipment_aggregate.unit_count,
                        avg_level: data.equipment_aggregate.avg_level,
                        check_status: data.equipment_aggregate.check_status,
                        // v1 compatibility
                        quantity: data.equipment_aggregate.unit_count,
                        power_level: data.equipment_aggregate.avg_level,
                        status: this.mapCheckStatusToLegacy(data.equipment_aggregate.check_status)
                    };

                    console.log('‚úì Ë®≠ÂÇôÁãÄÊÖãÂ∑≤Êõ¥Êñ∞ (optimistic):', eqId);
                },

                // v2: Â•óÁî®ÈüåÊÄßÂÑÄË°®ÊùøÂ∑ÆÁï∞Êõ¥Êñ∞ (Optimistic UI)
                applyDashboardDelta(delta) {
                    if (!delta || !delta.category) {
                        console.log('No dashboard delta to apply');
                        return;
                    }

                    console.log('‚úì Applying dashboard delta:', delta);

                    // ÊâæÂà∞Â∞çÊáâÁöÑ lifeline ‰∏¶Êõ¥Êñ∞
                    const lifelineIdx = this.resilienceStatus.lifelines?.findIndex(
                        ll => ll.type === delta.category
                    );

                    if (lifelineIdx !== -1 && this.resilienceStatus.lifelines) {
                        // Êõ¥Êñ∞Ë©≤ÁîüÂëΩÁ∑öÁöÑÁ∏ΩÊôÇÊï∏ (ÂêåÊôÇÊõ¥Êñ∞ endurance ÁµêÊßã‰ª•‰æõ v1 UI ‰ΩøÁî®)
                        const ll = this.resilienceStatus.lifelines[lifelineIdx];
                        ll.total_hours = delta.total_hours;
                        if (ll.endurance) {
                            ll.endurance.effective_hours = delta.total_hours >= 999999 ? '‚àû' : Math.round(delta.total_hours * 10) / 10;
                            ll.endurance.effective_days = Math.round(delta.total_hours / 24 * 10) / 10;
                        }

                        // ÈáçÊñ∞Ë®àÁÆóÊúÄÂº±ÁîüÂëΩÁ∑ö
                        const weakest = this.resilienceStatus.lifelines.reduce((min, ll) =>
                            (!min || ll.total_hours < min.total_hours) ? ll : min, null);

                        if (weakest && this.resilienceStatus.summary) {
                            this.resilienceStatus.summary.weakest_link = {
                                hours: weakest.total_hours,
                                type: weakest.type,
                                name: weakest.name
                            };

                            // Êõ¥Êñ∞Êï¥È´îÁãÄÊÖã
                            const targetHours = (this.resilienceStatus.summary.isolation_target_days || 3) * 24;
                            if (weakest.total_hours >= targetHours * 1.2) {
                                this.resilienceStatus.summary.overall_status = 'SAFE';
                            } else if (weakest.total_hours >= targetHours) {
                                this.resilienceStatus.summary.overall_status = 'WARNING';
                            } else {
                                this.resilienceStatus.summary.overall_status = 'CRITICAL';
                            }
                        }

                        // Êõ¥Êñ∞Ê™¢Êü•ÈÄ≤Â∫¶
                        if (this.resilienceStatus.summary?.check_progress) {
                            this.resilienceStatus.summary.check_progress.checked = delta.checked_count;
                            this.resilienceStatus.summary.check_progress.total = delta.total_units;
                            this.resilienceStatus.summary.check_progress.percentage =
                                Math.round((delta.checked_count / delta.total_units) * 100) || 0;
                        }

                        console.log('‚úì Dashboard updated optimistically');
                    }
                },

                // ============================================
                // v2.1: Ë®≠ÂÇôÂñÆ‰ΩçÁÆ°ÁêÜÂäüËÉΩ
                // ============================================

                async openUnitManageModal(eq) {
                    this.unitManageForm.equipment_id = eq.id;
                    this.unitManageForm.equipment_name = eq.name;
                    this.unitManageForm.type_code = eq.type_code;
                    this.unitManageForm.loading = true;
                    this.unitManageForm.showInactive = false;
                    this.unitManageForm.units = [];
                    this.unitManageForm.inactive_units = [];
                    this.showUnitManageModal = true;

                    try {
                        const response = await fetch(`${this.apiUrl}/v2/equipment/${eq.id}/units?include_inactive=true`);
                        if (response.ok) {
                            const data = await response.json();
                            this.unitManageForm.units = data.units || [];
                            this.unitManageForm.inactive_units = data.inactive_units || [];
                            this.unitManageForm.unit_prefix = data.unit_prefix;
                            this.unitManageForm.targetQuantity = data.active_count;
                        } else {
                            this.toast('ËºâÂÖ•ÂñÆ‰ΩçÂàóË°®Â§±Êïó', 'error');
                        }
                    } catch (error) {
                        console.error('ËºâÂÖ•Ë®≠ÂÇôÂñÆ‰ΩçÂ§±Êïó:', error);
                        this.toast('ËºâÂÖ•Ë®≠ÂÇôÂñÆ‰ΩçÂ§±Êïó', 'error');
                    } finally {
                        this.unitManageForm.loading = false;
                    }
                },

                async addUnit() {
                    const equipmentId = this.unitManageForm.equipment_id;
                    const form = this.unitManageForm.addForm;

                    try {
                        const response = await fetch(`${this.apiUrl}/v2/equipment/${equipmentId}/units`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                level_percent: parseInt(form.level_percent) || 100,
                                status: form.status || 'AVAILABLE',
                                reason: form.reason || null
                            })
                        });

                        const data = await response.json();

                        if (response.ok) {
                            this.toast(data.message || 'Â∑≤Êñ∞Â¢ûÂñÆ‰Ωç', 'success');
                            // Êñ∞Â¢ûÂà∞ÂàóË°®
                            this.unitManageForm.units.push(data.unit);
                            this.unitManageForm.targetQuantity = data.equipment_summary?.active_unit_count;
                            // ÈáçÁΩÆË°®ÂñÆ
                            this.unitManageForm.addForm = { level_percent: 100, status: 'AVAILABLE', reason: '' };
                            // Êõ¥Êñ∞‰∏ªÂàóË°®
                            await this.loadEquipment();
                            await this.loadResilienceStatus();
                        } else {
                            this.toast(data.detail || 'Êñ∞Â¢ûÂ§±Êïó', 'error');
                        }
                    } catch (error) {
                        console.error('Êñ∞Â¢ûÂñÆ‰ΩçÂ§±Êïó:', error);
                        this.toast('Êñ∞Â¢ûÂñÆ‰ΩçÂ§±Êïó', 'error');
                    }
                },

                async removeUnit(unit) {
                    const reason = this.unitManageForm.removeReason || 'ÊºîÁøíË™øÊï¥';

                    if (!confirm(`Á¢∫ÂÆöË¶ÅÁßªÈô§„Äå${unit.unit_label}„ÄçÔºü\nÂéüÂõ†: ${reason}`)) {
                        return;
                    }

                    try {
                        const response = await fetch(`${this.apiUrl}/v2/equipment/units/${unit.id}`, {
                            method: 'DELETE',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ reason: reason })
                        });

                        const data = await response.json();

                        if (response.ok) {
                            this.toast(data.message || 'Â∑≤ÁßªÈô§ÂñÆ‰Ωç', 'success');
                            // Âæû active ÂàóË°®ÁßªÈô§
                            this.unitManageForm.units = this.unitManageForm.units.filter(u => u.id !== unit.id);
                            // Âä†ÂÖ• inactive ÂàóË°®
                            this.unitManageForm.inactive_units.unshift({
                                ...unit,
                                is_active: false,
                                removed_at: new Date().toISOString(),
                                removal_reason: reason
                            });
                            this.unitManageForm.targetQuantity = data.equipment_summary?.active_unit_count;
                            // Êõ¥Êñ∞‰∏ªÂàóË°®
                            await this.loadEquipment();
                            await this.loadResilienceStatus();
                        } else {
                            this.toast(data.detail || 'ÁßªÈô§Â§±Êïó', 'error');
                        }
                    } catch (error) {
                        console.error('ÁßªÈô§ÂñÆ‰ΩçÂ§±Êïó:', error);
                        this.toast('ÁßªÈô§ÂñÆ‰ΩçÂ§±Êïó', 'error');
                    }
                },

                async restoreUnit(unit) {
                    if (!confirm(`Á¢∫ÂÆöË¶ÅÊÅ¢Âæ©„Äå${unit.unit_label}„ÄçÔºü`)) {
                        return;
                    }

                    try {
                        const response = await fetch(`${this.apiUrl}/v2/equipment/units/${unit.id}/restore`, {
                            method: 'POST'
                        });

                        const data = await response.json();

                        if (response.ok) {
                            this.toast(data.message || 'Â∑≤ÊÅ¢Âæ©ÂñÆ‰Ωç', 'success');
                            // Âæû inactive ÂàóË°®ÁßªÈô§
                            this.unitManageForm.inactive_units = this.unitManageForm.inactive_units.filter(u => u.id !== unit.id);
                            // Âä†ÂÖ• active ÂàóË°®
                            this.unitManageForm.units.push({
                                ...unit,
                                is_active: true,
                                removed_at: null,
                                removal_reason: null
                            });
                            this.unitManageForm.targetQuantity = data.equipment_summary?.active_unit_count;
                            // Êõ¥Êñ∞‰∏ªÂàóË°®
                            await this.loadEquipment();
                            await this.loadResilienceStatus();
                        } else {
                            this.toast(data.detail || 'ÊÅ¢Âæ©Â§±Êïó', 'error');
                        }
                    } catch (error) {
                        console.error('ÊÅ¢Âæ©ÂñÆ‰ΩçÂ§±Êïó:', error);
                        this.toast('ÊÅ¢Âæ©ÂñÆ‰ΩçÂ§±Êïó', 'error');
                    }
                },

                async batchAdjustQuantity() {
                    const equipmentId = this.unitManageForm.equipment_id;
                    const target = parseInt(this.unitManageForm.targetQuantity);
                    const current = this.unitManageForm.units.length;

                    if (target === current) {
                        this.toast('Êï∏ÈáèÊú™ËÆäÊõ¥', 'info');
                        return;
                    }

                    const action = target > current ? 'Êñ∞Â¢û' : 'ÁßªÈô§';
                    const diff = Math.abs(target - current);

                    if (!confirm(`Á¢∫ÂÆöË¶Å${action} ${diff} ÂÄãÂñÆ‰ΩçÔºü\n(${current} ‚Üí ${target})`)) {
                        return;
                    }

                    try {
                        const response = await fetch(`${this.apiUrl}/v2/equipment/${equipmentId}/quantity`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                target_quantity: target,
                                reason: 'ÊâπÊ¨°Êï∏ÈáèË™øÊï¥'
                            })
                        });

                        const data = await response.json();

                        if (response.ok) {
                            this.toast(data.message || 'Ë™øÊï¥ÂÆåÊàê', 'success');
                            // ÈáçÊñ∞ËºâÂÖ•ÂñÆ‰ΩçÂàóË°®
                            await this.openUnitManageModal({
                                id: equipmentId,
                                name: this.unitManageForm.equipment_name,
                                type_code: this.unitManageForm.type_code
                            });
                            // Êõ¥Êñ∞‰∏ªÂàóË°®
                            await this.loadEquipment();
                            await this.loadResilienceStatus();
                        } else {
                            this.toast(data.detail || 'Ë™øÊï¥Â§±Êïó', 'error');
                        }
                    } catch (error) {
                        console.error('ÊâπÊ¨°Ë™øÊï¥Â§±Êïó:', error);
                        this.toast('ÊâπÊ¨°Ë™øÊï¥Â§±Êïó', 'error');
                    }
                },

                getStatusBadgeClass(status) {
                    const classes = {
                        'AVAILABLE': 'bg-green-100 text-green-800',
                        'IN_USE': 'bg-blue-100 text-blue-800',
                        'CHARGING': 'bg-yellow-100 text-yellow-800',
                        'MAINTENANCE': 'bg-gray-100 text-gray-800',
                        'EMPTY': 'bg-red-100 text-red-800'
                    };
                    return classes[status] || 'bg-gray-100 text-gray-800';
                },

                // ÊâãË°ìË®òÈåÑ
                async loadSurgeryRecords() {
                    try {
                        let url = `${this.apiUrl}/surgery/records?limit=50`;
                        
                        if (this.surgerySearchForm.startDate) {
                            url += `&start_date=${this.surgerySearchForm.startDate}`;
                        }
                        if (this.surgerySearchForm.endDate) {
                            url += `&end_date=${this.surgerySearchForm.endDate}`;
                        }
                        if (this.surgerySearchForm.patientName) {
                            url += `&patient_name=${encodeURIComponent(this.surgerySearchForm.patientName)}`;
                        }
                        
                        const response = await fetch(url);
                        if (response.ok) {
                            const data = await response.json();
                            this.surgeryRecords = data.records;
                        }
                    } catch (error) {
                        console.error('ËºâÂÖ•ÊâãË°ìË®òÈåÑÂ§±Êïó:', error);
                        this.toast('ËºâÂÖ•ÊâãË°ìË®òÈåÑÂ§±Êïó', 'error');
                    }
                },

                addConsumptionItem() {
                    this.addSurgeryForm.consumptions.push({
                        itemCode: '',
                        itemName: '',
                        quantity: 1,
                        unit: '',
                        searchText: '',
                        showDropdown: false,
                        filteredItems: []
                    });
                },

                filterConsumptionItems(index) {
                    const item = this.addSurgeryForm.consumptions[index];
                    const searchText = item.searchText.toLowerCase();

                    // ÊéíÈô§Ëó•ÂìÅ (medicines) - Ëó•ÂìÅÊáâË©≤ÈÄèÈÅéËó•ÂìÅÈ†òÁî®ÊµÅÁ®ã
                    const nonMedicineItems = this.items.filter(i => i.category !== 'Ëó•ÂìÅ');

                    if (!searchText) {
                        item.filteredItems = nonMedicineItems;
                    } else {
                        item.filteredItems = nonMedicineItems.filter(i =>
                            i.code.toLowerCase().includes(searchText) ||
                            i.name.toLowerCase().includes(searchText)
                        );
                    }
                },

                selectConsumptionItem(index, selectedItem) {
                    const item = this.addSurgeryForm.consumptions[index];
                    item.itemCode = selectedItem.code;
                    item.itemName = selectedItem.name;
                    item.unit = selectedItem.unit;
                    item.searchText = `${selectedItem.code} - ${selectedItem.name}`;
                    item.showDropdown = false;
                },

                removeConsumptionItem(index) {
                    this.addSurgeryForm.consumptions.splice(index, 1);
                },

                updateConsumptionItemName(index) {
                    const itemCode = this.addSurgeryForm.consumptions[index].itemCode;
                    const item = this.items.find(i => i.code === itemCode);
                    if (item) {
                        this.addSurgeryForm.consumptions[index].itemName = item.name;
                        this.addSurgeryForm.consumptions[index].unit = item.unit;
                    }
                },

                // Ë°ì‰∏≠Áî®Ëó•ÊñπÊ≥ï
                addIntraopMed() {
                    this.addSurgeryForm.intraopMeds.push({
                        name: '',
                        dose: '',
                        unit: ''
                    });
                },

                removeIntraopMed(index) {
                    this.addSurgeryForm.intraopMeds.splice(index, 1);
                },

                addQuickIntraopMed(name, dose, unit) {
                    // Ê™¢Êü•ÊòØÂê¶Â∑≤Â≠òÂú®Áõ∏ÂêåËó•Áâ©
                    const existing = this.addSurgeryForm.intraopMeds.find(m => m.name === name);
                    if (existing) {
                        this.toast(`${name} Â∑≤Âú®ÂàóË°®‰∏≠`, 'warning');
                        return;
                    }
                    this.addSurgeryForm.intraopMeds.push({ name, dose, unit });
                },

                async submitAddSurgery() {
                    // Ëá≥Â∞ëÈúÄË¶ÅËÄóÊùêÊàñË°ì‰∏≠Áî®Ëó•ÂÖ∂‰∏≠‰πã‰∏Ä
                    if (this.addSurgeryForm.consumptions.length === 0 && this.addSurgeryForm.intraopMeds.length === 0) {
                        this.toast('Ë´ãËá≥Â∞ëÊñ∞Â¢û‰∏ÄÈ†ÖËÄóÊùêÊàñË°ì‰∏≠Áî®Ëó•', 'error');
                        return;
                    }

                    try {
                        const response = await fetch(`${this.apiUrl}/surgery/record`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(this.addSurgeryForm)
                        });
                        
                        const data = await response.json();
                        
                        if (response.ok) {
                            this.toast(data.message || 'ÊâãË°ìË®òÈåÑÂª∫Á´ãÊàêÂäü', 'success');
                            this.showAddSurgeryModal = false;
                            this.resetAddSurgeryForm();
                            await this.loadSurgeryRecords();
                            await this.loadItems();
                            await this.loadStats();
                        } else {
                            this.toast(data.detail || 'Âª∫Á´ãÂ§±Êïó', 'error');
                        }
                    } catch (error) {
                        console.error('Âª∫Á´ãÊâãË°ìË®òÈåÑÂ§±Êïó:', error);
                        this.toast('Âª∫Á´ãÊâãË°ìË®òÈåÑÂ§±Êïó', 'error');
                    }
                },

                resetAddSurgeryForm() {
                    this.addSurgeryForm = {
                        patientName: '',
                        triageTagId: '',
                        surgeryType: '',
                        surgeonName: '',
                        anesthesiaType: '',
                        durationMinutes: null,
                        remarks: '',
                        consumptions: [],
                        intraopMeds: [],  // Ë°ì‰∏≠Áî®Ëó•
                        stationId: this.stationId,
                        // v1.1: CIRS Êï¥Âêà
                        cirsRegistrationRef: null,
                        cirsPersonId: null
                    };
                },

                // v1.1: ËºâÂÖ• CIRS ÂæÖËôïÁΩÆÊ∏ÖÂñÆ
                // v1.2: Âä†ÂÖ• lastSynced È°ØÁ§∫ÊúÄÂæåÂêåÊ≠•ÊôÇÈñì
                async loadCirsProcedureWaiting() {
                    try {
                        const response = await fetch(`${this.apiUrl}/procedure/proxy/cirs/waiting-procedure`);
                        const data = await response.json();

                        this.cirsProcedureStatus.online = data.online;
                        this.cirsProcedurePatients = data.patients || [];

                        // v1.2: Ë®òÈåÑÊúÄÂæåÂêåÊ≠•ÊôÇÈñì
                        this.cirsProcedureStatus.lastSynced = data.local_timestamp || new Date().toISOString();

                        if (data.online) {
                            console.log(`CIRS ÂæÖËôïÁΩÆÊ∏ÖÂñÆ: ${data.count} ‰ΩçÁóÖÊÇ£`);
                        }
                    } catch (error) {
                        console.error('ËºâÂÖ• CIRS ÂæÖËôïÁΩÆÊ∏ÖÂñÆÂ§±Êïó:', error);
                        this.cirsProcedureStatus.online = false;
                        this.cirsProcedurePatients = [];
                        this.cirsProcedureStatus.lastSynced = new Date().toISOString();
                    }
                },

                // v1.1: ÂæûÂæÖËôïÁΩÆÊ∏ÖÂñÆÈÅ∏ÂèñÁóÖÊÇ£
                selectProcedurePatient(patient) {
                    this.ensureItemsLoaded();

                    // Ëá™ÂãïÂ∏∂ÂÖ•ÁóÖÊÇ£Ë≥áÊñô
                    this.addSurgeryForm.patientName = patient.name || patient.patient_ref || '';
                    this.addSurgeryForm.triageTagId = patient.patient_id || '';
                    this.addSurgeryForm.surgeryType = patient.procedure_notes || patient.chief_complaint || '';
                    this.addSurgeryForm.remarks = patient.chief_complaint ? `‰∏ªË®¥: ${patient.chief_complaint}` : '';

                    // v1.1: CIRS Êï¥ÂêàÊ¨Ñ‰Ωç
                    this.addSurgeryForm.cirsRegistrationRef = patient.registration_id;
                    this.addSurgeryForm.cirsPersonId = patient.patient_id;

                    // ÈñãÂïü Modal
                    this.showAddSurgeryModal = true;

                    this.toast(`Â∑≤ÈÅ∏ÂèñÁóÖÊÇ£: ${patient.name || patient.patient_ref}`, 'success');
                },

                viewSurgeryDetail(record) {
                    this.selectedSurgery = record;
                    this.showSurgeryDetailModal = true;
                },

                async exportSurgeryCSV() {
                    try {
                        let url = `${this.apiUrl}/surgery/export/csv`;
                        const params = [];
                        
                        if (this.surgerySearchForm.startDate) {
                            params.push(`start_date=${this.surgerySearchForm.startDate}`);
                        }
                        if (this.surgerySearchForm.endDate) {
                            params.push(`end_date=${this.surgerySearchForm.endDate}`);
                        }
                        
                        if (params.length > 0) {
                            url += '?' + params.join('&');
                        }
                        
                        window.open(url, '_blank');
                        this.toast('CSV ÂåØÂá∫ÊàêÂäü', 'success');
                    } catch (error) {
                        console.error('ÂåØÂá∫ CSV Â§±Êïó:', error);
                        this.toast('ÂåØÂá∫ CSV Â§±Êïó', 'error');
                    }
                },

                // Toast ÈÄöÁü•
                toast(message, type = 'info') {
                    this.toastMessage = message;
                    this.toastType = type;
                    this.showToast = true;
                    setTimeout(() => {
                        this.showToast = false;
                    }, 3000);
                },

                // ========== ‰º∫ÊúçÂô®‰ΩçÂùÄÈ°ØÁ§∫ (v2.5) ==========
                isLocalhostAccess() {
                    // Â¶ÇÊûúÂ∑≤ÂÅµÊ∏¨Âà∞‰º∫ÊúçÂô® URLÔºåÂ∞±‰∏çÈúÄË¶ÅË≠¶Âëä
                    if (this.detectedServerUrl) return false;
                    const host = window.location.hostname;
                    return host === 'localhost' || host === '127.0.0.1';
                },

                getDisplayServerUrl() {
                    // ÂÑ™ÂÖà‰ΩøÁî®ÂæåÁ´ØÂÅµÊ∏¨ÁöÑ IP
                    if (this.detectedServerUrl) {
                        return this.detectedServerUrl;
                    }
                    // ÂÇôÁî®Ôºö‰ΩøÁî®ÂâçÁ´ØÁöÑ hostname
                    const host = window.location.hostname;
                    const port = '8000';
                    if (host === 'localhost' || host === '127.0.0.1') {
                        return `http://<ÈõªËÖ¶IP>:${port}/api`;
                    }
                    return `http://${host}:${port}/api`;
                },

                // ========== PWA ÂêåÊ≠•ÈÄöÁü• (v0.8) ==========
                async initSyncNotifications() {
                    // ÂàùÂßãÂåñÊôÇË®òÈåÑÁï∂ÂâçÁöÑÁõ§ÈªûË®òÈåÑÊï∏Èáè
                    try {
                        const response = await fetch(`${this.apiUrl}/inventory-check/history`);
                        if (response.ok) {
                            const data = await response.json();
                            this.lastKnownCheckCount = (data.checks || []).length;
                            console.log('‚úì ÂêåÊ≠•ÈÄöÁü•Â∑≤ÂàùÂßãÂåñ, Áï∂ÂâçÁõ§ÈªûË®òÈåÑ:', this.lastKnownCheckCount);
                        }
                    } catch (e) {
                        console.log('ÂêåÊ≠•ÈÄöÁü•ÂàùÂßãÂåñÁï•ÈÅé');
                    }
                },

                async checkForNewSyncs() {
                    // ÂÆöÊúüÊ™¢Êü•ÊòØÂê¶ÊúâÊñ∞ÁöÑ PWA ÂêåÊ≠•Ë≥áÊñô
                    try {
                        const response = await fetch(`${this.apiUrl}/inventory-check/history`);
                        if (response.ok) {
                            const data = await response.json();
                            const currentCount = (data.checks || []).length;

                            if (currentCount > this.lastKnownCheckCount) {
                                const newCount = currentCount - this.lastKnownCheckCount;

                                // Ë®àÁÆóÊñ∞ÂêåÊ≠•ÁöÑÁ¢∫Ë™çÂíåÈåØË™§Êï∏Èáè
                                const newChecks = (data.checks || []).slice(0, newCount);
                                const newConfirmed = newChecks.reduce((sum, c) => sum + (c.confirmed_count || 0), 0);
                                const newErrors = newChecks.reduce((sum, c) => sum + (c.error_count || 0), 0);

                                // È°ØÁ§∫ÂêåÊ≠•ÈÄöÁü•
                                let msg = `üì± PWA ÂêåÊ≠•: ${newCount} Á≠ÜÊñ∞Áõ§ÈªûË®òÈåÑ`;
                                if (newConfirmed > 0 || newErrors > 0) {
                                    msg += ` (Á¢∫Ë™ç ${newConfirmed}, ÈåØË™§ ${newErrors})`;
                                }

                                this.toast(msg, newErrors > 0 ? 'error' : 'success');

                                // Êõ¥Êñ∞Â∑≤Áü•Êï∏Èáè
                                this.lastKnownCheckCount = currentCount;

                                // Â¶ÇÊûúÁõ§ÈªûË®òÈåÑÊ®°ÊÖãÁ™óÈñãÂïü‰∏≠ÔºåËá™ÂãïÂà∑Êñ∞
                                if (this.showInventoryCheckHistoryModal) {
                                    this.loadInventoryCheckHistory();
                                }

                                // Âà∑Êñ∞Áµ±Ë®àÊï∏Êìö
                                this.loadStats();

                                console.log(`‚úì PWA ÂêåÊ≠•ÈÄöÁü•: ${newCount} Á≠ÜÊñ∞Ë®òÈåÑ`);
                            }
                        }
                    } catch (e) {
                        // ÈùúÈªòÂ§±ÊïóÔºå‰∏çÂΩ±ÈüøÊ≠£Â∏∏‰ΩøÁî®
                    }
                },

                // Á∑äÊÄ•ÂäüËÉΩ (v1.4.5Êñ∞Â¢û)
                emergencyDownloadAll() {
                    window.open(`${this.apiUrl}/emergency/download-all`, '_blank');
                    this.showEmergencyModal = false;
                    this.toast('Ê≠£Âú®ÁîüÊàêÂÆåÊï¥ÂÇô‰ªΩÂåÖÔºåË´ãÁ®çÂÄô...', 'info');
                },

                emergencyQuickBackup() {
                    window.open(`${this.apiUrl}/emergency/quick-backup`, '_blank');
                    this.showEmergencyModal = false;
                    this.toast('Ê≠£Âú®‰∏ãËºâË≥áÊñôÂ∫´ÂÇô‰ªΩ...', 'info');
                },

                // ========== ÂêåÊ≠•ÁÆ°ÁêÜÂäüËÉΩ (ËÅØÈÇ¶Êû∂Êßã Phase 1-2) ==========

                // Áî¢ÁîüÂêåÊ≠•Â∞ÅÂåÖ
                async generateSyncPackage() {
                    try {
                        const requestBody = {
                            stationId: this.stationId,
                            hospitalId: 'HOSP-001',
                            syncType: this.syncPackageForm.syncType
                        };

                        // Â¶ÇÊûúÊòØÂ¢ûÈáèÂêåÊ≠•‰∏îÊúâÊåáÂÆöÊôÇÈñì
                        if (this.syncPackageForm.syncType === 'DELTA' && this.syncPackageForm.sinceTimestamp) {
                            // ËΩâÊèõÁÇ∫ ISO 8601 Ê†ºÂºè
                            const dt = new Date(this.syncPackageForm.sinceTimestamp);
                            requestBody.sinceTimestamp = dt.toISOString();
                        }

                        const response = await fetch(`${this.apiUrl}/station/sync/generate`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(requestBody)
                        });

                        if (response.ok) {
                            const data = await response.json();
                            this.generatedPackage = data;
                            this.syncStats.pendingChanges = data.changes_count;
                            this.toast(`Â∞ÅÂåÖÂ∑≤Áî¢ÁîüÔºö${data.changes_count} È†ÖËÆäÊõ¥`, 'success');
                        } else {
                            const error = await response.json();
                            this.toast(`Áî¢ÁîüÂ∞ÅÂåÖÂ§±ÊïóÔºö${error.detail}`, 'error');
                        }
                    } catch (error) {
                        console.error('Áî¢ÁîüÂêåÊ≠•Â∞ÅÂåÖÂ§±Êïó:', error);
                        this.toast('Áî¢ÁîüÂêåÊ≠•Â∞ÅÂåÖÂ§±Êïó', 'error');
                    }
                },

                // ‰∏ãËºâÂêåÊ≠•Â∞ÅÂåÖÁÇ∫ JSON Ê™îÊ°à
                downloadSyncPackage() {
                    if (!this.generatedPackage) {
                        this.toast('Ë´ãÂÖàÁî¢ÁîüÂêåÊ≠•Â∞ÅÂåÖ', 'error');
                        return;
                    }

                    const dataStr = JSON.stringify(this.generatedPackage, null, 2);
                    const dataBlob = new Blob([dataStr], { type: 'application/json' });
                    const url = URL.createObjectURL(dataBlob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `${this.generatedPackage.package_id}.json`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);

                    this.toast('Â∞ÅÂåÖÂ∑≤‰∏ãËºâ', 'success');
                },

                // Ë§áË£ΩÂêåÊ≠•Â∞ÅÂåÖÂà∞Ââ™Ë≤ºÁ∞ø
                async copySyncPackage() {
                    if (!this.generatedPackage) {
                        this.toast('Ë´ãÂÖàÁî¢ÁîüÂêåÊ≠•Â∞ÅÂåÖ', 'error');
                        return;
                    }

                    try {
                        const dataStr = JSON.stringify(this.generatedPackage, null, 2);
                        await navigator.clipboard.writeText(dataStr);
                        this.toast('Â∞ÅÂåÖÂ∑≤Ë§áË£ΩÂà∞Ââ™Ë≤ºÁ∞ø', 'success');
                    } catch (error) {
                        console.error('Ë§áË£ΩÂ§±Êïó:', error);
                        this.toast('Ë§áË£ΩÂ§±Êïó', 'error');
                    }
                },

                // ËôïÁêÜÂêåÊ≠•Ê™îÊ°à‰∏äÂÇ≥
                handleSyncFileUpload(event) {
                    const file = event.target.files[0];
                    if (!file) return;

                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const jsonData = JSON.parse(e.target.result);
                            this.uploadedPackage = {
                                packageId: jsonData.package_id,
                                changes: jsonData.changes,
                                checksum: jsonData.checksum
                            };
                            this.importResult = null; // Ê∏ÖÈô§‰πãÂâçÁöÑÂåØÂÖ•ÁµêÊûú
                            this.toast('Â∞ÅÂåÖÂ∑≤ËºâÂÖ•', 'info');
                        } catch (error) {
                            console.error('Ëß£Êûê JSON Â§±Êïó:', error);
                            this.toast('Ê™îÊ°àÊ†ºÂºèÈåØË™§', 'error');
                        }
                    };
                    reader.readAsText(file);
                },

                // Ê∏ÖÈô§Â∑≤‰∏äÂÇ≥ÁöÑÂ∞ÅÂåÖ
                clearUploadedPackage() {
                    this.uploadedPackage = null;
                    this.importResult = null;
                    // Ê∏ÖÈô§ file input
                    const fileInput = document.querySelector('input[type="file"]');
                    if (fileInput) fileInput.value = '';
                    this.toast('Â∑≤Ê∏ÖÈô§‰∏äÂÇ≥Â∞ÅÂåÖ', 'info');
                },

                // ÂåØÂÖ•ÂêåÊ≠•Â∞ÅÂåÖ
                async importSyncPackage() {
                    if (!this.uploadedPackage) {
                        this.toast('Ë´ãÂÖà‰∏äÂÇ≥ÂêåÊ≠•Â∞ÅÂåÖ', 'error');
                        return;
                    }

                    try {
                        const response = await fetch(`${this.apiUrl}/station/sync/import`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                stationId: this.stationId,
                                packageId: this.uploadedPackage.packageId,
                                changes: this.uploadedPackage.changes,
                                checksum: this.uploadedPackage.checksum
                            })
                        });

                        if (response.ok) {
                            const data = await response.json();
                            this.importResult = data;

                            if (data.success) {
                                this.syncStats.syncedPackages += 1;
                                this.syncStats.lastSync = new Date().toLocaleString('zh-TW');
                                this.toast(`ÂåØÂÖ•ÊàêÂäüÔºö${data.changes_applied} È†ÖËÆäÊõ¥Â∑≤Â•óÁî®`, 'success');

                                // ÈáçÊñ∞ËºâÂÖ•Ë≥áÊñô
                                await this.loadStats();
                                await this.loadItems();
                                await this.loadBloodInventory();
                            } else {
                                this.toast(`ÂåØÂÖ•Â§±ÊïóÔºö${data.message}`, 'error');
                            }
                        } else {
                            const error = await response.json();
                            this.importResult = {
                                success: false,
                                message: error.detail || 'ÂåØÂÖ•Â§±Êïó'
                            };
                            this.toast(`ÂåØÂÖ•Â§±ÊïóÔºö${error.detail}`, 'error');
                        }
                    } catch (error) {
                        console.error('ÂåØÂÖ•ÂêåÊ≠•Â∞ÅÂåÖÂ§±Êïó:', error);
                        this.importResult = {
                            success: false,
                            message: 'ÂåØÂÖ•Â§±ÊïóÔºöÁ∂≤Ë∑ØÈåØË™§'
                        };
                        this.toast('ÂåØÂÖ•ÂêåÊ≠•Â∞ÅÂåÖÂ§±Êïó', 'error');
                    }
                },

                // ========== Ëó•ÂìÅÈ†òÁî® API (MIRS v2.3 - Emergency Dispense) ==========

                // ËºâÂÖ•ÂæÖËôïÁêÜÈ†òÁî®Ê∏ÖÂñÆ
                async loadPendingDispenses() {
                    try {
                        const response = await fetch(`${this.apiUrl}/pharmacy/dispense/pending`);
                        if (response.ok) {
                            const data = await response.json();
                            this.pendingDispenses = data.records || [];
                            console.log('ÂæÖËôïÁêÜÈ†òÁî®Ê∏ÖÂñÆ:', this.pendingDispenses);
                        } else {
                            console.error('ËºâÂÖ•ÂæÖËôïÁêÜÈ†òÁî®Ê∏ÖÂñÆÂ§±Êïó');
                            this.toast('ËºâÂÖ•ÂæÖËôïÁêÜÈ†òÁî®Ê∏ÖÂñÆÂ§±Êïó', 'error');
                        }
                    } catch (error) {
                        console.error('ËºâÂÖ•ÂæÖËôïÁêÜÈ†òÁî®Ê∏ÖÂñÆÈåØË™§:', error);
                        this.toast('ËºâÂÖ•ÂæÖËôïÁêÜÈ†òÁî®Ê∏ÖÂñÆÈåØË™§', 'error');
                    }
                },

                // Ê≠£Â∏∏È†òÁî® (ÈúÄÂØ©Ê†∏)
                async normalDispense() {
                    if (!this.dispenseForm.medicineCode) {
                        this.toast('Ë´ãÈÅ∏ÊìáËó•ÂìÅ', 'error');
                        return;
                    }

                    if (!this.dispenseForm.dispensedBy) {
                        this.toast('Ë´ãËº∏ÂÖ•È†òËó•‰∫∫', 'error');
                        return;
                    }

                    try {
                        const response = await fetch(`${this.apiUrl}/pharmacy/dispense/normal`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                medicineCode: this.dispenseForm.medicineCode,
                                quantity: this.dispenseForm.quantity,
                                dispensedBy: this.dispenseForm.dispensedBy,
                                patientRefId: this.dispenseForm.patientRefId || null,
                                patientName: this.dispenseForm.patientName || null,
                                stationCode: this.dispenseForm.stationCode
                            })
                        });

                        const data = await response.json();

                        if (response.ok) {
                            this.toast(`Ê≠£Â∏∏È†òÁî®Ë´ãÊ±ÇÂ∑≤ÈÄÅÂá∫ÔºåÁ≠âÂæÖËó•Â∏´ÂØ©Ê†∏ (ID: ${data.dispense_id})`, 'success');
                            this.resetDispenseForm();
                            await this.loadPendingDispenses();
                        } else {
                            this.toast(`È†òÁî®Â§±Êïó: ${data.detail}`, 'error');
                        }
                    } catch (error) {
                        console.error('Ê≠£Â∏∏È†òÁî®ÈåØË™§:', error);
                        this.toast('Ê≠£Â∏∏È†òÁî®Â§±ÊïóÔºåË´ãÁ®çÂæåÂÜçË©¶', 'error');
                    }
                },

                // Á∑äÊÄ•È†òÁî® (Break-the-Glass)
                async emergencyDispense() {
                    if (!this.dispenseForm.medicineCode) {
                        this.toast('Ë´ãÈÅ∏ÊìáËó•ÂìÅ', 'error');
                        return;
                    }

                    if (!this.dispenseForm.dispensedBy) {
                        this.toast('Ë´ãËº∏ÂÖ•È†òËó•‰∫∫', 'error');
                        return;
                    }

                    if (!this.dispenseForm.emergencyReason || this.dispenseForm.emergencyReason.length < 5) {
                        this.toast('Á∑äÊÄ•ÂéüÂõ†ÂøÖÈ†àËá≥Â∞ë5ÂÄãÂ≠ó', 'error');
                        return;
                    }

                    try {
                        const response = await fetch(`${this.apiUrl}/pharmacy/dispense/emergency`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                medicineCode: this.dispenseForm.medicineCode,
                                quantity: this.dispenseForm.quantity,
                                dispensedBy: this.dispenseForm.dispensedBy,
                                emergencyReason: this.dispenseForm.emergencyReason,
                                patientRefId: this.dispenseForm.patientRefId || null,
                                patientName: this.dispenseForm.patientName || null,
                                stationCode: this.dispenseForm.stationCode
                            })
                        });

                        const data = await response.json();

                        if (response.ok) {
                            this.toast(`Á∑äÊÄ•È†òÁî®ÊàêÂäüÔºÅÂ∑≤Á´ãÂç≥Êâ£Èô§Â∫´Â≠ò (ID: ${data.dispense_id})`, 'success');
                            this.showEmergencyReasonModal = false;
                            this.resetDispenseForm();
                            await this.loadPendingDispenses();
                            await this.loadItems();
                            await this.loadStats();
                        } else {
                            this.toast(`Á∑äÊÄ•È†òÁî®Â§±Êïó: ${data.detail}`, 'error');
                        }
                    } catch (error) {
                        console.error('Á∑äÊÄ•È†òÁî®ÈåØË™§:', error);
                        this.toast('Á∑äÊÄ•È†òÁî®Â§±ÊïóÔºåË´ãÁ®çÂæåÂÜçË©¶', 'error');
                    }
                },

                // ÈñãÂïüËó•Â∏´ÂØ©Ê†∏ Modal
                openPharmacistApproval(dispense) {
                    this.selectedDispenseForApproval = dispense;
                    this.pharmacistApprovalForm.dispenseId = dispense.id;
                    this.showPharmacistApprovalModal = true;
                },

                // Ëó•Â∏´ÂØ©Ê†∏Á¢∫Ë™ç
                async submitPharmacistApproval() {
                    if (!this.pharmacistApprovalForm.approvedBy) {
                        this.toast('Ë´ãËº∏ÂÖ•Ëó•Â∏´ÂßìÂêç', 'error');
                        return;
                    }

                    if (!this.pharmacistApprovalForm.pinCode) {
                        this.toast('Ë´ãËº∏ÂÖ• PIN Á¢º', 'error');
                        return;
                    }

                    try {
                        const response = await fetch(`${this.apiUrl}/pharmacy/dispense/approve`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                dispenseId: this.pharmacistApprovalForm.dispenseId,
                                approvedBy: this.pharmacistApprovalForm.approvedBy,
                                pharmacistNotes: this.pharmacistApprovalForm.pharmacistNotes || null,
                                pinCode: this.pharmacistApprovalForm.pinCode
                            })
                        });

                        const data = await response.json();

                        if (response.ok) {
                            const wasEmergency = this.selectedDispenseForApproval?.status === 'EMERGENCY';
                            this.toast(wasEmergency ? 'Á∑äÊÄ•È†òÁî®Â∑≤Á¢∫Ë™ç' : 'È†òÁî®ÂØ©Ê†∏ÈÄöÈÅéÔºåÂ∑≤Êâ£Èô§Â∫´Â≠ò', 'success');
                            this.showPharmacistApprovalModal = false;
                            this.resetPharmacistApprovalForm();
                            await this.loadPendingDispenses();
                            await this.loadItems();
                            await this.loadStats();
                        } else {
                            if (response.status === 401) {
                                this.toast('PIN Á¢ºÈåØË™§ÔºåÊãíÁµïÂØ©Ê†∏', 'error');
                            } else {
                                this.toast(`ÂØ©Ê†∏Â§±Êïó: ${data.detail}`, 'error');
                            }
                        }
                    } catch (error) {
                        console.error('Ëó•Â∏´ÂØ©Ê†∏ÈåØË™§:', error);
                        this.toast('Ëó•Â∏´ÂØ©Ê†∏Â§±ÊïóÔºåË´ãÁ®çÂæåÂÜçË©¶', 'error');
                    }
                },

                // ÈáçÁΩÆÈ†òÁî®Ë°®ÂñÆ
                resetDispenseForm() {
                    this.dispenseForm = {
                        medicineCode: '',
                        quantity: 1,
                        dispensedBy: '',
                        patientRefId: '',
                        patientName: '',
                        stationCode: 'HC-000000',
                        emergencyReason: ''
                    };
                },

                // ÈáçÁΩÆËó•Â∏´ÂØ©Ê†∏Ë°®ÂñÆ
                resetPharmacistApprovalForm() {
                    this.pharmacistApprovalForm = {
                        dispenseId: null,
                        approvedBy: '',
                        pharmacistNotes: '',
                        pinCode: ''
                    };
                    this.selectedDispenseForApproval = null;
                },

                // === ÊâπÊ¨°È†òÁî®ÂäüËÉΩ (Batch Dispense) ===
                addBatchDispenseItem() {
                    this.batchDispenseForm.items.push({
                        medicineCode: '',
                        medicineName: '',
                        quantity: 1,
                        searchText: '',
                        showDropdown: false,
                        filteredItems: []
                    });
                },

                removeBatchDispenseItem(index) {
                    this.batchDispenseForm.items.splice(index, 1);
                },

                filterBatchDispenseItems(index) {
                    const item = this.batchDispenseForm.items[index];
                    const searchText = item.searchText.toLowerCase();

                    // Âè™È°ØÁ§∫Ëó•ÂìÅ (MED- ÈñãÈ†≠) - ‰∏ÄËà¨Áâ©ÂìÅÊáâË©≤ÈÄèÈÅéËôïÁΩÆÊ∂àËÄóÊµÅÁ®ã
                    const medicineItems = this.items.filter(i => i.code.startsWith('MED-'));

                    if (!searchText) {
                        item.filteredItems = medicineItems;
                    } else {
                        item.filteredItems = medicineItems.filter(i =>
                            i.code.toLowerCase().includes(searchText) ||
                            i.name.toLowerCase().includes(searchText)
                        );
                    }
                },

                selectBatchDispenseItem(index, selectedItem) {
                    const item = this.batchDispenseForm.items[index];
                    item.medicineCode = selectedItem.code;
                    item.medicineName = selectedItem.name;
                    item.searchText = `${selectedItem.code} - ${selectedItem.name}`;
                    item.showDropdown = false;
                },

                async submitBatchDispense() {
                    try {
                        if (this.batchDispenseForm.items.length === 0) {
                            this.toast('Ë´ãËá≥Â∞ëÊñ∞Â¢û‰∏ÄÁ≠ÜËó•ÂìÅ', 'error');
                            return;
                        }

                        if (!this.batchDispenseForm.dispensedBy) {
                            this.toast('Ë´ãËº∏ÂÖ•È†òËó•‰∫∫', 'error');
                            return;
                        }

                        // Â¶ÇÊûúÊòØÁ∑äÊÄ•È†òÁî®ÔºåÈúÄË¶ÅÊ™¢Êü•Á∑äÊÄ•ÂéüÂõ†
                        if (this.batchDispenseForm.isEmergency) {
                            if (!this.batchDispenseForm.emergencyReason || this.batchDispenseForm.emergencyReason.length < 5) {
                                this.toast('Á∑äÊÄ•ÂéüÂõ†ÂøÖÈ†àËá≥Â∞ë5ÂÄãÂ≠ó', 'error');
                                return;
                            }
                        }

                        // ÊâπÊ¨°Êèê‰∫§ÊØèÂÄãËó•ÂìÅÈ†òÁî®
                        let successCount = 0;
                        let failCount = 0;
                        const endpoint = this.batchDispenseForm.isEmergency ? 'emergency' : 'normal';

                        for (const item of this.batchDispenseForm.items) {
                            try {
                                const requestBody = {
                                    medicineCode: item.medicineCode,
                                    quantity: item.quantity,
                                    dispensedBy: this.batchDispenseForm.dispensedBy,
                                    patientRefId: this.batchDispenseForm.patientRefId || null,
                                    patientName: this.batchDispenseForm.patientName || null,
                                    stationCode: this.batchDispenseForm.stationCode
                                };

                                // Á∑äÊÄ•È†òÁî®ÈúÄË¶ÅÂä†‰∏äÁ∑äÊÄ•ÂéüÂõ†
                                if (this.batchDispenseForm.isEmergency) {
                                    requestBody.emergencyReason = this.batchDispenseForm.emergencyReason;
                                }

                                const response = await fetch(`${this.apiUrl}/pharmacy/dispense/${endpoint}`, {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify(requestBody)
                                });

                                if (response.ok) {
                                    successCount++;
                                } else {
                                    failCount++;
                                    const data = await response.json();
                                    console.error(`${item.medicineName} È†òÁî®Â§±Êïó:`, data.detail);
                                }
                            } catch (error) {
                                failCount++;
                                console.error(`${item.medicineName} È†òÁî®Â§±Êïó:`, error);
                            }
                        }

                        // È°ØÁ§∫ÁµêÊûú
                        if (failCount === 0) {
                            const message = this.batchDispenseForm.isEmergency
                                ? `ÊàêÂäüÁ∑äÊÄ•È†òÁî® ${successCount} È†ÖËó•ÂìÅÔºåÂ∑≤Á´ãÂç≥Êâ£Èô§Â∫´Â≠ò`
                                : `ÊàêÂäüÈÄÅÂá∫ ${successCount} È†ÖÈ†òÁî®Ë´ãÊ±ÇÔºåÁ≠âÂæÖËó•Â∏´ÂØ©Ê†∏`;
                            this.toast(message, 'success');
                            this.resetBatchDispenseForm();
                            this.showEmergencyReasonModal = false;
                            await this.loadPendingDispenses();
                            await this.loadItems();
                            await this.loadStats();
                        } else {
                            this.toast(`ÊàêÂäü ${successCount} È†ÖÔºåÂ§±Êïó ${failCount} È†Ö`, 'warning');
                            await this.loadPendingDispenses();
                            await this.loadItems();
                            await this.loadStats();
                        }
                    } catch (error) {
                        console.error('ÊâπÊ¨°È†òÁî®Â§±Êïó:', error);
                        this.toast('ÊâπÊ¨°È†òÁî®Â§±Êïó', 'error');
                    }
                },

                resetBatchDispenseForm() {
                    this.batchDispenseForm = {
                        dispensedBy: '',
                        patientRefId: '',
                        patientName: '',
                        items: [],
                        stationCode: this.stationId,
                        isEmergency: false,
                        emergencyReason: ''
                    };
                },

                // ============================================================
                // Ëó•Â±ÄÊí•ÁôºÂäüËÉΩ (MIRS v2.4 - Pharmacy Dispatch)
                // ============================================================

                async openDispatchModal() {
                    await this.ensureItemsLoaded();
                    await this.loadDispatchList();
                    this.showDispatchModal = true;
                },

                resetDispatchForm() {
                    this.dispatchForm = {
                        target_station_id: '',
                        target_station_name: '',
                        items: [{ code: '', name: '', quantity: 1, searchText: '', filteredItems: [], showDropdown: false }]
                    };
                },

                addDispatchItem() {
                    this.dispatchForm.items.push({
                        code: '',
                        name: '',
                        quantity: 1,
                        searchText: '',
                        filteredItems: [],
                        showDropdown: false
                    });
                },

                removeDispatchItem(index) {
                    if (this.dispatchForm.items.length > 1) {
                        this.dispatchForm.items.splice(index, 1);
                    }
                },

                filterDispatchItems(index) {
                    const searchText = this.dispatchForm.items[index].searchText.toLowerCase();
                    if (!searchText) {
                        this.dispatchForm.items[index].filteredItems = [];
                        return;
                    }
                    // Âè™È°ØÁ§∫Ëó•ÂìÅ (MED- ÂâçÁ∂¥)
                    this.dispatchForm.items[index].filteredItems = this.items.filter(item =>
                        item.code.startsWith('MED-') &&
                        (item.code.toLowerCase().includes(searchText) ||
                         item.name.toLowerCase().includes(searchText))
                    );
                },

                selectDispatchItem(index, med) {
                    this.dispatchForm.items[index].code = med.code;
                    this.dispatchForm.items[index].name = med.name;
                    this.dispatchForm.items[index].searchText = `${med.code} - ${med.name}`;
                    this.dispatchForm.items[index].showDropdown = false;
                    this.dispatchForm.items[index].filteredItems = [];
                },

                async loadDispatchList() {
                    try {
                        const response = await fetch(`${this.apiUrl}/pharmacy/dispatch`);
                        if (response.ok) {
                            const data = await response.json();
                            this.dispatchList = data.dispatches || [];
                        }
                    } catch (error) {
                        console.error('ËºâÂÖ•Êí•ÁôºÂñÆÂàóË°®Â§±Êïó:', error);
                    }
                },

                async createDispatch() {
                    // È©óË≠â
                    const validItems = this.dispatchForm.items.filter(item => item.code && item.quantity > 0);
                    if (validItems.length === 0) {
                        this.toast('Ë´ãËá≥Â∞ëÈÅ∏Êìá‰∏ÄÈ†ÖËó•ÂìÅ', 'error');
                        return;
                    }

                    try {
                        // Step 1: Âª∫Á´ãÊí•ÁôºÂñÆ (DRAFT)
                        const createPayload = {
                            target_station_id: this.dispatchForm.target_station_id || null,
                            target_station_name: this.dispatchForm.target_station_name || null,
                            created_by: this.stationId || 'MIRS',
                            items: validItems.map(item => ({
                                medicine_code: item.code,
                                quantity: parseInt(item.quantity)
                            }))
                        };

                        const createResponse = await fetch(`${this.apiUrl}/pharmacy/dispatch`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(createPayload)
                        });

                        if (!createResponse.ok) {
                            const errData = await createResponse.json();
                            const errMsg = typeof errData.detail === 'string' ? errData.detail : JSON.stringify(errData.detail);
                            this.toast(`Âª∫Á´ãÊí•ÁôºÂñÆÂ§±Êïó: ${errMsg}`, 'error');
                            return;
                        }

                        const createData = await createResponse.json();
                        const dispatchId = createData.dispatch_id;

                        // Step 2: È†êÊâ£Â∫´Â≠ò (DRAFT ‚Üí RESERVED)
                        const reserveResponse = await fetch(`${this.apiUrl}/pharmacy/dispatch/${dispatchId}/reserve`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ reserved_by: this.stationId || 'MIRS' })
                        });

                        if (!reserveResponse.ok) {
                            const errData = await reserveResponse.json();
                            const errMsg = typeof errData.detail === 'string' ? errData.detail : JSON.stringify(errData.detail);
                            this.toast(`È†êÊâ£Â∫´Â≠òÂ§±Êïó: ${errMsg}`, 'error');
                            // Ëã•È†êÊâ£Â§±ÊïóÂâáËá™ÂãïÂèñÊ∂àÊí•ÁôºÂñÆ (silent mode)
                            await this.cancelDispatch(dispatchId, true);
                            return;
                        }

                        // Step 3: ÂèñÂæó QR Code ‰∏¶Ê∏≤ÊüìÁÇ∫ÂúñÁâá
                        const qrResponse = await fetch(`${this.apiUrl}/pharmacy/dispatch/${dispatchId}/qr`);
                        if (!qrResponse.ok) {
                            this.toast('ÁÑ°Ê≥ïÂèñÂæó QR Code', 'error');
                            return;
                        }

                        const qrData = await qrResponse.json();
                        console.log('[Dispatch] Got QR data:', qrData.qr_data?.length, 'chunks');
                        const qrCodes = await this.generateQRDataURLs(qrData.qr_data || []);
                        console.log('[Dispatch] Generated QR codes:', qrCodes.length, 'first data_url:', qrCodes[0]?.data_url?.substring(0, 50));

                        this.dispatchQRData = {
                            dispatch_id: dispatchId,
                            qr_codes: qrCodes,
                            current_index: 0
                        };
                        console.log('[Dispatch] dispatchQRData set:', this.dispatchQRData.qr_codes?.length);

                        this.toast('Êí•ÁôºÂñÆÂª∫Á´ãÊàêÂäüÔºåË´ãËÆìËó•Â±ÄÊéÉÊèè QR Code', 'success');
                        this.resetDispatchForm();
                        await this.loadDispatchList();
                        await this.loadItems();
                        await this.loadStats();

                        // È°ØÁ§∫ QR Modal
                        console.log('[Dispatch] Showing QR modal');
                        this.showDispatchQRModal = true;

                    } catch (error) {
                        console.error('Âª∫Á´ãÊí•ÁôºÂñÆÈåØË™§:', error);
                        this.toast('Âª∫Á´ãÊí•ÁôºÂñÆÂ§±Êïó', 'error');
                    }
                },

                // Adapter: ‰ΩøÁî® qrcodejs (DOM-based) Áî¢Áîü DataURL
                generateQRToDataURL(text, width = 250) {
                    return new Promise((resolve, reject) => {
                        try {
                            // 1. ÂâµÂª∫Ëá®ÊôÇÈö±ËóèÂÆπÂô®
                            const tempDiv = document.createElement('div');
                            tempDiv.style.position = 'absolute';
                            tempDiv.style.left = '-9999px';
                            document.body.appendChild(tempDiv);

                            // 2. ‰ΩøÁî® qrcodejs ÁîüÊàê QR Code
                            new QRCode(tempDiv, {
                                text: text,
                                width: width,
                                height: width,
                                colorDark: "#000000",
                                colorLight: "#ffffff",
                                correctLevel: QRCode.CorrectLevel.L
                            });

                            // 3. ÂòóË©¶Âæû Canvas ÊèêÂèñ Data URL (ÊúÄÁ©©ÂÆö)
                            const canvas = tempDiv.querySelector('canvas');
                            if (canvas) {
                                const dataUrl = canvas.toDataURL("image/png");
                                document.body.removeChild(tempDiv);
                                resolve(dataUrl);
                                return;
                            }

                            // 4. Fallback: Âª∂ÈÅ≤ÊäìÂèñ img.src (ÈáùÂ∞çËàäÁâàÁÄèË¶ΩÂô®)
                            setTimeout(() => {
                                const canvasRetry = tempDiv.querySelector('canvas');
                                if (canvasRetry) {
                                    const dataUrl = canvasRetry.toDataURL("image/png");
                                    document.body.removeChild(tempDiv);
                                    resolve(dataUrl);
                                } else {
                                    const img = tempDiv.querySelector('img');
                                    document.body.removeChild(tempDiv);
                                    if (img && img.src) {
                                        resolve(img.src);
                                    } else {
                                        reject(new Error("Failed to generate QR Data URL"));
                                    }
                                }
                            }, 50);
                        } catch (e) {
                            reject(e);
                        }
                    });
                },

                // Â∞á XIR1 chunk strings ËΩâÊèõÁÇ∫ QR Code DataURL
                async generateQRDataURLs(chunks) {
                    console.log('[Dispatch] generateQRDataURLs called with', chunks?.length, 'chunks');
                    if (!chunks || chunks.length === 0) {
                        console.error('[Dispatch] No chunks provided');
                        return [];
                    }

                    if (typeof QRCode === 'undefined') {
                        console.error('[Dispatch] QRCode library not loaded (qrcodejs)');
                        return chunks.map(chunk => ({ chunk, data_url: '' }));
                    }

                    const results = [];
                    for (const chunk of chunks) {
                        try {
                            console.log('[Dispatch] Generating QR for chunk:', chunk.substring(0, 30) + '...');
                            // ‰ΩøÁî® Adapter ÂáΩÂºè (qrcodejs DOM-based)
                            const dataUrl = await this.generateQRToDataURL(chunk, 250);
                            console.log('[Dispatch] QR generated, dataUrl length:', dataUrl?.length);
                            results.push({ chunk, data_url: dataUrl });
                        } catch (e) {
                            console.error('[Dispatch] QR generation failed:', e);
                            results.push({ chunk, data_url: '' });
                        }
                    }
                    console.log('[Dispatch] Generated', results.length, 'QR codes');
                    return results;
                },

                async showDispatchQR(dispatch) {
                    try {
                        const response = await fetch(`${this.apiUrl}/pharmacy/dispatch/${dispatch.dispatch_id}/qr`);
                        if (response.ok) {
                            const data = await response.json();
                            const qrCodes = await this.generateQRDataURLs(data.qr_data || []);
                            this.dispatchQRData = {
                                dispatch_id: dispatch.dispatch_id,
                                qr_codes: qrCodes,
                                current_index: 0
                            };
                            this.showDispatchQRModal = true;
                        } else {
                            this.toast('ÁÑ°Ê≥ïÂèñÂæó QR Code', 'error');
                        }
                    } catch (error) {
                        console.error('ÂèñÂæó QR Code Â§±Êïó:', error);
                        this.toast('ÂèñÂæó QR Code Â§±Êïó', 'error');
                    }
                },

                async confirmDispatch(dispatchId) {
                    try {
                        const response = await fetch(`${this.apiUrl}/pharmacy/dispatch/${dispatchId}/confirm`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ dispatched_by: this.stationId || 'MIRS' })
                        });

                        if (response.ok) {
                            this.toast('Êí•ÁôºÂñÆÂ∑≤Á¢∫Ë™çÈÄÅÂá∫', 'success');
                            this.showDispatchQRModal = false;
                            await this.loadDispatchList();
                            await this.loadItems();
                            await this.loadStats();
                        } else {
                            const errData = await response.json();
                            const errMsg = typeof errData.detail === 'string' ? errData.detail : JSON.stringify(errData.detail);
                            this.toast(`Á¢∫Ë™çÂ§±Êïó: ${errMsg}`, 'error');
                        }
                    } catch (error) {
                        console.error('Á¢∫Ë™çÊí•ÁôºÂñÆÂ§±Êïó:', error);
                        this.toast('Á¢∫Ë™çÊí•ÁôºÂñÆÂ§±Êïó', 'error');
                    }
                },

                async cancelDispatch(dispatchId, silent = false) {
                    if (!silent && !confirm('Á¢∫ÂÆöË¶ÅÂèñÊ∂àÊ≠§Êí•ÁôºÂñÆÂóéÔºüÂ∫´Â≠òÂ∞áÊúÉÈáãÊîæÂõûÂèØÁî®ÁãÄÊÖã„ÄÇ')) {
                        return;
                    }

                    try {
                        const response = await fetch(`${this.apiUrl}/pharmacy/dispatch/${dispatchId}`, {
                            method: 'DELETE'
                        });

                        if (response.ok) {
                            if (!silent) {
                                this.toast('Êí•ÁôºÂñÆÂ∑≤ÂèñÊ∂à', 'success');
                            }
                            await this.loadDispatchList();
                            await this.loadItems();
                            await this.loadStats();
                        } else {
                            const errData = await response.json();
                            if (!silent) {
                                this.toast(`ÂèñÊ∂àÂ§±Êïó: ${errData.detail || 'Êú™Áü•ÈåØË™§'}`, 'error');
                            }
                        }
                    } catch (error) {
                        console.error('ÂèñÊ∂àÊí•ÁôºÂñÆÂ§±Êïó:', error);
                        if (!silent) {
                            this.toast('ÂèñÊ∂àÊí•ÁôºÂñÆÂ§±Êïó', 'error');
                        }
                    }
                },

                // Ê†ºÂºèÂåñ‰ΩçÂÖÉÁµÑÂ§ßÂ∞è
                formatBytes(bytes) {
                    if (!bytes) return '0 Bytes';
                    const k = 1024;
                    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                    const i = Math.floor(Math.log(bytes) / Math.log(k));
                    return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
                }
            };
        }
    </script>
</body>
</html>
